[{"url":"https://api.github.com/repos/rails/rails/issues/45998","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45998/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45998/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45998/events","html_url":"https://github.com/rails/rails/issues/45998","id":1368868095,"node_id":"I_kwDNIULOUZdE_w","number":45998,"title":"CSRF getting different token","user":{"login":"Saleh-Salem","id":22606707,"node_id":"MDQ6VXNlcjIyNjA2NzA3","avatar_url":"https://avatars.githubusercontent.com/u/22606707?v=4","gravatar_id":"","url":"https://api.github.com/users/Saleh-Salem","html_url":"https://github.com/Saleh-Salem","followers_url":"https://api.github.com/users/Saleh-Salem/followers","following_url":"https://api.github.com/users/Saleh-Salem/following{/other_user}","gists_url":"https://api.github.com/users/Saleh-Salem/gists{/gist_id}","starred_url":"https://api.github.com/users/Saleh-Salem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Saleh-Salem/subscriptions","organizations_url":"https://api.github.com/users/Saleh-Salem/orgs","repos_url":"https://api.github.com/users/Saleh-Salem/repos","events_url":"https://api.github.com/users/Saleh-Salem/events{/privacy}","received_events_url":"https://api.github.com/users/Saleh-Salem/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-11T08:08:17Z","updated_at":"2022-09-11T10:37:25Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"When validating the CSRF token getting an exception in API\r\n \r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\nthe `session[:_csrf_token]` and  `request.x_csrf_token` is different and getting issue.\r\nwhen I need to skip the csrf, I add `verify_authenticity_token`, In this case, I don't need to skip it.\r\nI debug and found the issue in the method:\r\n\r\n```\r\n  def compare_with_global_token(token, session = nil) # :doc:\r\n    ActiveSupport::SecurityUtils.fixed_length_secure_compare(token, global_csrf_token(session))\r\n  end\r\n```\r\n\r\nwhat is `session[:_csrf_token]` and how can I implement it in API?\r\nIs there any missing from my side?\r\n### Steps to reproduce\r\n\r\n1. Add `protect_from_forgery with: :exception` .\r\n2. When logging in return token in response is generated by `form_authenticity_token`.\r\n3. When Trying to request any POST, PUT or DELETE API get an exception.\r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nReturn Response without exception\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\ngetting an exception when requesting API by FE\r\n\r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\nGetting an success when requesting API by Postman\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.0.3.5\r\n**Ruby version**:\r\n2.7.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45998/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45996","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45996/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45996/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45996/events","html_url":"https://github.com/rails/rails/issues/45996","id":1368636436,"node_id":"I_kwDNIULOUZO8FA","number":45996,"title":"Cannot load such file -- redis/connection/hiredis (LoadError)","user":{"login":"qquokka","id":52653737,"node_id":"MDQ6VXNlcjUyNjUzNzM3","avatar_url":"https://avatars.githubusercontent.com/u/52653737?v=4","gravatar_id":"","url":"https://api.github.com/users/qquokka","html_url":"https://github.com/qquokka","followers_url":"https://api.github.com/users/qquokka/followers","following_url":"https://api.github.com/users/qquokka/following{/other_user}","gists_url":"https://api.github.com/users/qquokka/gists{/gist_id}","starred_url":"https://api.github.com/users/qquokka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qquokka/subscriptions","organizations_url":"https://api.github.com/users/qquokka/orgs","repos_url":"https://api.github.com/users/qquokka/repos","events_url":"https://api.github.com/users/qquokka/events{/privacy}","received_events_url":"https://api.github.com/users/qquokka/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-10T14:20:00Z","updated_at":"2022-09-10T15:34:24Z","closed_at":"2022-09-10T15:34:24Z","author_association":"NONE","active_lock_reason":null,"body":"Hi. I'm trying to upgrade the ruby version from 2.6.6 to 2.7.5 and the rails version from 6.0.3.3 to 6.1.7 of my existing project, which works well now. The problem is that Rails cannot load a certain file related with the redis gem although I've changed nothing but the ruby and the rails version. Is the redis version not corresponding to the rails's?\r\n\r\n### Steps to reproduce\r\nThe below codes are written in [the hiredis gem README](https://github.com/redis/hiredis-rb#redis-rb)\r\n\r\n```ruby\r\n# Gemfile\r\n\r\ngem \"hiredis\", '0.6.3'\r\ngem 'redis', '5.0.4', :require => [\"redis\", \"redis/connection/hiredis\"]\r\ngem 'redis-namespace', '1.9.0'\r\n```\r\n\r\n```bash\r\n$ bundle install\r\n\r\n$ rails s\r\n```\r\n\r\n### Expected behavior\r\nSuccessfully run the server.\r\n\r\n### Actual behavior\r\n```bash\r\n$ rails s\r\n\r\nTraceback (most recent call last):\r\n\t25: from bin/rails:6:in `<main>'\r\n\t24: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t23: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t22: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands.rb:18:in `<main>'\r\n\t21: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/command.rb:48:in `invoke'\r\n\t20: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/command/base.rb:69:in `perform'\r\n\t19: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\t18: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\t17: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\t16: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:135:in `perform'\r\n\t15: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:135:in `tap'\r\n\t14: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:138:in `block in perform'\r\n\t13: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:332:in `require'\r\n\t12: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:299:in `load_dependency'\r\n\t11: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:332:in `block in require'\r\n\t10: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t 9: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t 8: from /Users/yanghyejin/workspace/deali/bird/config/application.rb:23:in `<main>'\r\n\t 7: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler.rb:174:in `require'\r\n\t 6: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:58:in `require'\r\n\t 5: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:58:in `each'\r\n\t 4: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:69:in `block in require'\r\n\t 3: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:69:in `each'\r\n\t 2: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:74:in `block (2 levels) in require'\r\n\t 1: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:18:in `require'\r\n/Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:18:in `require': cannot load such file -- redis/connection/hiredis (LoadError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.7\r\n\r\n**Ruby version**: 2.7.5\r\n\r\nChipset: M1(mac)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45996/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45996/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45994","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45994/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45994/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45994/events","html_url":"https://github.com/rails/rails/issues/45994","id":1368555704,"node_id":"I_kwDNIULOUZKAuA","number":45994,"title":"LoadInterlockAwareMonitor deadlock when clearing cache (multiple databases, test)","user":{"login":"kuahyeow","id":16723,"node_id":"MDQ6VXNlcjE2NzIz","avatar_url":"https://avatars.githubusercontent.com/u/16723?v=4","gravatar_id":"","url":"https://api.github.com/users/kuahyeow","html_url":"https://github.com/kuahyeow","followers_url":"https://api.github.com/users/kuahyeow/followers","following_url":"https://api.github.com/users/kuahyeow/following{/other_user}","gists_url":"https://api.github.com/users/kuahyeow/gists{/gist_id}","starred_url":"https://api.github.com/users/kuahyeow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuahyeow/subscriptions","organizations_url":"https://api.github.com/users/kuahyeow/orgs","repos_url":"https://api.github.com/users/kuahyeow/repos","events_url":"https://api.github.com/users/kuahyeow/events{/privacy}","received_events_url":"https://api.github.com/users/kuahyeow/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-10T08:52:46Z","updated_at":"2022-09-10T08:56:12Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With multiple databases, we observe hangs within system tests.\r\n\r\nSee also https://gitlab.com/gitlab-org/gitlab/-/issues/371468 (GitLab is at Rails 6.1, Ruby 2.7.5)\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nHere's a minimal reproduction with Rails 7.0.3.1\r\n\r\n1. Checkout https://gitlab.com/tkuah/multi_database_system_test\r\n2. `bundle install`\r\n3. `bundle exec rails db:migrate`\r\n4. `bundle rails test test/system/home_pages_test.rb`\r\n\r\nThe conditions are:\r\n\r\n1. Multiple databases\r\n2. System test where there's an async request which overlaps with the main thread\r\n\r\n### Expected behavior\r\n\r\nIt does not hang, and the test completes\r\n\r\n### Actual behavior\r\n\r\nIt hangs. It looks like it's hanging when clearing query cache (see https://gitlab.com/gitlab-org/gitlab/-/issues/371468#note_1087203883, and https://gitlab.com/gitlab-org/gitlab/-/issues/371468#note_1088779499)\r\n\r\nA backtrace dump taken while the test is hanging [sigdump-68442.log](https://github.com/rails/rails/files/9539878/sigdump-68442.log)\r\n\r\nMy suspicion is that:\r\n\r\n1. `lock_thread` is true for system tests\r\n3. Therefore both the main thread, and the Puma thread attempt to clear query cache for the same set of connections\r\n\r\nSo we have two connections:\r\n\r\n1. Puma thread takes a `LoadInterlockAwareMonitor` lock for primary connection via `Post.transaction`\r\n2. Main thread takes a `LoadInterlockAwareMonitor` lock for animal connection via implicit transaction that `create` does\r\n3. Due to 2, main thread attempts to clear query cache for primary connection. **Waits for 1's lock**\r\n4. Due to 1, and because of `lock_thread`, puma thread clears query cache for primary connection. It takes a `LoadInterlockAwareMonitor` lock for primary connection which succeds\r\n5. Due to 1, puma thread now attempts clears query cache for animal connection. **Waits for 2's lock**\r\n\r\nSee [`clear_query_caches_for_current_thread` method](https://github.com/rails/rails/blob/e24fbf71fa0a10f63346b9b42604451958740844/activerecord/lib/active_record/connection_handling.rb#L244-L248)\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: ruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45994/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45994/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45988","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45988/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45988/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45988/events","html_url":"https://github.com/rails/rails/issues/45988","id":1368343535,"node_id":"I_kwDNIULOUY9D7w","number":45988,"title":"Incorrect link present when using the help menu -h, under -c option.","user":{"login":"creaturenex","id":15052690,"node_id":"MDQ6VXNlcjE1MDUyNjkw","avatar_url":"https://avatars.githubusercontent.com/u/15052690?v=4","gravatar_id":"","url":"https://api.github.com/users/creaturenex","html_url":"https://github.com/creaturenex","followers_url":"https://api.github.com/users/creaturenex/followers","following_url":"https://api.github.com/users/creaturenex/following{/other_user}","gists_url":"https://api.github.com/users/creaturenex/gists{/gist_id}","starred_url":"https://api.github.com/users/creaturenex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/creaturenex/subscriptions","organizations_url":"https://api.github.com/users/creaturenex/orgs","repos_url":"https://api.github.com/users/creaturenex/repos","events_url":"https://api.github.com/users/creaturenex/events{/privacy}","received_events_url":"https://api.github.com/users/creaturenex/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-09T21:24:01Z","updated_at":"2022-09-09T21:37:32Z","closed_at":"2022-09-09T21:37:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nrails -h\r\n\r\nunder the option\r\n -c, [--css=CSS]\r\n \r\n clicking on link provided generate an 404 error due to wrong address\r\n \r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Need some help running the test script, based on the provided list most like have to use generic_main.rb\r\n\r\n# The correction is simple, just removed the unnecessary bracket from the link\r\n```\r\n\r\n### Expected behavior\r\nLink should open to\r\nhttps://github.com/rails/cssbundling-rails\r\n\r\n### Actual behavior\r\n404 error due to wrong link\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45988/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45988/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45984","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45984/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45984/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45984/events","html_url":"https://github.com/rails/rails/issues/45984","id":1368144421,"node_id":"I_kwDNIULOUYw6JQ","number":45984,"title":"Cannot Eager Load has_many :through Relationships with custom scope","user":{"login":"dcorrigan","id":2445528,"node_id":"MDQ6VXNlcjI0NDU1Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/2445528?v=4","gravatar_id":"","url":"https://api.github.com/users/dcorrigan","html_url":"https://github.com/dcorrigan","followers_url":"https://api.github.com/users/dcorrigan/followers","following_url":"https://api.github.com/users/dcorrigan/following{/other_user}","gists_url":"https://api.github.com/users/dcorrigan/gists{/gist_id}","starred_url":"https://api.github.com/users/dcorrigan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dcorrigan/subscriptions","organizations_url":"https://api.github.com/users/dcorrigan/orgs","repos_url":"https://api.github.com/users/dcorrigan/repos","events_url":"https://api.github.com/users/dcorrigan/events{/privacy}","received_events_url":"https://api.github.com/users/dcorrigan/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-09T17:47:35Z","updated_at":"2022-09-09T17:47:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThis seems like it's the same as #28324, but I'm still seeing the issue in Rails 7. \r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :images, force: true do |t|\r\n    t.string :title\r\n    t.integer :post_id\r\n  end\r\n\r\n  create_table :captions, force: true do |t|\r\n    t.integer :image_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :images\r\n  has_many :captions, lambda { order('images.title DESC') }, through: :images\r\nend\r\n\r\nclass Image < ActiveRecord::Base\r\n  belongs_to :post\r\n  has_one :caption\r\nend\r\n\r\nclass Caption < ActiveRecord::Base\r\n  belongs_to :image\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_preload_has_many_through_association_with_scope\r\n    post = Post.create!\r\n    image = Image.create!\r\n    image.caption = Caption.create!\r\n    post.images << image\r\n    post.save!\r\n\r\n    # Access through the model works\r\n    assert_includes post.captions, Caption.first\r\n\r\n    # Query with association preloaded does not.\r\n    # When evaluated, it will apply the scope without the relevant JOIN table:\r\n    # SELECT \"captions\".* FROM \"captions\" WHERE \"captions\".\"image_id\" = ? ORDER BY images.title DESC\r\n    preloaded = Post.where(id: post.id).includes(:captions)\r\n\r\n    assert_includes preloaded.first.captions, Caption.first\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe test passes and we're able to eager load has_many :through associations with custom scopes in this way.\r\n\r\nI realize this can be fixed by adding a `references(:images)` to the query, but it seems reasonable to expect AR to infer that that the join is necessary here.\r\n\r\n### Actual behavior\r\n\r\nTest fails with an error: `ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: images.title`\r\n\r\n### System configuration\r\n**Rails version**: 7.0 \r\n\r\n**Ruby version**: 3.1.2p20\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45984/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45984/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45983","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45983/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45983/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45983/events","html_url":"https://github.com/rails/rails/issues/45983","id":1368057899,"node_id":"I_kwDNIULOUYroKw","number":45983,"title":"ApplicationTests::TestRunnerTest#test_load_fixtures_when_running_test_suites fails with Ruby 3.2.0.preview2","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-09T16:27:15Z","updated_at":"2022-09-10T14:43:42Z","closed_at":"2022-09-10T14:43:42Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/89320#01831efc-b45c-406b-8ae1-b73e9410ad8c\r\n\r\nAccording to git bisect, this behavior changed via https://bugs.ruby-lang.org/issues/18784\r\nhttps://github.com/ruby/ruby/commit/983115cf3c8f75b1afbe3274f02c1529e1ce3a81\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\ncd rails/railties\r\nrm ../Gemfile.lock\r\nbundle install\r\nbin/test test/application/test_runner_test.rb -n test_load_fixtures_when_running_test_suites\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nApplicationTests::TestRunnerTest#test_load_fixtures_when_running_test_suites:\r\nErrno::EISDIR: Is a directory @ apply2files - test/models\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2300:in `unlink'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2300:in `block in remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2305:in `platform_support'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2299:in `remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1449:in `remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1189:in `block in rm'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1188:in `each'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1188:in `rm'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1211:in `rm_f'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `block (2 levels) in test_load_fixtures_when_running_test_suites'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `chdir'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `block in test_load_fixtures_when_running_test_suites'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:250:in `each'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:250:in `test_load_fixtures_when_running_test_suites'\r\n\r\n\r\nbin/test test/application/test_runner_test.rb:246\r\n\r\n\r\n\r\nFinished in 2.319535s, 0.4311 runs/s, 0.8622 assertions/s.\r\n1 runs, 2 assertions, 0 failures, 1 errors, 0 skips\r\nyahonda@myryzen:~/src/github.com/rails/rails/railties$ ruby -v\r\nruby 3.2.0preview2 (2022-09-09 master 35cfc9a3bb) [x86_64-linux]\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.2.0preview2 (2022-09-09 master 35cfc9a3bb) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45983/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45983/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45967","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45967/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45967/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45967/events","html_url":"https://github.com/rails/rails/issues/45967","id":1366038829,"node_id":"I_kwDNIULOUWwZLQ","number":45967,"title":"Inconsistent update of timestamps while updating associations with *_ids=","user":{"login":"matthee","id":547653,"node_id":"MDQ6VXNlcjU0NzY1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/547653?v=4","gravatar_id":"","url":"https://api.github.com/users/matthee","html_url":"https://github.com/matthee","followers_url":"https://api.github.com/users/matthee/followers","following_url":"https://api.github.com/users/matthee/following{/other_user}","gists_url":"https://api.github.com/users/matthee/gists{/gist_id}","starred_url":"https://api.github.com/users/matthee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthee/subscriptions","organizations_url":"https://api.github.com/users/matthee/orgs","repos_url":"https://api.github.com/users/matthee/repos","events_url":"https://api.github.com/users/matthee/events{/privacy}","received_events_url":"https://api.github.com/users/matthee/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-08T10:51:09Z","updated_at":"2022-09-09T03:10:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"ActiveRecord inconsistently updates the `updated_at` column when changing `has_many through:` associations.\r\n\r\n### Steps to reproduce\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"activesupport\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"active_support/testing/time_helpers\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.timestamps\r\n  end\r\n  \r\n  create_table :tags, force: true do |t|\r\n  end\r\n\r\n  create_table :taggings, force: true do |t|\r\n    t.integer :post_id\r\n    t.integer :tag_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :taggings, dependent: :destroy\r\n  \r\n  has_many :tags, through: :taggings\r\nend\r\n\r\nclass Tagging < ActiveRecord::Base\r\n  belongs_to :post, touch: true\r\n  belongs_to :tag\r\nend\r\n\r\nclass Tag < ActiveRecord::Base\r\n  has_many :taggings\r\n  has_many :posts, through: :taggings\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  include ActiveSupport::Testing::TimeHelpers\r\n  \r\n  def test_updated_at_is_updated_when_setting_has_many_through_association\r\n    freeze_time\r\n        \r\n    tag_1 = Tag.create!\r\n    tag_2 = Tag.create!\r\n      \r\n    post = Post.create!\r\n    \r\n    travel_to(now = 1.hour.from_now)\r\n    \r\n    # Adding tags updates post.updated_at\r\n    post.update(tag_ids: [tag_1.id, tag_2.id])\r\n    assert_in_delta now, post.updated_at, 1.second, \"post#updated_at was not updated when adding tags\"\r\n    \r\n    # Removing tags does not update post.updated_at :(\r\n    travel_to(now = 2.hours.from_now)\r\n    post.update(tag_ids: [tag_1.id])\r\n    assert_in_delta now, post.updated_at, 1.second, \"post#updated_at was not updated when removing tags\"\r\n  end\r\n  \r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nIn the example above, both `.update` calls should update the `updated_at` column of the post record. (when adding and removing records)\r\n\r\n### Actual behavior\r\n\r\nWhen deleting a record, the `updated_at` timestamp is not updated.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3.1\r\n**Ruby version**:\r\n3.0.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45967/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45967/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45960","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45960/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45960/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45960/events","html_url":"https://github.com/rails/rails/issues/45960","id":1364924787,"node_id":"I_kwDNIULOUVsZcw","number":45960,"title":"Encrypted values for default values in test fixures do not work","user":{"login":"gjtorikian","id":64050,"node_id":"MDQ6VXNlcjY0MDUw","avatar_url":"https://avatars.githubusercontent.com/u/64050?v=4","gravatar_id":"","url":"https://api.github.com/users/gjtorikian","html_url":"https://github.com/gjtorikian","followers_url":"https://api.github.com/users/gjtorikian/followers","following_url":"https://api.github.com/users/gjtorikian/following{/other_user}","gists_url":"https://api.github.com/users/gjtorikian/gists{/gist_id}","starred_url":"https://api.github.com/users/gjtorikian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gjtorikian/subscriptions","organizations_url":"https://api.github.com/users/gjtorikian/orgs","repos_url":"https://api.github.com/users/gjtorikian/repos","events_url":"https://api.github.com/users/gjtorikian/events{/privacy}","received_events_url":"https://api.github.com/users/gjtorikian/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-07T16:34:59Z","updated_at":"2022-09-08T08:46:19Z","closed_at":"2022-09-08T08:46:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've been tracking down a bug which seems related to https://github.com/rails/rails/pull/45033 (cc @jorgemanrubia). \r\n\r\nIn short, it seems that default values are still not encrypted/decrypted properly when working with test fixtures. Attempting to load a test fixture that has an encrypted attribute with a default value yields `ActiveRecord::Encryption::Errors::Decryption`.\r\n\r\nHere's a reproducible test case:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"pg\"\r\n  gem \"debug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\nrequire \"debug\"\r\n\r\npg_opts = {adapter: \"postgresql\", database: \"jsonb_activerecord_issue\"}\r\nbegin\r\n  ActiveRecord::Base.establish_connection(pg_opts.except(:database))\r\n  ActiveRecord::Base.connection.create_database(pg_opts[:database])\r\n  puts \"Database #{pg_opts[:database]} was created.\"\r\nrescue => ActiveRecord::DatabaseAlreadyExists\r\n  puts \"Database #{pg_opts[:database]} alredy exists.\"\r\nend\r\nActiveRecord::Base.establish_connection(pg_opts)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass ActiveRecord::Encryption::Config\r\n  def primary_key\r\n    \"id\"\r\n  end\r\n\r\n  def key_derivation_salt\r\n    \"salt\"\r\n  end\r\nend\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :installations, force: true do |t|\r\n    t.string :name\r\n    t.jsonb :credentials, null: false, default: {}\r\n  end\r\nend\r\n\r\nclass Installation < ActiveRecord::Base\r\n  encrypts :credentials\r\nend\r\n\r\nrequire 'active_record/fixtures'\r\nActiveRecord::FixtureSet.create_fixtures(\".\", 'installations')\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_creating_record\r\n    valid_installation = Installation.create(name: \"valid\")\r\n    assert valid_installation.valid?\r\n    valid_installation.update(name: \"this is valid\")\r\n    assert valid_installation.valid?\r\n  end\r\n\r\n  def test_loading_record\r\n    loaded_installation = Installation.find ActiveRecord::FixtureSet.identify(:foo)\r\n    assert loaded_installation.valid?\r\n    loaded_installation.update(name: \"this is still not\")\r\n    assert loaded_installation.valid?\r\n  end\r\nend\r\n```\r\n\r\nThe associated YAML file is:\r\n\r\n```yml\r\nfoo:\r\n  name: \"Installation\"\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe test fixture should be able to load.\r\n### Actual behavior\r\n\r\nAn exception is thrown:\r\n\r\n<details>\r\n<pre>\r\nActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encryptor.rb:58:in `rescue in decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encryptor.rb:52:in `decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:73:in `block in decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/scheme.rb:64:in `with_context'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:15:in `with_context'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:72:in `decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:31:in `deserialize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute.rb:168:in `type_cast'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute.rb:43:in `value'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set/builder.rb:43:in `fetch_value'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:405:in `block in restore_transaction_record_state'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set.rb:98:in `transform_values'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set.rb:98:in `map'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:404:in `restore_transaction_record_state'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:336:in `rolledback!'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:159:in `rollback_records'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:448:in `block in rollback_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:441:in `rollback_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:464:in `rescue in block in within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:458:in `block in within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:453:in `within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:352:in `with_transaction_returning_status'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/persistence.rb:792:in `update'\r\n    jsonb_bug.rb:59:in `test_jsonb_encryption'\r\n</pre>\r\n</details>\r\n\r\n### System configuration\r\n**Rails version**: 7.1.0 (current edge)\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45960/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45960/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45959","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45959/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45959/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45959/events","html_url":"https://github.com/rails/rails/issues/45959","id":1364232810,"node_id":"I_kwDNIULOUVCKag","number":45959,"title":"JSON field not saving data with symbol : and it's saving with arrow =>","user":{"login":"sajjadmurtaza","id":8552702,"node_id":"MDQ6VXNlcjg1NTI3MDI=","avatar_url":"https://avatars.githubusercontent.com/u/8552702?v=4","gravatar_id":"","url":"https://api.github.com/users/sajjadmurtaza","html_url":"https://github.com/sajjadmurtaza","followers_url":"https://api.github.com/users/sajjadmurtaza/followers","following_url":"https://api.github.com/users/sajjadmurtaza/following{/other_user}","gists_url":"https://api.github.com/users/sajjadmurtaza/gists{/gist_id}","starred_url":"https://api.github.com/users/sajjadmurtaza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sajjadmurtaza/subscriptions","organizations_url":"https://api.github.com/users/sajjadmurtaza/orgs","repos_url":"https://api.github.com/users/sajjadmurtaza/repos","events_url":"https://api.github.com/users/sajjadmurtaza/events{/privacy}","received_events_url":"https://api.github.com/users/sajjadmurtaza/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-07T07:40:12Z","updated_at":"2022-09-08T07:23:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have JSON field in my database `t.json \"theme\"`. When I try to save the field hash with : , it's overridden before save\r\ne.g.\r\n`object.theme = { color: 'red' }` it always change to `{ color => 'red' }`\r\n\r\ni also tried with jsonb and default value with empty hash {} but still having the same issue.\r\n\r\n\r\nI want to save the JSON data hash with symbol keys `{ color: 'red' }`\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.0\r\n\r\n**Ruby version**: 2.7.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45959/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45959/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45949","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45949/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45949/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45949/events","html_url":"https://github.com/rails/rails/issues/45949","id":1362899537,"node_id":"I_kwDNIULOUTwyUQ","number":45949,"title":"ActionText::Attachable#as_json override is breaking ActiveStorage::Blob#as_json when blob is not persisted","user":{"login":"balbesina","id":7312369,"node_id":"MDQ6VXNlcjczMTIzNjk=","avatar_url":"https://avatars.githubusercontent.com/u/7312369?v=4","gravatar_id":"","url":"https://api.github.com/users/balbesina","html_url":"https://github.com/balbesina","followers_url":"https://api.github.com/users/balbesina/followers","following_url":"https://api.github.com/users/balbesina/following{/other_user}","gists_url":"https://api.github.com/users/balbesina/gists{/gist_id}","starred_url":"https://api.github.com/users/balbesina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/balbesina/subscriptions","organizations_url":"https://api.github.com/users/balbesina/orgs","repos_url":"https://api.github.com/users/balbesina/repos","events_url":"https://api.github.com/users/balbesina/events{/privacy}","received_events_url":"https://api.github.com/users/balbesina/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-06T08:26:39Z","updated_at":"2022-09-06T08:26:39Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nfrom rails console:\r\n```ruby\r\nActiveStorage::Blob.build_after_unfurling(io: StringIO.new('asd'), filename: 'asd.txt').as_json\r\n```\r\n\r\n[Reproduction script](https://gist.github.com/balbesina/30fbdafbfee4b71b06209d9e950f4128)\r\n\r\n### Expected behavior\r\nActiveStorage::Blob#as_json returns a Hash\r\n\r\n### Actual behavior\r\nActiveStorage::Blob#as_json raises exception\r\n```\r\n/Users/dhh/.rvm/gems/ruby-3.1.2/gems/globalid-1.0.0/lib/global_id/uri/gid.rb:167:in `validate_model_id': \r\nUnable to create a Global ID for ActiveStorage::Blob without a model id. (URI::GID::MissingModelIdError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3.1\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45949/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45939","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45939/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45939/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45939/events","html_url":"https://github.com/rails/rails/issues/45939","id":1360876688,"node_id":"I_kwDNIULOUR1UkA","number":45939,"title":"Validations aren't inherited from base model if child is called before validation declaration","user":{"login":"Exterm1nate","id":48535087,"node_id":"MDQ6VXNlcjQ4NTM1MDg3","avatar_url":"https://avatars.githubusercontent.com/u/48535087?v=4","gravatar_id":"","url":"https://api.github.com/users/Exterm1nate","html_url":"https://github.com/Exterm1nate","followers_url":"https://api.github.com/users/Exterm1nate/followers","following_url":"https://api.github.com/users/Exterm1nate/following{/other_user}","gists_url":"https://api.github.com/users/Exterm1nate/gists{/gist_id}","starred_url":"https://api.github.com/users/Exterm1nate/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Exterm1nate/subscriptions","organizations_url":"https://api.github.com/users/Exterm1nate/orgs","repos_url":"https://api.github.com/users/Exterm1nate/repos","events_url":"https://api.github.com/users/Exterm1nate/events{/privacy}","received_events_url":"https://api.github.com/users/Exterm1nate/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-09-03T14:46:42Z","updated_at":"2022-09-08T07:26:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nLet's create some STI models. Base `Vehicle` and two childs `Car` and `Motorcycle`.\r\n\r\n```ruby\r\n# models/vehicle.rb\r\nclass Vehicle < ApplicationRecord\r\n  TYPES = [Car, Motorcycle].freeze\r\n\r\n  validates :color, uniqueness: { scope: :model }\r\nend\r\n\r\n# models/car.rb\r\nclass Car < Vehicle\r\nend\r\n\r\n# models/motorcycle.rb\r\nclass Motorcycle < Vehicle\r\nend\r\n```\r\n\r\nAfter that we want to use `#validators_on` method to make sure the validation is present.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\nCar.validators_on(:color)\r\nMotorcycle.validators_on(:color)\r\n```\r\n\r\n### Expected behavior\r\n\r\nAll models must contain the validation.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nMotorcycle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\n```\r\n\r\n### Actual behavior\r\n\r\nBut for childs this method returns nothing.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> []\r\nMotorcycle.validators_on(:color)\r\n#=> []\r\n```\r\n\r\n### Notes\r\n\r\nIf we remove the `TYPES` constant (or just child classes calls from it) `validators_on` works as expected. Let's change original code a little bit:\r\n\r\n```ruby\r\n# models/vehicle.rb\r\nclass Vehicle < ApplicationRecord\r\n  TYPES = [Car].freeze # Motorcycle was removed from here!\r\n\r\n  validates :color, uniqueness: { scope: :model }\r\nend\r\n```\r\n\r\nAnd after that test again.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> []\r\nMotorcycle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\n```\r\n\r\n`Motorcycle` validation was returned correctly this time.\r\n\r\nIt seems to be a load error. `Car` was called before the `Vehicle`'s validation declaration, so it doesn't take this validation into account. It may also depend on loading order.\r\n\r\nNotice that validation itself is working well in all models.\r\n\r\n```ruby\r\nCar.create!(color: \"black\", model: \"Boomer\")\r\nCar.create!(color: \"black\", model: \"Boomer\") # raises ActiveRecord::RecordInvalid\r\n\r\nMotorcycle.create!(color: \"red\", model: \"Yamaha\")\r\nMotorcycle.create!(color: \"red\", model: \"Yamaha\") # raises ActiveRecord::RecordInvalid\r\n```\r\n\r\nExample project: https://github.com/Exterm1nate/rails-validation-issue\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45939/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45937","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45937/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45937/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45937/events","html_url":"https://github.com/rails/rails/issues/45937","id":1360779604,"node_id":"I_kwDNIULOURvZVA","number":45937,"title":"Add strict table mode (by default) to sqlite adapter","user":{"login":"jrz","id":149668,"node_id":"MDQ6VXNlcjE0OTY2OA==","avatar_url":"https://avatars.githubusercontent.com/u/149668?v=4","gravatar_id":"","url":"https://api.github.com/users/jrz","html_url":"https://github.com/jrz","followers_url":"https://api.github.com/users/jrz/followers","following_url":"https://api.github.com/users/jrz/following{/other_user}","gists_url":"https://api.github.com/users/jrz/gists{/gist_id}","starred_url":"https://api.github.com/users/jrz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrz/subscriptions","organizations_url":"https://api.github.com/users/jrz/orgs","repos_url":"https://api.github.com/users/jrz/repos","events_url":"https://api.github.com/users/jrz/events{/privacy}","received_events_url":"https://api.github.com/users/jrz/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-03T07:01:02Z","updated_at":"2022-09-08T07:30:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"SQLite supports 'strict tables' since 3.37.1 https://sqlite.org/stricttables.html\r\n\r\nThis forces a datatype to be specified when creating a table. This is the preferred method in any application created by developers. \r\n\r\nUnspecified/ANY datatypes are useful for quick tryouts as an enduser, similar to excel. But it's counterproductive when creating an application.\r\n\r\nIf this will become a configurable setting, the default should be set to strict.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45937/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45937/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45930","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45930/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45930/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45930/events","html_url":"https://github.com/rails/rails/issues/45930","id":1360031019,"node_id":"I_kwDNIULOURBtKw","number":45930,"title":"rails test not working in windows by default: FFI is required","user":{"login":"githubrarp","id":37696113,"node_id":"MDQ6VXNlcjM3Njk2MTEz","avatar_url":"https://avatars.githubusercontent.com/u/37696113?v=4","gravatar_id":"","url":"https://api.github.com/users/githubrarp","html_url":"https://github.com/githubrarp","followers_url":"https://api.github.com/users/githubrarp/followers","following_url":"https://api.github.com/users/githubrarp/following{/other_user}","gists_url":"https://api.github.com/users/githubrarp/gists{/gist_id}","starred_url":"https://api.github.com/users/githubrarp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/githubrarp/subscriptions","organizations_url":"https://api.github.com/users/githubrarp/orgs","repos_url":"https://api.github.com/users/githubrarp/repos","events_url":"https://api.github.com/users/githubrarp/events{/privacy}","received_events_url":"https://api.github.com/users/githubrarp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-02T10:55:04Z","updated_at":"2022-09-02T12:00:34Z","closed_at":"2022-09-02T12:00:34Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nrails test\r\n\r\n# Your reproduction script goes here\r\n`rescue in <main>': FFI is a required pre-requisite for Windows or posix_spawn support in the ChildProcess gem. Ensure the `ffi` gem is installed. If you believe this is an error, please file a bug at http://github.com/enkessler/childprocess/issues\r\n\r\n### Expected behavior\r\ntest to run\r\n\r\n### Actual behavior\r\nerror shows up\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.0.3p157\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45930/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45929","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45929/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45929/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45929/events","html_url":"https://github.com/rails/rails/issues/45929","id":1359850725,"node_id":"I_kwDNIULOUQ2s5Q","number":45929,"title":"cannot send mail in rails","user":{"login":"hminhduc","id":6736560,"node_id":"MDQ6VXNlcjY3MzY1NjA=","avatar_url":"https://avatars.githubusercontent.com/u/6736560?v=4","gravatar_id":"","url":"https://api.github.com/users/hminhduc","html_url":"https://github.com/hminhduc","followers_url":"https://api.github.com/users/hminhduc/followers","following_url":"https://api.github.com/users/hminhduc/following{/other_user}","gists_url":"https://api.github.com/users/hminhduc/gists{/gist_id}","starred_url":"https://api.github.com/users/hminhduc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hminhduc/subscriptions","organizations_url":"https://api.github.com/users/hminhduc/orgs","repos_url":"https://api.github.com/users/hminhduc/repos","events_url":"https://api.github.com/users/hminhduc/events{/privacy}","received_events_url":"https://api.github.com/users/hminhduc/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-02T08:08:16Z","updated_at":"2022-09-02T08:47:42Z","closed_at":"2022-09-02T08:47:42Z","author_association":"NONE","active_lock_reason":null,"body":"im using gmail smtp to send mail in my rails app to now. recenly activejob peformed but mail not received in mail box.\r\nhave google changed policy?\r\n\r\nGmail SMTP server address: smtp.gmail.com.\r\nGmail SMTP name: Your full name.\r\nGmail SMTP username: Your full Gmail email address (e.g. xyz@gmail.com)\r\nGmail SMTP password: The password you use to log in to Gmail.\r\nGmail SMTP port (TLS): 587.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45929/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45929/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45922","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45922/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45922/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45922/events","html_url":"https://github.com/rails/rails/issues/45922","id":1358965338,"node_id":"I_kwDNIULOUQAqWg","number":45922,"title":"ActiveStorage installation migration ignores `ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type`","user":{"login":"compeak","id":1942208,"node_id":"MDQ6VXNlcjE5NDIyMDg=","avatar_url":"https://avatars.githubusercontent.com/u/1942208?v=4","gravatar_id":"","url":"https://api.github.com/users/compeak","html_url":"https://github.com/compeak","followers_url":"https://api.github.com/users/compeak/followers","following_url":"https://api.github.com/users/compeak/following{/other_user}","gists_url":"https://api.github.com/users/compeak/gists{/gist_id}","starred_url":"https://api.github.com/users/compeak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/compeak/subscriptions","organizations_url":"https://api.github.com/users/compeak/orgs","repos_url":"https://api.github.com/users/compeak/repos","events_url":"https://api.github.com/users/compeak/events{/privacy}","received_events_url":"https://api.github.com/users/compeak/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-09-01T14:43:38Z","updated_at":"2022-09-01T21:52:30Z","closed_at":"2022-09-01T21:52:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Installing ActiveStorage with `bin/rails active_storage:install` after setting `ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type = :timestamptz` results in `timestamp without time zone` columns, because [activestorage/db/migrate/20170806125915_create_active_storage_tables.rb](https://github.com/rails/rails/blob/main/activestorage/db/migrate/20170806125915_create_active_storage_tables.rb) is a `5.2` migration.\r\n\r\nI don't know whether this is a bug or intended behaviour.\r\n\r\n### Steps to reproduce\r\n\r\nCreate new Rails app:\r\n\r\n```bash\r\nrails new testcase\r\n```\r\n\r\nSet `PostgreSQLAdapter.datetime_type`:\r\n\r\n`config/initializers/postgres.rb`:\r\n```ruby\r\nrequire 'active_record/connection_adapters/postgresql_adapter'\r\nActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type = :timestamptz\r\n```\r\n\r\nRun ActiveStorage installation task:\r\n```bash\r\nbin/rails active_storage:install\r\n```\r\n\r\nRun migration:\r\n```bash\r\nbin/rails db:migrate\r\n```\r\n\r\n### Expected behavior\r\n\r\nAll `datetime` columns should be created as `timestamp(6) with time zone`.\r\n\r\nExample:\r\n\r\n```\r\n                                         Table \"public.active_storage_attachments\"\r\n   Column    |            Type             | Collation | Nullable |                        Default                         \r\n-------------+-----------------------------+-----------+----------+--------------------------------------------------------\r\n id          | bigint                      |           | not null | nextval('active_storage_attachments_id_seq'::regclass)\r\n name        | character varying           |           | not null | \r\n record_type | character varying           |           | not null | \r\n record_id   | bigint                      |           | not null | \r\n blob_id     | bigint                      |           | not null | \r\n created_at  | timestamp(6) with time zone |           | not null | \r\n```\r\n\r\n### Actual behavior\r\n\r\n`datetime` columns are created as `timestamp(6) without time zone`.\r\n\r\nExample:\r\n\r\n```\r\n                                          Table \"public.active_storage_attachments\"\r\n   Column    |              Type              | Collation | Nullable |                        Default                         \r\n-------------+--------------------------------+-----------+----------+--------------------------------------------------------\r\n id          | bigint                         |           | not null | nextval('active_storage_attachments_id_seq'::regclass)\r\n name        | character varying              |           | not null | \r\n record_type | character varying              |           | not null | \r\n record_id   | bigint                         |           | not null | \r\n blob_id     | bigint                         |           | not null | \r\n created_at  | timestamp(6) without time zone |           | not null | \r\n```\r\n\r\n### Possible fix\r\n\r\nAfter changing the migration version from `5.2` to `7.0` all `datetime` columns are created as `timestamp(6) with time zone`.\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.3.1\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin21]\r\n**PostgreSQL version**: 14.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45922/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45922/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45920","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45920/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45920/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45920/events","html_url":"https://github.com/rails/rails/issues/45920","id":1358179995,"node_id":"I_kwDNIULOUPQumw","number":45920,"title":"Replace has_one through create_association might create duplicated rows","user":{"login":"lazaronixon","id":2651240,"node_id":"MDQ6VXNlcjI2NTEyNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2651240?v=4","gravatar_id":"","url":"https://api.github.com/users/lazaronixon","html_url":"https://github.com/lazaronixon","followers_url":"https://api.github.com/users/lazaronixon/followers","following_url":"https://api.github.com/users/lazaronixon/following{/other_user}","gists_url":"https://api.github.com/users/lazaronixon/gists{/gist_id}","starred_url":"https://api.github.com/users/lazaronixon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazaronixon/subscriptions","organizations_url":"https://api.github.com/users/lazaronixon/orgs","repos_url":"https://api.github.com/users/lazaronixon/repos","events_url":"https://api.github.com/users/lazaronixon/events{/privacy}","received_events_url":"https://api.github.com/users/lazaronixon/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-09-01T03:05:07Z","updated_at":"2022-09-01T23:03:40Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# Ensure backward compatibility with minitest 4.\r\nMinitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts do |t|\r\n  end\r\n\r\n  create_table :comments do |t|\r\n    t.references :post\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_one :comment, dependent: :destroy\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  validates_presence_of :post_id\r\n  belongs_to :post\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    sleep 5.seconds\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n```\r\n# transaction begin\r\nselect previous_comment for update\r\n\r\ninsert new_comment\r\n\r\ndelete previous_comment\r\n# transaction commit\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n```\r\n# transaction begin\r\ninsert new_comment\r\n# transaction commit\r\n\r\n# transaction begin\r\ndelete previous_comment\r\n# transaction commit\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45920/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45919","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45919/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45919/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45919/events","html_url":"https://github.com/rails/rails/issues/45919","id":1357912084,"node_id":"I_kwDNIULOUPAYFA","number":45919,"title":"`<<` function of `ActiveRecord::Associations::CollectionProxy` unexpected return value","user":{"login":"youssef1337","id":22629501,"node_id":"MDQ6VXNlcjIyNjI5NTAx","avatar_url":"https://avatars.githubusercontent.com/u/22629501?v=4","gravatar_id":"","url":"https://api.github.com/users/youssef1337","html_url":"https://github.com/youssef1337","followers_url":"https://api.github.com/users/youssef1337/followers","following_url":"https://api.github.com/users/youssef1337/following{/other_user}","gists_url":"https://api.github.com/users/youssef1337/gists{/gist_id}","starred_url":"https://api.github.com/users/youssef1337/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/youssef1337/subscriptions","organizations_url":"https://api.github.com/users/youssef1337/orgs","repos_url":"https://api.github.com/users/youssef1337/repos","events_url":"https://api.github.com/users/youssef1337/events{/privacy}","received_events_url":"https://api.github.com/users/youssef1337/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-31T21:52:45Z","updated_at":"2022-09-01T16:58:14Z","closed_at":"2022-09-01T16:35:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Explanation\r\nHello, so I am using the `<<` [function](https://api.rubyonrails.org/v6.1.3/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C) of `ActiveRecord::Associations::CollectionProxy` and before (in `rails 5`) it was returning `false` when it failed, when I upgraded to `rails 6` that doesn't happen anymore and I traced it to this [change](https://github.com/rails/rails/commit/5dc72378b783e924c5bf079ca660388ec4ac9224?diff=split#diff-ceff30ddab4e756e3a70ece45076eb17ff2f587a068dae657d2ad3a265a3f0d6L446) on `Jun 6, 2018` – my question is, how was I supposed to know that this change happened when upgarding? what did I miss? I have checked the upgrade guide and the release notes, didn't seem to find something related to that change. Thanks in advance.\r\n\r\n### Steps to reproduce\r\nJust check the reproduction script below for both `rails 5` and `rails 6`\r\n\r\n### Expected behavior\r\nThis is the expected behavior in rails 5, expected the return value of `<<` to be `false` when it fails.\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"5.0.7\"\r\n  gem \"sqlite3\", \"1.3.13\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n  validates :post, uniqueness: true # for the sake of testing\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.comments << Comment.create!\r\n    val = post.comments << Comment.create!\r\n\r\n    assert_equal false, val\r\n  end\r\nend\r\n```\r\nval returns `false` correctly as expected.\r\n### Actual behavior\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"6.0.3\"\r\n  gem \"sqlite3\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n  validates :post, uniqueness: true # for the sake of testing\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.comments << Comment.create!\r\n    val = post.comments << Comment.create!\r\n\r\n    assert_equal false, val\r\n  end\r\nend\r\n```\r\n`Expected: false`\r\n`Actual: nil`\r\n\r\n### System configuration\r\n**Rails version**:\r\n`5.0.7` for expected behavior\r\n`6.0.3` for the changed behavior which I wasn't expecting\r\n**Ruby version**:\r\n`2.5.5` for expected behavior\r\n`2.7.2` for the changed behavior which I wasn't expecting","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45919/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45919/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45913","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45913/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45913/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45913/events","html_url":"https://github.com/rails/rails/issues/45913","id":1356482599,"node_id":"I_kwDNIULOUNpIJw","number":45913,"title":"Active Job integration tests for `resque` and `sidekiq` fail with `redis` 5.0.1 and `redis-client` 0.7.1","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-30T23:52:34Z","updated_at":"2022-09-07T17:35:35Z","closed_at":"2022-09-07T17:35:35Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/89114#0182ef6a-4316-4671-981b-3dafdeee29a2\r\n\r\n### Steps to reproduce\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/activejob\r\nbundle update redis --conservative\r\ngit diff\r\nbundle exec rake test:integration:resque\r\nAJ_INTEGRATION_TESTS=1 AJ_ADAPTER=sidekiq bin/test test/integration/queuing_test.rb\r\n```\r\n\r\n### Expected behavior\r\nBoth of Active Job integration tests for `resque` and `sidekiq` should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ git diff\r\ndiff --git a/Gemfile.lock b/Gemfile.lock\r\nindex 28cfa23d9c..c39161f625 100644\r\n--- a/Gemfile.lock\r\n+++ b/Gemfile.lock\r\n@@ -400,7 +400,10 @@ GEM\r\n     rbtree (0.4.5)\r\n     rdoc (6.3.3)\r\n     redcarpet (3.2.3)\r\n-    redis (4.7.1)\r\n+    redis (5.0.1)\r\n+      redis-client (~> 0.7)\r\n+    redis-client (0.7.1)\r\n+      connection_pool\r\n     redis-namespace (1.8.1)\r\n       redis (>= 3.0.4)\r\n     regexp_parser (2.2.1)\r\n$\r\n```\r\n\r\n* for resque `redis-client-0.7.1/lib/redis_client/config.rb:20:in `initialize': unknown keyword: :thread_safe (ArgumentError)`\r\n\r\n```ruby\r\n$ bundle exec rake test:integration:resque\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/ruby -w -I\"lib:test\" /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb \"test/integration/queuing_test.rb\"\r\nUsing resque\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:24: warning: method redefined; discarding old require\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:27: warning: previous definition of require was here\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32454: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32615: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32651: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32740: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32756: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32822: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32863: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32888: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:31984: warning: assigned but unused variable - testEof\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:370: warning: assigned but unused variable - pathlen\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:51: warning: method redefined; discarding old initialize\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_cert\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_file\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_path\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/cookiejar-0.3.3/lib/cookiejar/cookie.rb:183: warning: mismatched indentations at 'end' with 'else' at 181\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/cookiejar-0.3.3/lib/cookiejar/jar.rb:225: warning: mismatched indentations at 'end' with 'else' at 223\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client/config.rb:20:in `initialize': unknown keyword: :thread_safe (ArgumentError)\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client/config.rb:155:in `initialize'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client.rb:122:in `new'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client.rb:122:in `config'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis/client.rb:22:in `config'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis.rb:157:in `initialize_client'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis.rb:73:in `initialize'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/adapters/resque.rb:6:in `new'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/adapters/resque.rb:6:in `setup'\r\n\tfrom /tmp/d20220831-278031-adlbts/dummy/config/initializers/activejob.rb:2:in `<main>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:60:in `load'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:60:in `load'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:673:in `block in load_config_initializer'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:208:in `instrument'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:672:in `load_config_initializer'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:626:in `block (2 levels) in <class:Engine>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:625:in `each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:625:in `block in <class:Engine>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:32:in `instance_exec'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:32:in `run'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:228:in `block in tsort_each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:422:in `block (2 levels) in each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:421:in `block in each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:50:in `each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:50:in `tsort_each_child'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:415:in `call'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:415:in `each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `call'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:226:in `tsort_each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:205:in `tsort_each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:60:in `run_initializers'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/application.rb:372:in `initialize!'\r\n\tfrom /tmp/d20220831-278031-adlbts/dummy/config/environment.rb:5:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/helper.rb:16:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/helper.rb:16:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/helper.rb:12:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/helper.rb:12:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:3:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:3:in `<top (required)>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:21:in `require'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:21:in `block in <main>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:6:in `select'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:6:in `<main>'\r\nrake aborted!\r\nCommand failed with status (1): [ruby -w -I\"lib:test\" /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb \"test/integration/queuing_test.rb\" ]\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/bundle:25:in `load'\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/bundle:25:in `<main>'\r\nTasks: TOP => test:integration:resque\r\n(See full trace by running task with --trace)\r\n$\r\n```\r\n\r\n* for sidekiq\r\n\r\n```ruby\r\n$ AJ_INTEGRATION_TESTS=1 AJ_ADAPTER=sidekiq bin/test test/integration/queuing_test.rb\r\nUsing sidekiq\r\nRun options: --seed 44047\r\n\r\n# Running:\r\n\r\n.F\r\n\r\nFailure:\r\nQueuingTest#test_should_run_jobs_enqueued_on_a_listening_queue [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:13]:\r\nJob AJ-129bbbb5-e8ba-480b-b4b6-5f386868c6e4 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:10\r\n\r\nF\r\n\r\nFailure:\r\nQueuingTest#test_current_timezone_is_kept_while_running_perform_later [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:118]:\r\nJob AJ-a1d7d95b-4a1e-45b9-ab5f-7d50a809fe41 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:109\r\n\r\n.SF\r\n\r\nFailure:\r\nQueuingTest#test_current_locale_is_kept_while_running_perform_later [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:101]:\r\nJob AJ-eaf07152-0f27-4d5d-8b81-4023971c352e was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:92\r\n\r\nSSS.F\r\n\r\nFailure:\r\nQueuingTest#test_should_run_job_enqueued_in_the_future_at_the_specified_time [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:75]:\r\nJob AJ-3152b499-0fbe-4e13-ae37-ccc708eb7784 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:70\r\n\r\n...\r\n\r\nFinished in 34.074661s, 0.4109 runs/s, 0.3522 assertions/s.\r\n14 runs, 12 assertions, 4 failures, 0 errors, 4 skips\r\n\r\nYou have skipped tests. Run with --verbose for details.\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45913/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45913/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45906","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45906/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45906/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45906/events","html_url":"https://github.com/rails/rails/issues/45906","id":1355732552,"node_id":"I_kwDNIULOUM7WSA","number":45906,"title":"High object allocation count from `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs `","user":{"login":"amarchenkoshopify","id":101111422,"node_id":"U_kgDOBgbWfg","avatar_url":"https://avatars.githubusercontent.com/u/101111422?v=4","gravatar_id":"","url":"https://api.github.com/users/amarchenkoshopify","html_url":"https://github.com/amarchenkoshopify","followers_url":"https://api.github.com/users/amarchenkoshopify/followers","following_url":"https://api.github.com/users/amarchenkoshopify/following{/other_user}","gists_url":"https://api.github.com/users/amarchenkoshopify/gists{/gist_id}","starred_url":"https://api.github.com/users/amarchenkoshopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarchenkoshopify/subscriptions","organizations_url":"https://api.github.com/users/amarchenkoshopify/orgs","repos_url":"https://api.github.com/users/amarchenkoshopify/repos","events_url":"https://api.github.com/users/amarchenkoshopify/events{/privacy}","received_events_url":"https://api.github.com/users/amarchenkoshopify/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/81","html_url":"https://github.com/rails/rails/milestone/81","labels_url":"https://api.github.com/repos/rails/rails/milestones/81/labels","id":7591006,"node_id":"MI_kwDNIULOAHPUXg","number":81,"title":"7.0.4","description":"","creator":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","site_admin":false},"open_issues":2,"closed_issues":3,"state":"open","created_at":"2022-01-20T01:51:07Z","updated_at":"2022-08-30T13:21:37Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2022-08-30T12:58:42Z","updated_at":"2022-08-31T12:37:42Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhile working on memory efficiency investigation I noticed that a very big bunch of object allocations comes from a single method `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs`:\r\n\r\n```ruby\r\n      def pool_configs(role = nil)\r\n        if role\r\n          @role_to_shard_mapping[role].values\r\n        else\r\n          @role_to_shard_mapping.flat_map { |_, shard_map| shard_map.values }\r\n        end\r\n      end \r\n```\r\n\r\nThis method is called on every activerecord operation and does not cache its result: could we think about a way of caching its result?\r\n\r\ncc @eileencodes \r\n\r\n### Expected behavior\r\n\r\n`#pool_configs` allocates configs once\r\n\r\n### Actual behavior\r\n\r\n`#pool_configs` allocates configs every time it is executed\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45906/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45906/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45901","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45901/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45901/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45901/events","html_url":"https://github.com/rails/rails/issues/45901","id":1354555667,"node_id":"I_kwDNIULOULzhEw","number":45901,"title":"bin/rails dbconsole should include_password by default","user":{"login":"wpeterson","id":178135,"node_id":"MDQ6VXNlcjE3ODEzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/178135?v=4","gravatar_id":"","url":"https://api.github.com/users/wpeterson","html_url":"https://github.com/wpeterson","followers_url":"https://api.github.com/users/wpeterson/followers","following_url":"https://api.github.com/users/wpeterson/following{/other_user}","gists_url":"https://api.github.com/users/wpeterson/gists{/gist_id}","starred_url":"https://api.github.com/users/wpeterson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wpeterson/subscriptions","organizations_url":"https://api.github.com/users/wpeterson/orgs","repos_url":"https://api.github.com/users/wpeterson/repos","events_url":"https://api.github.com/users/wpeterson/events{/privacy}","received_events_url":"https://api.github.com/users/wpeterson/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-29T16:19:45Z","updated_at":"2022-08-30T00:17:43Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n1. Configure a Rails `config/database.yml` with a `password` required to connect\r\n2. Run `rails dbconsole`\r\n3. See prompt for database password, despite password being configured/available\r\n4. Run `rails dbconsole -p`\r\n5. See dbconsole properly load and use credentials to connect to database for DB console session\r\n\r\n### Expected behavior\r\nWhenever a Rails app has credentials like a password configured for a database, the database console session should use those credentials vs. prompting the user to re-enter a password interactively.  When credentials are not configured and a password is required, we should prompt then.\r\n\r\nThis behavior is implemented since early Rails versions but is disabled by default.  I propose we enable the proper password behavior by default.\r\n\r\n### Actual behavior\r\n`bin/rails dbconsole` always prompts for a password, even when one is configured for the app.\r\n\r\n### System configuration\r\n**Rails version**: All (6.x, 7.x, head)\r\n\r\n**Ruby version**: All \r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45901/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45901/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45899","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45899/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45899/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45899/events","html_url":"https://github.com/rails/rails/issues/45899","id":1353676820,"node_id":"I_kwDNIULOUK94FA","number":45899,"title":"Active Job unit tests fail using que 2.2.0","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-29T04:24:06Z","updated_at":"2022-09-09T15:33:02Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\nActive Job CI has been failing since que 2.2.0 is installed. https://buildkite.com/rails/rails/builds/89068#0182e6b9-7c84-4b85-a651-8d640f5eb076\r\n\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/activejob\r\nbundle update que\r\nAJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\n```\r\n\r\nAlthough there are 3 failures and 75 errors. This script just runs a single test because it looks the root cause is the same.\r\n\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\nIt raises `ArgumentError: wrong number of arguments (given 2, expected 1)`.\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 62302\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nQueuingTest#test_run_queued_job:\r\nArgumentError: wrong number of arguments (given 2, expected 1)\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:78:in `run'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job_methods.rb:51:in `_run'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:248:in `block (2 levels) in _run_attrs'\r\n    (eval):9:in `run_job_middleware'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:247:in `block in _run_attrs'\r\n    <internal:kernel>:90:in `tap'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:246:in `_run_attrs'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:223:in `run'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/support/que/inline.rb:15:in `enqueue'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:66:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:27:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:67:in `block in enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:28:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:27:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:9:in `block (2 levels) in <module:Instrumentation>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:27:in `tag_logger'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:14:in `block (2 levels) in <module:Logging>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:63:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:30:in `perform_later'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/cases/queuing_test.rb:14:in `block in <class:QueuingTest>'\r\n\r\n\r\nbin/test test/cases/queuing_test.rb:13\r\n\r\n\r\n\r\nFinished in 0.008930s, 111.9768 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n\r\n### Additional information\r\n* `require_job_options_kwarg?` always returns `false` because `JobWrapper.method(:enqueue).parameters` does not have any `[:key, :job_options]` \r\nwhere it looks expected to return `true`.\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 32774\r\n\r\n# Running:\r\n\r\n[46, 55] in ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n    46|       end\r\n    47|\r\n    48|       private\r\n    49|         def require_job_options_kwarg?\r\n    50|           require 'debug'\r\n=>  51|           binding.break\r\n    52|           @require_job_options_kwarg ||=\r\n    53|             JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }\r\n    54|         end\r\n    55|\r\n=>#0\tActiveJob::QueueAdapters::QueAdapter#require_job_options_kwarg? at ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:51\r\n  #1\tActiveJob::QueueAdapters::QueAdapter#enqueue(job=#<HelloJob:0x00007fc861807740 @arguments...) at ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:24\r\n  # and 40 frames (use `bt' command for all frames)\r\n(rdbg) JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }    # ruby\r\nfalse\r\n(rdbg) JobWrapper.method(:enqueue).parameters    # ruby\r\n[[:req, :args], [:keyreq, :priority], [:keyreq, :queue], [:key, :run_at]]\r\n(rdbg) quit    # command\r\nReally quit? [Y/n] Y\r\n```\r\n\r\n* By changing `require_job_options_kwarg?` always returns `true`, it raises `ArgumentError: missing keywords: :priority, :queue`\r\n\r\n```ruby\r\n$ git diff\r\ndiff --git a/activejob/lib/active_job/queue_adapters/que_adapter.rb b/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\nindex 41b3633a07..54e8cbc39b 100644\r\n--- a/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n+++ b/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n@@ -47,6 +47,7 @@ def enqueue_at(job, timestamp) # :nodoc:\r\n\r\n       private\r\n         def require_job_options_kwarg?\r\n+          return true\r\n           @require_job_options_kwarg ||=\r\n             JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }\r\n         end\r\n$\r\n```\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 21508\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nQueuingTest#test_run_queued_job:\r\nArgumentError: missing keywords: :priority, :queue\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:65:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:25:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:67:in `block in enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:28:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:27:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:9:in `block (2 levels) in <module:Instrumentation>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:27:in `tag_logger'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:14:in `block (2 levels) in <module:Logging>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:63:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:30:in `perform_later'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/cases/queuing_test.rb:14:in `block in <class:QueuingTest>'\r\n\r\n\r\nbin/test test/cases/queuing_test.rb:13\r\n\r\n\r\n\r\nFinished in 0.008724s, 114.6312 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: $ ruby -v\r\nruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45899/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45998","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45998/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45998/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45998/events","html_url":"https://github.com/rails/rails/issues/45998","id":1368868095,"node_id":"I_kwDNIULOUZdE_w","number":45998,"title":"CSRF getting different token","user":{"login":"Saleh-Salem","id":22606707,"node_id":"MDQ6VXNlcjIyNjA2NzA3","avatar_url":"https://avatars.githubusercontent.com/u/22606707?v=4","gravatar_id":"","url":"https://api.github.com/users/Saleh-Salem","html_url":"https://github.com/Saleh-Salem","followers_url":"https://api.github.com/users/Saleh-Salem/followers","following_url":"https://api.github.com/users/Saleh-Salem/following{/other_user}","gists_url":"https://api.github.com/users/Saleh-Salem/gists{/gist_id}","starred_url":"https://api.github.com/users/Saleh-Salem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Saleh-Salem/subscriptions","organizations_url":"https://api.github.com/users/Saleh-Salem/orgs","repos_url":"https://api.github.com/users/Saleh-Salem/repos","events_url":"https://api.github.com/users/Saleh-Salem/events{/privacy}","received_events_url":"https://api.github.com/users/Saleh-Salem/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-11T08:08:17Z","updated_at":"2022-09-11T10:37:25Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"When validating the CSRF token getting an exception in API\r\n \r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\nthe `session[:_csrf_token]` and  `request.x_csrf_token` is different and getting issue.\r\nwhen I need to skip the csrf, I add `verify_authenticity_token`, In this case, I don't need to skip it.\r\nI debug and found the issue in the method:\r\n\r\n```\r\n  def compare_with_global_token(token, session = nil) # :doc:\r\n    ActiveSupport::SecurityUtils.fixed_length_secure_compare(token, global_csrf_token(session))\r\n  end\r\n```\r\n\r\nwhat is `session[:_csrf_token]` and how can I implement it in API?\r\nIs there any missing from my side?\r\n### Steps to reproduce\r\n\r\n1. Add `protect_from_forgery with: :exception` .\r\n2. When logging in return token in response is generated by `form_authenticity_token`.\r\n3. When Trying to request any POST, PUT or DELETE API get an exception.\r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nReturn Response without exception\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\ngetting an exception when requesting API by FE\r\n\r\n> Can't verify CSRF token authenticity.\r\n> ActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n\r\nGetting an success when requesting API by Postman\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.0.3.5\r\n**Ruby version**:\r\n2.7.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45998/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45998/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45996","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45996/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45996/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45996/events","html_url":"https://github.com/rails/rails/issues/45996","id":1368636436,"node_id":"I_kwDNIULOUZO8FA","number":45996,"title":"Cannot load such file -- redis/connection/hiredis (LoadError)","user":{"login":"qquokka","id":52653737,"node_id":"MDQ6VXNlcjUyNjUzNzM3","avatar_url":"https://avatars.githubusercontent.com/u/52653737?v=4","gravatar_id":"","url":"https://api.github.com/users/qquokka","html_url":"https://github.com/qquokka","followers_url":"https://api.github.com/users/qquokka/followers","following_url":"https://api.github.com/users/qquokka/following{/other_user}","gists_url":"https://api.github.com/users/qquokka/gists{/gist_id}","starred_url":"https://api.github.com/users/qquokka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qquokka/subscriptions","organizations_url":"https://api.github.com/users/qquokka/orgs","repos_url":"https://api.github.com/users/qquokka/repos","events_url":"https://api.github.com/users/qquokka/events{/privacy}","received_events_url":"https://api.github.com/users/qquokka/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-10T14:20:00Z","updated_at":"2022-09-10T15:34:24Z","closed_at":"2022-09-10T15:34:24Z","author_association":"NONE","active_lock_reason":null,"body":"Hi. I'm trying to upgrade the ruby version from 2.6.6 to 2.7.5 and the rails version from 6.0.3.3 to 6.1.7 of my existing project, which works well now. The problem is that Rails cannot load a certain file related with the redis gem although I've changed nothing but the ruby and the rails version. Is the redis version not corresponding to the rails's?\r\n\r\n### Steps to reproduce\r\nThe below codes are written in [the hiredis gem README](https://github.com/redis/hiredis-rb#redis-rb)\r\n\r\n```ruby\r\n# Gemfile\r\n\r\ngem \"hiredis\", '0.6.3'\r\ngem 'redis', '5.0.4', :require => [\"redis\", \"redis/connection/hiredis\"]\r\ngem 'redis-namespace', '1.9.0'\r\n```\r\n\r\n```bash\r\n$ bundle install\r\n\r\n$ rails s\r\n```\r\n\r\n### Expected behavior\r\nSuccessfully run the server.\r\n\r\n### Actual behavior\r\n```bash\r\n$ rails s\r\n\r\nTraceback (most recent call last):\r\n\t25: from bin/rails:6:in `<main>'\r\n\t24: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t23: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t22: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands.rb:18:in `<main>'\r\n\t21: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/command.rb:48:in `invoke'\r\n\t20: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/command/base.rb:69:in `perform'\r\n\t19: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\t18: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\t17: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\t16: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:135:in `perform'\r\n\t15: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:135:in `tap'\r\n\t14: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/railties-6.1.7/lib/rails/commands/server/server_command.rb:138:in `block in perform'\r\n\t13: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:332:in `require'\r\n\t12: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:299:in `load_dependency'\r\n\t11: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/activesupport-6.1.7/lib/active_support/dependencies.rb:332:in `block in require'\r\n\t10: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t 9: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:33:in `require'\r\n\t 8: from /Users/yanghyejin/workspace/deali/bird/config/application.rb:23:in `<main>'\r\n\t 7: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler.rb:174:in `require'\r\n\t 6: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:58:in `require'\r\n\t 5: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:58:in `each'\r\n\t 4: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:69:in `block in require'\r\n\t 3: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:69:in `each'\r\n\t 2: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/2.7.0/bundler/runtime.rb:74:in `block (2 levels) in require'\r\n\t 1: from /Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:18:in `require'\r\n/Users/yanghyejin/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:18:in `require': cannot load such file -- redis/connection/hiredis (LoadError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.7\r\n\r\n**Ruby version**: 2.7.5\r\n\r\nChipset: M1(mac)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45996/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45996/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45994","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45994/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45994/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45994/events","html_url":"https://github.com/rails/rails/issues/45994","id":1368555704,"node_id":"I_kwDNIULOUZKAuA","number":45994,"title":"LoadInterlockAwareMonitor deadlock when clearing cache (multiple databases, test)","user":{"login":"kuahyeow","id":16723,"node_id":"MDQ6VXNlcjE2NzIz","avatar_url":"https://avatars.githubusercontent.com/u/16723?v=4","gravatar_id":"","url":"https://api.github.com/users/kuahyeow","html_url":"https://github.com/kuahyeow","followers_url":"https://api.github.com/users/kuahyeow/followers","following_url":"https://api.github.com/users/kuahyeow/following{/other_user}","gists_url":"https://api.github.com/users/kuahyeow/gists{/gist_id}","starred_url":"https://api.github.com/users/kuahyeow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuahyeow/subscriptions","organizations_url":"https://api.github.com/users/kuahyeow/orgs","repos_url":"https://api.github.com/users/kuahyeow/repos","events_url":"https://api.github.com/users/kuahyeow/events{/privacy}","received_events_url":"https://api.github.com/users/kuahyeow/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-10T08:52:46Z","updated_at":"2022-09-10T08:56:12Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With multiple databases, we observe hangs within system tests.\r\n\r\nSee also https://gitlab.com/gitlab-org/gitlab/-/issues/371468 (GitLab is at Rails 6.1, Ruby 2.7.5)\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nHere's a minimal reproduction with Rails 7.0.3.1\r\n\r\n1. Checkout https://gitlab.com/tkuah/multi_database_system_test\r\n2. `bundle install`\r\n3. `bundle exec rails db:migrate`\r\n4. `bundle rails test test/system/home_pages_test.rb`\r\n\r\nThe conditions are:\r\n\r\n1. Multiple databases\r\n2. System test where there's an async request which overlaps with the main thread\r\n\r\n### Expected behavior\r\n\r\nIt does not hang, and the test completes\r\n\r\n### Actual behavior\r\n\r\nIt hangs. It looks like it's hanging when clearing query cache (see https://gitlab.com/gitlab-org/gitlab/-/issues/371468#note_1087203883, and https://gitlab.com/gitlab-org/gitlab/-/issues/371468#note_1088779499)\r\n\r\nA backtrace dump taken while the test is hanging [sigdump-68442.log](https://github.com/rails/rails/files/9539878/sigdump-68442.log)\r\n\r\nMy suspicion is that:\r\n\r\n1. `lock_thread` is true for system tests\r\n3. Therefore both the main thread, and the Puma thread attempt to clear query cache for the same set of connections\r\n\r\nSo we have two connections:\r\n\r\n1. Puma thread takes a `LoadInterlockAwareMonitor` lock for primary connection via `Post.transaction`\r\n2. Main thread takes a `LoadInterlockAwareMonitor` lock for animal connection via implicit transaction that `create` does\r\n3. Due to 2, main thread attempts to clear query cache for primary connection. **Waits for 1's lock**\r\n4. Due to 1, and because of `lock_thread`, puma thread clears query cache for primary connection. It takes a `LoadInterlockAwareMonitor` lock for primary connection which succeds\r\n5. Due to 1, puma thread now attempts clears query cache for animal connection. **Waits for 2's lock**\r\n\r\nSee [`clear_query_caches_for_current_thread` method](https://github.com/rails/rails/blob/e24fbf71fa0a10f63346b9b42604451958740844/activerecord/lib/active_record/connection_handling.rb#L244-L248)\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: ruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45994/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45994/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45988","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45988/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45988/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45988/events","html_url":"https://github.com/rails/rails/issues/45988","id":1368343535,"node_id":"I_kwDNIULOUY9D7w","number":45988,"title":"Incorrect link present when using the help menu -h, under -c option.","user":{"login":"creaturenex","id":15052690,"node_id":"MDQ6VXNlcjE1MDUyNjkw","avatar_url":"https://avatars.githubusercontent.com/u/15052690?v=4","gravatar_id":"","url":"https://api.github.com/users/creaturenex","html_url":"https://github.com/creaturenex","followers_url":"https://api.github.com/users/creaturenex/followers","following_url":"https://api.github.com/users/creaturenex/following{/other_user}","gists_url":"https://api.github.com/users/creaturenex/gists{/gist_id}","starred_url":"https://api.github.com/users/creaturenex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/creaturenex/subscriptions","organizations_url":"https://api.github.com/users/creaturenex/orgs","repos_url":"https://api.github.com/users/creaturenex/repos","events_url":"https://api.github.com/users/creaturenex/events{/privacy}","received_events_url":"https://api.github.com/users/creaturenex/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-09T21:24:01Z","updated_at":"2022-09-09T21:37:32Z","closed_at":"2022-09-09T21:37:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nrails -h\r\n\r\nunder the option\r\n -c, [--css=CSS]\r\n \r\n clicking on link provided generate an 404 error due to wrong address\r\n \r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Need some help running the test script, based on the provided list most like have to use generic_main.rb\r\n\r\n# The correction is simple, just removed the unnecessary bracket from the link\r\n```\r\n\r\n### Expected behavior\r\nLink should open to\r\nhttps://github.com/rails/cssbundling-rails\r\n\r\n### Actual behavior\r\n404 error due to wrong link\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45988/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45988/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45984","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45984/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45984/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45984/events","html_url":"https://github.com/rails/rails/issues/45984","id":1368144421,"node_id":"I_kwDNIULOUYw6JQ","number":45984,"title":"Cannot Eager Load has_many :through Relationships with custom scope","user":{"login":"dcorrigan","id":2445528,"node_id":"MDQ6VXNlcjI0NDU1Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/2445528?v=4","gravatar_id":"","url":"https://api.github.com/users/dcorrigan","html_url":"https://github.com/dcorrigan","followers_url":"https://api.github.com/users/dcorrigan/followers","following_url":"https://api.github.com/users/dcorrigan/following{/other_user}","gists_url":"https://api.github.com/users/dcorrigan/gists{/gist_id}","starred_url":"https://api.github.com/users/dcorrigan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dcorrigan/subscriptions","organizations_url":"https://api.github.com/users/dcorrigan/orgs","repos_url":"https://api.github.com/users/dcorrigan/repos","events_url":"https://api.github.com/users/dcorrigan/events{/privacy}","received_events_url":"https://api.github.com/users/dcorrigan/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-09T17:47:35Z","updated_at":"2022-09-09T17:47:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThis seems like it's the same as #28324, but I'm still seeing the issue in Rails 7. \r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :images, force: true do |t|\r\n    t.string :title\r\n    t.integer :post_id\r\n  end\r\n\r\n  create_table :captions, force: true do |t|\r\n    t.integer :image_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :images\r\n  has_many :captions, lambda { order('images.title DESC') }, through: :images\r\nend\r\n\r\nclass Image < ActiveRecord::Base\r\n  belongs_to :post\r\n  has_one :caption\r\nend\r\n\r\nclass Caption < ActiveRecord::Base\r\n  belongs_to :image\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_preload_has_many_through_association_with_scope\r\n    post = Post.create!\r\n    image = Image.create!\r\n    image.caption = Caption.create!\r\n    post.images << image\r\n    post.save!\r\n\r\n    # Access through the model works\r\n    assert_includes post.captions, Caption.first\r\n\r\n    # Query with association preloaded does not.\r\n    # When evaluated, it will apply the scope without the relevant JOIN table:\r\n    # SELECT \"captions\".* FROM \"captions\" WHERE \"captions\".\"image_id\" = ? ORDER BY images.title DESC\r\n    preloaded = Post.where(id: post.id).includes(:captions)\r\n\r\n    assert_includes preloaded.first.captions, Caption.first\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe test passes and we're able to eager load has_many :through associations with custom scopes in this way.\r\n\r\nI realize this can be fixed by adding a `references(:images)` to the query, but it seems reasonable to expect AR to infer that that the join is necessary here.\r\n\r\n### Actual behavior\r\n\r\nTest fails with an error: `ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: images.title`\r\n\r\n### System configuration\r\n**Rails version**: 7.0 \r\n\r\n**Ruby version**: 3.1.2p20\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45984/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45984/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45983","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45983/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45983/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45983/events","html_url":"https://github.com/rails/rails/issues/45983","id":1368057899,"node_id":"I_kwDNIULOUYroKw","number":45983,"title":"ApplicationTests::TestRunnerTest#test_load_fixtures_when_running_test_suites fails with Ruby 3.2.0.preview2","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-09T16:27:15Z","updated_at":"2022-09-10T14:43:42Z","closed_at":"2022-09-10T14:43:42Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/89320#01831efc-b45c-406b-8ae1-b73e9410ad8c\r\n\r\nAccording to git bisect, this behavior changed via https://bugs.ruby-lang.org/issues/18784\r\nhttps://github.com/ruby/ruby/commit/983115cf3c8f75b1afbe3274f02c1529e1ce3a81\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\ncd rails/railties\r\nrm ../Gemfile.lock\r\nbundle install\r\nbin/test test/application/test_runner_test.rb -n test_load_fixtures_when_running_test_suites\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nApplicationTests::TestRunnerTest#test_load_fixtures_when_running_test_suites:\r\nErrno::EISDIR: Is a directory @ apply2files - test/models\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2300:in `unlink'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2300:in `block in remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2305:in `platform_support'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:2299:in `remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1449:in `remove_file'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1189:in `block in rm'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1188:in `each'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1188:in `rm'\r\n    /home/yahonda/.rbenv/versions/3.2.0-preview2/lib/ruby/3.2.0+2/fileutils.rb:1211:in `rm_f'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `block (2 levels) in test_load_fixtures_when_running_test_suites'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `chdir'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:254:in `block in test_load_fixtures_when_running_test_suites'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:250:in `each'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/test_runner_test.rb:250:in `test_load_fixtures_when_running_test_suites'\r\n\r\n\r\nbin/test test/application/test_runner_test.rb:246\r\n\r\n\r\n\r\nFinished in 2.319535s, 0.4311 runs/s, 0.8622 assertions/s.\r\n1 runs, 2 assertions, 0 failures, 1 errors, 0 skips\r\nyahonda@myryzen:~/src/github.com/rails/rails/railties$ ruby -v\r\nruby 3.2.0preview2 (2022-09-09 master 35cfc9a3bb) [x86_64-linux]\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.2.0preview2 (2022-09-09 master 35cfc9a3bb) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45983/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45983/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45967","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45967/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45967/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45967/events","html_url":"https://github.com/rails/rails/issues/45967","id":1366038829,"node_id":"I_kwDNIULOUWwZLQ","number":45967,"title":"Inconsistent update of timestamps while updating associations with *_ids=","user":{"login":"matthee","id":547653,"node_id":"MDQ6VXNlcjU0NzY1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/547653?v=4","gravatar_id":"","url":"https://api.github.com/users/matthee","html_url":"https://github.com/matthee","followers_url":"https://api.github.com/users/matthee/followers","following_url":"https://api.github.com/users/matthee/following{/other_user}","gists_url":"https://api.github.com/users/matthee/gists{/gist_id}","starred_url":"https://api.github.com/users/matthee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthee/subscriptions","organizations_url":"https://api.github.com/users/matthee/orgs","repos_url":"https://api.github.com/users/matthee/repos","events_url":"https://api.github.com/users/matthee/events{/privacy}","received_events_url":"https://api.github.com/users/matthee/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-08T10:51:09Z","updated_at":"2022-09-09T03:10:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"ActiveRecord inconsistently updates the `updated_at` column when changing `has_many through:` associations.\r\n\r\n### Steps to reproduce\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"activesupport\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"active_support/testing/time_helpers\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.timestamps\r\n  end\r\n  \r\n  create_table :tags, force: true do |t|\r\n  end\r\n\r\n  create_table :taggings, force: true do |t|\r\n    t.integer :post_id\r\n    t.integer :tag_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :taggings, dependent: :destroy\r\n  \r\n  has_many :tags, through: :taggings\r\nend\r\n\r\nclass Tagging < ActiveRecord::Base\r\n  belongs_to :post, touch: true\r\n  belongs_to :tag\r\nend\r\n\r\nclass Tag < ActiveRecord::Base\r\n  has_many :taggings\r\n  has_many :posts, through: :taggings\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  include ActiveSupport::Testing::TimeHelpers\r\n  \r\n  def test_updated_at_is_updated_when_setting_has_many_through_association\r\n    freeze_time\r\n        \r\n    tag_1 = Tag.create!\r\n    tag_2 = Tag.create!\r\n      \r\n    post = Post.create!\r\n    \r\n    travel_to(now = 1.hour.from_now)\r\n    \r\n    # Adding tags updates post.updated_at\r\n    post.update(tag_ids: [tag_1.id, tag_2.id])\r\n    assert_in_delta now, post.updated_at, 1.second, \"post#updated_at was not updated when adding tags\"\r\n    \r\n    # Removing tags does not update post.updated_at :(\r\n    travel_to(now = 2.hours.from_now)\r\n    post.update(tag_ids: [tag_1.id])\r\n    assert_in_delta now, post.updated_at, 1.second, \"post#updated_at was not updated when removing tags\"\r\n  end\r\n  \r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nIn the example above, both `.update` calls should update the `updated_at` column of the post record. (when adding and removing records)\r\n\r\n### Actual behavior\r\n\r\nWhen deleting a record, the `updated_at` timestamp is not updated.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3.1\r\n**Ruby version**:\r\n3.0.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45967/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45967/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45960","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45960/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45960/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45960/events","html_url":"https://github.com/rails/rails/issues/45960","id":1364924787,"node_id":"I_kwDNIULOUVsZcw","number":45960,"title":"Encrypted values for default values in test fixures do not work","user":{"login":"gjtorikian","id":64050,"node_id":"MDQ6VXNlcjY0MDUw","avatar_url":"https://avatars.githubusercontent.com/u/64050?v=4","gravatar_id":"","url":"https://api.github.com/users/gjtorikian","html_url":"https://github.com/gjtorikian","followers_url":"https://api.github.com/users/gjtorikian/followers","following_url":"https://api.github.com/users/gjtorikian/following{/other_user}","gists_url":"https://api.github.com/users/gjtorikian/gists{/gist_id}","starred_url":"https://api.github.com/users/gjtorikian/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gjtorikian/subscriptions","organizations_url":"https://api.github.com/users/gjtorikian/orgs","repos_url":"https://api.github.com/users/gjtorikian/repos","events_url":"https://api.github.com/users/gjtorikian/events{/privacy}","received_events_url":"https://api.github.com/users/gjtorikian/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-07T16:34:59Z","updated_at":"2022-09-08T08:46:19Z","closed_at":"2022-09-08T08:46:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've been tracking down a bug which seems related to https://github.com/rails/rails/pull/45033 (cc @jorgemanrubia). \r\n\r\nIn short, it seems that default values are still not encrypted/decrypted properly when working with test fixtures. Attempting to load a test fixture that has an encrypted attribute with a default value yields `ActiveRecord::Encryption::Errors::Decryption`.\r\n\r\nHere's a reproducible test case:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"pg\"\r\n  gem \"debug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\nrequire \"debug\"\r\n\r\npg_opts = {adapter: \"postgresql\", database: \"jsonb_activerecord_issue\"}\r\nbegin\r\n  ActiveRecord::Base.establish_connection(pg_opts.except(:database))\r\n  ActiveRecord::Base.connection.create_database(pg_opts[:database])\r\n  puts \"Database #{pg_opts[:database]} was created.\"\r\nrescue => ActiveRecord::DatabaseAlreadyExists\r\n  puts \"Database #{pg_opts[:database]} alredy exists.\"\r\nend\r\nActiveRecord::Base.establish_connection(pg_opts)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass ActiveRecord::Encryption::Config\r\n  def primary_key\r\n    \"id\"\r\n  end\r\n\r\n  def key_derivation_salt\r\n    \"salt\"\r\n  end\r\nend\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :installations, force: true do |t|\r\n    t.string :name\r\n    t.jsonb :credentials, null: false, default: {}\r\n  end\r\nend\r\n\r\nclass Installation < ActiveRecord::Base\r\n  encrypts :credentials\r\nend\r\n\r\nrequire 'active_record/fixtures'\r\nActiveRecord::FixtureSet.create_fixtures(\".\", 'installations')\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_creating_record\r\n    valid_installation = Installation.create(name: \"valid\")\r\n    assert valid_installation.valid?\r\n    valid_installation.update(name: \"this is valid\")\r\n    assert valid_installation.valid?\r\n  end\r\n\r\n  def test_loading_record\r\n    loaded_installation = Installation.find ActiveRecord::FixtureSet.identify(:foo)\r\n    assert loaded_installation.valid?\r\n    loaded_installation.update(name: \"this is still not\")\r\n    assert loaded_installation.valid?\r\n  end\r\nend\r\n```\r\n\r\nThe associated YAML file is:\r\n\r\n```yml\r\nfoo:\r\n  name: \"Installation\"\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe test fixture should be able to load.\r\n### Actual behavior\r\n\r\nAn exception is thrown:\r\n\r\n<details>\r\n<pre>\r\nActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encryptor.rb:58:in `rescue in decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encryptor.rb:52:in `decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:73:in `block in decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/scheme.rb:64:in `with_context'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:15:in `with_context'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:72:in `decrypt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/encryption/encrypted_attribute_type.rb:31:in `deserialize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute.rb:168:in `type_cast'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute.rb:43:in `value'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set/builder.rb:43:in `fetch_value'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:405:in `block in restore_transaction_record_state'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set.rb:98:in `transform_values'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activemodel/lib/active_model/attribute_set.rb:98:in `map'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:404:in `restore_transaction_record_state'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:336:in `rolledback!'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:159:in `rollback_records'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:448:in `block in rollback_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:441:in `rollback_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:464:in `rescue in block in within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:458:in `block in within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:453:in `within_new_transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/transactions.rb:352:in `with_transaction_returning_status'\r\n    /Users/gjtorikian/.gem/bundler/gems/rails-01d345c4d6b9/activerecord/lib/active_record/persistence.rb:792:in `update'\r\n    jsonb_bug.rb:59:in `test_jsonb_encryption'\r\n</pre>\r\n</details>\r\n\r\n### System configuration\r\n**Rails version**: 7.1.0 (current edge)\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45960/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45960/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45959","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45959/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45959/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45959/events","html_url":"https://github.com/rails/rails/issues/45959","id":1364232810,"node_id":"I_kwDNIULOUVCKag","number":45959,"title":"JSON field not saving data with symbol : and it's saving with arrow =>","user":{"login":"sajjadmurtaza","id":8552702,"node_id":"MDQ6VXNlcjg1NTI3MDI=","avatar_url":"https://avatars.githubusercontent.com/u/8552702?v=4","gravatar_id":"","url":"https://api.github.com/users/sajjadmurtaza","html_url":"https://github.com/sajjadmurtaza","followers_url":"https://api.github.com/users/sajjadmurtaza/followers","following_url":"https://api.github.com/users/sajjadmurtaza/following{/other_user}","gists_url":"https://api.github.com/users/sajjadmurtaza/gists{/gist_id}","starred_url":"https://api.github.com/users/sajjadmurtaza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sajjadmurtaza/subscriptions","organizations_url":"https://api.github.com/users/sajjadmurtaza/orgs","repos_url":"https://api.github.com/users/sajjadmurtaza/repos","events_url":"https://api.github.com/users/sajjadmurtaza/events{/privacy}","received_events_url":"https://api.github.com/users/sajjadmurtaza/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-07T07:40:12Z","updated_at":"2022-09-08T07:23:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have JSON field in my database `t.json \"theme\"`. When I try to save the field hash with : , it's overridden before save\r\ne.g.\r\n`object.theme = { color: 'red' }` it always change to `{ color => 'red' }`\r\n\r\ni also tried with jsonb and default value with empty hash {} but still having the same issue.\r\n\r\n\r\nI want to save the JSON data hash with symbol keys `{ color: 'red' }`\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.0\r\n\r\n**Ruby version**: 2.7.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45959/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45959/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45949","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45949/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45949/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45949/events","html_url":"https://github.com/rails/rails/issues/45949","id":1362899537,"node_id":"I_kwDNIULOUTwyUQ","number":45949,"title":"ActionText::Attachable#as_json override is breaking ActiveStorage::Blob#as_json when blob is not persisted","user":{"login":"balbesina","id":7312369,"node_id":"MDQ6VXNlcjczMTIzNjk=","avatar_url":"https://avatars.githubusercontent.com/u/7312369?v=4","gravatar_id":"","url":"https://api.github.com/users/balbesina","html_url":"https://github.com/balbesina","followers_url":"https://api.github.com/users/balbesina/followers","following_url":"https://api.github.com/users/balbesina/following{/other_user}","gists_url":"https://api.github.com/users/balbesina/gists{/gist_id}","starred_url":"https://api.github.com/users/balbesina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/balbesina/subscriptions","organizations_url":"https://api.github.com/users/balbesina/orgs","repos_url":"https://api.github.com/users/balbesina/repos","events_url":"https://api.github.com/users/balbesina/events{/privacy}","received_events_url":"https://api.github.com/users/balbesina/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-06T08:26:39Z","updated_at":"2022-09-06T08:26:39Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nfrom rails console:\r\n```ruby\r\nActiveStorage::Blob.build_after_unfurling(io: StringIO.new('asd'), filename: 'asd.txt').as_json\r\n```\r\n\r\n[Reproduction script](https://gist.github.com/balbesina/30fbdafbfee4b71b06209d9e950f4128)\r\n\r\n### Expected behavior\r\nActiveStorage::Blob#as_json returns a Hash\r\n\r\n### Actual behavior\r\nActiveStorage::Blob#as_json raises exception\r\n```\r\n/Users/dhh/.rvm/gems/ruby-3.1.2/gems/globalid-1.0.0/lib/global_id/uri/gid.rb:167:in `validate_model_id': \r\nUnable to create a Global ID for ActiveStorage::Blob without a model id. (URI::GID::MissingModelIdError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3.1\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45949/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45939","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45939/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45939/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45939/events","html_url":"https://github.com/rails/rails/issues/45939","id":1360876688,"node_id":"I_kwDNIULOUR1UkA","number":45939,"title":"Validations aren't inherited from base model if child is called before validation declaration","user":{"login":"Exterm1nate","id":48535087,"node_id":"MDQ6VXNlcjQ4NTM1MDg3","avatar_url":"https://avatars.githubusercontent.com/u/48535087?v=4","gravatar_id":"","url":"https://api.github.com/users/Exterm1nate","html_url":"https://github.com/Exterm1nate","followers_url":"https://api.github.com/users/Exterm1nate/followers","following_url":"https://api.github.com/users/Exterm1nate/following{/other_user}","gists_url":"https://api.github.com/users/Exterm1nate/gists{/gist_id}","starred_url":"https://api.github.com/users/Exterm1nate/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Exterm1nate/subscriptions","organizations_url":"https://api.github.com/users/Exterm1nate/orgs","repos_url":"https://api.github.com/users/Exterm1nate/repos","events_url":"https://api.github.com/users/Exterm1nate/events{/privacy}","received_events_url":"https://api.github.com/users/Exterm1nate/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-09-03T14:46:42Z","updated_at":"2022-09-08T07:26:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nLet's create some STI models. Base `Vehicle` and two childs `Car` and `Motorcycle`.\r\n\r\n```ruby\r\n# models/vehicle.rb\r\nclass Vehicle < ApplicationRecord\r\n  TYPES = [Car, Motorcycle].freeze\r\n\r\n  validates :color, uniqueness: { scope: :model }\r\nend\r\n\r\n# models/car.rb\r\nclass Car < Vehicle\r\nend\r\n\r\n# models/motorcycle.rb\r\nclass Motorcycle < Vehicle\r\nend\r\n```\r\n\r\nAfter that we want to use `#validators_on` method to make sure the validation is present.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\nCar.validators_on(:color)\r\nMotorcycle.validators_on(:color)\r\n```\r\n\r\n### Expected behavior\r\n\r\nAll models must contain the validation.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nMotorcycle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\n```\r\n\r\n### Actual behavior\r\n\r\nBut for childs this method returns nothing.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> []\r\nMotorcycle.validators_on(:color)\r\n#=> []\r\n```\r\n\r\n### Notes\r\n\r\nIf we remove the `TYPES` constant (or just child classes calls from it) `validators_on` works as expected. Let's change original code a little bit:\r\n\r\n```ruby\r\n# models/vehicle.rb\r\nclass Vehicle < ApplicationRecord\r\n  TYPES = [Car].freeze # Motorcycle was removed from here!\r\n\r\n  validates :color, uniqueness: { scope: :model }\r\nend\r\n```\r\n\r\nAnd after that test again.\r\n\r\n```ruby\r\nVehicle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\nCar.validators_on(:color)\r\n#=> []\r\nMotorcycle.validators_on(:color)\r\n#=> [#<ActiveRecord::Validations::UniquenessValidator @attributes=[:color], @options={:scope=>:model}, @klass=Vehicle>]\r\n```\r\n\r\n`Motorcycle` validation was returned correctly this time.\r\n\r\nIt seems to be a load error. `Car` was called before the `Vehicle`'s validation declaration, so it doesn't take this validation into account. It may also depend on loading order.\r\n\r\nNotice that validation itself is working well in all models.\r\n\r\n```ruby\r\nCar.create!(color: \"black\", model: \"Boomer\")\r\nCar.create!(color: \"black\", model: \"Boomer\") # raises ActiveRecord::RecordInvalid\r\n\r\nMotorcycle.create!(color: \"red\", model: \"Yamaha\")\r\nMotorcycle.create!(color: \"red\", model: \"Yamaha\") # raises ActiveRecord::RecordInvalid\r\n```\r\n\r\nExample project: https://github.com/Exterm1nate/rails-validation-issue\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45939/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45937","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45937/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45937/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45937/events","html_url":"https://github.com/rails/rails/issues/45937","id":1360779604,"node_id":"I_kwDNIULOURvZVA","number":45937,"title":"Add strict table mode (by default) to sqlite adapter","user":{"login":"jrz","id":149668,"node_id":"MDQ6VXNlcjE0OTY2OA==","avatar_url":"https://avatars.githubusercontent.com/u/149668?v=4","gravatar_id":"","url":"https://api.github.com/users/jrz","html_url":"https://github.com/jrz","followers_url":"https://api.github.com/users/jrz/followers","following_url":"https://api.github.com/users/jrz/following{/other_user}","gists_url":"https://api.github.com/users/jrz/gists{/gist_id}","starred_url":"https://api.github.com/users/jrz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrz/subscriptions","organizations_url":"https://api.github.com/users/jrz/orgs","repos_url":"https://api.github.com/users/jrz/repos","events_url":"https://api.github.com/users/jrz/events{/privacy}","received_events_url":"https://api.github.com/users/jrz/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-09-03T07:01:02Z","updated_at":"2022-09-08T07:30:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"SQLite supports 'strict tables' since 3.37.1 https://sqlite.org/stricttables.html\r\n\r\nThis forces a datatype to be specified when creating a table. This is the preferred method in any application created by developers. \r\n\r\nUnspecified/ANY datatypes are useful for quick tryouts as an enduser, similar to excel. But it's counterproductive when creating an application.\r\n\r\nIf this will become a configurable setting, the default should be set to strict.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45937/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45937/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45930","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45930/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45930/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45930/events","html_url":"https://github.com/rails/rails/issues/45930","id":1360031019,"node_id":"I_kwDNIULOURBtKw","number":45930,"title":"rails test not working in windows by default: FFI is required","user":{"login":"githubrarp","id":37696113,"node_id":"MDQ6VXNlcjM3Njk2MTEz","avatar_url":"https://avatars.githubusercontent.com/u/37696113?v=4","gravatar_id":"","url":"https://api.github.com/users/githubrarp","html_url":"https://github.com/githubrarp","followers_url":"https://api.github.com/users/githubrarp/followers","following_url":"https://api.github.com/users/githubrarp/following{/other_user}","gists_url":"https://api.github.com/users/githubrarp/gists{/gist_id}","starred_url":"https://api.github.com/users/githubrarp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/githubrarp/subscriptions","organizations_url":"https://api.github.com/users/githubrarp/orgs","repos_url":"https://api.github.com/users/githubrarp/repos","events_url":"https://api.github.com/users/githubrarp/events{/privacy}","received_events_url":"https://api.github.com/users/githubrarp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-02T10:55:04Z","updated_at":"2022-09-02T12:00:34Z","closed_at":"2022-09-02T12:00:34Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nrails test\r\n\r\n# Your reproduction script goes here\r\n`rescue in <main>': FFI is a required pre-requisite for Windows or posix_spawn support in the ChildProcess gem. Ensure the `ffi` gem is installed. If you believe this is an error, please file a bug at http://github.com/enkessler/childprocess/issues\r\n\r\n### Expected behavior\r\ntest to run\r\n\r\n### Actual behavior\r\nerror shows up\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.0.3p157\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45930/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45929","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45929/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45929/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45929/events","html_url":"https://github.com/rails/rails/issues/45929","id":1359850725,"node_id":"I_kwDNIULOUQ2s5Q","number":45929,"title":"cannot send mail in rails","user":{"login":"hminhduc","id":6736560,"node_id":"MDQ6VXNlcjY3MzY1NjA=","avatar_url":"https://avatars.githubusercontent.com/u/6736560?v=4","gravatar_id":"","url":"https://api.github.com/users/hminhduc","html_url":"https://github.com/hminhduc","followers_url":"https://api.github.com/users/hminhduc/followers","following_url":"https://api.github.com/users/hminhduc/following{/other_user}","gists_url":"https://api.github.com/users/hminhduc/gists{/gist_id}","starred_url":"https://api.github.com/users/hminhduc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hminhduc/subscriptions","organizations_url":"https://api.github.com/users/hminhduc/orgs","repos_url":"https://api.github.com/users/hminhduc/repos","events_url":"https://api.github.com/users/hminhduc/events{/privacy}","received_events_url":"https://api.github.com/users/hminhduc/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-09-02T08:08:16Z","updated_at":"2022-09-02T08:47:42Z","closed_at":"2022-09-02T08:47:42Z","author_association":"NONE","active_lock_reason":null,"body":"im using gmail smtp to send mail in my rails app to now. recenly activejob peformed but mail not received in mail box.\r\nhave google changed policy?\r\n\r\nGmail SMTP server address: smtp.gmail.com.\r\nGmail SMTP name: Your full name.\r\nGmail SMTP username: Your full Gmail email address (e.g. xyz@gmail.com)\r\nGmail SMTP password: The password you use to log in to Gmail.\r\nGmail SMTP port (TLS): 587.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45929/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45929/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45922","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45922/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45922/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45922/events","html_url":"https://github.com/rails/rails/issues/45922","id":1358965338,"node_id":"I_kwDNIULOUQAqWg","number":45922,"title":"ActiveStorage installation migration ignores `ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type`","user":{"login":"compeak","id":1942208,"node_id":"MDQ6VXNlcjE5NDIyMDg=","avatar_url":"https://avatars.githubusercontent.com/u/1942208?v=4","gravatar_id":"","url":"https://api.github.com/users/compeak","html_url":"https://github.com/compeak","followers_url":"https://api.github.com/users/compeak/followers","following_url":"https://api.github.com/users/compeak/following{/other_user}","gists_url":"https://api.github.com/users/compeak/gists{/gist_id}","starred_url":"https://api.github.com/users/compeak/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/compeak/subscriptions","organizations_url":"https://api.github.com/users/compeak/orgs","repos_url":"https://api.github.com/users/compeak/repos","events_url":"https://api.github.com/users/compeak/events{/privacy}","received_events_url":"https://api.github.com/users/compeak/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-09-01T14:43:38Z","updated_at":"2022-09-01T21:52:30Z","closed_at":"2022-09-01T21:52:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Installing ActiveStorage with `bin/rails active_storage:install` after setting `ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type = :timestamptz` results in `timestamp without time zone` columns, because [activestorage/db/migrate/20170806125915_create_active_storage_tables.rb](https://github.com/rails/rails/blob/main/activestorage/db/migrate/20170806125915_create_active_storage_tables.rb) is a `5.2` migration.\r\n\r\nI don't know whether this is a bug or intended behaviour.\r\n\r\n### Steps to reproduce\r\n\r\nCreate new Rails app:\r\n\r\n```bash\r\nrails new testcase\r\n```\r\n\r\nSet `PostgreSQLAdapter.datetime_type`:\r\n\r\n`config/initializers/postgres.rb`:\r\n```ruby\r\nrequire 'active_record/connection_adapters/postgresql_adapter'\r\nActiveRecord::ConnectionAdapters::PostgreSQLAdapter.datetime_type = :timestamptz\r\n```\r\n\r\nRun ActiveStorage installation task:\r\n```bash\r\nbin/rails active_storage:install\r\n```\r\n\r\nRun migration:\r\n```bash\r\nbin/rails db:migrate\r\n```\r\n\r\n### Expected behavior\r\n\r\nAll `datetime` columns should be created as `timestamp(6) with time zone`.\r\n\r\nExample:\r\n\r\n```\r\n                                         Table \"public.active_storage_attachments\"\r\n   Column    |            Type             | Collation | Nullable |                        Default                         \r\n-------------+-----------------------------+-----------+----------+--------------------------------------------------------\r\n id          | bigint                      |           | not null | nextval('active_storage_attachments_id_seq'::regclass)\r\n name        | character varying           |           | not null | \r\n record_type | character varying           |           | not null | \r\n record_id   | bigint                      |           | not null | \r\n blob_id     | bigint                      |           | not null | \r\n created_at  | timestamp(6) with time zone |           | not null | \r\n```\r\n\r\n### Actual behavior\r\n\r\n`datetime` columns are created as `timestamp(6) without time zone`.\r\n\r\nExample:\r\n\r\n```\r\n                                          Table \"public.active_storage_attachments\"\r\n   Column    |              Type              | Collation | Nullable |                        Default                         \r\n-------------+--------------------------------+-----------+----------+--------------------------------------------------------\r\n id          | bigint                         |           | not null | nextval('active_storage_attachments_id_seq'::regclass)\r\n name        | character varying              |           | not null | \r\n record_type | character varying              |           | not null | \r\n record_id   | bigint                         |           | not null | \r\n blob_id     | bigint                         |           | not null | \r\n created_at  | timestamp(6) without time zone |           | not null | \r\n```\r\n\r\n### Possible fix\r\n\r\nAfter changing the migration version from `5.2` to `7.0` all `datetime` columns are created as `timestamp(6) with time zone`.\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.3.1\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin21]\r\n**PostgreSQL version**: 14.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45922/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45922/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45920","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45920/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45920/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45920/events","html_url":"https://github.com/rails/rails/issues/45920","id":1358179995,"node_id":"I_kwDNIULOUPQumw","number":45920,"title":"Replace has_one through create_association might create duplicated rows","user":{"login":"lazaronixon","id":2651240,"node_id":"MDQ6VXNlcjI2NTEyNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2651240?v=4","gravatar_id":"","url":"https://api.github.com/users/lazaronixon","html_url":"https://github.com/lazaronixon","followers_url":"https://api.github.com/users/lazaronixon/followers","following_url":"https://api.github.com/users/lazaronixon/following{/other_user}","gists_url":"https://api.github.com/users/lazaronixon/gists{/gist_id}","starred_url":"https://api.github.com/users/lazaronixon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazaronixon/subscriptions","organizations_url":"https://api.github.com/users/lazaronixon/orgs","repos_url":"https://api.github.com/users/lazaronixon/repos","events_url":"https://api.github.com/users/lazaronixon/events{/privacy}","received_events_url":"https://api.github.com/users/lazaronixon/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-09-01T03:05:07Z","updated_at":"2022-09-01T23:03:40Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# Ensure backward compatibility with minitest 4.\r\nMinitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts do |t|\r\n  end\r\n\r\n  create_table :comments do |t|\r\n    t.references :post\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_one :comment, dependent: :destroy\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  validates_presence_of :post_id\r\n  belongs_to :post\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    Thread.new { post.create_comment! }\r\n    sleep 5.seconds\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n```\r\n# transaction begin\r\nselect previous_comment for update\r\n\r\ninsert new_comment\r\n\r\ndelete previous_comment\r\n# transaction commit\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n```\r\n# transaction begin\r\ninsert new_comment\r\n# transaction commit\r\n\r\n# transaction begin\r\ndelete previous_comment\r\n# transaction commit\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45920/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45920/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45919","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45919/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45919/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45919/events","html_url":"https://github.com/rails/rails/issues/45919","id":1357912084,"node_id":"I_kwDNIULOUPAYFA","number":45919,"title":"`<<` function of `ActiveRecord::Associations::CollectionProxy` unexpected return value","user":{"login":"youssef1337","id":22629501,"node_id":"MDQ6VXNlcjIyNjI5NTAx","avatar_url":"https://avatars.githubusercontent.com/u/22629501?v=4","gravatar_id":"","url":"https://api.github.com/users/youssef1337","html_url":"https://github.com/youssef1337","followers_url":"https://api.github.com/users/youssef1337/followers","following_url":"https://api.github.com/users/youssef1337/following{/other_user}","gists_url":"https://api.github.com/users/youssef1337/gists{/gist_id}","starred_url":"https://api.github.com/users/youssef1337/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/youssef1337/subscriptions","organizations_url":"https://api.github.com/users/youssef1337/orgs","repos_url":"https://api.github.com/users/youssef1337/repos","events_url":"https://api.github.com/users/youssef1337/events{/privacy}","received_events_url":"https://api.github.com/users/youssef1337/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-31T21:52:45Z","updated_at":"2022-09-01T16:58:14Z","closed_at":"2022-09-01T16:35:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Explanation\r\nHello, so I am using the `<<` [function](https://api.rubyonrails.org/v6.1.3/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C) of `ActiveRecord::Associations::CollectionProxy` and before (in `rails 5`) it was returning `false` when it failed, when I upgraded to `rails 6` that doesn't happen anymore and I traced it to this [change](https://github.com/rails/rails/commit/5dc72378b783e924c5bf079ca660388ec4ac9224?diff=split#diff-ceff30ddab4e756e3a70ece45076eb17ff2f587a068dae657d2ad3a265a3f0d6L446) on `Jun 6, 2018` – my question is, how was I supposed to know that this change happened when upgarding? what did I miss? I have checked the upgrade guide and the release notes, didn't seem to find something related to that change. Thanks in advance.\r\n\r\n### Steps to reproduce\r\nJust check the reproduction script below for both `rails 5` and `rails 6`\r\n\r\n### Expected behavior\r\nThis is the expected behavior in rails 5, expected the return value of `<<` to be `false` when it fails.\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"5.0.7\"\r\n  gem \"sqlite3\", \"1.3.13\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n  validates :post, uniqueness: true # for the sake of testing\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.comments << Comment.create!\r\n    val = post.comments << Comment.create!\r\n\r\n    assert_equal false, val\r\n  end\r\nend\r\n```\r\nval returns `false` correctly as expected.\r\n### Actual behavior\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"6.0.3\"\r\n  gem \"sqlite3\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n  validates :post, uniqueness: true # for the sake of testing\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.comments << Comment.create!\r\n    val = post.comments << Comment.create!\r\n\r\n    assert_equal false, val\r\n  end\r\nend\r\n```\r\n`Expected: false`\r\n`Actual: nil`\r\n\r\n### System configuration\r\n**Rails version**:\r\n`5.0.7` for expected behavior\r\n`6.0.3` for the changed behavior which I wasn't expecting\r\n**Ruby version**:\r\n`2.5.5` for expected behavior\r\n`2.7.2` for the changed behavior which I wasn't expecting","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45919/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45919/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45913","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45913/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45913/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45913/events","html_url":"https://github.com/rails/rails/issues/45913","id":1356482599,"node_id":"I_kwDNIULOUNpIJw","number":45913,"title":"Active Job integration tests for `resque` and `sidekiq` fail with `redis` 5.0.1 and `redis-client` 0.7.1","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-30T23:52:34Z","updated_at":"2022-09-07T17:35:35Z","closed_at":"2022-09-07T17:35:35Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/89114#0182ef6a-4316-4671-981b-3dafdeee29a2\r\n\r\n### Steps to reproduce\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/activejob\r\nbundle update redis --conservative\r\ngit diff\r\nbundle exec rake test:integration:resque\r\nAJ_INTEGRATION_TESTS=1 AJ_ADAPTER=sidekiq bin/test test/integration/queuing_test.rb\r\n```\r\n\r\n### Expected behavior\r\nBoth of Active Job integration tests for `resque` and `sidekiq` should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ git diff\r\ndiff --git a/Gemfile.lock b/Gemfile.lock\r\nindex 28cfa23d9c..c39161f625 100644\r\n--- a/Gemfile.lock\r\n+++ b/Gemfile.lock\r\n@@ -400,7 +400,10 @@ GEM\r\n     rbtree (0.4.5)\r\n     rdoc (6.3.3)\r\n     redcarpet (3.2.3)\r\n-    redis (4.7.1)\r\n+    redis (5.0.1)\r\n+      redis-client (~> 0.7)\r\n+    redis-client (0.7.1)\r\n+      connection_pool\r\n     redis-namespace (1.8.1)\r\n       redis (>= 3.0.4)\r\n     regexp_parser (2.2.1)\r\n$\r\n```\r\n\r\n* for resque `redis-client-0.7.1/lib/redis_client/config.rb:20:in `initialize': unknown keyword: :thread_safe (ArgumentError)`\r\n\r\n```ruby\r\n$ bundle exec rake test:integration:resque\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/ruby -w -I\"lib:test\" /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb \"test/integration/queuing_test.rb\"\r\nUsing resque\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:24: warning: method redefined; discarding old require\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:27: warning: previous definition of require was here\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32454: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32615: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32651: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32740: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32756: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32822: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32863: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:32888: warning: statement not reached\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/mail-2.7.1/lib/mail/parsers/address_lists_parser.rb:31984: warning: assigned but unused variable - testEof\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:370: warning: assigned but unused variable - pathlen\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:51: warning: method redefined; discarding old initialize\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_cert\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_file\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/httpclient-2.8.3/lib/httpclient/ssl_config.rb:58: warning: method redefined; discarding old add_path\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/cookiejar-0.3.3/lib/cookiejar/cookie.rb:183: warning: mismatched indentations at 'end' with 'else' at 181\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/cookiejar-0.3.3/lib/cookiejar/jar.rb:225: warning: mismatched indentations at 'end' with 'else' at 223\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client/config.rb:20:in `initialize': unknown keyword: :thread_safe (ArgumentError)\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client/config.rb:155:in `initialize'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client.rb:122:in `new'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-client-0.7.1/lib/redis_client.rb:122:in `config'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis/client.rb:22:in `config'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis.rb:157:in `initialize_client'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/redis-5.0.1/lib/redis.rb:73:in `initialize'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/adapters/resque.rb:6:in `new'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/adapters/resque.rb:6:in `setup'\r\n\tfrom /tmp/d20220831-278031-adlbts/dummy/config/initializers/activejob.rb:2:in `<main>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:60:in `load'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/bootsnap-1.9.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:60:in `load'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:673:in `block in load_config_initializer'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:208:in `instrument'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:672:in `load_config_initializer'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:626:in `block (2 levels) in <class:Engine>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:625:in `each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/engine.rb:625:in `block in <class:Engine>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:32:in `instance_exec'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:32:in `run'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:228:in `block in tsort_each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:422:in `block (2 levels) in each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:421:in `block in each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:50:in `each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:50:in `tsort_each_child'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:415:in `call'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:415:in `each_strongly_connected_component_from'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `call'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:347:in `each_strongly_connected_component'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:226:in `tsort_each'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/3.1.0/tsort.rb:205:in `tsort_each'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/initializable.rb:60:in `run_initializers'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/railties/lib/rails/application.rb:372:in `initialize!'\r\n\tfrom /tmp/d20220831-278031-adlbts/dummy/config/environment.rb:5:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/helper.rb:16:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/support/integration/helper.rb:16:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/helper.rb:12:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/helper.rb:12:in `<top (required)>'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:3:in `require'\r\n\tfrom /home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:3:in `<top (required)>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:21:in `require'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:21:in `block in <main>'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:6:in `select'\r\n\tfrom /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb:6:in `<main>'\r\nrake aborted!\r\nCommand failed with status (1): [ruby -w -I\"lib:test\" /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_test_loader.rb \"test/integration/queuing_test.rb\" ]\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/bundle:25:in `load'\r\n/home/yahonda/.rbenv/versions/3.1.2/bin/bundle:25:in `<main>'\r\nTasks: TOP => test:integration:resque\r\n(See full trace by running task with --trace)\r\n$\r\n```\r\n\r\n* for sidekiq\r\n\r\n```ruby\r\n$ AJ_INTEGRATION_TESTS=1 AJ_ADAPTER=sidekiq bin/test test/integration/queuing_test.rb\r\nUsing sidekiq\r\nRun options: --seed 44047\r\n\r\n# Running:\r\n\r\n.F\r\n\r\nFailure:\r\nQueuingTest#test_should_run_jobs_enqueued_on_a_listening_queue [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:13]:\r\nJob AJ-129bbbb5-e8ba-480b-b4b6-5f386868c6e4 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:10\r\n\r\nF\r\n\r\nFailure:\r\nQueuingTest#test_current_timezone_is_kept_while_running_perform_later [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:118]:\r\nJob AJ-a1d7d95b-4a1e-45b9-ab5f-7d50a809fe41 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:109\r\n\r\n.SF\r\n\r\nFailure:\r\nQueuingTest#test_current_locale_is_kept_while_running_perform_later [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:101]:\r\nJob AJ-eaf07152-0f27-4d5d-8b81-4023971c352e was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:92\r\n\r\nSSS.F\r\n\r\nFailure:\r\nQueuingTest#test_should_run_job_enqueued_in_the_future_at_the_specified_time [/home/yahonda/src/github.com/rails/rails/activejob/test/integration/queuing_test.rb:75]:\r\nJob AJ-3152b499-0fbe-4e13-ae37-ccc708eb7784 was not executed\r\n\r\n\r\nbin/test test/integration/queuing_test.rb:70\r\n\r\n...\r\n\r\nFinished in 34.074661s, 0.4109 runs/s, 0.3522 assertions/s.\r\n14 runs, 12 assertions, 4 failures, 0 errors, 4 skips\r\n\r\nYou have skipped tests. Run with --verbose for details.\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45913/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45913/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45906","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45906/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45906/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45906/events","html_url":"https://github.com/rails/rails/issues/45906","id":1355732552,"node_id":"I_kwDNIULOUM7WSA","number":45906,"title":"High object allocation count from `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs `","user":{"login":"amarchenkoshopify","id":101111422,"node_id":"U_kgDOBgbWfg","avatar_url":"https://avatars.githubusercontent.com/u/101111422?v=4","gravatar_id":"","url":"https://api.github.com/users/amarchenkoshopify","html_url":"https://github.com/amarchenkoshopify","followers_url":"https://api.github.com/users/amarchenkoshopify/followers","following_url":"https://api.github.com/users/amarchenkoshopify/following{/other_user}","gists_url":"https://api.github.com/users/amarchenkoshopify/gists{/gist_id}","starred_url":"https://api.github.com/users/amarchenkoshopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarchenkoshopify/subscriptions","organizations_url":"https://api.github.com/users/amarchenkoshopify/orgs","repos_url":"https://api.github.com/users/amarchenkoshopify/repos","events_url":"https://api.github.com/users/amarchenkoshopify/events{/privacy}","received_events_url":"https://api.github.com/users/amarchenkoshopify/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/81","html_url":"https://github.com/rails/rails/milestone/81","labels_url":"https://api.github.com/repos/rails/rails/milestones/81/labels","id":7591006,"node_id":"MI_kwDNIULOAHPUXg","number":81,"title":"7.0.4","description":"","creator":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","site_admin":false},"open_issues":2,"closed_issues":3,"state":"open","created_at":"2022-01-20T01:51:07Z","updated_at":"2022-08-30T13:21:37Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2022-08-30T12:58:42Z","updated_at":"2022-08-31T12:37:42Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhile working on memory efficiency investigation I noticed that a very big bunch of object allocations comes from a single method `ActiveRecord::ConnectionAdapters::PoolManager#pool_configs`:\r\n\r\n```ruby\r\n      def pool_configs(role = nil)\r\n        if role\r\n          @role_to_shard_mapping[role].values\r\n        else\r\n          @role_to_shard_mapping.flat_map { |_, shard_map| shard_map.values }\r\n        end\r\n      end \r\n```\r\n\r\nThis method is called on every activerecord operation and does not cache its result: could we think about a way of caching its result?\r\n\r\ncc @eileencodes \r\n\r\n### Expected behavior\r\n\r\n`#pool_configs` allocates configs once\r\n\r\n### Actual behavior\r\n\r\n`#pool_configs` allocates configs every time it is executed\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45906/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45906/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45901","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45901/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45901/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45901/events","html_url":"https://github.com/rails/rails/issues/45901","id":1354555667,"node_id":"I_kwDNIULOULzhEw","number":45901,"title":"bin/rails dbconsole should include_password by default","user":{"login":"wpeterson","id":178135,"node_id":"MDQ6VXNlcjE3ODEzNQ==","avatar_url":"https://avatars.githubusercontent.com/u/178135?v=4","gravatar_id":"","url":"https://api.github.com/users/wpeterson","html_url":"https://github.com/wpeterson","followers_url":"https://api.github.com/users/wpeterson/followers","following_url":"https://api.github.com/users/wpeterson/following{/other_user}","gists_url":"https://api.github.com/users/wpeterson/gists{/gist_id}","starred_url":"https://api.github.com/users/wpeterson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wpeterson/subscriptions","organizations_url":"https://api.github.com/users/wpeterson/orgs","repos_url":"https://api.github.com/users/wpeterson/repos","events_url":"https://api.github.com/users/wpeterson/events{/privacy}","received_events_url":"https://api.github.com/users/wpeterson/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-29T16:19:45Z","updated_at":"2022-08-30T00:17:43Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n1. Configure a Rails `config/database.yml` with a `password` required to connect\r\n2. Run `rails dbconsole`\r\n3. See prompt for database password, despite password being configured/available\r\n4. Run `rails dbconsole -p`\r\n5. See dbconsole properly load and use credentials to connect to database for DB console session\r\n\r\n### Expected behavior\r\nWhenever a Rails app has credentials like a password configured for a database, the database console session should use those credentials vs. prompting the user to re-enter a password interactively.  When credentials are not configured and a password is required, we should prompt then.\r\n\r\nThis behavior is implemented since early Rails versions but is disabled by default.  I propose we enable the proper password behavior by default.\r\n\r\n### Actual behavior\r\n`bin/rails dbconsole` always prompts for a password, even when one is configured for the app.\r\n\r\n### System configuration\r\n**Rails version**: All (6.x, 7.x, head)\r\n\r\n**Ruby version**: All \r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45901/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45901/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45899","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45899/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45899/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45899/events","html_url":"https://github.com/rails/rails/issues/45899","id":1353676820,"node_id":"I_kwDNIULOUK94FA","number":45899,"title":"Active Job unit tests fail using que 2.2.0","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-29T04:24:06Z","updated_at":"2022-09-09T15:33:02Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\nActive Job CI has been failing since que 2.2.0 is installed. https://buildkite.com/rails/rails/builds/89068#0182e6b9-7c84-4b85-a651-8d640f5eb076\r\n\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/activejob\r\nbundle update que\r\nAJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\n```\r\n\r\nAlthough there are 3 failures and 75 errors. This script just runs a single test because it looks the root cause is the same.\r\n\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\nIt raises `ArgumentError: wrong number of arguments (given 2, expected 1)`.\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 62302\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nQueuingTest#test_run_queued_job:\r\nArgumentError: wrong number of arguments (given 2, expected 1)\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:78:in `run'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job_methods.rb:51:in `_run'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:248:in `block (2 levels) in _run_attrs'\r\n    (eval):9:in `run_job_middleware'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:247:in `block in _run_attrs'\r\n    <internal:kernel>:90:in `tap'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:246:in `_run_attrs'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/job.rb:223:in `run'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/support/que/inline.rb:15:in `enqueue'\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:66:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:27:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:67:in `block in enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:28:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:27:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:9:in `block (2 levels) in <module:Instrumentation>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:27:in `tag_logger'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:14:in `block (2 levels) in <module:Logging>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:63:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:30:in `perform_later'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/cases/queuing_test.rb:14:in `block in <class:QueuingTest>'\r\n\r\n\r\nbin/test test/cases/queuing_test.rb:13\r\n\r\n\r\n\r\nFinished in 0.008930s, 111.9768 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n\r\n### Additional information\r\n* `require_job_options_kwarg?` always returns `false` because `JobWrapper.method(:enqueue).parameters` does not have any `[:key, :job_options]` \r\nwhere it looks expected to return `true`.\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 32774\r\n\r\n# Running:\r\n\r\n[46, 55] in ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n    46|       end\r\n    47|\r\n    48|       private\r\n    49|         def require_job_options_kwarg?\r\n    50|           require 'debug'\r\n=>  51|           binding.break\r\n    52|           @require_job_options_kwarg ||=\r\n    53|             JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }\r\n    54|         end\r\n    55|\r\n=>#0\tActiveJob::QueueAdapters::QueAdapter#require_job_options_kwarg? at ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:51\r\n  #1\tActiveJob::QueueAdapters::QueAdapter#enqueue(job=#<HelloJob:0x00007fc861807740 @arguments...) at ~/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:24\r\n  # and 40 frames (use `bt' command for all frames)\r\n(rdbg) JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }    # ruby\r\nfalse\r\n(rdbg) JobWrapper.method(:enqueue).parameters    # ruby\r\n[[:req, :args], [:keyreq, :priority], [:keyreq, :queue], [:key, :run_at]]\r\n(rdbg) quit    # command\r\nReally quit? [Y/n] Y\r\n```\r\n\r\n* By changing `require_job_options_kwarg?` always returns `true`, it raises `ArgumentError: missing keywords: :priority, :queue`\r\n\r\n```ruby\r\n$ git diff\r\ndiff --git a/activejob/lib/active_job/queue_adapters/que_adapter.rb b/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\nindex 41b3633a07..54e8cbc39b 100644\r\n--- a/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n+++ b/activejob/lib/active_job/queue_adapters/que_adapter.rb\r\n@@ -47,6 +47,7 @@ def enqueue_at(job, timestamp) # :nodoc:\r\n\r\n       private\r\n         def require_job_options_kwarg?\r\n+          return true\r\n           @require_job_options_kwarg ||=\r\n             JobWrapper.method(:enqueue).parameters.any? { |ptype, pname| ptype == :key && pname == :job_options }\r\n         end\r\n$\r\n```\r\n\r\n```ruby\r\n$ AJ_ADAPTER=que bin/test test/cases/queuing_test.rb:13\r\nUsing que\r\nRun options: --seed 21508\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nQueuingTest#test_run_queued_job:\r\nArgumentError: missing keywords: :priority, :queue\r\n    /home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/que-2.2.0/lib/que/active_job/extensions.rb:65:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/queue_adapters/que_adapter.rb:25:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:67:in `block in enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:28:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:27:in `instrument'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/instrumentation.rb:9:in `block (2 levels) in <module:Instrumentation>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:27:in `tag_logger'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/logging.rb:14:in `block (2 levels) in <module:Logging>'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `instance_exec'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:63:in `enqueue'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/lib/active_job/enqueuing.rb:30:in `perform_later'\r\n    /home/yahonda/src/github.com/rails/rails/activejob/test/cases/queuing_test.rb:14:in `block in <class:QueuingTest>'\r\n\r\n\r\nbin/test test/cases/queuing_test.rb:13\r\n\r\n\r\n\r\nFinished in 0.008724s, 114.6312 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: $ ruby -v\r\nruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45899/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45893","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45893/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45893/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45893/events","html_url":"https://github.com/rails/rails/issues/45893","id":1352793907,"node_id":"I_kwDNIULOUKH_Mw","number":45893,"title":"ActiveRecord: HMT with conditions does not update the in-memory collection when pushing new objects","user":{"login":"joanniclaborde","id":411925,"node_id":"MDQ6VXNlcjQxMTkyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/411925?v=4","gravatar_id":"","url":"https://api.github.com/users/joanniclaborde","html_url":"https://github.com/joanniclaborde","followers_url":"https://api.github.com/users/joanniclaborde/followers","following_url":"https://api.github.com/users/joanniclaborde/following{/other_user}","gists_url":"https://api.github.com/users/joanniclaborde/gists{/gist_id}","starred_url":"https://api.github.com/users/joanniclaborde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joanniclaborde/subscriptions","organizations_url":"https://api.github.com/users/joanniclaborde/orgs","repos_url":"https://api.github.com/users/joanniclaborde/repos","events_url":"https://api.github.com/users/joanniclaborde/events{/privacy}","received_events_url":"https://api.github.com/users/joanniclaborde/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-26T22:40:12Z","updated_at":"2022-08-30T15:33:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi! When using a `has_many :a, through: :b` relation, and the `:b` relation has a condition, adding new objects doesn't update the in-memory collection properly (stops after the first object).\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :packages, force: true do |t|\r\n  end\r\n\r\n  create_table :package_items, force: true do |t|\r\n    t.integer :package_id\r\n    t.integer :item_id\r\n  end\r\n\r\n  create_table :items, force: true do |t|\r\n    t.boolean \"deleted\", default: false\r\n  end\r\nend\r\n\r\nclass Package < ActiveRecord::Base\r\n  has_many :package_items, ->{ where(item_id: Item.active.pluck(:id)) }\r\n  has_many :items, through: :package_items\r\nend\r\n\r\nclass PackageItem < ActiveRecord::Base\r\n  belongs_to :package\r\n  belongs_to :item\r\nend\r\n\r\nclass Item < ActiveRecord::Base\r\n  has_many :package_items\r\n  has_many :packages, through: :package_items\r\n\r\n  scope :active, -> { where(deleted: false) }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    package = Package.create!\r\n    package.items << Item.create!\r\n    package.items << Item.create!\r\n    package.items << Item.create!\r\n\r\n    # This should be [3, 3, 3] but we get [3, 1, 3]\r\n    assert_equal [3, 3, 3], [Item.count, package.items.count, package.reload.items.count]\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n`package.items.count` is equal to 3.\r\n\r\n### Actual behavior\r\n`package.items.count` is equal to 1, even though all the items and relations are created properly (see assertion).\r\n\r\n### System configuration\r\n**Rails version**: tested on `7.1.0.alpha` and `6.1.6.1`.\r\n\r\n**Ruby version**: tested on `2.7.5`.\r\n\r\n### Workaround\r\nI was able to fix this issue by changing the weird condition to a proper scope:\r\n\r\n```ruby\r\nclass Package < ActiveRecord::Base\r\n  has_many :package_items, ->{ includes(:item).merge(Item.active) }\r\n  has_many :items, through: :package_items\r\nend\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45893/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45893/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45890","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45890/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45890/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45890/events","html_url":"https://github.com/rails/rails/issues/45890","id":1351993167,"node_id":"I_kwDNIULOUJXHTw","number":45890,"title":"ActiveStorage: Partial downloads with incorrect range throw a RoutingError and 404 not found","user":{"login":"alietz","id":8299086,"node_id":"MDQ6VXNlcjgyOTkwODY=","avatar_url":"https://avatars.githubusercontent.com/u/8299086?v=4","gravatar_id":"","url":"https://api.github.com/users/alietz","html_url":"https://github.com/alietz","followers_url":"https://api.github.com/users/alietz/followers","following_url":"https://api.github.com/users/alietz/following{/other_user}","gists_url":"https://api.github.com/users/alietz/gists{/gist_id}","starred_url":"https://api.github.com/users/alietz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alietz/subscriptions","organizations_url":"https://api.github.com/users/alietz/orgs","repos_url":"https://api.github.com/users/alietz/repos","events_url":"https://api.github.com/users/alietz/events{/privacy}","received_events_url":"https://api.github.com/users/alietz/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-26T09:16:10Z","updated_at":"2022-09-02T06:29:54Z","closed_at":"2022-09-02T06:29:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem 'rails', '~> 7.0.0'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record/railtie'\r\nrequire 'active_storage/engine'\r\nrequire 'tmpdir'\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: 'cookie_store_key'\r\n  secrets.secret_key_base = 'secret_key_base'\r\n  config.hosts << 'www.example.com'\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: 'Disk'\r\n    }\r\n  }\r\nend\r\n\r\nENV['DATABASE_URL'] = 'sqlite3::memory:'\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join('db/migrate/20170806125915_create_active_storage_tables.rb').to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one_attached :pdf\r\nend\r\n\r\nrequire 'minitest/autorun'\r\n\r\n# Download a file with incorrect partial byte range\r\nclass PartialDownloadTest < ActionDispatch::IntegrationTest\r\n  test 'Partial download' do\r\n    user = User.create!(\r\n      pdf: {\r\n        content_type: 'application/pdf',\r\n        filename: 'dummy.pdf',\r\n        io: ::StringIO.new(SecureRandom.random_bytes(1000))\r\n      }\r\n    )\r\n    # Get URL for download\r\n    get \"/#{Rails.application.routes.url_helpers.rails_blob_path(user.pdf, only_path: true)}\"\r\n    assert_response :redirect\r\n    # Download with non-existing range\r\n    get(response.location, headers: { 'Range' => 'bytes=10000-10000' })\r\n    # Should respond with status 416 Range not satisfiable, but throws a RoutingError and responds with 404 not found\r\n    assert_response 416\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nWhen a browser asks for a part of a file that doesn't exist (Safari is prone to doing this), the response should be 416 'Range not satisfiable'.\r\n\r\n### Actual behavior\r\nThe response is 404 'Not found' and an ActionController::RoutingError occurs.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.0.2p107\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45890/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45890/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45889","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45889/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45889/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45889/events","html_url":"https://github.com/rails/rails/issues/45889","id":1351479107,"node_id":"I_kwDNIULOUI3vQw","number":45889,"title":"ActiveStorage NoMethodError: undefined method `upload' for nil:NilClass","user":{"login":"mridul911","id":60569576,"node_id":"MDQ6VXNlcjYwNTY5NTc2","avatar_url":"https://avatars.githubusercontent.com/u/60569576?v=4","gravatar_id":"","url":"https://api.github.com/users/mridul911","html_url":"https://github.com/mridul911","followers_url":"https://api.github.com/users/mridul911/followers","following_url":"https://api.github.com/users/mridul911/following{/other_user}","gists_url":"https://api.github.com/users/mridul911/gists{/gist_id}","starred_url":"https://api.github.com/users/mridul911/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mridul911/subscriptions","organizations_url":"https://api.github.com/users/mridul911/orgs","repos_url":"https://api.github.com/users/mridul911/repos","events_url":"https://api.github.com/users/mridul911/events{/privacy}","received_events_url":"https://api.github.com/users/mridul911/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-25T21:43:23Z","updated_at":"2022-09-06T12:27:39Z","closed_at":"2022-09-06T12:27:39Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nSimply follow the instruction to download the activestorage.\r\n\r\n- I've ran the migration: rails active_storage:install\r\n\r\n- I've edited my development environtment file: config.active_storage.service = :local\r\n\r\n- setup xyz model by adding: has_one_attached :image\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Here we have request parameters\r\nStarted PATCH \"url/99\" for ::1 at 2022-08-26 03:03:43 +0530\r\nProcessing by XYZController#update as HTML\r\n  Parameters: {......., \"image\"=>#<ActionDispatch::Http::UploadedFile:0x0000000118d3b238 @tempfile=#<Tempfile:/var/folders/vt/yz_3y9j54d12prrw0k28n0nr0000gn/T/RackMultipart20220826-6048-1dxkoj9.png>, @original_filename=\"Screenshot 2022-08-16 at 11.07.24 PM.png\", @content_type=\"image/png\", @headers=\"Content-Disposition: form-data; name=\\\"xyz[image]\\\"; filename=\\\"Screenshot 2022-08-16 at 11.07.24 PM.png\\\"\\r\\nContent-Type: image/png\\r\\n\">, ......}\r\n```\r\n**Controller**\r\n```\r\ndef update\r\n    @xyz.update(xyz_params)\r\nend\r\n```\r\n\r\n**Form**\r\n using .slim \r\n```\r\n= form_for @xyz, :html => {:class => \"ui form deal-form\", 'data-parsley-validate' => true, multipart: true, :action => \"upload\"} do |f|\r\n  = f.file_field :image, id: \"cover-photo\", class: \"xyz-field\", :value =>  \"some value\"\"\r\n```\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nShould attach this object as expected.\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nWhen I submit this form, the aforementioned error is thrown. The same error occurs when trying to update an @event object.\r\n### System configuration\r\n**Rails version**:\r\n5.2.8.1\r\n**Ruby version**:\r\n2.7.0","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45889/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45889/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45888","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45888/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45888/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45888/events","html_url":"https://github.com/rails/rails/issues/45888","id":1351409368,"node_id":"I_kwDNIULOUIze2A","number":45888,"title":"propshaft broken by change in rails/main","user":{"login":"strobilomyces","id":68540841,"node_id":"MDQ6VXNlcjY4NTQwODQx","avatar_url":"https://avatars.githubusercontent.com/u/68540841?v=4","gravatar_id":"","url":"https://api.github.com/users/strobilomyces","html_url":"https://github.com/strobilomyces","followers_url":"https://api.github.com/users/strobilomyces/followers","following_url":"https://api.github.com/users/strobilomyces/following{/other_user}","gists_url":"https://api.github.com/users/strobilomyces/gists{/gist_id}","starred_url":"https://api.github.com/users/strobilomyces/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/strobilomyces/subscriptions","organizations_url":"https://api.github.com/users/strobilomyces/orgs","repos_url":"https://api.github.com/users/strobilomyces/repos","events_url":"https://api.github.com/users/strobilomyces/events{/privacy}","received_events_url":"https://api.github.com/users/strobilomyces/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-25T20:24:29Z","updated_at":"2022-08-31T08:12:21Z","closed_at":"2022-08-28T23:09:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n- Create app using Rails main (on or after 73d96c494759888eda7021c94774463c9b0f5556) and propshaft -- `rails new fuck -a propshaft --main`\r\n\r\n### Expected behavior\r\nA new Rails app with propshaft should be created without errors.\r\n\r\n### Actual behavior\r\n```\r\nUse `bundle info [gemname]` to see where a bundled gem is installed.\r\n         run  bundle binstubs bundler\r\n       rails  importmap:install\r\nrails aborted!\r\nNoMethodError: undefined method `assets=' for #<Fuck::Application>\r\n\r\n      app.assets = Propshaft::Assembly.new(app.config.assets)\r\n         ^^^^^^^^^\r\n/home/user/fuck/config/environment.rb:5:in `<main>'\r\nTasks: TOP => app:template => environment\r\n(See full trace by running task with --trace)\r\n\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.1.2p20\r\n\r\nRolling back to the previous commit, 2045cef03babe22ddbc9edab7df5e9829bb8748b, everything works as normal.\r\n\r\nNot sure whether this is ultimately a Propshaft issue, but given that it was broken here, here we are.\r\n\r\nThanks :)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45888/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45888/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45880","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45880/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45880/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45880/events","html_url":"https://github.com/rails/rails/issues/45880","id":1349546108,"node_id":"I_kwDNIULOUHBwfA","number":45880,"title":"Google search links to old API docs","user":{"login":"abraham","id":3341,"node_id":"MDQ6VXNlcjMzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/3341?v=4","gravatar_id":"","url":"https://api.github.com/users/abraham","html_url":"https://github.com/abraham","followers_url":"https://api.github.com/users/abraham/followers","following_url":"https://api.github.com/users/abraham/following{/other_user}","gists_url":"https://api.github.com/users/abraham/gists{/gist_id}","starred_url":"https://api.github.com/users/abraham/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abraham/subscriptions","organizations_url":"https://api.github.com/users/abraham/orgs","repos_url":"https://api.github.com/users/abraham/repos","events_url":"https://api.github.com/users/abraham/events{/privacy}","received_events_url":"https://api.github.com/users/abraham/received_events","type":"User","site_admin":true},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-24T14:33:55Z","updated_at":"2022-08-25T23:48:01Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Search Google for a Rails API https://www.google.com/search?q=rails+update_all\r\n2. Follow link for \"ActiveRecord::Relation - Rails API\"\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nFind documentation for the latest version of Rails. Currently `7.0.3.1`.\r\n\r\n`https://api.rubyonrails.org/classes/ActiveRecord/Relation.html`\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nFind documentation for the the very old version of `3.2.3`.\r\n\r\n`https://api.rubyonrails.org/v3.2.3/classes/ActiveRecord/Relation.html`\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45880/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45880/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45879","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45879/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45879/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45879/events","html_url":"https://github.com/rails/rails/issues/45879","id":1349392218,"node_id":"I_kwDNIULOUG4XWg","number":45879,"title":"No implicit conversion of String into Integer (TypeError) - when commiting record to the database","user":{"login":"bcoelh0","id":2817303,"node_id":"MDQ6VXNlcjI4MTczMDM=","avatar_url":"https://avatars.githubusercontent.com/u/2817303?v=4","gravatar_id":"","url":"https://api.github.com/users/bcoelh0","html_url":"https://github.com/bcoelh0","followers_url":"https://api.github.com/users/bcoelh0/followers","following_url":"https://api.github.com/users/bcoelh0/following{/other_user}","gists_url":"https://api.github.com/users/bcoelh0/gists{/gist_id}","starred_url":"https://api.github.com/users/bcoelh0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bcoelh0/subscriptions","organizations_url":"https://api.github.com/users/bcoelh0/orgs","repos_url":"https://api.github.com/users/bcoelh0/repos","events_url":"https://api.github.com/users/bcoelh0/events{/privacy}","received_events_url":"https://api.github.com/users/bcoelh0/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-08-24T12:46:51Z","updated_at":"2022-08-25T07:52:52Z","closed_at":"2022-08-25T07:52:52Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```\r\nrails new testApp\r\ncd testApp\r\nrails g model Test hash:string\r\nrake db:migrate\r\nrails console\r\n> t = Test.create!(hash: \"sdas\")\r\n(1.2ms)  SELECT sqlite_version(*)\r\n TRANSACTION (0.1ms)  begin transaction\r\n  Test Create (2.9ms)  INSERT INTO \"tests\" (\"hash\", \"created_at\", \"updated_at\") VALUES (?, ?, ?)  [[\"hash\", \"sdas\"], [\"created_at\", \"2022-08-24 12:37:30.474479\"], [\"updated_at\", \"2022-08-24 12:37:30.474479\"]]\r\n  TRANSACTION (1.1ms)  commit transaction\r\n\r\n/Users/<user>/.rvm/gems/ruby-3.1.2/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/transaction.rb:156:in `commit_records': no implicit conversion of String into Integer (TypeError)\r\n```\r\n\r\n### Expected behavior\r\nExpected object to be created in the database with no errors AND object to be returned\r\n\r\n### Actual behavior\r\nThe record is actually saved to the database, but this error is returned \r\nThe variable `t` is set to `nil` instead of the object just saved.\r\nThis only happens if the record has one of the fields named `hash`. Any class without this field saves to the database without any issues.\r\n\r\n### Fix\r\nI was able to fix this locally simply by changing the affected lines to use the method `to_s` on `record`\r\n\r\n```\r\nshould_run_callbacks = !already_run_callbacks[record.to_s] && trigger_callbacks\r\nalready_run_callbacks[record.to_s] ||= trigger_callbacks\r\n```\r\nThis works for me as a quick fix, but not sure if this is the best fix.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3.1\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45879/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45879/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45868","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45868/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45868/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45868/events","html_url":"https://github.com/rails/rails/issues/45868","id":1346133220,"node_id":"I_kwDNIULOUDxc5A","number":45868,"title":"ActiveRecord store deserialization fails with nested objects","user":{"login":"tkalliom","id":4124528,"node_id":"MDQ6VXNlcjQxMjQ1Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/4124528?v=4","gravatar_id":"","url":"https://api.github.com/users/tkalliom","html_url":"https://github.com/tkalliom","followers_url":"https://api.github.com/users/tkalliom/followers","following_url":"https://api.github.com/users/tkalliom/following{/other_user}","gists_url":"https://api.github.com/users/tkalliom/gists{/gist_id}","starred_url":"https://api.github.com/users/tkalliom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tkalliom/subscriptions","organizations_url":"https://api.github.com/users/tkalliom/orgs","repos_url":"https://api.github.com/users/tkalliom/repos","events_url":"https://api.github.com/users/tkalliom/events{/privacy}","received_events_url":"https://api.github.com/users/tkalliom/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-22T09:55:29Z","updated_at":"2022-08-24T19:32:14Z","closed_at":"2022-08-24T19:32:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.text \"properties\"\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  store :properties\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_store_yaml_serialization\r\n    post = Post.create! properties: { scalar_value: 2, nested_properties: { a: 3, b: 4 } }\r\n    assert_equal 2, post.properties[:scalar_value]\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nThe serialization/deserialization round trip should work.\r\n\r\n### Actual behavior\r\nA `Psych::DisallowedClass` error is raised:\r\n```\r\nBugTest#test_store_yaml_serialization:\r\nPsych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess\r\n    /usr/lib/ruby/2.7.0/psych/class_loader.rb:97:in `find'\r\n    /usr/lib/ruby/2.7.0/psych/class_loader.rb:28:in `load'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:411:in `resolve_class'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:283:in `visit_Psych_Nodes_Mapping'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:340:in `block in revive_hash'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:338:in `each'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:338:in `each_slice'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:338:in `revive_hash'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:162:in `visit_Psych_Nodes_Mapping'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'\r\n    /usr/lib/ruby/2.7.0/psych.rb:360:in `safe_load'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activerecord/lib/active_record/coders/yaml_column.rb:61:in `yaml_load'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activerecord/lib/active_record/coders/yaml_column.rb:26:in `load'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activerecord/lib/active_record/store.rb:275:in `load'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activerecord/lib/active_record/type/serialized.rb:22:in `deserialize'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activemodel/lib/active_model/attribute.rb:168:in `type_cast'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activemodel/lib/active_model/attribute.rb:43:in `value'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activemodel/lib/active_model/attribute_set.rb:51:in `fetch_value'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activerecord/lib/active_record/attribute_methods/read.rb:38:in `_read_attribute'\r\n    .../.bundle/ruby/2.7.0/rails-241893900740/activemodel/lib/active_model/attribute_methods.rb:277:in `properties'\r\n    serialize-case.rb:35:in `test_store_yaml_serialization'\r\n```\r\n\r\nThe issue #45585 was marked as fixed with PR #45591, but that fix is incomplete. It does not take into account nested objects: e.g. in my example above, the top-level `properties` is converted from `HashWithIndifferentAccess` to a regular hash, but even after that conversion, `properties[:nested_properties]` remains a `HashWithIndifferentAccess`. `Activerecord::Store::IndifferentCoder#as_regular_hash` should work in a recursive fashion.\r\n\r\n### System configuration\r\n**Rails version**: 2418939 (7.1.0.alpha)\r\n\r\n**Ruby version**: 2.7.4p191\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45868/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45868/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45866","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45866/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45866/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45866/events","html_url":"https://github.com/rails/rails/issues/45866","id":1345342715,"node_id":"I_kwDNIULOUDBM-w","number":45866,"title":"JSON rendered as empty array of strings when bundling edge Rails","user":{"login":"izaguirrejoe","id":14005731,"node_id":"MDQ6VXNlcjE0MDA1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/14005731?v=4","gravatar_id":"","url":"https://api.github.com/users/izaguirrejoe","html_url":"https://github.com/izaguirrejoe","followers_url":"https://api.github.com/users/izaguirrejoe/followers","following_url":"https://api.github.com/users/izaguirrejoe/following{/other_user}","gists_url":"https://api.github.com/users/izaguirrejoe/gists{/gist_id}","starred_url":"https://api.github.com/users/izaguirrejoe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/izaguirrejoe/subscriptions","organizations_url":"https://api.github.com/users/izaguirrejoe/orgs","repos_url":"https://api.github.com/users/izaguirrejoe/repos","events_url":"https://api.github.com/users/izaguirrejoe/events{/privacy}","received_events_url":"https://api.github.com/users/izaguirrejoe/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-21T00:48:56Z","updated_at":"2022-09-04T16:50:17Z","closed_at":"2022-09-04T16:50:17Z","author_association":"NONE","active_lock_reason":null,"body":"An error occurs when running `bundle update rails`. I'm bundling edge rails, going from commit d0bc58a8365034c06333e1aff5383892e3a7d803 to 893e5e25e5d83416c8f270dd1b1e32d9e5da76f5. Upon upgrading, attempting to render an array of ActiveRecord objects as JSON returns [\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"]. A new bug was introduced between those two commits in Rails. Reverting to older version of Rails fixes the bug. \r\n\r\nThe full bundle logs:\r\n\r\n❯ bundle update rails\r\nFetching https://github.com/rails/rails.git\r\nFetching gem metadata from https://rubygems.org/..........\r\nResolving dependencies...\r\nUsing rake 13.0.6\r\nUsing connection_pool 2.2.5\r\nUsing minitest 5.16.3 (was 5.15.0)\r\nUsing builder 3.2.4\r\nUsing erubi 1.11.0 (was 1.10.0)\r\nUsing racc 1.6.0\r\nUsing crass 1.0.6\r\nUsing digest 3.1.0\r\nUsing timeout 0.3.0\r\nUsing strscan 3.0.4 (was 3.0.1)\r\nUsing public_suffix 4.0.7\r\nUsing aws-eventstream 1.2.0\r\nUsing aws-partitions 1.593.0\r\nUsing jmespath 1.6.1\r\nUsing bcrypt 3.1.18\r\nUsing nio4r 2.5.8\r\nUsing marcel 1.0.2\r\nUsing bindex 0.8.1\r\nUsing msgpack 1.5.1\r\nUsing bundler 2.3.7\r\nUsing matrix 0.4.2\r\nUsing regexp_parser 2.4.0\r\nUsing childprocess 4.1.0\r\nUsing dead_end 3.1.2\r\nUsing io-console 0.5.11\r\nUsing ffi 1.15.5\r\nUsing mini_mime 1.1.2\r\nUsing memory_profiler 1.0.0\r\nUsing mini_histogram 0.3.1\r\nUsing ruby-statistics 3.0.0\r\nUsing rack 2.2.4 (was 2.2.3)\r\nUsing websocket-extensions 0.1.5\r\nUsing docile 1.4.0\r\nUsing honeybadger 4.12.1\r\nUsing http-accept 1.7.0\r\nUsing method_source 1.0.0\r\nUsing thor 1.2.1\r\nUsing mime-types-data 3.2022.0105\r\nUsing geocoder 1.8.0\r\nUsing newrelic_rpm 8.7.0\r\nUsing mini_magick 4.11.0\r\nUsing benchmark-ips 2.10.0\r\nUsing redis 4.6.0\r\nUsing rubyzip 2.3.2\r\nUsing simplecov-html 0.12.3\r\nUsing simplecov_json_formatter 0.1.4\r\nUsing stackprof 0.2.19\r\nUsing nokogiri 1.13.8 (arm64-darwin) (was 1.13.6)\r\nUsing mail 2.7.1\r\nUsing unf_ext 0.0.8.2\r\nUsing addressable 2.8.0\r\nUsing local_time 2.1.0\r\nUsing rexml 3.2.5\r\nUsing reline 0.3.1\r\nUsing get_process_mem 0.2.7\r\nUsing ruby-vips 2.1.4\r\nUsing aws-sigv4 1.5.0\r\nUsing bootsnap 1.11.1\r\nUsing rack-mini-profiler 3.0.0\r\nUsing websocket-driver 0.7.5\r\nUsing heapy 0.2.0\r\nUsing mime-types 3.4.1\r\nUsing loofah 2.18.0\r\nUsing zeitwerk 2.6.0 (was 2.5.4)\r\nUsing simplecov 0.21.2\r\nUsing irb 1.4.1\r\nUsing unf 0.1.4\r\nUsing image_processing 1.12.2\r\nUsing selenium-webdriver 4.1.0\r\nUsing pg 1.3.5\r\nUsing concurrent-ruby 1.1.10\r\nUsing net-protocol 0.1.3\r\nUsing rack-test 2.0.2 (was 1.1.0)\r\nUsing netrc 0.11.0\r\nUsing puma 5.6.4\r\nUsing xpath 3.2.0\r\nUsing aws-sdk-core 3.131.1\r\nUsing i18n 1.12.0 (was 1.10.0)\r\nUsing tzinfo 2.0.5 (was 2.0.4)\r\nUsing rails-html-sanitizer 1.4.3 (was 1.4.2)\r\nUsing net-pop 0.1.1\r\nUsing net-smtp 0.3.1\r\nUsing derailed_benchmarks 2.1.1\r\nUsing domain_name 0.5.20190701\r\nUsing webdrivers 5.0.0\r\nUsing net-imap 0.2.3\r\nUsing activesupport 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing debug 1.5.0\r\nUsing sprockets 4.0.3\r\nUsing capybara 3.37.1\r\nUsing faker 2.21.0\r\nUsing http-cookie 1.0.5\r\nUsing aws-sdk-kms 1.57.0\r\nUsing rest-client 2.1.0\r\nUsing aws-sdk-s3 1.114.0\r\nUsing mailgun-ruby 1.2.5\r\nUsing activemodel 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing rails-dom-testing 2.0.3\r\nUsing activerecord 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing actionview 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing globalid 1.0.0\r\nUsing actionpack 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing jbuilder 2.11.5\r\nUsing rails-controller-testing 1.0.5\r\nUsing sprockets-rails 3.4.2\r\nUsing railties 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing actioncable 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing activejob 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing activestorage 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing actionmailer 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing actionmailbox 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing active_storage_validations 0.9.8\r\nUsing actiontext 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@d1a9a99)\r\nUsing stimulus-rails 1.0.4\r\nUsing tailwindcss-rails 2.0.8 (arm64-darwin)\r\nUsing turbo-rails 1.1.1\r\nUsing web-console 4.2.0\r\nUsing importmap-rails 1.1.0\r\nBundle updated!","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45866/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45866/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45861","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45861/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45861/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45861/events","html_url":"https://github.com/rails/rails/issues/45861","id":1344796510,"node_id":"I_kwDNIULOUCf3Xg","number":45861,"title":"Rails 7, cannot be loaded  js controllers in production","user":{"login":"sergitejada","id":49126831,"node_id":"MDQ6VXNlcjQ5MTI2ODMx","avatar_url":"https://avatars.githubusercontent.com/u/49126831?v=4","gravatar_id":"","url":"https://api.github.com/users/sergitejada","html_url":"https://github.com/sergitejada","followers_url":"https://api.github.com/users/sergitejada/followers","following_url":"https://api.github.com/users/sergitejada/following{/other_user}","gists_url":"https://api.github.com/users/sergitejada/gists{/gist_id}","starred_url":"https://api.github.com/users/sergitejada/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergitejada/subscriptions","organizations_url":"https://api.github.com/users/sergitejada/orgs","repos_url":"https://api.github.com/users/sergitejada/repos","events_url":"https://api.github.com/users/sergitejada/events{/privacy}","received_events_url":"https://api.github.com/users/sergitejada/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-19T18:52:35Z","updated_at":"2022-08-30T14:42:05Z","closed_at":"2022-08-30T14:42:04Z","author_association":"NONE","active_lock_reason":null,"body":"When moving from development to production environment the JS drivers cannot load into the html.\r\n\r\n### Error\r\n![image](https://user-images.githubusercontent.com/49126831/185686468-4c725ec0-515b-43d5-ba8a-1ebc3f5a6d67.png)\r\n\r\n### My Code\r\n**JS Folder**:\r\n![image](https://user-images.githubusercontent.com/49126831/185686599-af905db8-3078-45f0-8b11-d60c5da040e6.png)\r\n**Main Page**:\r\n![image](https://user-images.githubusercontent.com/49126831/185687016-275b5870-1b30-4c38-a822-2acfc596f96e.png)\r\n**Config File**:\r\n![image](https://user-images.githubusercontent.com/49126831/185687399-26574566-4606-46ba-b46c-e0719a44d9eb.png)\r\n![image](https://user-images.githubusercontent.com/49126831/185687468-16bde524-aa61-46ca-a0cd-f0f080d436b2.png)\r\n\r\n**Public folder and Assets folder**:\r\n![image](https://user-images.githubusercontent.com/49126831/185687084-f85afb46-13ef-4bbe-b868-d6d7dcc3447d.png)\r\n\r\nMy actions to deploy:\r\n`RAILS_ENV=production rails assets:precompile`\r\n`RAILS_ENV=production rails s`\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**:  2.7.0\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45861/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45861/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45854","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45854/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45854/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45854/events","html_url":"https://github.com/rails/rails/issues/45854","id":1344230301,"node_id":"I_kwDNIULOUB9TnQ","number":45854,"title":"Bug when broadcasting TaggedLogging(without a block) loggers.","user":{"login":"tmimura39","id":11774087,"node_id":"MDQ6VXNlcjExNzc0MDg3","avatar_url":"https://avatars.githubusercontent.com/u/11774087?v=4","gravatar_id":"","url":"https://api.github.com/users/tmimura39","html_url":"https://github.com/tmimura39","followers_url":"https://api.github.com/users/tmimura39/followers","following_url":"https://api.github.com/users/tmimura39/following{/other_user}","gists_url":"https://api.github.com/users/tmimura39/gists{/gist_id}","starred_url":"https://api.github.com/users/tmimura39/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tmimura39/subscriptions","organizations_url":"https://api.github.com/users/tmimura39/orgs","repos_url":"https://api.github.com/users/tmimura39/repos","events_url":"https://api.github.com/users/tmimura39/events{/privacy}","received_events_url":"https://api.github.com/users/tmimura39/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-19T10:05:36Z","updated_at":"2022-09-08T16:03:57Z","closed_at":"2022-09-08T16:03:57Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\nrequire 'active_support'\r\nmain_logger = ActiveSupport::TaggedLogging.new(ActiveSupport::Logger.new('main_logger.log'))\r\nbroadcast_logger = ActiveSupport::TaggedLogging.new(ActiveSupport::Logger.new('broadcast_logger.log'))\r\nmain_logger.extend(ActiveSupport::Logger.broadcast(broadcast_logger))\r\nmain_logger.tagged('tag')\r\nmain_logger.info('text')\r\n```\r\n\r\n### Expected behavior\r\n\r\n```shell\r\n$ tail main_logger.log broadcast_logger.log\r\n==> main_logger.log <==\r\n# Logfile created on 2022-08-19 18:53:04 +0900 by logger.rb/v1.5.0\r\ntext\r\n\r\n==> broadcast_logger.log <==\r\n# Logfile created on 2022-08-19 18:53:04 +0900 by logger.rb/v1.5.0\r\ntext\r\n```\r\n\r\n### Actual behavior\r\n\r\n```shell\r\n$ tail main_logger.log broadcast_logger.log\r\n==> main_logger.log <==\r\n# Logfile created on 2022-08-19 18:53:04 +0900 by logger.rb/v1.5.0\r\ntext\r\n\r\n==> broadcast_logger.log <==\r\n# Logfile created on 2022-08-19 18:53:04 +0900 by logger.rb/v1.5.0\r\n[tag] text\r\n```\r\n\r\nIf `#tagged` is used without blocking, the tag is incorrectly referenced in the broadcast destination logger.\r\n\r\nI think it is a bug related to https://github.com/rails/rails/pull/44695.\r\n\r\nWhen the formatter of the logger that originated the broadcast is updated, the reference to the tag to which the broadcast is directed is switched.\r\nhttps://github.com/rails/rails/blob/04972d9b9ef60796dc8f0917817b5392d61fcf09/activesupport/lib/active_support/tagged_logging.rb#L99-L107\r\n\r\nwithout block `#tagged` creates a temporary logger, in which case the formatter is updated.\r\nhttps://github.com/rails/rails/blob/04972d9b9ef60796dc8f0917817b5392d61fcf09/activesupport/lib/active_support/tagged_logging.rb#L116\r\nhttps://github.com/rails/rails/blob/04972d9b9ef60796dc8f0917817b5392d61fcf09/activesupport/lib/active_support/tagged_logging.rb#L85-L90\r\n\r\nAs a result, it appears that tags applied to temporary loggers are subsequently referenced in the broadcast destination loggers.\r\n\r\n#### supplementary information\r\n\r\nThe standard output of logs at rails server startup in the development environment is implemented in broadcast.\r\nTherefore, there may be differences in log output between standard output and `log/develooment.log`.\r\nhttps://github.com/rails/rails/blob/3d84e1298b8dd073fb8be0725f8112f9bbdab51a/railties/lib/rails/commands/server/server_command.rb#L75-L85\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45854/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45854/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45852","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45852/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45852/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45852/events","html_url":"https://github.com/rails/rails/issues/45852","id":1343689966,"node_id":"I_kwDNIULOUBcU7g","number":45852,"title":"Enabling executor_around_test_case and disabling allow_concurrency fails controller tests","user":{"login":"JiaboHou","id":4871708,"node_id":"MDQ6VXNlcjQ4NzE3MDg=","avatar_url":"https://avatars.githubusercontent.com/u/4871708?v=4","gravatar_id":"","url":"https://api.github.com/users/JiaboHou","html_url":"https://github.com/JiaboHou","followers_url":"https://api.github.com/users/JiaboHou/followers","following_url":"https://api.github.com/users/JiaboHou/following{/other_user}","gists_url":"https://api.github.com/users/JiaboHou/gists{/gist_id}","starred_url":"https://api.github.com/users/JiaboHou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JiaboHou/subscriptions","organizations_url":"https://api.github.com/users/JiaboHou/orgs","repos_url":"https://api.github.com/users/JiaboHou/repos","events_url":"https://api.github.com/users/JiaboHou/events{/privacy}","received_events_url":"https://api.github.com/users/JiaboHou/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-18T21:57:06Z","updated_at":"2022-08-19T21:04:16Z","closed_at":"2022-08-19T21:04:16Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n1. In a test environment, set the following configs:\r\n    - [`config.active_support.executor_around_test_case`](https://guides.rubyonrails.org/configuring.html#config-active-support-executor-around-test-case) to `true`\r\n    - `config.allow_concurrency` to `false`\r\n2. Run a test that makes a web request (calls `get`, `post`, `patch`, etc.), usually a controller test.\r\n3. Observe the following error:\r\n`ThreadError: deadlock; recursive locking`\r\n\r\nI've also observed the following error in a different repo: \r\n```\r\nNoMethodError: undefined method `prepare!' for nil:NilClass\r\n\r\n            @response.prepare!\r\n```\r\n\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nI've created a repo to reproduce this error easily: https://github.com/JiaboHou/rails-concurrency-bug\r\nSimply run `bin/rails test`. See [latest commit](https://github.com/JiaboHou/rails-concurrency-bug/commit/4d820c5fa884e101c551e2a6545ba97c037ddc55) for what I changed compared to what running `rails new blog` provided.\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nThe test should run without any errors.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nThe test fails with a `ThreadError`.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n\r\n<details>\r\n<summary><h3>Debugging Info</h3></summary>\r\n\r\nI've also used the debugger here to find exactly where this exception is being raised:\r\n\r\n```ruby\r\n[91, 100] in ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/application/finisher.rb\r\n    91|         def initialize(mutex = Mutex.new)\r\n    92|           @mutex = mutex\r\n    93|         end\r\n    94|\r\n    95|         def run\r\n=>  96|           @mutex.lock\r\n    97|         end\r\n    98|\r\n    99|         def complete(_state)\r\n   100|           @mutex.unlock\r\n=>#0\tRails::Application::Finisher::MutexHook#run at ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/application/finisher.rb:96\r\n  #1\tActiveSupport::ExecutionWrapper::RunHook#before(target=#<#<Class:0x000000010648d620>:0x000000010...) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:29\r\n  # and 52 frames (use `bt' command for all frames)\r\n\r\nStop by #0  BP - Line  /Users/jiabo/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/application/finisher.rb:96 (call)\r\n(rdbg) bt    # backtrace command\r\n=>#0\tRails::Application::Finisher::MutexHook#run at ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/application/finisher.rb:96\r\n  #1\tActiveSupport::ExecutionWrapper::RunHook#before(target=#<#<Class:0x00000001077f5500>:0x000000010...) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:29\r\n  #2\tblock {|target=#<#<Class:0x00000001077f5500>:0x000000010..., value=nil, block=nil|} in make_lambda at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:423\r\n  #3\tblock in halting (2 levels) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:199\r\n  #4\tblock in default_terminator (2 levels) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:687\r\n  #5\t[C] Kernel#catch at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:686\r\n  #6\tblock {|target=#<#<Class:0x00000001077f5500>:0x000000010..., result_lambda=#<Proc:0x000000010735f360 /Users/jiabo/.g...|} in default_terminator at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:686\r\n  #7\tblock {|env=#<struct ActiveSupport::Callbacks::Filter...|} in halting at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:200\r\n  #8\tblock {|b=#<Proc:0x0000000105df8f30 /Users/jiabo/.g...|} in invoke_before at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:595\r\n  #9\t[C] Array#each at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:595\r\n  #10\tActiveSupport::Callbacks::CallbackSequence#invoke_before(arg=#<struct ActiveSupport::Callbacks::Filter...) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:595\r\n  #11\tActiveSupport::Callbacks#run_callbacks(kind=:run) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/callbacks.rb:106\r\n  #12\tActiveSupport::ExecutionWrapper#run at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:129\r\n  #13\tActiveSupport::ExecutionWrapper#run! at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:125\r\n  #14\tblock {|instance=#<#<Class:0x00000001077f5500>:0x000000010...|} in run! at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:78\r\n  #15\tKernel#tap at <internal:kernel>:90\r\n  #16\t#<Class:ActiveSupport::ExecutionWrapper>#run!(reset=true) at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:75\r\n  #17\tActionDispatch::Executor#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/middleware/executor.rb:12\r\n  #18\tRack::Lock#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/rack-2.2.4/lib/rack/lock.rb:18\r\n  #19\tActionDispatch::Static#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/middleware/static.rb:23\r\n  #20\tRack::Sendfile#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/rack-2.2.4/lib/rack/sendfile.rb:110\r\n  #21\tActionDispatch::HostAuthorization#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/middleware/host_authorization.rb:131\r\n  #22\tRails::Engine#call(env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/engine.rb:530\r\n  #23\tRack::Test::Session#process_request(uri=#<URI::HTTP http://www.example.com/articl..., env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<...) at ~/.gem/ruby/3.1.2/gems/rack-test-2.0.2/lib/rack/test.rb:358\r\n  #24\tRack::Test::Session#request(uri=#<URI::HTTP http://www.example.com/articl..., env={\"rack.version\"=>[1, 3], \"rack.input\"=>#<..., block=nil) at ~/.gem/ruby/3.1.2/gems/rack-test-2.0.2/lib/rack/test.rb:155\r\n  #25\tActionDispatch::Integration::Session#process(method=:get, path=\"/articles\", params=nil, headers={}, env=nil, xhr=false, as=nil) at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/testing/integration.rb:279\r\n  #26\tActionDispatch::Integration::RequestHelpers#get(path=\"/articles\", args={}) at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/testing/integration.rb:16\r\n  #27\tActionDispatch::Integration::Runner#get at ~/.gem/ruby/3.1.2/gems/actionpack-7.0.3.1/lib/action_dispatch/testing/integration.rb:370\r\n  #28\tblock in <class:ArticlesControllerTest> at ~/src/github.com/Shopify/test-rails/blog/test/controllers/articles_controller_test.rb:8\r\n  #29\tblock in run (3 levels) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:98\r\n  #30\tMinitest::Test#capture_exceptions at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:195\r\n  #31\tblock in run (2 levels) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:95\r\n  #32\tMinitest::Runnable#time_it at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:296\r\n  #33\tblock in run at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:94\r\n  #34\t#<Class:Minitest::Runnable>#on_signal(name=\"INFO\", action=#<Proc:0x000000010593adb8 /Users/jiabo/.g...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:391\r\n  #35\tMinitest::Test#with_info_handler(block=#<Proc:0x000000010593aef8 /Users/jiabo/.g...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:243\r\n  #36\tMinitest::Test#run at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest/test.rb:93\r\n  #37\tblock in run at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/executor/test_helper.rb:5\r\n  #38\t#<Class:ActiveSupport::ExecutionWrapper>#perform at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/execution_wrapper.rb:105\r\n  #39\tActiveSupport::Executor::TestHelper#run at ~/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/executor/test_helper.rb:5\r\n  #40\tMinitest.run_one_method(klass=ArticlesControllerTest, method_name=\"test_successful_response\") at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:1059\r\n  #41\t#<Class:Minitest::Runnable>#run_one_method(klass=ArticlesControllerTest, method_name=\"test_successful_response\", reporter=#<Minitest::CompositeReporter:0x000000010...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:365\r\n  #42\tblock {|method_name=\"test_successful_response\"|} in run (2 levels) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:352\r\n  #43\t[C] Array#each at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:351\r\n  #44\tblock in run at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:351\r\n  #45\t#<Class:Minitest::Runnable>#on_signal(name=\"INFO\", action=#<Proc:0x0000000105f35e70 /Users/jiabo/.g...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:391\r\n  #46\t#<Class:Minitest::Runnable>#with_info_handler(reporter=#<Minitest::CompositeReporter:0x000000010..., block=#<Proc:0x0000000105f35ee8 /Users/jiabo/.g...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:378\r\n  #47\t#<Class:Minitest::Runnable>#run(reporter=#<Minitest::CompositeReporter:0x000000010..., options={:io=>#<IO:<STDOUT>>, :color=>true, :outp...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:350\r\n  #48\tRails::LineFiltering#run(reporter=#<Minitest::CompositeReporter:0x000000010..., options={:io=>#<IO:<STDOUT>>, :color=>true, :outp...) at ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/test_unit/line_filtering.rb:10\r\n  #49\tblock {|suite=ArticlesControllerTest|} in __run at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:182\r\n  #50\t[C] Array#map at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:182\r\n  #51\tMinitest.__run(reporter=#<Minitest::CompositeReporter:0x000000010..., options={:io=>#<IO:<STDOUT>>, :color=>true, :outp...) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:182\r\n  #52\tMinitest.run(args=[]) at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:159\r\n  #53\tblock in autorun at ~/.gem/ruby/3.1.2/gems/minitest-5.16.3/lib/minitest.rb:83\r\n(rdbg) s    # step command\r\nDEBUGGER (trace/exception) #th:1 #depth:55 #<ThreadError: deadlock; recursive locking> at ~/.gem/ruby/3.1.2/gems/railties-7.0.3.1/lib/rails/application/finisher.rb:96\r\n```\r\n\r\n</details>","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45852/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45852/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45847","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45847/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45847/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45847/events","html_url":"https://github.com/rails/rails/issues/45847","id":1343151854,"node_id":"I_kwDNIULOUA7e7g","number":45847,"title":"Proposal: MySQL UUID Proposal [Draft]","user":{"login":"pnegri","id":39310,"node_id":"MDQ6VXNlcjM5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/39310?v=4","gravatar_id":"","url":"https://api.github.com/users/pnegri","html_url":"https://github.com/pnegri","followers_url":"https://api.github.com/users/pnegri/followers","following_url":"https://api.github.com/users/pnegri/following{/other_user}","gists_url":"https://api.github.com/users/pnegri/gists{/gist_id}","starred_url":"https://api.github.com/users/pnegri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pnegri/subscriptions","organizations_url":"https://api.github.com/users/pnegri/orgs","repos_url":"https://api.github.com/users/pnegri/repos","events_url":"https://api.github.com/users/pnegri/events{/privacy}","received_events_url":"https://api.github.com/users/pnegri/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2022-08-18T14:01:09Z","updated_at":"2022-09-08T07:34:43Z","closed_at":"2022-09-08T07:34:43Z","author_association":"NONE","active_lock_reason":null,"body":"### MySQL UUID (Draft)\r\n\r\nWe want to add native rails support for UUID on MySQL. We currently use a solution at iugu (Financial Institution at Brazil) that we update on each new rails version (With tables with more than 200 million records).\r\n\r\nCurrent code we use for Rails 7 shared at:\r\nhttps://github.com/pnegri/rails7-mysql-uuid (As a Patch to Rails)\r\n\r\nUUID Attribute Gem - POC:\r\nhttps://github.com/iugu/uuid_attribute\r\nhttps://rubygems.org/gems/uuid_attribute\r\n\r\n```\r\n\r\nChange initializer to make uuid as primary_id:\r\nconfig/initializers/generators.rb:\r\nRails.application.config.generators do |g|\r\n  g.orm :active_record, primary_key_type: :uuid\r\nend\r\n\r\nOutputs from sample code:\r\nrails g model Person name:string\r\n\r\nclass CreatePeople < ActiveRecord::Migration[7.0]\r\n  def change\r\n    create_table :people, id: :uuid do |t|\r\n      t.string :name\r\n\r\n      t.timestamps\r\n    end\r\n  end\r\nend\r\n\r\nAt rails console:\r\n\r\nrb(main):001:0> person = Person.create(name: 'Patrick Negri')\r\n  TRANSACTION (0.2ms)  BEGIN\r\n  Person Create (0.2ms)  INSERT INTO `people` (`id`, `name`, `created_at`, `updated_at`) VALUES (x'bbc8972af4fa4284939358603875cb8b', 'Patrick Negri', '2022-08-18 13:52:41.958421', '2022-08-18 13:52:41.958421')                    \r\n  TRANSACTION (1.5ms)  COMMIT                                                \r\n=>                                                                           \r\n#<Person:0x00007f85774135a8                                                  \r\n...                                                                          \r\nirb(main):002:0>\r\n\r\n====\r\n\r\nirb(main):002:0> person\r\n=> \r\n#<Person:0x00007f85774135a8                                                \r\n id: \"5iLEaLFZUeD6Dg8nnfSiCZ\",       (Supports shortened UUID)                                       \r\n name: \"Patrick Negri\",                                                    \r\n created_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00,               \r\n updated_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00>               \r\nirb(main):003:0>\r\n\r\n====\r\n\r\nirb(main):011:0> person.id.to_uuid\r\n=> #<UUID:0x17f20 UUID:bbc8972a-f4fa-4284-9393-58603875cb8b>\r\n\r\n====\r\n\r\nirb(main):012:0> person.id.to_uuid.to_param\r\n=> \"BBC8972AF4FA4284939358603875CB8B\"\r\nirb(main):017:0> person.id.to_uuid.to_s\r\n=> \"bbc8972a-f4fa-4284-9393-58603875cb8b\"\r\nirb(main):018:0> person.id.to_uuid.shorten\r\n=> \"5iLEaLFZUeD6Dg8nnfSiCZ\"\r\n\r\n====\r\n\r\nSupports finding by Hex\r\nirb(main):019:0> Person.find('BBC8972AF4FA4284939358603875CB8B')\r\n  Person Load (0.3ms)  SELECT `people`.* FROM `people` WHERE `people`.`id` = x'bbc8972af4fa4284939358603875cb8b' LIMIT 1\r\n=>                                                                                          \r\n#<Person:0x00007f857b075410                                                                 \r\n id: \"5iLEaLFZUeD6Dg8nnfSiCZ\",                                                              \r\n name: \"Patrick Negri\",                                                                     \r\n created_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00,                                \r\n updated_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00>\r\n\r\n====\r\n\r\nSupports finding by Shortened Hex\r\nirb(main):020:0> Person.find('5iLEaLFZUeD6Dg8nnfSiCZ')\r\n  Person Load (0.4ms)  SELECT `people`.* FROM `people` WHERE `people`.`id` = x'bbc8972af4fa4284939358603875cb8b' LIMIT 1\r\n=>                                                                                          \r\n#<Person:0x00007f8578d1e9f8                                       \r\n id: \"5iLEaLFZUeD6Dg8nnfSiCZ\",                                    \r\n name: \"Patrick Negri\",                                           \r\n created_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00,      \r\n updated_at: Thu, 18 Aug 2022 13:52:41.958421000 UTC +00:00>\r\n```\r\n\r\n### Expected behavior\r\nWe would like to use UUID for MySQL as a native feature, using binary(16) for older MySQLs and MariaDB but also uuid for newer ones (MariaDB, MySQL is still using binary(16)).\r\n\r\n### Actual behavior\r\nWhen we try to use :uuid on MySQL we get errors on lots of different places, from primary key to references.\r\n\r\n### System configuration\r\nAny supported Rails version\r\nAny supported Ruby version\r\n\r\n### TODO\r\nRemove any UUID Tools reference (Done on POC Gem)\r\nIf going to gem path, support PostgreSQL uuid or bytea","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45847/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":2,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45847/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45846","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45846/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45846/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45846/events","html_url":"https://github.com/rails/rails/issues/45846","id":1343150404,"node_id":"I_kwDNIULOUA7ZRA","number":45846,"title":"7-0-stable still breaks with ActiveRecord.serialize with yaml coder","user":{"login":"renatolond","id":173791,"node_id":"MDQ6VXNlcjE3Mzc5MQ==","avatar_url":"https://avatars.githubusercontent.com/u/173791?v=4","gravatar_id":"","url":"https://api.github.com/users/renatolond","html_url":"https://github.com/renatolond","followers_url":"https://api.github.com/users/renatolond/followers","following_url":"https://api.github.com/users/renatolond/following{/other_user}","gists_url":"https://api.github.com/users/renatolond/gists{/gist_id}","starred_url":"https://api.github.com/users/renatolond/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/renatolond/subscriptions","organizations_url":"https://api.github.com/users/renatolond/orgs","repos_url":"https://api.github.com/users/renatolond/repos","events_url":"https://api.github.com/users/renatolond/events{/privacy}","received_events_url":"https://api.github.com/users/renatolond/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-18T14:00:04Z","updated_at":"2022-08-22T08:46:34Z","closed_at":"2022-08-22T08:46:34Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n```\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"7-0-stable\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\nrequire \"active_record\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    post \"/\" => \"test#index\"\r\n  end\r\nend\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.text :data\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  serialize :data\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    Post.create!(params.permit(data: [:title]))\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    post \"/\", data: { title: \"who needs a schema?\" }\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nIt should serialize simple values into the data column & back out, like it used to in Rails 7.0.3\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nAn PsychDisallowedClass is raised:\r\n```\r\nPsych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/class_loader.rb:97:in `find'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/class_loader.rb:28:in `load'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:411:in `resolve_class'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:283:in `visit_Psych_Nodes_Mapping'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:313:in `visit_Psych_Nodes_Document'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/visitor.rb:16:in `visit'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/visitor.rb:6:in `accept'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych/visitors/to_ruby.rb:32:in `accept'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/psych.rb:360:in `safe_load'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/coders/yaml_column.rb:61:in `yaml_load'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/coders/yaml_column.rb:26:in `load'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/type/serialized.rb:22:in `deserialize'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/type/helpers/mutable.rb:8:in `cast'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/attribute.rb:179:in `type_cast'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/attribute.rb:43:in `value'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/attribute_set.rb:46:in `fetch_value'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/transactions.rb:403:in `block in restore_transaction_record_state'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/attribute_set.rb:93:in `transform_values'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activemodel/lib/active_model/attribute_set.rb:93:in `map'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/transactions.rb:402:in `restore_transaction_record_state'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/transactions.rb:334:in `rolledback!'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:134:in `rollback_records'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:312:in `block in rollback_transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:309:in `rollback_transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:325:in `rescue in block in within_new_transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:322:in `block in within_new_transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:317:in `within_new_transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/transactions.rb:350:in `with_transaction_returning_status'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/transactions.rb:302:in `save!'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/suppressor.rb:54:in `save!'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activerecord/lib/active_record/persistence.rb:55:in `create!'\r\ntest.rb:47:in `index'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/basic_implicit_render.rb:6:in `send_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/abstract_controller/base.rb:215:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/rendering.rb:53:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/abstract_controller/callbacks.rb:234:in `block in process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/callbacks.rb:99:in `run_callbacks'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/abstract_controller/callbacks.rb:233:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/rescue.rb:22:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/instrumentation.rb:67:in `block in process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/instrumentation.rb:66:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal/params_wrapper.rb:259:in `process_action'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/abstract_controller/base.rb:151:in `process'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionview/lib/action_view/rendering.rb:39:in `process'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal.rb:188:in `dispatch'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_controller/metal.rb:251:in `dispatch'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/routing/route_set.rb:49:in `dispatch'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/routing/route_set.rb:32:in `serve'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/journey/router.rb:32:in `each'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/journey/router.rb:32:in `serve'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/routing/route_set.rb:852:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/tempfile_reaper.rb:15:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/etag.rb:27:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/conditional_get.rb:40:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/head.rb:12:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/http/permissions_policy.rb:38:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/http/content_security_policy.rb:36:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/cookies.rb:696:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/activesupport/lib/active_support/callbacks.rb:99:in `run_callbacks'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/executor.rb:14:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/railties/lib/rails/rack/logger.rb:40:in `call_app'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/railties/lib/rails/rack/logger.rb:27:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/remote_ip.rb:93:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/method_override.rb:24:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/runtime.rb:22:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/executor.rb:14:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/static.rb:23:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-2.2.4/lib/rack/sendfile.rb:110:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/actionpack/lib/action_dispatch/middleware/host_authorization.rb:137:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/bundler/gems/rails-cd673773bc65/railties/lib/rails/engine.rb:530:in `call'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-test-2.0.2/lib/rack/test.rb:358:in `process_request'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-test-2.0.2/lib/rack/test.rb:165:in `custom_request'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/rack-test-2.0.2/lib/rack/test.rb:114:in `post'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/2.7.0/forwardable.rb:235:in `post'\r\ntest.rb:62:in `test_returns_success'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:98:in `block (3 levels) in run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:195:in `capture_exceptions'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:95:in `block (2 levels) in run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:296:in `time_it'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:94:in `block in run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:391:in `on_signal'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:243:in `with_info_handler'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest/test.rb:93:in `run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:1059:in `run_one_method'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:365:in `run_one_method'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:352:in `block (2 levels) in run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:351:in `each'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:351:in `block in run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:391:in `on_signal'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:378:in `with_info_handler'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:350:in `run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:182:in `block in __run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:182:in `map'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:182:in `__run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:159:in `run'\r\n/home/renatolond/.rvm/rubies/ruby-2.7.6-jemalloc/lib/ruby/gems/2.7.0/gems/minitest-5.16.3/lib/minitest.rb:83:in `block in autorun'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: From 7-0-stable, which has the fix for #45585\r\n\r\n**Ruby version**: 2.7.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45846/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45844","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45844/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45844/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45844/events","html_url":"https://github.com/rails/rails/issues/45844","id":1342959363,"node_id":"I_kwDNIULOUAvvAw","number":45844,"title":"ActionView output_buffer issue on newly registered view file types","user":{"login":"rikkipitt","id":1147871,"node_id":"MDQ6VXNlcjExNDc4NzE=","avatar_url":"https://avatars.githubusercontent.com/u/1147871?v=4","gravatar_id":"","url":"https://api.github.com/users/rikkipitt","html_url":"https://github.com/rikkipitt","followers_url":"https://api.github.com/users/rikkipitt/followers","following_url":"https://api.github.com/users/rikkipitt/following{/other_user}","gists_url":"https://api.github.com/users/rikkipitt/gists{/gist_id}","starred_url":"https://api.github.com/users/rikkipitt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rikkipitt/subscriptions","organizations_url":"https://api.github.com/users/rikkipitt/orgs","repos_url":"https://api.github.com/users/rikkipitt/repos","events_url":"https://api.github.com/users/rikkipitt/events{/privacy}","received_events_url":"https://api.github.com/users/rikkipitt/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-08-18T11:24:22Z","updated_at":"2022-09-06T09:27:30Z","closed_at":"2022-09-06T09:27:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nUsing the latest Rails version (HEAD), I'm getting some issues with views that have extensions that have been registered. For example, I have a markdown handler that works in Rails 6.1.6.1 but seemingly not in 7 (specifically, 7.1).\r\n\r\nWhen the view/templates are rendered, what's returned is an `@output_buffer.safe_append=\"...\"` leading to things like:\r\n\r\n`undefined method 'gsub' for #<ActionView::OutputBuffer:0x000000011f067aa0 @raw_buffer=\"...\"`\r\n\r\nIt also happens with mailer views rendered by https://github.com/foundation/inky-rb via files like `mailer.html.inky`\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nI expect HTML to be returned, I think.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nAn Actionview output buffer is returned, leading to errors from missing methods that probably expect a string.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.1.0.alpha\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]\r\n\r\nApologies for the tricky one. Let me know if I can do anything to explain it a bit better. Perhaps I'll see if I can create a proof of concept demo repo?\r\n\r\nCheers","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45844/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45844/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45841","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45841/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45841/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45841/events","html_url":"https://github.com/rails/rails/issues/45841","id":1341960150,"node_id":"I_kwDNIULOT_yv1g","number":45841,"title":"Configure a Base class per database for multi db setups","user":{"login":"jwoodrow","id":9072741,"node_id":"MDQ6VXNlcjkwNzI3NDE=","avatar_url":"https://avatars.githubusercontent.com/u/9072741?v=4","gravatar_id":"","url":"https://api.github.com/users/jwoodrow","html_url":"https://github.com/jwoodrow","followers_url":"https://api.github.com/users/jwoodrow/followers","following_url":"https://api.github.com/users/jwoodrow/following{/other_user}","gists_url":"https://api.github.com/users/jwoodrow/gists{/gist_id}","starred_url":"https://api.github.com/users/jwoodrow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jwoodrow/subscriptions","organizations_url":"https://api.github.com/users/jwoodrow/orgs","repos_url":"https://api.github.com/users/jwoodrow/repos","events_url":"https://api.github.com/users/jwoodrow/events{/privacy}","received_events_url":"https://api.github.com/users/jwoodrow/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-17T15:40:16Z","updated_at":"2022-09-02T21:15:12Z","closed_at":"2022-09-02T21:15:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nI don't know if this is the right place for this but I've been having issues with multi-db setups where the `schema_migrations` tabl for a database ends up filled in by another database's migration timestamps. This would result in permanent `Pending migrations` preventing code execution.\r\n\r\nI've worked around it somehow by creating my own `ActiveRecord::Migration[6.1]` inherited classes to use for each type of migration a little like this\r\n\r\n```ruby\r\nclass PrimaryMigration < ActiveRecord::Migration[6.1]\r\n  def connection\r\n    @connection ||= Primary::Base.establish_connection.connection\r\n  end\r\nend\r\n```\r\n\r\nBut this implies manually modifying future migrations to use the right `Migration` class which does feel right.\r\n\r\nBy looking into the code it seems there might be the `connection_specification_name` in the [`schema_migration`](https://github.com/rails/rails/blob/d6973d50d01fe55e5c65368b92160708fb60a3da/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L195) method that might look like what I'm looking for but I have no idea if and how this can be configured 🤔 \r\n\r\nMaybe an option like this might be interesting to have ?\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```yaml\r\n# database.yml\r\nprimary:\r\n  url: some_url\r\n  migrations_paths: db/migrate/primary\r\n  base: 'Primary::Base'\r\nsecondary:\r\n  url: some_other_url\r\n  migrations_paths: db/migrate/secondary\r\n  base: 'Secondary::Base'\r\ntertiary:\r\n  url: yet_another_other_url\r\n  migrations_paths: db/migrate/tertiary\r\n  base: 'Tertiary::Base'\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n`schema_migrations` are stored in the right database for each database\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n`schema_migrations` seem all jumbled up and maybe even ascii order dependent (with 2 databases ahoy/primary my ahoy migrations get run first but are saved in the `primary` database's `schema_migrations` table)\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 3.0.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45841/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45841/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45838","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45838/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45838/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45838/events","html_url":"https://github.com/rails/rails/issues/45838","id":1341004704,"node_id":"I_kwDNIULOT-4boA","number":45838,"title":"Tailwind isn't working with Rails7 and React(jsbundling)","user":{"login":"mikinovation","id":33025073,"node_id":"MDQ6VXNlcjMzMDI1MDcz","avatar_url":"https://avatars.githubusercontent.com/u/33025073?v=4","gravatar_id":"","url":"https://api.github.com/users/mikinovation","html_url":"https://github.com/mikinovation","followers_url":"https://api.github.com/users/mikinovation/followers","following_url":"https://api.github.com/users/mikinovation/following{/other_user}","gists_url":"https://api.github.com/users/mikinovation/gists{/gist_id}","starred_url":"https://api.github.com/users/mikinovation/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikinovation/subscriptions","organizations_url":"https://api.github.com/users/mikinovation/orgs","repos_url":"https://api.github.com/users/mikinovation/repos","events_url":"https://api.github.com/users/mikinovation/events{/privacy}","received_events_url":"https://api.github.com/users/mikinovation/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-17T00:16:04Z","updated_at":"2022-08-17T10:31:42Z","closed_at":"2022-08-17T10:31:10Z","author_association":"NONE","active_lock_reason":null,"body":"## Problem\r\nI tried to use rails7 with react(esbuild) and tailwind.\r\nHowever I need to make rails read tailwind class name at once on \"rails view\" for tailwind to work on react.\r\nI use tailwind CLI with rails `rails tailwindcss:watch` in my env\r\n\r\nhttps://tailwindcss.com/blog/standalone-cli\r\n\r\n## Ask\r\nI think tailwind minify CSS following the classes on \"rails view\" but CSS won't be built when I added class name to react component.\r\nShould I not use tailwind CLI with rails? I wonder if I need to choose install tailwind in package.json\r\n\r\nThank you","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45838/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45838/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45832","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45832/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45832/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45832/events","html_url":"https://github.com/rails/rails/issues/45832","id":1339487378,"node_id":"I_kwDNIULOT9b0kg","number":45832,"title":"MySQL 8.0 VARBINARY default value is hexadecimal","user":{"login":"HParker","id":4482399,"node_id":"MDQ6VXNlcjQ0ODIzOTk=","avatar_url":"https://avatars.githubusercontent.com/u/4482399?v=4","gravatar_id":"","url":"https://api.github.com/users/HParker","html_url":"https://github.com/HParker","followers_url":"https://api.github.com/users/HParker/followers","following_url":"https://api.github.com/users/HParker/following{/other_user}","gists_url":"https://api.github.com/users/HParker/gists{/gist_id}","starred_url":"https://api.github.com/users/HParker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HParker/subscriptions","organizations_url":"https://api.github.com/users/HParker/orgs","repos_url":"https://api.github.com/users/HParker/repos","events_url":"https://api.github.com/users/HParker/events{/privacy}","received_events_url":"https://api.github.com/users/HParker/received_events","type":"User","site_admin":true},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":309390193,"node_id":"MDU6TGFiZWwzMDkzOTAxOTM=","url":"https://api.github.com/repos/rails/rails/labels/MySQL","name":"MySQL","color":"fef2c0","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-15T20:42:09Z","updated_at":"2022-08-16T10:23:16Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Default values on VARBINARY columns changed behavior between MySQL 5.7 and 8.0\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"mysql2\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"mysql2\", database: \"adam_test\", prepared_statements: false, host: '127.0.0.1', port: 3307, user: \"root\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.binary :some_binary, null: false, limit: 1024, default: \"hello-world\"\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_mysql_defaults\r\n    post = Post.create!\r\n\r\n    mysql_vars = ActiveRecord::Base.connection.select_rows(\"SHOW VARIABLES LIKE '%version%'\")\r\n    puts mysql_vars.inspect\r\n    puts Post.column_defaults\r\n\r\n    # assert_equal \"0x68656C6C6F2D776F726C64\", post.some_binary # This passes\r\n    assert_equal \"hello-world\", post.some_binary # This fails\r\n\r\n    reloaded_post = Post.first\r\n    assert_equal \"hello-world\", reloaded_post.some_binary # this passes\r\n  end\r\nend\r\n```\r\n\r\nOn MySQL 5.7:\r\n\r\n```ruby\r\nPost.column_defaults # => {\"id\"=>nil, \"some_binary\"=>\"hello-world\"}\r\n```\r\n\r\nOn MySQL 8.0:\r\n\r\n```ruby\r\nPost.column_defaults # => {\"id\"=>nil, \"some_binary\"=>\"0x68656C6C6F2D776F726C64\"}\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe default value on binary columns should be Ruby strings, not ruby strings of hexadecimal.\r\n\r\n### Actual behavior\r\n\r\nThe column default in MySQL 8.0 is a hexadecimal string representing the binary data.\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.1.0\r\n\r\nSome interesting MySQL forum posts about this behavior change:\r\n\r\n- https://forums.mysql.com/read.php?24,685577,685577\r\n- https://forums.mysql.com/read.php?20,698061,698061#msg-698061\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45832/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45832/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45830","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45830/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45830/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45830/events","html_url":"https://github.com/rails/rails/issues/45830","id":1338922250,"node_id":"I_kwDNIULOT85VCg","number":45830,"title":"ActiveRecord Rollbacks on errors which happen on commit","user":{"login":"Baxxx","id":17880055,"node_id":"MDQ6VXNlcjE3ODgwMDU1","avatar_url":"https://avatars.githubusercontent.com/u/17880055?v=4","gravatar_id":"","url":"https://api.github.com/users/Baxxx","html_url":"https://github.com/Baxxx","followers_url":"https://api.github.com/users/Baxxx/followers","following_url":"https://api.github.com/users/Baxxx/following{/other_user}","gists_url":"https://api.github.com/users/Baxxx/gists{/gist_id}","starred_url":"https://api.github.com/users/Baxxx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Baxxx/subscriptions","organizations_url":"https://api.github.com/users/Baxxx/orgs","repos_url":"https://api.github.com/users/Baxxx/repos","events_url":"https://api.github.com/users/Baxxx/events{/privacy}","received_events_url":"https://api.github.com/users/Baxxx/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-08-15T12:09:14Z","updated_at":"2022-08-25T13:32:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nIn some of our projects we use Postgres as database, and for some cases we deferred trigger constraints. These triggers fire up when `COMMIT` is called. Trigger can raise an error, which kills the transaction. ActiveRecord catches the error, and bubbles it up to developer, but it also sends `ROLLBACK` to Postgres, to which Postgres gives a warning that there is no transaction in progress.\r\n\r\nI didn't test this with sqlite3 or mysql.\r\n\r\nYou can see the reproduction script, and screenshot with the current behavior.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", \"~> 7\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"logger\"\r\n\r\nlogger = Logger.new(STDOUT)\r\n\r\n# This connection will do for database-independent bug reports.\r\npg_opts = {adapter: \"postgresql\", database: \"ar_rollback_after_failed_commit_issue\"}\r\n\r\nActiveRecord::Base.establish_connection(pg_opts.except(:database))\r\nActiveRecord::Base.connection.drop_database(pg_opts[:database])\r\nActiveRecord::Base.connection.create_database(pg_opts[:database])\r\nlogger.info \"Database #{pg_opts[:database]} was (re)created.\"\r\n\r\nActiveRecord::Base.establish_connection(pg_opts)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  execute <<~SQL\r\n    CREATE FUNCTION perform_custom_validation()\r\n      RETURNS TRIGGER\r\n      LANGUAGE plpgsql\r\n      AS $$\r\n        DECLARE\r\n          total_invalid INTEGER;\r\n        BEGIN\r\n          SELECT COUNT(*) INTO total_invalid\r\n          FROM things\r\n          WHERE name = 'bad';\r\n\r\n          IF (total_invalid > 0) THEN\r\n            RAISE EXCEPTION 'There are bad things';\r\n          END IF;\r\n          RETURN NULL;\r\n        END;\r\n      $$;\r\n\r\n    CREATE TABLE \"things\" (\r\n      \"id\" bigserial primary key,\r\n      \"name\" character varying NOT NULL\r\n    );\r\n\r\n    CREATE CONSTRAINT\r\n      TRIGGER bank_transaction_rl_payment_date_validation\r\n      AFTER INSERT OR UPDATE ON things\r\n      DEFERRABLE INITIALLY DEFERRED\r\n      FOR EACH ROW EXECUTE FUNCTION perform_custom_validation();\r\n  SQL\r\nend\r\n\r\nclass Thing < ActiveRecord::Base\r\n  validates :name, presence: true\r\nend\r\n\r\n# All good\r\nlogger.info \"First transaction\"\r\nThing.create!(name: \"good\")\r\n\r\n# AR tries to commit, DB raises an error, AR tries to ROLLBACK, and PG gives a warning\r\nbegin\r\n  logger.info \"Second transaction\"\r\n  Thing.create!(name: \"bad\")\r\nrescue StandardError\r\n  # Doesn't matter\r\nend\r\n```\r\n\r\n### Expected behavior\r\nActiveRecord should not `ROLLBACK`, as there is no transaction in progress.\r\n\r\n### Actual behavior\r\nActiveRecord tries to `ROLLBACK`.\r\n\r\n![Screenshot from 2022-08-15 14-07-11](https://user-images.githubusercontent.com/17880055/184632335-0277cd27-4c7b-4b98-94a8-373be34a87ee.png)\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 2.7.5p203\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45830/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45830/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45826","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45826/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45826/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45826/events","html_url":"https://github.com/rails/rails/issues/45826","id":1337836753,"node_id":"I_kwDNIULOT73E0Q","number":45826,"title":"Psych::DisallowedClass in xxxcontroller#update Tried to load unspecified class: ActiveSupport::TimeWithZone","user":{"login":"laptopmutia","id":43276109,"node_id":"MDQ6VXNlcjQzMjc2MTA5","avatar_url":"https://avatars.githubusercontent.com/u/43276109?v=4","gravatar_id":"","url":"https://api.github.com/users/laptopmutia","html_url":"https://github.com/laptopmutia","followers_url":"https://api.github.com/users/laptopmutia/followers","following_url":"https://api.github.com/users/laptopmutia/following{/other_user}","gists_url":"https://api.github.com/users/laptopmutia/gists{/gist_id}","starred_url":"https://api.github.com/users/laptopmutia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laptopmutia/subscriptions","organizations_url":"https://api.github.com/users/laptopmutia/orgs","repos_url":"https://api.github.com/users/laptopmutia/repos","events_url":"https://api.github.com/users/laptopmutia/events{/privacy}","received_events_url":"https://api.github.com/users/laptopmutia/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-13T03:06:24Z","updated_at":"2022-08-15T12:55:13Z","closed_at":"2022-08-15T12:55:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nmy application is just fine before then I do bundle update so that It could [fixed debug error with 1.6.1 ](https://github.com/ruby/debug/issues/735)\r\nthis is the gemfile changes before and after I did `bundle update`\r\nhttps://gist.github.com/laptopmutia/ddc22041f81a81995e42ea0ef0e5d8eb/revisions\r\n```\r\nPsych::DisallowedClass in BillsController#update\r\nTried to load unspecified class: BigDecimal\r\n\r\nRails.root: /home/mutia/freya\r\n[Application Trace](http://localhost:3000/freights/448/bills/2143/edit#) | [Framework Trace](http://localhost:3000/freights/448/bills/2143/edit#) | [Full Trace](http://localhost:3000/freights/448/bills/2143/edit#)\r\n(eval):2:in `big_decimal'\r\napp/controllers/bills_controller.rb:116:in `block in update'\r\napp/controllers/bills_controller.rb:115:in `update'\r\nRequest\r\n\r\nParameters:\r\n\r\n{\"_method\"=>\"patch\",\r\n \"authenticity_token\"=>\"[FILTERED]\",\r\n \"bill\"=>\r\n  {\"type\"=>\"Invoice\",\r\n   \"revisi\"=>\"0\",\r\n   \"foreign_payment\"=>\"0\",\r\n   \"bill_to_type\"=>\"Company\",\r\n   \"bill_to_id\"=>\"356\",\r\n   \"vat\"=>\"2\",\r\n   \"foreign_currency_id\"=>\"5\",\r\n   \"currency_rate\"=>\"0.0\",\r\n   \"billed_at\"=>\"2022-06-26\",\r\n   \"termin\"=>\"30_hari\",\r\n   \"bill_entries_attributes\"=>\r\n    {\"0\"=>{\"bill_type_id\"=>\"521\", \"quantity\"=>\"1.0\", \"bill_unit_id\"=>\"4\", \"currency_type\"=>\"local\", \"price\"=>\"1000000.0\", \"_destroy\"=>\"false\", \"id\"=>\"9126\"},\r\n     \"1\"=>{\"bill_type_id\"=>\"588\", \"quantity\"=>\"1.0\", \"bill_unit_id\"=>\"4\", \"currency_type\"=>\"local\", \"price\"=>\"600000.0\", \"_destroy\"=>\"false\", \"id\"=>\"9127\"},\r\n     \"2\"=>{\"bill_type_id\"=>\"438\", \"quantity\"=>\"1.0\", \"bill_unit_id\"=>\"4\", \"currency_type\"=>\"local\", \"price\"=>\"250000.0\", \"_destroy\"=>\"false\", \"id\"=>\"9128\"},\r\n     \"3\"=>{\"bill_type_id\"=>\"293\", \"quantity\"=>\"1.0\", \"bill_unit_id\"=>\"4\", \"currency_type\"=>\"local\", \"price\"=>\"250000.0\", \"_destroy\"=>\"false\", \"id\"=>\"9129\"}}},\r\n \"commit\"=>\"Save\",\r\n \"freight_id\"=>\"448\",\r\n \"id\"=>\"2143\"}\r\n ```\r\n\r\n### Expected behavior\r\nits should not error\r\n\r\n### Actual behavior\r\nit gives weird error that is hard for me to trace it happens when I do a model update \r\nand the message is based on attributes that I update sometimes it throw this\r\n```\r\nPsych::DisallowedClass in BillsController#update \r\nTried to load unspecified class: ActiveSupport::TimeWithZone\r\n```\r\nand also this \r\n```\r\nPsych::DisallowedClass in BillsController#update\r\nTried to load unspecified class: BigDecimal\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45826/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45826/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45823","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45823/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45823/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45823/events","html_url":"https://github.com/rails/rails/issues/45823","id":1337409694,"node_id":"I_kwDNIULOT7dAng","number":45823,"title":"Change Column with Raw Character Set Failure","user":{"login":"ahoglund","id":3407303,"node_id":"MDQ6VXNlcjM0MDczMDM=","avatar_url":"https://avatars.githubusercontent.com/u/3407303?v=4","gravatar_id":"","url":"https://api.github.com/users/ahoglund","html_url":"https://github.com/ahoglund","followers_url":"https://api.github.com/users/ahoglund/followers","following_url":"https://api.github.com/users/ahoglund/following{/other_user}","gists_url":"https://api.github.com/users/ahoglund/gists{/gist_id}","starred_url":"https://api.github.com/users/ahoglund/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ahoglund/subscriptions","organizations_url":"https://api.github.com/users/ahoglund/orgs","repos_url":"https://api.github.com/users/ahoglund/repos","events_url":"https://api.github.com/users/ahoglund/events{/privacy}","received_events_url":"https://api.github.com/users/ahoglund/received_events","type":"User","site_admin":true},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-12T16:21:50Z","updated_at":"2022-08-12T20:47:38Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With [this recent change to how collation is handled for column changes](https://github.com/rails/rails/pull/45744/files), there is now a potential for older migrations written in a specific manner to break if the `collation:` argument is not specific.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\n# you need to install mysql locally for this to work.\r\n# on Mac:\r\n# brew install mysql\r\n# brew services start mysql\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"mysql2\"\r\n\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nclient = Mysql2::Client.new(host: 'localhost', username: \"root\")\r\nclient.query(\"DROP DATABASE test\")\r\nclient.query(\"CREATE DATABASE test\")\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"mysql2\", database: \"test\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :payments, force: true do |t|\r\n    t.string :description, \"varchar(64)\", null: false\r\n  end\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass ChangeAmountToAddScale < ActiveRecord::Migration[7.1]\r\n  # This sets the default character set for the payments\r\n  # table to utf32 with a default COLLATION of utf32_general_ci.\r\n  # This can be verified by running the following query:\r\n  #\r\n  # SHOW CHARACTER SET;\r\n  #\r\n  connection.execute(<<~SQL)\r\n    ALTER TABLE payments CONVERT TO CHARACTER SET utf32\r\n  SQL\r\n\r\n  def change\r\n    reversible do |dir|\r\n      dir.up do\r\n        change_table(:payments, bulk: true) do |t|\r\n          # The default collation of utf32_general_ci\r\n          # will not be compatible with this ascii character set. \r\n          #\r\n          # when we build the column change now we automatically\r\n          # try to assign the previous collation to the column if no `collation:` is specified.\r\n          # \r\n          # https://github.com/rails/rails/pull/45744\r\n          #\r\n          # The workaround is to add `collation: 'ascii_bin'` or `collation: 'ascii_general_ci'` to the change.\r\n          #\r\n          # This isn't a huge deal and it has a workaround but it _will_ break\r\n          # anyone who has migrations that are written like this and upgrade to this version\r\n          # of Rails.\r\n          t.change :description, \"varchar(64) CHARACTER SET ascii\", null: false\r\n        end\r\n      end\r\n\r\n      dir.down do\r\n        change_table(:payments, bulk: true) do |t|\r\n          t.change :description, \"varchar(64)\", null: false\r\n        end\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    ChangeAmountToAddScale.migrate(:up)\r\n    Payment.reset_column_information\r\n\r\n    assert_equal \"varchar\", Payment.columns.last.sql_type\r\n  end\r\n\r\n  def test_migration_down\r\n    ChangeAmountToAddScale.migrate(:down)\r\n    Payment.reset_column_information\r\n\r\n    assert_equal \"varchar\", Payment.columns.last.sql_type\r\n  end\r\nend\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nI would expect this to detect that the character set is being changed, and either \r\n\r\n1. change the collation to be compatible.\r\n2. At least give a clearer error that requires the `collation:` arg to be passed when the character set is being modified.\r\n\r\n### Actual behavior\r\n\r\nThis error:\r\n\r\n```\r\nError:\r\nBugTest#test_migration_up:\r\nActiveRecord::StatementInvalid: Mysql2::Error: COLLATION 'utf32_general_ci' is not valid for CHARACTER SET 'ascii'\r\n    test.rb:51:in `block (2 levels) in change'\r\n    test.rb:50:in `block in change'\r\n    test.rb:49:in `change'\r\n    test.rb:67:in `test_migration_up'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main\r\n**Ruby version**: ruby 3.1.1p18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45823/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45823/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45822","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45822/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45822/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45822/events","html_url":"https://github.com/rails/rails/issues/45822","id":1337253221,"node_id":"I_kwDNIULOT7TdZQ","number":45822,"title":"ActiveRecord: Wrong results returned by ActiveRecord::Associations::Preloader when intermediate association is already preloaded.","user":{"login":"yopzer","id":6330271,"node_id":"MDQ6VXNlcjYzMzAyNzE=","avatar_url":"https://avatars.githubusercontent.com/u/6330271?v=4","gravatar_id":"","url":"https://api.github.com/users/yopzer","html_url":"https://github.com/yopzer","followers_url":"https://api.github.com/users/yopzer/followers","following_url":"https://api.github.com/users/yopzer/following{/other_user}","gists_url":"https://api.github.com/users/yopzer/gists{/gist_id}","starred_url":"https://api.github.com/users/yopzer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yopzer/subscriptions","organizations_url":"https://api.github.com/users/yopzer/orgs","repos_url":"https://api.github.com/users/yopzer/repos","events_url":"https://api.github.com/users/yopzer/events{/privacy}","received_events_url":"https://api.github.com/users/yopzer/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"jhawthorn","id":131752,"node_id":"MDQ6VXNlcjEzMTc1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/131752?v=4","gravatar_id":"","url":"https://api.github.com/users/jhawthorn","html_url":"https://github.com/jhawthorn","followers_url":"https://api.github.com/users/jhawthorn/followers","following_url":"https://api.github.com/users/jhawthorn/following{/other_user}","gists_url":"https://api.github.com/users/jhawthorn/gists{/gist_id}","starred_url":"https://api.github.com/users/jhawthorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhawthorn/subscriptions","organizations_url":"https://api.github.com/users/jhawthorn/orgs","repos_url":"https://api.github.com/users/jhawthorn/repos","events_url":"https://api.github.com/users/jhawthorn/events{/privacy}","received_events_url":"https://api.github.com/users/jhawthorn/received_events","type":"User","site_admin":true},"assignees":[{"login":"jhawthorn","id":131752,"node_id":"MDQ6VXNlcjEzMTc1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/131752?v=4","gravatar_id":"","url":"https://api.github.com/users/jhawthorn","html_url":"https://github.com/jhawthorn","followers_url":"https://api.github.com/users/jhawthorn/followers","following_url":"https://api.github.com/users/jhawthorn/following{/other_user}","gists_url":"https://api.github.com/users/jhawthorn/gists{/gist_id}","starred_url":"https://api.github.com/users/jhawthorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhawthorn/subscriptions","organizations_url":"https://api.github.com/users/jhawthorn/orgs","repos_url":"https://api.github.com/users/jhawthorn/repos","events_url":"https://api.github.com/users/jhawthorn/events{/privacy}","received_events_url":"https://api.github.com/users/jhawthorn/received_events","type":"User","site_admin":true}],"milestone":null,"comments":1,"created_at":"2022-08-12T14:06:55Z","updated_at":"2022-08-18T23:36:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activerecord\", \"7.0.3.1\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :a_records, force: true\r\n\r\n  create_table :b_records, force: true do |t|\r\n    t.references :a_record\r\n    t.references :c_record\r\n  end\r\n\r\n  create_table :c_records, force: true\r\n\r\n  create_table :d_records, force: true do |t|\r\n    t.references :c_record\r\n  end\r\nend\r\n\r\nclass ARecord < ActiveRecord::Base\r\n  has_one :b_record\r\n  has_one :c_record, through: :b_record\r\n  has_many :d_records, through: :c_record\r\nend\r\n\r\nclass BRecord < ActiveRecord::Base\r\n  belongs_to :a_record\r\n  belongs_to :c_record\r\nend\r\n\r\nclass CRecord < ActiveRecord::Base\r\n  has_one :b_record\r\n  has_many :d_records\r\nend\r\n\r\nclass DRecord < ActiveRecord::Base\r\n  belongs_to :c_record\r\nend\r\n\r\na = ARecord.create!\r\nc = CRecord.create!\r\nBRecord.create!(a_record: a, c_record: c)\r\nDRecord.create!(c_record: c)\r\nDRecord.create!(c_record: c)\r\n\r\na.reload\r\na.c_record # NB: if removed this works\r\n\r\n::ActiveRecord::Associations::Preloader.new(records: [a], associations: :d_records).call\r\nputs({ record_ids: a.d_records.map(&:id), size: a.d_records.size })\r\n```\r\n\r\n### Expected behavior\r\nTwo records should be loaded:\r\n`{:record_ids=>[1, 2], :size=>2}`\r\n\r\n### Actual behavior\r\nNo records are loaded:\r\n`{:record_ids=>[], :size=>0}`\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45822/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45822/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45821","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45821/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45821/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45821/events","html_url":"https://github.com/rails/rails/issues/45821","id":1336949359,"node_id":"I_kwDNIULOT7A6bw","number":45821,"title":"ActiveRecord \"endless\" range for >=, =<, < but not >","user":{"login":"olegantonyan","id":2301579,"node_id":"MDQ6VXNlcjIzMDE1Nzk=","avatar_url":"https://avatars.githubusercontent.com/u/2301579?v=4","gravatar_id":"","url":"https://api.github.com/users/olegantonyan","html_url":"https://github.com/olegantonyan","followers_url":"https://api.github.com/users/olegantonyan/followers","following_url":"https://api.github.com/users/olegantonyan/following{/other_user}","gists_url":"https://api.github.com/users/olegantonyan/gists{/gist_id}","starred_url":"https://api.github.com/users/olegantonyan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olegantonyan/subscriptions","organizations_url":"https://api.github.com/users/olegantonyan/orgs","repos_url":"https://api.github.com/users/olegantonyan/repos","events_url":"https://api.github.com/users/olegantonyan/events{/privacy}","received_events_url":"https://api.github.com/users/olegantonyan/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-12T09:07:09Z","updated_at":"2022-08-24T18:34:52Z","closed_at":"2022-08-24T18:34:52Z","author_association":"NONE","active_lock_reason":null,"body":"This is not a bug, but more like question/suggestion.\r\n\r\nActiveRecord support endless ranges in queries, for example:\r\n```\r\nUser.where(created_at: ..2.years.ago).to_sql\r\n#=> SELECT `users`.* FROM `users` WHERE `users`.`created_at` <= '2020-08-12 08:57:08'\r\n```\r\n`>=` possible too\r\n```\r\nUser.where(created_at: 2.years.ago..).to_sql\r\n#=> SELECT `users`.* FROM `users` WHERE `users`.`created_at` >= '2020-08-12 08:57:56'\r\n```\r\nAlso works with non-inclusive ranges as `<`\r\n```\r\nUser.where(created_at: ...2.years.ago).to_sql\r\n#=> SELECT `users`.* FROM `users` WHERE `users`.`created_at` < '2020-08-12 08:59:06'\r\n```\r\nBut not `>`\r\n```\r\nUser.where(created_at: 2.years.ago...).to_sql\r\n#=> SELECT `users`.* FROM `users` WHERE `users`.`created_at` >= '2020-08-12 09:00:15'\r\n```\r\n\r\nThis makes sense from range's perspective b/c left value of a range is always included. But considering examples above I'd expect `whatever...` to mean `strictly greater than whatever` b/c it makes sense in this context and only this context.\r\n\r\nThis range syntax is great b/c otherwise you need to write condition as sql string (`where(\"created_at <= ?\", whatever)`), and when you do this you also have to put table name (`where(\"users.created_at <= ?\", whatever)`), otherwise you risk running into db errors when joining with another table with the same column.\r\n\r\n**Rails version**: 7.0.3.1\r\n**Ruby version**: 3.2.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45821/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45821/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45817","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45817/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45817/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45817/events","html_url":"https://github.com/rails/rails/issues/45817","id":1336797388,"node_id":"I_kwDNIULOT63ozA","number":45817,"title":"Value of attribute default proc is shared between instances after dup + dirty tracking","user":{"login":"quadule","id":15299,"node_id":"MDQ6VXNlcjE1Mjk5","avatar_url":"https://avatars.githubusercontent.com/u/15299?v=4","gravatar_id":"","url":"https://api.github.com/users/quadule","html_url":"https://github.com/quadule","followers_url":"https://api.github.com/users/quadule/followers","following_url":"https://api.github.com/users/quadule/following{/other_user}","gists_url":"https://api.github.com/users/quadule/gists{/gist_id}","starred_url":"https://api.github.com/users/quadule/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quadule/subscriptions","organizations_url":"https://api.github.com/users/quadule/orgs","repos_url":"https://api.github.com/users/quadule/repos","events_url":"https://api.github.com/users/quadule/events{/privacy}","received_events_url":"https://api.github.com/users/quadule/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-12T06:16:00Z","updated_at":"2022-08-15T15:56:11Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhen an attribute without a database column defines a default proc, `dup`ing a model in which the default wasn't accessed passes the unevaluated `UserProvidedDefault` attribute to the new instance as the attribute's original value. Checking the new attribute for changes will then memoize the value in the original attribute definition, making it the default value in every new model instance afterward.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n  gem \"rails\", github: \"rails/rails\", ref: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Schema.define do\r\n  create_table :cats do |t|\r\n    t.string :name\r\n  end\r\nend\r\n\r\nclass Cat < ActiveRecord::Base\r\n  attribute :sounds, default: -> { [] }\r\nend\r\n\r\nclass VirtualAttributeTest < Minitest::Test\r\n  def test_virtual_attribute_defaults_are_independent\r\n    Cat.new.dup.save!\r\n    Cat.new.sounds << \"meow\"\r\n    refute_same Cat.new.sounds, Cat.new.sounds\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nEach new instance should get a new default value from the proc.\r\n\r\n### Actual behavior\r\nAfter using dirty tracking on a duplicated instance with an uncalled proc default, all new instances of a model receive the same default value and share any changes made to it.\r\n\r\n### Affected versions\r\nThis seems to date back quite a while; the test fails on the main branch back to 5-1-stable.\r\n\r\n### Credits\r\nThanks to @GBH for originally discovering this bug.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45817/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45817/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45816","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45816/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45816/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45816/events","html_url":"https://github.com/rails/rails/issues/45816","id":1336782839,"node_id":"I_kwDNIULOT62v9w","number":45816,"title":" ruby 3.1.1- cannot load such file -- net/ftp (LoadError)","user":{"login":"artisr","id":1955809,"node_id":"MDQ6VXNlcjE5NTU4MDk=","avatar_url":"https://avatars.githubusercontent.com/u/1955809?v=4","gravatar_id":"","url":"https://api.github.com/users/artisr","html_url":"https://github.com/artisr","followers_url":"https://api.github.com/users/artisr/followers","following_url":"https://api.github.com/users/artisr/following{/other_user}","gists_url":"https://api.github.com/users/artisr/gists{/gist_id}","starred_url":"https://api.github.com/users/artisr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/artisr/subscriptions","organizations_url":"https://api.github.com/users/artisr/orgs","repos_url":"https://api.github.com/users/artisr/repos","events_url":"https://api.github.com/users/artisr/events{/privacy}","received_events_url":"https://api.github.com/users/artisr/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-12T05:53:23Z","updated_at":"2022-08-12T19:46:13Z","closed_at":"2022-08-12T19:46:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrvm use 3.1.1\r\ngem install rails\r\nrails new testapp\r\ncd testapp\r\nrails c\r\nrequire 'net/ftp'\r\n```\r\n\r\n### Expected behavior\r\n=> true \r\n\r\n### Actual behavior\r\n`require': cannot load such file -- net/ftp (LoadError)\r\n\r\n### System configuration\r\n**Rails version**:\r\nrails (7.0.3.1)\r\n\r\n**Ruby version**:\r\nruby-3.1.1\r\n\r\n\r\nI tested and have this issue on ruby 3.1.0, 3.1.1, 3.1.2 running on m1\r\nOn ruby 3.0.4 I dont have this issue.\r\n\r\nI also tested this on fresh debian 11 vps\r\n\r\n```\r\nLinux 172-105-130-168 5.10.0-16-amd64 #1 SMP Debian 5.10.127-1 (2022-06-30) x86_64\r\n\r\nThe programs included with the Debian GNU/Linux system are free software;\r\nthe exact distribution terms for each program are described in the\r\nindividual files in /usr/share/doc/*/copyright.\r\n\r\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\r\npermitted by applicable law.\r\n_____________________________________________________________________\r\nWARNING! Your environment specifies an invalid locale.\r\n The unknown environment variables are:\r\n   LC_CTYPE=UTF-8 LC_ALL=\r\n This can affect your user experience significantly, including the\r\n ability to manage packages. You may install the locales by running:\r\n\r\n sudo dpkg-reconfigure locales\r\n\r\n and select the missing language. Alternatively, you can install the\r\n locales-all package:\r\n\r\n sudo apt-get install locales-all\r\n\r\nTo disable this message for all users, run:\r\n   sudo touch /var/lib/cloud/instance/locale-check.skip\r\n_____________________________________________________________________\r\n\r\nroot@172-105-130-168:~# curl -sSL https://get.rvm.io | bash -s stable\r\nDownloading https://github.com/rvm/rvm/archive/1.29.12.tar.gz\r\nDownloading https://github.com/rvm/rvm/releases/download/1.29.12/1.29.12.tar.gz.asc\r\nFound PGP signature at: 'https://github.com/rvm/rvm/releases/download/1.29.12/1.29.12.tar.gz.asc',\r\nbut no GPG software exists to validate it, skipping.\r\nCreating group 'rvm'\r\nInstalling RVM to /usr/local/rvm/\r\nInstallation of RVM in /usr/local/rvm/ is almost complete:\r\n\r\n  * First you need to add all users that will be using rvm to 'rvm' group,\r\n    and logout - login again, anyone using rvm will be operating with `umask u=rwx,g=rwx,o=rx`.\r\n\r\n  * To start using RVM you need to run `source /etc/profile.d/rvm.sh`\r\n    in all your open shell windows, in rare cases you need to reopen all shell windows.\r\n  * Please do NOT forget to add your users to the rvm group.\r\n     The installer no longer auto-adds root or users to the rvm group. Admins must do this.\r\n     Also, please note that group memberships are ONLY evaluated at login time.\r\n     This means that users must log out then back in before group membership takes effect!\r\nThanks for installing RVM 🙏\r\nPlease consider donating to our open collective to help us maintain RVM.\r\n\r\n👉  Donate: https://opencollective.com/rvm/donate\r\n\r\n\r\nroot@172-105-130-168:~# source /etc/profile.d/rvm.sh\r\nroot@172-105-130-168:~# rvm install 3.1.1\r\nSearching for binary rubies, this might take some time.\r\nNo binary rubies available for: debian/11/x86_64/ruby-3.1.1.\r\nContinuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.\r\nChecking requirements for debian.\r\nInstalling requirements for debian.\r\nUpdating system...\r\nInstalling required packages: patch, bzip2, gawk, g++, gcc, autoconf, automake, bison, libc6-dev, libffi-dev, libgdbm-dev, libncurses5-dev, libsqlite3-dev, libtool, libyaml-dev, make, patch, pkg-config, sqlite3, zlib1g-dev, libgmp-dev, libreadline-dev, libssl-dev.....................................\r\nRequirements installation successful.\r\nInstalling Ruby from source to: /usr/local/rvm/rubies/ruby-3.1.1, this may take a while depending on your cpu(s)...\r\nruby-3.1.1 - #downloading ruby-3.1.1, this may take a while depending on your connection...\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100 19.6M  100 19.6M    0     0  48.6M      0 --:--:-- --:--:-- --:--:-- 48.6M\r\nNo checksum for downloaded archive, recording checksum in user configuration.\r\nruby-3.1.1 - #extracting ruby-3.1.1 to /usr/local/rvm/src/ruby-3.1.1.....\r\nruby-3.1.1 - #configuring..........................................................................\r\nruby-3.1.1 - #post-configuration..\r\nruby-3.1.1 - #compiling.............................................................................................\r\nruby-3.1.1 - #installing.....................\r\nruby-3.1.1 - #making binaries executable...\r\nInstalled rubygems 3.3.7 is newer than 3.0.9 provided with installed ruby, skipping installation, use --force to force installation.\r\nruby-3.1.1 - #gemset created /usr/local/rvm/gems/ruby-3.1.1@global\r\nruby-3.1.1 - #importing gemset /usr/local/rvm/gemsets/global.gems..........................................................\r\nruby-3.1.1 - #generating global wrappers........\r\nruby-3.1.1 - #gemset created /usr/local/rvm/gems/ruby-3.1.1\r\nruby-3.1.1 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems evaluated to empty gem list\r\nruby-3.1.1 - #generating default wrappers........\r\nruby-3.1.1 - #adjusting #shebangs for (gem irb erb ri rdoc testrb rake).\r\nInstall of ruby-3.1.1 - #complete \r\nRuby was built without documentation, to build it run: rvm docs generate-ri\r\nroot@172-105-130-168:~# apt-get install git\r\nReading package lists... Done\r\nBuilding dependency tree... Done\r\nReading state information... Done\r\nThe following additional packages will be installed:\r\n  git-man liberror-perl\r\nSuggested packages:\r\n  git-daemon-run | git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-cvs git-mediawiki git-svn\r\nThe following NEW packages will be installed:\r\n  git git-man liberror-perl\r\n0 upgraded, 3 newly installed, 0 to remove and 6 not upgraded.\r\nNeed to get 7386 kB of archives.\r\nAfter this operation, 37.9 MB of additional disk space will be used.\r\nDo you want to continue? [Y/n] y\r\nGet:1 http://mirrors.linode.com/debian bullseye/main amd64 liberror-perl all 0.17029-1 [31.0 kB]\r\nGet:2 http://mirrors.linode.com/debian bullseye/main amd64 git-man all 1:2.30.2-1 [1827 kB]\r\nGet:3 http://mirrors.linode.com/debian bullseye/main amd64 git amd64 1:2.30.2-1 [5527 kB]\r\nFetched 7386 kB in 0s (152 MB/s)\r\nperl: warning: Setting locale failed.\r\nperl: warning: Please check that your locale settings:\r\n\tLANGUAGE = (unset),\r\n\tLC_ALL = (unset),\r\n\tLC_CTYPE = \"UTF-8\",\r\n\tLANG = \"en_US.UTF-8\"\r\n    are supported and installed on your system.\r\nperl: warning: Falling back to a fallback locale (\"en_US.UTF-8\").\r\nlocale: Cannot set LC_CTYPE to default locale: No such file or directory\r\nlocale: Cannot set LC_ALL to default locale: No such file or directory\r\nSelecting previously unselected package liberror-perl.\r\n(Reading database ... 35298 files and directories currently installed.)\r\nPreparing to unpack .../liberror-perl_0.17029-1_all.deb ...\r\nUnpacking liberror-perl (0.17029-1) ...\r\nSelecting previously unselected package git-man.\r\nPreparing to unpack .../git-man_1%3a2.30.2-1_all.deb ...\r\nUnpacking git-man (1:2.30.2-1) ...\r\nSelecting previously unselected package git.\r\nPreparing to unpack .../git_1%3a2.30.2-1_amd64.deb ...\r\nUnpacking git (1:2.30.2-1) ...\r\nSetting up liberror-perl (0.17029-1) ...\r\nSetting up git-man (1:2.30.2-1) ...\r\nSetting up git (1:2.30.2-1) ...\r\nProcessing triggers for man-db (2.9.4-2) ...\r\nroot@172-105-130-168:~# gem install rails --no-document\r\nFetching tzinfo-2.0.5.gem\r\nFetching concurrent-ruby-1.1.10.gem\r\nFetching zeitwerk-2.6.0.gem\r\nFetching method_source-1.0.0.gem\r\nFetching crass-1.0.6.gem\r\nFetching activesupport-7.0.3.1.gem\r\nFetching loofah-2.18.0.gem\r\nFetching i18n-1.12.0.gem\r\nFetching thor-1.2.1.gem\r\nFetching nokogiri-1.13.8-x86_64-linux.gem\r\nFetching rails-html-sanitizer-1.4.3.gem\r\nFetching rails-dom-testing-2.0.3.gem\r\nFetching rack-2.2.4.gem\r\nFetching rack-test-2.0.2.gem\r\nFetching erubi-1.11.0.gem\r\nFetching builder-3.2.4.gem\r\nFetching actionview-7.0.3.1.gem\r\nFetching actionpack-7.0.3.1.gem\r\nFetching railties-7.0.3.1.gem\r\nFetching mini_mime-1.1.2.gem\r\nFetching marcel-1.0.2.gem\r\nFetching activemodel-7.0.3.1.gem\r\nFetching activerecord-7.0.3.1.gem\r\nFetching globalid-1.0.0.gem\r\nFetching activejob-7.0.3.1.gem\r\nFetching activestorage-7.0.3.1.gem\r\nFetching actiontext-7.0.3.1.gem\r\nFetching mail-2.7.1.gem\r\nFetching actionmailer-7.0.3.1.gem\r\nFetching actionmailbox-7.0.3.1.gem\r\nFetching websocket-extensions-0.1.5.gem\r\nFetching websocket-driver-0.7.5.gem\r\nFetching rails-7.0.3.1.gem\r\nFetching nio4r-2.5.8.gem\r\nFetching actioncable-7.0.3.1.gem\r\nSuccessfully installed zeitwerk-2.6.0\r\nSuccessfully installed thor-1.2.1\r\nSuccessfully installed method_source-1.0.0\r\nSuccessfully installed concurrent-ruby-1.1.10\r\nSuccessfully installed tzinfo-2.0.5\r\nSuccessfully installed i18n-1.12.0\r\nSuccessfully installed activesupport-7.0.3.1\r\nSuccessfully installed nokogiri-1.13.8-x86_64-linux\r\nSuccessfully installed crass-1.0.6\r\nSuccessfully installed loofah-2.18.0\r\nSuccessfully installed rails-html-sanitizer-1.4.3\r\nSuccessfully installed rails-dom-testing-2.0.3\r\nSuccessfully installed rack-2.2.4\r\nSuccessfully installed rack-test-2.0.2\r\nSuccessfully installed erubi-1.11.0\r\nSuccessfully installed builder-3.2.4\r\nSuccessfully installed actionview-7.0.3.1\r\nSuccessfully installed actionpack-7.0.3.1\r\nSuccessfully installed railties-7.0.3.1\r\nSuccessfully installed mini_mime-1.1.2\r\nSuccessfully installed marcel-1.0.2\r\nSuccessfully installed activemodel-7.0.3.1\r\nSuccessfully installed activerecord-7.0.3.1\r\nSuccessfully installed globalid-1.0.0\r\nSuccessfully installed activejob-7.0.3.1\r\nSuccessfully installed activestorage-7.0.3.1\r\nSuccessfully installed actiontext-7.0.3.1\r\nSuccessfully installed mail-2.7.1\r\nSuccessfully installed actionmailer-7.0.3.1\r\nSuccessfully installed actionmailbox-7.0.3.1\r\nSuccessfully installed websocket-extensions-0.1.5\r\nBuilding native extensions. This could take a while...\r\nSuccessfully installed websocket-driver-0.7.5\r\nBuilding native extensions. This could take a while...\r\nSuccessfully installed nio4r-2.5.8\r\nSuccessfully installed actioncable-7.0.3.1\r\nSuccessfully installed rails-7.0.3.1\r\n35 gems installed\r\nroot@172-105-130-168:~# rails new testapp\r\n      create  \r\n      create  README.md\r\n      create  Rakefile\r\n      create  .ruby-version\r\n      create  config.ru\r\n      create  .gitignore\r\n      create  .gitattributes\r\n      create  Gemfile\r\n         run  git init from \".\"\r\nhint: Using 'master' as the name for the initial branch. This default branch name\r\nhint: is subject to change. To configure the initial branch name to use in all\r\nhint: of your new repositories, which will suppress this warning, call:\r\nhint: \r\nhint: \tgit config --global init.defaultBranch <name>\r\nhint: \r\nhint: Names commonly chosen instead of 'master' are 'main', 'trunk' and\r\nhint: 'development'. The just-created branch can be renamed via this command:\r\nhint: \r\nhint: \tgit branch -m <name>\r\nInitialized empty Git repository in /root/testapp/.git/\r\n      create  app\r\n      create  app/assets/config/manifest.js\r\n      create  app/assets/stylesheets/application.css\r\n      create  app/channels/application_cable/channel.rb\r\n      create  app/channels/application_cable/connection.rb\r\n      create  app/controllers/application_controller.rb\r\n      create  app/helpers/application_helper.rb\r\n      create  app/jobs/application_job.rb\r\n      create  app/mailers/application_mailer.rb\r\n      create  app/models/application_record.rb\r\n      create  app/views/layouts/application.html.erb\r\n      create  app/views/layouts/mailer.html.erb\r\n      create  app/views/layouts/mailer.text.erb\r\n      create  app/assets/images\r\n      create  app/assets/images/.keep\r\n      create  app/controllers/concerns/.keep\r\n      create  app/models/concerns/.keep\r\n      create  bin\r\n      create  bin/rails\r\n      create  bin/rake\r\n      create  bin/setup\r\n      create  config\r\n      create  config/routes.rb\r\n      create  config/application.rb\r\n      create  config/environment.rb\r\n      create  config/cable.yml\r\n      create  config/puma.rb\r\n      create  config/storage.yml\r\n      create  config/environments\r\n      create  config/environments/development.rb\r\n      create  config/environments/production.rb\r\n      create  config/environments/test.rb\r\n      create  config/initializers\r\n      create  config/initializers/assets.rb\r\n      create  config/initializers/content_security_policy.rb\r\n      create  config/initializers/cors.rb\r\n      create  config/initializers/filter_parameter_logging.rb\r\n      create  config/initializers/inflections.rb\r\n      create  config/initializers/new_framework_defaults_7_0.rb\r\n      create  config/initializers/permissions_policy.rb\r\n      create  config/locales\r\n      create  config/locales/en.yml\r\n      create  config/master.key\r\n      append  .gitignore\r\n      create  config/boot.rb\r\n      create  config/database.yml\r\n      create  db\r\n      create  db/seeds.rb\r\n      create  lib\r\n      create  lib/tasks\r\n      create  lib/tasks/.keep\r\n      create  lib/assets\r\n      create  lib/assets/.keep\r\n      create  log\r\n      create  log/.keep\r\n      create  public\r\n      create  public/404.html\r\n      create  public/422.html\r\n      create  public/500.html\r\n      create  public/apple-touch-icon-precomposed.png\r\n      create  public/apple-touch-icon.png\r\n      create  public/favicon.ico\r\n      create  public/robots.txt\r\n      create  tmp\r\n      create  tmp/.keep\r\n      create  tmp/pids\r\n      create  tmp/pids/.keep\r\n      create  tmp/cache\r\n      create  tmp/cache/assets\r\n      create  vendor\r\n      create  vendor/.keep\r\n      create  test/fixtures/files\r\n      create  test/fixtures/files/.keep\r\n      create  test/controllers\r\n      create  test/controllers/.keep\r\n      create  test/mailers\r\n      create  test/mailers/.keep\r\n      create  test/models\r\n      create  test/models/.keep\r\n      create  test/helpers\r\n      create  test/helpers/.keep\r\n      create  test/integration\r\n      create  test/integration/.keep\r\n      create  test/channels/application_cable/connection_test.rb\r\n      create  test/test_helper.rb\r\n      create  test/system\r\n      create  test/system/.keep\r\n      create  test/application_system_test_case.rb\r\n      create  storage\r\n      create  storage/.keep\r\n      create  tmp/storage\r\n      create  tmp/storage/.keep\r\n      remove  config/initializers/cors.rb\r\n      remove  config/initializers/new_framework_defaults_7_0.rb\r\n         run  bundle install\r\nDon't run Bundler as root. Bundler can ask for sudo if it is needed, and installing your bundle as root will break this application for all non-root users on this machine.\r\nFetching gem metadata from https://rubygems.org/...........\r\nResolving dependencies.....\r\nUsing rake 13.0.6\r\nUsing concurrent-ruby 1.1.10\r\nFetching minitest 5.16.2\r\nUsing builder 3.2.4\r\nUsing bundler 2.3.7\r\nUsing matrix 0.4.2\r\nFetching regexp_parser 2.5.0\r\nUsing rack 2.2.4\r\nFetching childprocess 4.1.0\r\nUsing crass 1.0.6\r\nUsing io-console 0.5.11\r\nUsing method_source 1.0.0\r\nUsing thor 1.2.1\r\nUsing zeitwerk 2.6.0\r\nUsing rexml 3.2.5\r\nFetching rubyzip 2.3.2\r\nUsing marcel 1.0.2\r\nFetching strscan 3.0.4\r\nFetching websocket 1.2.9\r\nUsing racc 1.6.0\r\nInstalling minitest 5.16.2\r\nUsing websocket-extensions 0.1.5\r\nUsing nio4r 2.5.8\r\nInstalling strscan 3.0.4 with native extensions\r\nUsing erubi 1.11.0\r\nFetching timeout 0.3.0\r\nFetching public_suffix 4.0.7\r\nFetching bindex 0.8.1\r\nFetching msgpack 1.5.4\r\nUsing rack-test 2.0.2\r\nFetching sprockets 4.1.1\r\nInstalling rubyzip 2.3.2\r\nUsing mini_mime 1.1.2\r\nFetching reline 0.3.1\r\nUsing i18n 1.12.0\r\nUsing nokogiri 1.13.8 (x86_64-linux)\r\nUsing websocket-driver 0.7.5\r\nInstalling childprocess 4.1.0\r\nInstalling regexp_parser 2.5.0\r\nUsing digest 3.1.0\r\nUsing mail 2.7.1\r\nUsing loofah 2.18.0\r\nFetching xpath 3.2.0\r\nInstalling timeout 0.3.0\r\nFetching puma 5.6.4\r\nInstalling sprockets 4.1.1\r\nInstalling bindex 0.8.1 with native extensions\r\nInstalling reline 0.3.1\r\nInstalling public_suffix 4.0.7\r\nInstalling msgpack 1.5.4 with native extensions\r\nInstalling xpath 3.2.0\r\nUsing tzinfo 2.0.5\r\nFetching net-protocol 0.1.3\r\nUsing rails-html-sanitizer 1.4.3\r\nFetching sqlite3 1.4.4\r\nInstalling websocket 1.2.9\r\nInstalling puma 5.6.4 with native extensions\r\nInstalling sqlite3 1.4.4 with native extensions\r\nUsing irb 1.4.1\r\nInstalling net-protocol 0.1.3\r\nFetching debug 1.6.2\r\nInstalling debug 1.6.2 with native extensions\r\nUsing net-pop 0.1.1\r\nUsing net-smtp 0.3.1\r\nUsing activesupport 7.0.3.1\r\nUsing rails-dom-testing 2.0.3\r\nUsing globalid 1.0.0\r\nUsing activemodel 7.0.3.1\r\nUsing activejob 7.0.3.1\r\nUsing actionview 7.0.3.1\r\nUsing activerecord 7.0.3.1\r\nUsing actionpack 7.0.3.1\r\nFetching jbuilder 2.11.5\r\nUsing actioncable 7.0.3.1\r\nUsing activestorage 7.0.3.1\r\nUsing railties 7.0.3.1\r\nFetching selenium-webdriver 4.4.0\r\nFetching sprockets-rails 3.4.2\r\nUsing actiontext 7.0.3.1\r\nFetching importmap-rails 1.1.5\r\nFetching stimulus-rails 1.1.0\r\nFetching turbo-rails 1.1.1\r\nFetching addressable 2.8.0\r\nInstalling stimulus-rails 1.1.0\r\nInstalling sprockets-rails 3.4.2\r\nInstalling turbo-rails 1.1.1\r\nInstalling jbuilder 2.11.5\r\nInstalling addressable 2.8.0\r\nInstalling selenium-webdriver 4.4.0\r\nInstalling importmap-rails 1.1.5\r\nFetching capybara 3.37.1\r\nFetching web-console 4.2.0\r\nInstalling web-console 4.2.0\r\nInstalling capybara 3.37.1\r\nFetching webdrivers 5.0.0\r\nInstalling webdrivers 5.0.0\r\nUsing net-imap 0.2.3\r\nUsing actionmailbox 7.0.3.1\r\nUsing actionmailer 7.0.3.1\r\nUsing rails 7.0.3.1\r\nFetching bootsnap 1.13.0\r\nInstalling bootsnap 1.13.0 with native extensions\r\nBundle complete! 15 Gemfile dependencies, 74 gems now installed.\r\nUse `bundle info [gemname]` to see where a bundled gem is installed.\r\n         run  bundle binstubs bundler\r\n       rails  importmap:install\r\nAdd Importmap include tags in application layout\r\n      insert  app/views/layouts/application.html.erb\r\nCreate application.js module as entrypoint\r\n      create  app/javascript/application.js\r\nUse vendor/javascript for downloaded pins\r\n      create  vendor/javascript\r\n      create  vendor/javascript/.keep\r\nEnsure JavaScript files are in the Sprocket manifest\r\n      append  app/assets/config/manifest.js\r\nConfigure importmap paths in config/importmap.rb\r\n      create  config/importmap.rb\r\nCopying binstub\r\n      create  bin/importmap\r\n       rails  turbo:install stimulus:install\r\nImport Turbo\r\n      append  app/javascript/application.js\r\nPin Turbo\r\n      append  config/importmap.rb\r\nRun turbo:install:redis to switch on Redis and use it in development for turbo streams\r\nCreate controllers directory\r\n      create  app/javascript/controllers\r\n      create  app/javascript/controllers/index.js\r\n      create  app/javascript/controllers/application.js\r\n      create  app/javascript/controllers/hello_controller.js\r\nImport Stimulus controllers\r\n      append  app/javascript/application.js\r\nPin Stimulus\r\nAppending: pin \"@hotwired/stimulus\", to: \"stimulus.min.js\", preload: true\"\r\n      append  config/importmap.rb\r\nAppending: pin \"@hotwired/stimulus-loading\", to: \"stimulus-loading.js\", preload: true\r\n      append  config/importmap.rb\r\nPin all controllers\r\nAppending: pin_all_from \"app/javascript/controllers\", under: \"controllers\"\r\n      append  config/importmap.rb\r\nroot@172-105-130-168:~# cd testapp/\r\nUsing /usr/local/rvm/gems/ruby-3.1.1\r\nroot@172-105-130-168:~/testapp# rails c\r\nLoading development environment (Rails 7.0.3.1)\r\n3.1.1 :001 > require 'net/ftp'\r\n/usr/local/rvm/gems/ruby-3.1.1/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:17:in `require': cannot load such file -- net/ftp (LoadError)\r\n```\r\n\r\nit loads fine from irb\r\n```\r\nroot@172-105-130-168:~/testapp# irb\r\n3.1.1 :001 > require 'net/ftp'\r\n => true \r\n3.1.1 :002 > exit\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45816/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45816/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45815","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45815/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45815/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45815/events","html_url":"https://github.com/rails/rails/issues/45815","id":1336760714,"node_id":"I_kwDNIULOT61Zig","number":45815,"title":"How to build a micro service using Ruby on Rails ?","user":{"login":"SanjayKumaR0007","id":108576367,"node_id":"U_kgDOBni-bw","avatar_url":"https://avatars.githubusercontent.com/u/108576367?v=4","gravatar_id":"","url":"https://api.github.com/users/SanjayKumaR0007","html_url":"https://github.com/SanjayKumaR0007","followers_url":"https://api.github.com/users/SanjayKumaR0007/followers","following_url":"https://api.github.com/users/SanjayKumaR0007/following{/other_user}","gists_url":"https://api.github.com/users/SanjayKumaR0007/gists{/gist_id}","starred_url":"https://api.github.com/users/SanjayKumaR0007/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SanjayKumaR0007/subscriptions","organizations_url":"https://api.github.com/users/SanjayKumaR0007/orgs","repos_url":"https://api.github.com/users/SanjayKumaR0007/repos","events_url":"https://api.github.com/users/SanjayKumaR0007/events{/privacy}","received_events_url":"https://api.github.com/users/SanjayKumaR0007/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-12T05:13:10Z","updated_at":"2022-08-12T13:46:35Z","closed_at":"2022-08-12T13:46:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45815/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45815/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45812","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45812/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45812/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45812/events","html_url":"https://github.com/rails/rails/issues/45812","id":1336467785,"node_id":"I_kwDNIULOT6jhSQ","number":45812,"title":"single-table inheritance mechanism failed to locate subclass","user":{"login":"holcomb1977","id":52258886,"node_id":"MDQ6VXNlcjUyMjU4ODg2","avatar_url":"https://avatars.githubusercontent.com/u/52258886?v=4","gravatar_id":"","url":"https://api.github.com/users/holcomb1977","html_url":"https://github.com/holcomb1977","followers_url":"https://api.github.com/users/holcomb1977/followers","following_url":"https://api.github.com/users/holcomb1977/following{/other_user}","gists_url":"https://api.github.com/users/holcomb1977/gists{/gist_id}","starred_url":"https://api.github.com/users/holcomb1977/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/holcomb1977/subscriptions","organizations_url":"https://api.github.com/users/holcomb1977/orgs","repos_url":"https://api.github.com/users/holcomb1977/repos","events_url":"https://api.github.com/users/holcomb1977/events{/privacy}","received_events_url":"https://api.github.com/users/holcomb1977/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-11T20:39:03Z","updated_at":"2022-08-12T14:32:48Z","closed_at":"2022-08-11T21:04:31Z","author_association":"NONE","active_lock_reason":null,"body":"Received the following error twice:\r\n\r\nThe single-table inheritance mechanism failed to locate the subclass: 'ForemanOpenscap::ComplianceStatus.' This error is raised because the column 'type' is reserved for storing the class in case of inheritance. Please rename this column if you didn't intend to be used for storing the inheritance class or overwrite HostStatus::Status.inheritance_column to use another column for that information.  \r\n\r\nI am not a linux guy, so any assistance on this error...in layman's terms...would be greatly appreciated.\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45812/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45812/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45809","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45809/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45809/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45809/events","html_url":"https://github.com/rails/rails/issues/45809","id":1336074609,"node_id":"I_kwDNIULOT6LhcQ","number":45809,"title":"Parallel tests & PG custom tsearch","user":{"login":"KevinBerthier","id":25929311,"node_id":"MDQ6VXNlcjI1OTI5MzEx","avatar_url":"https://avatars.githubusercontent.com/u/25929311?v=4","gravatar_id":"","url":"https://api.github.com/users/KevinBerthier","html_url":"https://github.com/KevinBerthier","followers_url":"https://api.github.com/users/KevinBerthier/followers","following_url":"https://api.github.com/users/KevinBerthier/following{/other_user}","gists_url":"https://api.github.com/users/KevinBerthier/gists{/gist_id}","starred_url":"https://api.github.com/users/KevinBerthier/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KevinBerthier/subscriptions","organizations_url":"https://api.github.com/users/KevinBerthier/orgs","repos_url":"https://api.github.com/users/KevinBerthier/repos","events_url":"https://api.github.com/users/KevinBerthier/events{/privacy}","received_events_url":"https://api.github.com/users/KevinBerthier/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-11T14:49:33Z","updated_at":"2022-08-11T15:08:02Z","closed_at":"2022-08-11T15:07:44Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nI have a custom tsearch config \r\nBefore running my tests I load the config : `RAILS_ENV=test rails pg_search:create_f_unaccent pg_search:recreate_text_search`\r\n\r\n```ruby\r\n    puts '-- create f_unaccent function'\r\n    ActiveRecord::Base.connection.execute <<~SQL.squish\r\n      CREATE EXTENSION IF NOT EXISTS unaccent;\r\n\r\n      CREATE OR REPLACE FUNCTION f_unaccent(text)\r\n        RETURNS text AS\r\n      $func$\r\n      SELECT public.unaccent('public.unaccent', $1)\r\n      $func$  LANGUAGE sql IMMUTABLE;\r\n    SQL\r\n\r\n    puts '-- create text search configuration'\r\n    puts '   -> create a french dictionary without stopwords'\r\n    puts '   -> link our thesaurus to our new dictionary'\r\n    puts '   -> link our synonyms dictionary to our new dictionary'\r\n    puts '   -> duplicate french configuration'\r\n    puts '   -> customize our new configuration'\r\n\r\n    ActiveRecord::Base.connection.execute <<~SQL.squish\r\n      CREATE TEXT SEARCH DICTIONARY public.french_codeur_stem (\r\n        TEMPLATE = pg_catalog.snowball,\r\n        LANGUAGE = 'french',\r\n        STOPWORDS = 'french_codeur'\r\n      );\r\n\r\n      CREATE TEXT SEARCH DICTIONARY public.tag_thesaurus (\r\n        TEMPLATE = pg_catalog.thesaurus,\r\n        DICTFILE = 'tag_thesaurus',\r\n        DICTIONARY = 'public.french_codeur_stem'\r\n      );\r\n\r\n      CREATE TEXT SEARCH DICTIONARY public.tag_synonyms (\r\n        TEMPLATE = pg_catalog.synonym,\r\n        SYNONYMS = 'tag_synonyms'\r\n      );\r\n\r\n      CREATE TEXT SEARCH CONFIGURATION public.french_codeur (\r\n        COPY = french\r\n      );\r\n\r\n      ALTER TEXT SEARCH CONFIGURATION public.french_codeur\r\n        ALTER MAPPING FOR asciiword, asciihword, hword_asciipart, word\r\n        WITH tag_thesaurus, tag_synonyms, french_codeur_stem;\r\n\r\n      ALTER TEXT SEARCH CONFIGURATION public.french_codeur\r\n        DROP MAPPING IF EXISTS FOR blank;\r\n\r\n      ALTER TEXT SEARCH CONFIGURATION public.french_codeur\r\n        ALTER MAPPING FOR file, host\r\n        WITH tag_thesaurus, simple;\r\n    SQL\r\n```\r\nIf I run my test without `parallelize(workers: :number_of_processors)` it runs OK. But with parallel tests it raises : \r\n```bash\r\nDRb::DRbRemoteError: PG::UndefinedObject: ERROR:  text search configuration \"french_codeur\" does not exist\r\nLINE 1: ...earch\" tsvector GENERATED ALWAYS AS ((to_tsvector('french_co...\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nParallel test should handle custom tsearch configs\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nforked databases don't seems to have access to my tsearch config\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45809/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45809/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45805","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45805/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45805/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45805/events","html_url":"https://github.com/rails/rails/issues/45805","id":1334890678,"node_id":"I_kwDNIULOT5DQtg","number":45805,"title":"Rails 7 weird `ActiveRecord::NoDatabaseError` during development","user":{"login":"masterkain","id":12844,"node_id":"MDQ6VXNlcjEyODQ0","avatar_url":"https://avatars.githubusercontent.com/u/12844?v=4","gravatar_id":"","url":"https://api.github.com/users/masterkain","html_url":"https://github.com/masterkain","followers_url":"https://api.github.com/users/masterkain/followers","following_url":"https://api.github.com/users/masterkain/following{/other_user}","gists_url":"https://api.github.com/users/masterkain/gists{/gist_id}","starred_url":"https://api.github.com/users/masterkain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/masterkain/subscriptions","organizations_url":"https://api.github.com/users/masterkain/orgs","repos_url":"https://api.github.com/users/masterkain/repos","events_url":"https://api.github.com/users/masterkain/events{/privacy}","received_events_url":"https://api.github.com/users/masterkain/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-10T16:36:17Z","updated_at":"2022-08-13T19:39:26Z","closed_at":"2022-08-10T20:15:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I have no idea how to consistently reproduce this but I have a pretty basic Rails 7.0.3.1 app, connected to a postgres.\r\n\r\noccasionally during normal development the database cannot be found, one or two browser refresh and the request goes through.\r\nit's the first time I've seen this. log doesn't say what it is issuing to the database to make it fail. database has nothing going on.\r\n\r\nedit: **I just noticed it can also happen at rails boot.**\r\n\r\nusing puma in multithreaded mode, relevant config:\r\n\r\n```ruby\r\nmax_threads_count = ENV.fetch('RAILS_MAX_THREADS') { 15 }\r\nmin_threads_count = ENV.fetch('RAILS_MIN_THREADS') { max_threads_count }\r\nthreads min_threads_count, max_threads_count\r\npreload_app!\r\nworkers ENV.fetch('WEB_CONCURRENCY') { 5 }\r\nbefore_fork { ActiveRecord::Base.connection_pool.disconnect! if defined?(ActiveRecord) }\r\non_worker_boot { ActiveRecord::Base.establish_connection if defined?(ActiveRecord) }\r\n```\r\n\r\nattached three requests in succession, first two fails, third goes through.\r\n\r\n```\r\nStarted GET \"/school_adoptions?q%5Bscholastic_year_eq%5D=2020\" for 192.168.144.1 at 2022-08-10 16:25:33 +0000\r\nProcessing by SchoolAdoptionsController#index as HTML\r\n  Parameters: {\"q\"=>{\"scholastic_year_eq\"=>\"2020\"}}\r\nCompleted 500 Internal Server Error in 23ms (Allocations: 2564)\r\n\r\nActiveRecord::NoDatabaseError (We could not find your database: opendata_development. Which can be found in the database configuration file located at config/database.yml.\r\n\r\nTo resolve this issue:\r\n\r\n- Did you create the database for this app, or delete it? You may need to create your database.\r\n- Has the database name changed? Check your database.yml config has the correct database name.\r\n\r\nTo create your database, run:\r\n\r\n        bin/rails db:create\r\n):\r\n\r\napp/models/school_adoption.rb:73:in `block in <class:SchoolAdoption>'\r\napp/controllers/application_controller.rb:6:in `load_menu_data'\r\nFinished \"/cable/\" [WebSocket] for 192.168.144.1 at 2022-08-10 16:25:34 +0000\r\nTurbo::StreamsChannel stopped streaming from hotwire-livereload\r\nFinished \"/cable/\" [WebSocket] for 192.168.144.1 at 2022-08-10 16:25:34 +0000\r\nHotwire::Livereload::ReloadChannel stopped streaming from hotwire-reload\r\n```\r\n\r\n```\r\nStarted GET \"/school_adoptions?q%5Bscholastic_year_eq%5D=2020\" for 192.168.144.1 at 2022-08-10 16:29:22 +0000\r\nProcessing by SchoolAdoptionsController#index as HTML\r\n  Parameters: {\"q\"=>{\"scholastic_year_eq\"=>\"2020\"}}\r\nCompleted 500 Internal Server Error in 15ms (Allocations: 2560)\r\n\r\nActiveRecord::NoDatabaseError (We could not find your database: opendata_development. Which can be found in the database configuration file located at config/database.yml.\r\n\r\nTo resolve this issue:\r\n\r\n- Did you create the database for this app, or delete it? You may need to create your database.\r\n- Has the database name changed? Check your database.yml config has the correct database name.\r\n\r\nTo create your database, run:\r\n\r\n        bin/rails db:create\r\n):\r\n\r\napp/controllers/application_controller.rb:6:in `load_menu_data'\r\n```\r\n\r\n```\r\nStarted GET \"/school_adoptions?q%5Bscholastic_year_eq%5D=2020\" for 192.168.144.1 at 2022-08-10 16:29:24 +0000\r\nProcessing by SchoolAdoptionsController#index as HTML\r\n  Parameters: {\"q\"=>{\"scholastic_year_eq\"=>\"2020\"}}\r\n  SchoolAdoption Count (5.5ms)  SELECT COUNT(*) FROM \"school_adoptions\" WHERE \"school_adoptions\".\"scholastic_year\" = 2019\r\n```\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45805/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45805/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45804","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45804/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45804/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45804/events","html_url":"https://github.com/rails/rails/issues/45804","id":1334597990,"node_id":"I_kwDNIULOT4xZZg","number":45804,"title":"`ActiveRecord::Associations::Preloader` ignores `available_records` when association has a scope","user":{"login":"tbuehlmann","id":77664,"node_id":"MDQ6VXNlcjc3NjY0","avatar_url":"https://avatars.githubusercontent.com/u/77664?v=4","gravatar_id":"","url":"https://api.github.com/users/tbuehlmann","html_url":"https://github.com/tbuehlmann","followers_url":"https://api.github.com/users/tbuehlmann/followers","following_url":"https://api.github.com/users/tbuehlmann/following{/other_user}","gists_url":"https://api.github.com/users/tbuehlmann/gists{/gist_id}","starred_url":"https://api.github.com/users/tbuehlmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbuehlmann/subscriptions","organizations_url":"https://api.github.com/users/tbuehlmann/orgs","repos_url":"https://api.github.com/users/tbuehlmann/repos","events_url":"https://api.github.com/users/tbuehlmann/events{/privacy}","received_events_url":"https://api.github.com/users/tbuehlmann/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-10T13:05:26Z","updated_at":"2022-08-12T20:27:37Z","closed_at":"2022-08-12T20:27:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When preloading a `has_one` association that has a scope and providing `available_records` for the association, the `available_records` are ignored.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\nrequire 'bundler/inline'\r\n\r\ngemfile(false) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem 'activerecord', '7.0.3.1'\r\n  gem 'sqlite3'\r\n  gem 'pry'\r\n  gem 'rspec'\r\nend\r\n\r\nrequire 'active_record'\r\n\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts do |t|\r\n    t.timestamps\r\n  end\r\n\r\n  create_table :comments do |t|\r\n    t.belongs_to :post, foreign_key: true\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\n  has_one :latest_comment, -> { order(created_at: :desc) }, class_name: 'Comment', foreign_key: :post_id\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\nend\r\n\r\ndef preload_latest_comments(posts)\r\n  # these are the relevant comments, the latest per post\r\n  comments = Comment.where(post: posts).group(:post_id).having('MAX(created_at)').to_a\r\n\r\n  # using postgres:\r\n  # comments = Comment.where(post: posts).order(created_at: :desc).select('DISTINCT ON (post_id) *').to_a\r\n\r\n  # this \"works\", but it won't use `comments` to assign the latest comment per post,\r\n  # it will fetch all (!) comments per post and assign\r\n  preloader = ActiveRecord::Associations::Preloader.new(records: posts, associations: :latest_comment, available_records: comments)\r\n  preloader.call\r\nend\r\n\r\nRSpec.describe 'preloading using available_records' do\r\n  it 'only uses a single sql query' do\r\n    post_1 = Post.create!\r\n    post_1_latest_comment = Comment.create!(post: post_1)\r\n\r\n    post_2 = Post.create!\r\n    Comment.create!(post: post_2)\r\n    post_2_latest_comment = Comment.create!(post: post_2)\r\n\r\n    post_3 = Post.create!\r\n    Comment.create!(post: post_3)\r\n    Comment.create!(post: post_3)\r\n    post_3_latest_comment = Comment.create!(post: post_3)\r\n\r\n    posts = [post_1, post_2, post_3]\r\n\r\n    queries = []\r\n    callback = ->(name, start, finish, message_id, values) { queries << values[:sql] }\r\n\r\n    # memoize sql queries, should only be one\r\n    ActiveSupport::Notifications.subscribed(callback, 'sql.active_record') do\r\n      preload_latest_comments(posts)\r\n\r\n      expect(post_1.latest_comment).to eq(post_1_latest_comment)\r\n      expect(post_2.latest_comment).to eq(post_2_latest_comment)\r\n      expect(post_3.latest_comment).to eq(post_3_latest_comment)\r\n\r\n      # this should just be:\r\n      #   SELECT \"comments\".* FROM \"comments\" WHERE \"comments\".\"post_id\" IN (?, ?, ?) GROUP BY \"comments\".\"post_id\" HAVING (MAX(created_at))\r\n      #\r\n      #  but will be two:\r\n      #    SELECT \"comments\".* FROM \"comments\" WHERE \"comments\".\"post_id\" IN (?, ?, ?) GROUP BY \"comments\".\"post_id\" HAVING (MAX(created_at))\r\n      #    and\r\n      #    SELECT \"comments\".* FROM \"comments\" WHERE \"comments\".\"post_id\" IN (?, ?, ?) ORDER BY \"comments\".\"created_at\" DESC\r\n      expect(queries.join(\"\\n\")).to eq('SELECT \"comments\".* FROM \"comments\" WHERE \"comments\".\"post_id\" IN (?, ?, ?) GROUP BY \"comments\".\"post_id\" HAVING (MAX(created_at))')\r\n    end\r\n  end\r\nend\r\n\r\nRSpec::Core::Runner.invoke\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expect `available_records` to be used and no additional sql query to be perfomed.\r\n\r\n### Actual behavior\r\n\r\n`available_records` is ignored.\r\n\r\nI did some research and this line is why an early return is triggered and the `available_records` aren't used: https://github.com/rails/rails/blob/v7.0.3.1/activerecord/lib/active_record/associations/preloader/association.rb#L204\r\n\r\n`reflection_scope.empty_scope?` return `false` because of the `has_one` scope option (`-> { order(created_at: :desc) }`) so `!reflection_scope.empty_scope?` returns `true` and the method returns early.\r\n\r\nThe corresponding code comes from this [commit](https://github.com/rails/rails/commit/2a3f1757dd61cea4f85da859f6bd0ce7180b62b3). If I comment that one early return line, it works as expected.\r\n\r\nPingin you @jhawthorn, as you seem to be involved. :)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45804/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45804/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45803","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45803/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45803/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45803/events","html_url":"https://github.com/rails/rails/issues/45803","id":1334500936,"node_id":"I_kwDNIULOT4reSA","number":45803,"title":"undefined method `queue_as' for ActionMailer::MailDeliveryJob:Class (NoMethodError)","user":{"login":"sonaligvc","id":65411079,"node_id":"MDQ6VXNlcjY1NDExMDc5","avatar_url":"https://avatars.githubusercontent.com/u/65411079?v=4","gravatar_id":"","url":"https://api.github.com/users/sonaligvc","html_url":"https://github.com/sonaligvc","followers_url":"https://api.github.com/users/sonaligvc/followers","following_url":"https://api.github.com/users/sonaligvc/following{/other_user}","gists_url":"https://api.github.com/users/sonaligvc/gists{/gist_id}","starred_url":"https://api.github.com/users/sonaligvc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sonaligvc/subscriptions","organizations_url":"https://api.github.com/users/sonaligvc/orgs","repos_url":"https://api.github.com/users/sonaligvc/repos","events_url":"https://api.github.com/users/sonaligvc/events{/privacy}","received_events_url":"https://api.github.com/users/sonaligvc/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-08-10T11:45:27Z","updated_at":"2022-08-10T12:45:45Z","closed_at":"2022-08-10T12:45:45Z","author_association":"NONE","active_lock_reason":null,"body":"ruby-2.7.2\r\ngem 'rails', '~> 7.0.1'\r\n\r\nWhen I am starting server, I am getting \"undefined method `queue_as' for ActionMailer::MailDeliveryJob:Class (NoMethodError)\"\r\nI am upgrading application from rails 6.0.1. to rails 7.0.1\r\n\r\n=> Booting Puma\r\n=> Rails 7.0.3.1 application starting in development \r\n=> Run `bin/rails server --help` for more startup options\r\nExiting\r\nTraceback (most recent call last):\r\n\t58: from bin/rails:4:in `<main>'\r\n\t57: from bin/rails:4:in `require'\r\n\t56: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands.rb:18:in `<top (required)>'\r\n\t55: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/command.rb:48:in `invoke'\r\n\t54: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/command/base.rb:87:in `perform'\r\n\t53: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\t52: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\t51: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\t50: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands/server/server_command.rb:134:in `perform'\r\n\t49: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands/server/server_command.rb:134:in `tap'\r\n\t48: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands/server/server_command.rb:143:in `block in perform'\r\n\t47: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands/server/server_command.rb:36:in `start'\r\n\t46: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/commands/server/server_command.rb:76:in `log_to_stdout'\r\n\t45: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/server.rb:422:in `wrapped_app'\r\n\t44: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/server.rb:249:in `app'\r\n\t43: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/server.rb:349:in `build_app_and_options_from_config'\r\n\t42: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/builder.rb:66:in `parse_file'\r\n\t41: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/builder.rb:105:in `load_file'\r\n\t40: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/builder.rb:116:in `new_from_string'\r\n\t39: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/rack-2.2.4/lib/rack/builder.rb:116:in `eval'\r\n\t38: from config.ru:3:in `block in <main>'\r\n\t37: from config.ru:3:in `require_relative'\r\n\t36: from /home/sonali/bank/tupay/config/environment.rb:8:in `<top (required)>'\r\n\t35: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/application.rb:372:in `initialize!'\r\n\t34: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:60:in `run_initializers'\r\n\t33: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:205:in `tsort_each'\r\n\t32: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:226:in `tsort_each'\r\n\t31: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:347:in `each_strongly_connected_component'\r\n\t30: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:347:in `call'\r\n\t29: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:347:in `each'\r\n\t28: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\n\t27: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:415:in `each_strongly_connected_component_from'\r\n\t26: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:415:in `call'\r\n\t25: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:50:in `tsort_each_child'\r\n\t24: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:50:in `each'\r\n\t23: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:421:in `block in each_strongly_connected_component_from'\r\n\t22: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\n\t21: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:422:in `block (2 levels) in each_strongly_connected_component_from'\r\n\t20: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\n\t19: from /home/sonali/.rvm/rubies/ruby-2.7.2/lib/ruby/2.7.0/tsort.rb:228:in `block in tsort_each'\r\n\t18: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n\t17: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:32:in `run'\r\n\t16: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/initializable.rb:32:in `instance_exec'\r\n\t15: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:619:in `block in <class:Engine>'\r\n\t14: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:619:in `each'\r\n\t13: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:620:in `block (2 levels) in <class:Engine>'\r\n\t12: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:666:in `load_config_initializer'\r\n\t11: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/activesupport-7.0.3.1/lib/active_support/notifications.rb:208:in `instrument'\r\n\t10: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:667:in `block in load_config_initializer'\r\n\t 9: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/railties-7.0.3.1/lib/rails/engine.rb:667:in `load'\r\n\t 8: from /home/sonali/bank/tupay/config/initializers/monkey_patches.rb:2:in `<top (required)>'\r\n\t 7: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:35:in `require'\r\n\t 6: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:35:in `require'\r\n\t 5: from /home/sonali/bank/tupay/lib/core_ext/action_mailer/delivery_job.rb:3:in `<top (required)>'\r\n\t 4: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:35:in `require'\r\n\t 3: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:35:in `require'\r\n\t 2: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/actionmailer-7.0.3.1/lib/action_mailer/mail_delivery_job.rb:5:in `<top (required)>'\r\n\t 1: from /home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/actionmailer-7.0.3.1/lib/action_mailer/mail_delivery_job.rb:11:in `<module:ActionMailer>'\r\n/home/sonali/.rvm/gems/ruby-2.7.2@tupay_2.7/gems/actionmailer-7.0.3.1/lib/action_mailer/mail_delivery_job.rb:12:in `<class:MailDeliveryJob>': **undefined method `queue_as' for ActionMailer::MailDeliveryJob:Class (NoMethodError)**\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45803/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45803/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45801","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45801/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45801/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45801/events","html_url":"https://github.com/rails/rails/issues/45801","id":1333775038,"node_id":"I_kwDNIULOT3_Kvg","number":45801,"title":"Test","user":{"login":"uday708","id":17236400,"node_id":"MDQ6VXNlcjE3MjM2NDAw","avatar_url":"https://avatars.githubusercontent.com/u/17236400?v=4","gravatar_id":"","url":"https://api.github.com/users/uday708","html_url":"https://github.com/uday708","followers_url":"https://api.github.com/users/uday708/followers","following_url":"https://api.github.com/users/uday708/following{/other_user}","gists_url":"https://api.github.com/users/uday708/gists{/gist_id}","starred_url":"https://api.github.com/users/uday708/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uday708/subscriptions","organizations_url":"https://api.github.com/users/uday708/orgs","repos_url":"https://api.github.com/users/uday708/repos","events_url":"https://api.github.com/users/uday708/events{/privacy}","received_events_url":"https://api.github.com/users/uday708/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-09T20:51:19Z","updated_at":"2022-08-09T21:12:05Z","closed_at":"2022-08-09T21:12:05Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n### Expected behavior\r\n\r\n### Actual behavior\r\n\r\n### System configuration\r\n**Rails version**: \r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45801/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45801/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45800","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45800/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45800/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45800/events","html_url":"https://github.com/rails/rails/issues/45800","id":1333729087,"node_id":"I_kwDNIULOT38XPw","number":45800,"title":"active_record:multi_db generator seems to be missing","user":{"login":"JoaoPedroAssis","id":38732089,"node_id":"MDQ6VXNlcjM4NzMyMDg5","avatar_url":"https://avatars.githubusercontent.com/u/38732089?v=4","gravatar_id":"","url":"https://api.github.com/users/JoaoPedroAssis","html_url":"https://github.com/JoaoPedroAssis","followers_url":"https://api.github.com/users/JoaoPedroAssis/followers","following_url":"https://api.github.com/users/JoaoPedroAssis/following{/other_user}","gists_url":"https://api.github.com/users/JoaoPedroAssis/gists{/gist_id}","starred_url":"https://api.github.com/users/JoaoPedroAssis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoaoPedroAssis/subscriptions","organizations_url":"https://api.github.com/users/JoaoPedroAssis/orgs","repos_url":"https://api.github.com/users/JoaoPedroAssis/repos","events_url":"https://api.github.com/users/JoaoPedroAssis/events{/privacy}","received_events_url":"https://api.github.com/users/JoaoPedroAssis/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-09T20:05:31Z","updated_at":"2022-08-10T01:45:00Z","closed_at":"2022-08-10T01:44:59Z","author_association":"NONE","active_lock_reason":null,"body":"Hi there, I'm trying to implement read/write databases, following the official docs [here](https://edgeguides.rubyonrails.org/active_record_multiple_databases.html)\r\n\r\nIn step 4, or `Activating automatic role switching`, the instructions tells me to run the following generator:\r\n\r\n`$ bin/rails g active_record:multi_db`\r\n\r\nTo properly generate some files. When I actually run this command, I get the following output:\r\n\r\n```bash\r\nCould not find generator 'active_record:multi_db'. Maybe you meant \"active_record:model\"?\r\nRun `bin/rails generate --help` for more options.\r\n```\r\nAm I missing something?\r\n### Steps to reproduce\r\n\r\nTrying to run the generator\r\n\r\n### Expected behavior\r\n\r\nGenerator should run, and the docs should mention installation steps, if needed\r\n\r\n### Actual behavior\r\n The command outputs the error mentioned above\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.6\r\n\r\n**Ruby version**:\r\n2.7.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45800/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45800/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45799","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45799/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45799/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45799/events","html_url":"https://github.com/rails/rails/issues/45799","id":1333514640,"node_id":"I_kwDNIULOT3vRkA","number":45799,"title":"Asset folder is not created","user":{"login":"josephmo","id":202611,"node_id":"MDQ6VXNlcjIwMjYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/202611?v=4","gravatar_id":"","url":"https://api.github.com/users/josephmo","html_url":"https://github.com/josephmo","followers_url":"https://api.github.com/users/josephmo/followers","following_url":"https://api.github.com/users/josephmo/following{/other_user}","gists_url":"https://api.github.com/users/josephmo/gists{/gist_id}","starred_url":"https://api.github.com/users/josephmo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josephmo/subscriptions","organizations_url":"https://api.github.com/users/josephmo/orgs","repos_url":"https://api.github.com/users/josephmo/repos","events_url":"https://api.github.com/users/josephmo/events{/privacy}","received_events_url":"https://api.github.com/users/josephmo/received_events","type":"User","site_admin":false},"labels":[{"id":128693,"node_id":"MDU6TGFiZWwxMjg2OTM=","url":"https://api.github.com/repos/rails/rails/labels/asset%20pipeline","name":"asset pipeline","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-09T16:38:29Z","updated_at":"2022-08-10T20:45:28Z","closed_at":"2022-08-10T20:45:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nUp until this morning, I have been using the following build script to start my Production server:\r\n\r\n    sudo rm -Rf /home/deploy/current/\r\n    git clone -b xxxx git@xxxxxxx.git /home/deploy/current\r\n    cd /home/deploy/current/\r\n    bundle update\r\n    bundle install\r\n    rake db:migrate\r\n    rake db:seed\r\n    rails tailwindcss:build\r\n    bundle exec rake assets:precompile\r\n    bundle binstubs puma\r\n    sudo systemctl stop puma\r\n    sudo systemctl start puma\r\n    sudo service nginx restart\r\n\r\nand things were working fine. This morning, when I did this, I discovered that the public/assets folder was not created. So, obviously the application is not working.\r\n\r\nI rebooted the server, and re-tried this multiple times. No error are generated in the log file. I tried precompiling with the --trace switch, and no errors.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nI was expecting a  public/assets folder to be created and the assets precompiled there.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.3.1\r\n\r\n**Ruby version**:\r\n\r\n3.1.0","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45799/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45797","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45797/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45797/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45797/events","html_url":"https://github.com/rails/rails/issues/45797","id":1333307287,"node_id":"I_kwDNIULOT3inlw","number":45797,"title":"PostgresqlTimestampFixtureTest#test_bc_timestamp fails with Ruby 3.2.0dev ","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-09T14:01:48Z","updated_at":"2022-08-18T23:43:16Z","closed_at":"2022-08-18T23:43:16Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/88721#0182816a-1029-4874-89ee-60d75993d2ce/1046-1057\r\n\r\n### Steps to reproduce\r\n1. Install Ruby 3.2.0dev that includes https://github.com/ruby/ruby/commit/e07d450deae500422b7693a30c75c5b1567601a\r\n\r\n2. Execute these steps\r\n```\r\ngit clone https://github.com/rails/rails\r\ncd rails\r\nrm Gemfile.lock\r\nbundle install\r\ncd activerecord\r\nARCONN=postgresql bin/test test/cases/adapters/postgresql/timestamp_test.rb -n test_bc_timestamp\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ ARCONN=postgresql bin/test test/cases/adapters/postgresql/timestamp_test.rb -n test_bc_timestamp\r\nUsing postgresql\r\nRun options: -n test_bc_timestamp --seed 15322\r\n\r\n# Running:\r\n\r\nF\r\n\r\nFailure:\r\nPostgresqlTimestampFixtureTest#test_bc_timestamp [/home/yahonda/src/github.com/rails/rails/activerecord/test/cases/adapters/postgresql/timestamp_test.rb:150]:\r\nExpected: Thu, 25 Dec -0001\r\n  Actual: -0001-12-25 00:00:00 UTC\r\n\r\n\r\nbin/test test/cases/adapters/postgresql/timestamp_test.rb:147\r\n\r\n\r\n\r\nFinished in 0.082358s, 12.1421 runs/s, 12.1421 assertions/s.\r\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\r\n$\r\n```\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.2.0dev (2022-08-08T14:50:17Z master e07d450dea) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45797/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45797/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45795","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45795/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45795/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45795/events","html_url":"https://github.com/rails/rails/issues/45795","id":1333074356,"node_id":"I_kwDNIULOT3UZtA","number":45795,"title":"Create returns \"id: 0\" when id type is set to UUID when using MySQL","user":{"login":"Shuttleu","id":329582,"node_id":"MDQ6VXNlcjMyOTU4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/329582?v=4","gravatar_id":"","url":"https://api.github.com/users/Shuttleu","html_url":"https://github.com/Shuttleu","followers_url":"https://api.github.com/users/Shuttleu/followers","following_url":"https://api.github.com/users/Shuttleu/following{/other_user}","gists_url":"https://api.github.com/users/Shuttleu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shuttleu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shuttleu/subscriptions","organizations_url":"https://api.github.com/users/Shuttleu/orgs","repos_url":"https://api.github.com/users/Shuttleu/repos","events_url":"https://api.github.com/users/Shuttleu/events{/privacy}","received_events_url":"https://api.github.com/users/Shuttleu/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-09T10:51:26Z","updated_at":"2022-09-11T01:00:15Z","closed_at":"2022-09-11T01:00:15Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nWhen creating a new rails app with nothing but using the MySQL adaptor, using a UUID as the primary key causes ActiveRecord to return id: 0 when creating a new record.\r\n\r\n`rails new app --database=mysql`\r\n\r\nMigration\r\n```ruby\r\nclass CreateUsers < ActiveRecord::Migration[7.0]\r\n    def change\r\n        create_table :users, id: :uuid, default: -> { \"UUID()\" } do |t|\r\n            t.string :name\r\n      \r\n            t.timestamps\r\n        end\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nWhen creating a new record with the id being a UUID type, the returned object should have the correct id.\r\n\r\n### Actual behavior\r\nWhen creating a new record, and assigning it to a variable, the variable returned has id: 0\r\n\r\n```\r\n3.0.2 :021 > foo = User.create(name: \"Foo\")\r\n\r\n  TRANSACTION (0.3ms)  BEGIN\r\n  User Create (0.4ms)  INSERT INTO `users` (`name`,`created_at`, `updated_at`) VALUES ('Foo', '2022-08-09 10:28:08.926529', '2022-08-09 10:28:08.926529')\r\n  TRANSACTION (2.3ms)  COMMIT\r\n => #<User:0x000056216d6f1a28 id: 0, name: \"Foo\", created_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00, updated_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00>\r\n\r\n3.0.2 :021 > foo\r\n\r\n => #<User:0x000056216d6f1a28 id: 0, name: \"Foo\", created_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00, updated_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00>\r\n\r\n3.0.2 :021 > foo.id\r\n\r\n => 0\r\n\r\n3.0.2 :001 > User.first\r\n\r\n  User Load (0.5ms)  SELECT `users`.* FROM `users` ORDER BY `users`.`id` DESC LIMIT 1\r\n =>\r\n#<User:0x000055698f9e02e8\r\n id: \"4377c7f9-17ce-11ed-b8d5-7cd30a13200b\",\r\n name: \"Foo\",\r\n created_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00,\r\n updated_at: Tue, 09 Aug 2022 10:28:08.926529000 UTC +00:00>\r\n\r\n3.0.2 :021 > User.first.id\r\n\r\n  User Load (0.8ms)  SELECT `users`.* FROM `users` ORDER BY `users`.`id` DESC LIMIT 1\r\n => \"4377c7f9-17ce-11ed-b8d5-7cd30a13200b\"\r\n\r\n3.0.2 :002 > foo = User.first\r\n\r\n  User Load (0.6ms)  SELECT `users`.* FROM `users` ORDER BY `users`.`id` DESC LIMIT 1\r\n =>\r\n#<User:0x000055698fc801d8\r\n...\r\n\r\n3.0.2 :021 > foo.id\r\n\r\n => \"4377c7f9-17ce-11ed-b8d5-7cd30a13200b\"\r\n\r\n```\r\n\r\n### Note\r\nI'm assuming this is because the id is generated using a function on the server side? But this seems to work fine when using an integer with auto increment (which is also done server side)\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.3.1\r\n\r\n**Ruby version**:\r\nRuby 3.0.2\r\n\r\n**MySQL server version**:\r\nMariaDB 10.7.4","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45795/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45795/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45794","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45794/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45794/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45794/events","html_url":"https://github.com/rails/rails/issues/45794","id":1332999733,"node_id":"I_kwDNIULOT3P2NQ","number":45794,"title":"Action Cable client goes in a connection loop if you subscribe multiple times to the same channel","user":{"login":"ProGM","id":5167659,"node_id":"MDQ6VXNlcjUxNjc2NTk=","avatar_url":"https://avatars.githubusercontent.com/u/5167659?v=4","gravatar_id":"","url":"https://api.github.com/users/ProGM","html_url":"https://github.com/ProGM","followers_url":"https://api.github.com/users/ProGM/followers","following_url":"https://api.github.com/users/ProGM/following{/other_user}","gists_url":"https://api.github.com/users/ProGM/gists{/gist_id}","starred_url":"https://api.github.com/users/ProGM/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ProGM/subscriptions","organizations_url":"https://api.github.com/users/ProGM/orgs","repos_url":"https://api.github.com/users/ProGM/repos","events_url":"https://api.github.com/users/ProGM/events{/privacy}","received_events_url":"https://api.github.com/users/ProGM/received_events","type":"User","site_admin":false},"labels":[{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-09T09:48:36Z","updated_at":"2022-08-17T17:57:27Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nYou can just start from a fresh `rails new [project-name]` installation.\r\nChannel code:\r\n```ruby\r\nclass ArticleChannel < ApplicationCable::Channel\r\n  def subscribed\r\n    stream_from \"ArticleChannel\"\r\n  end\r\n\r\n  def unsubscribed\r\n    # Any cleanup needed when channel is unsubscribed\r\n  end\r\nend\r\n```\r\n\r\nJavascript code:\r\n```javascript\r\nimport consumer from \"channels/consumer\"\r\n\r\nfunction subscribe() {\r\n\treturn consumer.subscriptions.create('ArticleChannel', {\r\n\t\tconnected() {\r\n\t\t\tconsole.log('connected');\r\n\t\t\t// Called when the subscription is ready for use on the server\r\n\t\t},\r\n\r\n\t\tdisconnected() {\r\n\t\t\tconsole.log('disconnected');\r\n\t\t\t// Called when the subscription has been terminated by the server\r\n\t\t},\r\n\r\n\t\treceived(data) {\r\n\t\t\tconsole.log('received', data);\r\n\t\t\t// Called when there's incoming data on the websocket for this channel\r\n\t\t}\r\n\t});\r\n}\r\n\r\nsetTimeout(() => {\r\n\tsubscribe();\r\n}, 3000);\r\n\r\nsetTimeout(() => {\r\n\tsubscribe();\r\n}, 4000);\r\n```\r\n\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nAny of these options could be considered an expected behavior:\r\n* Everything just works™, both subscriptions receive notification from that channel and no error is raised\r\n* The second `subscription.create(...)` raises some kind of error, notifying that the channel is already connected\r\n* The second `subscription.create(...)` returns the same instance of Subscription and writes a `console.warning` in console\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nThe second subscriptions triggers a connection loop.\r\n\r\nExample logs with `ActionCable.logger.enabled = true`.\r\n\r\n```\r\n[ActionCable] Opening WebSocket, current state is null, subprotocols: actioncable-v1-json,actioncable-unsupported 1660037219747\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] ConnectionMonitor started. stale threshold = 6 s 1660037219748\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] WebSocket onopen event, using 'actioncable-v1-json' subprotocol 1660037219758\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] ConnectionMonitor recorded connect 1660037219759\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor guaranteeing {\"channel\":\"ArticleChannel\"} 1660037219760\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] Subscription confirmed {\"channel\":\"ArticleChannel\"} 1660037219762\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor forgetting {\"channel\":\"ArticleChannel\"} 1660037219762\r\narticle_channel-b29f3f7bf31169dfadd26c7747a46706d4992a1fd842de8268f206c5f0a0fe45.js:6 connected\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor guaranteeing {\"channel\":\"ArticleChannel\"} 1660037220744\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor resubscribing {\"channel\":\"ArticleChannel\"} 1660037221248\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor already guaranteeing {\"channel\":\"ArticleChannel\"} 1660037221248\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor resubscribing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor already guaranteeing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor resubscribing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor already guaranteeing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor resubscribing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n[ActionCable] SubscriptionGuarantor already guaranteeing {\"channel\":\"ArticleChannel\"} 1660037221753\r\nactioncable.esm-e01089c3ec4fe7817fa9abcad06cab6bdc387f95f0ca6aab4bf7ba7537f70690.js:10\r\n... and so on, forever...\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1\r\n\r\n### Possible solutions\r\nThis issue happens because the identifier of both subscriptions is the same. Since Rails (ActionCable) doesn't answer to any subsequential command \"subscribe\" from the same client (in this case: `{\"command\":\"subscribe\",\"identifier\":\"{\\\"channel\\\":\\\"ArticleChannel\\\"}\"}`), the `SubscriptionGuarantor` considers the connection failed and [retries to connect after 500ms](https://github.com/rails/rails/blob/8994f09dd2f6ae363e74d8ee3b24700d9db94a16/actioncable/app/assets/javascripts/actioncable.esm.js#L351).\r\n\r\nI see various options to fix this:\r\n* Raise an exception when trying to create a subscription with the same identifier\r\n* Add a random/uuid to the identifier when connecting, so two connection would not share the same identifier? (I've already tested it, and it seems to fix)\r\n\r\nWould you accept a PR from me regarding this?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45794/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45794/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45793","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45793/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45793/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45793/events","html_url":"https://github.com/rails/rails/issues/45793","id":1332849690,"node_id":"I_kwDNIULOT3GsGg","number":45793,"title":"Schema.db \"Unknown type 'uuid' for column 'id'\" when using MySQL","user":{"login":"Shuttleu","id":329582,"node_id":"MDQ6VXNlcjMyOTU4Mg==","avatar_url":"https://avatars.githubusercontent.com/u/329582?v=4","gravatar_id":"","url":"https://api.github.com/users/Shuttleu","html_url":"https://github.com/Shuttleu","followers_url":"https://api.github.com/users/Shuttleu/followers","following_url":"https://api.github.com/users/Shuttleu/following{/other_user}","gists_url":"https://api.github.com/users/Shuttleu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shuttleu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shuttleu/subscriptions","organizations_url":"https://api.github.com/users/Shuttleu/orgs","repos_url":"https://api.github.com/users/Shuttleu/repos","events_url":"https://api.github.com/users/Shuttleu/events{/privacy}","received_events_url":"https://api.github.com/users/Shuttleu/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-08-09T07:44:17Z","updated_at":"2022-09-11T01:01:14Z","closed_at":"2022-09-11T01:01:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nWhen creating a new rails app with nothing but using the MySQL adaptor, creating a migration that uses UUID as the primary key type, does not allow schema.db to be generated.\r\n\r\n`rails new app --database=mysql`\r\n\r\nMigration\r\n```ruby\r\nclass CreateUsers < ActiveRecord::Migration[7.0]\r\n    def change\r\n        create_table :users, id: :uuid, default: -> { \"UUID()\" } do |t|\r\n            t.string :name\r\n      \r\n            t.timestamps\r\n        end\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nschema.db should have the table definitions for the Users table\r\n\r\n### Actual behavior\r\nInstead of table definitions, it has this comment instead\r\n```ruby\r\n# Could not dump table \"users\" because of following StandardError\r\n#   Unknown type 'uuid' for column 'id'\r\n```\r\nThe database is created correctly, and works as expected in use.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.3.1\r\n\r\n**Ruby version**:\r\nRuby 3.0.2\r\n\r\n**MySQL server version**:\r\nMariaDB 10.7.4","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45793/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45793/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45791","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45791/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45791/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45791/events","html_url":"https://github.com/rails/rails/issues/45791","id":1332570977,"node_id":"I_kwDNIULOT21rYQ","number":45791,"title":"Google::Apis::ClientError raised when using ActiveStorage to generate signed URLs to access a file in a GCS bucket with GKE Workload Identity","user":{"login":"danielyazbek","id":18390164,"node_id":"MDQ6VXNlcjE4MzkwMTY0","avatar_url":"https://avatars.githubusercontent.com/u/18390164?v=4","gravatar_id":"","url":"https://api.github.com/users/danielyazbek","html_url":"https://github.com/danielyazbek","followers_url":"https://api.github.com/users/danielyazbek/followers","following_url":"https://api.github.com/users/danielyazbek/following{/other_user}","gists_url":"https://api.github.com/users/danielyazbek/gists{/gist_id}","starred_url":"https://api.github.com/users/danielyazbek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielyazbek/subscriptions","organizations_url":"https://api.github.com/users/danielyazbek/orgs","repos_url":"https://api.github.com/users/danielyazbek/repos","events_url":"https://api.github.com/users/danielyazbek/events{/privacy}","received_events_url":"https://api.github.com/users/danielyazbek/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-08-09T01:05:08Z","updated_at":"2022-08-09T15:53:58Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nConfigure ActiveStorage with GKE Workload identity (as documented [here](https://edgeguides.rubyonrails.org/active_storage_overview.html#google-cloud-storage-service)):\r\n\r\n```ruby\r\ngoogle:\r\n  service: GCS\r\n  iam: true\r\n  project: <%= ENV['ACTIVE_STORAGE_PROJECT'] %>\r\n  bucket: <%= ENV['ACTIVE_STORAGE_BUCKET'] %>\r\n```\r\n\r\nDefine a class:\r\n```ruby\r\nclass Transaction < ApplicationRecord\r\n  has_one_attached :csv_report\r\nend\r\n```\r\n\r\nWrite something to ActiveStorage:\r\n```ruby\r\nt = Transaction.create\r\nt.csv_report.attach(io: StringIO.new(\"A,B,C\"), filename: 'test.csv')\r\n```\r\n\r\nGenerate a Signed URL\r\n```ruby\r\nRails.application.routes.url_helpers.rails_blob_url(Transaction.last.csv_report, disposition: 'attachment')\r\n```\r\n\r\nPaste the generated URL into a browser\r\n\r\n### Expected behavior\r\nActiveRecord provides the attachment\r\n\r\n### Actual behavior\r\nError is raised:\r\n\r\n```\r\nGoogle::Apis::ClientError (Invalid request):\r\ngems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:236:in `check_status': Invalid request (Google::Apis::ClientError)\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/api_command.rb:134:in `check_status'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:199:in `process_response'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:318:in `execute_once'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:118:in `block (2 levels) in execute'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:61:in `block in retriable'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:56:in `times'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:56:in `retriable'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:115:in `block in execute'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:61:in `block in retriable'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:56:in `times'\r\n    from gems/retriable-3.1.2/lib/retriable.rb:56:in `retriable'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/http_command.rb:105:in `execute'\r\n    from gems/google-apis-core-0.7.0/lib/google/apis/core/base_service.rb:397:in `execute_or_queue_command'\r\n    from gems/google-apis-iamcredentials_v1-0.13.0/lib/google/apis/iamcredentials_v1/service.rb:158:in `sign_service_account_blob'\r\n    from gems/activestorage-7.0.3.1/lib/active_storage/service/gcs_service.rb:232:in `block in signer'\r\n    from gems/google-cloud-storage-1.38.0/lib/google/cloud/storage/file/signer_v2.rb:135:in `generate_signature'\r\n    from gems/google-cloud-storage-1.38.0/lib/google/cloud/storage/file/signer_v2.rb:128:in `signed_url'\r\n    from gems/google-cloud-storage-1.38.0/lib/google/cloud/storage/file.rb:1801:in `signed_url'\r\n    from gems/activestorage-7.0.3.1/lib/active_storage/service/gcs_service.rb:160:in `private_url'\r\n    from gems/activestorage-7.0.3.1/lib/active_storage/service.rb:123:in `block in url'\r\n    from gems/activesupport-7.0.3.1/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    from gems/activesupport-7.0.3.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n    from gems/activesupport-7.0.3.1/lib/active_support/notifications.rb:206:in `instrument'\r\n    from gems/activestorage-7.0.3.1/lib/active_storage/service.rb:163:in `instrument'\r\n    from gems/activestorage-7.0.3.1/lib/active_storage/service.rb:118:in `url'\r\n    from gems/activestorage-7.0.3.1models/active_storage/blob.rb:217:in `url'\r\n    from gems/activestorage-7.0.3.1controllers/active_storage/blobs/redirect_controller.rb:14:in `show'\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n\r\n**google-cloud-storage gem version:** 1.38.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45791/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45791/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45781","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45781/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45781/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45781/events","html_url":"https://github.com/rails/rails/issues/45781","id":1330695816,"node_id":"I_kwDNIULOT1DOiA","number":45781,"title":"ActiveStorage ProxyController crashes in API-only apps","user":{"login":"chvp","id":42220376,"node_id":"MDQ6VXNlcjQyMjIwMzc2","avatar_url":"https://avatars.githubusercontent.com/u/42220376?v=4","gravatar_id":"","url":"https://api.github.com/users/chvp","html_url":"https://github.com/chvp","followers_url":"https://api.github.com/users/chvp/followers","following_url":"https://api.github.com/users/chvp/following{/other_user}","gists_url":"https://api.github.com/users/chvp/gists{/gist_id}","starred_url":"https://api.github.com/users/chvp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chvp/subscriptions","organizations_url":"https://api.github.com/users/chvp/orgs","repos_url":"https://api.github.com/users/chvp/repos","events_url":"https://api.github.com/users/chvp/events{/privacy}","received_events_url":"https://api.github.com/users/chvp/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-06T08:54:13Z","updated_at":"2022-08-08T13:46:42Z","closed_at":"2022-08-08T13:46:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n * Create an API-only rails app with activestorage enabled and using the [proxy mode](https://guides.rubyonrails.org/active_storage_overview.html#proxy-mode).\r\n * Upload an attachment.\r\n * Try to download it.\r\n * See that [this](https://github.com/rails/rails/blob/main/activestorage/app/controllers/active_storage/representations/proxy_controller.rb#L13) fails because it transitively calls [this](https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/metal/etag_with_flash.rb#L15), and `flash` is not available in a default API-only rails app.\r\n\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n\r\n  # Important configuration\r\n  config.api_only = true\r\n  config.active_storage.resolve_model_to_route = :rails_storage_proxy\r\n  \r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\nend\r\n\r\ndb_dir = Dir.mktmpdir(\"test\", Dir.tmpdir)\r\nENV[\"DATABASE_URL\"] = \"sqlite3:#{db_dir}/db.sqlite3\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one_attached :profile\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rails.application.routes.url_helpers\r\n  include Rack::Test::Methods\r\n\r\n  def test_upload_and_fetch\r\n    user = User.create!(\r\n      profile: {\r\n        content_type: \"text/plain\",\r\n        filename: \"dummy.txt\",\r\n        io: ::StringIO.new(\"dummy\"),\r\n      }\r\n    )\r\n\r\n    response = get rails_blob_url(user.profile, only_path: true)\r\n    assert response.ok?\r\n  end\r\n\r\n  private\r\n\r\n  def app\r\n    Rails.application\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nThe resource is requested without issues.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nIt crashes [here](https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/metal/etag_with_flash.rb#L15). Relevant part of stacktrace:\r\n```\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/flash.rb:10:in `flash'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/etag_with_flash.rb:15:in `block (2 levels) in <module:EtagWithFlash>'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:322:in `instance_exec'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:322:in `block in combine_etags'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:322:in `map'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:322:in `combine_etags'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:126:in `fresh_when'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:250:in `stale?'\r\nrails (0c97d1db023d) actionpack/lib/action_controller/metal/conditional_get.rb:309:in `http_cache_forever'\r\nrails (0c97d1db023d) activestorage/app/controllers/active_storage/blobs/proxy_controller.rb:17:in `show'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0 / edge\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45781/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45781/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45778","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45778/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45778/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45778/events","html_url":"https://github.com/rails/rails/issues/45778","id":1330360134,"node_id":"I_kwDNIULOT0uvRg","number":45778,"title":"ActiveStorage attachments are lost when casting using Becomes","user":{"login":"markedmondson","id":1653699,"node_id":"MDQ6VXNlcjE2NTM2OTk=","avatar_url":"https://avatars.githubusercontent.com/u/1653699?v=4","gravatar_id":"","url":"https://api.github.com/users/markedmondson","html_url":"https://github.com/markedmondson","followers_url":"https://api.github.com/users/markedmondson/followers","following_url":"https://api.github.com/users/markedmondson/following{/other_user}","gists_url":"https://api.github.com/users/markedmondson/gists{/gist_id}","starred_url":"https://api.github.com/users/markedmondson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markedmondson/subscriptions","organizations_url":"https://api.github.com/users/markedmondson/orgs","repos_url":"https://api.github.com/users/markedmondson/repos","events_url":"https://api.github.com/users/markedmondson/events{/privacy}","received_events_url":"https://api.github.com/users/markedmondson/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-05T20:19:16Z","updated_at":"2022-08-09T18:05:34Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\nCreate an ActiveRecord model with an ActiveStorage relation. Initialize and add the associated attachment. Cast the object to another subclassed model, the associated attachment is lost.\r\n\r\n```ruby\r\nunless File.exist?('Gemfile')\r\n    File.write('Gemfile', <<-GEMFILE)\r\n    source 'https://rubygems.org'\r\n    gem 'rails', '~> 6.1'\r\n    gem 'sqlite3'\r\n    GEMFILE\r\n\r\n    system 'bundle'\r\nend\r\n\r\nrequire 'bundler'\r\nBundler.setup(:default)\r\n\r\nrequire 'active_record'\r\nrequire 'active_storage/engine'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << 'example.org'\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: 'cookie_store_key'\r\n  secrets.secret_key_base = 'secret_key_base'\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: 'Disk'\r\n    }\r\n  }\r\nend\r\n\r\nENV['DATABASE_URL'] = 'sqlite3::memory:'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join('db/migrate/20170806125915_create_active_storage_tables.rb').to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :posts do |t|\r\n    t.string :title\r\n    t.string :text\r\n  end\r\n\r\n  create_table :comments do |t|\r\n    t.belongs_to :post\r\n    t.string :text\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n  has_one_attached :image\r\nend\r\n\r\nclass ModeratedComment < Comment; end\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    @post = Post.create(title: 'Post', text: 'Welcome')\r\n  end\r\n\r\n  def test_association\r\n    comment = @post.comments.new(text: 'I do not like this')\r\n\r\n    moderated_comment = comment.becomes(ModeratedComment)\r\n\r\n    assert_equal @post, moderated_comment.post # Pass\r\n  end\r\n\r\n  def test_attachment\r\n    file = ActiveStorage::Blob.create_and_upload!(\r\n      content_type: \"image/png\",\r\n      filename: \"image.png\",\r\n      io: ::StringIO.new(\"png\"),\r\n    )\r\n    comment = @post.comments.new(text: 'I do not like this', image: file)\r\n\r\n    moderated_comment = comment.becomes(ModeratedComment)\r\n\r\n    assert moderated_comment.image.attached? # Fail\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nWhen casting an ActiveRecord to another model, I expect the associations to be copied thus I expect attached ActiveStorage association assets to be copied.\r\n\r\n### Actual behavior\r\nPreviously attached ActiveStorage associated objects are lost on the original object.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 3.0.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45778/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45778/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45777","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45777/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45777/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45777/events","html_url":"https://github.com/rails/rails/issues/45777","id":1330341035,"node_id":"I_kwDNIULOT0tkqw","number":45777,"title":"ActionView::Template::Error: undefined method `concat' for ActionView::OutputBuffer","user":{"login":"kyrofa","id":946674,"node_id":"MDQ6VXNlcjk0NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/946674?v=4","gravatar_id":"","url":"https://api.github.com/users/kyrofa","html_url":"https://github.com/kyrofa","followers_url":"https://api.github.com/users/kyrofa/followers","following_url":"https://api.github.com/users/kyrofa/following{/other_user}","gists_url":"https://api.github.com/users/kyrofa/gists{/gist_id}","starred_url":"https://api.github.com/users/kyrofa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kyrofa/subscriptions","organizations_url":"https://api.github.com/users/kyrofa/orgs","repos_url":"https://api.github.com/users/kyrofa/repos","events_url":"https://api.github.com/users/kyrofa/events{/privacy}","received_events_url":"https://api.github.com/users/kyrofa/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-08-05T19:59:37Z","updated_at":"2022-08-08T07:05:45Z","closed_at":"2022-08-08T07:05:45Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nFirst of all, I really appreciate how easy you make it to submit test cases on issues, but I couldn't figure out how to make one for this particular situation. I can tell you, though, that after a bisect, this issue is introduced by 4e8e82829182cc2c1dc07997acc210bc0656eda4.\r\n\r\nMy test case is pretty simple. I have a HAML view that makes use of a helper like this:\r\n\r\n```\r\ndef icons\r\n  content_tag(:span, class: \"my-icons\") do\r\n    concat image_tag('path/to/image.svg')\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThis helper should render a span with an image contained within it. Before 4e8e82829182cc2c1dc07997acc210bc0656eda4, that's what happened.\r\n\r\n### Actual behavior\r\nAn error is raised:\r\n\r\n```\r\nActionView::Template::Error: undefined method `concat' for #<ActionView::OutputBuffer:0x000055751f13e310 @raw_buffer=\"\">\r\n    /home/app/foo/vendor/bundle/ruby/2.7.0/gems/haml-5.2.2/lib/haml/helpers/action_view_xss_mods.rb:41:in `concat_with_haml_xss'\r\n    /home/app/foo/app/helpers/icons_helper.rb:80:in `block in icons'\r\n    <snip>\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main\r\n**Ruby version**: 2.7.4","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45777/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45777/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45775","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45775/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45775/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45775/events","html_url":"https://github.com/rails/rails/issues/45775","id":1330225377,"node_id":"I_kwDNIULOT0mg4Q","number":45775,"title":"Uniqueness validation on association does not use the correct primary key","user":{"login":"mikeletscher","id":6666411,"node_id":"MDQ6VXNlcjY2NjY0MTE=","avatar_url":"https://avatars.githubusercontent.com/u/6666411?v=4","gravatar_id":"","url":"https://api.github.com/users/mikeletscher","html_url":"https://github.com/mikeletscher","followers_url":"https://api.github.com/users/mikeletscher/followers","following_url":"https://api.github.com/users/mikeletscher/following{/other_user}","gists_url":"https://api.github.com/users/mikeletscher/gists{/gist_id}","starred_url":"https://api.github.com/users/mikeletscher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikeletscher/subscriptions","organizations_url":"https://api.github.com/users/mikeletscher/orgs","repos_url":"https://api.github.com/users/mikeletscher/repos","events_url":"https://api.github.com/users/mikeletscher/events{/privacy}","received_events_url":"https://api.github.com/users/mikeletscher/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-05T18:10:22Z","updated_at":"2022-08-09T14:52:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nI'm not _entirely_ sure if this is considered a bug, or intended behavior that's not well-documented for `uniqueness` validations on associations.\r\n\r\nI'm happy to help improve the documentation on this if that would be the most helpful way forward, or if this _is_ considered a bug, I can take a stab at a PR. \r\n\r\nIt looks like the issue is that `build_relation` on the uniqueness validator calls [`bind_attribute` on `ActiveRecord::Relation`](https://github.com/rails/rails/blob/408d061a80a49878ad26b305616ed9ba88ee1411/activerecord/lib/active_record/relation.rb#L45), which properly takes into account the reflection's foreign_key, but not primary key if it's been overridden. \r\n\r\nHere's a test that reproduces the issue:\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem 'activerecord', '~> 7.0.3.1'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(\r\n  adapter: 'sqlite3',\r\n  database: ':memory:'\r\n)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :prescriptions, force: true do |t|\r\n    t.string :rx_number\r\n  end\r\n\r\n  create_table :fills, force: true do |t|\r\n    t.string :rx_number\r\n  end\r\nend\r\n\r\nclass Prescription < ActiveRecord::Base\r\n  has_many :fills, foreign_key: :rx_number, primary_key: :rx_number\r\nend\r\n\r\nclass Fill < ActiveRecord::Base\r\n  belongs_to :prescription, foreign_key: :rx_number, primary_key: :rx_number\r\n\r\n  validates :prescription, uniqueness: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_fill_unique_by_rx_number\r\n    Fill.create!(rx_number: '1234')\r\n    prescription = Prescription.create!(rx_number: '1234')\r\n    new_fill = prescription.fills.new\r\n    refute new_fill.save\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe uniqueness validation query would use the `rx_number` value of the `Prescription` to query for an existing `Fill` since that is what is set as the associations `primary_key`. \r\n\r\n### Actual behavior\r\nThe uniqueness validation query uses the `id` value of the `Prescription` to query for existing fills, disregarding the association's overridden `primary_key`.\r\n\r\nThis test passes if I patch bind_attribute to read the primary key from the reflection instead of directly from the reflection's klass:\r\n\r\n```ruby\r\nmodule ActiveRecord\r\n  # = Active Record \\Relation\r\n  class Relation\r\n    def bind_attribute(name, value) # :nodoc:\r\n      if reflection = klass._reflect_on_association(name)\r\n        name = reflection.foreign_key\r\n        primary_key = reflection.association_primary_key || reflection.klass.primary_key\r\n        value = value.read_attribute(primary_key) unless value.nil?\r\n      end\r\n\r\n      attr = table[name]\r\n      bind = predicate_builder.build_bind_attribute(attr.name, value)\r\n      yield attr, bind\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nWe were able to work around this by adding the uniqueness validation to the `rx_number` attribute instead of the association. If this is the desired way to handle this, I can open a PR to add a note about this to the docs, as it took us by surprise that validation on the association wouldn't use the defined key to get the value to query.\r\n\r\n### System configuration\r\n**Rails version**: `7.0.3.1`\r\n\r\n**Ruby version**: `3.1.2`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45775/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45775/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45767","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45767/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45767/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45767/events","html_url":"https://github.com/rails/rails/issues/45767","id":1329781610,"node_id":"I_kwDNIULOT0Lbag","number":45767,"title":"ArgumentError due to nil `pool_config` when calling `connects_to` ","user":{"login":"lsylvester","id":191128,"node_id":"MDQ6VXNlcjE5MTEyOA==","avatar_url":"https://avatars.githubusercontent.com/u/191128?v=4","gravatar_id":"","url":"https://api.github.com/users/lsylvester","html_url":"https://github.com/lsylvester","followers_url":"https://api.github.com/users/lsylvester/followers","following_url":"https://api.github.com/users/lsylvester/following{/other_user}","gists_url":"https://api.github.com/users/lsylvester/gists{/gist_id}","starred_url":"https://api.github.com/users/lsylvester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lsylvester/subscriptions","organizations_url":"https://api.github.com/users/lsylvester/orgs","repos_url":"https://api.github.com/users/lsylvester/repos","events_url":"https://api.github.com/users/lsylvester/events{/privacy}","received_events_url":"https://api.github.com/users/lsylvester/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-08-05T10:57:02Z","updated_at":"2022-08-05T17:07:53Z","closed_at":"2022-08-05T17:07:53Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate configuration for a second database.\r\n\r\nEnsure that `legacy_connection_handling` is not in use.\r\n\r\nEnsure that there are no fixture file for the secondary database. - if there are any fixture files then the Abstract class that configures the database referenced before the fixtures are loaded and it is able to be configured successfully.\r\n\r\nConfigure the databases in the abstract class using `reading` before `writing` in the `connects_to database:` hash - the error only occurs if the `pool_config` for the `reading` role is set before the `writing` roles.\r\n\r\nRun tests.\r\n\r\nReproduced in application at https://github.com/lsylvester/connection-pool-error\r\n\r\n### Expected behavior\r\n\r\nApplication should connect to second database.\r\n\r\n### Actual behavior\r\n\r\n```\r\nError:\r\nDogTest#test_dog:\r\nArgumentError: The `pool_config` for the :reading role and :default shard was `nil`. Please check your configuration. If you want your writing role to be something other than `:writing` set `config.active_record.writing_role` in your application configuration. The same setting should be applied for the `reading_role` if applicable.\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/connection_adapters/pool_manager.rb:42:in `set_pool_config'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:234:in `block (3 levels) in setup_shared_connection_pool'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:229:in `each'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:229:in `block (2 levels) in setup_shared_connection_pool'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:226:in `each'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:226:in `block in setup_shared_connection_pool'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:224:in `each'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:224:in `setup_shared_connection_pool'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/test_fixtures.rb:140:in `block in setup_fixtures'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:236:in `finish'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:76:in `block in finish'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:91:in `block in iterate_guarding_exceptions'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:90:in `each'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:90:in `iterate_guarding_exceptions'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/fanout.rb:76:in `finish'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/instrumenter.rb:49:in `finish_with_state'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activesupport/lib/active_support/notifications/instrumenter.rb:30:in `instrument'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/connection_adapters/abstract/connection_handler.rb:154:in `establish_connection'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/connection_handling.rb:95:in `block in connects_to'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/connection_handling.rb:90:in `each'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/bundler/gems/rails-d60d0587c3c1/activerecord/lib/active_record/connection_handling.rb:90:in `connects_to'\r\n    /Users/lachlansylvester/Blake/connection-pool/app/models/animals_record.rb:4:in `<class:AnimalsRecord>'\r\n    /Users/lachlansylvester/Blake/connection-pool/app/models/animals_record.rb:1:in `<main>'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:27:in `require'\r\n    /Users/lachlansylvester/Blake/connection-pool/app/models/dog.rb:1:in `<main>'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/bootsnap-1.13.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\n    /Users/lachlansylvester/.asdf/installs/ruby/3.0.1/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:27:in `require'\r\n    /Users/lachlansylvester/Blake/connection-pool/test/models/dog_test.rb:6:in `block in <class:DogTest>'\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: Rails 6.1 / Edge\r\n\r\n**Ruby version**: 3.0.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45767/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45767/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45766","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45766/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45766/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45766/events","html_url":"https://github.com/rails/rails/issues/45766","id":1329650798,"node_id":"I_kwDNIULOT0Dcbg","number":45766,"title":"Active Model Dirty: attribute_changed? options (from/to) do not accept symbol","user":{"login":"thomasvanholder","id":36309895,"node_id":"MDQ6VXNlcjM2MzA5ODk1","avatar_url":"https://avatars.githubusercontent.com/u/36309895?v=4","gravatar_id":"","url":"https://api.github.com/users/thomasvanholder","html_url":"https://github.com/thomasvanholder","followers_url":"https://api.github.com/users/thomasvanholder/followers","following_url":"https://api.github.com/users/thomasvanholder/following{/other_user}","gists_url":"https://api.github.com/users/thomasvanholder/gists{/gist_id}","starred_url":"https://api.github.com/users/thomasvanholder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomasvanholder/subscriptions","organizations_url":"https://api.github.com/users/thomasvanholder/orgs","repos_url":"https://api.github.com/users/thomasvanholder/repos","events_url":"https://api.github.com/users/thomasvanholder/events{/privacy}","received_events_url":"https://api.github.com/users/thomasvanholder/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-05T08:54:51Z","updated_at":"2022-08-07T20:25:55Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nThe `attribute_changed?` receives optional options, such as `from` and `to`. Each option key is passed a value. Only string values are accepted, and symbols are not recognized. This is inconsistent behavior as updating a column using the `update` method does accept both a string and a symbol.\r\n \r\n Source code: [attribute_changed?](https://github.com/rails/rails/blob/04972d9b9ef60796dc8f0917817b5392d61fcf09/activemodel/lib/active_model/dirty.rb#L178) \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"debug\"\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.column :status, :integer, default: 0\r\n    t.date :review_date\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  enum :status, {draft: 0, published: 1}\r\n\r\n  before_update :set_review_date\r\n\r\n  def set_review_date\r\n    # when \"published\" is set as a string, the test correcty passes.\r\n    if status_changed?(to: :published)\r\n      self.review_date = Date.today\r\n    end\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_set_status\r\n    post = Post.create!\r\n    post.update(status: :published)\r\n\r\n    assert_equal \"published\", post.status\r\n  end\r\n\r\n  def test_sets_review_date\r\n    post = Post.create!\r\n    post.published!\r\n\r\n    assert_equal \"published\", post.status\r\n    assert_equal Date.today, post.review_date\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe value of the optional arguments `from` and `to` accepts both a string or symbol.\r\n\r\n### Actual behavior\r\nWhen options, such as `from` and `to` are passed to the [attribute_changed?](https://github.com/rails/rails/blob/04972d9b9ef60796dc8f0917817b5392d61fcf09/activemodel/lib/active_model/dirty.rb#L178) method the arguments are not recognized when passed as a symbol.\r\n\r\n### System configuration\r\n**Rails version**: `Rails 7.0.3`\r\n\r\n**Ruby version**: `ruby 3.1.2`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45766/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45766/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45761","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45761/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45761/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45761/events","html_url":"https://github.com/rails/rails/issues/45761","id":1328855746,"node_id":"I_kwDNIULOTzS6wg","number":45761,"title":"In Ruby on Rails 7.0.3.1 with Bootstrap 5.2 Uglifier error in production mode","user":{"login":"Sega100500","id":584144,"node_id":"MDQ6VXNlcjU4NDE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/584144?v=4","gravatar_id":"","url":"https://api.github.com/users/Sega100500","html_url":"https://github.com/Sega100500","followers_url":"https://api.github.com/users/Sega100500/followers","following_url":"https://api.github.com/users/Sega100500/following{/other_user}","gists_url":"https://api.github.com/users/Sega100500/gists{/gist_id}","starred_url":"https://api.github.com/users/Sega100500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sega100500/subscriptions","organizations_url":"https://api.github.com/users/Sega100500/orgs","repos_url":"https://api.github.com/users/Sega100500/repos","events_url":"https://api.github.com/users/Sega100500/events{/privacy}","received_events_url":"https://api.github.com/users/Sega100500/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-08-04T15:55:37Z","updated_at":"2022-08-05T15:56:08Z","closed_at":"2022-08-05T11:55:10Z","author_association":"NONE","active_lock_reason":null,"body":"Ruby 3.1.2\r\nRuby on Rails 7.0.3.1\r\ngem Uglifier 4.2.0\r\nThird party library: Bootstrap **5.2** ( [new version 5.2 released](https://blog.getbootstrap.com/2022/07/19/bootstrap-5-2-0/) )\r\n\r\n#### With bootstrap 5.1.3 (previous version) all works fine!\r\n\r\n`app/assets/config/manifest.js` :\r\n```javascript\r\n//= link_tree ../images\r\n//= link_directory ../javascripts .js\r\n//= link_directory ../stylesheets .css\r\n\r\n//= link lib/bootstrap/5.2.0/js/bootstrap.bundle.min.js\r\n//= link lib/bootstrap/5.2.0/js/bootstrap.min.js\r\n//= link lib/bootstrap/5.2.0/css/bootstrap.min.css\r\n```\r\n\r\nin view stylesheets and javascripts are attached via `stylesheet_link_tag` and `javascript_include_tag`\r\n\r\n`config/environments/production.rb` :\r\n```ruby\r\nconfig.assets.compile = true\r\nconfig.assets.js_compressor = Uglifier.new(harmony: true)\r\n```\r\n\r\n`log/production.log` :\r\n```log\r\nI, [2022-08-04T20:29:16.542499 #11922]  INFO -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab] Started GET \"/\" for 127.0.0.1 at 2022-08-04 20:29:16 +0500\r\nI, [2022-08-04T20:29:16.545698 #11922]  INFO -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab] Processing by ApplicationBaseController#index as HTML\r\nI, [2022-08-04T20:29:16.554844 #11922]  INFO -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab]   Rendered application_base/index.html.erb within layouts/application (Duration: 0.9ms | Allocations: 314)\r\nI, [2022-08-04T20:29:33.586606 #11922]  INFO -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab]   Rendered layout layouts/application.html.erb (Duration: 17032.8ms | Allocations: 628213)\r\nI, [2022-08-04T20:29:33.586988 #11922]  INFO -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab] Completed 500 Internal Server Error in 17041ms (ActiveRecord: 0.7ms | Allocations: 630135)\r\nF, [2022-08-04T20:29:33.587842 #11922] FATAL -- : [425e1b3d-5d27-4e00-afdf-d698f79e50ab]   \r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] ActionView::Template::Error (\r\n):\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab]   \r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] uglifier (4.2.0) lib/uglifier.rb:291:in `parse_result'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] uglifier (4.2.0) lib/uglifier.rb:221:in `run_uglifyjs'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] uglifier (4.2.0) lib/uglifier.rb:166:in `compile'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/compressing.rb:84:in `block in js_compressor='\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:84:in `call_processor'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:66:in `block in call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `reverse_each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:182:in `load_from_unloaded'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:59:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:337:in `fetch_asset_from_dependency_cache'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:43:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `fetch'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/bundle.rb:32:in `block in call'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] /home/ruby/.rbenv/versions/3.1.2/lib/ruby/3.1.0/set.rb:511:in `each_key'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] /home/ruby/.rbenv/versions/3.1.2/lib/ruby/3.1.0/set.rb:511:in `each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/bundle.rb:31:in `call'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:84:in `call_processor'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:66:in `block in call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `reverse_each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:182:in `load_from_unloaded'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:59:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:337:in `fetch_asset_from_dependency_cache'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:43:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `fetch'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/bundle.rb:32:in `block in call'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] /home/ruby/.rbenv/versions/3.1.2/lib/ruby/3.1.0/set.rb:511:in `each_key'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] /home/ruby/.rbenv/versions/3.1.2/lib/ruby/3.1.0/set.rb:511:in `each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/bundle.rb:31:in `call'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:84:in `call_processor'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:66:in `block in call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `reverse_each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/processor_utils.rb:65:in `call_processors'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:182:in `load_from_unloaded'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:59:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:337:in `fetch_asset_from_dependency_cache'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/loader.rb:43:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `block in load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `fetch'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/cached_environment.rb:44:in `load'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/base.rb:81:in `find_asset'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/base.rb:88:in `find_all_linked_assets'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/manifest.rb:125:in `each'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/manifest.rb:125:in `to_a'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] sprockets (4.1.1) lib/sprockets/manifest.rb:125:in `block (2 levels) in find'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:24:in `block in execute'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:47:in `block in synchronize'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:47:in `synchronize'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/synchronization/mutex_lockable_object.rb:47:in `synchronize'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/safe_task_executor.rb:22:in `execute'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/promise.rb:564:in `block in realize'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:352:in `run_task'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:343:in `block (3 levels) in create_worker'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `loop'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:334:in `block (2 levels) in create_worker'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `catch'\r\n[425e1b3d-5d27-4e00-afdf-d698f79e50ab] concurrent-ruby (1.1.10) lib/concurrent-ruby/concurrent/executor/ruby_thread_pool_executor.rb:333:in `block in create_worker'\r\n```\r\n\r\n#### All other compressors are works with errors in this case\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45761/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45761/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45760","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45760/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45760/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45760/events","html_url":"https://github.com/rails/rails/issues/45760","id":1328194697,"node_id":"I_kwDNIULOTyqkiQ","number":45760,"title":"ActiveRecord does not correctly format a parameterized array of bytes when querying a binary column","user":{"login":"postmodern","id":12671,"node_id":"MDQ6VXNlcjEyNjcx","avatar_url":"https://avatars.githubusercontent.com/u/12671?v=4","gravatar_id":"","url":"https://api.github.com/users/postmodern","html_url":"https://github.com/postmodern","followers_url":"https://api.github.com/users/postmodern/followers","following_url":"https://api.github.com/users/postmodern/following{/other_user}","gists_url":"https://api.github.com/users/postmodern/gists{/gist_id}","starred_url":"https://api.github.com/users/postmodern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/postmodern/subscriptions","organizations_url":"https://api.github.com/users/postmodern/orgs","repos_url":"https://api.github.com/users/postmodern/repos","events_url":"https://api.github.com/users/postmodern/events{/privacy}","received_events_url":"https://api.github.com/users/postmodern/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-04T07:31:38Z","updated_at":"2022-08-04T08:19:08Z","closed_at":"2022-08-04T08:19:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I ran into this bug where I was trying to query a binary column using a parameterized value. I assumed it must require an Array of bytes instead of a binary String. However, this resulted in the Array of bytes being formatted as `a,b,c`, which caused a SQL error.\r\n\r\n### Steps to reproduce\r\n\r\nGemfile:\r\n\r\n```ruby\r\nsource 'https://rubygems.org'\r\n\r\ngem 'activerecord', '~> 7.0'\r\ngem 'sqlite3',      '~> 1.0'\r\n```\r\n\r\ntest.rb:\r\n\r\n```ruby\r\n#!/usr/bin/env ruby\r\n\r\nrequire 'bundler/setup'\r\nrequire 'active_record'\r\n\r\nActiveRecord::Base.establish_connection(\r\n  adapter: 'sqlite3',\r\n  database: 'test.sqlite3'\r\n)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass CreateUsersTable < ActiveRecord::Migration[7.0]\r\n\r\n  def change\r\n    drop_table :users, if_exists: true\r\n    create_table :users do |t|\r\n      t.string :name, null: false\r\n      t.string :email, null: false\r\n      t.binary :bin_data, null: false\r\n      t.index :email, unique: true\r\n    end\r\n  end\r\n\r\nend\r\n\r\nCreateUsersTable.migrate(:up)\r\n\r\nclass User < ActiveRecord::Base\r\n\r\n  attribute :name, :string\r\n  validates :name, presence: true\r\n\r\n  attribute :email, :string\r\n  validates :name, presence:   true,\r\n                   uniqueness: true\r\n\r\nend\r\n\r\nbin_data = String.new(\"\\x00\\x01\\x02\", encoding: Encoding::ASCII_8BIT)\r\nuser = User.create(name: 'Test', email: 'test@example.com', bin_data: bin_data)\r\n\r\np User.where('bin_data = ?', [0x00, 0x01, 0x02])\r\n```\r\n\r\n### Expected behavior\r\n\r\nQueries the `bin_data` column using the special SQLite3 literal binary string syntax of `bin_data = x'000102'`.\r\n\r\n### Actual behavior\r\n\r\n```\r\n==  CreateUsersTable: migrating ===============================================\r\nD, [2022-08-04T00:27:56.376569 #34771] DEBUG -- :    (0.8ms)  SELECT sqlite_version(*)\r\n-- drop_table(:users, {:if_exists=>true})\r\nD, [2022-08-04T00:27:56.631286 #34771] DEBUG -- :    (254.2ms)  DROP TABLE IF EXISTS \"users\"\r\n   -> 0.2547s\r\n-- create_table(:users)\r\nD, [2022-08-04T00:27:56.739408 #34771] DEBUG -- :    (106.4ms)  CREATE TABLE \"users\" (\"id\" integer PRIMARY KEY AUTOINCREMENT NOT NULL, \"name\" varchar NOT NULL, \"email\" varchar NOT NULL, \"bin_data\" blob NOT NULL)\r\nD, [2022-08-04T00:27:56.872967 #34771] DEBUG -- :    (132.7ms)  CREATE UNIQUE INDEX \"index_users_on_email\" ON \"users\" (\"email\")\r\n   -> 0.2413s\r\n==  CreateUsersTable: migrated (0.4965s) ======================================\r\n\r\nD, [2022-08-04T00:27:56.932140 #34771] DEBUG -- :   TRANSACTION (0.1ms)  begin transaction\r\nD, [2022-08-04T00:27:56.933114 #34771] DEBUG -- :   User Exists? (0.7ms)  SELECT 1 AS one FROM \"users\" WHERE \"users\".\"name\" = ? LIMIT ?  [[\"name\", \"Test\"], [\"LIMIT\", 1]]\r\nD, [2022-08-04T00:27:56.934068 #34771] DEBUG -- :   User Create (0.3ms)  INSERT INTO \"users\" (\"name\", \"email\", \"bin_data\") VALUES (?, ?, ?)  [[\"name\", \"Test\"], [\"email\", \"test@example.com\"], [\"bin_data\", \"<3 bytes of binary data>\"]]\r\nD, [2022-08-04T00:27:57.051168 #34771] DEBUG -- :   TRANSACTION (116.8ms)  commit transaction\r\nD, [2022-08-04T00:27:57.053506 #34771] DEBUG -- :   User Load (0.5ms)  SELECT \"users\".* FROM \"users\" WHERE (bin_data = 0,1,2) /* loading for inspect */ LIMIT ?  [[\"LIMIT\", 11]]\r\n/home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `initialize': SQLite3::SQLException: row value misused (ActiveRecord::StatementInvalid)\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `new'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `prepare'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:50:in `block (2 levels) in exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:47:in `block in exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract_adapter.rb:765:in `block in log'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract_adapter.rb:756:in `log'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:46:in `exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/database_statements.rb:560:in `select'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/database_statements.rb:66:in `select_all'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/query_cache.rb:110:in `select_all'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/querying.rb:54:in `_query_by_sql'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:941:in `block in exec_main_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:927:in `exec_main_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:913:in `block in exec_queries'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:907:in `exec_queries'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:695:in `load'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:250:in `records'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:245:in `to_ary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation/finder_methods.rb:528:in `find_take_with_limit'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation/finder_methods.rb:98:in `take'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:795:in `inspect'\r\n\tfrom ./test.rb:42:in `p'\r\n\tfrom ./test.rb:42:in `<main>'\r\n```\r\n\r\n### System configuration\r\n\r\n* libsqlite 3.36.0\r\n* ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n* Gems included by the bundle:\r\n  * activemodel (7.0.3.1)\r\n  * activerecord (7.0.3.1)\r\n  * activesupport (7.0.3.1)\r\n  * bundler (2.3.17)\r\n  * concurrent-ruby (1.1.10)\r\n  * i18n (1.12.0)\r\n  * minitest (5.16.2)\r\n  * sqlite3 (1.4.4)\r\n  * tzinfo (2.0.5)\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45760/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45760/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45759","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45759/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45759/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45759/events","html_url":"https://github.com/rails/rails/issues/45759","id":1328184489,"node_id":"I_kwDNIULOTyp8qQ","number":45759,"title":"ActiveRecord does not correctly parameterize queries against binary columns","user":{"login":"postmodern","id":12671,"node_id":"MDQ6VXNlcjEyNjcx","avatar_url":"https://avatars.githubusercontent.com/u/12671?v=4","gravatar_id":"","url":"https://api.github.com/users/postmodern","html_url":"https://github.com/postmodern","followers_url":"https://api.github.com/users/postmodern/followers","following_url":"https://api.github.com/users/postmodern/following{/other_user}","gists_url":"https://api.github.com/users/postmodern/gists{/gist_id}","starred_url":"https://api.github.com/users/postmodern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/postmodern/subscriptions","organizations_url":"https://api.github.com/users/postmodern/orgs","repos_url":"https://api.github.com/users/postmodern/repos","events_url":"https://api.github.com/users/postmodern/events{/privacy}","received_events_url":"https://api.github.com/users/postmodern/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-08-04T07:22:01Z","updated_at":"2022-08-04T09:15:37Z","closed_at":"2022-08-04T08:49:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I ran into this edge case where I wanted to query a binary column (stored as a SQLite3 BLOB) with a parameterized query. However, ActiveRecord cannot correctly parameterize the binary input String.\r\n\r\n### Steps to reproduce\r\n\r\nGemfile:\r\n\r\n```ruby\r\nsource 'https://rubygems.org'\r\n\r\ngem 'activerecord', '~> 7.0'\r\ngem 'sqlite3',      '~> 1.0'\r\n```\r\n\r\ntest.rb:\r\n\r\n```ruby\r\n#!/usr/bin/env ruby\r\n\r\nrequire 'bundler/setup'\r\nrequire 'active_record'\r\n\r\nActiveRecord::Base.establish_connection(\r\n  adapter: 'sqlite3',\r\n  database: 'test.sqlite3'\r\n)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass CreateUsersTable < ActiveRecord::Migration[7.0]\r\n\r\n  def change\r\n    drop_table :users, if_exists: true\r\n    create_table :users do |t|\r\n      t.string :name, null: false\r\n      t.string :email, null: false\r\n      t.binary :bin_data, null: false\r\n      t.index :email, unique: true\r\n    end\r\n  end\r\n\r\nend\r\n\r\nCreateUsersTable.migrate(:up)\r\n\r\nclass User < ActiveRecord::Base\r\n\r\n  attribute :name, :string\r\n  validates :name, presence: true\r\n\r\n  attribute :email, :string\r\n  validates :name, presence:   true,\r\n                   uniqueness: true\r\n\r\nend\r\n\r\nbin_data = String.new(\"\\x00\\x01\\x02\", encoding: Encoding::ASCII_8BIT)\r\nuser = User.create(name: 'Test', email: 'test@example.com', bin_data: bin_data)\r\n\r\np User.where('bin_data = ?', bin_data)\r\n```\r\n\r\n### Expected behavior\r\n\r\nQueries the `bin_data` column using the special SQLite3 literal binary string syntax of `bin_data = x'000102'`.\r\n\r\n### Actual behavior\r\n\r\n```\r\n==  CreateUsersTable: migrating ===============================================\r\nD, [2022-08-04T00:24:14.636243 #34698] DEBUG -- :    (0.8ms)  SELECT sqlite_version(*)\r\n-- drop_table(:users, {:if_exists=>true})\r\nD, [2022-08-04T00:24:14.761447 #34698] DEBUG -- :    (124.7ms)  DROP TABLE IF EXISTS \"users\"\r\n   -> 0.1253s\r\n-- create_table(:users)\r\nD, [2022-08-04T00:24:14.911818 #34698] DEBUG -- :    (148.3ms)  CREATE TABLE \"users\" (\"id\" integer PRIMARY KEY AUTOINCREMENT NOT NULL, \"name\" varchar NOT NULL, \"email\" varchar NOT NULL, \"bin_data\" blob NOT NULL)\r\nD, [2022-08-04T00:24:15.011456 #34698] DEBUG -- :    (97.7ms)  CREATE UNIQUE INDEX \"index_users_on_email\" ON \"users\" (\"email\")\r\n   -> 0.2497s\r\n==  CreateUsersTable: migrated (0.3754s) ======================================\r\n\r\nD, [2022-08-04T00:24:15.070114 #34698] DEBUG -- :   TRANSACTION (0.1ms)  begin transaction\r\nD, [2022-08-04T00:24:15.071669 #34698] DEBUG -- :   User Exists? (1.1ms)  SELECT 1 AS one FROM \"users\" WHERE \"users\".\"name\" = ? LIMIT ?  [[\"name\", \"Test\"], [\"LIMIT\", 1]]\r\nD, [2022-08-04T00:24:15.073721 #34698] DEBUG -- :   User Create (0.6ms)  INSERT INTO \"users\" (\"name\", \"email\", \"bin_data\") VALUES (?, ?, ?)  [[\"name\", \"Test\"], [\"email\", \"test@example.com\"], [\"bin_data\", \"<3 bytes of binary data>\"]]\r\nD, [2022-08-04T00:24:15.193240 #34698] DEBUG -- :   TRANSACTION (119.0ms)  commit transaction\r\nD, [2022-08-04T00:24:15.209975 #34698] DEBUG -- :   User Load (0.4ms)  SELECT \"users\".* FROM \"users\" WHERE (bin_data = '') /* loading for inspect */ LIMIT ?  [[\"LIMIT\", 11]]\r\n/home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `initialize': SQLite3::SQLException: unrecognized token: \"'\" (ActiveRecord::StatementInvalid)\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `new'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/sqlite3-1.4.4/lib/sqlite3/database.rb:152:in `prepare'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:50:in `block (2 levels) in exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:47:in `block in exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract_adapter.rb:765:in `block in log'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.3.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract_adapter.rb:756:in `log'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3/database_statements.rb:46:in `exec_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/database_statements.rb:560:in `select'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/database_statements.rb:66:in `select_all'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/abstract/query_cache.rb:110:in `select_all'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/querying.rb:54:in `_query_by_sql'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:941:in `block in exec_main_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:927:in `exec_main_query'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:913:in `block in exec_queries'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:907:in `exec_queries'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:695:in `load'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:250:in `records'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:245:in `to_ary'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation/finder_methods.rb:528:in `find_take_with_limit'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation/finder_methods.rb:98:in `take'\r\n\tfrom /home/postmodern/test/ruby/activerecord/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/relation.rb:795:in `inspect'\r\n\tfrom ./test.rb:42:in `p'\r\n\tfrom ./test.rb:42:in `<main>'\r\n```\r\n\r\n### System configuration\r\n\r\n* ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n* libsqlite3 3.36.0\r\n* Gems included by the bundle:\r\n  * activemodel (7.0.3.1)\r\n  * activerecord (7.0.3.1)\r\n  * activesupport (7.0.3.1)\r\n  * bundler (2.3.17)\r\n  * concurrent-ruby (1.1.10)\r\n  * i18n (1.12.0)\r\n  * minitest (5.16.2)\r\n  * sqlite3 (1.4.4)\r\n  * tzinfo (2.0.5)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45759/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45759/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45758","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45758/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45758/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45758/events","html_url":"https://github.com/rails/rails/issues/45758","id":1327892229,"node_id":"I_kwDNIULOTyYHBQ","number":45758,"title":"ActiveRecord 6.1 and JSONB: Incorrect results value/type when using both arrow operator and double arrow operator in the same SELECT statement","user":{"login":"shhavel","id":1169424,"node_id":"MDQ6VXNlcjExNjk0MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1169424?v=4","gravatar_id":"","url":"https://api.github.com/users/shhavel","html_url":"https://github.com/shhavel","followers_url":"https://api.github.com/users/shhavel/followers","following_url":"https://api.github.com/users/shhavel/following{/other_user}","gists_url":"https://api.github.com/users/shhavel/gists{/gist_id}","starred_url":"https://api.github.com/users/shhavel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shhavel/subscriptions","organizations_url":"https://api.github.com/users/shhavel/orgs","repos_url":"https://api.github.com/users/shhavel/repos","events_url":"https://api.github.com/users/shhavel/events{/privacy}","received_events_url":"https://api.github.com/users/shhavel/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-08-03T23:42:39Z","updated_at":"2022-08-05T22:26:04Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Issue Description\r\n\r\nGenerally when using JSONB operators `->` (arrow operator) and `->>` (double arrow operator) in SELECT statement, \r\nActiveRecord returns correct result types: objects for `->` operator and string for `->>` operator.\r\nBut when using both operators in the same select statement, the returned results may have an unexpected type or be `nil`.\r\n\r\n### Steps to reproduce with Expected behaviour in tests and Actual behaviour in comments\r\n\r\n```ruby\r\n# file: activerecord_6_1_jsonb_test.rb\r\n# run: ruby activerecord_6_1_jsonb_test.rb\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activerecord\", \"6.1.6.1\" # the same behaviour for version \"7.0.3.1\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\npg_opts = {adapter: \"postgresql\", database: \"jsonb_activerecord_issue\"}\r\nbegin\r\n  ActiveRecord::Base.establish_connection(pg_opts.except(:database))\r\n  ActiveRecord::Base.connection.create_database(pg_opts[:database])\r\n  puts \"Database #{pg_opts[:database]} was created.\"\r\nrescue => ActiveRecord::DatabaseAlreadyExists\r\n  puts \"Database #{pg_opts[:database]} alredy exists.\"\r\nend\r\nActiveRecord::Base.establish_connection(pg_opts)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :entries, force: true do |t|\r\n    t.jsonb :value\r\n  end\r\nend\r\n\r\nclass Entry < ActiveRecord::Base\r\nend\r\nEntry.create(value: {a: \"a\", b: \"b\", c: {}})\r\n\r\nclass BugTest < Minitest::Test\r\n  # passed\r\n  def test_jsonb_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->'a', value->'b'\"))\r\n    assert_equal [[{}, \"b\"]], Entry.pluck(Arel.sql(\"value->'c', value->'b'\"))\r\n  end\r\n\r\n  # passed\r\n  def test_jsonb_double_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'a', value->>'b'\"))\r\n    assert_equal [[\"{}\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'c', value->>'b'\"))\r\n  end\r\n\r\n  # failed (this test results are differ in activerecord 6.0)\r\n  def test_jsonb_arrow_operator_and_double_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->'a', value->>'b'\")) # Actual [[\"a\", nil]]\r\n    assert_equal [[{}, \"b\"]], Entry.pluck(Arel.sql(\"value->'c', value->>'b'\")) # Actual [[{}, nil]]\r\n  end\r\n\r\n  # failed\r\n  def test_jsonb_double_arrow_operator_and_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'a', value->'b'\")) # Actual [[nil, \"b\"]]\r\n    assert_equal [[\"{}\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'c', value->'b'\")) # Actual [[{}, \"b\"]]\r\n  end\r\nend\r\n```\r\n\r\n### PostgreSQL results \r\n\r\n```sql\r\nSELECT\r\n  pg_typeof(value->'a'), value->'a',\r\n  pg_typeof(value->'b'), value->'b',\r\n  pg_typeof(value->'c'), value->'c',\r\n  pg_typeof(value->>'a'), value->>'a',\r\n  pg_typeof(value->>'b'), value->>'b',\r\n  pg_typeof(value->>'c'), value->>'c'\r\nFROM \"entries\";\r\n\r\n pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column?\r\n-----------+----------+-----------+----------+-----------+----------+-----------+----------+-----------+----------+-----------+----------\r\n jsonb     | \"a\"      | jsonb     | \"b\"      | jsonb     | {}       | text      | a        | text      | b        | text      | {}\r\n(1 row)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 3.1.0\r\n\r\n### Similar issue in different versions of ActiveRecord\r\n\r\nThere is a similar issue but with slightly different behaviour in AR 6.0. Created another issue: #45757\r\n\r\nPlease confirm or comment on the expected behaviour.\r\nThank you.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45758/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45758/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45757","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45757/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45757/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45757/events","html_url":"https://github.com/rails/rails/issues/45757","id":1327892069,"node_id":"I_kwDNIULOTyYGZQ","number":45757,"title":"ActiveRecord 6.0 and JSONB: Incorrect results value/type when using both arrow operator and double arrow operator in the same SELECT statement","user":{"login":"shhavel","id":1169424,"node_id":"MDQ6VXNlcjExNjk0MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/1169424?v=4","gravatar_id":"","url":"https://api.github.com/users/shhavel","html_url":"https://github.com/shhavel","followers_url":"https://api.github.com/users/shhavel/followers","following_url":"https://api.github.com/users/shhavel/following{/other_user}","gists_url":"https://api.github.com/users/shhavel/gists{/gist_id}","starred_url":"https://api.github.com/users/shhavel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shhavel/subscriptions","organizations_url":"https://api.github.com/users/shhavel/orgs","repos_url":"https://api.github.com/users/shhavel/repos","events_url":"https://api.github.com/users/shhavel/events{/privacy}","received_events_url":"https://api.github.com/users/shhavel/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-03T23:42:16Z","updated_at":"2022-08-04T00:26:13Z","closed_at":"2022-08-04T00:26:13Z","author_association":"NONE","active_lock_reason":null,"body":"### Issue Description\r\n\r\nGenerally when using JSONB operators `->` (arrow operator) and `->>` (double arrow operator) in SELECT statement, \r\nActiveRecord returns correct result types: objects for `->` operator and string for `->>` operator.\r\nBut when using both operators in the same select statement, the returned results may have an unexpected type or be `nil`.\r\n\r\n### Steps to reproduce with Expected behaviour in tests and Actual behaviour in comments\r\n\r\n```ruby\r\n# file: activerecord_6_0_jsonb_test.rb\r\n# run: ruby activerecord_6_0_jsonb_test.rb\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activerecord\", \"6.0.5.1\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\npg_opts = {adapter: \"postgresql\", database: \"jsonb_activerecord_issue\"}\r\nbegin\r\n  ActiveRecord::Base.establish_connection(pg_opts.except(:database))\r\n  ActiveRecord::Base.connection.create_database(pg_opts[:database])\r\n  puts \"Database #{pg_opts[:database]} was created.\"\r\nrescue => ActiveRecord::DatabaseAlreadyExists\r\n  puts \"Database #{pg_opts[:database]} alredy exists.\"\r\nend\r\nActiveRecord::Base.establish_connection(pg_opts)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :entries, force: true do |t|\r\n    t.jsonb :value\r\n  end\r\nend\r\n\r\nclass Entry < ActiveRecord::Base\r\nend\r\nEntry.create(value: {a: \"a\", b: \"b\", c: {}})\r\n\r\nclass BugTest < Minitest::Test\r\n  # passed\r\n  def test_jsonb_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->'a', value->'b'\"))\r\n    assert_equal [[{}, \"b\"]], Entry.pluck(Arel.sql(\"value->'c', value->'b'\"))\r\n  end\r\n\r\n  # passed\r\n  def test_jsonb_double_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'a', value->>'b'\"))\r\n    assert_equal [[\"{}\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'c', value->>'b'\"))\r\n  end\r\n\r\n  # failed (this test results are differ in activerecord 6.1)\r\n  def test_jsonb_arrow_operator_and_double_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->'a', value->>'b'\")) # Actual [[\"\\\"a\\\"\", \"b\"]]\r\n    assert_equal [[{}, \"b\"]], Entry.pluck(Arel.sql(\"value->'c', value->>'b'\")) # Actual [[\"{}\", \"b\"]]\r\n  end\r\n\r\n  # failed\r\n  def test_jsonb_double_arrow_operator_and_arrow_operator\r\n    assert_equal [[\"a\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'a', value->'b'\")) # Actual [[nil, \"b\"]]\r\n    assert_equal [[\"{}\", \"b\"]], Entry.pluck(Arel.sql(\"value->>'c', value->'b'\")) # Actual [[{}, \"b\"]]\r\n  end\r\nend\r\n```\r\n\r\n### PostgreSQL results \r\n\r\n```sql\r\nSELECT\r\n  pg_typeof(value->'a'), value->'a',\r\n  pg_typeof(value->'b'), value->'b',\r\n  pg_typeof(value->'c'), value->'c',\r\n  pg_typeof(value->>'a'), value->>'a',\r\n  pg_typeof(value->>'b'), value->>'b',\r\n  pg_typeof(value->>'c'), value->>'c'\r\nFROM \"entries\";\r\n\r\n pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column? | pg_typeof | ?column?\r\n-----------+----------+-----------+----------+-----------+----------+-----------+----------+-----------+----------+-----------+----------\r\n jsonb     | \"a\"      | jsonb     | \"b\"      | jsonb     | {}       | text      | a        | text      | b        | text      | {}\r\n(1 row)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.0.5.1\r\n\r\n**Ruby version**: 3.1.0\r\n\r\n### Similar issue in different versions of ActiveRecord\r\n\r\nThere is a similar issue but with slightly different behaviour in AR 6.1 and 7.0. Created another issue: #45758\r\n\r\nPlease confirm or comment on the expected behaviour.\r\nThank you.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45757/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45757/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45750","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45750/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45750/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45750/events","html_url":"https://github.com/rails/rails/issues/45750","id":1327484205,"node_id":"I_kwDNIULOTx_NLQ","number":45750,"title":"Running `rails test` doesn't automatically load any custom tasks under `lib/tasks`","user":{"login":"onlynone","id":833690,"node_id":"MDQ6VXNlcjgzMzY5MA==","avatar_url":"https://avatars.githubusercontent.com/u/833690?v=4","gravatar_id":"","url":"https://api.github.com/users/onlynone","html_url":"https://github.com/onlynone","followers_url":"https://api.github.com/users/onlynone/followers","following_url":"https://api.github.com/users/onlynone/following{/other_user}","gists_url":"https://api.github.com/users/onlynone/gists{/gist_id}","starred_url":"https://api.github.com/users/onlynone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/onlynone/subscriptions","organizations_url":"https://api.github.com/users/onlynone/orgs","repos_url":"https://api.github.com/users/onlynone/repos","events_url":"https://api.github.com/users/onlynone/events{/privacy}","received_events_url":"https://api.github.com/users/onlynone/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-08-03T16:16:38Z","updated_at":"2022-08-03T18:09:40Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create the file `lib/tasks/test.rake` with the content:\r\n```ruby\r\nENV[\"test.rake\"] = \"yes\"\r\ntask :custom_task do\r\n  ENV[\"custom_task\"] = \"yes\"\r\nend\r\n\r\ntask :test => [:custom_task]\r\n```\r\n2. Create a test file at `test/unit/rails_test_test.rb` with the content:\r\n```ruby\r\nclass RailsTestTest < ActiveSupport::TestCase\r\n  test \"test.rake is in the environment\" do\r\n    assert_equal('yes', ENV['test.rake'])\r\n  end\r\n\r\n  test \"custom_task is in the environment\" do\r\n    assert_equal('yes', ENV['custom_task'])\r\n  end\r\nend\r\n```\r\n3. Run `bin/rails test test/unit/rails_test_test.rb`\r\n4. Run `bin/rake test test/unit/rails_test_test.rb`\r\n\r\n### Expected behavior\r\nBoth `rails test` and `rake test` should succeed.\r\n\r\n### Actual behavior\r\nRunning the tests with `bin/rake` succeeds with the output:\r\n```\r\nbin/rake test test/unit/rails_test_test.rb\r\nRunning via Spring preloader in process 59092\r\nRun options: --seed 6948\r\n\r\n# Running:\r\n\r\n..\r\n\r\nFinished in 0.000943s, 2120.8907 runs/s, 2120.8907 assertions/s.\r\n2 runs, 2 assertions, 0 failures, 0 errors, 0 skips\r\n```\r\n\r\nWhile running with `bin/rails` fails with the output:\r\n\r\n```\r\nRunning via Spring preloader in process 58735\r\nRun options: --seed 33633\r\n\r\n# Running:\r\n\r\nF\r\n\r\nFailure:\r\nRailsTestTest#test_custom_task_is_in_the_environment [/Users/steven/projects/rails_test_tasks/test/unit/rails_test_test.rb:7]:\r\nExpected: \"yes\"\r\n  Actual: nil\r\n\r\n\r\nrails test test/unit/rails_test_test.rb:6\r\n\r\nF\r\n\r\nFailure:\r\nRailsTestTest#test_test.rake_is_in_the_environment [/Users/steven/projects/rails_test_tasks/test/unit/rails_test_test.rb:3]:\r\nExpected: \"yes\"\r\n  Actual: nil\r\n\r\n\r\nrails test test/unit/rails_test_test.rb:2\r\n\r\n\r\n\r\nFinished in 0.001378s, 1451.3788 runs/s, 1451.3788 assertions/s.\r\n2 runs, 2 assertions, 2 failures, 0 errors, 0 skips\r\n```\r\n\r\nBecause the file `lib/tasks/test.rake` is never loaded.\r\n\r\nIt seems like rails will only end up loading custom tasks if it can't find the command being run on the command line in its own list of built-in commands. When it can't find the command, it will load the local `Rakefile` via `find_by_namespace(\"rake\").perform(full_namespace, args, config)` in `Rails::Command.invoke`. And the local `Rakefile` usually has `Rails.application.load_tasks` and that loads any custom tasks under `lib/tasks`.\r\n\r\nFor example, this happens when the `ActiveRecord` migration exec's out to call: `bin/rails db:test:prepare`. That task is apparently not a built-in rails task, so the `Rakefile` and all custom tasks *do* end up getting loaded for that one.\r\n\r\n(As an aside here, I don't fully understand the difference between the built-in rails tasks and the ones that have to be searched for via rake. I also don't understand why the migration code needs to fork a separate process to do `db:test:prepare`. That task just ends up doing `db_namespace[\"test:load\"].invoke`. Why couldn't the `db:test:prepare` tasks simply be invoked the same way in the same process?)\r\n\r\n### System configuration\r\n**Rails version**: 6.0.5\r\n\r\n**Ruby version**: 2.6.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45750/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45750/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45746","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45746/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45746/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45746/events","html_url":"https://github.com/rails/rails/issues/45746","id":1327035899,"node_id":"I_kwDNIULOTxj1-w","number":45746,"title":"Feature request/suggestion: add \"exist?\" aliases to \"exists?\" methods","user":{"login":"marvinthepa","id":51218,"node_id":"MDQ6VXNlcjUxMjE4","avatar_url":"https://avatars.githubusercontent.com/u/51218?v=4","gravatar_id":"","url":"https://api.github.com/users/marvinthepa","html_url":"https://github.com/marvinthepa","followers_url":"https://api.github.com/users/marvinthepa/followers","following_url":"https://api.github.com/users/marvinthepa/following{/other_user}","gists_url":"https://api.github.com/users/marvinthepa/gists{/gist_id}","starred_url":"https://api.github.com/users/marvinthepa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marvinthepa/subscriptions","organizations_url":"https://api.github.com/users/marvinthepa/orgs","repos_url":"https://api.github.com/users/marvinthepa/repos","events_url":"https://api.github.com/users/marvinthepa/events{/privacy}","received_events_url":"https://api.github.com/users/marvinthepa/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-08-03T10:53:22Z","updated_at":"2022-08-03T15:12:36Z","closed_at":"2022-08-03T15:12:36Z","author_association":"NONE","active_lock_reason":null,"body":"Rationale:\r\nRubys [`File.exist?`](https://rubyapi.org/3.1/o/file#method-c-exist-3F) used to have an alias `File.exists?`, but it was deprecated and removed: https://bugs.ruby-lang.org/issues/17391\r\n\r\nRails methods that do a similar thing are (still) called `exists?`, and no alias exists (no pun intended).\r\nThis makes for a sub-optimal developer experience, as $developer always needs to remember where to include the s, and where to leave it off.\r\n\r\nI would suggest adding aliases to all `exists?` methods, e.g.\r\nhttps://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F\r\nhttps://api.rubyonrails.org/classes/ActiveRecord/Encryption/ExtendedDeterministicQueries/RelationQueries.html#method-i-exists-3F\r\nhttps://api.rubyonrails.org/classes/ActionView/LookupContext/ViewPaths.html#method-i-exists-3F\r\nhttps://api.rubyonrails.org/classes/ActionMailer/Preview.html#method-c-exists-3F\r\n\r\nIt is then possible to deprecate the `exists?` version (and eventually remove it) to become fully consistent to ruby, but for me personally it would be sufficient to have the alias around. I just would like to use the same variant everywhere.\r\n\r\nFeel free to close this if you think it is okay as-is - just a suggestion.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45746/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45746/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45742","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45742/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45742/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45742/events","html_url":"https://github.com/rails/rails/issues/45742","id":1326859212,"node_id":"I_kwDNIULOTxZDzA","number":45742,"title":"`change_column_null` resets collation","user":{"login":"c960657","id":111346,"node_id":"MDQ6VXNlcjExMTM0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/111346?v=4","gravatar_id":"","url":"https://api.github.com/users/c960657","html_url":"https://github.com/c960657","followers_url":"https://api.github.com/users/c960657/followers","following_url":"https://api.github.com/users/c960657/following{/other_user}","gists_url":"https://api.github.com/users/c960657/gists{/gist_id}","starred_url":"https://api.github.com/users/c960657/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c960657/subscriptions","organizations_url":"https://api.github.com/users/c960657/orgs","repos_url":"https://api.github.com/users/c960657/repos","events_url":"https://api.github.com/users/c960657/events{/privacy}","received_events_url":"https://api.github.com/users/c960657/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-08-03T08:24:27Z","updated_at":"2022-08-03T13:26:11Z","closed_at":"2022-08-03T12:53:50Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"`change_column_null` changes the column's collation to the table's default collation.\r\n\r\nThis bug is visible when changing a column whose collation differs from the table's default collation.\r\n\r\nTested with MySQL.\r\n\r\n### Steps to reproduce\r\nRun this migration:\r\n```\r\nclass TestCase < ActiveRecord::Migration[7.0]\r\n  def change\r\n    create_table :utf8_table, id: :integer, charset: :utf8mb4, collation: :utf8mb4_unicode_ci do |t|\r\n      t.string :utf8_col_1, collation: :utf8mb4_unicode_ci, null: false\r\n      t.string :utf8_col_2, collation: :utf8mb4_unicode_ci, null: true\r\n      t.string :ascii_col_1, collation: :ascii_general_ci, null: false\r\n      t.string :ascii_col_2, collation: :ascii_general_ci, null: true\r\n    end\r\n\r\n    change_column_null :utf8_table, :utf8_col_2, false\r\n    change_column_null :utf8_table, :ascii_col_2, false\r\n\r\n    create_table :ascii_table, id: :integer, charset: :ascii, collation: :ascii_general_ci do |t|\r\n      t.string :utf8_col_1, collation: :utf8mb4_unicode_ci, null: false\r\n      t.string :utf8_col_2, collation: :utf8mb4_unicode_ci, null: true\r\n      t.string :ascii_col_1, collation: :ascii_general_ci, null: false\r\n      t.string :ascii_col_2, collation: :ascii_general_ci, null: true\r\n    end\r\n\r\n    change_column_null :ascii_table, :utf8_col_2, false\r\n    change_column_null :ascii_table, :ascii_col_2, false\r\n  end\r\nend\r\n```\r\n\r\nThe end result is that all columns should be NOT NULL. The `_col_1` columns are set to `NOT NULL` in `create_table`, and the `_col_2`  columns are changed later with `change_column_null`.\r\n\r\n### Expected behavior\r\n`change_column_null` should preserve the column's collation, so that the `_col_1` and `_col_2` definitions are identical even though the null-ness on `_col_2` columns was changed after the initial `create_table`.\r\n\r\nThe the table should look like this, so that `utf8_col_1` and `utf8_col_2` are defined identically in each table, and likewise for `ascii_col_1`/`ascii_col_2`:\r\n```\r\nCREATE TABLE `ascii_table` (\r\n  `id` int NOT NULL AUTO_INCREMENT,\r\n  `utf8_col_1` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `utf8_col_2` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `ascii_col_1` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL,\r\n  `ascii_col_2` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT ,\r\n  PRIMARY KEY (`id`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=ascii;\r\n\r\nCREATE TABLE `utf8_table` (\r\n  `id` int NOT NULL AUTO_INCREMENT,\r\n  `utf8_col_1` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `utf8_col_2` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `ascii_col_1` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL,\r\n  `ascii_col_2` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL,\r\n  PRIMARY KEY (`id`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n```\r\n\r\n### Actual behavior\r\nThe special `CHARACTER SET` and `COLLATE` directives are missing from the columns whose collation differs from the table default column.\r\n```\r\nCREATE TABLE `ascii_table` (\r\n  `id` int NOT NULL AUTO_INCREMENT,\r\n  `utf8_col_1` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `utf8_col_2` varchar(255) NOT NULL,\r\n  `ascii_col_1` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL,\r\n  `ascii_col_2` varchar(255) NOT NULL,\r\n  PRIMARY KEY (`id`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=ascii;\r\n\r\nCREATE TABLE `utf8_table` (\r\n  `id` int NOT NULL AUTO_INCREMENT,\r\n  `utf8_col_1` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `utf8_col_2` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  `ascii_col_1` varchar(255) CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL,\r\n  `ascii_col_2` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,\r\n  PRIMARY KEY (`id`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3\r\n\r\n**Ruby version**:\r\n3.1.2p20\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45742/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45742/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45736","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45736/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45736/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45736/events","html_url":"https://github.com/rails/rails/issues/45736","id":1326221102,"node_id":"I_kwDNIULOTwyHLg","number":45736,"title":"Virtual stored columns are always nil for newly created records","user":{"login":"camiloforero","id":6606686,"node_id":"MDQ6VXNlcjY2MDY2ODY=","avatar_url":"https://avatars.githubusercontent.com/u/6606686?v=4","gravatar_id":"","url":"https://api.github.com/users/camiloforero","html_url":"https://github.com/camiloforero","followers_url":"https://api.github.com/users/camiloforero/followers","following_url":"https://api.github.com/users/camiloforero/following{/other_user}","gists_url":"https://api.github.com/users/camiloforero/gists{/gist_id}","starred_url":"https://api.github.com/users/camiloforero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/camiloforero/subscriptions","organizations_url":"https://api.github.com/users/camiloforero/orgs","repos_url":"https://api.github.com/users/camiloforero/repos","events_url":"https://api.github.com/users/camiloforero/events{/privacy}","received_events_url":"https://api.github.com/users/camiloforero/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-02T18:09:28Z","updated_at":"2022-08-02T19:28:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nUsing postgresql:\r\n\r\nGenerate a new model with one or more columns with default values, and a virtual stored column based on those other columns\r\nCreate a new record of that model\r\nAccess the value of the virtual stored column from the newly created ActiveRecord object\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem 'pg', '~> 1.4'\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection \"postgresql:///test\"\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.integer :counter1, null: false, default: 0\r\n    t.integer :counter2, null: false, default: 0\r\n    t.virtual :counter_sum, type: :integer, as: \"counter1 + counter2\", stored: true\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_virtual_column_value_populated\r\n    post = Post.create!\r\n\r\n    assert_equal 0, post.counter_sum\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe value of the virtual column should be *something*, in this particular case, 0\r\n\r\n### Actual behavior\r\nThe value of the virtual column is `nil`. The test fails with the following output\r\n```ruby\r\n# Running:\r\n\r\nD, [2022-08-02T13:05:17.402730 #13548] DEBUG -- :   TRANSACTION (0.1ms)  BEGIN\r\nD, [2022-08-02T13:05:17.403136 #13548] DEBUG -- :   Post Create (0.6ms)  INSERT INTO \"posts\" DEFAULT VALUES RETURNING \"id\"\r\nD, [2022-08-02T13:05:17.406144 #13548] DEBUG -- :   TRANSACTION (2.6ms)  COMMIT\r\nF\r\n\r\nFailure:\r\nBugTest#test_virtual_column_value_populated [stored_bug.rb:37]:\r\nExpected: 0\r\n  Actual: nil\r\n\r\n\r\nrails test stored_bug.rb:34\r\n\r\n\r\n\r\nFinished in 0.011047s, 90.5240 runs/s, 90.5240 assertions/s.\r\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### System configuration\r\n**Rails version**: edge\r\n**Ruby version**: 3.1.2\r\n**PostgreSQL version**: 14.4\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45736/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45736/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45725","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45725/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45725/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45725/events","html_url":"https://github.com/rails/rails/issues/45725","id":1324884548,"node_id":"I_kwDNIULOTvgiRA","number":45725,"title":"Testing an invalid resource as turbo_stream format","user":{"login":"david-hello-world","id":110423719,"node_id":"U_kgDOBpTupw","avatar_url":"https://avatars.githubusercontent.com/u/110423719?v=4","gravatar_id":"","url":"https://api.github.com/users/david-hello-world","html_url":"https://github.com/david-hello-world","followers_url":"https://api.github.com/users/david-hello-world/followers","following_url":"https://api.github.com/users/david-hello-world/following{/other_user}","gists_url":"https://api.github.com/users/david-hello-world/gists{/gist_id}","starred_url":"https://api.github.com/users/david-hello-world/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/david-hello-world/subscriptions","organizations_url":"https://api.github.com/users/david-hello-world/orgs","repos_url":"https://api.github.com/users/david-hello-world/repos","events_url":"https://api.github.com/users/david-hello-world/events{/privacy}","received_events_url":"https://api.github.com/users/david-hello-world/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-08-01T19:39:11Z","updated_at":"2022-08-03T16:31:44Z","closed_at":"2022-08-03T16:11:06Z","author_association":"NONE","active_lock_reason":null,"body":"I've faced what I think is an inconsistency between testing an invalid resource in an integration test, and testing it using the browser. Explanation:\r\n\r\nI have this create action (modified from a scaffold generated by Rails):\r\n\r\n```ruby\r\ndef create\r\n  @post = Post.new(post_params)\r\n\r\n  respond_to do |format|\r\n    if @post.save\r\n      format.html { redirect_to post_url(@post), notice: \"Post was successfully created.\" }\r\n      format.json { render :show, status: :created, location: @post }\r\n      format.turbo_stream\r\n    else\r\n      format.html { render :new, status: :unprocessable_entity }\r\n      format.json { render json: @post.errors, status: :unprocessable_entity }\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nIn the browser this works correctly:\r\n\r\n- If post is valid, it responds as turbo-stream, adding the new post to the list with JS.\r\n- If post is invalid, it displays the \"error prohibited this post from being saved\" message, and lists the validation error/s **responding as turbo-stream as well.**\r\n\r\nI want to focus on the second case, when the post is invalid. The request is a post method, using a fetch type, which is correct. And it gets a 422 status in the response, using a turbo-frame.\r\n\r\nThen I have this integration test:\r\n\r\n```ruby\r\nclass CreatePostTest < ActionDispatch::IntegrationTest\r\n  def post_params\r\n    { title: 'Some title',\r\n      body: 'Some text' }\r\n  end\r\n\r\n  test 'cannot create an invalid post' do\r\n    post posts_path(format: :turbo_stream),\r\n          params: { post: { title: '', body: '' } }\r\n\r\n    assert_response 422\r\n  end\r\n\r\n  test 'create a valid post' do\r\n    post posts_path(format: :turbo_stream),\r\n          params: { post: { title: 'Some title', body: 'Some text' } }\r\n\r\n    assert_response 200\r\n  end\r\nend\r\n```\r\n\r\nAfter running it, the \"valid post\" test passes, but the invalid one fails with this error:\r\n\r\n> Error: CreatePostTest#test_cannot_create_an_invalid_post: ActionController::UnknownFormat: ActionController::UnknownFormat app/controllers/posts_controller.rb:26:in 'create' test/integration/create_post_test.rb:12:in 'block in class:CreatePostTest'\r\n\r\nSo it's basically saying that it doesn't know how to respond with turbo-stream format. This is expected because the `else` in the controller doesn't implement the `turbo_stream` format. The solution is to remove `format: :turbo_stream` from the `posts_path`.\r\n\r\nWhy must I specify the path without a format (and therefore default to HTML), and in the browser it works correctly responding as turbo-stream? Isn't this an inconsistency?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45725/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45725/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45713","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45713/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45713/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45713/events","html_url":"https://github.com/rails/rails/issues/45713","id":1323426557,"node_id":"I_kwDNIULOTuHi_Q","number":45713,"title":"Rails Active Storage image variant flipped upside down","user":{"login":"zaouch","id":31248577,"node_id":"MDQ6VXNlcjMxMjQ4NTc3","avatar_url":"https://avatars.githubusercontent.com/u/31248577?v=4","gravatar_id":"","url":"https://api.github.com/users/zaouch","html_url":"https://github.com/zaouch","followers_url":"https://api.github.com/users/zaouch/followers","following_url":"https://api.github.com/users/zaouch/following{/other_user}","gists_url":"https://api.github.com/users/zaouch/gists{/gist_id}","starred_url":"https://api.github.com/users/zaouch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zaouch/subscriptions","organizations_url":"https://api.github.com/users/zaouch/orgs","repos_url":"https://api.github.com/users/zaouch/repos","events_url":"https://api.github.com/users/zaouch/events{/privacy}","received_events_url":"https://api.github.com/users/zaouch/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-31T10:48:53Z","updated_at":"2022-08-04T22:01:51Z","closed_at":"2022-08-04T22:01:51Z","author_association":"NONE","active_lock_reason":null,"body":"When rendering a rails active storage image variant as follows:\r\n\r\n```ruby\r\n<%=image_tag(current_user.avatar.variant(resize_to_limit:[200, 200])) %>\r\n```\r\nThe image gets flipped upside down. I have tried to remove the EXIF metadata by setting the `auto_orient` option as `true` like suggested [here](https://rubyflow.com/p/qqivs1-activestorage-variants-are-persisting-original-image-exif-metadata) without success. This is definitely a rails bug because as soon as I remove the variant method, the original image displays correctly.\r\n\r\n\r\nNote that I am uploading picture captured by iphone devices. Here is [the image I used](https://easyupload.io/9fu47q).\r\n\r\n### Expected behavior\r\nResized Image variant should be displayed as is. \r\n\r\n### Actual behavior\r\nResized Image variant is displayed flipped upside down.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 3.1.1p18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45713/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45713/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45712","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45712/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45712/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45712/events","html_url":"https://github.com/rails/rails/issues/45712","id":1323390556,"node_id":"I_kwDNIULOTuFWXA","number":45712,"title":"Yhing","user":{"login":"Quidstein","id":110324767,"node_id":"U_kgDOBpNsHw","avatar_url":"https://avatars.githubusercontent.com/u/110324767?v=4","gravatar_id":"","url":"https://api.github.com/users/Quidstein","html_url":"https://github.com/Quidstein","followers_url":"https://api.github.com/users/Quidstein/followers","following_url":"https://api.github.com/users/Quidstein/following{/other_user}","gists_url":"https://api.github.com/users/Quidstein/gists{/gist_id}","starred_url":"https://api.github.com/users/Quidstein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Quidstein/subscriptions","organizations_url":"https://api.github.com/users/Quidstein/orgs","repos_url":"https://api.github.com/users/Quidstein/repos","events_url":"https://api.github.com/users/Quidstein/events{/privacy}","received_events_url":"https://api.github.com/users/Quidstein/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-31T07:58:03Z","updated_at":"2022-07-31T15:33:37Z","closed_at":"2022-07-31T15:33:37Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45712/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45712/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45710","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45710/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45710/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45710/events","html_url":"https://github.com/rails/rails/issues/45710","id":1323314633,"node_id":"I_kwDNIULOTuAtyQ","number":45710,"title":"Model.upsert_all raises ArgumentError if passed an empty array","user":{"login":"dhnaranjo","id":536280,"node_id":"MDQ6VXNlcjUzNjI4MA==","avatar_url":"https://avatars.githubusercontent.com/u/536280?v=4","gravatar_id":"","url":"https://api.github.com/users/dhnaranjo","html_url":"https://github.com/dhnaranjo","followers_url":"https://api.github.com/users/dhnaranjo/followers","following_url":"https://api.github.com/users/dhnaranjo/following{/other_user}","gists_url":"https://api.github.com/users/dhnaranjo/gists{/gist_id}","starred_url":"https://api.github.com/users/dhnaranjo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhnaranjo/subscriptions","organizations_url":"https://api.github.com/users/dhnaranjo/orgs","repos_url":"https://api.github.com/users/dhnaranjo/repos","events_url":"https://api.github.com/users/dhnaranjo/events{/privacy}","received_events_url":"https://api.github.com/users/dhnaranjo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-30T22:56:43Z","updated_at":"2022-08-02T11:02:57Z","closed_at":"2022-08-02T11:02:57Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    empty_array = []\r\n    Post.create(empty_array)\r\n\r\n    assert_raises(ArgumentError) do\r\n      Post.upsert_all(empty_array)\r\n    end\r\n  end\r\nend\r\n\r\n```\r\n\r\nWhich like... is on purpose as we can see in this lil snip, but why?\r\n\r\nhttps://github.com/rails/rails/blob/d96609505511a76c618dc3adfa3ca4679317d008/activerecord/lib/active_record/insert_all.rb#L5-L11\r\n\r\n### Expected behavior\r\nNothing happens, same as `Model.create` when passed an empty array. Or like... most things that accept arrays.\r\n\r\n### Actual behavior\r\nRaises `initialize: Empty list of attributes passed (ArgumentError)`\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45710/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45710/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45709","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45709/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45709/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45709/events","html_url":"https://github.com/rails/rails/issues/45709","id":1323303409,"node_id":"I_kwDNIULOTuAB8Q","number":45709,"title":"Rails & can't pin JS files from Unpkg","user":{"login":"septerr","id":1094216,"node_id":"MDQ6VXNlcjEwOTQyMTY=","avatar_url":"https://avatars.githubusercontent.com/u/1094216?v=4","gravatar_id":"","url":"https://api.github.com/users/septerr","html_url":"https://github.com/septerr","followers_url":"https://api.github.com/users/septerr/followers","following_url":"https://api.github.com/users/septerr/following{/other_user}","gists_url":"https://api.github.com/users/septerr/gists{/gist_id}","starred_url":"https://api.github.com/users/septerr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/septerr/subscriptions","organizations_url":"https://api.github.com/users/septerr/orgs","repos_url":"https://api.github.com/users/septerr/repos","events_url":"https://api.github.com/users/septerr/events{/privacy}","received_events_url":"https://api.github.com/users/septerr/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-30T21:44:43Z","updated_at":"2022-08-02T18:08:34Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nIn a new Rails & app, try to pin a package from Unpkg CDN:\r\n\r\n```\r\n./bin/importmap pin @walletconnect/web3-provider@1.7.8 --from unpkg\r\n```\r\n\r\nYou get following response:\r\n\r\n```\r\nCouldn't find any packages in [\"@walletconnect/web3-provider@1.7.8\"] on unpkg\r\n```\r\nBut the file does exist on unpkg: https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js\r\n\r\nAfter adding some breakpoints in `.rbenv/versions/3.1.0/lib/ruby/gems/3.1.0/gems/importmap-rails-1.1.5/lib/importmap/packager.rb`, saw that the CDN post request and response are as follows:\r\n\r\nPost URL: \r\n```\r\n<URI::HTTPS https://api.jspm.io/generate>\r\n```\r\nPost Body:\r\n```\r\n \"{\\\"install\\\":[\\\"@walletconnect/web3-provider@1.7.8\\\"],\\\"flattenScope\\\":true,\\\"env\\\":[\\\"browser\\\",\\\"module\\\",\\\"production\\\"],\\\"provider\\\":\\\"unpkg\\\"}\"\r\n```\r\n\r\nPost Response:\r\n```\r\n<Net::HTTPUnauthorized 401 Unauthorized readbody=true>\r\n```\r\n\r\n### Expected behavior\r\nExpected the files from unpkg to be pinned.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nMisleading error that files don't exist on unpkg.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.3.1\r\n\r\n**Ruby version**:\r\nruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45709/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45709/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45703","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45703/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45703/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45703/events","html_url":"https://github.com/rails/rails/issues/45703","id":1322847546,"node_id":"I_kwDNIULOTtkNOg","number":45703,"title":"Incorrect installation command for webpacker","user":{"login":"pkayokay","id":13375749,"node_id":"MDQ6VXNlcjEzMzc1NzQ5","avatar_url":"https://avatars.githubusercontent.com/u/13375749?v=4","gravatar_id":"","url":"https://api.github.com/users/pkayokay","html_url":"https://github.com/pkayokay","followers_url":"https://api.github.com/users/pkayokay/followers","following_url":"https://api.github.com/users/pkayokay/following{/other_user}","gists_url":"https://api.github.com/users/pkayokay/gists{/gist_id}","starred_url":"https://api.github.com/users/pkayokay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkayokay/subscriptions","organizations_url":"https://api.github.com/users/pkayokay/orgs","repos_url":"https://api.github.com/users/pkayokay/repos","events_url":"https://api.github.com/users/pkayokay/events{/privacy}","received_events_url":"https://api.github.com/users/pkayokay/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-30T02:28:30Z","updated_at":"2022-08-01T04:29:39Z","closed_at":"2022-08-01T04:29:39Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n- Visit [\"Install Webpacker\"](https://guides.rubyonrails.org/webpacker.html#installing-webpacker)\r\n\r\n### Expected behavior\r\n- \"To include Webpacker in a new project, add `-j webpack`...\"\r\n\r\n### Actual behavior\r\n- \"To include Webpacker in a new project, add `--webpack`...\"\r\n\r\nhttps://github.com/rails/jsbundling-rails/#installation\r\n\r\n`rails new myapp -j [esbuild|rollup|webpack].`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45703/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45703/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45702","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45702/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45702/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45702/events","html_url":"https://github.com/rails/rails/issues/45702","id":1322812678,"node_id":"I_kwDNIULOTtiFBg","number":45702,"title":"Attribute assignment fails after ActiveRecord::Persistence#becomes ","user":{"login":"caiohsramos","id":12804854,"node_id":"MDQ6VXNlcjEyODA0ODU0","avatar_url":"https://avatars.githubusercontent.com/u/12804854?v=4","gravatar_id":"","url":"https://api.github.com/users/caiohsramos","html_url":"https://github.com/caiohsramos","followers_url":"https://api.github.com/users/caiohsramos/followers","following_url":"https://api.github.com/users/caiohsramos/following{/other_user}","gists_url":"https://api.github.com/users/caiohsramos/gists{/gist_id}","starred_url":"https://api.github.com/users/caiohsramos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/caiohsramos/subscriptions","organizations_url":"https://api.github.com/users/caiohsramos/orgs","repos_url":"https://api.github.com/users/caiohsramos/repos","events_url":"https://api.github.com/users/caiohsramos/events{/privacy}","received_events_url":"https://api.github.com/users/caiohsramos/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-30T00:13:06Z","updated_at":"2022-07-30T14:43:56Z","closed_at":"2022-07-30T14:43:56Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :parents, force: true do |t|\r\n    t.string :type\r\n  end\r\nend\r\n\r\nclass Parent < ActiveRecord::Base\r\nend\r\nclass Child1 < Parent\r\n  attribute :name\r\nend\r\nclass Child2 < Parent\r\n  attribute :email\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_becomes\r\n    c1 = Child1.create!\r\n    c2 = c1.becomes(Child2)\r\n    c2.email = \"test@test.com\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nShould not raise `ActiveModel::MissingAttributeError` and assign the attribute\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nRaises `ActiveModel::MissingAttributeError` and doesn't assign the attribute\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45702/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45702/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45694","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45694/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45694/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45694/events","html_url":"https://github.com/rails/rails/issues/45694","id":1322187043,"node_id":"I_kwDNIULOTs75Iw","number":45694,"title":"Find with array returns nothing if primary key is not selected","user":{"login":"fschwahn","id":57876,"node_id":"MDQ6VXNlcjU3ODc2","avatar_url":"https://avatars.githubusercontent.com/u/57876?v=4","gravatar_id":"","url":"https://api.github.com/users/fschwahn","html_url":"https://github.com/fschwahn","followers_url":"https://api.github.com/users/fschwahn/followers","following_url":"https://api.github.com/users/fschwahn/following{/other_user}","gists_url":"https://api.github.com/users/fschwahn/gists{/gist_id}","starred_url":"https://api.github.com/users/fschwahn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fschwahn/subscriptions","organizations_url":"https://api.github.com/users/fschwahn/orgs","repos_url":"https://api.github.com/users/fschwahn/repos","events_url":"https://api.github.com/users/fschwahn/events{/privacy}","received_events_url":"https://api.github.com/users/fschwahn/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-29T12:26:59Z","updated_at":"2022-09-02T13:14:23Z","closed_at":"2022-09-02T13:14:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhen `select` is used and the primary key is not selected, the array form of `find` just returns an empty array.\r\n\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n    t.string :first_name\r\n    t.string :last_name\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  def name\r\n    \"#{first_name} #{last_name}\"\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_find_returns_nothing\r\n    user1 = User.create!(first_name: \"John\", last_name: \"Doe\")\r\n    user2 = User.create!(first_name: \"Jane\", last_name: \"Doe\")\r\n\r\n    assert_equal User.select(:first_name, :last_name).find([user1.id, user2.id]).map(&:name), [\"John Doe\", \"Jane Doe\"]\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nI think this should either raise (asking users to include the primary key), or automatically add the primary key to the `select`ed columns. It could also just return the records, but in that case order is not guaranteed anymore, which might be surprising to users.\r\n\r\n### Actual behavior\r\nAn empty array is returned. In rails 6.1 this raised a KeyError which is also pretty confusing (and was the reason I originally investigated this).\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 2.7.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45694/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45694/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45693","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45693/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45693/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45693/events","html_url":"https://github.com/rails/rails/issues/45693","id":1322132299,"node_id":"I_kwDNIULOTs4jSw","number":45693,"title":"Missing unless statement in one of the view files in getting started guide","user":{"login":"bhaskarshankarling","id":8980733,"node_id":"MDQ6VXNlcjg5ODA3MzM=","avatar_url":"https://avatars.githubusercontent.com/u/8980733?v=4","gravatar_id":"","url":"https://api.github.com/users/bhaskarshankarling","html_url":"https://github.com/bhaskarshankarling","followers_url":"https://api.github.com/users/bhaskarshankarling/followers","following_url":"https://api.github.com/users/bhaskarshankarling/following{/other_user}","gists_url":"https://api.github.com/users/bhaskarshankarling/gists{/gist_id}","starred_url":"https://api.github.com/users/bhaskarshankarling/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bhaskarshankarling/subscriptions","organizations_url":"https://api.github.com/users/bhaskarshankarling/orgs","repos_url":"https://api.github.com/users/bhaskarshankarling/repos","events_url":"https://api.github.com/users/bhaskarshankarling/events{/privacy}","received_events_url":"https://api.github.com/users/bhaskarshankarling/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-29T11:29:58Z","updated_at":"2022-07-29T15:26:52Z","closed_at":"2022-07-29T15:26:52Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nCompare the content of `app/views/comments/_comment.html.erb` between [rails-getting-started-guide#using-concerns](https://guides.rubyonrails.org/getting_started.html#using-concerns) and [rails-getting-started-guide#deleting-comments](https://guides.rubyonrails.org/getting_started.html#deleting-comments), a `unless` statement is missing in [rails-getting-started-guide#deleting-comments](https://guides.rubyonrails.org/getting_started.html#deleting-comments). See the images attached below\r\n\r\n#### Contents of `_comment.html.erb` from Using Concerns section\r\n<img width=\"629\" alt=\"Screenshot 2022-07-29 at 4 51 01 PM\" src=\"https://user-images.githubusercontent.com/8980733/181748789-c593d391-c17a-44c3-8dd3-f197121ac8a4.png\">\r\n\r\n#### Contents of `_comment.html.erb` from Deleting Comments section\r\n<img width=\"630\" alt=\"Screenshot 2022-07-29 at 4 51 39 PM\" src=\"https://user-images.githubusercontent.com/8980733/181748846-59f654f6-3b10-4098-8a8e-fd845ab43249.png\">\r\n\r\n### Expected behavior\r\n`app/views/comments/_comment.html.erb` in both [rails-getting-started-guide#using-concerns](https://guides.rubyonrails.org/getting_started.html#using-concerns) and [rails-getting-started-guide#deleting-comments](https://guides.rubyonrails.org/getting_started.html#deleting-comments) should have the below `unless` statement\r\n```html+erb\r\n<% unless comment.archived? %>\r\n...\r\n...\r\n<% end %>\r\n```\r\n\r\n### Actual behavior\r\n`unless` statement is missing from `app/views/comments/_comment.html.erb` in [rails-getting-started-guide#deleting-comments](https://guides.rubyonrails.org/getting_started.html#deleting-comments)\r\n\r\n### System configuration\r\n**Rails version**: v7.0.3.1\r\n\r\n**Ruby version**: NA\r\n\r\n---\r\n\r\nI have raised a PR https://github.com/rails/rails/pull/45692 to fix this issue in the documentation\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45693/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45693/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45691","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45691/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45691/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45691/events","html_url":"https://github.com/rails/rails/issues/45691","id":1322122058,"node_id":"I_kwDNIULOTs37Sg","number":45691,"title":"ActionMailer fails to create correct multipart message with rfc822 attachment","user":{"login":"der-flo","id":35431,"node_id":"MDQ6VXNlcjM1NDMx","avatar_url":"https://avatars.githubusercontent.com/u/35431?v=4","gravatar_id":"","url":"https://api.github.com/users/der-flo","html_url":"https://github.com/der-flo","followers_url":"https://api.github.com/users/der-flo/followers","following_url":"https://api.github.com/users/der-flo/following{/other_user}","gists_url":"https://api.github.com/users/der-flo/gists{/gist_id}","starred_url":"https://api.github.com/users/der-flo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/der-flo/subscriptions","organizations_url":"https://api.github.com/users/der-flo/orgs","repos_url":"https://api.github.com/users/der-flo/repos","events_url":"https://api.github.com/users/der-flo/events{/privacy}","received_events_url":"https://api.github.com/users/der-flo/received_events","type":"User","site_admin":false},"labels":[{"id":107188,"node_id":"MDU6TGFiZWwxMDcxODg=","url":"https://api.github.com/repos/rails/rails/labels/actionmailer","name":"actionmailer","color":"8B00FC","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-29T11:19:00Z","updated_at":"2022-08-02T19:46:17Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I cannot re-open #42849 so I create a new issue…\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n  gem 'rails', github: 'rails/rails', branch: 'main'\r\nend\r\n\r\nrequire 'minitest/autorun'\r\nrequire 'action_mailer/railtie'\r\n\r\nclass TestMailer < ActionMailer::Base\r\n  def main\r\n    message_to_attach =  <<~MAIL.gsub(/\\n/, \"\\r\\n\")\r\n      Message-ID: <12345@foo.example>\r\n      Subject: Test\r\n      From: test1@foo.example\r\n      To: test2@foo.example\r\n      \r\n      hello world\r\n    MAIL\r\n    attachments['test.eml'] = {\r\n      mime_type: params[:mime_type],\r\n      content: message_to_attach\r\n    }\r\n\r\n    mail(from: 'test3@foo.example', to: 'test4@foo.example', subject: 'Test outer') do |format|\r\n      format.text { \"outer text - #{params[:mime_type]} attachment\" }\r\n    end\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_with_plain_mime_type\r\n    message = TestMailer.with(mime_type: 'text/plain').main\r\n    assert_equal message.mime_type, 'multipart/mixed'\r\n  end\r\n\r\n  def test_with_rfc822_mime_type\r\n    message = TestMailer.with(mime_type: 'message/rfc822').main\r\n    assert_equal message.mime_type, 'multipart/mixed'\r\n  end\r\nend\r\n```\r\n\r\nThe second test fails, the message object is rendered as follows:\r\n```\r\nDate: Fri, 23 Jul 2021 13:59:19 +0200\r\nFrom: test3@foo.example\r\nTo: test4@foo.example\r\nMessage-ID: <60faaf1738a02_14fbd98-3fb@flo.adigi.ai.mail>\r\nSubject: Test outer\r\nMime-Version: 1.0\r\nContent-Type: text/plain;\r\n boundary=\"--==_mimepart_60faaf1738008_14fbd98-484\";\r\n charset=UTF-8\r\nContent-Transfer-Encoding: 7bit\r\n\r\n\r\n----==_mimepart_60faaf1738008_14fbd98-484\r\nContent-Type: text/plain;\r\n charset=UTF-8\r\nContent-Transfer-Encoding: 7bit\r\n\r\nouter text - message/rfc822 attachment\r\n----==_mimepart_60faaf1738008_14fbd98-484\r\nContent-Type: message/rfc822\r\nContent-Transfer-Encoding: \r\nContent-Disposition: attachment;\r\n filename=test.eml\r\nContent-ID: <60faaf1739102_14fbd98-2b@flo.adigi.ai.mail>\r\n\r\nMessage-ID: <12345@foo.example>\r\nSubject: Test\r\nFrom: test1@foo.example\r\nTo: test2@foo.example\r\n\r\nhello world\r\n\r\n----==_mimepart_60faaf1738008_14fbd98-484--\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe `message.mime_type` is `multipart/mixed` in both test cases. ActionMailer handles attachments in the way it is described in https://guides.rubyonrails.org/action_mailer_basics.html#adding-attachments describes.\r\n\r\n### Actual behavior\r\n\r\nWhen attaching a `message/rfc822` - an email message - the generated mail parts are not nested correctly, the outer `multipart/mixed` is missing.\r\n\r\nPerhaps this behaviour is caused by the [special handling](https://github.com/mikel/mail/blob/master/lib/mail/attachments_list.rb#L9) of such attachments in the `mail` gem.\r\n\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45691/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45691/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45690","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45690/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45690/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45690/events","html_url":"https://github.com/rails/rails/issues/45690","id":1321705185,"node_id":"I_kwDNIULOTsee4Q","number":45690,"title":"NullStore cache randomly blows up in asynchronous cases","user":{"login":"CodingAnarchy","id":5926159,"node_id":"MDQ6VXNlcjU5MjYxNTk=","avatar_url":"https://avatars.githubusercontent.com/u/5926159?v=4","gravatar_id":"","url":"https://api.github.com/users/CodingAnarchy","html_url":"https://github.com/CodingAnarchy","followers_url":"https://api.github.com/users/CodingAnarchy/followers","following_url":"https://api.github.com/users/CodingAnarchy/following{/other_user}","gists_url":"https://api.github.com/users/CodingAnarchy/gists{/gist_id}","starred_url":"https://api.github.com/users/CodingAnarchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CodingAnarchy/subscriptions","organizations_url":"https://api.github.com/users/CodingAnarchy/orgs","repos_url":"https://api.github.com/users/CodingAnarchy/repos","events_url":"https://api.github.com/users/CodingAnarchy/events{/privacy}","received_events_url":"https://api.github.com/users/CodingAnarchy/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-07-29T03:13:12Z","updated_at":"2022-08-02T07:37:15Z","closed_at":"2022-08-02T07:37:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nThis appears to be an esoteric bug that I found in an edge case while running asynchronous code that all queried the `NullStore` cache (which was empty).\r\n\r\nI couldn't come up with a way to replicate without loading the entire application, nor by loading the application on another machine, but I did manage to fix it locally by adding a safe navigation operator on: https://github.com/rails/rails/blob/752b566152ca3e8daf4804c90777cc1a01d003f6/activesupport/lib/active_support/cache/strategy/local_cache.rb#L135\r\n\r\nWhat I'm wondering is if this is a sensible thing to adjust to avoid this weird case.\r\n\r\n### Expected behavior\r\n\r\nCache value should return `nil` and fall through to continuing code.\r\n\r\n### Actual behavior\r\n\r\n```ruby\r\nundefined method `value' for nil:NilClass\r\n   \r\n                   deserialize_entry(payload).value\r\n                                              ^^^^^\r\n /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache/strategy/local_cache.rb:127:in `block in read_multi_entries'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache/strategy/local_cache.rb:126:in `transform_values!'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache/strategy/local_cache.rb:126:in `read_multi_entries'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache.rb:425:in `block in read_multi'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache.rb:778:in `block in instrument'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/notifications.rb:208:in `instrument'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache.rb:778:in `instrument'\r\n    /Users/mtanous/.gem/ruby/3.1.2/gems/activesupport-7.0.3.1/lib/active_support/cache.rb:424:in `read_multi'\r\n16156 /Users/mtanous/src/github.com/Shopify/grid-next/app/lib/cache.rb:35:in `read_multi'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45690/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45690/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45687","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45687/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45687/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45687/events","html_url":"https://github.com/rails/rails/issues/45687","id":1321337408,"node_id":"I_kwDNIULOTsICQA","number":45687,"title":"Define correct constant with Zeitwerk","user":{"login":"vs37559","id":60176636,"node_id":"MDQ6VXNlcjYwMTc2NjM2","avatar_url":"https://avatars.githubusercontent.com/u/60176636?v=4","gravatar_id":"","url":"https://api.github.com/users/vs37559","html_url":"https://github.com/vs37559","followers_url":"https://api.github.com/users/vs37559/followers","following_url":"https://api.github.com/users/vs37559/following{/other_user}","gists_url":"https://api.github.com/users/vs37559/gists{/gist_id}","starred_url":"https://api.github.com/users/vs37559/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vs37559/subscriptions","organizations_url":"https://api.github.com/users/vs37559/orgs","repos_url":"https://api.github.com/users/vs37559/repos","events_url":"https://api.github.com/users/vs37559/events{/privacy}","received_events_url":"https://api.github.com/users/vs37559/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-28T18:37:02Z","updated_at":"2022-08-01T02:00:27Z","closed_at":"2022-08-01T02:00:26Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, \r\nI am trying to add a file in custom directory as `app/data_dispatchers/file_dispatcher.rb`.\r\n``` ruby\r\nmodule DataDispatchers\r\n  class FileDispatcher\r\n    # some logic\r\n  end\r\nend\r\n```\r\nI am getting this error on running `rails zeitwerk:check`\r\n``` ruby\r\nexpected file app/data_dispatchers/file_dispatcher.rb to define constant FileDispatcher\r\n```\r\n\r\nIs there any workaround with which I can define `DataDispatchers::FileDispatcher` as my constant ?\r\n\r\n### System configuration\r\n**Rails version**: `v7.0.3.1`\r\n\r\n**Ruby version**: `v3.1.2`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45687/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45687/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45683","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45683/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45683/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45683/events","html_url":"https://github.com/rails/rails/issues/45683","id":1321142780,"node_id":"I_kwDNIULOTr8J_A","number":45683,"title":"Rails.application.config.active_record.has_many_inversing config not applied until load_defaults value is changed to 6.1","user":{"login":"alexadia","id":79482354,"node_id":"MDQ6VXNlcjc5NDgyMzU0","avatar_url":"https://avatars.githubusercontent.com/u/79482354?v=4","gravatar_id":"","url":"https://api.github.com/users/alexadia","html_url":"https://github.com/alexadia","followers_url":"https://api.github.com/users/alexadia/followers","following_url":"https://api.github.com/users/alexadia/following{/other_user}","gists_url":"https://api.github.com/users/alexadia/gists{/gist_id}","starred_url":"https://api.github.com/users/alexadia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexadia/subscriptions","organizations_url":"https://api.github.com/users/alexadia/orgs","repos_url":"https://api.github.com/users/alexadia/repos","events_url":"https://api.github.com/users/alexadia/events{/privacy}","received_events_url":"https://api.github.com/users/alexadia/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-28T15:40:55Z","updated_at":"2022-07-28T16:34:57Z","closed_at":"2022-07-28T16:34:39Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n* Uncomment `Rails.application.config.active_record.has_many_inversing = true` in file config/initializers/new_framework_defaults_6_1.rb. \r\n* In config/application.rb, set `config.load_defaults` to 6.0 (no string). Ex: `config.load_defaults 6.0`. \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nIn a rails console run \r\n```ruby\r\nRails.application.config.active_record.has_many_inversing\r\nActiveRecord::Base.has_many_inversing\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nThe output for both commands below should be true so that has_many_inversing is turned on.\r\n\r\n```ruby\r\nRails.application.config.active_record.has_many_inversing\r\nActiveRecord::Base.has_many_inversing\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n* Only `Rails.application.config.active_record.has_many_inversing` returned true. \r\n* Whereas `ActiveRecord::Base.has_many_inversing` returned false. \r\n\r\nHence the feature `has_many_inversing` wasn't on when `config.load_defaults` was 6.0, even though `Rails.application.config.active_record.has_many_inversing` was set to true in config/initializers/new_framework_defaults_6_1.rb. \r\n\r\nThe feature has_many_inversing was only turned on once I deleted the file config/initializers/new_framework_defaults_6_1.rb and changed `config.load_defaults` from 6.0 to 6.1. \r\n\r\nThis caused a spec related to `has_many_inversing` to only fail once load_defaults was changed to 6.1. On the branch with load_defaults set to 6.1, setting `has_many_inversing` to false fixed the spec.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 2.7.2p137\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45683/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45683/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45682","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45682/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45682/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45682/events","html_url":"https://github.com/rails/rails/issues/45682","id":1321062784,"node_id":"I_kwDNIULOTr3RgA","number":45682,"title":"ActiveRecord `with_options` should merge and combine options","user":{"login":"james-em","id":63726983,"node_id":"MDQ6VXNlcjYzNzI2OTgz","avatar_url":"https://avatars.githubusercontent.com/u/63726983?v=4","gravatar_id":"","url":"https://api.github.com/users/james-em","html_url":"https://github.com/james-em","followers_url":"https://api.github.com/users/james-em/followers","following_url":"https://api.github.com/users/james-em/following{/other_user}","gists_url":"https://api.github.com/users/james-em/gists{/gist_id}","starred_url":"https://api.github.com/users/james-em/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james-em/subscriptions","organizations_url":"https://api.github.com/users/james-em/orgs","repos_url":"https://api.github.com/users/james-em/repos","events_url":"https://api.github.com/users/james-em/events{/privacy}","received_events_url":"https://api.github.com/users/james-em/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-28T14:53:48Z","updated_at":"2022-07-28T22:11:20Z","closed_at":"2022-07-28T22:11:19Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# my_model.rb\r\n\r\nclass MyModel < ApplicationRecord\r\n  with_options if: -> { email.present? } do\r\n    validates :first_name, presence: true\r\n    validates :last_name, if: -> { first_name.present? }\r\n   end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n**First name** should be mandatory if email is present.\r\n**Last name** should be mandatory if email **and** first_name is present.\r\n\r\n### Actual behavior\r\n\r\n**First name** is mandatory if email is present.\r\n**Last name** is mandatory if first_name is present **even if the email is blank.**\r\n\r\nThe inner **if** seems to override the parent **if** that is defined with the **with_options** instead of testing both condition.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.0\r\n\r\n### Possible workaround for that specific scenario\r\n\r\n```ruby\r\n# my_model.rb\r\n\r\nclass MyModel < ApplicationRecord\r\n  with_options unless: -> { email.blank? } do\r\n    validates :first_name, presence: true\r\n    validates :last_name, if: -> { first_name.present? }\r\n   end\r\nend\r\n```\r\n\r\nIt works as expected because inner if will not replace parent unless and both condition will be executed.\r\n\r\nRelated article https://stackoverflow.com/questions/13174435/rails-nested-with-option-if-used-in-validation","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45682/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45681","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45681/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45681/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45681/events","html_url":"https://github.com/rails/rails/issues/45681","id":1320829568,"node_id":"I_kwDNIULOTrpCgA","number":45681,"title":"SameSite error logged in Firefox (rails/main)","user":{"login":"strobilomyces","id":68540841,"node_id":"MDQ6VXNlcjY4NTQwODQx","avatar_url":"https://avatars.githubusercontent.com/u/68540841?v=4","gravatar_id":"","url":"https://api.github.com/users/strobilomyces","html_url":"https://github.com/strobilomyces","followers_url":"https://api.github.com/users/strobilomyces/followers","following_url":"https://api.github.com/users/strobilomyces/following{/other_user}","gists_url":"https://api.github.com/users/strobilomyces/gists{/gist_id}","starred_url":"https://api.github.com/users/strobilomyces/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/strobilomyces/subscriptions","organizations_url":"https://api.github.com/users/strobilomyces/orgs","repos_url":"https://api.github.com/users/strobilomyces/repos","events_url":"https://api.github.com/users/strobilomyces/events{/privacy}","received_events_url":"https://api.github.com/users/strobilomyces/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-28T12:02:57Z","updated_at":"2022-07-29T20:46:02Z","closed_at":"2022-07-29T20:46:02Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n- Create a new rails app using main or on/after d29e755aea0cd01d3bb27f5a9db14b9a1a346bb0\r\n- Add a model, change default route to its index\r\n- Start server, open in Firefox (I'm using 103.0)\r\n\r\n### Expected behavior\r\nNo console errors\r\n\r\n### Actual behavior\r\nThe good old:\r\n\r\n`Cookie “_fuck_session” does not have a proper “SameSite” attribute value. Soon, cookies without the “SameSite” attribute or with an invalid value will be treated as “Lax”. This means that the cookie will no longer be sent in third-party contexts. If your application depends on this cookie being available in such contexts, please add the “SameSite=None“ attribute to it. To know more about the “SameSite“ attribute, read https://developer.mozilla.org/docs/Web/HTTP/Headers/Set-Cookie/SameSite`\r\n\r\n### System configuration\r\n**Rails version**: rails/main (currently at b8964e53100f66197e0adbd96c194285651cae4e)\r\n\r\n**Ruby version**: 3.1.2p20\r\n\r\n### Fix\r\n\r\nRolling back to the previous commit, 646bff6091af8067a9ec898d1c2399c255d75ffd, the console error is not logged.\r\n\r\n### Etc.\r\n\r\nSetting config.action_dispatch.cookies_same_site_protection in application.rb has no effect on this.\r\n\r\nI don't know if the changelog for d29e755aea0cd01d3bb27f5a9db14b9a1a346bb0 is supposed to be suggesting a workaround, but where exactly it would be set for ordinary session cookies is unclear to me. Regardless, out of the box, the error is present.\r\n\r\nOh, yeah, and there aren't any errors in Chrome (hence the title).\r\n\r\nThanks in advance :)\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45681/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45681/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45668","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45668/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45668/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45668/events","html_url":"https://github.com/rails/rails/issues/45668","id":1319462779,"node_id":"I_kwDNIULOTqVnew","number":45668,"title":"enum definition silences UnknownAttributeError & misbehaves with outdated schema cache","user":{"login":"klyonrad","id":1453955,"node_id":"MDQ6VXNlcjE0NTM5NTU=","avatar_url":"https://avatars.githubusercontent.com/u/1453955?v=4","gravatar_id":"","url":"https://api.github.com/users/klyonrad","html_url":"https://github.com/klyonrad","followers_url":"https://api.github.com/users/klyonrad/followers","following_url":"https://api.github.com/users/klyonrad/following{/other_user}","gists_url":"https://api.github.com/users/klyonrad/gists{/gist_id}","starred_url":"https://api.github.com/users/klyonrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/klyonrad/subscriptions","organizations_url":"https://api.github.com/users/klyonrad/orgs","repos_url":"https://api.github.com/users/klyonrad/repos","events_url":"https://api.github.com/users/klyonrad/events{/privacy}","received_events_url":"https://api.github.com/users/klyonrad/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-27T12:03:25Z","updated_at":"2022-08-03T18:20:40Z","closed_at":"2022-08-03T18:20:40Z","author_association":"NONE","active_lock_reason":null,"body":"Defining an enum to a ActiveRecord model has the affect that typical safeguards / checks for *unknown attributes* are bypassed, for example when there was a typo in the database migration related to an enum.\r\n\r\n**How was this observed?**\r\n\r\nA process (example a worker processor like sidekiq), which had the enum definition loaded already, and another process/system changed the database with a migration, adding the column for which the enum was defined. Later on expected data was not stored into the database (instead the default value for the column). Assumption: Since the background process did not refresh the schema cache it ignores the change for the enum attribute. But because `Enum` module defines an `attribute` activerecord considers it not a problem that the column is not really present.\r\n\r\n**Comment:**\r\n\r\nI would totally understand if this considered an extreme edge case but I just thought it would be worthwhile to report. While thinking about about a potential solution, I realize that a potential solution is not even obvious. Should the enum definition cause an error when the model is loaded? Should every update to an Enum attribute check whether or not the column exists?\r\n\r\n### Steps to reproduce\r\n\r\n- define enum attribute in model for a non existing column name\r\n- try to store a value into this attribute with the same name\r\n- no error is raised. The desired data is not stored\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\n  gem \"mysql2\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\n# ActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \"rails_enum_bug.sqlite\")\r\n# ActiveRecord::Base.establish_connection(adapter: \"mysql2\", database: \"rails_enum_bug_report\", username: 'root', host: '127.0.0.1')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  enum :wrong_attributee, [:default_value, :middle_value, :other_value]\r\nend\r\n\r\nclass AddAttributeToPosts < ActiveRecord::Migration[7.0]\r\n  def change\r\n    add_column :posts, :wrong_attrib, :integer, default: 0\r\n  end\r\nend\r\n\r\nclass AddEnumToPosts < ActiveRecord::Migration[7.0]\r\n  def change\r\n    add_column :posts, :wrong_attributee, :integer, default: 0\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_with_outdated_schema_cache\r\n    assert_equal [\"id\"], Post.column_names # to load schema cache\r\n    AddAttributeToPosts.migrate(:up)\r\n    AddEnumToPosts.migrate(:up)\r\n    assert_equal [\"id\"], Post.column_names\r\n    new_post = Post.create!(wrong_attributee: :other_value) # column is not in the schema cache, so why no error?\r\n    Post.reset_column_information\r\n\r\n    assert_equal \"default_value\", new_post.reload.wrong_attributee # database default is used\r\n    assert_equal \"other_value\", new_post.reload.wrong_attributee # actual value is 0 (sqlite default)\r\n  end\r\n\r\n  def test_unknown_attribute\r\n    AddAttributeToPosts.migrate(:up)\r\n    Post.reset_column_information\r\n\r\n    # expected/normal behaviour\r\n    assert_raises(ActiveModel::UnknownAttributeError) do\r\n      Post.create!(wrong_attribute: :other_value)\r\n    end\r\n    new_post = Post.create!(wrong_attributee: :other_value) # bug, this should raise an error\r\n\r\n    assert_nil new_post.reload.wrong_attributee\r\n    assert_nil new_post.reload.wrong_attrib\r\n    assert_equal \"other_value\", new_post.reload.wrong_attributee # not really expected behaviour :)\r\n  end\r\n\r\n  def teardown\r\n    Post.delete_all\r\n    AddAttributeToPosts.migrate(:down)\r\n    AddEnumToPosts.migrate(:down) if ActiveRecord::Base.connection.column_exists?(:posts, :wrong_attributee)\r\n    Post.reset_column_information\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\n- UnknownAttributeError would get raised at *some point* \r\n\r\n### Actual behavior\r\n\r\n- no error is raised\r\n- record gets created/modified without the desired value\r\n- in the case of a successful migration for a column with a default value but a missing schema cache update, the record gets created without the desired data in that column but the default value\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7\r\n\r\n**Ruby version**:\r\n\r\n3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45668/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45668/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45666","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45666/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45666/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45666/events","html_url":"https://github.com/rails/rails/issues/45666","id":1318995848,"node_id":"I_kwDNIULOTp5HiA","number":45666,"title":"Bug about view table when use version 7.0.3.1","user":{"login":"behemoth-truongnd","id":72366897,"node_id":"MDQ6VXNlcjcyMzY2ODk3","avatar_url":"https://avatars.githubusercontent.com/u/72366897?v=4","gravatar_id":"","url":"https://api.github.com/users/behemoth-truongnd","html_url":"https://github.com/behemoth-truongnd","followers_url":"https://api.github.com/users/behemoth-truongnd/followers","following_url":"https://api.github.com/users/behemoth-truongnd/following{/other_user}","gists_url":"https://api.github.com/users/behemoth-truongnd/gists{/gist_id}","starred_url":"https://api.github.com/users/behemoth-truongnd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/behemoth-truongnd/subscriptions","organizations_url":"https://api.github.com/users/behemoth-truongnd/orgs","repos_url":"https://api.github.com/users/behemoth-truongnd/repos","events_url":"https://api.github.com/users/behemoth-truongnd/events{/privacy}","received_events_url":"https://api.github.com/users/behemoth-truongnd/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-27T04:11:06Z","updated_at":"2022-07-27T08:39:43Z","closed_at":"2022-07-27T08:39:43Z","author_association":"NONE","active_lock_reason":null,"body":"Hi everyone!\r\nin the database i create a view table\r\n```\r\nCREATE VIEW view_favorites AS\r\n        SELECT account_id, targetable_id, \"\" as youtube_id, targetable_type, is_favorited, created_at, updated_at, id as favorite_id, \"\" as favorite_youtube_id FROM favorites\r\n        UNION ALL\r\n        SELECT account_id, \"\" , youtube_id, \"Youtube\", is_favorited, created_at, updated_at, \"\", id FROM favorite_youtubes;\r\n```\r\n\r\nI am getting error when using views table\r\n\r\n```\r\nNoMethodError: undefined method `match' for nil:NilClass\r\n\r\n          match = create_table_info(table_name).match(/`#{field_name}` (.+) DEFAULT ('|\\d+|[A-z]+)/)\r\n                                               ^^^^^^\r\n/app/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/mysql/schema_statements.rb:162:in `default_type'\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3.1\r\n**Ruby version**:\r\n3.1.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45666/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45666/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45658","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45658/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45658/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45658/events","html_url":"https://github.com/rails/rails/issues/45658","id":1317190091,"node_id":"I_kwDNIULOToK5yw","number":45658,"title":"`Model.update_all(attribute: interval_expression)` sets the wrong date when using Postgres' interval expressions","user":{"login":"fnando","id":3009,"node_id":"MDQ6VXNlcjMwMDk=","avatar_url":"https://avatars.githubusercontent.com/u/3009?v=4","gravatar_id":"","url":"https://api.github.com/users/fnando","html_url":"https://github.com/fnando","followers_url":"https://api.github.com/users/fnando/followers","following_url":"https://api.github.com/users/fnando/following{/other_user}","gists_url":"https://api.github.com/users/fnando/gists{/gist_id}","starred_url":"https://api.github.com/users/fnando/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fnando/subscriptions","organizations_url":"https://api.github.com/users/fnando/orgs","repos_url":"https://api.github.com/users/fnando/repos","events_url":"https://api.github.com/users/fnando/events{/privacy}","received_events_url":"https://api.github.com/users/fnando/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-07-25T18:12:32Z","updated_at":"2022-07-26T05:14:43Z","closed_at":"2022-07-26T05:14:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile do\r\n  ruby \"3.1.2\"\r\n  source \"https://rubygems.org\"\r\n  gem \"activerecord\", \"~> 7.0\"\r\n  gem \"pg\"\r\n  gem \"minitest\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\n\r\nENV[\"TZ\"] = \"Etc/UTC\"\r\n\r\nActiveRecord::Base.establish_connection \"postgresql:///test\"\r\nActiveRecord::Base.logger = Logger.new($stdout)\r\n\r\nputs \"=> Using activecord v#{ActiveRecord::VERSION::STRING}\"\r\nputs \"=> Using pg v#{PG::VERSION}\"\r\nputs\r\n\r\nActiveRecord::Schema.define(version: 0) do\r\n  drop_table :things if table_exists?(:things)\r\n\r\n  create_table :things do |t|\r\n    t.datetime :next_thing_at, null: false, default: -> { \"now()\" }\r\n  end\r\nend\r\n\r\nclass Thing < ActiveRecord::Base\r\nend\r\n\r\nclass TestThing < Minitest::Test\r\n  def test_updates_timestamp_column_properly_using_interval\r\n    next_thing_at = Time.now.beginning_of_day\r\n    thing = Thing.create!(next_thing_at:)\r\n\r\n    Thing.update_all(\"next_thing_at = next_thing_at + '15 minute'::interval\")\r\n    thing.reload\r\n\r\n    assert_equal thing.next_thing_at, next_thing_at + 15.minutes\r\n\r\n    Thing.update_all(next_thing_at: \"next_thing_at + '15 minute'::interval\")\r\n    thing.reload\r\n\r\n    assert_equal thing.next_thing_at, next_thing_at + 30.minutes\r\n  end\r\nend\r\n```\r\n\r\nRunning the following script gives this output:\r\n\r\n```console\r\n$ ruby file.rb\r\n=> Using activecord v7.0.3.1\r\n=> Using pg v1.4.1\r\n\r\n-- table_exists?(:things)\r\n   -> 0.0406s\r\n-- drop_table(:things)\r\nD, [2022-07-25T18:33:26.205658 #50118] DEBUG -- :    (5.8ms)  DROP TABLE \"things\"\r\n   -> 0.0060s\r\n-- create_table(:things)\r\nD, [2022-07-25T18:33:26.211264 #50118] DEBUG -- :    (4.8ms)  CREATE TABLE \"things\" (\"id\" bigserial primary key, \"next_thing_at\" timestamp(6) DEFAULT now() NOT NULL)\r\n   -> 0.0055s\r\nD, [2022-07-25T18:33:26.241237 #50118] DEBUG -- :   ActiveRecord::SchemaMigration Pluck (1.4ms)  SELECT \"schema_migrations\".\"version\" FROM \"schema_migrations\" ORDER BY \"schema_migrations\".\"version\" ASC\r\nD, [2022-07-25T18:33:26.251079 #50118] DEBUG -- :   ActiveRecord::InternalMetadata Load (0.4ms)  SELECT \"ar_internal_metadata\".* FROM \"ar_internal_metadata\" WHERE \"ar_internal_metadata\".\"key\" = $1 LIMIT $2  [[\"key\", \"environment\"], [\"LIMIT\", 1]]\r\nRun options: --seed 8003\r\n\r\n# Running:\r\n\r\nD, [2022-07-25T18:33:26.275424 #50118] DEBUG -- :   TRANSACTION (0.1ms)  BEGIN\r\nD, [2022-07-25T18:33:26.276118 #50118] DEBUG -- :   Thing Create (0.6ms)  INSERT INTO \"things\" (\"next_thing_at\") VALUES ($1) RETURNING \"id\"  [[\"next_thing_at\", \"2022-07-25 00:00:00\"]]\r\nD, [2022-07-25T18:33:26.276365 #50118] DEBUG -- :   TRANSACTION (0.2ms)  COMMIT\r\nD, [2022-07-25T18:33:26.276792 #50118] DEBUG -- :   Thing Update All (0.3ms)  UPDATE \"things\" SET next_thing_at = next_thing_at + '15 minute'::interval\r\nD, [2022-07-25T18:33:26.277315 #50118] DEBUG -- :   Thing Load (0.1ms)  SELECT \"things\".* FROM \"things\" WHERE \"things\".\"id\" = $1 LIMIT $2  [[\"id\", 1], [\"LIMIT\", 1]]\r\nD, [2022-07-25T18:33:26.277880 #50118] DEBUG -- :   Thing Update All (0.2ms)  UPDATE \"things\" SET \"next_thing_at\" = $1  [[\"next_thing_at\", \"2015-01-01 00:00:00\"]]\r\nD, [2022-07-25T18:33:26.278086 #50118] DEBUG -- :   Thing Load (0.1ms)  SELECT \"things\".* FROM \"things\" WHERE \"things\".\"id\" = $1 LIMIT $2  [[\"id\", 1], [\"LIMIT\", 1]]\r\nF\r\n\r\nFinished in 0.009049s, 110.5094 runs/s, 221.0189 assertions/s.\r\n\r\n  1) Failure:\r\nTestThing#test_updates_timestamp_column_properly_using_interval [file.rb:49]:\r\nExpected: 2015-01-01 00:00:00 UTC\r\n  Actual: 2022-07-25 00:30:00 +0000\r\n\r\n1 runs, 2 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### Expected behavior\r\n\r\nWhen calling `Model.update_all(attribute: expression)` using a Postgres interval expression, ActiveRecord sets the column to a date in the past. Using `Model.update_all(update_string)` works properly.\r\n\r\n### Actual behavior\r\n\r\n`Model.update_all(attribute: expression)` should behave like `Model.update_all(update_string)` when passing an interval expression.\r\n\r\n### System configuration\r\n\r\n* **Rails version**: 7.0.3.1\r\n* **Ruby version**: 3.1.2\r\n* **PG version**: 1.4.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45658/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45658/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45646","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45646/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45646/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45646/events","html_url":"https://github.com/rails/rails/issues/45646","id":1315722009,"node_id":"I_kwDNIULOTmxTGQ","number":45646,"title":"Broken links in Guides Documentation","user":{"login":"nickjenkins83","id":33209785,"node_id":"MDQ6VXNlcjMzMjA5Nzg1","avatar_url":"https://avatars.githubusercontent.com/u/33209785?v=4","gravatar_id":"","url":"https://api.github.com/users/nickjenkins83","html_url":"https://github.com/nickjenkins83","followers_url":"https://api.github.com/users/nickjenkins83/followers","following_url":"https://api.github.com/users/nickjenkins83/following{/other_user}","gists_url":"https://api.github.com/users/nickjenkins83/gists{/gist_id}","starred_url":"https://api.github.com/users/nickjenkins83/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nickjenkins83/subscriptions","organizations_url":"https://api.github.com/users/nickjenkins83/orgs","repos_url":"https://api.github.com/users/nickjenkins83/repos","events_url":"https://api.github.com/users/nickjenkins83/events{/privacy}","received_events_url":"https://api.github.com/users/nickjenkins83/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-07-23T18:42:41Z","updated_at":"2022-08-05T02:25:46Z","closed_at":"2022-08-01T04:37:03Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n2 of the 3 links are broken currently on the 'Getting Started' guide.\r\n\r\n[Mr. Neighborly’s Humble Little Ruby Book](http://www.humblelittlerubybook.com/)  ## Should now be (https://archive.org/details/ost-computer-science-humble-little-ruby-book)\r\n\r\n[Why’s (Poignant) Guide to Ruby](http://mislav.uniqpath.com/poignant-guide/)  ## Should now be (https://poignant.guide/)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45646/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45646/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45644","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45644/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45644/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45644/events","html_url":"https://github.com/rails/rails/issues/45644","id":1315405732,"node_id":"I_kwDNIULOTmd_pA","number":45644,"title":"Getting started point 7.5. DELETE resource doesn't work","user":{"login":"gitrobertofl","id":57234280,"node_id":"MDQ6VXNlcjU3MjM0Mjgw","avatar_url":"https://avatars.githubusercontent.com/u/57234280?v=4","gravatar_id":"","url":"https://api.github.com/users/gitrobertofl","html_url":"https://github.com/gitrobertofl","followers_url":"https://api.github.com/users/gitrobertofl/followers","following_url":"https://api.github.com/users/gitrobertofl/following{/other_user}","gists_url":"https://api.github.com/users/gitrobertofl/gists{/gist_id}","starred_url":"https://api.github.com/users/gitrobertofl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gitrobertofl/subscriptions","organizations_url":"https://api.github.com/users/gitrobertofl/orgs","repos_url":"https://api.github.com/users/gitrobertofl/repos","events_url":"https://api.github.com/users/gitrobertofl/events{/privacy}","received_events_url":"https://api.github.com/users/gitrobertofl/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-07-22T20:48:33Z","updated_at":"2022-08-01T18:58:00Z","closed_at":"2022-08-01T18:57:56Z","author_association":"NONE","active_lock_reason":null,"body":"Hi to everyone!\r\n\r\nI'm a total newcomer to Ruby on Rails. I'm reproducing step by step the Getting started guide for versión 7.0.3.1 over Windows 10. Firefox 102.0.1\r\n\r\npoint 7.5. of the guide\r\nWhen I click on link \"delete\", server sends this message\r\n\r\nStarted GET \"/articles/5\" for 127.0.0.1 at 2022-07-22 22:22:44 +0200\r\nProcessing by ArticlesController#show as HTML\r\n  Parameters: {\"id\"=>\"5\"}\r\n  Article Load (0.2ms)  SELECT \"articles\".* FROM \"articles\" WHERE \"articles\".\"id\" = ? LIMIT ?  [[\"id\", 5], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/articles_controller.rb:8:in `show'\r\n  Rendering layout layouts/application.html.erb\r\n  Rendering articles/show.html.erb within layouts/application\r\n  Rendered articles/show.html.erb within layouts/application (Duration: 0.2ms | Allocations: 121)\r\n  Rendered layout layouts/application.html.erb (Duration: 4.6ms | Allocations: 1325)\r\nCompleted 200 OK in 8ms (Views: 5.6ms | ActiveRecord: 0.2ms | Allocations: 2089)\r\n\r\nand reload the same page: article 5 in this case.\r\n\r\nFF renders that:\r\n\r\n\"<a data-turbo-method=\"delete\" data-turbo-confirm=\"Are you sure?\" href=\"/articles/5\">Destroy</a>\"\r\n\r\nI know that browsers don't implement DELETE verb, and turbo makes a conversion to POST\r\n\r\nI have just read the issue #43941 but it doesn't clear anything and the problem persist.\r\nI have searching about that and no one solution (some of them old UJS references, deprecated).\r\n I think that that browsers don't implement DELETE verb, and \"turbo\" makes a conversion of that, but nothing more.\r\n\r\nBest regards,\r\nRoberto\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45644/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45644/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45641","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45641/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45641/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45641/events","html_url":"https://github.com/rails/rails/issues/45641","id":1315298042,"node_id":"I_kwDNIULOTmXa-g","number":45641,"title":"value that fails to cast for a JSON column is silently set to nil","user":{"login":"tjwp","id":1476506,"node_id":"MDQ6VXNlcjE0NzY1MDY=","avatar_url":"https://avatars.githubusercontent.com/u/1476506?v=4","gravatar_id":"","url":"https://api.github.com/users/tjwp","html_url":"https://github.com/tjwp","followers_url":"https://api.github.com/users/tjwp/followers","following_url":"https://api.github.com/users/tjwp/following{/other_user}","gists_url":"https://api.github.com/users/tjwp/gists{/gist_id}","starred_url":"https://api.github.com/users/tjwp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tjwp/subscriptions","organizations_url":"https://api.github.com/users/tjwp/orgs","repos_url":"https://api.github.com/users/tjwp/repos","events_url":"https://api.github.com/users/tjwp/events{/privacy}","received_events_url":"https://api.github.com/users/tjwp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-07-22T18:22:41Z","updated_at":"2022-09-01T20:59:45Z","closed_at":"2022-09-01T20:59:45Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nAssign to a JSON column a value that cannot be cast, serialized and deserialized. \r\n\r\nThe value will first be cast by calling serialize, followed by deserialize: \r\nhttps://github.com/rails/rails/blob/main/activemodel/lib/active_model/type/helpers/mutable.rb#L8\r\n\r\nWhen deserialize fails for a JSON value, the error is rescued and nil is returned:\r\nhttps://github.com/rails/rails/blob/main/activerecord/lib/active_record/type/json.rb#L14\r\n\r\nThis results in the attribute being set to nil with no indication that there was an error.\r\n\r\nOne way that a value can fail to be cast as JSON is that it is too deeply nested.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.json :data\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_setting_json_column\r\n    post = Post.new\r\n\r\n    # Generate a hash that serializes to JSON < 100 bytes\r\n    post.data = BigJson.serializable_hash\r\n    refute_equal nil, post.data, \"small JSON is set correctly\"\r\n\r\n    # Generate a deeply nested hash. The size here is large enough demonstrate the issue,\r\n    # but the error is due to nesting, not the size specifically.\r\n    nested_hash = BigJson.serializable_hash(30_000)\r\n\r\n    # Identify the error that is silently discarded when casting to ActiveModel::Type::Json\r\n    begin\r\n      ActiveSupport::JSON.decode(ActiveSupport::JSON.encode(nested_hash))\r\n    rescue => error\r\n    end\r\n    assert_equal JSON::NestingError, error.class\r\n    assert_equal \"nesting of 101 is too deep\", error.message\r\n\r\n    # Assigning the deeply nested hash will fail to cast as demonstrated above, and the\r\n    # attribute is silently set to nil\r\n    post.data = nested_hash\r\n    refute_equal nil, post.data, \"deeply nested JSON is not silently set to nil\"\r\n  end\r\nend\r\n\r\nclass BigJson\r\n  def self.serializable_hash(max_size = 100, current = nil)\r\n    current ||= { key: \"a\" }\r\n    if current.to_json.size < max_size\r\n      serializable_hash(max_size, { key: \"a\", previous: current })\r\n    else\r\n      current\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nAn error should be raised instead of silently setting the attribute to nil and discarding the data.\r\n\r\nIn the reproduction above the underlying error is `#<JSON::NestingError: nesting of 101 is too deep>`.\r\n\r\n### Actual behavior\r\n\r\nThe attribute is set to nil, and if the record is saved, and the model allows, the column is set to NULL.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45641/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45641/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45640","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45640/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45640/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45640/events","html_url":"https://github.com/rails/rails/issues/45640","id":1315219867,"node_id":"I_kwDNIULOTmSpmw","number":45640,"title":"ActiveModel::Dirty changes not reset properly when using store_accessor (tested with postgres)","user":{"login":"vccoffey","id":59817868,"node_id":"MDQ6VXNlcjU5ODE3ODY4","avatar_url":"https://avatars.githubusercontent.com/u/59817868?v=4","gravatar_id":"","url":"https://api.github.com/users/vccoffey","html_url":"https://github.com/vccoffey","followers_url":"https://api.github.com/users/vccoffey/followers","following_url":"https://api.github.com/users/vccoffey/following{/other_user}","gists_url":"https://api.github.com/users/vccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/vccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vccoffey/subscriptions","organizations_url":"https://api.github.com/users/vccoffey/orgs","repos_url":"https://api.github.com/users/vccoffey/repos","events_url":"https://api.github.com/users/vccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/vccoffey/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-22T16:44:57Z","updated_at":"2022-07-23T17:51:49Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nUsing PostgreSQL (pg) database\r\nGiven a model with a jsonb column\r\n```\r\nclass CreateTestModels < ActiveRecord::Migration[6.1]\r\n  def change\r\n    create_table :test_models do |t|\r\n      t.jsonb :jsonb_hash_attr\r\n      t.timestamps\r\n    end\r\n  end\r\nend\r\n```\r\nusing store_accessor\r\n```\r\nclass TestModel < ApplicationRecord\r\n  store_accessor :jsonb_hash_attr, :key, prefix: true\r\nend\r\n```\r\n\r\n### Expected behavior\r\nBoth tests pass:\r\n```\r\nrequire \"test_helper\"\r\nclass TestModelTest < ActiveSupport::TestCase\r\n  test \"does not show changes for a jsonb attribute if changed back to original value\" do\r\n    tm = TestModel.create jsonb_hash_attr: { \"key\" => \"foo\" }\r\n    tm.jsonb_hash_attr = { \"key\" => \"bar\" }\r\n    assert_equal tm.jsonb_hash_attr_change, [{ \"key\" => \"foo\" }, { \"key\" => \"bar\" }]\r\n    tm.jsonb_hash_attr = { \"key\" => \"foo\" }\r\n    assert_equal tm.jsonb_hash_attr_change, nil\r\n  end\r\n\r\n  test \"does not show changes for a jsonb attribute if changed back to original value using store_accessor\" do\r\n    tm = TestModel.create jsonb_hash_attr: { \"key\" => \"foo\" }\r\n    tm.jsonb_hash_attr_key = \"bar\"\r\n    assert_equal tm.jsonb_hash_attr_change, [{ \"key\" => \"foo\" }, { \"key\" => \"bar\" }]\r\n    tm.jsonb_hash_attr_key = \"foo\"\r\n    assert_equal tm.jsonb_hash_attr_change, nil\r\n  end\r\nend\r\n```\r\n### Actual behavior\r\nThe second test fails\r\n```\r\n--- expected\r\n+++ actual\r\n-[{\"key\"=>\"foo\"}, {\"key\"=>\"foo\"}]\r\n+nil\r\n```\r\n### System configuration\r\n**Rails version**:\r\ntested with 6.1.6.1 and 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45640/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45640/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45639","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45639/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45639/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45639/events","html_url":"https://github.com/rails/rails/issues/45639","id":1314984267,"node_id":"I_kwDNIULOTmERSw","number":45639,"title":"Explicitly touch on save","user":{"login":"schmijos","id":245443,"node_id":"MDQ6VXNlcjI0NTQ0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/245443?v=4","gravatar_id":"","url":"https://api.github.com/users/schmijos","html_url":"https://github.com/schmijos","followers_url":"https://api.github.com/users/schmijos/followers","following_url":"https://api.github.com/users/schmijos/following{/other_user}","gists_url":"https://api.github.com/users/schmijos/gists{/gist_id}","starred_url":"https://api.github.com/users/schmijos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/schmijos/subscriptions","organizations_url":"https://api.github.com/users/schmijos/orgs","repos_url":"https://api.github.com/users/schmijos/repos","events_url":"https://api.github.com/users/schmijos/events{/privacy}","received_events_url":"https://api.github.com/users/schmijos/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-22T13:05:14Z","updated_at":"2022-07-22T20:31:00Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  ruby \"3.1.0\"\r\n  gem \"rails\", \"7.0.3.1\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_save_touch\r\n    Post.create!(updated_at: 3.days.ago)\r\n    Post.last.save!(touch: true)\r\n\r\n    assert_in_delta 0.seconds.ago.to_i, Post.last.updated_at.to_i, 5\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nIf I tell _ActiveRecord_ to explicitly \"touch\", then I would expect it to update the timestamps.\r\n\r\n### Actual behavior\r\n`save` never hits the database if no attribute changed.\r\n\r\n### System configuration\r\n**Rails version**: >= 3.0.0, < 8","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45639/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45639/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45638","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45638/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45638/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45638/events","html_url":"https://github.com/rails/rails/issues/45638","id":1314662755,"node_id":"I_kwDNIULOTlwpYw","number":45638,"title":"CSRF Token Expiry issue.","user":{"login":"MBM1607","id":47133639,"node_id":"MDQ6VXNlcjQ3MTMzNjM5","avatar_url":"https://avatars.githubusercontent.com/u/47133639?v=4","gravatar_id":"","url":"https://api.github.com/users/MBM1607","html_url":"https://github.com/MBM1607","followers_url":"https://api.github.com/users/MBM1607/followers","following_url":"https://api.github.com/users/MBM1607/following{/other_user}","gists_url":"https://api.github.com/users/MBM1607/gists{/gist_id}","starred_url":"https://api.github.com/users/MBM1607/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MBM1607/subscriptions","organizations_url":"https://api.github.com/users/MBM1607/orgs","repos_url":"https://api.github.com/users/MBM1607/repos","events_url":"https://api.github.com/users/MBM1607/events{/privacy}","received_events_url":"https://api.github.com/users/MBM1607/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-22T08:38:19Z","updated_at":"2022-07-22T08:40:22Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"We are encountering an issue with form submission in production environment.\r\nThe criteria seems to be exceptionally rare, I have been unable to replicate the issue. \r\n\r\nCSRF token is created and validated just fine.\r\n\r\n### Timing\r\n\r\nIssue seems to occur only when users wait more than 2 hours on a form before submitting, but doing this we have been unable to reproduce as well.\r\n\r\n### Logs\r\n```\r\nW, [2022-07-14T15:19:37.535241 #2433]  WARN -- : Can't verify CSRF token authenticity.\r\nI, [2022-07-14T15:19:37.535556 #2433]  INFO -- : Completed 422 Unprocessable Entity in 1ms (ActiveRecord: 0.0ms | Allocations: 291)\r\nF, [2022-07-14T15:19:37.536425 #2433] FATAL -- :   \r\nActionController::InvalidAuthenticityToken (ActionController::InvalidAuthenticityToken):\r\n```\r\n\r\n### System configuration\r\n**Rails version 6.1.6** \r\n**Ruby version 2.7.4**\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45638/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45638/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45637","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45637/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45637/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45637/events","html_url":"https://github.com/rails/rails/issues/45637","id":1314550839,"node_id":"I_kwDNIULOTlp0Nw","number":45637,"title":"Template details defined in strings should either throw or be accepted correctly.","user":{"login":"axos88","id":1281218,"node_id":"MDQ6VXNlcjEyODEyMTg=","avatar_url":"https://avatars.githubusercontent.com/u/1281218?v=4","gravatar_id":"","url":"https://api.github.com/users/axos88","html_url":"https://github.com/axos88","followers_url":"https://api.github.com/users/axos88/followers","following_url":"https://api.github.com/users/axos88/following{/other_user}","gists_url":"https://api.github.com/users/axos88/gists{/gist_id}","starred_url":"https://api.github.com/users/axos88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/axos88/subscriptions","organizations_url":"https://api.github.com/users/axos88/orgs","repos_url":"https://api.github.com/users/axos88/repos","events_url":"https://api.github.com/users/axos88/events{/privacy}","received_events_url":"https://api.github.com/users/axos88/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-22T07:43:17Z","updated_at":"2022-08-16T20:05:29Z","closed_at":"2022-08-16T20:05:29Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n  - Create a template app/views/foo/bar.text.erb\r\n\r\n```ruby\r\ndetails = { locale: ['en'], formats: ['text'], handlers: ['erb'], variants: []}\r\nActionController::Base.view_paths.find('bar', 'foo', false, details, nil, [])\r\n```\r\n\r\n### Expected behavior\r\n\r\nRails should either throw an exception saying that details must be supplied as symbols, or the template should be correctly returned\r\n\r\n### Actual behavior\r\n\r\nSilently fails to find the otherwise existing template, specifying the correct directory it the file resides in.\r\nConfustion intensifies.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n**Ruby version**: 2.7.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45637/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45637/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45636","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45636/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45636/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45636/events","html_url":"https://github.com/rails/rails/issues/45636","id":1314546104,"node_id":"I_kwDNIULOTlphuA","number":45636,"title":"Invalid template types should raise an exception","user":{"login":"axos88","id":1281218,"node_id":"MDQ6VXNlcjEyODEyMTg=","avatar_url":"https://avatars.githubusercontent.com/u/1281218?v=4","gravatar_id":"","url":"https://api.github.com/users/axos88","html_url":"https://github.com/axos88","followers_url":"https://api.github.com/users/axos88/followers","following_url":"https://api.github.com/users/axos88/following{/other_user}","gists_url":"https://api.github.com/users/axos88/gists{/gist_id}","starred_url":"https://api.github.com/users/axos88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/axos88/subscriptions","organizations_url":"https://api.github.com/users/axos88/orgs","repos_url":"https://api.github.com/users/axos88/repos","events_url":"https://api.github.com/users/axos88/events{/privacy}","received_events_url":"https://api.github.com/users/axos88/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-22T07:40:54Z","updated_at":"2022-08-17T18:02:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n  - Create a template in views/foo/bar.txt.erb # Note .txt, and not .text\r\n\r\n```ruby\r\ndetails = { locale: [:en], formats: [:txt], handlers: [:erb], variants: []}\r\nActionController::Base.view_paths.find(\"bar\", 'foo', false, details, nil, [])\r\n```\r\n\r\n### Expected behavior\r\n\r\nShould throw an exception that :txt is not a registered type in Template::Types\r\n\r\n### Actual behavior\r\n\r\nSilently fails to find the otherwise existing template, specifying the correct directory it the file resides in. \r\nConfustion intensifies.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n**Ruby version**: 2.7.6","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45636/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45636/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45635","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45635/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45635/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45635/events","html_url":"https://github.com/rails/rails/issues/45635","id":1314015345,"node_id":"I_kwDNIULOTlJIcQ","number":45635,"title":"Recent security releases are missing from the Releases page","user":{"login":"georgeclaghorn","id":94129,"node_id":"MDQ6VXNlcjk0MTI5","avatar_url":"https://avatars.githubusercontent.com/u/94129?v=4","gravatar_id":"","url":"https://api.github.com/users/georgeclaghorn","html_url":"https://github.com/georgeclaghorn","followers_url":"https://api.github.com/users/georgeclaghorn/followers","following_url":"https://api.github.com/users/georgeclaghorn/following{/other_user}","gists_url":"https://api.github.com/users/georgeclaghorn/gists{/gist_id}","starred_url":"https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/georgeclaghorn/subscriptions","organizations_url":"https://api.github.com/users/georgeclaghorn/orgs","repos_url":"https://api.github.com/users/georgeclaghorn/repos","events_url":"https://api.github.com/users/georgeclaghorn/events{/privacy}","received_events_url":"https://api.github.com/users/georgeclaghorn/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","site_admin":false},"assignees":[{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-07-22T01:21:34Z","updated_at":"2022-08-19T18:08:06Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Rails versions 7.0.3.1, 6.1.6.1, 6.0.5.1, and 5.2.8.1 are not listed at this GitHub repository’s [Releases](https://github.com/rails/rails/releases) page. Past releases are listed there, including the most recent round of bugfix releases from May.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45635/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45635/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45634","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45634/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45634/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45634/events","html_url":"https://github.com/rails/rails/issues/45634","id":1313783838,"node_id":"I_kwDNIULOTk7AHg","number":45634,"title":"Check if database constraint exists before attempting to remove","user":{"login":"eudaimonious","id":2916661,"node_id":"MDQ6VXNlcjI5MTY2NjE=","avatar_url":"https://avatars.githubusercontent.com/u/2916661?v=4","gravatar_id":"","url":"https://api.github.com/users/eudaimonious","html_url":"https://github.com/eudaimonious","followers_url":"https://api.github.com/users/eudaimonious/followers","following_url":"https://api.github.com/users/eudaimonious/following{/other_user}","gists_url":"https://api.github.com/users/eudaimonious/gists{/gist_id}","starred_url":"https://api.github.com/users/eudaimonious/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eudaimonious/subscriptions","organizations_url":"https://api.github.com/users/eudaimonious/orgs","repos_url":"https://api.github.com/users/eudaimonious/repos","events_url":"https://api.github.com/users/eudaimonious/events{/privacy}","received_events_url":"https://api.github.com/users/eudaimonious/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-21T20:47:31Z","updated_at":"2022-08-03T18:41:24Z","closed_at":"2022-08-03T18:41:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I love the new ability to add and remove constraints. I can't use the remove_constraint feature as intended however. I can not guarantee that the constraint will exist on every environment the migration is run and the remove_constraint method is designed to raise an error if the the constraint does not exist. What about if, instead, we check whether the constraint exists, and if it does remove it, otherwise no-op\r\n\r\n[Relevant PR.](https://github.com/rails/rails/pull/31323)","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45634/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45634/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45632","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45632/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45632/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45632/events","html_url":"https://github.com/rails/rails/issues/45632","id":1312439669,"node_id":"I_kwDNIULOTjo9dQ","number":45632,"title":"`_read_attribute` method should also check whether an attribute is aliased or not","user":{"login":"khiav223577","id":4011729,"node_id":"MDQ6VXNlcjQwMTE3Mjk=","avatar_url":"https://avatars.githubusercontent.com/u/4011729?v=4","gravatar_id":"","url":"https://api.github.com/users/khiav223577","html_url":"https://github.com/khiav223577","followers_url":"https://api.github.com/users/khiav223577/followers","following_url":"https://api.github.com/users/khiav223577/following{/other_user}","gists_url":"https://api.github.com/users/khiav223577/gists{/gist_id}","starred_url":"https://api.github.com/users/khiav223577/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/khiav223577/subscriptions","organizations_url":"https://api.github.com/users/khiav223577/orgs","repos_url":"https://api.github.com/users/khiav223577/repos","events_url":"https://api.github.com/users/khiav223577/events{/privacy}","received_events_url":"https://api.github.com/users/khiav223577/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-21T03:14:22Z","updated_at":"2022-07-21T21:37:09Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```rb\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  gem \"activerecord\", '7.0.3'\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table \"users\", force: :cascade do |t|\r\n    t.string :name\r\n  end\r\n\r\n  create_table \"posts\", force: :cascade do |t|\r\n    t.string :title\r\n    t.integer :userId\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_many :posts\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  belongs_to :user\r\n\r\n  alias_attribute :user_id, :userId\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    user = User.create!(name: 'Tester')\r\n    post = Post.create!(user_id: user.id, title: 'Post A')\r\n  end\r\n\r\n  def test_has_many\r\n    assert_equal ['Post A'], User.first.posts.map(&:title)\r\n  end\r\n\r\n  def test_belongs_to\r\n    assert_equal 'Tester', Post.first.user&.name\r\n  end\r\nend\r\n```\r\n\r\nResult:\r\n```\r\nFinished in 0.059414s, 33.6619 runs/s, 33.6619 assertions/s.\r\n\r\n  1) Failure:\r\nBugTest#test_belongs_to [test.rb:53]:\r\nExpected: \"Tester\"\r\n  Actual: nil\r\n\r\n2 runs, 2 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### Expected behavior\r\n\r\nI run into this issue when I tried to add an association on an aliased attribute.\r\n\r\nThen I found `belongs_to_association` will use `_read_attribute` method to check if this `foreign_key` exists on this model or not.\r\nIt doesn't pass the condition, therefore `find_target` will not be triggered.\r\nhttps://github.com/rails/rails/blob/3272335f8f4739629283cdeff7c3db723f34a3f5/activerecord/lib/active_record/associations/association.rb#L172-L173\r\nhttps://github.com/rails/rails/blob/3272335f8f4739629283cdeff7c3db723f34a3f5/activerecord/lib/active_record/associations/association.rb#L274-L276\r\nhttps://github.com/rails/rails/blob/2ea5ff9e13b9c5d0d5d25b2441efa81a2de2a262/activerecord/lib/active_record/associations/belongs_to_association.rb#L133-L135\r\nhttps://github.com/rails/rails/blob/4ae0390c1051a39ec16a4a95451cd06172a1b260/activerecord/lib/active_record/attribute_methods/read.rb#L37-L39\r\n\r\nThe `read_attribute` method takes `attribute_alias` into consideration since https://github.com/rails/rails/pull/26529, while `_read_attribute` doesn't. I think it should, too.\r\n\r\n### Actual behavior\r\n\r\nSee the test script below.\r\n\r\n### System configuration\r\n**Rails version**: \r\n7.0.3.1\r\n\r\n**Ruby version**:\r\nruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45632/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45632/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45610","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45610/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45610/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45610/events","html_url":"https://github.com/rails/rails/issues/45610","id":1306841638,"node_id":"I_kwDNIULOTeTSJg","number":45610,"title":"System test with importmap","user":{"login":"rzepetor","id":90463267,"node_id":"MDQ6VXNlcjkwNDYzMjY3","avatar_url":"https://avatars.githubusercontent.com/u/90463267?v=4","gravatar_id":"","url":"https://api.github.com/users/rzepetor","html_url":"https://github.com/rzepetor","followers_url":"https://api.github.com/users/rzepetor/followers","following_url":"https://api.github.com/users/rzepetor/following{/other_user}","gists_url":"https://api.github.com/users/rzepetor/gists{/gist_id}","starred_url":"https://api.github.com/users/rzepetor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rzepetor/subscriptions","organizations_url":"https://api.github.com/users/rzepetor/orgs","repos_url":"https://api.github.com/users/rzepetor/repos","events_url":"https://api.github.com/users/rzepetor/events{/privacy}","received_events_url":"https://api.github.com/users/rzepetor/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-16T15:55:46Z","updated_at":"2022-08-17T05:05:28Z","closed_at":"2022-08-17T05:05:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have a \"Sign up\" link that has `data-turbo-frame` attribute, when test starts sometimes click is not intercepted by Turbo and nothing happens, but sometimes test run normally. \r\n\r\nI also noticed that on development server if I refresh website and quickly click \"Sign up\" button also nothing happens. I must wait some time (maybe second) to be able to Turbo works\r\n\r\n### Expected behavior\r\nCapybara tests should always starts only when all JS modules are loaded\r\n\r\n### Actual behavior\r\nSometimes JS modeles are not loaded before test starts\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45610/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45609","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45609/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45609/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45609/events","html_url":"https://github.com/rails/rails/issues/45609","id":1306840730,"node_id":"I_kwDNIULOTeTOmg","number":45609,"title":"Cannot add ActiveModel::Attribute::FromDatabase to permitted YAML safe load classes","user":{"login":"stanhu","id":963826,"node_id":"MDQ6VXNlcjk2MzgyNg==","avatar_url":"https://avatars.githubusercontent.com/u/963826?v=4","gravatar_id":"","url":"https://api.github.com/users/stanhu","html_url":"https://github.com/stanhu","followers_url":"https://api.github.com/users/stanhu/followers","following_url":"https://api.github.com/users/stanhu/following{/other_user}","gists_url":"https://api.github.com/users/stanhu/gists{/gist_id}","starred_url":"https://api.github.com/users/stanhu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stanhu/subscriptions","organizations_url":"https://api.github.com/users/stanhu/orgs","repos_url":"https://api.github.com/users/stanhu/repos","events_url":"https://api.github.com/users/stanhu/events{/privacy}","received_events_url":"https://api.github.com/users/stanhu/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-07-16T15:51:30Z","updated_at":"2022-08-18T11:39:07Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWe have some database entries serialized to YAML. For example:\r\n\r\n```\r\n---\r\n:custom_message: Repository Download Started\r\n:author_name: !ruby/object:DeployToken\r\n  concise_attributes:\r\n  - !ruby/object:ActiveModel::Attribute::FromDatabase\r\n    name: deploy_token_type\r\n    value_before_type_cast: 1\r\n  - !ruby/object:ActiveModel::Attribute::FromDatabase\r\n    name: id\r\n    value_before_type_cast: 2\r\n  - !ruby/object:ActiveModel::Attribute::FromDatabase\r\n    name: revoked\r\n    value_before_type_cast: false\r\n  - !ruby/object:ActiveModel::Attribute::FromDatabase\r\n    name: read_repository\r\n    value_before_type_cast: true\r\n```\r\n\r\nHowever, since the security release announced in https://rubyonrails.org/2022/7/12/Rails-Versions-7-0-3-1-6-1-6-1-6-0-5-1-and-5-2-8-1-have-been-released to address CVE-2022-32224, we cannot simply add `ActiveModel::Attribute::FromDatabase` to the permitted class list:\r\n\r\n```ruby\r\n(byebug) YAML.safe_load(payload, permitted_classes: [ActiveModel::Attribute::FromDatabase, Symbol, DeployToken], aliases: true)\r\n*** NameError Exception: private constant ActiveModel::Attribute::FromDatabase referenced\r\n```\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n### Expected behavior\r\n\r\nYAML loading should work. Should this constant no longer be private since it's been serialized to YAML?\r\n\r\n### Actual behavior\r\n\r\nYAML loading fails with:\r\n\r\n```\r\n*** NameError Exception: private constant ActiveModel::Attribute::FromDatabase referenced\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\nv6.1.6.1\r\n\r\n**Ruby version**:\r\nv2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45609/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45609/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45608","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45608/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45608/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45608/events","html_url":"https://github.com/rails/rails/issues/45608","id":1306721321,"node_id":"I_kwDNIULOTeL8KQ","number":45608,"title":"javascript_importmap_tags creating a browser error","user":{"login":"dvodvo","id":716130,"node_id":"MDQ6VXNlcjcxNjEzMA==","avatar_url":"https://avatars.githubusercontent.com/u/716130?v=4","gravatar_id":"","url":"https://api.github.com/users/dvodvo","html_url":"https://github.com/dvodvo","followers_url":"https://api.github.com/users/dvodvo/followers","following_url":"https://api.github.com/users/dvodvo/following{/other_user}","gists_url":"https://api.github.com/users/dvodvo/gists{/gist_id}","starred_url":"https://api.github.com/users/dvodvo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dvodvo/subscriptions","organizations_url":"https://api.github.com/users/dvodvo/orgs","repos_url":"https://api.github.com/users/dvodvo/repos","events_url":"https://api.github.com/users/dvodvo/events{/privacy}","received_events_url":"https://api.github.com/users/dvodvo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-16T06:11:39Z","updated_at":"2022-07-17T05:03:23Z","closed_at":"2022-07-17T05:03:23Z","author_association":"NONE","active_lock_reason":null,"body":"At present, a turbo frame includes an edit link, but processes the item as HTML, not TURBO_STREAM.\r\nWhile the code for executing the action appears correct, the console reports an error at edit:28:7 of the rendered HMTL, line 28 containing `<script type=\"module\">import \"application\"</script>`  which appears to be the source of the mis-process.\r\n\r\n### Steps to reproduce\r\n**Note** the following was tested with a new application: turbo stream worked as expected, but the console reported only the first of the two messages shown in 'actual behaviour' below.\r\n\r\nIt is my conclusion that there is another matter generating `Loading failed for the module with source “blob:http://localhost:3000/` browser complaint and impeding proper handling via turbo.\r\n\r\n\r\n`app/javascript/application.js` has the default content:\r\n```\r\n// Configure your import map in config/importmap.rb. Read more: https://github.com/rails/importmap-rails\r\nimport \"@hotwired/turbo-rails\"\r\nimport \"controllers\"\r\n```\r\napp/javascript/controllers has the 3 files generated at application creation time application.js, hello_controller.js, index.js\r\n\r\napplication.html.erb has:\r\n```\r\n    <%= stylesheet_link_tag \"application\", \"data-turbo-track\": \"reload\" %>\r\n    <%= javascript_importmap_tags %>\r\n    <% if controller_name == 'acqs' && action_name == 'active' %>\r\n      <script src=\"https://js.stripe.com/v3/\"></script>\r\n    <% end %>\r\n```\r\nRedis is running\r\n```\r\nbrew services info redis\r\nredis (homebrew.mxcl.redis)\r\nRunning: ✔\r\nLoaded: ✔\r\nSchedulable: ✘\r\n```\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nedit.html.erb\r\n```\r\n<%= turbo_frame_tag dom_id(@continent) do %>\r\n  <%= render 'form', continent: @continent %>\r\n  <%= link_to 'cancel', @continent %>\r\n<% end %>\r\n```\r\nshow.html.erb\r\n```\r\n<%= turbo_frame_tag dom_id(@continent) do %>\r\n  <div class=\"grid-x grid-padding-x\">\r\n    <div class='cell small-8'>\r\n      <%= render 'continent', continent: @continent %>\r\n    </div>\r\n    <div class='cell small-2'>\r\n      <%= link_to fa_icon('eye', class: 'fa-lg'), @continent %> <%= @continent.id %>\r\n    </div>\r\n    <div class='cell small-2'>\r\n      <%= link_to fa_icon('pencil-square-o', class: 'fa-lg'), edit_continent_path(@continent) %>\r\n    </div>\r\n  </div>\r\n<% end %>\r\n```\r\npartial _continent.html.erb\r\n```\r\n    <div id=\"<%= dom_id continent %>\">\r\n      <strong> <%= continent.name %></strong> \r\n    </div>\r\n```\r\n\r\nclilcking on the link leads to `Processing by ContinentsController#edit as HTML`\r\nnot TURBO_STREAM as expected.\r\n\r\nthe controller methods, invoking application_controller methods:\r\n```\r\n  def create\r\n    @continent = Continent.new(continent_params)\r\n    response_to_save(@continent, \"continent was successfully created.\")\r\n  end\r\n\r\n  def update\r\n    response_to_update(@continent, continent_params, \"continent was successfully updated.\")\r\n  end\r\n\r\n  def response_to_save(at_object, notice_msg)\r\n    respond_to do |format|\r\n      format.html\r\n      if at_object.save\r\n        redirect_to at_object, notice: notice_msg\r\n      else\r\n        render :new, status: :unprocessable_entity\r\n      end\r\n    end\r\n  end\r\n  \r\n  def response_to_update(at_object, paramz, notice_msg)\r\n    respond_to do |format|\r\n      format.html\r\n      if at_object.update(paramz)\r\n        redirect_to at_object, notice: notice_msg \r\n      else\r\n        render :edit, status: :unprocessable_entity\r\n      end\r\n    end\r\n  end\r\n```\r\n\r\n\r\n```ruby\r\n```\r\n\r\n### Expected behavior\r\n\r\na) absence of error\r\nb) process as TURBO_STREAM\r\nc) understand how to go about debugging `“blob:http://localhost:3000/26c607e0-890f-41e3-bc1c-1ac708362e80”.` error\r\n\r\n### Actual behavior\r\n\r\nconsole of browser reports\r\n```\r\nUncaught TypeError: Error resolving module specifier “application”. Relative module specifiers must start with “./”, “../” or “/”.\r\n\r\nLoading failed for the module with source “blob:http://localhost:3000/26c607e0-890f-41e3-bc1c-1ac708362e80”.\r\n\r\n```\r\nwith rendered HMTL\r\n```\r\n   <script type=\"importmap\" data-turbo-track=\"reload\">{\r\n  \"imports\": {\r\n    \"application\": \"/assets/application-37f365cbecf1fa2810a8303f4b6571676fa1f9c56c248528bc14ddb857531b95.js\",\r\n    \"@hotwired/turbo-rails\": \"/assets/turbo.min-e5023178542f05fc063cd1dc5865457259cc01f3fba76a28454060d33de6f429.js\",\r\n    \"@hotwired/stimulus\": \"/assets/stimulus.min-900648768bd96f3faeba359cf33c1bd01ca424ca4d2d05f36a5d8345112ae93c.js\",\r\n    \"@hotwired/stimulus-loading\": \"/assets/stimulus-loading-1fc59770fb1654500044afd3f5f6d7d00800e5be36746d55b94a2963a7a228aa.js\",\r\n    \"controllers/application\": \"/assets/controllers/application-368d98631bccbf2349e0d4f8269afb3fe9625118341966de054759d96ea86c7e.js\",\r\n    \"controllers/hello_controller\": \"/assets/controllers/hello_controller-549135e8e7c683a538c3d6d517339ba470fcfb79d62f738a0a089ba41851a554.js\",\r\n    \"controllers\": \"/assets/controllers/index-2db729dddcc5b979110e98de4b6720f83f91a123172e87281d5a58410fc43806.js\"\r\n  }\r\n}</script>\r\n<link rel=\"modulepreload\" href=\"/assets/application-37f365cbecf1fa2810a8303f4b6571676fa1f9c56c248528bc14ddb857531b95.js\">\r\n<link rel=\"modulepreload\" href=\"/assets/turbo.min-e5023178542f05fc063cd1dc5865457259cc01f3fba76a28454060d33de6f429.js\">\r\n<link rel=\"modulepreload\" href=\"/assets/stimulus.min-900648768bd96f3faeba359cf33c1bd01ca424ca4d2d05f36a5d8345112ae93c.js\">\r\n<link rel=\"modulepreload\" href=\"/assets/stimulus-loading-1fc59770fb1654500044afd3f5f6d7d00800e5be36746d55b94a2963a7a228aa.js\">\r\n<script type=\"esms-options\">{\"nonce\":null}</script>\r\n<script src=\"/assets/es-module-shims.min-b8099fffdbd758070d4801321d43b389c5b6174a50782f9f4cb57061533b7ac2.js\" async=\"async\" data-turbo-track=\"reload\"></script>\r\n<script type=\"module\">import \"application\"</script>\r\n\r\n```\r\n### System configuration\r\n**Rails version**:  7.0.3\r\n\r\n**Ruby version**:  3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45608/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45608/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45607","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45607/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45607/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45607/events","html_url":"https://github.com/rails/rails/issues/45607","id":1306332317,"node_id":"I_kwDNIULOTd0MnQ","number":45607,"title":"`ActionDispatch::ServerTiming` overwrites instead of appending to the `Server-Timing` header.","user":{"login":"jtmalinowski","id":645127,"node_id":"MDQ6VXNlcjY0NTEyNw==","avatar_url":"https://avatars.githubusercontent.com/u/645127?v=4","gravatar_id":"","url":"https://api.github.com/users/jtmalinowski","html_url":"https://github.com/jtmalinowski","followers_url":"https://api.github.com/users/jtmalinowski/followers","following_url":"https://api.github.com/users/jtmalinowski/following{/other_user}","gists_url":"https://api.github.com/users/jtmalinowski/gists{/gist_id}","starred_url":"https://api.github.com/users/jtmalinowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtmalinowski/subscriptions","organizations_url":"https://api.github.com/users/jtmalinowski/orgs","repos_url":"https://api.github.com/users/jtmalinowski/repos","events_url":"https://api.github.com/users/jtmalinowski/events{/privacy}","received_events_url":"https://api.github.com/users/jtmalinowski/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-15T17:57:59Z","updated_at":"2022-07-19T15:33:44Z","closed_at":"2022-07-19T15:33:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"`ActionDispatch::ServerTiming` overwrites instead of appending to the `Server-Timing` header.\r\n\r\nIn an application this can be solved by inserting the middleware before the `ActionDispatch::ServerTiming`, however in a library it is potentially difficult to consistently insert the middleware so that it executes after `ActionDispatch::ServerTiming` or at the right time if `ActionDispatch::ServerTiming` is not present in the middlewares stack.\r\n\r\nOur team would like to submit a PR which improves this behaviour and if possible (and needed) back-port it to Rails `6.x` and `5.x`. The change is really simple and straightforward, basically in `ActionDispatch::ServerTiming` we append to `Server-Timing` if it already has a value.\r\n\r\n### Steps to reproduce\r\nAdd a Railtie in a fresh Rails 7.0.3 app:\r\n\r\n```ruby\r\nmodule MyServerTiming\r\n  class MyMiddleware\r\n    def initialize(app)\r\n      @app = app\r\n    end\r\n\r\n    def call(env)\r\n      status, headers, body = @app.call(env)\r\n      headers[\"Server-Timing\"] = [headers[\"Server-Timing\"], %(myprop;desc=\"something\";dur=1)].compact.join(\", \")\r\n      [status, headers, body]\r\n    end\r\n  end\r\n\r\n  class Railtie < ::Rails::Railtie\r\n    config.before_initialize do |app|\r\n      app.middleware.use MyMiddleware\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nServer-Timing header does not include `myprop;desc=\"something\";dur=1`.\r\n\r\n### Actual behavior\r\nServer-Timing header should include `myprop` entry.\r\n\r\n### System configuration\r\n**Rails version**: `7.0.3.1`\r\n**Ruby version**: `3.1`, but it should not matter for the purpose of this issue\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45607/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45607/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45605","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45605/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45605/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45605/events","html_url":"https://github.com/rails/rails/issues/45605","id":1305800999,"node_id":"I_kwDNIULOTdTxJw","number":45605,"title":"`rails new --css bootstrap` can't patch some files on `rails  css:install:bootstrap`","user":{"login":"nleo","id":800970,"node_id":"MDQ6VXNlcjgwMDk3MA==","avatar_url":"https://avatars.githubusercontent.com/u/800970?v=4","gravatar_id":"","url":"https://api.github.com/users/nleo","html_url":"https://github.com/nleo","followers_url":"https://api.github.com/users/nleo/followers","following_url":"https://api.github.com/users/nleo/following{/other_user}","gists_url":"https://api.github.com/users/nleo/gists{/gist_id}","starred_url":"https://api.github.com/users/nleo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nleo/subscriptions","organizations_url":"https://api.github.com/users/nleo/orgs","repos_url":"https://api.github.com/users/nleo/repos","events_url":"https://api.github.com/users/nleo/events{/privacy}","received_events_url":"https://api.github.com/users/nleo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-15T09:26:57Z","updated_at":"2022-07-15T21:02:40Z","closed_at":"2022-07-15T21:02:40Z","author_association":"NONE","active_lock_reason":null,"body":"`rails new content_service -T -d postgresql --css bootstrap`\r\n\r\n![image](https://user-images.githubusercontent.com/800970/179195187-22545e95-5e5e-4254-880e-4fecfa5fa604.png)\r\n\r\n```\r\n       rails  css:install:bootstrap\r\nBuild into app/assets/builds\r\n       exist  app/assets/builds\r\n   identical  app/assets/builds/.keep\r\nFile unchanged! The supplied flag value not found!  app/assets/config/manifest.js\r\nStop linking stylesheets automatically\r\n        gsub  app/assets/config/manifest.js\r\nFile unchanged! The supplied flag value not found!  .gitignore\r\nFile unchanged! The supplied flag value not found!  .gitignore\r\nRemove app/assets/stylesheets/application.css so build output can take over\r\n      remove  app/assets/stylesheets/application.css\r\nAdd stylesheet link tag in application layout\r\nFile unchanged! The supplied flag value not found!  app/views/layouts/application.html.erb\r\n      append  Procfile.dev\r\nAdd bin/dev to start foreman\r\n   identical  bin/dev\r\nInstall Bootstrap with Bootstrap Icons and Popperjs/core\r\n      create  app/assets/stylesheets/application.bootstrap.scss\r\n         run  yarn add sass bootstrap bootstrap-icons @popperjs/core from \".\"\r\n```\r\n\r\n```\r\nruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\nRails 7.0.3.1\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45605/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45601","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45601/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45601/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45601/events","html_url":"https://github.com/rails/rails/issues/45601","id":1305227318,"node_id":"I_kwDNIULOTcwwNg","number":45601,"title":"Included in project gem with controller that inherits from ActionController::API breaks Jbuilder","user":{"login":"TakaiSaisei","id":34200381,"node_id":"MDQ6VXNlcjM0MjAwMzgx","avatar_url":"https://avatars.githubusercontent.com/u/34200381?v=4","gravatar_id":"","url":"https://api.github.com/users/TakaiSaisei","html_url":"https://github.com/TakaiSaisei","followers_url":"https://api.github.com/users/TakaiSaisei/followers","following_url":"https://api.github.com/users/TakaiSaisei/following{/other_user}","gists_url":"https://api.github.com/users/TakaiSaisei/gists{/gist_id}","starred_url":"https://api.github.com/users/TakaiSaisei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TakaiSaisei/subscriptions","organizations_url":"https://api.github.com/users/TakaiSaisei/orgs","repos_url":"https://api.github.com/users/TakaiSaisei/repos","events_url":"https://api.github.com/users/TakaiSaisei/events{/privacy}","received_events_url":"https://api.github.com/users/TakaiSaisei/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-14T19:55:55Z","updated_at":"2022-07-14T22:53:46Z","closed_at":"2022-07-14T22:52:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```rails new example_api --api```, ```bundle gem example_gem```, actual content of both can be seen in these commits:\r\nhttps://github.com/TakaiSaisei/example_gem/commit/83f3c802171f2c9b334feceb681e2059daaea672\r\nhttps://github.com/TakaiSaisei/example_api/commit/dd99c144278aecaab903ad05c62f402cb024c62d\r\n```shell\r\ngit clone https://github.com/TakaiSaisei/example_api.git && cd example_api\r\nbundle\r\nrails s\r\ncurl 127.0.0.1:3000/users.json\r\n```\r\n\r\n### Expected behavior\r\nTemplate ```views/users/index.json.jbuilder``` rendered\r\ncurl printed ```{\"users\":[{\"id\":1},{\"id\":2},{\"id\":3}]}```\r\n\r\n### Actual behavior\r\nRails will skip template rendering because the project includes a gem that have a controller that inherits from ActionController::API\r\n\r\nAs soon as the BaseController from the gem is inherited from ::Metal or ::Base, everything will work fine. If ApplicationController from Rails project inherits from ::Base (and ::Metal, I guess), everything will work fine. If gem is excluded from Gemfile, everything will work fine.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3.1\r\n**Ruby version**:\r\n3.1.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45601/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45601/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45600","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45600/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45600/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45600/events","html_url":"https://github.com/rails/rails/issues/45600","id":1304988160,"node_id":"I_kwDNIULOTciKAA","number":45600,"title":"intermittent \"uninitialized constant ActiveStorage::Attached (NameError)\" errors on Rails 6.1.6.1","user":{"login":"thekendalmiller","id":4512175,"node_id":"MDQ6VXNlcjQ1MTIxNzU=","avatar_url":"https://avatars.githubusercontent.com/u/4512175?v=4","gravatar_id":"","url":"https://api.github.com/users/thekendalmiller","html_url":"https://github.com/thekendalmiller","followers_url":"https://api.github.com/users/thekendalmiller/followers","following_url":"https://api.github.com/users/thekendalmiller/following{/other_user}","gists_url":"https://api.github.com/users/thekendalmiller/gists{/gist_id}","starred_url":"https://api.github.com/users/thekendalmiller/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thekendalmiller/subscriptions","organizations_url":"https://api.github.com/users/thekendalmiller/orgs","repos_url":"https://api.github.com/users/thekendalmiller/repos","events_url":"https://api.github.com/users/thekendalmiller/events{/privacy}","received_events_url":"https://api.github.com/users/thekendalmiller/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-14T16:02:06Z","updated_at":"2022-08-08T12:34:48Z","closed_at":"2022-08-08T12:34:48Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nUnfortunately it is very random and I have not figured out how to reproduce it.  It happens when starting the environment. My guess is it's related to zeitwerk as we recently upgrades to Rails 6.x\r\n\r\n```\r\nirb(main):001:0> Rails.application.config.autoloader\r\n=> :zeitwerk\r\nirb(main):002:0> Rails.application.config.eager_load\r\n=> true\r\n```\r\n\r\nThe missing constant we've seen the most is `ActiveStorage::Attached`. Our application code does not reference that class directly, but does use ActiveStorage.\r\n\r\nHere is the stack trace. \r\n\r\n```\r\n/home/my_app/vendor/bundle/ruby/2.7.0/gems/activestorage-6.1.6.1/lib/active_storage/attached.rb:8:in `<module:ActiveStorage>': uninitialized constant ActiveStorage::Attached (NameError)\r\n\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/activestorage-6.1.6.1/lib/active_storage/attached.rb:5:in `<main>'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:35:in `require'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/activestorage-6.1.6.1/lib/active_storage/engine.rb:118:in `block in <class:Engine>'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/railties-6.1.6.1/lib/rails/initializable.rb:32:in `instance_exec'\r\n\tfrom /home/my_app/vendor/bundle/ruby/2.7.0/gems/railties-6.1.6.1/lib/rails/initializable.rb:32:in `run'\r\n```\r\n\r\n### Expected behavior\r\nRails application should start\r\n\r\n### Actual behavior\r\nRoughly 2% of the time, the application fails to start with a missing constant related to a rails class. When looking at it today, it's been `ActiveStorage::Attached`\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 2.7.6p219\r\n\r\n**Zeitwerk version**: 2.6.0\r\n\r\n**Bootsnap version**: 1.12.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45600/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45600/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45598","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45598/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45598/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45598/events","html_url":"https://github.com/rails/rails/issues/45598","id":1304290506,"node_id":"I_kwDNIULOTb3kyg","number":45598,"title":"Rails 6.0.5.1: breaking change in ActiveRecord::Coders::YAMLColumn#yaml_load","user":{"login":"rocket-turtle","id":4182510,"node_id":"MDQ6VXNlcjQxODI1MTA=","avatar_url":"https://avatars.githubusercontent.com/u/4182510?v=4","gravatar_id":"","url":"https://api.github.com/users/rocket-turtle","html_url":"https://github.com/rocket-turtle","followers_url":"https://api.github.com/users/rocket-turtle/followers","following_url":"https://api.github.com/users/rocket-turtle/following{/other_user}","gists_url":"https://api.github.com/users/rocket-turtle/gists{/gist_id}","starred_url":"https://api.github.com/users/rocket-turtle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocket-turtle/subscriptions","organizations_url":"https://api.github.com/users/rocket-turtle/orgs","repos_url":"https://api.github.com/users/rocket-turtle/repos","events_url":"https://api.github.com/users/rocket-turtle/events{/privacy}","received_events_url":"https://api.github.com/users/rocket-turtle/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-14T05:51:15Z","updated_at":"2022-07-14T06:01:52Z","closed_at":"2022-07-14T06:01:52Z","author_association":"NONE","active_lock_reason":null,"body":"### Problem\r\n\r\nWe use the _audited_ gem and our tests fail with this exception:\r\n\r\n>      Psych::DisallowedClass:\r\n>        Tried to load unspecified class: ActiveSupport::TimeWithZone\r\n>      # .../ruby-2.7.6@mhmr/gems/audited-5.0.2/lib/audited/audit.rb:22:in `load'\r\n\r\n`obj = \"---\\nemail: oda1@swift.io\\nreset_password_sent_at:\\nlast_password_change: !ruby/object:ActiveSupport::TimeWithZone\\n  utc: 2022-07-14 05:41:52.142873000 Z\\n  zone: &1 !ruby/object:ActiveSupport::TimeZone\\n    name: Europe/Berlin\\n  time: 2022-07-14 07:41:52.142873000 Z\\n\"`\r\nhttps://github.com/collectiveidea/audited/blob/master/lib/audited/audit.rb#L22\r\n\r\nFor me the default for this change seems to be a breaking change:\r\nhttps://github.com/rails/rails/commit/2dfa064a2f302030d5ac29c06381091b01d58eb0\r\n\r\nIf I set `config.active_record.use_yaml_unsafe_load = true` everything works fine.\r\n\r\nWas that on purpose?\r\n\r\n### Expected behavior\r\nDefault of ActiveRecord::Base.use_yaml_unsafe_load should be true\r\n\r\n### Actual behavior\r\nDefault of ActiveRecord::Base.use_yaml_unsafe_load is false\r\n\r\n### System configuration\r\n**Rails version**: 6.0.5.1\r\n\r\n**Ruby version**: 2.7.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45598/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45598/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45596","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45596/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45596/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45596/events","html_url":"https://github.com/rails/rails/issues/45596","id":1304247666,"node_id":"I_kwDNIULOTb09cg","number":45596,"title":"Setting `schema_dump` in database.yml does not change dump format","user":{"login":"leboshi","id":16550140,"node_id":"MDQ6VXNlcjE2NTUwMTQw","avatar_url":"https://avatars.githubusercontent.com/u/16550140?v=4","gravatar_id":"","url":"https://api.github.com/users/leboshi","html_url":"https://github.com/leboshi","followers_url":"https://api.github.com/users/leboshi/followers","following_url":"https://api.github.com/users/leboshi/following{/other_user}","gists_url":"https://api.github.com/users/leboshi/gists{/gist_id}","starred_url":"https://api.github.com/users/leboshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leboshi/subscriptions","organizations_url":"https://api.github.com/users/leboshi/orgs","repos_url":"https://api.github.com/users/leboshi/repos","events_url":"https://api.github.com/users/leboshi/events{/privacy}","received_events_url":"https://api.github.com/users/leboshi/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-14T04:44:37Z","updated_at":"2022-07-14T14:34:25Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Originally brought up in #43173.  I opened PR #43240 to address it, but that was closed when it was decided #43530 did the same thing.  Unfortunately, I don't think any of us were really reading what the other was doing, because the two PRs actually each only addressed half the opened issue.\r\n\r\nPR incoming to fully address this and the second half of #43173!\r\n\r\n### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_schema_format_corresponds_with_schema_dump\r\n    Dir.mktmpdir do |dir|\r\n      ActiveRecord::Tasks::DatabaseTasks.stub(:db_dir, dir) do\r\n        old_configurations = ActiveRecord::Base.configurations\r\n        ActiveRecord::Base.configurations = {\r\n          \"development\" => {\r\n            \"primary\" => {\r\n              \"database\" => \"dev-db\",\r\n              \"schema_dump\" => \"primary_structure.sql\"\r\n            }\r\n          }\r\n        }\r\n\r\n        db_config = ActiveRecord::Base.configurations.configs_for(env_name: \"development\", name: \"primary\")\r\n        ActiveRecord::Tasks::DatabaseTasks.dump_schema(db_config)\r\n\r\n        dump_contents = File.read(File.join(dir, \"primary_structure.sql\"))\r\n        refute_match /ActiveRecord::Schema/, dump_contents\r\n        assert_match /CREATE TABLE/, dump_contents\r\n      ensure\r\n        ActiveRecord::Base.configurations = old_configurations\r\n        ActiveRecord::Base.clear_cache!\r\n      end\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nIf `schema_dump` is set to something like `primary_structure.sql`, I'd expect it to do a SQL structure dump rather than a Ruby schema dump.\r\n\r\n### Actual behavior\r\nThe filename in `schema_dump` has no bearing on the format of the dump Rails writes or expects to read.\r\n\r\n### System configuration\r\n**Rails version**: (main)\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45596/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45590","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45590/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45590/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45590/events","html_url":"https://github.com/rails/rails/issues/45590","id":1303616369,"node_id":"I_kwDNIULOTbObcQ","number":45590,"title":"Rails 6.1.6.1 with Ruby 2.5 throws ArgumentError: unknown keywords: permitted_classes, aliases","user":{"login":"ofedoren","id":32508194,"node_id":"MDQ6VXNlcjMyNTA4MTk0","avatar_url":"https://avatars.githubusercontent.com/u/32508194?v=4","gravatar_id":"","url":"https://api.github.com/users/ofedoren","html_url":"https://github.com/ofedoren","followers_url":"https://api.github.com/users/ofedoren/followers","following_url":"https://api.github.com/users/ofedoren/following{/other_user}","gists_url":"https://api.github.com/users/ofedoren/gists{/gist_id}","starred_url":"https://api.github.com/users/ofedoren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ofedoren/subscriptions","organizations_url":"https://api.github.com/users/ofedoren/orgs","repos_url":"https://api.github.com/users/ofedoren/repos","events_url":"https://api.github.com/users/ofedoren/events{/privacy}","received_events_url":"https://api.github.com/users/ofedoren/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":91966972,"node_id":"MDU6TGFiZWw5MTk2Njk3Mg==","url":"https://api.github.com/repos/rails/rails/labels/security","name":"security","color":"D94A4A","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","site_admin":false},"assignees":[{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2022-07-13T15:38:28Z","updated_at":"2022-09-06T04:59:06Z","closed_at":"2022-07-15T18:56:00Z","author_association":"NONE","active_lock_reason":null,"body":"Due to latest security update [1] backported to 6.1-stable Rails can no longer load on Ruby 2.5.\r\n\r\n[1] - https://github.com/rails/rails/commit/f05ac78bfc9d172abaa86a9da139c7933e4e79c5\r\n\r\nI guess it's due to simple overlook at the `safe_load` method version between different Rubies:\r\n\r\nRuby 2.5.9: https://ruby-doc.org/stdlib-2.5.9/libdoc/psych/rdoc/Psych.html#method-c-safe_load\r\nRuby 2.6.0: https://ruby-doc.org/stdlib-2.6/libdoc/psych/rdoc/Psych.html#method-c-safe_load\r\n\r\n### Steps to reproduce\r\n\r\nHave Rails 6.1.6.1 application running on Ruby 2.5.x.\r\n\r\n### Expected behavior\r\n\r\nRails works as before.\r\n\r\n### Actual behavior\r\n\r\nTrying to load application throws `[/usr/local/rvm/rubies/ruby-2.5.1/lib/ruby/2.5.0/psych.rb:313]:\r\nArgumentError: unknown keywords: permitted_classes, aliases`.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6.1\r\n\r\n**Ruby version**: 2.5.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45590/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45590/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45587","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45587/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45587/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45587/events","html_url":"https://github.com/rails/rails/issues/45587","id":1303550712,"node_id":"I_kwDNIULOTbKa-A","number":45587,"title":"Config `use_yaml_unsafe_load` breaks `assets:precompile` when without `config/database.yml`","user":{"login":"cmitz","id":5594436,"node_id":"MDQ6VXNlcjU1OTQ0MzY=","avatar_url":"https://avatars.githubusercontent.com/u/5594436?v=4","gravatar_id":"","url":"https://api.github.com/users/cmitz","html_url":"https://github.com/cmitz","followers_url":"https://api.github.com/users/cmitz/followers","following_url":"https://api.github.com/users/cmitz/following{/other_user}","gists_url":"https://api.github.com/users/cmitz/gists{/gist_id}","starred_url":"https://api.github.com/users/cmitz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmitz/subscriptions","organizations_url":"https://api.github.com/users/cmitz/orgs","repos_url":"https://api.github.com/users/cmitz/repos","events_url":"https://api.github.com/users/cmitz/events{/privacy}","received_events_url":"https://api.github.com/users/cmitz/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-13T14:48:26Z","updated_at":"2022-07-14T08:44:35Z","closed_at":"2022-07-13T22:43:28Z","author_association":"NONE","active_lock_reason":null,"body":"## Context\r\n\r\nWe have a Rails app that we dockerized using a multi-stage Dockerfile. `database.yml` is not available when precompiling the assets, as assets are static and we don't want a NodeJS exec runtime when running the Rails container, and database connection info is supplied at runtime via ENV variables.\r\n\r\n### Steps to reproduce\r\nDemo available at: https://github.com/cmitz/rails_demo_unsafe_yaml_db\r\n\r\nExecute `bundle exec rails assets:precompile` on:\r\n* Initial commit: https://github.com/cmitz/rails_demo_unsafe_yaml_db/commit/b68a71bb082a08a54806be20175a3ce25f314a67\r\n* Second commit: https://github.com/cmitz/rails_demo_unsafe_yaml_db/commit/c514108db6fa71804130de65b7c1e30d4142c350\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```bash\r\nbundle exec rails assets:precompile\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n**Build successfull!**\r\n\r\nConsole output:\r\n\r\n<details>\r\n\r\n```\r\nyarn install v1.21.1\r\n[1/4] 🔍  Resolving packages...\r\nsuccess Already up-to-date.\r\n✨  Done in 0.34s.\r\nI, [2022-07-13T16:43:52.583023 #67874]  INFO -- : Writing /Users/my_username/src/rails_demo_unsafe_yaml_db/public/assets/manifest-b4bf6e57a53c2bdb55b8998cc94cd00883793c1c37c5e5aea3ef6749b4f6d92b.js\r\nI, [2022-07-13T16:43:52.583268 #67874]  INFO -- : Writing /Users/my_username/src/rails_demo_unsafe_yaml_db/public/assets/manifest-b4bf6e57a53c2bdb55b8998cc94cd00883793c1c37c5e5aea3ef6749b4f6d92b.js.gz\r\nI, [2022-07-13T16:43:52.583411 #67874]  INFO -- : Writing /Users/my_username/src/rails_demo_unsafe_yaml_db/public/assets/application-b324c44f04a0d0da658824105489a2676d49df561c3d06723770321fd441977c.css\r\nI, [2022-07-13T16:43:52.583558 #67874]  INFO -- : Writing /Users/my_username/src/rails_demo_unsafe_yaml_db/public/assets/application-b324c44f04a0d0da658824105489a2676d49df561c3d06723770321fd441977c.css.gz\r\nCompiling...\r\nCompiled all packs in /Users/my_username/src/rails_demo_unsafe_yaml_db/public/packs\r\nHash: 83f44b586f0dbe4874e0\r\nVersion: webpack 4.46.0\r\nTime: 1058ms\r\nBuilt at: 07/13/2022 4:43:56 PM\r\n                                        Asset       Size  Chunks                         Chunk Names\r\n       js/application-ea49f96df08ec2f415e6.js   68.2 KiB       0  [emitted] [immutable]  application\r\n    js/application-ea49f96df08ec2f415e6.js.br   15.2 KiB          [emitted]\r\n    js/application-ea49f96df08ec2f415e6.js.gz   17.5 KiB          [emitted]\r\n   js/application-ea49f96df08ec2f415e6.js.map    201 KiB       0  [emitted] [dev]        application\r\njs/application-ea49f96df08ec2f415e6.js.map.br     43 KiB          [emitted]\r\njs/application-ea49f96df08ec2f415e6.js.map.gz   49.6 KiB          [emitted]\r\n                                manifest.json  364 bytes          [emitted]\r\n                             manifest.json.br  129 bytes          [emitted]\r\n                             manifest.json.gz  142 bytes          [emitted]\r\nEntrypoint application = js/application-ea49f96df08ec2f415e6.js js/application-ea49f96df08ec2f415e6.js.map\r\n[3] ./app/javascript/packs/application.js 480 bytes {0} [built]\r\n[4] ./app/javascript/channels/index.js 205 bytes {0} [built]\r\n[5] ./app/javascript/channels sync _channel\\.js$ 160 bytes {0} [built]\r\n    + 3 hidden modules\r\n\r\nExecution time: 0h:00m:09s sec\r\n```\r\n\r\n</details>\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n```\r\nmy_username ~/src/rails_demo_unsafe_yaml_db main $ be rails assets:precompile\r\nrails aborted!\r\nCannot load database configuration:\r\nCould not load database configuration. No such file - [\"config/database.yml\"]\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/config/environment.rb:5:in `<main>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/rails:5:in `<top (required)>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:10:in `require'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:10:in `block in <top (required)>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:7:in `tap'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:7:in `<top (required)>'\r\n\r\nCaused by:\r\nCould not load database configuration. No such file - [\"config/database.yml\"]\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/config/environment.rb:5:in `<main>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/rails:5:in `<top (required)>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:10:in `require'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:10:in `block in <top (required)>'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:7:in `tap'\r\n/Users/my_username/src/rails_demo_unsafe_yaml_db/bin/spring:7:in `<top (required)>'\r\nTasks: TOP => environment\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n> This step succeeds when I add an correct database.yml file\r\n\r\n### System configuration\r\n**Rails version**: `6.0.5.1`, `6.1.6.1`\r\n\r\n**Ruby version**: `2.6`, `2.7`\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45587/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45587/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45585","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45585/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45585/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45585/events","html_url":"https://github.com/rails/rails/issues/45585","id":1303519392,"node_id":"I_kwDNIULOTbIgoA","number":45585,"title":"7.0.3.1 breaks ActiveRecord.store with yaml coders.","user":{"login":"jdelStrother","id":2377,"node_id":"MDQ6VXNlcjIzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/2377?v=4","gravatar_id":"","url":"https://api.github.com/users/jdelStrother","html_url":"https://github.com/jdelStrother","followers_url":"https://api.github.com/users/jdelStrother/followers","following_url":"https://api.github.com/users/jdelStrother/following{/other_user}","gists_url":"https://api.github.com/users/jdelStrother/gists{/gist_id}","starred_url":"https://api.github.com/users/jdelStrother/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdelStrother/subscriptions","organizations_url":"https://api.github.com/users/jdelStrother/orgs","repos_url":"https://api.github.com/users/jdelStrother/repos","events_url":"https://api.github.com/users/jdelStrother/events{/privacy}","received_events_url":"https://api.github.com/users/jdelStrother/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-07-13T14:25:43Z","updated_at":"2022-07-20T08:45:34Z","closed_at":"2022-07-13T16:52:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nTry to use `ActiveRecord.store` in Rails 7.0.3.1 with the default YAML encoder\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"7.0.3.1\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.text :data\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  store :data, accessors: [:title]\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_store\r\n    post = Post.create!(title: \"who needs a schema?\")\r\n\r\n    assert_equal \"who needs a schema?\", post.title\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nIt should serialize simple values into the data column & back out, like it used to in Rails 7.0.3\r\n\r\n\r\n### Actual behavior\r\n\r\nIt raises Psych::DisallowedClass  -\r\n\r\n\r\n```\r\nPsych::DisallowedClass: Tried to load unspecified class: ActiveSupport::HashWithIndifferentAccess\r\n    RUBY/lib/ruby/3.0.0/psych/class_loader.rb:99:in `find'\r\n    RUBY/lib/ruby/3.0.0/psych/class_loader.rb:28:in `load'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/to_ruby.rb:424:in `resolve_class'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/to_ruby.rb:288:in `visit_Psych_Nodes_Mapping'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/visitor.rb:30:in `visit'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/visitor.rb:6:in `accept'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/to_ruby.rb:35:in `accept'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/to_ruby.rb:318:in `visit_Psych_Nodes_Document'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/visitor.rb:30:in `visit'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/visitor.rb:6:in `accept'\r\n    RUBY/lib/ruby/3.0.0/psych/visitors/to_ruby.rb:35:in `accept'\r\n    RUBY/lib/ruby/3.0.0/psych.rb:362:in `safe_load'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/coders/yaml_column.rb:50:in `yaml_load'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/coders/yaml_column.rb:26:in `load'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/store.rb:275:in `load'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/type/serialized.rb:22:in `deserialize'\r\n    GEMS/activemodel-7.0.3.1/lib/active_model/attribute.rb:168:in `type_cast'\r\n    GEMS/activemodel-7.0.3.1/lib/active_model/attribute.rb:43:in `value'\r\n    GEMS/activemodel-7.0.3.1/lib/active_model/attribute_set.rb:46:in `fetch_value'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/attribute_methods/read.rb:38:in `_read_attribute'\r\n    GEMS/activemodel-7.0.3.1/lib/active_model/attribute_methods.rb:277:in `data'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/store.rb:251:in `prepare'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/store.rb:222:in `read'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/store.rb:208:in `read_store_attribute'\r\n    GEMS/activerecord-7.0.3.1/lib/active_record/store.rb:140:in `block (3 levels) in store_accessor'\r\n    ar-store.rb:37:in `test_store'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3.1\r\n\r\n**Ruby version**: 3.0.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45585/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45585/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45573","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45573/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45573/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45573/events","html_url":"https://github.com/rails/rails/issues/45573","id":1302142414,"node_id":"I_kwDNIULOTZ0dzg","number":45573,"title":"Erroneous SQL when querying for empty has_one / has_many","user":{"login":"leoarnold","id":4201235,"node_id":"MDQ6VXNlcjQyMDEyMzU=","avatar_url":"https://avatars.githubusercontent.com/u/4201235?v=4","gravatar_id":"","url":"https://api.github.com/users/leoarnold","html_url":"https://github.com/leoarnold","followers_url":"https://api.github.com/users/leoarnold/followers","following_url":"https://api.github.com/users/leoarnold/following{/other_user}","gists_url":"https://api.github.com/users/leoarnold/gists{/gist_id}","starred_url":"https://api.github.com/users/leoarnold/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leoarnold/subscriptions","organizations_url":"https://api.github.com/users/leoarnold/orgs","repos_url":"https://api.github.com/users/leoarnold/repos","events_url":"https://api.github.com/users/leoarnold/events{/privacy}","received_events_url":"https://api.github.com/users/leoarnold/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-12T14:25:30Z","updated_at":"2022-07-12T18:20:26Z","closed_at":"2022-07-12T18:20:26Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  ruby '3.1.2'\r\n\r\n  gem 'rails', '7.0.2.4'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new($stdout)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :octopi, force: true\r\n\r\n  create_table :arms, force: true do |t|\r\n    t.belongs_to :octopus\r\n  end\r\n\r\n  create_table :mouths, force: true do |t|\r\n    t.belongs_to :octopus\r\n  end\r\nend\r\n\r\nclass Octopus < ActiveRecord::Base\r\n  has_many :arms\r\n  has_one :mouth\r\nend\r\n\r\nclass Arm < ActiveRecord::Base\r\n  belongs_to :octopus\r\nend\r\n\r\nclass Mouth < ActiveRecord::Base\r\n  belongs_to :octopus\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    Octopus.delete_all\r\n    Mouth.delete_all\r\n    Arm.delete_all\r\n  end\r\n\r\n  def test_has_one\r\n    mouth = Octopus.create!(mouth: Mouth.new).mouth\r\n    Octopus.create!(mouth: nil)\r\n\r\n    assert_equal 1, Octopus.where(mouth: mouth).count # PASS\r\n\r\n    # Expected:\r\n    assert_equal 1, ActiveRecord::Base.connection.execute(<<~SQL.squish).first['count']\r\n      SELECT count(*) AS count FROM \"octopi\" LEFT JOIN \"mouths\" ON \"mouths\".\"octopus_id\" = \"octopi\".\"id\" WHERE \"mouths\".\"octopus_id\" IS NULL\r\n    SQL\r\n\r\n    # Actual: SELECT count(*) FROM \"octopi\" WHERE \"octopi\".\"id\" IS NULL\r\n    assert_equal 1, Octopus.where(mouth: nil).count # FAIL\r\n  end\r\n\r\n  def test_has_many\r\n    Octopus.create!(arms: [Arm.new])\r\n    Octopus.create!\r\n\r\n    # Expected:\r\n    assert_equal 1, ActiveRecord::Base.connection.execute(<<~SQL.squish).first['count']\r\n      SELECT count(*) AS count FROM \"octopi\" LEFT JOIN \"arms\" ON \"arms\".\"octopus_id\" = \"octopi\".\"id\" WHERE \"arms\".\"octopus_id\" IS NULL\r\n    SQL\r\n    assert_equal 1, ActiveRecord::Base.connection.execute(<<~SQL.squish).first['count']\r\n      SELECT count(*) AS count FROM \"octopi\" LEFT JOIN \"arms\" ON \"arms\".\"octopus_id\" = \"octopi\".\"id\" WHERE \"arms\".\"octopus_id\" IS NOT NULL\r\n    SQL\r\n\r\n    # Actual: SELECT count(*) FROM \"octopi\" WHERE \"octopi\".\"id\" IS NULL\r\n    assert_equal 1, Octopus.where(arms: nil).count # FAIL\r\n    # Actual: SELECT count(*) FROM \"octopi\" WHERE \"octopi\".\"id\" IS NOT NULL\r\n    assert_equal 1, Octopus.where.not(arms: nil).count # FAIL\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nSee inline comments\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nSee inline comments\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45573/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45571","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45571/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45571/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45571/events","html_url":"https://github.com/rails/rails/issues/45571","id":1301653888,"node_id":"I_kwDNIULOTZWpgA","number":45571,"title":"MISSING_TRANSLATION from ActionView::Helpers::TranslationHelper is cached in the I18n cache and read back as a different Object","user":{"login":"rocket-turtle","id":4182510,"node_id":"MDQ6VXNlcjQxODI1MTA=","avatar_url":"https://avatars.githubusercontent.com/u/4182510?v=4","gravatar_id":"","url":"https://api.github.com/users/rocket-turtle","html_url":"https://github.com/rocket-turtle","followers_url":"https://api.github.com/users/rocket-turtle/followers","following_url":"https://api.github.com/users/rocket-turtle/following{/other_user}","gists_url":"https://api.github.com/users/rocket-turtle/gists{/gist_id}","starred_url":"https://api.github.com/users/rocket-turtle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocket-turtle/subscriptions","organizations_url":"https://api.github.com/users/rocket-turtle/orgs","repos_url":"https://api.github.com/users/rocket-turtle/repos","events_url":"https://api.github.com/users/rocket-turtle/events{/privacy}","received_events_url":"https://api.github.com/users/rocket-turtle/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-12T07:26:41Z","updated_at":"2022-07-15T20:06:29Z","closed_at":"2022-07-15T20:06:29Z","author_association":"NONE","active_lock_reason":null,"body":"We try upgrading to Rails 6.1 and have the following Problem.\r\nIf we call something like `t('some_untranslated_key', default: :hello)` in a view twice the result changes.\r\nThis can be reproduced with Rails Rails 7.0.3.\r\n\r\n```\r\n(ruby) t('some_untranslated_key', default: :hello)\r\n\"Hello world\"\r\n(ruby) t('some_untranslated_key', default: :hello)\r\n#<Object:0x00007f96ec466ce0>\r\n```\r\n\r\nIt might be related to this change https://github.com/rails/rails/commit/d81926fdacbeb384d211e22cff66195c1a753eb5.\r\nThe `translated` value from the I18n cache is not `true` for `translated.equal?(MISSING_TRANSLATION)`\r\nThe problem is not related to the `default` so I left it out for the example code.\r\n\r\n### Steps to reproduce\r\n\r\n-  Setup new Rails 7.0.3 application\r\n-  Add i18n caching\r\n-  Put two times the same untranslated i18n call into the view.\r\n\r\n```\r\ndiff --git a/config/initializers/i18n_cache.rb b/config/initializers/i18n_cache.rb\r\nnew file mode 100644\r\nindex 0000000..4e305d6\r\n--- /dev/null\r\n+++ b/config/initializers/i18n_cache.rb\r\n@@ -0,0 +1,3 @@\r\n+I18n::Backend::Simple.send(:include, I18n::Backend::Cache)\r\n+\r\n+I18n.cache_store = ActiveSupport::Cache.lookup_store(:memory_store)\r\n```\r\n\r\n```\r\nrailties-7.0.3/lib/rails/templates/rails/welcome/index.html.erb\r\n  <%= t('foo') %>\r\n  <%= t('foo') %>\r\n```\r\n\r\n### Expected behavior\r\nPrints the key of the translation two times\r\n\r\n### Actual behavior\r\nPrints the key on the first call and an object on the second call\r\n\r\n```\r\nFoo\r\n#<Object:0x00007fbece7dc668>\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n**Ruby version**: ruby 2.7.6p219 (2022-04-12 revision c9c2245c0a) [x86_64-darwin21]\r\n\r\n### Analysis\r\n**First call to t('foo')**\r\n\r\nactionview/lib/action_view/helpers/translation_helper.rb#translate\r\n- sets `default = MISSING_TRANSLATION`\r\n- `default` is `#<Object:0x00007fbece12c3b8>`\r\n- calls `translated = ActiveSupport::HtmlSafeTranslation.translate(key, **options, default: default)`\r\n\r\nactivesupport/lib/active_support/html_safe_translation.rb#translate\r\n- calls `I18n.translate(key, **options)`\r\n\r\ni18n-1.11.0/lib/i18n.rb#translate\r\n- calls `translate_key(key, throw, raise, locale, backend, options)`\r\n\r\ni18n-1.11.0/lib/i18n.rb#translate_key\r\n- calls `backend.translate(locale, key, options)`\r\n\r\ni18n-1.11.0/lib/i18n/backend/cache.rb#translate\r\n- `I18n.perform_caching?` is `true`\r\n- calls `fetch(cache_key(locale, key, options)) { super }`\r\n\r\ni18n-1.11.0/lib/i18n/backend/cache.rb#fetch\r\n- calls `result = _fetch(cache_key, &block)`\r\n- `result` is `#<Object:0x00007fbece12c3b8>`\r\n\r\ni18n-1.11.0/lib/i18n/backend/cache.rb#_fetch\r\n- calls `result = I18n.cache_store.read(cache_key)`\r\n- `result` is `nil`\r\n- ...\r\n- calls `result = catch(:exception, &block)`\r\n- `result` is `#<Object:0x00007fbece12c3b8>` that is the same as `MISSING_TRANSLATION`\r\n\r\nWhen I call `I18n.cache_store.read(cache_key)` now or later with a second call to `t('foo')` the result allways changes.\r\nExample: `#<Object:0x00007fbedd3a9ed8>`\r\n\r\n**Second call to t('foo')**\r\n\r\nactionview/lib/action_view/helpers/translation_helper.rb#translate\r\n- calls `translated = ActiveSupport::HtmlSafeTranslation.translate(key, **options, default: default)`\r\n- `translated` is `#<Object:0x00007fbece7dc668>` and `translated.equal?(MISSING_TRANSLATION)` is `false`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45571/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45571/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45568","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45568/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45568/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45568/events","html_url":"https://github.com/rails/rails/issues/45568","id":1301500772,"node_id":"I_kwDNIULOTZNTZA","number":45568,"title":"AutoLoader Customizing Inflections in initializers dir is not working for models in autoloaded_once_paths","user":{"login":"cantin","id":1147234,"node_id":"MDQ6VXNlcjExNDcyMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1147234?v=4","gravatar_id":"","url":"https://api.github.com/users/cantin","html_url":"https://github.com/cantin","followers_url":"https://api.github.com/users/cantin/followers","following_url":"https://api.github.com/users/cantin/following{/other_user}","gists_url":"https://api.github.com/users/cantin/gists{/gist_id}","starred_url":"https://api.github.com/users/cantin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cantin/subscriptions","organizations_url":"https://api.github.com/users/cantin/orgs","repos_url":"https://api.github.com/users/cantin/repos","events_url":"https://api.github.com/users/cantin/events{/privacy}","received_events_url":"https://api.github.com/users/cantin/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-07-12T03:57:26Z","updated_at":"2022-07-28T23:56:40Z","closed_at":"2022-07-28T23:56:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"[The customizing inflections section in Autoloading Rails guide](https://guides.rubyonrails.org/autoloading_and_reloading_constants.html#customizing-inflections) is not working for classes in autoloaded_once_paths.\r\n\r\nBecause the initializer `setup_once_autoloader` is run before the `load_config_initializers`.\r\n\r\n### Steps to reproduce\r\n\r\nRun following script:\r\n```bash\r\nrails new testapp && cd testapp\r\n# Add autoload_paths and autoload_once_paths in config/application.rb\r\nruby -i -pe 'gsub(/(class Application.+)/) { $1 + \"\\n config.autoload_once_paths += %W(autoload_once) \\n config.autoload_paths += %W(autoload)\" }' config/application.rb\r\n\r\nmkdir autoload_once autoload\r\necho \"class AI; end\" > autoload_once/ai.rb\r\necho \"class CI; end\" > autoload/ci.rb\r\n\r\ntouch config/initializers/zeitwerk.rb\r\n\r\n# add inflector\r\ncat <<-EOF > config/initializers/zeitwerk.rb\r\n  Rails.autoloaders.each do |autoloader|\r\n    autoloader.inflector.inflect(\r\n      \"ai\"   => \"AI\",\r\n      \"ci\"   => \"CI\"\r\n    )\r\n  end\r\nEOF\r\n\r\n# output CI successfully\r\nbundle exec rails r 'puts CI'\r\n\r\n# Error occurred: uninitialized constant AI\r\nbundle exec rails r 'puts AI'\r\n```\r\n\r\n### Expected behavior\r\n`bundle exec rails r 'puts AI'` should output AI\r\n\r\n### Actual behavior\r\nError occurred:  uninitialized constant AI\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45568/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45568/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45567","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45567/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45567/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45567/events","html_url":"https://github.com/rails/rails/issues/45567","id":1301261688,"node_id":"I_kwDNIULOTY-teA","number":45567,"title":"Record not touched when ActiveStorage::Blob is analyzed","user":{"login":"natematykiewicz","id":5104186,"node_id":"MDQ6VXNlcjUxMDQxODY=","avatar_url":"https://avatars.githubusercontent.com/u/5104186?v=4","gravatar_id":"","url":"https://api.github.com/users/natematykiewicz","html_url":"https://github.com/natematykiewicz","followers_url":"https://api.github.com/users/natematykiewicz/followers","following_url":"https://api.github.com/users/natematykiewicz/following{/other_user}","gists_url":"https://api.github.com/users/natematykiewicz/gists{/gist_id}","starred_url":"https://api.github.com/users/natematykiewicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/natematykiewicz/subscriptions","organizations_url":"https://api.github.com/users/natematykiewicz/orgs","repos_url":"https://api.github.com/users/natematykiewicz/repos","events_url":"https://api.github.com/users/natematykiewicz/events{/privacy}","received_events_url":"https://api.github.com/users/natematykiewicz/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-11T21:44:22Z","updated_at":"2022-07-26T16:34:20Z","closed_at":"2022-07-26T16:34:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true do |t|\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one_attached :profile\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_upload_and_download\r\n    user = User.create!(\r\n      profile: {\r\n        content_type: \"text/plain\",\r\n        filename: \"dummy.txt\",\r\n        io: ::StringIO.new(\"dummy\"),\r\n      }\r\n    )\r\n\r\n    old_updated_at = user.updated_at\r\n\r\n    # Sanity test, since some database adapters truncate microseconds\r\n    assert_equal user.reload.updated_at, old_updated_at\r\n\r\n    # Analyze the blob\r\n    user.profile.blob.analyze\r\n\r\n    # User should have been touched\r\n    refute_equal user.reload.updated_at, old_updated_at\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nAnalyzing an ActiveStorage Blob should touch all of the models that the blob is attached to.\r\n\r\n### Actual behavior\r\nThe model is untouched.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6\r\n\r\n**Ruby version**: 2.6\r\n\r\n\r\n### Additional Context\r\n\r\nActiveStorage Blobs are considered immutable. The table has no `updated_at` column, and the documentation states:\r\n\r\n> Blobs are intended to be immutable in as-so-far as their reference to a specific file goes. You're allowed to update a blob's metadata on a subsequent pass, but you should not update the key or change the uploaded file. If you need to create a derivative or otherwise change the blob, simply create a new blob and purge the old one.\r\n\r\nIn this case, I've added an analyzer and need to update old records to have the additional metadata. This is not a new concept, as Rails added a few new analyzers in Rails 7.0.0 and presumably people would like to have this additional metadata on old records. \r\nI ran `ActiveStorage::Blob.find_each(&:analyze_later)` to re-analyze my records, but this did not touch my model records that they're associated to, and therefore various caches were not invalidated.\r\n\r\nA similar problem can happen due to the fact that attachments are analyzed later. When an attachment is uploaded, `analyze_later` is called, and a background job then downloads the blob, analyzes it, and updates the `ActiveStorage::Blob` to have new metadata.\r\n\r\nThis means that it's very possible to experience this race condition:\r\n\r\n1. Upload attachment (this will create an ActiveStorage::Blob, ActiveStorage::Attachment, and `touch` the model) \r\n2. Enqueue analyze job\r\n3. Request record\r\n4. Build a cache for that record\r\n5. Analyze the attachment. \r\n6. Request the record again\r\n7. Serve a cache that doesn't include data from the analyzers, because the cache was built before it got analyzed, and the updated_at hasn't changed.\r\n\r\nRight now when an `ActiveStorage::Attachment` changes, the attachments's `record` is `touch`ed. I believe that when a Blob changes, all of the attachments' records should be updated as well.\r\n\r\nI'm currently running this patch and it does what I expect. I'm wondering if this feels like a PR that Rails would be willing to accept.\r\n\r\n```ruby\r\nmodule ActiveStorageBlobTouchAssociated\r\n  extend ActiveSupport::Concern\r\n\r\n  included do\r\n    after_update :touch_attachment_records, if: :saved_change_to_metadata?\r\n  end\r\n\r\nprivate\r\n\r\n  def touch_attachment_records\r\n    attachments.includes(:record).each do |attachment|\r\n      attachment.record.touch\r\n    end\r\n  end\r\nend\r\n\r\nActiveSupport.on_load :active_storage_blob do\r\n  include ActiveStorageBlobTouchAssociated\r\nend\r\n```\r\n\r\nAs an aside, it does make me wonder if the table should have an `updated_at`. While the file you've uploaded to your ActiveStorage Service (like S3) cannot change, the ActiveStorage::Blob can definitely change as analyzers are added/fixed, and more metadata is extracted from the raw file.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45567/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45567/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45566","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45566/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45566/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45566/events","html_url":"https://github.com/rails/rails/issues/45566","id":1301143161,"node_id":"I_kwDNIULOTY3eeQ","number":45566,"title":"Rails `button_to` form submission is detected as format turbo-stream incorrectly after redirect","user":{"login":"Ikariusrb","id":15335953,"node_id":"MDQ6VXNlcjE1MzM1OTUz","avatar_url":"https://avatars.githubusercontent.com/u/15335953?v=4","gravatar_id":"","url":"https://api.github.com/users/Ikariusrb","html_url":"https://github.com/Ikariusrb","followers_url":"https://api.github.com/users/Ikariusrb/followers","following_url":"https://api.github.com/users/Ikariusrb/following{/other_user}","gists_url":"https://api.github.com/users/Ikariusrb/gists{/gist_id}","starred_url":"https://api.github.com/users/Ikariusrb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ikariusrb/subscriptions","organizations_url":"https://api.github.com/users/Ikariusrb/orgs","repos_url":"https://api.github.com/users/Ikariusrb/repos","events_url":"https://api.github.com/users/Ikariusrb/events{/privacy}","received_events_url":"https://api.github.com/users/Ikariusrb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-07-11T19:44:10Z","updated_at":"2022-07-12T14:08:40Z","closed_at":"2022-07-12T14:08:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nGenerate a rails 7 application  (`rails new myapp`), scaffold a model (`rails g scaffold my_model`), update the index method in the model controller to respond to both HMTL and turbo_stream:\r\n\r\n```\r\n  def index\r\n    respond_to do |format|\r\n      format.html { @my_models = MyModel.all }\r\n      format.turbo_stream { raise StandardError.new('Wrong format!') }\r\n    end\r\n  end\r\n```\r\n\r\nCreate a single model on console (MyModel.new.save!) , and go to the show page for it (http://localhost:3000/my_models/1) - now click the \"destroy this MyModel\" button\r\n\r\n### Expected behavior\r\nThe MyModels index page should be rendered from the `redirect_to` of the form delete submission.\r\n### Actual behavior\r\nThe index method executes the turbo_stream format block, and raises an exception.\r\n### Notes\r\nThe `button_to` helper generates the following form: \r\n```\r\n<form class=\"button_to\" method=\"post\" action=\"/mymodels/2\"><input type=\"hidden\" name=\"_method\" value=\"delete\" autocomplete=\"off\"><button type=\"submit\">Destroy this my_model</button></form>\r\n```\r\nWhen that form is submitted, the following header is set on the request: \r\n```\r\nAccept: text/vnd.turbo-stream.html, text/html, application/xhtml+xml\r\n```\r\nThat accept header carries over to the GET following the redirect from the delete handler, and then it appears that Rails concludes the request format is `turbo-stream` rather than `html`.\r\n\r\nI have dropped debugging breakpoints in both the html and turbo-stream blocks for the controller index method and determined that the html format block is never called, only the turbo-stream format block. \r\n\r\nThere are no turbo-frames anywhere in the HTML in this reproduction.\r\n\r\n### System configuration\r\nrails version: **7.0.3**\r\n\r\nruby version: **3.1.2**\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45566/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45561","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45561/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45561/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45561/events","html_url":"https://github.com/rails/rails/issues/45561","id":1300660008,"node_id":"I_kwDNIULOTYZ_KA","number":45561,"title":"ActiveSupport:Cache:RedisCacheStore write_multi_entries with raw: true bug","user":{"login":"nivb121","id":57943249,"node_id":"MDQ6VXNlcjU3OTQzMjQ5","avatar_url":"https://avatars.githubusercontent.com/u/57943249?v=4","gravatar_id":"","url":"https://api.github.com/users/nivb121","html_url":"https://github.com/nivb121","followers_url":"https://api.github.com/users/nivb121/followers","following_url":"https://api.github.com/users/nivb121/following{/other_user}","gists_url":"https://api.github.com/users/nivb121/gists{/gist_id}","starred_url":"https://api.github.com/users/nivb121/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nivb121/subscriptions","organizations_url":"https://api.github.com/users/nivb121/orgs","repos_url":"https://api.github.com/users/nivb121/repos","events_url":"https://api.github.com/users/nivb121/events{/privacy}","received_events_url":"https://api.github.com/users/nivb121/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-11T12:44:22Z","updated_at":"2022-07-26T22:39:56Z","closed_at":"2022-07-26T22:39:56Z","author_association":"NONE","active_lock_reason":null,"body":"At function 'write_multi_entries', at:\r\nactivesupport-6.141/lib/active_support/cache/redis_cache_store.rb line 89\r\nentries.map returns `raw_entry.expires_at` which makes to_h function fails.\r\nThis can be fixed by returning [key, raw_entry] at the end of the mapped block.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\nconfig.cache_store = :redis_cache_store\r\n\r\nvalues_hash = { 'key1' => 'val1', 'key2' => 'val2' }\r\nRails.cache.write_multi(values_hash, { raw: true} )\r\n```\r\n\r\n### Expected behavior\r\nSuccessful writes to Redis\r\n\r\n### Actual behavior\r\nRaised Exception\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.1\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45561/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45561/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45560","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45560/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45560/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45560/events","html_url":"https://github.com/rails/rails/issues/45560","id":1300656524,"node_id":"I_kwDNIULOTYZxjA","number":45560,"title":"tag for v6.1.6 does not seem to live in this repository","user":{"login":"thomasdziedzic-census","id":83411925,"node_id":"MDQ6VXNlcjgzNDExOTI1","avatar_url":"https://avatars.githubusercontent.com/u/83411925?v=4","gravatar_id":"","url":"https://api.github.com/users/thomasdziedzic-census","html_url":"https://github.com/thomasdziedzic-census","followers_url":"https://api.github.com/users/thomasdziedzic-census/followers","following_url":"https://api.github.com/users/thomasdziedzic-census/following{/other_user}","gists_url":"https://api.github.com/users/thomasdziedzic-census/gists{/gist_id}","starred_url":"https://api.github.com/users/thomasdziedzic-census/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomasdziedzic-census/subscriptions","organizations_url":"https://api.github.com/users/thomasdziedzic-census/orgs","repos_url":"https://api.github.com/users/thomasdziedzic-census/repos","events_url":"https://api.github.com/users/thomasdziedzic-census/events{/privacy}","received_events_url":"https://api.github.com/users/thomasdziedzic-census/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-07-11T12:41:19Z","updated_at":"2022-08-17T11:05:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nVisit https://github.com/rails/rails/tree/v6.1.6 and you will see: \"This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.\".\r\n\r\nAlternatively:\r\n\r\n```\r\n% git checkout v6.1.6\r\nerror: pathspec 'v6.1.6' did not match any file(s) known to git\r\n```\r\n\r\n### Expected behavior\r\nSince 6.1.6 has been released, I expect there to be an associated tag in this repo. https://rubygems.org/gems/rails/versions/6.1.6\r\n\r\n### Actual behavior\r\nThe tag `v6.1.6` doesn't seem to exist.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45560/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45560/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45554","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45554/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45554/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45554/events","html_url":"https://github.com/rails/rails/issues/45554","id":1299601433,"node_id":"I_kwDNIULOTXZYGQ","number":45554,"title":"`ActionDispatch::Routing::RoutesProxy#merge_script_names` throws exceptions given certain arguments","user":{"login":"kenaniah","id":363800,"node_id":"MDQ6VXNlcjM2MzgwMA==","avatar_url":"https://avatars.githubusercontent.com/u/363800?v=4","gravatar_id":"","url":"https://api.github.com/users/kenaniah","html_url":"https://github.com/kenaniah","followers_url":"https://api.github.com/users/kenaniah/followers","following_url":"https://api.github.com/users/kenaniah/following{/other_user}","gists_url":"https://api.github.com/users/kenaniah/gists{/gist_id}","starred_url":"https://api.github.com/users/kenaniah/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kenaniah/subscriptions","organizations_url":"https://api.github.com/users/kenaniah/orgs","repos_url":"https://api.github.com/users/kenaniah/repos","events_url":"https://api.github.com/users/kenaniah/events{/privacy}","received_events_url":"https://api.github.com/users/kenaniah/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-09T07:55:35Z","updated_at":"2022-07-29T19:02:02Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Mount an engine in the routes file inside of a namespace (or sub path)\r\n2. Attempt to call a top-level route from the engine's route helper\r\n3. A runtime exception occurs -- NoMethodError: undefined method `join' for nil:NilClass\r\n\r\n### Test Case\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\nrequire \"rails\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    proxy = ActionDispatch::Routing::RoutesProxy.new(nil, nil, nil)\r\n    assert_equal \"/foo/bar\", proxy.send(:merge_script_names, \"\", \"/foo/bar\") #=> NoMethodError: undefined method `join' for nil:NilClass\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe engine's route helper (which is an instance of `ActionDispatch::Routing::RoutesProxy`) should return the requested url or path without throwing an exception.\r\n\r\n### Actual behavior\r\nhttps://github.com/rails/rails/blob/18707ab17fa492eb25ad2e8f9818a320dc20b823/actionpack/lib/action_dispatch/routing/routes_proxy.rb#L58-L66\r\n\r\n * `#merge_script_names` is invoked with two arguments, `\"\"` and `\"/foo/bar\"`\r\n * `resolved_parts` evaluates to `2`\r\n * `previous_parts` evaluates to `0`\r\n * `context_parts` evaluates to `-1` (!!!)\r\n * `previous_script_name.split(\"/\")` evaluates to an empty array\r\n * `Array#slice(0, -1)` is called, which evaluates to `nil` (but an array was expected)\r\n * `#join` is invoked on an instance of `NilClass`, because `#slice` did not return an array due to the negative value of the second argument\r\n\r\n### Suggested Remediation\r\n\r\n`context_parts` should probably be guarded to ensure a negative value isn't generated -- maybe something like:\r\n```ruby\r\ncontext_parts = [0, previous_parts - resolved_parts + 1].max\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: ruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45554/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45554/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45552","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45552/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45552/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45552/events","html_url":"https://github.com/rails/rails/issues/45552","id":1299474420,"node_id":"I_kwDNIULOTXRn9A","number":45552,"title":"Rails 7.0.3 Db migration with multiple Databases disturbing tasks name change when using database_tasks: in database.yml","user":{"login":"net1957","id":17736,"node_id":"MDQ6VXNlcjE3NzM2","avatar_url":"https://avatars.githubusercontent.com/u/17736?v=4","gravatar_id":"","url":"https://api.github.com/users/net1957","html_url":"https://github.com/net1957","followers_url":"https://api.github.com/users/net1957/followers","following_url":"https://api.github.com/users/net1957/following{/other_user}","gists_url":"https://api.github.com/users/net1957/gists{/gist_id}","starred_url":"https://api.github.com/users/net1957/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/net1957/subscriptions","organizations_url":"https://api.github.com/users/net1957/orgs","repos_url":"https://api.github.com/users/net1957/repos","events_url":"https://api.github.com/users/net1957/events{/privacy}","received_events_url":"https://api.github.com/users/net1957/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-07-08T22:00:48Z","updated_at":"2022-07-12T16:07:15Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nwith the following databse.yml\r\n```ruby\r\ndefault: &default\r\n  adapter: sqlite3\r\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\r\n  timeout: 5000\r\n\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n    database: db/development.sqlite3\r\n  comdev_fr:\r\n    <<: *default\r\n    migrations_paths: db/migrate_comdev_fr\r\n    database: db/development_comdev_fr.sqlite3\r\n```\r\nthe bin/rails -T return (filterer on db:migrate):\r\n\r\nrails db:migrate                         # Migrate the database (options: V...\r\nrails db:migrate:comdev_fr               # Migrate comdev_fr database for c...\r\nrails db:migrate:down                    # Runs the \"down\" for a given migr...\r\nrails db:migrate:primary                 # Migrate primary database for cur...\r\nrails db:migrate:redo                    # Rolls back the database one migr...\r\nrails db:migrate:redo:comdev_fr          # Rolls back comdev_fr database on...\r\nrails db:migrate:redo:primary            # Rolls back primary database one ...\r\nrails db:migrate:status                  # Display status of migrations\r\nrails db:migrate:status:comdev_fr        # Display status of migrations for...\r\nrails db:migrate:status:primary          # Display status of migrations for...\r\nrails db:migrate:up                      # Runs the \"up\" for a given migrat...\r\n\r\nin most update/install script we use only the tasks related to the primary db:\r\nrails db:migrate:primary                 # example\r\n\r\nWith the following databse.yml\r\n```ruby\r\ndefault: &default\r\n  adapter: sqlite3\r\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\r\n  timeout: 5000\r\n\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n    database: db/development.sqlite3\r\n  comdev_fr:\r\n    <<: *default\r\n    database_tasks: false\r\n    migrations_paths: db/migrate_comdev_fr\r\n    database: db/development_comdev_fr.sqlite3\r\n```\r\nthe bin/rails -T return (filterer on db:migrate):\r\n\r\nrails db:migrate                         # Migrate the database (options: V...\r\nrails db:migrate:down                    # Runs the \"down\" for a given migr...\r\nrails db:migrate:redo                    # Rolls back the database one migr...\r\nrails db:migrate:status                  # Display status of migrations\r\nrails db:migrate:up                      # Runs the \"up\" for a given migrat...\r\n\r\nand \r\nrails db:migrate:primary command is not found and so our script fail.\r\n\r\nI have tried with more DB and as soon only 1DB has database_tasks: true (the default),\r\nthe tasks related to multi-db don't exist any more\r\n\r\nI would be nice that in this case\r\nthe task related to the primary db don't disappear.\r\n\r\nrails db:migrate:primary  # should be here\r\n\r\n*** Why?\r\nIn the future if we add a new DB that support migrations, the commands for migrating the primary DB\r\nchange from \r\nrails db:migrate\r\nto\r\nrails db:migrate:primary\r\n\r\nand most time migration are done DB by DB in separate scripts, that we need to change.\r\n\r\nSo it would be nice  to allow the  task rails db:migrate:xxxx to exist even if it's the only DB with database_tasks: true (the default)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.0.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45552/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45552/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45551","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45551/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45551/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45551/events","html_url":"https://github.com/rails/rails/issues/45551","id":1299429953,"node_id":"I_kwDNIULOTXO6QQ","number":45551,"title":"ActiveRecord: Incorrect Mysql Connection Adapter Quoting handling","user":{"login":"dutompson","id":1041975,"node_id":"MDQ6VXNlcjEwNDE5NzU=","avatar_url":"https://avatars.githubusercontent.com/u/1041975?v=4","gravatar_id":"","url":"https://api.github.com/users/dutompson","html_url":"https://github.com/dutompson","followers_url":"https://api.github.com/users/dutompson/followers","following_url":"https://api.github.com/users/dutompson/following{/other_user}","gists_url":"https://api.github.com/users/dutompson/gists{/gist_id}","starred_url":"https://api.github.com/users/dutompson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dutompson/subscriptions","organizations_url":"https://api.github.com/users/dutompson/orgs","repos_url":"https://api.github.com/users/dutompson/repos","events_url":"https://api.github.com/users/dutompson/events{/privacy}","received_events_url":"https://api.github.com/users/dutompson/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-08T20:44:42Z","updated_at":"2022-07-12T23:57:17Z","closed_at":"2022-07-12T23:57:17Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n### Problem\r\n\r\nI'm running rake spec with a Mysql database named `database.name` with a dot in the middle of its name.\r\n\r\nWhen the code is ran it goes through this line:\r\n\r\nhttps://github.com/rails/rails/blob/3872bc0e54d32e8bf3a6299b0bfe173d94b072fc/activerecord/lib/active_record/connection_adapters/mysql/quoting.rb#L31\r\n\r\nThen the database name is escaped like this:\r\n\r\n``CREATE DATABASE `database`.`name` ``\r\n\r\nBut it should be:\r\n\r\n``CREATE DATABASE `database.name` ``\r\n\r\n\r\n### Solution\r\n\r\nChange this:\r\n\r\nhttps://github.com/rails/rails/blob/3872bc0e54d32e8bf3a6299b0bfe173d94b072fc/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb#L251-L266\r\n\r\nTo this:\r\n\r\n```ruby\r\n      def create_database(name, options = {})\r\n        if options[:collation]\r\n          execute \"CREATE DATABASE `#{name}` DEFAULT COLLATE #{quote_table_name(options[:collation])}\"\r\n        elsif options[:charset]\r\n          execute \"CREATE DATABASE `#{name}` DEFAULT CHARACTER SET #{quote_table_name(options[:charset])}\"\r\n        elsif row_format_dynamic_by_default?\r\n          execute \"CREATE DATABASE `#{name}` DEFAULT CHARACTER SET `utf8mb4`\"\r\n        else\r\n          raise \"Configure a supported :charset and ensure innodb_large_prefix is enabled to support indexes on varchar(255) string columns.\"\r\n        end\r\n      end\r\n\r\n      # Drops a MySQL database.\r\n      #\r\n      # Example:\r\n      #   drop_database('sebastian_development')\r\n      def drop_database(name) #:nodoc:\r\n        execute \"DROP DATABASE IF EXISTS `#{name}`\"\r\n```\r\n\r\n### System configuration\r\n\r\nActiveRecord: 6.1.4.4\r\n\r\nRuby version: 2.5.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45551/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45548","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45548/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45548/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45548/events","html_url":"https://github.com/rails/rails/issues/45548","id":1298872874,"node_id":"I_kwDNIULOTWs6Kg","number":45548,"title":"TimeWithZone#time returns incorrect time","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-08T11:09:34Z","updated_at":"2022-07-23T17:52:34Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n> jst = Time.find_zone!(\"Asia/Tokyo\").parse(\"2022-03-30T23:59:59Z\")\r\n> jst.utc\r\n=> 2022-03-30 23:59:59 UTC # correct\r\n> jst.time\r\n=> 2022-03-31 08:59:59 UTC # wrong\r\n```\r\n\r\n### Expected behavior\r\n\r\nReturns the time in the local time zone? Or if it returns UTC, it should at least match with the `TimeWithZone#utc`.\r\n\r\n### Actual behavior\r\n\r\nReturns UTC where the time zone offset is added/subtracted.\r\n\r\n### System configuration\r\n**Rails version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]\r\n\r\n**Ruby version**: Rails 7.0.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45548/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45548/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45547","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45547/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45547/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45547/events","html_url":"https://github.com/rails/rails/issues/45547","id":1298591586,"node_id":"I_kwDNIULOTWbvYg","number":45547,"title":"CSS File with [application-*.css] name causes \"No route matches\" error","user":{"login":"mfa777","id":2765931,"node_id":"MDQ6VXNlcjI3NjU5MzE=","avatar_url":"https://avatars.githubusercontent.com/u/2765931?v=4","gravatar_id":"","url":"https://api.github.com/users/mfa777","html_url":"https://github.com/mfa777","followers_url":"https://api.github.com/users/mfa777/followers","following_url":"https://api.github.com/users/mfa777/following{/other_user}","gists_url":"https://api.github.com/users/mfa777/gists{/gist_id}","starred_url":"https://api.github.com/users/mfa777/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfa777/subscriptions","organizations_url":"https://api.github.com/users/mfa777/orgs","repos_url":"https://api.github.com/users/mfa777/repos","events_url":"https://api.github.com/users/mfa777/events{/privacy}","received_events_url":"https://api.github.com/users/mfa777/received_events","type":"User","site_admin":false},"labels":[{"id":128693,"node_id":"MDU6TGFiZWwxMjg2OTM=","url":"https://api.github.com/repos/rails/rails/labels/asset%20pipeline","name":"asset pipeline","color":"d7e102","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-08T07:10:47Z","updated_at":"2022-07-13T02:33:53Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nFirst I use webpack and jsbundling-rails to build a CSS file from JavaScript code, which name is `application-webpack.css`, it located under builds folder.\r\n\r\n```\r\napp/assets\r\n├── builds\r\n│   ├── **application-webpack.css**\r\n│   ├── application.css\r\n│   ├── application.js\r\n│   └── application.js.LICENSE.txt\r\n```\r\n\r\nwebpack.config.js\r\n```javascript\r\nmodule.exports = {\r\n    mode,\r\n    optimization: {\r\n        moduleIds: 'hashed',\r\n    },\r\n    entry: {\r\n        application: \"./app/javascript/application.js\"\r\n    },\r\n    output: {\r\n        filename: \"[name].js\",\r\n        sourceMapFilename: \"[file].map\",\r\n        path: path.resolve(__dirname, '..', '..', 'app/assets/builds')\r\n    },\r\n    plugins: [\r\n        new webpack.optimize.LimitChunkCountPlugin({\r\n            maxChunks: 1\r\n        }),\r\n        new RemoveEmptyScriptsPlugin(),\r\n        new MiniCssExtractPlugin({\r\n            // **This will output application-webpack.css**\r\n            filename: \"[name]-webpack.css\"\r\n        }),\r\n    ],\r\n    module: {\r\n        rules: [{\r\n            // Add CSS/SASS/SCSS rule with loaders\r\n            {\r\n                test: /\\.(?:sa|sc|c)ss$/i,\r\n                use: [MiniCssExtractPlugin.loader, 'css-loader', 'sass-loader'],\r\n            },\r\n        ]\r\n    }\r\n}\r\n\r\n```\r\nThen include CSS from erb view:\r\n\r\n`<%= stylesheet_link_tag 'application', \"application-webpack\", media: 'all', 'data-turbo-track': 'reload' %>`\r\n\r\nThis will generate\r\n\r\n```html\r\n<link rel=\"stylesheet\" href=\"/assets/application-webpack.css\" media=\"all\" data-turbo-track=\"reload\" />\r\n<link rel=\"stylesheet\" href=\"/assets/application.css\" media=\"all\" data-turbo-track=\"reload\" />\r\n```\r\n\r\nWhen access \"http://dev-server/assets/application-webpack.css\" from browser, you will see 'No route matches [GET] \"/assets/application-webpack.css' error.\r\n\r\nIf I change the out file name to another name such as `a-webpack.css`, repeat same test, the route error will NOT raise any more.\r\n\r\nAfter do some google search, I found there's a similar issue: https://github.com/rails/rails/issues/44260\r\n\r\n### Expected behavior\r\nShould see CSS file content.\r\n\r\n### Actual behavior\r\nEncounter 'No route matches [GET] \"/assets/application-webpack.css' error.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.3\r\n**Ruby version**:\r\nruby 3.1.2p20","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45547/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45542","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45542/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45542/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45542/events","html_url":"https://github.com/rails/rails/issues/45542","id":1297492001,"node_id":"I_kwDNIULOTVYoIQ","number":45542,"title":"ActiveRecord: Bad handling of already loaded middle association in Associations::Preloaders::ThroughAssociation","user":{"login":"such","id":1303925,"node_id":"MDQ6VXNlcjEzMDM5MjU=","avatar_url":"https://avatars.githubusercontent.com/u/1303925?v=4","gravatar_id":"","url":"https://api.github.com/users/such","html_url":"https://github.com/such","followers_url":"https://api.github.com/users/such/followers","following_url":"https://api.github.com/users/such/following{/other_user}","gists_url":"https://api.github.com/users/such/gists{/gist_id}","starred_url":"https://api.github.com/users/such/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/such/subscriptions","organizations_url":"https://api.github.com/users/such/orgs","repos_url":"https://api.github.com/users/such/repos","events_url":"https://api.github.com/users/such/events{/privacy}","received_events_url":"https://api.github.com/users/such/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-07T13:57:01Z","updated_at":"2022-07-07T23:19:37Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activerecord\", \"7.0.2.4\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :cards, force: true do |t|\r\n    t.references :card_data\r\n  end\r\n\r\n  create_table :card_data, force: true do |t|\r\n    t.references :player\r\n  end\r\n\r\n  create_table :players, force: true do |t|\r\n    t.references :active_club\r\n  end\r\n\r\n  create_table :teams, force: true do |t|\r\n    t.string :type\r\n  end\r\nend\r\n\r\nclass Card < ActiveRecord::Base\r\n  belongs_to :card_data\r\n  has_one :player, through: :card_data\r\n  has_one :active_club, through: :player\r\nend\r\n\r\nclass CardData < ActiveRecord::Base\r\n  belongs_to :player\r\nend\r\n\r\nclass Player < ActiveRecord::Base\r\n  belongs_to :active_club, class_name: 'Club' # NB: if class_name: 'Team' this works\r\nend\r\n\r\nclass Team < ActiveRecord::Base\r\nend\r\n\r\nclass Club < Team\r\nend\r\n\r\nplayer = Player.create!\r\ncard_data = CardData.create!(player:)\r\ncard = Card.create!(card_data:)\r\n\r\ncard.reload.player # NB: if removed this works\r\n::ActiveRecord::Associations::Preloader.new(records: [card], associations: :active_club).call.then(&:first)\r\n```\r\n\r\n### Expected behavior\r\nThe association should be loaded properly\r\n\r\n### Actual behavior\r\n```\r\n/Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:31:in `block (2 levels) in records_by_owner': undefined method `[]' for nil:NilClass (NoMethodError)\r\n\r\n              source_records_by_owner[record]\r\n                                     ^^^^^^^^\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:30:in `each'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:30:in `flat_map'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:30:in `block in records_by_owner'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:14:in `each'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:14:in `each_with_object'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/through_association.rb:14:in `records_by_owner'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/association.rb:122:in `run'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/batch.rb:28:in `each'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader/batch.rb:28:in `call'\r\n\tfrom /Users/adrien/.rvm/gems/ruby-3.1.1@sorare/gems/activerecord-7.0.2.4/lib/active_record/associations/preloader.rb:118:in `call'\r\n\tfrom test_source_records_by_owner.rb:62:in `<main>'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45542/reactions","total_count":11,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":3,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45542/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45535","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45535/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45535/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45535/events","html_url":"https://github.com/rails/rails/issues/45535","id":1295825634,"node_id":"I_kwDNIULOTTy64g","number":45535,"title":"Getting \"Connection Closed: 1006\" when trying to establish a connection to ActionCable","user":{"login":"gustavothecoder","id":57065994,"node_id":"MDQ6VXNlcjU3MDY1OTk0","avatar_url":"https://avatars.githubusercontent.com/u/57065994?v=4","gravatar_id":"","url":"https://api.github.com/users/gustavothecoder","html_url":"https://github.com/gustavothecoder","followers_url":"https://api.github.com/users/gustavothecoder/followers","following_url":"https://api.github.com/users/gustavothecoder/following{/other_user}","gists_url":"https://api.github.com/users/gustavothecoder/gists{/gist_id}","starred_url":"https://api.github.com/users/gustavothecoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gustavothecoder/subscriptions","organizations_url":"https://api.github.com/users/gustavothecoder/orgs","repos_url":"https://api.github.com/users/gustavothecoder/repos","events_url":"https://api.github.com/users/gustavothecoder/events{/privacy}","received_events_url":"https://api.github.com/users/gustavothecoder/received_events","type":"User","site_admin":false},"labels":[{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-07-06T13:13:52Z","updated_at":"2022-07-16T22:27:30Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Expected behavior\r\nI would like my real-time chat using ActionCable to work in a production like environment using Redis as the adapter.\r\n\r\n### Actual behavior\r\nI'm building a real-time chat using ActionCable and it works very well locally, but when I deploy to a production like environment it stops to work. \r\n\r\n#### Browser\r\nNo error is displayed in the browser console, but non-stop requests to ActionCable mount point are made, and in all of them I get this response:\r\n\r\n![ac_stg](https://user-images.githubusercontent.com/57065994/177396450-cec6164b-57c0-4f5c-ba42-cab2443d56a7.png)\r\n\r\n#### Server logs\r\nFor each request, this is printed:\r\n```bash\r\n{\"method\":{},\"path\":{},\"format\":{},\"params\":null,\"controller\":\"ApplicationCable::Connection\",\"action\":\"connect\",\"status\":200,\"duration\":1.45}\r\n{\"method\":{},\"path\":{},\"format\":{},\"params\":null,\"controller\":\"ChatChannel\",\"action\":\"subscribe\",\"status\":200,\"duration\":0.53}\r\n```\r\n\r\n#### Redis connection\r\nI think the problem is here, because when I change the adapter to `async` my app works in all environments. \r\n\r\nChecking the connection with Redis directly from the ActionCable, I get this:\r\n```bash\r\nirb(main):006:0> ActionCable.server.pubsub.redis_connection_for_subscriptions.connected?\r\n=> false\r\nirb(main):007:0> ActionCable.server.pubsub.redis_connection_for_subscriptions._client\r\n=> #<Redis::Client:0x000055b89df3df30 @options={\"url\"=>\"redis://my-domain.com:6379/1\", \"id\"=>\"ActionCable-PID-2391\", \"scheme\"=>\"redis\", \"host\"=>\"my-domain.com\", \"port\"=>6379, \"path\"=>nil, \"timeout\"=>5.0, \"password\"=>nil, \"db\"=>1, \"driver\"=>Redis::Connection::Ruby, \"tcp_keepalive\"=>0, \"reconnect_attempts\"=>1, \"reconnect_delay\"=>0.0, \"reconnect_delay_max\"=>0.5, \"inherit_socket\"=>false, \"role\"=>:master, \"connect_timeout\"=>5.0, \"read_timeout\"=>5.0, \"write_timeout\"=>5.0, \"_parsed\"=>true}, @reconnect=true, @logger=nil, @connection=nil, @command_map={}, @pending_reads=0, @connector=#<Redis::Client::Connector:0x000055b89df978f0 @options={\"url\"=>\"redis://my-domain.com:6379/1\", \"id\"=>\"ActionCable-PID-2391\", \"scheme\"=>\"redis\", \"host\"=>\"my-domain.com\", \"port\"=>6379, \"path\"=>nil, \"timeout\"=>5.0, \"password\"=>nil, \"db\"=>1, \"driver\"=>Redis::Connection::Ruby, \"tcp_keepalive\"=>0, \"reconnect_attempts\"=>1, \"reconnect_delay\"=>0.0, \"reconnect_delay_max\"=>0.5, \"inherit_socket\"=>false, \"role\"=>:master, \"connect_timeout\"=>5.0, \"read_timeout\"=>5.0, \"write_timeout\"=>5.0, \"_parsed\"=>true}>>\r\nirb(main):008:0> ActionCable.server.pubsub.redis_connection_for_subscriptions.ping\r\nTraceback (most recent call last):\r\n        1: from (irb):8\r\nRedis::CommandError (ERR unknown command 'client')\r\n```\r\nCreating a connection myself (in the same environment), I get this:\r\n```bash\r\nirb(main):012:0> redis_conn = Redis.new(url: \"redis://my-domain.com:6379/1\")\r\n=> #<Redis client v4.1.3 for redis://my-domain.com:6379/1>\r\nirb(main):013:0> redis_conn.connected?\r\n=> false\r\nirb(main):014:0> redis_conn.ping\r\n=> \"PONG\"\r\nirb(main):015:0> redis_conn.connected?\r\n=> true\r\nirb(main):016:0> redis_conn.publish('ChatChannel', 'test')\r\n=> 0\r\n```\r\n\r\n#### My ActionCable code\r\nI think this is all the code relevant to the problem:\r\n```ruby\r\n# app/channels/chat_channel.rb\r\n\r\nclass ChatChannel < ApplicationCable::Channel\r\n  def subscribed\r\n    stream_from 'chat_channel'\r\n  end\r\n\r\n  def unsubscribed; end\r\nend\r\n```\r\n```ruby\r\n# config/application.rb\r\n\r\nconfig.action_cable.mount_path = '/cable'\r\n```\r\n```ruby\r\n# config/cable.yml\r\n\r\nlocal: &local\r\n  adapter: redis\r\n  url: redis://localhost:6379\r\n\r\ndevelopment: *local\r\n\r\ntest:\r\n  adapter: async\r\n\r\nproduction:\r\n  adapter: redis\r\n  url: <%= ENV['HOST_REDIS'] %>\r\n```\r\nOBS.: I've tried to putting the Redis url directly in `cable.yml` instead of using an environment variable, but I get the same error.\r\n\r\n```ruby\r\n# config/environments/production.rb\r\n\r\nconfig.action_cable.allowed_request_origins = [/http:\\/\\/*/, /https:\\/\\/*/]\r\n```\r\n```ruby\r\n# config/routes.rb\r\n\r\nmount ActionCable.server => '/cable'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.0.2.2\r\n**Ruby version**: 2.6.3\r\n**Redis**: 3.2\r\n**Browser**: Firefox 101.0.1 (I tried Chrome too)\r\n**OS**: Manjaro Linux","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45535/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45535/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45524","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45524/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45524/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45524/events","html_url":"https://github.com/rails/rails/issues/45524","id":1294150259,"node_id":"I_kwDNIULOTSMqcw","number":45524,"title":"The Asset Pipeline documentation references vendor/assets, but after creating a new project, I only see vendor/javascript. Is the documentation incorrect or am I missing Vendor/Assets?","user":{"login":"EarningEvolved","id":108590869,"node_id":"U_kgDOBnj3FQ","avatar_url":"https://avatars.githubusercontent.com/u/108590869?v=4","gravatar_id":"","url":"https://api.github.com/users/EarningEvolved","html_url":"https://github.com/EarningEvolved","followers_url":"https://api.github.com/users/EarningEvolved/followers","following_url":"https://api.github.com/users/EarningEvolved/following{/other_user}","gists_url":"https://api.github.com/users/EarningEvolved/gists{/gist_id}","starred_url":"https://api.github.com/users/EarningEvolved/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EarningEvolved/subscriptions","organizations_url":"https://api.github.com/users/EarningEvolved/orgs","repos_url":"https://api.github.com/users/EarningEvolved/repos","events_url":"https://api.github.com/users/EarningEvolved/events{/privacy}","received_events_url":"https://api.github.com/users/EarningEvolved/received_events","type":"User","site_admin":false},"labels":[{"id":128693,"node_id":"MDU6TGFiZWwxMjg2OTM=","url":"https://api.github.com/repos/rails/rails/labels/asset%20pipeline","name":"asset pipeline","color":"d7e102","default":false,"description":null},{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-05T11:09:07Z","updated_at":"2022-08-01T04:56:53Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hello All! I have an old Rails project I am converting over to the \"latest\" way of loading javascript/images/etc. I created a new project using rails new . git -d postgresql and proceeded to go through the newly created shell to see the various differences in how the project was set up. I clicked on the vendor directory and noticed the directory had a javascript directory. I assumed that folder holds the vendor specific javascript that needs to be added to the project and I went to the handy Asset Pipeline guide to read up on it. That guide is located here: https://guides.rubyonrails.org/asset_pipeline.html. The guide states, \r\n`Pipeline assets can be placed inside an application in one of three locations: app/assets, lib/assets or **vendor/assets**.`\r\n\r\nThe documentation goes on to state \r\n```\r\nPipeline assets can be placed inside an application in one of three locations: app/assets, lib/assets or vendor/assets.\r\n...\r\nvendor/assets is for assets that are owned by outside entities, such as code for JavaScript plugins and CSS frameworks. Keep in mind that third party code with references to other files also processed by the asset Pipeline (images, stylesheets, etc.), will need to be rewritten to use helpers like asset_path.\r\n```\r\n\r\nFinally, the guide states \r\n\r\n```\r\nFor example, these files:\r\n...\r\nvendor/assets/javascripts/slider.js\r\n\r\nwould be referenced in a manifest like this:\r\n...\r\n//= require slider\r\n```\r\n\r\nAll of these things lead me to believe that the scaffolding didn't create the correct structure and it should be \r\n\r\n- Vendor\r\n-      Assets\r\n-           Javascript\r\n\r\ninstead of \r\n\r\n- Vendor\r\n-     Javascript\r\n\r\nAlthough I know I can easily change the directory structure to be Vendor/Assets/Javascript, if a new user is following the guide and working to understand how the Asset Pipeline works and where their assets should go, this small error may add to their confusion concerning the correct way to set up their assets so the system will recognize them. This could also lead them to believe that the documentation is incorrect and possibly set their files up in a way that may/may not be recognized. I believe for consistency, the documentation and project scaffolding should match and Vendor/Javascript should be changed to Vendor/Assets to follow along with app/assets & lib/assets. \r\n\r\n![Vendor](https://user-images.githubusercontent.com/108590869/177314049-4ee66687-6d79-4d36-9e80-6f32cda6711d.png)\r\n\r\nFYI - I'm using:\r\nRuby  - 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\nRails   - 7.0.3\r\nPostgresql - 14.4\r\nWSL2\r\nUbuntu 22.04 LTS\r\n\r\nThank you, in advance, for taking the time to review this.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45524/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45519","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45519/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45519/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45519/events","html_url":"https://github.com/rails/rails/issues/45519","id":1293444226,"node_id":"I_kwDNIULOTRhkgg","number":45519,"title":"Images saved using ActiveStorage different in production and development environments","user":{"login":"Sega100500","id":584144,"node_id":"MDQ6VXNlcjU4NDE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/584144?v=4","gravatar_id":"","url":"https://api.github.com/users/Sega100500","html_url":"https://github.com/Sega100500","followers_url":"https://api.github.com/users/Sega100500/followers","following_url":"https://api.github.com/users/Sega100500/following{/other_user}","gists_url":"https://api.github.com/users/Sega100500/gists{/gist_id}","starred_url":"https://api.github.com/users/Sega100500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sega100500/subscriptions","organizations_url":"https://api.github.com/users/Sega100500/orgs","repos_url":"https://api.github.com/users/Sega100500/repos","events_url":"https://api.github.com/users/Sega100500/events{/privacy}","received_events_url":"https://api.github.com/users/Sega100500/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":30,"created_at":"2022-07-04T17:47:17Z","updated_at":"2022-07-07T15:13:31Z","closed_at":"2022-07-06T20:11:49Z","author_association":"NONE","active_lock_reason":null,"body":"### Expected behavior\r\nIn both environments same behavior\r\n\r\n### Actual behavior\r\nIn development environment saved (attach) image in content-page within `gem ckeditor` using `ActiveStorage` with `mini_magick` - then in production environment image are not showed, and vice versa - saved in production, then are not showed in development. I use **same database** (mysql) in development and production environments.\r\n\r\n### System configuration\r\n- **Ruby version**: 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n- **Rails version**: 7.0.3\r\n- gem [ckeditor](https://github.com/galetahub/ckeditor) 5.1.1\r\n\r\n```\r\n# storage.yml\r\nlocal:\r\n  service: Disk\r\n  root: <%= Rails.root.join(\"storage\") %>\r\n```\r\n\r\nIn production environment I use config: \r\n```ruby\r\nconfig.assets.compile = true\r\nconfig.active_storage.service = :local\r\nconfig.active_storage.variant_processor = :mini_magick\r\n```\r\nin development:\r\n```ruby\r\nconfig.active_storage.service = :local\r\nconfig.active_storage.variant_processor = :mini_magick\r\n```\r\n\r\nsaved image in source code of page show like this:\r\n```\r\n<img alt=\"\" src=\"/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDUT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--68a08d9de8f843ecd8b5c5be61d33859a3333bb7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2QzNKbGMybDZaVWtpQ1Rnd01ENEdPd1pVIiwiZXhwIjpudWxsLCJwdXIiOiJ2YXJpYXRpb24ifX0=--2ccbd7d12a252e03eb26bb2401505e4efaeff669/7d85fe9c160bb2f3b559a45303cc8ce4.jpg\" style=\"width: 700px; height: 475px;\" />\r\n```\r\n\r\n### The problem, most likely, is in the ActiveStorage, because the `gem ckeditor` works correctly with other configurations\r\n\r\n@rafaelfranca\r\n#### It is not `sprockets-rails` issue but ActiveStorage","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45519/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45519/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45516","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45516/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45516/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45516/events","html_url":"https://github.com/rails/rails/issues/45516","id":1293238677,"node_id":"I_kwDNIULOTRVBlQ","number":45516,"title":"[Active-Record] Using .pluck with DISTINCT ON drops DISTINCT from the query","user":{"login":"asad-u","id":62687519,"node_id":"MDQ6VXNlcjYyNjg3NTE5","avatar_url":"https://avatars.githubusercontent.com/u/62687519?v=4","gravatar_id":"","url":"https://api.github.com/users/asad-u","html_url":"https://github.com/asad-u","followers_url":"https://api.github.com/users/asad-u/followers","following_url":"https://api.github.com/users/asad-u/following{/other_user}","gists_url":"https://api.github.com/users/asad-u/gists{/gist_id}","starred_url":"https://api.github.com/users/asad-u/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asad-u/subscriptions","organizations_url":"https://api.github.com/users/asad-u/orgs","repos_url":"https://api.github.com/users/asad-u/repos","events_url":"https://api.github.com/users/asad-u/events{/privacy}","received_events_url":"https://api.github.com/users/asad-u/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-07-04T14:17:48Z","updated_at":"2022-07-04T16:33:29Z","closed_at":"2022-07-04T16:33:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nModel.select(\"DISTINCT ON (table.uniq_key) table.*\").pluck(:uniq_key)\r\n# SELECT \"table\".\"uniq_key\" FROM \"table\"\r\n\r\nModel.select(\"DISTINCT table.uniq_key\").pluck(:uniq_key)\r\n# SELECT \"table\".\"uniq_key\" FROM \"table\"\r\n```\r\n\r\nBoth of the above examples return non-distinct results.\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n```ruby\r\nModel.select(\"DISTINCT ON (table.uniq_key) table.*\").pluck(:uniq_key)\r\n# SELECT DISTINCT ON (table.uniq_key) table.* FROM \"table\" \r\n\r\nModel.select(\"DISTINCT table.uniq_key\").pluck(:uniq_key)\r\n# SELECT DISTINCT ON table.uniq_key FROM \"table\" \r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nDISTINCT ON gets dropped from the query which results in non-unique results.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.4\r\n\r\n**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux-musl]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45516/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45516/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45510","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45510/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45510/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45510/events","html_url":"https://github.com/rails/rails/issues/45510","id":1292241402,"node_id":"I_kwDNIULOTQYJ-g","number":45510,"title":"Why does sprockets require a manifest file config/<engine_name>.js while rails generates config/<engine_name>_manifest.js ?","user":{"login":"Sega100500","id":584144,"node_id":"MDQ6VXNlcjU4NDE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/584144?v=4","gravatar_id":"","url":"https://api.github.com/users/Sega100500","html_url":"https://github.com/Sega100500","followers_url":"https://api.github.com/users/Sega100500/followers","following_url":"https://api.github.com/users/Sega100500/following{/other_user}","gists_url":"https://api.github.com/users/Sega100500/gists{/gist_id}","starred_url":"https://api.github.com/users/Sega100500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sega100500/subscriptions","organizations_url":"https://api.github.com/users/Sega100500/orgs","repos_url":"https://api.github.com/users/Sega100500/repos","events_url":"https://api.github.com/users/Sega100500/events{/privacy}","received_events_url":"https://api.github.com/users/Sega100500/received_events","type":"User","site_admin":false},"labels":[{"id":128693,"node_id":"MDU6TGFiZWwxMjg2OTM=","url":"https://api.github.com/repos/rails/rails/labels/asset%20pipeline","name":"asset pipeline","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-03T08:20:17Z","updated_at":"2022-07-04T17:55:28Z","closed_at":"2022-07-04T17:55:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Expected behavior\r\n\r\nUsing manifest file generated by `rails` or generate manifest file required to `sprockets` within engine.\r\n\r\n### Actual behavior\r\n\r\nWhen `rails` is generates engine <engine_name> it create file <engine_name>/app/assets/config/<engine_name>_manifest.js\r\n```\r\nrails plugin new engine_name --mountable --full\r\n```\r\nBut `sprockets` needs file <engine_name>/app/assets/config/<engine_name>.js\r\nwith adding to main application `app/assets/config/manifest.js` :\r\n```javascript\r\n//= link engine_name\r\n```\r\n\r\nIt's misleading when edit a file `<engine_name>/app/assets/config/<engine_name>_manifest.js` and don't get the effect.\r\n\r\n### System configuration\r\n\r\n- Sprockets version 4.1.1\r\n- Ruby version 3.1.2\r\n- Rails version 7.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45510/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45510/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45517","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45517/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45517/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45517/events","html_url":"https://github.com/rails/rails/issues/45517","id":1293395618,"node_id":"I_kwDNIULOTRemog","number":45517,"title":"Why does sprockets require a manifest file config/<engine_name>.js while rails generates config/<engine_name>_manifest.js ?","user":{"login":"Sega100500","id":584144,"node_id":"MDQ6VXNlcjU4NDE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/584144?v=4","gravatar_id":"","url":"https://api.github.com/users/Sega100500","html_url":"https://github.com/Sega100500","followers_url":"https://api.github.com/users/Sega100500/followers","following_url":"https://api.github.com/users/Sega100500/following{/other_user}","gists_url":"https://api.github.com/users/Sega100500/gists{/gist_id}","starred_url":"https://api.github.com/users/Sega100500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sega100500/subscriptions","organizations_url":"https://api.github.com/users/Sega100500/orgs","repos_url":"https://api.github.com/users/Sega100500/repos","events_url":"https://api.github.com/users/Sega100500/events{/privacy}","received_events_url":"https://api.github.com/users/Sega100500/received_events","type":"User","site_admin":false},"labels":[{"id":128693,"node_id":"MDU6TGFiZWwxMjg2OTM=","url":"https://api.github.com/repos/rails/rails/labels/asset%20pipeline","name":"asset pipeline","color":"d7e102","default":false,"description":null},{"id":4782967,"node_id":"MDU6TGFiZWw0NzgyOTY3","url":"https://api.github.com/repos/rails/rails/labels/engines","name":"engines","color":"e102d8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-03T08:16:10Z","updated_at":"2022-07-04T17:53:40Z","closed_at":"2022-07-04T17:53:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Expected behavior\r\n\r\nUsing manifest file generated by `rails` or generate manifest file required to `sprockets` within engine.\r\n\r\n### Actual behavior\r\n\r\nWhen `rails` is generates engine <engine_name> it create file <engine_name>/app/assets/config/<engine_name>_manifest.js\r\n```\r\nrails plugin new engine_name --mountable --full\r\n```\r\nBut `sprockets` needs file <engine_name>/app/assets/config/<engine_name>.js\r\nwith adding to main application `app/assets/config/manifest.js` :\r\n```javascript\r\n//= link engine_name\r\n```\r\n\r\nIt's misleading when edit a file `<engine_name>/app/assets/config/<engine_name>_manifest.js` and don't get the effect.\r\n\r\n### System configuration\r\n\r\n- Sprockets version 4.1.1\r\n- Ruby version 3.1.2\r\n- Rails version 7.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45517/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45517/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45509","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45509/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45509/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45509/events","html_url":"https://github.com/rails/rails/issues/45509","id":1292207069,"node_id":"I_kwDNIULOTQWD3Q","number":45509,"title":"Gmail account update ","user":{"login":"Ar901hasan","id":103959955,"node_id":"U_kgDOBjJNkw","avatar_url":"https://avatars.githubusercontent.com/u/103959955?v=4","gravatar_id":"","url":"https://api.github.com/users/Ar901hasan","html_url":"https://github.com/Ar901hasan","followers_url":"https://api.github.com/users/Ar901hasan/followers","following_url":"https://api.github.com/users/Ar901hasan/following{/other_user}","gists_url":"https://api.github.com/users/Ar901hasan/gists{/gist_id}","starred_url":"https://api.github.com/users/Ar901hasan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ar901hasan/subscriptions","organizations_url":"https://api.github.com/users/Ar901hasan/orgs","repos_url":"https://api.github.com/users/Ar901hasan/repos","events_url":"https://api.github.com/users/Ar901hasan/events{/privacy}","received_events_url":"https://api.github.com/users/Ar901hasan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-03T04:50:25Z","updated_at":"2022-07-03T05:25:20Z","closed_at":"2022-07-03T05:25:20Z","author_association":"NONE","active_lock_reason":null,"body":"> Arhasan617@gmail.com\r\n\r\nhttps://github.com/rails/rails/blob/f8eed695fa6ed5b846daf2e456dfca7baeaab607/activerecord/lib/active_record/relation/predicate_builder.rb#L85-L87","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45509/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45509/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45506","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45506/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45506/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45506/events","html_url":"https://github.com/rails/rails/issues/45506","id":1291453647,"node_id":"I_kwDNIULOTPoEzw","number":45506,"title":"Images saved via using ActiveStorage different in production and development environments","user":{"login":"Sega100500","id":584144,"node_id":"MDQ6VXNlcjU4NDE0NA==","avatar_url":"https://avatars.githubusercontent.com/u/584144?v=4","gravatar_id":"","url":"https://api.github.com/users/Sega100500","html_url":"https://github.com/Sega100500","followers_url":"https://api.github.com/users/Sega100500/followers","following_url":"https://api.github.com/users/Sega100500/following{/other_user}","gists_url":"https://api.github.com/users/Sega100500/gists{/gist_id}","starred_url":"https://api.github.com/users/Sega100500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sega100500/subscriptions","organizations_url":"https://api.github.com/users/Sega100500/orgs","repos_url":"https://api.github.com/users/Sega100500/repos","events_url":"https://api.github.com/users/Sega100500/events{/privacy}","received_events_url":"https://api.github.com/users/Sega100500/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-07-01T14:03:42Z","updated_at":"2022-07-04T16:59:49Z","closed_at":"2022-07-04T16:59:49Z","author_association":"NONE","active_lock_reason":null,"body":"### Expected behavior\r\nIn both environments same behavior\r\n\r\n### Actual behavior\r\nIn development environment saved (attach) image in content-page within `gem ckeditor` using `ActiveStorage` with `mini_magick` - then in production environment image are not showed, and vice versa - saved in production, then are not showed in development. I use **same database** (mysql) in development and production environments.\r\n\r\n### System configuration\r\n- **Ruby version**: 3.1.2\r\n- **Rails version**: 7.0.3\r\n- gem [ckeditor](https://github.com/galetahub/ckeditor) 5.1.1\r\n\r\nIn production mode I use config: \r\n```ruby\r\nconfig.assets.compile = true\r\nconfig.active_storage.service = :local\r\nconfig.active_storage.variant_processor = :mini_magick\r\n```\r\nin development:\r\n```ruby\r\nconfig.active_storage.service = :local\r\nconfig.active_storage.variant_processor = :mini_magick\r\n```\r\n\r\nsaved image in source code of page show like this:\r\n```\r\n<img alt=\"\" src=\"/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBDUT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--68a08d9de8f843ecd8b5c5be61d33859a3333bb7/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2QzNKbGMybDZaVWtpQ1Rnd01ENEdPd1pVIiwiZXhwIjpudWxsLCJwdXIiOiJ2YXJpYXRpb24ifX0=--2ccbd7d12a252e03eb26bb2401505e4efaeff669/7d85fe9c160bb2f3b559a45303cc8ce4.jpg\" style=\"width: 700px; height: 475px;\" />\r\n```\r\n\r\n### The problem, most likely, is in the ActiveStorage, because the `gem ckeditor` works correctly with other configurations","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45506/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45506/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45505","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45505/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45505/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45505/events","html_url":"https://github.com/rails/rails/issues/45505","id":1291294130,"node_id":"I_kwDNIULOTPeVsg","number":45505,"title":"Missing require on active_support/isolated_execution_state ?","user":{"login":"pmustel","id":51155506,"node_id":"MDQ6VXNlcjUxMTU1NTA2","avatar_url":"https://avatars.githubusercontent.com/u/51155506?v=4","gravatar_id":"","url":"https://api.github.com/users/pmustel","html_url":"https://github.com/pmustel","followers_url":"https://api.github.com/users/pmustel/followers","following_url":"https://api.github.com/users/pmustel/following{/other_user}","gists_url":"https://api.github.com/users/pmustel/gists{/gist_id}","starred_url":"https://api.github.com/users/pmustel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmustel/subscriptions","organizations_url":"https://api.github.com/users/pmustel/orgs","repos_url":"https://api.github.com/users/pmustel/repos","events_url":"https://api.github.com/users/pmustel/events{/privacy}","received_events_url":"https://api.github.com/users/pmustel/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-07-01T11:37:34Z","updated_at":"2022-07-05T17:14:24Z","closed_at":"2022-07-05T17:14:24Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI have a small piece of  ruby code, running in bundle with gems 'ruby-kafka' and 'activesupport' Ruby-kafka uses the notifications to tell a message is produced. But it crashes. It seems to be missing a 'require' somewhere. \r\n\r\nIt works when I add: \r\nrequire 'active_support/iloacted_execution_state'\r\n\r\n# Your reproduction script goes here\r\n\r\nrequire 'active_support/notifications'\r\nrequire 'kafka'\r\n\r\nThread.new do\r\n  ActiveSupport::Notifications.subscribe('produce_message.producer.kafka') do\r\n    puts 'Hello'\r\n  end\r\nend\r\n\r\nsleep 1\r\n\r\nkafka = Kafka.new(seed_brokers: 'localhost:9092', client_id: 'maia_agent')\r\nproducer = kafka.producer\r\nproducer.produce('text', topic: 'TOPIC')\r\n\r\n### Expected behavior\r\n\r\nprints 'hello'\r\n\r\n### Actual behavior\r\n\r\nactivesupport-7.0.3/lib/active_support/notifications.rb:272:in `registry': uninitialized constant ActiveSupport::IsolatedExecutionState (NameError)\r\n\tfrom /opt/t2data.com/develop/maia_test_suite/packages/maia_agent/local_repository/.bundle.dep/ruby/3.0.0/gems/activesupport-7.0.3/lib/active_support/notifications.rb:267:in `instrumenter'\r\n\r\n### System configuration\r\nactivesupport-7.0.3\r\n\r\nruby-3.0.3\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45505/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45505/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45503","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45503/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45503/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45503/events","html_url":"https://github.com/rails/rails/issues/45503","id":1291035892,"node_id":"I_kwDNIULOTPOk9A","number":45503,"title":"data_source_sql query is unnecessarily slow on MySQL with many tables and derived_merge=off","user":{"login":"blowfishpro","id":10545461,"node_id":"MDQ6VXNlcjEwNTQ1NDYx","avatar_url":"https://avatars.githubusercontent.com/u/10545461?v=4","gravatar_id":"","url":"https://api.github.com/users/blowfishpro","html_url":"https://github.com/blowfishpro","followers_url":"https://api.github.com/users/blowfishpro/followers","following_url":"https://api.github.com/users/blowfishpro/following{/other_user}","gists_url":"https://api.github.com/users/blowfishpro/gists{/gist_id}","starred_url":"https://api.github.com/users/blowfishpro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blowfishpro/subscriptions","organizations_url":"https://api.github.com/users/blowfishpro/orgs","repos_url":"https://api.github.com/users/blowfishpro/repos","events_url":"https://api.github.com/users/blowfishpro/events{/privacy}","received_events_url":"https://api.github.com/users/blowfishpro/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-07-01T07:39:19Z","updated_at":"2022-07-01T19:00:57Z","closed_at":"2022-07-01T19:00:57Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n* Have a rails application using MySQL\r\n* Have a reasonably large number of tables in your database (we have 866)\r\n* Have the optimizer switch `derived_merge=off` due to [many](https://bugs.mysql.com/bug.php?id=88252) [issues](https://www.percona.com/blog/2018/09/25/why-optimization-derived_merge-can-break-your-queries/) in MySQL 5.7\r\n* Use any method that runs `data_source_sql` (I think rails runs some of these queries automatically when reading the schema, we were also running `data_source_exists?(table_name)` explicitly\r\n```ruby\r\n# done explicitly here to make the benchmark results demonstrate the issue\r\nActiveRecord::Base.connection.disable_query_cache!\r\n\r\nActiveRecord::Base.connection.data_sources.count\r\n# => 866\r\n\r\nActiveRecord::Base.connection.select_value('select @@session.optimizer_switch')[/derived_merge=\\w+/]\r\n# => derived_merge=off\r\n\r\nBenchmark.measure { 100.times { ActiveRecord::Base.connection.data_source_exists?('schema_migrations') } }\r\n# =>  0.024123   0.002947   0.027070 ( 24.075342)\r\n\r\nBenchmark.measure { 100.times { ActiveRecord::Base.connection.select_value('SELECT table_name FROM information_schema.tables WHERE table_schema = database() AND table_name = \"schema_migrations\"').present? } }\r\n# => 0.010774   0.002236   0.013010 (  0.026767)\r\n\r\n```\r\n\r\n### Expected behavior\r\nThese calls are fast\r\n\r\n### Actual behavior\r\nThese calls are ~900x slower than they could be\r\n\r\n### System configuration\r\n**Rails version**: `6.0.4.8`\r\n\r\n**Ruby version**: `2.7.5`\r\n\r\n### Additional information\r\n\r\n* The behavior was changed from something like the fast query above to the current query in #39712 to work around another MySQL bug.  However we do not use user permissions below the database level so we don't necessarily need that.\r\n* Some of the `derived_merge` issues are fixed in MySQL 8, however it's not clear that they all are.\r\n* Of course we aren't running this 100 times in quick succession with no query cache, however the individual calls add up over time and can make performance much worse when the database server is already under heavy load.\r\n* Since the table permissions case has to be supported too maybe this could be switchable somehow?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45503/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45503/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45500","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45500/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45500/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45500/events","html_url":"https://github.com/rails/rails/issues/45500","id":1290469117,"node_id":"I_kwDNIULOTOr-_Q","number":45500,"title":"url_options are wrong after accessing engine route in integration tests","user":{"login":"brandoncc","id":543973,"node_id":"MDQ6VXNlcjU0Mzk3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/543973?v=4","gravatar_id":"","url":"https://api.github.com/users/brandoncc","html_url":"https://github.com/brandoncc","followers_url":"https://api.github.com/users/brandoncc/followers","following_url":"https://api.github.com/users/brandoncc/following{/other_user}","gists_url":"https://api.github.com/users/brandoncc/gists{/gist_id}","starred_url":"https://api.github.com/users/brandoncc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brandoncc/subscriptions","organizations_url":"https://api.github.com/users/brandoncc/orgs","repos_url":"https://api.github.com/users/brandoncc/repos","events_url":"https://api.github.com/users/brandoncc/events{/privacy}","received_events_url":"https://api.github.com/users/brandoncc/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":35206628,"node_id":"MDU6TGFiZWwzNTIwNjYyOA==","url":"https://api.github.com/repos/rails/rails/labels/routing","name":"routing","color":"e102d8","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false},"assignees":[{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-06-30T17:56:44Z","updated_at":"2022-07-08T23:52:28Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. In an `ActionDispatch::IntegrationTest`, access (`get`/`post`/etc) a route that is provided by an engine.\r\n2. Try using a route helper that is part of the core Rails application.\r\n\r\n@gmcgibbon and I paired on this and believe that the issue lies in [this method](https://github.com/rails/rails/blob/d44e786d216f82584c7752ffee91ef4d5bea14ba/actionpack/lib/action_dispatch/testing/integration.rb#L133-L143).\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\n\r\nmodule Hemi\r\n  class Engine < ::Rails::Engine\r\n    def self.find_root(_)\r\n      __dir__\r\n    end\r\n\r\n    isolate_namespace Hemi\r\n\r\n    routes.draw do\r\n      post \"/example\" => \"repro#example\", as: :repro_example\r\n    end\r\n  end\r\n\r\n  class ReproController < ActionController::Base\r\n    include Engine.routes.url_helpers\r\n\r\n    def example\r\n      head 201\r\n    end\r\n  end\r\nend\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"www.example.com\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get \"/\" => \"test#index\", as: \"slash\"\r\n    mount Hemi::Engine, at: \"/hemi\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < ActionDispatch::IntegrationTest\r\n  def test_url_is_correct_after_accessing_engine_path\r\n    post hemi.repro_example_path\r\n    assert_equal \"/\", slash_path\r\n  end\r\n\r\n  def test_url_is_correct_after_accessing_application_path\r\n    post hemi.repro_example_path\r\n\r\n    # resets `controller.url_options`\r\n    get \"/\"\r\n    assert_equal \"/\", slash_path\r\n  end\r\n\r\n  private\r\n\r\n  def app\r\n    Rails.application\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expect `slash_path` to always return `\"/\"`, and not be dependent on the last route accessed.\r\n\r\n### Actual behavior\r\n\r\nAfter accessing an engine route, `controller.url_options` represents the engine, so the engine's mount point (\"script_name\" header) is prepended to the output of route helpers from the core Rails application.\r\n\r\nAccessing a route from the core Rails application again resets `controller.url_options` and the output of the route helpers will once again be what you expect.\r\n\r\n### System configuration\r\n**Rails version**: 7.1.0.alpha from https://github.com/rails/rails.git (at main@c704da6)\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45500/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45500/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45499","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45499/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45499/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45499/events","html_url":"https://github.com/rails/rails/issues/45499","id":1290446458,"node_id":"I_kwDNIULOTOqmeg","number":45499,"title":"Epub format support for kindle version documentation","user":{"login":"geongeorge","id":29296982,"node_id":"MDQ6VXNlcjI5Mjk2OTgy","avatar_url":"https://avatars.githubusercontent.com/u/29296982?v=4","gravatar_id":"","url":"https://api.github.com/users/geongeorge","html_url":"https://github.com/geongeorge","followers_url":"https://api.github.com/users/geongeorge/followers","following_url":"https://api.github.com/users/geongeorge/following{/other_user}","gists_url":"https://api.github.com/users/geongeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/geongeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geongeorge/subscriptions","organizations_url":"https://api.github.com/users/geongeorge/orgs","repos_url":"https://api.github.com/users/geongeorge/repos","events_url":"https://api.github.com/users/geongeorge/events{/privacy}","received_events_url":"https://api.github.com/users/geongeorge/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"geongeorge","id":29296982,"node_id":"MDQ6VXNlcjI5Mjk2OTgy","avatar_url":"https://avatars.githubusercontent.com/u/29296982?v=4","gravatar_id":"","url":"https://api.github.com/users/geongeorge","html_url":"https://github.com/geongeorge","followers_url":"https://api.github.com/users/geongeorge/followers","following_url":"https://api.github.com/users/geongeorge/following{/other_user}","gists_url":"https://api.github.com/users/geongeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/geongeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geongeorge/subscriptions","organizations_url":"https://api.github.com/users/geongeorge/orgs","repos_url":"https://api.github.com/users/geongeorge/repos","events_url":"https://api.github.com/users/geongeorge/events{/privacy}","received_events_url":"https://api.github.com/users/geongeorge/received_events","type":"User","site_admin":false},"assignees":[{"login":"geongeorge","id":29296982,"node_id":"MDQ6VXNlcjI5Mjk2OTgy","avatar_url":"https://avatars.githubusercontent.com/u/29296982?v=4","gravatar_id":"","url":"https://api.github.com/users/geongeorge","html_url":"https://github.com/geongeorge","followers_url":"https://api.github.com/users/geongeorge/followers","following_url":"https://api.github.com/users/geongeorge/following{/other_user}","gists_url":"https://api.github.com/users/geongeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/geongeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geongeorge/subscriptions","organizations_url":"https://api.github.com/users/geongeorge/orgs","repos_url":"https://api.github.com/users/geongeorge/repos","events_url":"https://api.github.com/users/geongeorge/events{/privacy}","received_events_url":"https://api.github.com/users/geongeorge/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2022-06-30T17:31:26Z","updated_at":"2022-08-12T18:49:04Z","closed_at":"2022-08-12T18:49:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Amazon is dropping support for .mobi files for their Kindle devices slowly. \r\nSend to device will stop working from August. And later, support will fully drop.\r\n\r\n**Source**: https://www.amazon.com/gp/help/customer/display.html?nodeId=G5WYD9SAF7PGXRNA\r\n\r\n**Solution**\r\n\r\n- Build EPUB version of the documentation along with mobi ([code](https://github.com/rails/rails/blob/main/guides/Rakefile))\r\n- Towards the end of support, stop supporting mobi, and only support epub\r\n\r\n\r\n**Email recieved**\r\n\r\n> Dear Kindle Customer,\r\n> Thank you for using the Send to Kindle service to send personal documents to your Kindle library. We noticed that the following document(s), sent by you at 10:42 PM on Thu, Jun 30, 2022 IST are in MOBI (.mobi, .azw) formats:\r\n>\r\n>  Ruby on Rails Guides v2 - Ruby on Rails.mobi\r\n>\r\n> We wanted to let you know that starting August 2022, you will no longer be able to send MOBI (.mobi, .azw) files to your Kindle library. Any MOBI files that are already in your library will not be affected by this change. MOBI is an older file format and will not support the newest Kindle features for documents. Any existing MOBI files that you want to read with our most up-to-date features for documents will need to be re-sent in a compatible format.\r\n>\r\n> Compatible formats now include EPUB (.epub), which you can send to your library using your Send to Kindle email address. We will also be adding EPUB support to the free Kindle app for iOS and Android devices and the Send to Kindle desktop app for PC and Mac.      \r\n>\r\n> If you have any questions, please visit our help page or contact our Customer Service team.      \r\n>\r\n> Regards,\r\n> Amazon Kindle Support\r\n\r\n**Excerpt from Amazon help page**\r\n\r\n> Note: Beginning in late 2022, you'll no longer be able to send MOBI (.AZW, .MOBI) files to your Kindle library using Send to Kindle. This change won't affect any MOBI files already in your Kindle library. You can still read them with Kindle. MOBI is an older file format and won't support the newest Kindle features for documents.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45499/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45496","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45496/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45496/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45496/events","html_url":"https://github.com/rails/rails/issues/45496","id":1290205493,"node_id":"I_kwDNIULOTOb5NQ","number":45496,"title":"Using scopes with belongs_to/has_many changes the behavior on the result of `collection.create`","user":{"login":"pjambet","id":717637,"node_id":"MDQ6VXNlcjcxNzYzNw==","avatar_url":"https://avatars.githubusercontent.com/u/717637?v=4","gravatar_id":"","url":"https://api.github.com/users/pjambet","html_url":"https://github.com/pjambet","followers_url":"https://api.github.com/users/pjambet/followers","following_url":"https://api.github.com/users/pjambet/following{/other_user}","gists_url":"https://api.github.com/users/pjambet/gists{/gist_id}","starred_url":"https://api.github.com/users/pjambet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pjambet/subscriptions","organizations_url":"https://api.github.com/users/pjambet/orgs","repos_url":"https://api.github.com/users/pjambet/repos","events_url":"https://api.github.com/users/pjambet/events{/privacy}","received_events_url":"https://api.github.com/users/pjambet/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-30T14:17:41Z","updated_at":"2022-07-05T22:12:50Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\n  gem \"debug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\nrequire \"debug\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments, ->() { where(\"1=1\") }\r\n  # Using a scope-less association like this works\r\n  # has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post, ->() { where(\"1=1\") }\r\n  # Using a scope-less association like this works\r\n  # belongs_to :post\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    comment = post.comments.create!\r\n    # Explicitly passing the post object works\r\n    # comment = post.comments.create!(post: post)\r\n\r\n    assert_equal 1, post.comments.count\r\n    assert_equal 1, Comment.count\r\n    assert_equal post.id, Comment.first.post.id\r\n    assert_equal post.id, comment.post.id\r\n    # Problematic test:\r\n    assert_equal post.object_id, comment.post.object_id\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe `post` object should be the same object as `comment.post`, even when using scopes for the associations\r\n\r\nWe could argue that due to the scope on `belongs_to`, we do want to load a new instance when calling `comment.post`, maybe the scope would actually not return the `post` due to the condition, but even changing it to a plain `belongs_to :post` fails the test\r\n\r\n### Actual behavior\r\n\r\nThe `post` object and the `comment.post` object are two different ruby objects of the the same (an extra query is performed when calling `comment.post`, loading the new object)\r\n\r\n### System configuration\r\n**Rails version**:  `7.1.0.alpha from https://github.com/rails/rails.git (at main@92fa470)`\r\n\r\n**Ruby version**: `ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [arm64-darwin21]`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45496/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45493","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45493/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45493/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45493/events","html_url":"https://github.com/rails/rails/issues/45493","id":1289785178,"node_id":"I_kwDNIULOTOCPWg","number":45493,"title":"Rails: ActionView::Template::Error (wrong number of arguments (given 4, expected 0..1)):","user":{"login":"zolzaya","id":115309,"node_id":"MDQ6VXNlcjExNTMwOQ==","avatar_url":"https://avatars.githubusercontent.com/u/115309?v=4","gravatar_id":"","url":"https://api.github.com/users/zolzaya","html_url":"https://github.com/zolzaya","followers_url":"https://api.github.com/users/zolzaya/followers","following_url":"https://api.github.com/users/zolzaya/following{/other_user}","gists_url":"https://api.github.com/users/zolzaya/gists{/gist_id}","starred_url":"https://api.github.com/users/zolzaya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zolzaya/subscriptions","organizations_url":"https://api.github.com/users/zolzaya/orgs","repos_url":"https://api.github.com/users/zolzaya/repos","events_url":"https://api.github.com/users/zolzaya/events{/privacy}","received_events_url":"https://api.github.com/users/zolzaya/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-30T08:31:09Z","updated_at":"2022-09-11T00:23:34Z","closed_at":"2022-06-30T23:06:11Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hello guys,\r\n\r\nFirst of all sorry for asking question. I know this is not a right place to ask question. But I really really really need a help. Here is the my question.\r\n\r\nI have an app running on production. But I get following errors `only on production` environment.\r\n```\r\n[81bedcfb-4b75-445c-b56e-ce17a1c477db] app/views/layouts/application.html.erb:17\r\nI, [2022-06-30T14:05:56.938148 #71839]  INFO -- : [ae44ac69-b517-40d4-9022-32d48befe086] Started GET \"/\" for 127.0.0.1 at 2022-06-30 14:05:56 +0800\r\nI, [2022-06-30T14:05:56.939300 #71839]  INFO -- : [ae44ac69-b517-40d4-9022-32d48befe086] Processing by DashboardController#index as HTML\r\nI, [2022-06-30T14:05:56.942026 #71839]  INFO -- : [ae44ac69-b517-40d4-9022-32d48befe086]   Rendered dashboard/index.html.erb within layouts/application (Duration: 0.2ms | Allocations: 4)\r\nI, [2022-06-30T14:05:56.943254 #71839]  INFO -- : [ae44ac69-b517-40d4-9022-32d48befe086]   Rendered layout layouts/application.html.erb (Duration: 1.4ms | Allocations: 647)\r\nI, [2022-06-30T14:05:56.943428 #71839]  INFO -- : [ae44ac69-b517-40d4-9022-32d48befe086] Completed 500 Internal Server Error in 4ms (ActiveRecord: 0.3ms | Allocations: 1418)\r\nF, [2022-06-30T14:05:56.945594 #71839] FATAL -- : [ae44ac69-b517-40d4-9022-32d48befe086]   \r\n[ae44ac69-b517-40d4-9022-32d48befe086] ActionView::Template::Error (wrong number of arguments (given 4, expected 0..1)):\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     1: <nav aria-label=\"breadcrumb\" class=\"-intro-x h-[45px] mr-auto\">\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     2:   <ol class=\"breadcrumb breadcrumb-light\">\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     3:     <li class=\"breadcrumb-item\">\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     4:       <%= link_to \"Home\", root_path %>\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     5:     </li>\r\n[ae44ac69-b517-40d4-9022-32d48befe086]     6: \r\n[ae44ac69-b517-40d4-9022-32d48befe086]     7:     <% breadcrumbs.each_with_index do |item, index| %>\r\n[ae44ac69-b517-40d4-9022-32d48befe086]   \r\n[ae44ac69-b517-40d4-9022-32d48befe086] app/views/shared/_breadcrumb.html.erb:4\r\n[ae44ac69-b517-40d4-9022-32d48befe086] app/views/shared/_topbar.html.erb:11\r\n```\r\n\r\nBelow errors only occurs on `routes` /for example: `root_path`, `dashboard_path` etc./.\r\nHere is the my router.rb\r\n```\r\n\r\n# require 'sidekiq/web'\r\n\r\nRails.application.routes.draw do\r\n  # post \"/graphql\", to: \"graphql#execute\"\r\n  root 'dashboard#index'\r\n\r\n  # authenticate :admin do\r\n  #   mount Sidekiq::Web => \"/sidekiq\"\r\n  #   mount GraphiQL::Rails::Engine, at: \"/graphiql\", graphql_path: \"/graphql\"\r\n  # end\r\n\r\n  resources :organizations do\r\n    collection do\r\n      get :users\r\n    end\r\n\r\n    member do\r\n      post :admins, to: 'organizations/tabs#admins'\r\n      post :customers, to: 'organizations/tabs#customers'\r\n      post :addresses, to: 'organizations/tabs#addresses'\r\n    end\r\n  end\r\n\r\n  resources :users\r\n\r\n  namespace :finance do\r\n    resources :accounts\r\n    resources :transactions, except: [:edit, :update]\r\n  end\r\n\r\n  resources :lawyers do\r\n    resources :settings, controller: 'lawyers/settings', only: [:index, :update]\r\n    resources :timetables, controller: 'lawyers/timetables'\r\n    resources :transactions, controller: 'lawyers/transactions', except: [:edit, :update]\r\n    resources :educations, controller: 'lawyers/educations'\r\n    resources :work_experiences, controller: 'lawyers/work_experiences'\r\n    resources :authentications, controller: 'lawyers/authentications', only: [:index, :new, :create]\r\n    resources :comments, controller: 'lawyers/comments', only: [:index, :destroy]\r\n    resources :ratings, controller: 'lawyers/ratings', except: [:edit, :update]\r\n  end\r\n\r\n  namespace :listens do\r\n    resources :taxons\r\n    resources :audios\r\n  end\r\n\r\n  namespace :settings do\r\n    resources :banners\r\n    resources :evaluations\r\n    resources :sms_logs, only: [:index, :update, :destroy]\r\n    resources :services\r\n    resources :admins\r\n    resources :questions\r\n    resources :categories\r\n  end\r\n\r\n  devise_for :users\r\n  devise_for :lawyers\r\n\r\n  devise_for :admins, path: 'auth',\r\n                      path_names: { sign_in: 'login', sign_out: 'logout', password: 'secret', confirmation: 'verification', unlock: 'unblock' }\r\n\r\n  #  root 'dashboard#index'\r\n  post \"/graphql\", to: \"graphql#execute\"\r\n\r\n  # authenticate :admin do\r\n    # mount Sidekiq::Web => \"/sidekiq\"\r\n    # mount GraphiQL::Rails::Engine, at: \"/graphiql\", graphql_path: \"/graphql\"\r\n  # end\r\n\r\n  # match '/404', to: 'errors#not_found', via: :all\r\n  # match '/500', to: 'errors#internal_server_error', via: :all\r\nend\r\n```\r\n\r\nAnd here is the some partials.\r\n\r\n`_breadcrumb.html.erb`\r\n```\r\n\r\n<nav aria-label=\"breadcrumb\" class=\"-intro-x h-[45px] mr-auto\">\r\n  <ol class=\"breadcrumb breadcrumb-light\">\r\n    <li class=\"breadcrumb-item\">\r\n      <%= link_to \"Home\", root_path %>\r\n    </li>\r\n\r\n    <% breadcrumbs.each_with_index do |item, index| %>\r\n      <% if index == breadcrumbs.size - 1 %>\r\n        <li class=\"breadcrumb-item active\" aria-current=\"page\"><%= item.name %></li>\r\n      <% else %>\r\n        <li class=\"breadcrumb-item\" aria-current=\"page\"><%= link_to item.name, item.path %></li>\r\n      <% end %>\r\n    <% end %>\r\n  </ol>\r\n</nav>\r\n```\r\n\r\n`_topbar.html.erb`\r\n```\r\n<!-- BEGIN: Top Bar -->\r\n<div class=\"top-bar-boxed h-[70px] md:h-[65px] z-[51] border-b border-white/[0.08] -mt-7 md:mt-0 -mx-3 sm:-mx-8 md:-mx-0 px-3 md:border-b-0 relative md:fixed md:inset-x-0 md:top-0 sm:px-8 md:px-10 md:pt-10 md:bg-gradient-to-b md:from-slate-100 md:to-transparent dark:md:from-darkmode-700\">\r\n  <div class=\"h-full flex items-center\">\r\n    <!-- BEGIN: Logo -->\r\n    <a href=\"\" class=\"logo -intro-x hidden md:flex xl:w-[180px] block\">\r\n      <%= image_tag 'logo.svg', class: 'w-6' %>\r\n      <span class=\"logo__text text-white text-lg ml-3\"> Enigma </span>\r\n    </a>\r\n    <!-- END: Logo -->\r\n    <!-- BEGIN: Breadcrumb -->\r\n    <%= render partial: 'shared/breadcrumb' %>\r\n    <!-- END: Breadcrumb -->\r\n\r\n    <!-- BEGIN: Account Menu -->\r\n    <div class=\"intro-x dropdown w-8 h-8\">\r\n      <div class=\"dropdown-toggle w-8 h-8 rounded-full overflow-hidden shadow-lg image-fit zoom-in scale-110\" role=\"button\" aria-expanded=\"false\" data-tw-toggle=\"dropdown\">\r\n        <%= image_tag \"profile.jpg\" %>\r\n      </div>\r\n      <div class=\"dropdown-menu w-56\">\r\n        <ul class=\"dropdown-content bg-primary/80 before:block before:absolute before:bg-black before:inset-0 before:rounded-md before:z-[-1] text-white\">\r\n          <li class=\"p-2\">\r\n            <div class=\"font-medium\">Arnold Schwarzenegger</div>\r\n            <div class=\"text-xs text-white/60 mt-0.5 dark:text-slate-500\">Software Engineer</div>\r\n          </li>\r\n          <li>\r\n            <hr class=\"dropdown-divider border-white/[0.08]\">\r\n          </li>\r\n          <li>\r\n            <a href=\"\" class=\"dropdown-item hover:bg-white/5\"> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" icon-name=\"user\" data-lucide=\"user\" class=\"lucide lucide-user w-4 h-4 mr-2\"><path d=\"M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg> Profile </a>\r\n          </li>\r\n          <li>\r\n            <a href=\"\" class=\"dropdown-item hover:bg-white/5\"> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" icon-name=\"edit\" data-lucide=\"edit\" class=\"lucide lucide-edit w-4 h-4 mr-2\"><path d=\"M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7\"></path><path d=\"M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z\"></path></svg> Add Account </a>\r\n          </li>\r\n          <li>\r\n            <a href=\"\" class=\"dropdown-item hover:bg-white/5\"> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" icon-name=\"lock\" data-lucide=\"lock\" class=\"lucide lucide-lock w-4 h-4 mr-2\"><rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\"></rect><path d=\"M7 11V7a5 5 0 0110 0v4\"></path></svg> Reset Password </a>\r\n          </li>\r\n          <li>\r\n            <a href=\"\" class=\"dropdown-item hover:bg-white/5\"> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" icon-name=\"help-circle\" data-lucide=\"help-circle\" class=\"lucide lucide-help-circle w-4 h-4 mr-2\"><circle cx=\"12\" cy=\"12\" r=\"10\"></circle><path d=\"M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3\"></path><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"></line></svg> Help </a>\r\n          </li>\r\n          <li>\r\n            <hr class=\"dropdown-divider border-white/[0.08]\">\r\n          </li>\r\n          <li>\r\n            <a href=\"\" class=\"dropdown-item hover:bg-white/5\"> <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" icon-name=\"toggle-right\" data-lucide=\"toggle-right\" class=\"lucide lucide-toggle-right w-4 h-4 mr-2\"><rect x=\"1\" y=\"5\" width=\"22\" height=\"14\" rx=\"7\" ry=\"7\"></rect><circle cx=\"16\" cy=\"12\" r=\"3\"></circle></svg> Logout </a>\r\n          </li>\r\n        </ul>\r\n      </div>\r\n    </div>\r\n    <!-- END: Account Menu -->\r\n  </div>\r\n</div>\r\n```\r\n\r\nI'm using ruby 3.1.2 and here is my app environment:\r\n```\r\n\r\nGems included by the bundle:\r\n  * actioncable (7.0.3)\r\n  * actionmailbox (7.0.3)\r\n  * actionmailer (7.0.3)\r\n  * actionpack (7.0.3)\r\n  * actiontext (7.0.3)\r\n  * actionview (7.0.3)\r\n  * active_storage_validations (0.9.8)\r\n  * activejob (7.0.3)\r\n  * activemodel (7.0.3)\r\n  * activerecord (7.0.3)\r\n  * activestorage (7.0.3)\r\n  * activesupport (7.0.3)\r\n  * airbrussh (1.4.0)\r\n  * ancestry (4.2.0)\r\n  * auto_increment (1.5.2)\r\n  * bcrypt (3.1.17)\r\n  * bindex (0.8.1)\r\n  * bootsnap (1.11.1)\r\n  * builder (3.2.4)\r\n  * capistrano (3.17.0)\r\n  * capistrano-bundler (2.1.0)\r\n  * capistrano-passenger (0.2.1)\r\n  * capistrano-rails (1.6.2)\r\n  * capistrano-rbenv (2.2.0)\r\n  * capistrano-sidekiq (2.3.0)\r\n  * childprocess (4.1.0)\r\n  * concurrent-ruby (1.1.10)\r\n  * connection_pool (2.2.5)\r\n  * crass (1.0.6)\r\n  * cypress-on-rails (1.13.1)\r\n  * database_cleaner-active_record (2.0.1)\r\n  * database_cleaner-core (2.0.1)\r\n  * datev (0.11.0)\r\n  * debug (1.4.0)\r\n  * devise (4.8.1)\r\n  * digest (3.1.0)\r\n  * erubi (1.10.0)\r\n  * factory_bot (6.2.1)\r\n  * factory_bot_rails (6.2.0)\r\n  * faker (2.21.0 4255812)\r\n  * ffi (1.15.5)\r\n  * globalid (1.0.0)\r\n  * graphiql-rails (1.8.0)\r\n  * graphql (2.0.11)\r\n  * i18n (1.10.0)\r\n  * image_processing (1.12.2)\r\n  * inline_svg (1.8.0)\r\n  * io-console (0.5.11)\r\n  * irb (1.4.1)\r\n  * jbuilder (2.11.5)\r\n  * jsbundling-rails (1.0.2)\r\n  * jwt (2.3.0)\r\n  * keepr (0.7.0)\r\n  * loofah (2.18.0)\r\n  * mail (2.7.1)\r\n  * marcel (1.0.2)\r\n  * method_source (1.0.0)\r\n  * mini_magick (4.11.0)\r\n  * mini_mime (1.1.2)\r\n  * minitest (5.15.0)\r\n  * msgpack (1.4.5)\r\n  * net-imap (0.2.3)\r\n  * net-pop (0.1.1)\r\n  * net-protocol (0.1.3)\r\n  * net-scp (3.0.0)\r\n  * net-smtp (0.3.1)\r\n  * net-ssh (6.1.0)\r\n  * nio4r (2.5.8)\r\n  * nokogiri (1.13.6)\r\n  * orm_adapter (0.5.0)\r\n  * pagy (5.10.1)\r\n  * pg (1.3.5)\r\n  * puma (5.6.4)\r\n  * racc (1.6.0)\r\n  * rack (2.2.3)\r\n  * rack-cors (1.1.1)\r\n  * rack-test (1.1.0)\r\n  * rails (7.0.3)\r\n  * rails-dom-testing (2.0.3)\r\n  * rails-html-sanitizer (1.4.2)\r\n  * railties (7.0.3)\r\n  * rake (13.0.6)\r\n  * ransack (3.2.1)\r\n  * redis (4.6.0)\r\n  * reline (0.3.1)\r\n  * responders (3.0.1)\r\n  * rexml (3.2.5)\r\n  * ruby-vips (2.1.4)\r\n  * rubyzip (2.3.2)\r\n  * sassc (2.4.0)\r\n  * sassc-rails (2.1.2)\r\n  * selenium-webdriver (4.1.0)\r\n  * sidekiq (6.5.1)\r\n  * sprockets (4.0.3)\r\n  * sprockets-rails (3.4.2)\r\n  * sshkit (1.21.2)\r\n  * stimulus-rails (1.0.4)\r\n  * strscan (3.0.1)\r\n  * thor (1.2.1)\r\n  * tilt (2.0.10)\r\n  * timeout (0.2.0)\r\n  * turbo-rails (1.1.1)\r\n  * tzinfo (2.0.4)\r\n  * view_component (2.57.1)\r\n  * warden (1.2.9)\r\n  * web-console (4.2.0)\r\n  * webdrivers (5.0.0)\r\n  * websocket-driver (0.7.5)\r\n  * websocket-extensions (0.1.5)\r\n  * zeitwerk (2.5.4)\r\n```\r\n\r\nAs you can see errors are very odd. In my development environment app is running fine. I have no idea how to find main reason. Is there any tool for this situation? \r\n\r\nI will very thank for any ideas and advices\r\n\r\n**UPDATE:** Added full trace.\r\n```\r\nactionpack (7.0.3) lib/action_dispatch/routing/url_for.rb:169:in `url_for'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:271:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:214:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:327:in `block in define_url_helper'\r\napp/views/shared/_breadcrumb.html.erb:4\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `public_send'\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `_run'\r\nactionview (7.0.3) lib/action_view/template.rb:157:in `block in render'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:208:in `instrument'\r\nactionview (7.0.3) lib/action_view/template.rb:361:in `instrument_render_template'\r\nactionview (7.0.3) lib/action_view/template.rb:155:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:251:in `block in render_partial_template'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `block in instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `instrument'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:246:in `render_partial_template'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:237:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:81:in `render_partial_to_object'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:27:in `render_to_object'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:22:in `render'\r\nactionview (7.0.3) lib/action_view/helpers/rendering_helper.rb:37:in `block in render'\r\nactionview (7.0.3) lib/action_view/base.rb:270:in `in_rendering_context'\r\nactionview (7.0.3) lib/action_view/helpers/rendering_helper.rb:33:in `render'\r\napp/views/shared/_topbar.html.erb:11\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `public_send'\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `_run'\r\nactionview (7.0.3) lib/action_view/template.rb:157:in `block in render'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:208:in `instrument'\r\nactionview (7.0.3) lib/action_view/template.rb:361:in `instrument_render_template'\r\nactionview (7.0.3) lib/action_view/template.rb:155:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:251:in `block in render_partial_template'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `block in instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `instrument'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:246:in `render_partial_template'\r\nactionview (7.0.3) lib/action_view/renderer/partial_renderer.rb:237:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:81:in `render_partial_to_object'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:27:in `render_to_object'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:22:in `render'\r\nactionview (7.0.3) lib/action_view/helpers/rendering_helper.rb:37:in `block in render'\r\nactionview (7.0.3) lib/action_view/base.rb:270:in `in_rendering_context'\r\nactionview (7.0.3) lib/action_view/helpers/rendering_helper.rb:33:in `render'\r\napp/views/layouts/application.html.erb:17\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `public_send'\r\nactionview (7.0.3) lib/action_view/base.rb:244:in `_run'\r\nactionview (7.0.3) lib/action_view/template.rb:157:in `block in render'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:208:in `instrument'\r\nactionview (7.0.3) lib/action_view/template.rb:361:in `instrument_render_template'\r\nactionview (7.0.3) lib/action_view/template.rb:155:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/template_renderer.rb:76:in `block in render_with_layout'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `block in instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `instrument'\r\nactionview (7.0.3) lib/action_view/renderer/template_renderer.rb:74:in `render_with_layout'\r\nactionview (7.0.3) lib/action_view/renderer/template_renderer.rb:59:in `render_template'\r\nactionview (7.0.3) lib/action_view/renderer/template_renderer.rb:11:in `render'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:61:in `render_template_to_object'\r\nactionview (7.0.3) lib/action_view/renderer/renderer.rb:29:in `render_to_object'\r\nactionview (7.0.3) lib/action_view/rendering.rb:117:in `block in _render_template'\r\nactionview (7.0.3) lib/action_view/base.rb:270:in `in_rendering_context'\r\nactionview (7.0.3) lib/action_view/rendering.rb:116:in `_render_template'\r\nactionpack (7.0.3) lib/action_controller/metal/streaming.rb:216:in `_render_template'\r\nactionview (7.0.3) lib/action_view/rendering.rb:103:in `render_to_body'\r\nactionpack (7.0.3) lib/action_controller/metal/rendering.rb:46:in `render_to_body'\r\nactionpack (7.0.3) lib/action_controller/metal/renderers.rb:141:in `render_to_body'\r\nactionpack (7.0.3) lib/abstract_controller/rendering.rb:25:in `render'\r\nactionpack (7.0.3) lib/action_controller/metal/rendering.rb:30:in `render'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:22:in `block (2 levels) in render'\r\n/Users/zoloo/.rbenv/versions/3.1.2/lib/ruby/3.1.0/benchmark.rb:311:in `realtime'\r\nactivesupport (7.0.3) lib/active_support/core_ext/benchmark.rb:14:in `ms'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:22:in `block in render'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:91:in `cleanup_view_runtime'\r\nactiverecord (7.0.3) lib/active_record/railties/controller_runtime.rb:34:in `cleanup_view_runtime'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:21:in `render'\r\nactionpack (7.0.3) lib/action_controller/metal/implicit_render.rb:35:in `default_render'\r\nactionpack (7.0.3) lib/action_controller/metal/basic_implicit_render.rb:6:in `block in send_action'\r\n<internal:kernel>:90:in `tap'\r\nactionpack (7.0.3) lib/action_controller/metal/basic_implicit_render.rb:6:in `send_action'\r\nactionpack (7.0.3) lib/abstract_controller/base.rb:215:in `process_action'\r\nactionpack (7.0.3) lib/action_controller/metal/rendering.rb:53:in `process_action'\r\nactionpack (7.0.3) lib/abstract_controller/callbacks.rb:234:in `block in process_action'\r\nactivesupport (7.0.3) lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\nactiontext (7.0.3) lib/action_text/rendering.rb:20:in `with_renderer'\r\nactiontext (7.0.3) lib/action_text/engine.rb:69:in `block (4 levels) in <class:Engine>'\r\nactivesupport (7.0.3) lib/active_support/callbacks.rb:127:in `instance_exec'\r\nactivesupport (7.0.3) lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\nactivesupport (7.0.3) lib/active_support/callbacks.rb:138:in `run_callbacks'\r\nactionpack (7.0.3) lib/abstract_controller/callbacks.rb:233:in `process_action'\r\nactionpack (7.0.3) lib/action_controller/metal/rescue.rb:22:in `process_action'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:67:in `block in process_action'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `block in instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\nactivesupport (7.0.3) lib/active_support/notifications.rb:206:in `instrument'\r\nactionpack (7.0.3) lib/action_controller/metal/instrumentation.rb:66:in `process_action'\r\nactionpack (7.0.3) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'\r\nactiverecord (7.0.3) lib/active_record/railties/controller_runtime.rb:27:in `process_action'\r\nactionpack (7.0.3) lib/abstract_controller/base.rb:151:in `process'\r\nactionview (7.0.3) lib/action_view/rendering.rb:39:in `process'\r\nactionpack (7.0.3) lib/action_controller/metal.rb:188:in `dispatch'\r\nactionpack (7.0.3) lib/action_controller/metal.rb:251:in `dispatch'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:49:in `dispatch'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:32:in `serve'\r\nactionpack (7.0.3) lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\nactionpack (7.0.3) lib/action_dispatch/journey/router.rb:32:in `each'\r\nactionpack (7.0.3) lib/action_dispatch/journey/router.rb:32:in `serve'\r\nactionpack (7.0.3) lib/action_dispatch/routing/route_set.rb:852:in `call'\r\nwarden (1.2.9) lib/warden/manager.rb:36:in `block in call'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `catch'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `call'\r\nrack (2.2.3) lib/rack/tempfile_reaper.rb:15:in `call'\r\nrack (2.2.3) lib/rack/etag.rb:27:in `call'\r\nrack (2.2.3) lib/rack/conditional_get.rb:27:in `call'\r\nrack (2.2.3) lib/rack/head.rb:12:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/http/permissions_policy.rb:38:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/http/content_security_policy.rb:36:in `call'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:266:in `context'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:260:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/cookies.rb:697:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\nactivesupport (7.0.3) lib/active_support/callbacks.rb:99:in `run_callbacks'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/actionable_exceptions.rb:17:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'\r\nrailties (7.0.3) lib/rails/rack/logger.rb:40:in `call_app'\r\nrailties (7.0.3) lib/rails/rack/logger.rb:25:in `block in call'\r\nactivesupport (7.0.3) lib/active_support/tagged_logging.rb:114:in `block in tagged'\r\nactivesupport (7.0.3) lib/active_support/tagged_logging.rb:38:in `tagged'\r\nactivesupport (7.0.3) lib/active_support/tagged_logging.rb:114:in `tagged'\r\nrailties (7.0.3) lib/rails/rack/logger.rb:25:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/remote_ip.rb:93:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\nrack (2.2.3) lib/rack/method_override.rb:24:in `call'\r\nrack (2.2.3) lib/rack/runtime.rb:22:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nrack (2.2.3) lib/rack/sendfile.rb:110:in `call'\r\nactionpack (7.0.3) lib/action_dispatch/middleware/host_authorization.rb:131:in `call'\r\nrack-cors (1.1.1) lib/rack/cors.rb:100:in `call'\r\nrailties (7.0.3) lib/rails/engine.rb:530:in `call'\r\npuma (5.6.4) lib/puma/configuration.rb:252:in `call'\r\npuma (5.6.4) lib/puma/request.rb:77:in `block in handle_request'\r\npuma (5.6.4) lib/puma/thread_pool.rb:340:in `with_force_shutdown'\r\npuma (5.6.4) lib/puma/request.rb:76:in `handle_request'\r\npuma (5.6.4) lib/puma/server.rb:441:in `process_client'\r\npuma (5.6.4) lib/puma/thread_pool.rb:147:in `block in spawn_thread'\r\n```\r\n\r\nOriginal [question on stackoverflow](https://stackoverflow.com/questions/72811121/rails-actionviewtemplateerror-wrong-number-of-arguments-given-4-expected).","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45493/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45493/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45489","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45489/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45489/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45489/events","html_url":"https://github.com/rails/rails/issues/45489","id":1288638858,"node_id":"I_kwDNIULOTM8Rig","number":45489,"title":"Routes prefixed with `cable-` 404","user":{"login":"andrewmcodes","id":18423853,"node_id":"MDQ6VXNlcjE4NDIzODUz","avatar_url":"https://avatars.githubusercontent.com/u/18423853?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewmcodes","html_url":"https://github.com/andrewmcodes","followers_url":"https://api.github.com/users/andrewmcodes/followers","following_url":"https://api.github.com/users/andrewmcodes/following{/other_user}","gists_url":"https://api.github.com/users/andrewmcodes/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewmcodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewmcodes/subscriptions","organizations_url":"https://api.github.com/users/andrewmcodes/orgs","repos_url":"https://api.github.com/users/andrewmcodes/repos","events_url":"https://api.github.com/users/andrewmcodes/events{/privacy}","received_events_url":"https://api.github.com/users/andrewmcodes/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-29T12:18:11Z","updated_at":"2022-06-29T18:44:14Z","closed_at":"2022-06-29T18:44:14Z","author_association":"NONE","active_lock_reason":null,"body":"\r\nNavigating to a route prefixed with `#{Rails.application.config.action_cable.mount_path}-` 404s.\r\n\r\nI discovered this in a Rails 6 application and confirmed the behavior exists on the latest version. It's possible this is expected and I couldn't find that documentation but the behavior is odd enough that I believe this is a bug.\r\n\r\nI tried to provide as much info as possible and have [provided a reproduction repo](https://github.com/andrewmcodes/rails-cable-route-bug-reproduction) and reproduction instructions below. If I can provide anything else, let me know!\r\n\r\nIf this is a bug, I would be happy to take a stab at fixing it if someone can give me a nudge in the right direction.\r\n\r\n### Steps to reproduce\r\n\r\n1. Generate new rails app (`rails new test-app && cd test-app`) or use the one [here](https://github.com/andrewmcodes/rails-cable-route-bug-reproduction).\r\n2. `bin/rails g controller Test index`\r\n3. Add these routes to your `config/routes.rb`:\r\n    ```rb\r\n    get \"/cable-hyphenated-slug\", to: \"test#index\"\r\n    get \"/cable_underscored_slug\", to: \"test#index\"\r\n    ```\r\n4. Add the following tests to `TestControllerTest`\r\n    ```rb\r\n      # Fails\r\n      test \"route prefixed with 'cable-' should get index\" do\r\n        get cable_hyphenated_slug_path\r\n        assert response.ok?\r\n      end\r\n\r\n      # Succeeds\r\n      test \"route prefixed with 'cable_' should get index\" do\r\n        get cable_underscored_slug_path\r\n        assert response.ok?\r\n      end\r\n    ```\r\n5. Run the tests to witness the issue\r\n6. To view in the browser, start the Rails server with `rails s`\r\n  1. `http://localhost:3000/cable_underscored_slug` should render the index template\r\n  2. **`http://localhost:3000/cable-hypenated-slug` will 404**\r\n\r\n\r\n### Expected behavior\r\n\r\nIn the example above, `/cable-hypenated-slug` should be routed to `test#index` like `/cable_underscored_slug` is.\r\n\r\n### Actual behavior\r\n\r\nNavigating to a route that is prefixed with `#{Rails.application.config.action_cable.mount_path}-` 404s but navigating to a route that is prefixed with `#{Rails.application.config.action_cable.mount_path}_` works.\r\n\r\n```rb\r\n# http://localhost:3000/cable-hypenated-slug -> 404\r\n# http://localhost:3000/cable_underscored_slug -> 200\r\n```\r\n\r\nThe same is true regardless of the mount path:\r\n\r\n```rb\r\nconfig.action_cable.mount_path = \"/dev/cable\"\r\n\r\n# http://localhost:3000/dev/cable-hyphenated-slug -> 404\r\n# http://localhost:3000/dev/cable_underscored_slug -> 200\r\n```\r\n\r\nAccording to the logs, it looks like Rails tries to split the path on the first hyphen and then try to GET it as a WebSocket request:\r\n\r\n```log\r\n2022-06-29 04:04:44 -0700 HTTP parse error, malformed request: #<Puma::HttpParserError: Invalid HTTP format, parsing fails. Are you trying to open an SSL connection to a non-SSL Puma?>\r\nStarted GET \"/cable-hyphenated-slug\" for ::1 at 2022-06-29 04:04:47 -0700\r\nStarted GET \"/cable/-hyphenated-slug\"[non-WebSocket] for ::1 at 2022-06-29 04:04:47 -0700\r\nFailed to upgrade to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, HTTP_UPGRADE: )\r\nFinished \"/cable/-hyphenated-slug\"[non-WebSocket] for ::1 at 2022-06-29 04:04:47 -0700\r\nStarted GET \"/cable-hyphenated-slug\" for ::1 at 2022-06-29 04:04:47 -0700\r\nStarted GET \"/cable/-hyphenated-slug\"[non-WebSocket] for ::1 at 2022-06-29 04:04:47 -0700\r\nFailed to upgrade to WebSocket (REQUEST_METHOD: GET, HTTP_CONNECTION: keep-alive, HTTP_UPGRADE: )\r\nFinished \"/cable/-hyphenated-slug\"[non-WebSocket] for ::1 at 2022-06-29 04:04:47 -0700\r\n```\r\n\r\nThe easy solution is to not prefix any routes with `cable-` but I am working in an app where users can set their own slugs for pages and the only solution I can come up with is add that prefix to a blocklist.\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\n\r\n- 7.0.3\r\n- 6.1.5.1\r\n\r\n**Ruby version**:\r\n\r\n- 2.7.5\r\n- 2.7.6\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45489/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45489/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45483","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45483/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45483/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45483/events","html_url":"https://github.com/rails/rails/issues/45483","id":1287829547,"node_id":"I_kwDNIULOTMK4Kw","number":45483,"title":"ActionView::FormBuilder#field_name returns incorrect field name for deeply-nested associations","user":{"login":"shanecav84","id":7495328,"node_id":"MDQ6VXNlcjc0OTUzMjg=","avatar_url":"https://avatars.githubusercontent.com/u/7495328?v=4","gravatar_id":"","url":"https://api.github.com/users/shanecav84","html_url":"https://github.com/shanecav84","followers_url":"https://api.github.com/users/shanecav84/followers","following_url":"https://api.github.com/users/shanecav84/following{/other_user}","gists_url":"https://api.github.com/users/shanecav84/gists{/gist_id}","starred_url":"https://api.github.com/users/shanecav84/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shanecav84/subscriptions","organizations_url":"https://api.github.com/users/shanecav84/orgs","repos_url":"https://api.github.com/users/shanecav84/repos","events_url":"https://api.github.com/users/shanecav84/events{/privacy}","received_events_url":"https://api.github.com/users/shanecav84/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-28T20:11:56Z","updated_at":"2022-07-11T22:17:56Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"`field_name` is adding an extra index parameter, the extra `[0]` in `parent[children_attributes][0][0][grandchildren_attributes][]`\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"sqlite3\"\r\n  gem 'rails'\r\n  gem 'sprockets-rails'\r\nend\r\n\r\nrequire 'rails'\r\nrequire \"active_record/railtie\"\r\nrequire \"action_controller/railtie\"\r\nrequire \"action_view/railtie\"\r\nrequire \"sprockets/railtie\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass TestApp < Rails::Application; end\r\n\r\nRails.application.routes.draw do\r\n  resources :parents\r\nend\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :parents, force: true do |t|\r\n  end\r\n\r\n  create_table :children, force: true do |t|\r\n    t.integer :parent_id\r\n  end\r\n\r\n  create_table :grandchildren, force: true do |t|\r\n    t.integer :child_id\r\n  end\r\nend\r\n\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  self.abstract_class = true\r\nend\r\n\r\nclass Parent < ApplicationRecord\r\n  has_many :children\r\n  accepts_nested_attributes_for :children\r\nend\r\n\r\nclass Child < ApplicationRecord\r\n  belongs_to :parent\r\n  has_many :grandchildren\r\n  accepts_nested_attributes_for :grandchildren\r\nend\r\n\r\nclass Grandchild < ApplicationRecord\r\n  belongs_to :child\r\nend\r\n\r\n\r\nTEMPLATE = <<~ERB\r\n<%= form_with model: parent do |f| %>\r\n <%= f.field_name :children_attributes, multiple: true %>\r\n  <%= f.fields_for :children do |child_f| %>\r\n     <%= child_f.field_name :grandchildren_attributes, multiple: true %>\r\n  <% end %>\r\n<% end %>\r\nERB\r\n\r\nclass ApplicationController < ActionController::Base\r\n  include ActionDispatch::Routing::UrlFor\r\n  include Rails.application.routes.url_helpers\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n\r\n  def setup\r\n    @parent = Parent.new\r\n    child = Child.new\r\n    grandchild = Grandchild.new\r\n    child.grandchildren << grandchild\r\n    @parent.children << child\r\n    @rendered = ApplicationController.renderer.render inline: TEMPLATE, locals: { parent: @parent }\r\n  end\r\n\r\n  def test_grandchildren_field_name\r\n    assert_match('parent[children_attributes][0][grandchildren_attributes][]', @rendered)\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nDon't add an extra index parameter (parent[children_attributes][0]~~[0]~~[grandchildren_attributes][])\r\n\r\n### Actual behavior\r\nAn extra index parameter is added\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45483/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45483/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45480","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45480/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45480/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45480/events","html_url":"https://github.com/rails/rails/issues/45480","id":1287487469,"node_id":"I_kwDNIULOTL1_7Q","number":45480,"title":"ActiveStorage variant filename. Issue with TIFF files","user":{"login":"coorasse","id":1319150,"node_id":"MDQ6VXNlcjEzMTkxNTA=","avatar_url":"https://avatars.githubusercontent.com/u/1319150?v=4","gravatar_id":"","url":"https://api.github.com/users/coorasse","html_url":"https://github.com/coorasse","followers_url":"https://api.github.com/users/coorasse/followers","following_url":"https://api.github.com/users/coorasse/following{/other_user}","gists_url":"https://api.github.com/users/coorasse/gists{/gist_id}","starred_url":"https://api.github.com/users/coorasse/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coorasse/subscriptions","organizations_url":"https://api.github.com/users/coorasse/orgs","repos_url":"https://api.github.com/users/coorasse/repos","events_url":"https://api.github.com/users/coorasse/events{/privacy}","received_events_url":"https://api.github.com/users/coorasse/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-28T15:01:58Z","updated_at":"2022-08-17T18:04:29Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\nOur customer uploads TIFF files and we attach them to the model using ActiveStorage.\r\nSince we need to display them in the browser, and most browsers do not support TIFF format, we have a variant that converts the uploaded file to PDF.\r\n\r\n```\r\nhas_one_attached :file do |attachable|\r\n  attachable.variant :pdf, format: :pdf, loader: { page: nil } # page: nil is needed to convert all pages\r\nend\r\n```\r\n\r\nWe then embed the PDF using the following:\r\n\r\n```erb\r\n<embed src=\"#{url_for(pdf.variant(:pdf))}\">\r\n```\r\n\r\nAnd here is the issue: `url_for` generates the following path (truncated for readability):\r\n\r\n```\r\n/rails/active_storage/representations/redirect/eyJfcm/eyJfcm/sample.tiff\r\n```\r\n\r\nNow chrome thinks that this is a TIFF file, and does not even try to load this URL 😱 , and just display a message:\r\n<img width=\"438\" alt=\"CleanShot 2022-06-28 at 16 57 57@2x\" src=\"https://user-images.githubusercontent.com/1319150/176212076-61773a8c-fc41-466d-99ee-a709d52ed349.png\">\r\n\r\n\r\nWe have a ~~solution~~trick. We can add the .pdf extension to the filename 🙈 \r\n\r\n```erb\r\n<embed src=\"#{url_for(pdf.variant(:pdf))}.pdf\">\r\n```\r\n\r\nand force chrome into fetching the file (which is actually a PDF!)\r\n\r\n### Expected behavior\r\n\r\n`url_for(pdf.variant(:pdf))` returns a path with a `.pdf` extension.\r\n\r\n### Actual behavior\r\n\r\n`url_for(pdf.variant(:pdf))` returns a path with a `.tiff` extension.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45480/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45480/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45479","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45479/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45479/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45479/events","html_url":"https://github.com/rails/rails/issues/45479","id":1287289064,"node_id":"I_kwDNIULOTLp46A","number":45479,"title":"Get attributes that were used to instantiate object","user":{"login":"OskarEichler","id":62393985,"node_id":"MDQ6VXNlcjYyMzkzOTg1","avatar_url":"https://avatars.githubusercontent.com/u/62393985?v=4","gravatar_id":"","url":"https://api.github.com/users/OskarEichler","html_url":"https://github.com/OskarEichler","followers_url":"https://api.github.com/users/OskarEichler/followers","following_url":"https://api.github.com/users/OskarEichler/following{/other_user}","gists_url":"https://api.github.com/users/OskarEichler/gists{/gist_id}","starred_url":"https://api.github.com/users/OskarEichler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OskarEichler/subscriptions","organizations_url":"https://api.github.com/users/OskarEichler/orgs","repos_url":"https://api.github.com/users/OskarEichler/repos","events_url":"https://api.github.com/users/OskarEichler/events{/privacy}","received_events_url":"https://api.github.com/users/OskarEichler/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-28T12:44:26Z","updated_at":"2022-07-03T05:40:23Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"We are looking for a method to grab the attributes that were used when instantiating an object.\r\n\r\nSo for example when we call:\r\n\r\n`user = User.new(name: \"John\", age: 27, address: \"\")`\r\n\r\nthen it is possible to grab the changes by looking at user.changes in order to see which values have changed:\r\n\r\n`{\"name\"=>[nil, \"John\"], \"age\"=>[nil, 27], \"address\"=>[nil, \"\"]}`\r\n\r\nHowever, if the default value of address is an empty string \"\" then .changes will not return it anymore:\r\n\r\n`{\"name\"=>[nil, \"John\"], \"age\"=>[nil, 27]}`\r\n\r\nIs there a way to still know that address was explicitly used to instantiate the object and was not filled by the default after the fact?\r\n\r\nIt's import for us to know which columns were used explicitly during instantiation as those are the ones that we want to update via an upsert. But if the column is being set back to the default value we will miss it.\r\n\r\nIn our example, if a user currently has an address and then wants to remove it then we would replace it with an empty string, but then .changes would not return the column because it is the same like the default.\r\n\r\nSimilarly, if changing name from \"John\" => \"John\" on an existing record, it would also not show up in .changes\r\n\r\nHence why it would be awesome to have some new method that returns the columns / attributes that were explicitly provided when instantiating the object.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45479/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45479/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45467","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45467/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45467/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45467/events","html_url":"https://github.com/rails/rails/issues/45467","id":1285125557,"node_id":"I_kwDNIULOTJl1tQ","number":45467,"title":"Action Pack CI fails since rack-test v2.0.0 ","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-27T02:02:54Z","updated_at":"2022-07-06T13:25:40Z","closed_at":"2022-07-06T13:25:40Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/87630#0181a100-e98e-41d3-9114-9f767b8e9e3d\r\n\r\nAccording to git bisect, this behavior change has been introduced via https://github.com/rack/rack-test/commit/a68ea95e75bdceaf4644efb9178cb3657b9eb3e0 I am not familiar with rack-test let me open this issue.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/actionpack\r\nbundle update rack-test --conservative\r\nbin/test\r\n```\r\n\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n\r\n```ruby\r\nRun options: --seed 48625\r\n\r\n# Running:\r\n\r\n.......................................................................................................................................................................................................................................................................................................................E\r\n\r\nError:\r\nMemCacheStoreTest#test_getting_session_value_after_session_reset:\r\nNoMethodError: undefined method `hash_for' for #<Rack::Test::CookieJar:0x00007f95ec01cb90 @default_host=\"www.example.com\", @cookies=[#<Rack::Test::Cookie:0x00007f95ebfcf458 @default_host=\"www.example.com\", @raw=\"_session_id=7e3e28b363f1159dac05374704fbdb5f\", @name=\"_session_id\", @value=\"7e3e28b363f1159dac05374704fbdb5f\", @options={\"path\"=>\"/\", \"HttpOnly\"=>nil, \"domain\"=>\"www.example.com\"}, @exact_domain_match=true>]>\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/mem_cache_store_test.rb:74:in `block in test_getting_session_value_after_session_reset'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/mem_cache_store_test.rb:205:in `block in with_test_route_set'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/abstract_unit.rb:154:in `with_routing'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/mem_cache_store_test.rb:191:in `with_test_route_set'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/mem_cache_store_test.rb:70:in `test_getting_session_value_after_session_reset'\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/mem_cache_store_test.rb:69\r\n\r\n...............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................F\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_template_exception [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:84]:\r\n--- expected\r\n+++ actual\r\n@@ -1,5 +1,2 @@\r\n-\"37\\r\r\n-\\\"><script>window.location = \\\"/500.html\\\"</script></html>\\r\r\n-0\\r\r\n-\\r\r\n+\"500 error fixture\r\n \"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:82\r\n\r\nF\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_layout_exception [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:78]:\r\n--- expected\r\n+++ actual\r\n@@ -1,7 +1,2 @@\r\n-\"d\\r\r\n-<body class=\\\"\\r\r\n-37\\r\r\n-\\\"><script>window.location = \\\"/500.html\\\"</script></html>\\r\r\n-0\\r\r\n-\\r\r\n+\"500 error fixture\r\n \"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:76\r\n\r\nF\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_streaming_do_not_override_explicit_cache_control_given_to_render [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:61]:\r\n--- expected\r\n+++ actual\r\n@@ -1,7 +1 @@\r\n-\"b\\r\r\n-Hello world\\r\r\n-b\\r\r\n-, I'm here!\\r\r\n-0\\r\r\n-\\r\r\n-\"\r\n+\"Hello world, I'm here!\"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:59\r\n\r\n.F\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_streaming_given_to_render [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:55]:\r\n--- expected\r\n+++ actual\r\n@@ -1,7 +1 @@\r\n-\"b\\r\r\n-Hello world\\r\r\n-b\\r\r\n-, I'm here!\\r\r\n-0\\r\r\n-\\r\r\n-\"\r\n+\"Hello world, I'm here!\"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:53\r\n\r\nF\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_streaming_no_layout [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:67]:\r\n--- expected\r\n+++ actual\r\n@@ -1,5 +1 @@\r\n-\"b\\r\r\n-Hello world\\r\r\n-0\\r\r\n-\\r\r\n-\"\r\n+\"Hello world\"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:65\r\n\r\n...F\r\n\r\nFailure:\r\nRenderStreaming::StreamingTest#test_rendering_with_streaming_enabled_at_the_class_level [/home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:49]:\r\n--- expected\r\n+++ actual\r\n@@ -1,7 +1 @@\r\n-\"b\\r\r\n-Hello world\\r\r\n-b\\r\r\n-, I'm here!\\r\r\n-0\\r\r\n-\\r\r\n-\"\r\n+\"Hello world, I'm here!\"\r\n\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/controller/new_base/render_streaming_test.rb:47\r\n\r\n...................................................................................................................................................E\r\n\r\nError:\r\nCacheStoreTest#test_getting_session_value_after_session_reset:\r\nNoMethodError: undefined method `hash_for' for #<Rack::Test::CookieJar:0x00007f95eb7a8068 @default_host=\"www.example.com\", @cookies=[#<Rack::Test::Cookie:0x00007f95eb7b7108 @default_host=\"www.example.com\", @raw=\"_session_id=dfcb9f82e4826d004315e8245269a293\", @name=\"_session_id\", @value=\"dfcb9f82e4826d004315e8245269a293\", @options={\"path\"=>\"/\", \"HttpOnly\"=>nil, \"domain\"=>\"www.example.com\"}, @exact_domain_match=true>]>\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/cache_store_test.rb:62:in `block in test_getting_session_value_after_session_reset'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/cache_store_test.rb:221:in `block in with_test_route_set'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/abstract_unit.rb:154:in `with_routing'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/cache_store_test.rb:208:in `with_test_route_set'\r\n    /home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/cache_store_test.rb:58:in `test_getting_session_value_after_session_reset'\r\n\r\n\r\nrails test home/yahonda/src/github.com/rails/rails/actionpack/test/dispatch/session/cache_store_test.rb:57\r\n\r\n.........................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................\r\n\r\nFinished in 8.480767s, 437.4604 runs/s, 2075.5197 assertions/s.\r\n3710 runs, 17602 assertions, 6 failures, 2 errors, 0 skips\r\nrake aborted!\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45467/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45467/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45447","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45447/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45447/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45447/events","html_url":"https://github.com/rails/rails/issues/45447","id":1282666913,"node_id":"I_kwDNIULOTHPxoQ","number":45447,"title":"Anyway to change the default colors that rails uses?","user":{"login":"arianf","id":7397857,"node_id":"MDQ6VXNlcjczOTc4NTc=","avatar_url":"https://avatars.githubusercontent.com/u/7397857?v=4","gravatar_id":"","url":"https://api.github.com/users/arianf","html_url":"https://github.com/arianf","followers_url":"https://api.github.com/users/arianf/followers","following_url":"https://api.github.com/users/arianf/following{/other_user}","gists_url":"https://api.github.com/users/arianf/gists{/gist_id}","starred_url":"https://api.github.com/users/arianf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arianf/subscriptions","organizations_url":"https://api.github.com/users/arianf/orgs","repos_url":"https://api.github.com/users/arianf/repos","events_url":"https://api.github.com/users/arianf/events{/privacy}","received_events_url":"https://api.github.com/users/arianf/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-23T16:30:49Z","updated_at":"2022-06-23T17:04:34Z","closed_at":"2022-06-23T17:04:33Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nUse `rails c`\r\n\r\nwhile using a solarized dark console theme for Terminal...\r\n[Solarized Dark.terminal.zip](https://github.com/rails/rails/files/8968996/Solarized.Dark.terminal.zip)\r\n\r\n### Expected behavior\r\nNot to have colors clashing. Maybe be able to modify the standard colors that rails selects\r\n\r\n### Actual behavior\r\n\r\n<img width=\"383\" alt=\"Screen Shot 2022-06-23 at 9 13 28 AM\" src=\"https://user-images.githubusercontent.com/7397857/175348995-492285bd-97d5-4226-afe3-18ef1e0bb305.png\">\r\n\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\nRails 7.0.3\r\n\r\n**Ruby version**:\r\n\r\nruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [arm64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45447/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45447/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45443","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45443/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45443/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45443/events","html_url":"https://github.com/rails/rails/issues/45443","id":1282572313,"node_id":"I_kwDNIULOTHKAGQ","number":45443,"title":"Current versions of NPM packages do not match the actual most recent versions","user":{"login":"matthee","id":547653,"node_id":"MDQ6VXNlcjU0NzY1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/547653?v=4","gravatar_id":"","url":"https://api.github.com/users/matthee","html_url":"https://github.com/matthee","followers_url":"https://api.github.com/users/matthee/followers","following_url":"https://api.github.com/users/matthee/following{/other_user}","gists_url":"https://api.github.com/users/matthee/gists{/gist_id}","starred_url":"https://api.github.com/users/matthee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthee/subscriptions","organizations_url":"https://api.github.com/users/matthee/orgs","repos_url":"https://api.github.com/users/matthee/repos","events_url":"https://api.github.com/users/matthee/events{/privacy}","received_events_url":"https://api.github.com/users/matthee/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-23T15:15:51Z","updated_at":"2022-06-29T22:02:41Z","closed_at":"2022-06-29T22:02:41Z","author_association":"NONE","active_lock_reason":null,"body":"NPM displays version 6.0.5 as the most recent version of the [@rails/activestorage](https://www.npmjs.com/package/@rails/activestorage) package. However, version [7.0.3](https://www.npmjs.com/package/@rails/activestorage/v/7.0.3) actually is.\r\n\r\nSame thing applies to the [@rails/actiontext](https://www.npmjs.com/package/@rails/actiontext) package (maybe others as well?).\r\n\r\n# Why is this a problem?\r\n\r\nRunning `rails action_text:install` in a new app (with jsbundling) installs old versions of the @rails/actiontext and @rails/activestorage packages, without the most recent bugfixes. \r\n\r\nThis task calls `yarn add [package]` internally, which inserts the following line into `package.json`:\r\n\r\n```js\r\n  \"@rails/actiontext\": \"^6.0.5\"\r\n```\r\n\r\nI'm not sure how versions are ordered in the JS ecosystem. I assume it's by release date, since 6.0.5 seems to be the package most recently uploaded to NPM and is listed as the current version there. \r\n\r\nTherefore, running `rails action_text:install` in a rails 7 app leads to installation of the older 6.x packages (since these were the most recently uploaded ones).\r\n\r\n# How to fix?\r\n\r\nI'm not sure how. Maybe running `rails action_text:install` could install the corresponding package to the version of the actiontext gem? Thoughts?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45443/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45443/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45434","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45434/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45434/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45434/events","html_url":"https://github.com/rails/rails/issues/45434","id":1280838602,"node_id":"I_kwDNIULOTFgLyg","number":45434,"title":"Defer constant loading ActiveRecord `destroy_association_async_job` during Rails initialization","user":{"login":"bensheldon","id":47554,"node_id":"MDQ6VXNlcjQ3NTU0","avatar_url":"https://avatars.githubusercontent.com/u/47554?v=4","gravatar_id":"","url":"https://api.github.com/users/bensheldon","html_url":"https://github.com/bensheldon","followers_url":"https://api.github.com/users/bensheldon/followers","following_url":"https://api.github.com/users/bensheldon/following{/other_user}","gists_url":"https://api.github.com/users/bensheldon/gists{/gist_id}","starred_url":"https://api.github.com/users/bensheldon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bensheldon/subscriptions","organizations_url":"https://api.github.com/users/bensheldon/orgs","repos_url":"https://api.github.com/users/bensheldon/repos","events_url":"https://api.github.com/users/bensheldon/events{/privacy}","received_events_url":"https://api.github.com/users/bensheldon/received_events","type":"User","site_admin":true},"labels":[{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-22T20:27:20Z","updated_at":"2022-07-13T18:06:39Z","closed_at":"2022-07-13T18:06:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ActiveRecord's `destroy_association_async_job` currently loads an ActiveJob Job constant during ActiveRecord's initialization. Introduced in #40157\r\n\r\nhttps://github.com/rails/rails/blob/4d5a570cfe1890f71a1d198a5fe40d528f2b60d4/activejob/lib/active_job/railtie.rb#L45-L47\r\n\r\nThat means that loading ActiveRecord triggers loading the Job constant, which triggers initializing ActiveJob, which then triggers initializing the ActiveJob adapter. I have seen this cause an autoloading deadlock if somewhere during this chain an ActiveRecord constant is touched.\r\n\r\nA similar autoload chain is also present with [`ActionMailer.delivery_job`](https://github.com/rails/rails/blob/1003e974ed9cdae6a057a1857374bceb09b34a7b/actionmailer/lib/action_mailer/railtie.rb#L44-L46) but I have yet to see it deadlock (probably because people are less likely to reference an ActionMailer constant in their ActiveJob configuration).\r\n\r\nAside: I also think that the ActiveJob initializer linked above should be inverted such that it lives in ActiveRecord and is assigned `on_load(:active_job)`; that makes it more consistent with ActionMailers Railtie behavior. I don't think this impacts the autoload behavior though, just an observation.\r\n\r\n### Expected behavior\r\n\r\nThis loading could be deferred if instead of a constant, `destroy_association_async_job` was configured with a string that was then constantized when the behavior is invoked.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45434/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45433","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45433/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45433/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45433/events","html_url":"https://github.com/rails/rails/issues/45433","id":1280826386,"node_id":"I_kwDNIULOTFfcEg","number":45433,"title":"`1.years.hours`, `1.year.days`, and other duration methods called on `1.year` all return the number of seconds in a year. ","user":{"login":"db00m","id":85647423,"node_id":"MDQ6VXNlcjg1NjQ3NDIz","avatar_url":"https://avatars.githubusercontent.com/u/85647423?v=4","gravatar_id":"","url":"https://api.github.com/users/db00m","html_url":"https://github.com/db00m","followers_url":"https://api.github.com/users/db00m/followers","following_url":"https://api.github.com/users/db00m/following{/other_user}","gists_url":"https://api.github.com/users/db00m/gists{/gist_id}","starred_url":"https://api.github.com/users/db00m/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/db00m/subscriptions","organizations_url":"https://api.github.com/users/db00m/orgs","repos_url":"https://api.github.com/users/db00m/repos","events_url":"https://api.github.com/users/db00m/events{/privacy}","received_events_url":"https://api.github.com/users/db00m/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-22T20:19:24Z","updated_at":"2022-06-23T00:13:24Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"This issue is small and relatively unimportant, but it's still a bug that could cause problems in the future.  I use `1.year.seconds` to get the number of seconds and was about to use `1.year.days` to get the number of days in a year until I noticed the bug.\r\n\r\n### Steps to reproduce\r\nWhen running the rails console (assuming that doing so will load ActiveSupport) run the following lines of code:\r\n``` ruby\r\n1.year.seconds\r\n\r\n1.year.hours\r\n\r\n1.year.days\r\n```\r\nEvery line returns the same number—31556952—which is the number of seconds in a year.\r\n\r\n### Expected behavior\r\nI expect that `1.year.days` should return the number of days in a year.  The same should be the case for all other duration related methods that could be called on `Integer.year`\r\n\r\n### Actual behavior\r\nEach duration method returns the number of seconds in a year rather than the number of Days, Hours, or other duration types called on `Integer.year`.\r\n\r\n### System configuration\r\n**Rails Version**: 6.1.5\r\n\r\n**Ruby Version**: 3.0.3\r\n\r\nAnother note on system config: After discovering this bug in the project I was working on, I created an empty project to make sure the issue didn't come from conflicting gems.  The result was the same.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45433/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45433/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45431","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45431/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45431/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45431/events","html_url":"https://github.com/rails/rails/issues/45431","id":1280798406,"node_id":"I_kwDNIULOTFduxg","number":45431,"title":"Move `test:prepare` task to the main rails tasks from test_unit railtie","user":{"login":"simmerz","id":24327,"node_id":"MDQ6VXNlcjI0MzI3","avatar_url":"https://avatars.githubusercontent.com/u/24327?v=4","gravatar_id":"","url":"https://api.github.com/users/simmerz","html_url":"https://github.com/simmerz","followers_url":"https://api.github.com/users/simmerz/followers","following_url":"https://api.github.com/users/simmerz/following{/other_user}","gists_url":"https://api.github.com/users/simmerz/gists{/gist_id}","starred_url":"https://api.github.com/users/simmerz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simmerz/subscriptions","organizations_url":"https://api.github.com/users/simmerz/orgs","repos_url":"https://api.github.com/users/simmerz/repos","events_url":"https://api.github.com/users/simmerz/events{/privacy}","received_events_url":"https://api.github.com/users/simmerz/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-22T19:57:29Z","updated_at":"2022-06-22T19:57:29Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Presently, `test:prepare` is only defined in the test_unit railtie rake task as a placeholder to be hooked on to.\r\n\r\nThe `tailwindcss-rails`, `cssbundling-rails` and `jsbundling-rails` all enhance the task to allow tests to pre-compile to `app/assets/build`.\r\n\r\nHowever, for those of us using RSpec, there is no way without additional configuration to pre-compile those assets (we don't want to run `assets:precompile` either because that's utterly confusing for the developer when changes made to app/assets/* subsequently don't appear to work).\r\n\r\nBecause the Rakefile in a Rails app loads all the application rake tasks by default, then those from gems and then those in lib/tasks last of all, not including test_unit means there's no sensible way to ensure that a placeholder task exists *before* tailwindcss-rails etc enhance it, short of specifically putting the gems higher in the gemfile - that's not clear to the developer, and doesn't follow the convention that Rails should be easy to work with.\r\n\r\n`rspec-rails` already invokes `test:prepare` if it is defined, so it seems to me to make a great deal of sense to move this placeholder into the main rails tasks and then document it as a placeholder to be enhanced by other tasks.\r\n\r\nIf you're amenable to that, I'd be happy to raise a PR for it.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45431/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45431/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45430","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45430/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45430/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45430/events","html_url":"https://github.com/rails/rails/issues/45430","id":1280713821,"node_id":"I_kwDNIULOTFYkXQ","number":45430,"title":"database schema: foreign key causes json default to become string instead of object","user":{"login":"kyrofa","id":946674,"node_id":"MDQ6VXNlcjk0NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/946674?v=4","gravatar_id":"","url":"https://api.github.com/users/kyrofa","html_url":"https://github.com/kyrofa","followers_url":"https://api.github.com/users/kyrofa/followers","following_url":"https://api.github.com/users/kyrofa/following{/other_user}","gists_url":"https://api.github.com/users/kyrofa/gists{/gist_id}","starred_url":"https://api.github.com/users/kyrofa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kyrofa/subscriptions","organizations_url":"https://api.github.com/users/kyrofa/orgs","repos_url":"https://api.github.com/users/kyrofa/repos","events_url":"https://api.github.com/users/kyrofa/events{/privacy}","received_events_url":"https://api.github.com/users/kyrofa/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-22T18:39:03Z","updated_at":"2022-06-23T14:31:43Z","closed_at":"2022-06-23T14:31:43Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table \"accounts\", force: :cascade do |t|\r\n    t.text \"name\"\r\n  end\r\n\r\n  create_table \"products\", force: :cascade do |t|\r\n    t.integer \"account_id\"\r\n    t.json \"foo\", default: {}\r\n  end\r\n\r\n  # If you comment this out, this test will pass\r\n  add_foreign_key \"products\", \"accounts\", column: \"account_id\"\r\nend\r\n\r\nclass Product < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_product_foo_default\r\n    product = Product.new\r\n    assert_equal({}, product.foo)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nA json column with a `default: {}` should be an empty JSON object by default.\r\n\r\n### Actual behavior\r\nThe expected behavior is what happens until you add a foreign key. Then suddenly it quotes the braces, turning the default into a string. Note that this happens in both main and v7 (I have not tested anything else).\r\n\r\n### System configuration\r\n**Rails version**: main and 7.0.3\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45430/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45430/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45429","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45429/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45429/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45429/events","html_url":"https://github.com/rails/rails/issues/45429","id":1280338401,"node_id":"I_kwDNIULOTFBp4Q","number":45429,"title":"Polymorphic has_one / has_many Foreign Key Associations","user":{"login":"OskarEichler","id":62393985,"node_id":"MDQ6VXNlcjYyMzkzOTg1","avatar_url":"https://avatars.githubusercontent.com/u/62393985?v=4","gravatar_id":"","url":"https://api.github.com/users/OskarEichler","html_url":"https://github.com/OskarEichler","followers_url":"https://api.github.com/users/OskarEichler/followers","following_url":"https://api.github.com/users/OskarEichler/following{/other_user}","gists_url":"https://api.github.com/users/OskarEichler/gists{/gist_id}","starred_url":"https://api.github.com/users/OskarEichler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OskarEichler/subscriptions","organizations_url":"https://api.github.com/users/OskarEichler/orgs","repos_url":"https://api.github.com/users/OskarEichler/repos","events_url":"https://api.github.com/users/OskarEichler/events{/privacy}","received_events_url":"https://api.github.com/users/OskarEichler/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-22T15:17:41Z","updated_at":"2022-06-22T15:59:13Z","closed_at":"2022-06-22T15:58:52Z","author_association":"NONE","active_lock_reason":null,"body":"In this scenario we have two models, both with columns `:source_entity_id` and `:source_entity_type`\r\n\r\n```\r\nclass EntityPopularity\r\n  belongs_to :source_entity, polymorphic: true\r\nend\r\n```\r\n\r\n```\r\nclass CurrentEntityPopularity\r\n  belongs_to :source_entity, polymorphic: true\r\nend\r\n```\r\n\r\nUnfortunately there does not seem to be a good way of creating has_one or has_many associations between the two.\r\n\r\nThe nicest way to handle this would be:\r\n\r\n```\r\nclass EntityPopularity\r\n  belongs_to :source_entity, polymorphic: true\r\n  has_one :current_entity_popularity, foreign_key: [:source_entity_id, :source_entity_type], primary_key: [:source_entity_id, :source_entity_type]\r\nend\r\n```\r\n\r\nDe facto passing in an array of two foreign_keys - would it be possible to support that?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45429/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45429/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45428","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45428/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45428/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45428/events","html_url":"https://github.com/rails/rails/issues/45428","id":1280226378,"node_id":"I_kwDNIULOTE60Sg","number":45428,"title":"Not working with model connection to a view instead of a table","user":{"login":"Koen03","id":30521298,"node_id":"MDQ6VXNlcjMwNTIxMjk4","avatar_url":"https://avatars.githubusercontent.com/u/30521298?v=4","gravatar_id":"","url":"https://api.github.com/users/Koen03","html_url":"https://github.com/Koen03","followers_url":"https://api.github.com/users/Koen03/followers","following_url":"https://api.github.com/users/Koen03/following{/other_user}","gists_url":"https://api.github.com/users/Koen03/gists{/gist_id}","starred_url":"https://api.github.com/users/Koen03/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Koen03/subscriptions","organizations_url":"https://api.github.com/users/Koen03/orgs","repos_url":"https://api.github.com/users/Koen03/repos","events_url":"https://api.github.com/users/Koen03/events{/privacy}","received_events_url":"https://api.github.com/users/Koen03/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-22T14:17:49Z","updated_at":"2022-08-02T21:58:35Z","closed_at":"2022-08-02T21:58:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nAdd to model:\r\n`self.table_name = <view>`\r\n\r\n### Expected behavior\r\nExpect to work like any other model\r\n\r\n### Actual behavior\r\n`undefined method 'match' for nil:NilClass`\r\n`match = create_table_info(table_name).match(/'#{field_name}' (.+) DEFAULT ('|\\d+|[A-z]+)/)`\r\n\r\n### System configuration\r\n**Rails version**: 7.03\r\n\r\n**Ruby version**: 3.1.*\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45428/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45428/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45421","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45421/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45421/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45421/events","html_url":"https://github.com/rails/rails/issues/45421","id":1278701548,"node_id":"I_kwDNIULOTDdv7A","number":45421,"title":"Is it possible to add s3 direct upload policies with active storage?","user":{"login":"imanpalsingh","id":49276301,"node_id":"MDQ6VXNlcjQ5Mjc2MzAx","avatar_url":"https://avatars.githubusercontent.com/u/49276301?v=4","gravatar_id":"","url":"https://api.github.com/users/imanpalsingh","html_url":"https://github.com/imanpalsingh","followers_url":"https://api.github.com/users/imanpalsingh/followers","following_url":"https://api.github.com/users/imanpalsingh/following{/other_user}","gists_url":"https://api.github.com/users/imanpalsingh/gists{/gist_id}","starred_url":"https://api.github.com/users/imanpalsingh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imanpalsingh/subscriptions","organizations_url":"https://api.github.com/users/imanpalsingh/orgs","repos_url":"https://api.github.com/users/imanpalsingh/repos","events_url":"https://api.github.com/users/imanpalsingh/events{/privacy}","received_events_url":"https://api.github.com/users/imanpalsingh/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-21T16:34:43Z","updated_at":"2022-06-23T00:41:10Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"In my current implementation, to add file upload size validations directly with S3 I am using [policies](https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-HTTPPOSTConstructPolicy.html) and setting `content-length-range` in them.\r\n\r\nThis request looks something like\r\n\r\n```\r\npolicy: eyJleHBpcmF0aW9uIjoiMjAyMi0wNi0yMl....\r\nsuccess_action_status: 201\r\nX-Amz-Algorithm: AWS4-HMAC-SHA256\r\nX-Amz-Credential: 123/20220621/us-east-1/s3/aws4_request\r\nX-Amz-Date: 20220621T161259Z\r\nX-Amz-Signature: 7d309f63646082d49e52ddf0b38...\r\nX-Requested-With: xhr\r\n```\r\n\r\nWhen I perform a s3 direct upload with active storage, this is what gets sent with the request by default.\r\n\r\n<img width=\"594\" alt=\"Screenshot 2022-06-21 at 9 52 30 PM\" src=\"https://user-images.githubusercontent.com/49276301/174849391-bf824c50-7b33-43eb-bf92-f826bd7bdbbb.png\">\r\n\r\n\r\nIs it possible for me to add `policies` in the direct upload with active storage ?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45421/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45421/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45418","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45418/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45418/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45418/events","html_url":"https://github.com/rails/rails/issues/45418","id":1278211761,"node_id":"I_kwDNIULOTC_2sQ","number":45418,"title":"Active Job worker crashes when a job causes an Exception in DelayedJob","user":{"login":"fnordfish","id":12839,"node_id":"MDQ6VXNlcjEyODM5","avatar_url":"https://avatars.githubusercontent.com/u/12839?v=4","gravatar_id":"","url":"https://api.github.com/users/fnordfish","html_url":"https://github.com/fnordfish","followers_url":"https://api.github.com/users/fnordfish/followers","following_url":"https://api.github.com/users/fnordfish/following{/other_user}","gists_url":"https://api.github.com/users/fnordfish/gists{/gist_id}","starred_url":"https://api.github.com/users/fnordfish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fnordfish/subscriptions","organizations_url":"https://api.github.com/users/fnordfish/orgs","repos_url":"https://api.github.com/users/fnordfish/repos","events_url":"https://api.github.com/users/fnordfish/events{/privacy}","received_events_url":"https://api.github.com/users/fnordfish/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null},{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2022-06-21T10:07:33Z","updated_at":"2022-07-05T17:22:57Z","closed_at":"2022-07-05T17:22:57Z","author_association":"NONE","active_lock_reason":null,"body":"(I'm not quite sure if that issue is limited to the DelayedJob adapter)\r\n\r\n### Steps to reproduce\r\n\r\nDemo project with traces: https://github.com/fnordfish/activejob-poison-pill-demo.\r\n\r\n```ruby\r\nclass TestJob < ActiveJob::Base\r\n  # Thid has no effect on Exceptions thrown in Queue Adapters?\r\n  discard_on Encoding::CompatibilityError\r\n  \r\n  # this will eventually bubble up into the Adapter (when retries exhausted?)\r\n  retry_on Exception, wait: 1.second\r\n\r\n  def perform(message)\r\n    raise message.dup.force_encoding(\"ASCII-8BIT\")\r\n  end\r\nend\r\n\r\nTestJob.perform_later(\"🤷\")\r\n```\r\n\r\n### Expected behavior\r\n\r\n- Job fails\r\n- Exception trace of the `Encoding::CompatibilityError` is logged\r\n- Job worker keeps on working, not trying the failed job again\r\n\r\n### Actual behavior\r\n\r\n- Job fails\r\n- Exception trace of the `Encoding::CompatibilityError` is logged\r\n- Job worker crashes with `Encoding::CompatibilityError` exception\r\n- Restarting the job worker will try the failed job again, crashing the job worker again\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3, 7.1.0.alpha\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45418/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45418/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45417","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45417/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45417/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45417/events","html_url":"https://github.com/rails/rails/issues/45417","id":1278097911,"node_id":"I_kwDNIULOTC459w","number":45417,"title":"Rails 5.2.3: Not able to install rails 5.2.3 because of transitive dependencies on  minitest 5.16.1 ~> 5.1:","user":{"login":"mayankesh-maurya","id":17639176,"node_id":"MDQ6VXNlcjE3NjM5MTc2","avatar_url":"https://avatars.githubusercontent.com/u/17639176?v=4","gravatar_id":"","url":"https://api.github.com/users/mayankesh-maurya","html_url":"https://github.com/mayankesh-maurya","followers_url":"https://api.github.com/users/mayankesh-maurya/followers","following_url":"https://api.github.com/users/mayankesh-maurya/following{/other_user}","gists_url":"https://api.github.com/users/mayankesh-maurya/gists{/gist_id}","starred_url":"https://api.github.com/users/mayankesh-maurya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayankesh-maurya/subscriptions","organizations_url":"https://api.github.com/users/mayankesh-maurya/orgs","repos_url":"https://api.github.com/users/mayankesh-maurya/repos","events_url":"https://api.github.com/users/mayankesh-maurya/events{/privacy}","received_events_url":"https://api.github.com/users/mayankesh-maurya/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-21T08:36:01Z","updated_at":"2022-06-21T08:53:51Z","closed_at":"2022-06-21T08:53:51Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI am using ruby version as 2.5.9\r\n\r\nruby -v\r\nruby 2.5.9p229 (2021-04-05 revision 67939) [x86_64-linux]\r\n\r\nwhile installing gem using gem install it is giving below error:\r\nERROR:  Error installing rails:\r\n        minitest requires Ruby version < 4.0, >= 2.6. The current ruby version is 2.5.0.\r\n\r\nI tried to install minitest older version which was working as minitest 5.15, but still I am facing same issue.\r\n\r\nI am running my application in centos 7 and _I am not using bundler_ \r\n\r\nWe are first installing gems our app requires using \"gem install\" as below.\r\n\r\n`\r\nhttp_proxy=proxy-grp1.lb-priv.svc.247-inc.net:3128 gem install --install-dir /usr/share/gems rails -v '5.2.3'\r\nhttp_proxy=proxy-grp1.lb-priv.svc.247-inc.net:3128 gem install --install-dir /usr/share/gems passenger -v '5.0.22'\r\n`\r\nI have raised the below PRs to the Ruby on Rails community.\r\n\r\nhttps://github.com/rails/rails/pull/45386\r\nhttps://github.com/mayankesh-maurya/minitest/pull/1\r\n\r\n### Expected behavior\r\nit should be able to install rails gem\r\n\r\n### Actual behavior\r\nit is not able to install, giving the below error and breaking backward compatibility.\r\nERROR:  Error installing rails:\r\n        minitest requires Ruby version < 4.0, >= 2.6. The current ruby version is 2.5.0.\r\n\r\n### System configuration\r\n**Rails version**: rails 5.2.3\r\n\r\n**Ruby version**: ruby 2.5.9p229 (2021-04-05 revision 67939) [x86_64-linux]\r\n\r\nPlease check this, it does not provide backward compatibility and breaks the existing ROR application.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45417/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45417/timeline","performed_via_github_app":null,"state_reason":"not_planned"},{"url":"https://api.github.com/repos/rails/rails/issues/45416","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45416/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45416/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45416/events","html_url":"https://github.com/rails/rails/issues/45416","id":1277946621,"node_id":"I_kwDNIULOTCvq_Q","number":45416,"title":"Rails7.X: Cache of attribtute method definistions will be applied to methods with different target.","user":{"login":"sachisuzuki","id":73353020,"node_id":"MDQ6VXNlcjczMzUzMDIw","avatar_url":"https://avatars.githubusercontent.com/u/73353020?v=4","gravatar_id":"","url":"https://api.github.com/users/sachisuzuki","html_url":"https://github.com/sachisuzuki","followers_url":"https://api.github.com/users/sachisuzuki/followers","following_url":"https://api.github.com/users/sachisuzuki/following{/other_user}","gists_url":"https://api.github.com/users/sachisuzuki/gists{/gist_id}","starred_url":"https://api.github.com/users/sachisuzuki/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sachisuzuki/subscriptions","organizations_url":"https://api.github.com/users/sachisuzuki/orgs","repos_url":"https://api.github.com/users/sachisuzuki/repos","events_url":"https://api.github.com/users/sachisuzuki/events{/privacy}","received_events_url":"https://api.github.com/users/sachisuzuki/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-06-21T06:18:44Z","updated_at":"2022-06-27T02:08:29Z","closed_at":"2022-06-25T07:17:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```\r\n$ docker run --rm -ti ruby:3.1.2 /bin/bash\r\n$ ruby test_case.rb\r\n```\r\n-test_case.rb\r\n```ruby:test_case.rb\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n  gem \"activemodel\", \"~> 7.0.3\"\r\nend\r\n\r\nrequire \"active_model\"\r\n\r\nclass C1\r\n  include ActiveModel::AttributeMethods\r\n  attribute_method_suffix \"_changed?\", parameters: false\r\n  define_attribute_methods :x\r\n  attr_accessor :x\r\n\r\n  def attributes\r\n    {\"x\" => @x}\r\n  end\r\n\r\n  def attribute_changed?(name, **options)\r\n    [name, self.class, __method__]\r\n  end\r\nend\r\n\r\np C1.new.x_changed? #=> [\"x\", C1, :attribute_changed?]\r\n\r\n# The definition of `x_changed?` is cached on ActiveSupprt::CodeGenerator,\r\n# and It is applied to methods with the same name, even if they should call\r\n# different target method.\r\nclass C2\r\n  include ActiveModel::AttributeMethods\r\n  attribute_method_suffix \"?\", parameters: false\r\n  define_attribute_methods :x_changed\r\n  attr_accessor :x_changed\r\n\r\n  def attributes\r\n    {\"x_changed\" => @x_changed}\r\n  end\r\n\r\n  # It is expected to be called through `C2#x_changed?`,\r\n  # although `C2#attribute_changed?` will be called.\r\n  def attribute?(name, **options)\r\n    [name, self.class, __method__]\r\n  end\r\nend\r\n\r\np C2.new.x_changed? #=> undefined method `attribute_changed?' for #<C2:0x00007fdbbd0688a8> (NoMethodError)\r\n\r\n```\r\n\r\n### Expected behavior\r\nC2#attribute? is expected to be called.\r\n\r\n### Actual behavior\r\nCached `C2#attribute_changed?` is called and a NoMethodError is raised.\r\nundefined method `attribute_changed?' for #<C2:.....> (NoMethodError)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n**Ruby version**: 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45416/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45416/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45409","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45409/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45409/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45409/events","html_url":"https://github.com/rails/rails/issues/45409","id":1276968462,"node_id":"I_kwDNIULOTBz-Dg","number":45409,"title":"ActionDispatch::IntegrationTest GET with params keyword cause a conversion to POST ","user":{"login":"matteo-rossi-wise","id":60428992,"node_id":"MDQ6VXNlcjYwNDI4OTky","avatar_url":"https://avatars.githubusercontent.com/u/60428992?v=4","gravatar_id":"","url":"https://api.github.com/users/matteo-rossi-wise","html_url":"https://github.com/matteo-rossi-wise","followers_url":"https://api.github.com/users/matteo-rossi-wise/followers","following_url":"https://api.github.com/users/matteo-rossi-wise/following{/other_user}","gists_url":"https://api.github.com/users/matteo-rossi-wise/gists{/gist_id}","starred_url":"https://api.github.com/users/matteo-rossi-wise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matteo-rossi-wise/subscriptions","organizations_url":"https://api.github.com/users/matteo-rossi-wise/orgs","repos_url":"https://api.github.com/users/matteo-rossi-wise/repos","events_url":"https://api.github.com/users/matteo-rossi-wise/events{/privacy}","received_events_url":"https://api.github.com/users/matteo-rossi-wise/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-20T13:53:12Z","updated_at":"2022-06-20T18:45:21Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n- Setup a new Rails api_only app with MiniTest\r\n- Write a controller with `index` and `create` actions (and respective routes)\r\n- Write an `ActionDispatch::IntegrationTest` to test both previous actions\r\n- Run the test suite\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\ntest \"should get index and return ok on success\" do\r\n  get items_url, params: index_params, as: :json\r\n  assert_response :ok\r\nend\r\n\r\ntest \"should post create and return created on success\" do\r\n  post items_url, params: create_params, as: :json\r\n  assert_response :created\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nThe first test (GET) is successful\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nThe first test fails, its verb is converted to `POST` and the invoked action is `create`. I managed make the test pass by converting the first test like this:\r\n\r\n```ruby\r\ntest \"should get index and return ok on success\" do\r\n  get items_url(index_params), as: :json\r\n  assert_response :ok\r\nend\r\n```\r\n\r\nor by removing the `as: :json` like this:\r\n\r\n```ruby\r\ntest \"should get index and return ok on success\" do\r\n  get items_url, params: index_params\r\n  assert_response :ok\r\nend\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45409/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45409/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45408","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45408/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45408/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45408/events","html_url":"https://github.com/rails/rails/issues/45408","id":1276854251,"node_id":"I_kwDNIULOTBs_6w","number":45408,"title":"Is load_async supposed to work on associations?","user":{"login":"andrejbl","id":36857192,"node_id":"MDQ6VXNlcjM2ODU3MTky","avatar_url":"https://avatars.githubusercontent.com/u/36857192?v=4","gravatar_id":"","url":"https://api.github.com/users/andrejbl","html_url":"https://github.com/andrejbl","followers_url":"https://api.github.com/users/andrejbl/followers","following_url":"https://api.github.com/users/andrejbl/following{/other_user}","gists_url":"https://api.github.com/users/andrejbl/gists{/gist_id}","starred_url":"https://api.github.com/users/andrejbl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrejbl/subscriptions","organizations_url":"https://api.github.com/users/andrejbl/orgs","repos_url":"https://api.github.com/users/andrejbl/repos","events_url":"https://api.github.com/users/andrejbl/events{/privacy}","received_events_url":"https://api.github.com/users/andrejbl/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-06-20T12:27:14Z","updated_at":"2022-06-23T12:11:17Z","closed_at":"2022-06-23T12:11:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have a model called `App` which has a `has_many` association to a model called `ManualTags`.\r\n\r\n```ruby\r\nclass App < ApplicationRecord\r\n  ...\r\n  has_many :manual_tags, class_name: \"TagService::Private::DataModels::ManualTag\"\r\n  ...\r\nend\r\n```\r\n\r\nTrying to force the association to load_async doesn't seem to work (notice no ASYNC in the log output):\r\n\r\n```ruby\r\ntest = app.reload.manual_tags.load_async; sleep 1; test.load;\r\n...\r\nTagService::Private::DataModels::ManualTag Load (0.7ms)  SELECT `manual_tags`.* FROM `manual_tags` WHERE `manual_tags`.`deleted` = FALSE AND `manual_tags`.`app_id` = '<obfuscated>'\r\n```\r\n\r\nHowever, when I explicitly force a dummy relation on the query, it gets executed async without problems: 🤔 \r\n\r\n```ruby\r\ntest = app.reload.manual_tags.where(\"1=1\").load_async; sleep 1; test.load;\r\n...\r\nASYNC TagService::Private::DataModels::ManualTag Load (0.0ms) (db time 0.7ms)  SELECT `manual_tags`.* FROM `manual_tags` WHERE `manual_tags`.`deleted` = FALSE AND `manual_tags`.`app_id` = '<obfuscated>' AND (1=1)\r\n...\r\n```\r\n\r\nI'm using the reload/load mechanism since this repro is ran on the console and I want to make sure the query doesn't get optimised to run straight away or is already loaded.\r\n\r\nIn both cases, I can see that the async behaviour on the connection is enabled:\r\n\r\n```ruby\r\n[5] Rails(DEV)> app.manual_tags.connection.async_enabled?\r\n=> true\r\n[6] Rails(DEV)> app.manual_tags.where(\"1=1\").connection.async_enabled?\r\n=> true\r\n```\r\n\r\nThe `async_query_executor` is configured to run in `:multi_thread_pool` mode:\r\n\r\n```ruby\r\nconfig.active_record.async_query_executor = :multi_thread_pool\r\n```\r\n\r\nAm I missing something here? Or there is a an issue or load_async is not supposed to work on associations? Thanks for the input!\r\n\r\n### Expected behavior\r\n`test = app.reload.manual_tags.load_async; sleep 1; test.load;` runs the query asynchronously\r\n\r\n### Actual behavior\r\n`test = app.reload.manual_tags.load_async; sleep 1; test.load;` runs the query synchronously \r\n\r\n### System configuration\r\n**Rails version**:\r\n`Rails 7.0.3`\r\n\r\n**Ruby version**:\r\n`ruby 2.7.5`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45408/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45408/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45407","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45407/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45407/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45407/events","html_url":"https://github.com/rails/rails/issues/45407","id":1276847606,"node_id":"I_kwDNIULOTBsl9g","number":45407,"title":"Switch to rollup from blade for building actionview","user":{"login":"pravi","id":708222,"node_id":"MDQ6VXNlcjcwODIyMg==","avatar_url":"https://avatars.githubusercontent.com/u/708222?v=4","gravatar_id":"","url":"https://api.github.com/users/pravi","html_url":"https://github.com/pravi","followers_url":"https://api.github.com/users/pravi/followers","following_url":"https://api.github.com/users/pravi/following{/other_user}","gists_url":"https://api.github.com/users/pravi/gists{/gist_id}","starred_url":"https://api.github.com/users/pravi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pravi/subscriptions","organizations_url":"https://api.github.com/users/pravi/orgs","repos_url":"https://api.github.com/users/pravi/repos","events_url":"https://api.github.com/users/pravi/events{/privacy}","received_events_url":"https://api.github.com/users/pravi/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":603319189,"node_id":"MDU6TGFiZWw2MDMzMTkxODk=","url":"https://api.github.com/repos/rails/rails/labels/rails-ujs","name":"rails-ujs","color":"5319e7","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","site_admin":false},"assignees":[{"login":"skipkayhil","id":6014046,"node_id":"MDQ6VXNlcjYwMTQwNDY=","avatar_url":"https://avatars.githubusercontent.com/u/6014046?v=4","gravatar_id":"","url":"https://api.github.com/users/skipkayhil","html_url":"https://github.com/skipkayhil","followers_url":"https://api.github.com/users/skipkayhil/followers","following_url":"https://api.github.com/users/skipkayhil/following{/other_user}","gists_url":"https://api.github.com/users/skipkayhil/gists{/gist_id}","starred_url":"https://api.github.com/users/skipkayhil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skipkayhil/subscriptions","organizations_url":"https://api.github.com/users/skipkayhil/orgs","repos_url":"https://api.github.com/users/skipkayhil/repos","events_url":"https://api.github.com/users/skipkayhil/events{/privacy}","received_events_url":"https://api.github.com/users/skipkayhil/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-06-20T12:21:44Z","updated_at":"2022-07-13T03:03:22Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\nWhen trying to update cofeescript to 2.x in debian, the default output switched to ES6 and execjs . See https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1013218 We'd prefer to use coffeescript 2 and looks like coffee-script project is stalled. https://github.com/rails/ruby-coffee-script/issues/22\r\n\r\n### Expected behavior\r\nlike activestorage and in line with moving to native node tools and webpacker, actionview should switch to rollup as well.\r\n\r\n### Actual behavior\r\nIt is still using blade, which use coffee-script gem and which is still using coffeescript 1.x.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45407/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45407/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45406","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45406/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45406/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45406/events","html_url":"https://github.com/rails/rails/issues/45406","id":1276813606,"node_id":"I_kwDNIULOTBqhJg","number":45406,"title":"Supporting preloading on instance dependent associations not working","user":{"login":"GregSmith92","id":48311414,"node_id":"MDQ6VXNlcjQ4MzExNDE0","avatar_url":"https://avatars.githubusercontent.com/u/48311414?v=4","gravatar_id":"","url":"https://api.github.com/users/GregSmith92","html_url":"https://github.com/GregSmith92","followers_url":"https://api.github.com/users/GregSmith92/followers","following_url":"https://api.github.com/users/GregSmith92/following{/other_user}","gists_url":"https://api.github.com/users/GregSmith92/gists{/gist_id}","starred_url":"https://api.github.com/users/GregSmith92/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GregSmith92/subscriptions","organizations_url":"https://api.github.com/users/GregSmith92/orgs","repos_url":"https://api.github.com/users/GregSmith92/repos","events_url":"https://api.github.com/users/GregSmith92/events{/privacy}","received_events_url":"https://api.github.com/users/GregSmith92/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-20T11:54:40Z","updated_at":"2022-07-01T09:58:24Z","closed_at":"2022-07-01T09:58:24Z","author_association":"NONE","active_lock_reason":null,"body":"Rails 6.1.6\r\nRuby 3.1.2\r\n\r\nI have an instance dependent association where queries which require preloading cannot be run.\r\n\r\nMy model:\r\n```\r\nclass Artist < ApplicationRecord\r\n  has_many :artist_masters, ->(artist) {\r\n    unscope(:where).where(artist_id: artist.id)\r\n                   .or(where(composer_id: artist.id))\r\n                   .or(where(performer_id: artist.id))\r\n                   .or(where(conductor_id: artist.id))\r\n  }\r\n\r\n  has_many :masters, through: :artist_masters\r\nend\r\n```\r\n\r\n`Artist.includes(:artist_masters).first` results in `ArgumentError: The association scope 'artist_masters' is instance dependent (the scope block takes an argument). Preloading instance dependent scopes is not supported.`\r\n\r\nThere was however a [PR merged in Jun 2021 ](https://github.com/rails/rails/pull/42553) which added support for this.\r\n\r\nPerhaps I am misunderstanding the scope of this PR, but should this not work?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45406/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45406/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45405","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45405/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45405/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45405/events","html_url":"https://github.com/rails/rails/issues/45405","id":1276528836,"node_id":"I_kwDNIULOTBZIxA","number":45405,"title":"Allow configuration of embeddables storage service for ActionText via `has_rich_text`","user":{"login":"simmerz","id":24327,"node_id":"MDQ6VXNlcjI0MzI3","avatar_url":"https://avatars.githubusercontent.com/u/24327?v=4","gravatar_id":"","url":"https://api.github.com/users/simmerz","html_url":"https://github.com/simmerz","followers_url":"https://api.github.com/users/simmerz/followers","following_url":"https://api.github.com/users/simmerz/following{/other_user}","gists_url":"https://api.github.com/users/simmerz/gists{/gist_id}","starred_url":"https://api.github.com/users/simmerz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simmerz/subscriptions","organizations_url":"https://api.github.com/users/simmerz/orgs","repos_url":"https://api.github.com/users/simmerz/repos","events_url":"https://api.github.com/users/simmerz/events{/privacy}","received_events_url":"https://api.github.com/users/simmerz/received_events","type":"User","site_admin":false},"labels":[{"id":1180817762,"node_id":"MDU6TGFiZWwxMTgwODE3NzYy","url":"https://api.github.com/repos/rails/rails/labels/actiontext","name":"actiontext","color":"3bc667","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-20T08:03:07Z","updated_at":"2022-06-24T14:10:49Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Currently, ActionText attachments use the default storage service.\r\n\r\nIf we want one ActionText `has_rich_text` on a model to use a public service, the whole app needs to be public first, rather than private first, the latter of which would be my preference.\r\n\r\nAllowing a per case configuration as is possible with native-to-model attachables would allow the developer to choose their preference, and importantly allow that data-privacy-first approach.\r\n\r\nI guess it should fall back to the default configured service if none is specified.\r\n\r\nI would propose to use the same service parameter as is used on `has_x_attached` and pass it through to `has_many_attached :embeds` at [rails/rich_text.rb](https://github.com/rails/rails/blob/914caca2d31bd753f47f9168f2a375921d9e91cc/actiontext/app/models/action_text/rich_text.rb#L15)\r\n\r\nNot sure of the best way to go about passing that through though, so it’s configurable per rich text, rather than globally.\r\n\r\nPreviously posted as a discussion [here](https://discuss.rubyonrails.org/t/feature-proposal-allow-actiontext-content-attachments-to-use-configurable-service/76804) but posting as an issue here so that if it's worthwhile it can be PR'd.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45405/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45405/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45401","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45401/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45401/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45401/events","html_url":"https://github.com/rails/rails/issues/45401","id":1276128189,"node_id":"I_kwDNIULOTBArvQ","number":45401,"title":"API Only project keeps pinging for `/__vite_ping`","user":{"login":"xluk9","id":25955481,"node_id":"MDQ6VXNlcjI1OTU1NDgx","avatar_url":"https://avatars.githubusercontent.com/u/25955481?v=4","gravatar_id":"","url":"https://api.github.com/users/xluk9","html_url":"https://github.com/xluk9","followers_url":"https://api.github.com/users/xluk9/followers","following_url":"https://api.github.com/users/xluk9/following{/other_user}","gists_url":"https://api.github.com/users/xluk9/gists{/gist_id}","starred_url":"https://api.github.com/users/xluk9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xluk9/subscriptions","organizations_url":"https://api.github.com/users/xluk9/orgs","repos_url":"https://api.github.com/users/xluk9/repos","events_url":"https://api.github.com/users/xluk9/events{/privacy}","received_events_url":"https://api.github.com/users/xluk9/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-19T17:55:51Z","updated_at":"2022-06-19T19:42:28Z","closed_at":"2022-06-19T19:41:30Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# The same with: rails new test --api --skip-javascript --skip-hotwire --skip-asset-pipeline\r\nrails new test --api\r\ncd test\r\nrails s -b 0.0.0.0\r\n```\r\n\r\n### Expected behavior\r\n```sh\r\n=> Booting Puma\r\n=> Rails 7.0.3 application starting in development\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.2-p20) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: development\r\n*          PID: 408575\r\n* Listening on http://0.0.0.0:3000\r\nUse Ctrl-C to stop\r\n   (0.6ms)  SELECT sqlite_version(*)\r\n```\r\n\r\n### Actual behavior\r\nThe `Started GET \"/__vite_ping\"...` with `ActionController::RoutingError...` keeps flooding the terminal output evert few seconds. \r\n```sh\r\n=> Booting Puma\r\n=> Rails 7.0.3 application starting in development\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.2-p20) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: development\r\n*          PID: 408575\r\n* Listening on http://0.0.0.0:3000\r\nUse Ctrl-C to stop\r\nStarted GET \"/__vite_ping\" for *.*.*.* at 2022-06-19 19:47:35 +0200\r\n   (0.6ms)  SELECT sqlite_version(*)\r\n\r\nActionController::RoutingError (No route matches [GET] \"/__vite_ping\"):\r\n\r\nStarted GET \"/__vite_ping\" for *.*.*.* at 2022-06-19 19:47:37 +0200\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n```sh\r\n$ rails -v\r\nRails 7.0.3\r\n```\r\n**Ruby version**:\r\n```sh\r\n$ ruby -v\r\nruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45401/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45401/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45398","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45398/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45398/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45398/events","html_url":"https://github.com/rails/rails/issues/45398","id":1275876875,"node_id":"I_kwDNIULOTAxWCw","number":45398,"title":"Order of SQL JOINs should not matter for ActiveRecord::Relation#or","user":{"login":"Exterm1nate","id":48535087,"node_id":"MDQ6VXNlcjQ4NTM1MDg3","avatar_url":"https://avatars.githubusercontent.com/u/48535087?v=4","gravatar_id":"","url":"https://api.github.com/users/Exterm1nate","html_url":"https://github.com/Exterm1nate","followers_url":"https://api.github.com/users/Exterm1nate/followers","following_url":"https://api.github.com/users/Exterm1nate/following{/other_user}","gists_url":"https://api.github.com/users/Exterm1nate/gists{/gist_id}","starred_url":"https://api.github.com/users/Exterm1nate/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Exterm1nate/subscriptions","organizations_url":"https://api.github.com/users/Exterm1nate/orgs","repos_url":"https://api.github.com/users/Exterm1nate/repos","events_url":"https://api.github.com/users/Exterm1nate/events{/privacy}","received_events_url":"https://api.github.com/users/Exterm1nate/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-18T20:20:27Z","updated_at":"2022-06-24T13:48:33Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nConsider we have some model with associations.\r\n\r\n```ruby\r\nclass User < ApplicationRecord\r\n  has_many :posts\r\n  has_many :comments\r\nend\r\n```\r\n\r\nThen we want to use `ActiveRecord::Relation#or` to build some query.\r\n\r\n```ruby\r\n  User.joins(:posts, :comments).where(comments: { id: 1 }).or(User.joins(:comments, :posts).where(posts: { id: 2 }))\r\n```\r\n\r\n### Expected behavior\r\n\r\nIt should produce a valid SQL query with two JOINs (final order of JOIN statements can be determined from one of subqueries).\r\n\r\n```ruby\r\nUser.joins(:posts, :comments).where(comments: { id: 1 }).or(User.joins(:comments, :posts).where(posts: { id: 2 }))\r\n\r\n# SELECT \"users\".* FROM \"users\" INNER JOIN \"posts\" ON \"posts\".\"user_id\" = \"users\".\"id\" INNER JOIN \"comments\" ON \"comments\".\"user_id\" = \"users\".\"id\" WHERE (\"comments\".\"id\" = $1 OR \"posts\".\"id\" = $2)  [[\"id\", 1], [\"id\", 2]]\r\n```\r\n\r\n### Actual behavior\r\n\r\nBut it raises an error due to arguments order difference in #joins.\r\n\r\n```ruby\r\nUser.joins(:posts, :comments).where(comments: { id: 1 }).or(User.joins(:comments, :posts).where(posts: { id: 2 }))\r\n\r\n# Relation passed to #or must be structurally compatible. Incompatible values: [:joins] (ArgumentError)\r\n```\r\n\r\n### Notes\r\n\r\nThis problem exists for all methods provided in `STRUCTURAL_VALUE_METHODS` constant in `ActiveRecord::QueryMethods`. I think for most of them arguments order should not be checked.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45398/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45398/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45392","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45392/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45392/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45392/events","html_url":"https://github.com/rails/rails/issues/45392","id":1275369579,"node_id":"I_kwDNIULOTASYaw","number":45392,"title":"Rails 7 activejob using deprecated Que API","user":{"login":"kyrofa","id":946674,"node_id":"MDQ6VXNlcjk0NjY3NA==","avatar_url":"https://avatars.githubusercontent.com/u/946674?v=4","gravatar_id":"","url":"https://api.github.com/users/kyrofa","html_url":"https://github.com/kyrofa","followers_url":"https://api.github.com/users/kyrofa/followers","following_url":"https://api.github.com/users/kyrofa/following{/other_user}","gists_url":"https://api.github.com/users/kyrofa/gists{/gist_id}","starred_url":"https://api.github.com/users/kyrofa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kyrofa/subscriptions","organizations_url":"https://api.github.com/users/kyrofa/orgs","repos_url":"https://api.github.com/users/kyrofa/repos","events_url":"https://api.github.com/users/kyrofa/events{/privacy}","received_events_url":"https://api.github.com/users/kyrofa/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-17T19:03:39Z","updated_at":"2022-06-18T15:21:16Z","closed_at":"2022-06-18T07:08:43Z","author_association":"NONE","active_lock_reason":null,"body":"Forgive me, I'm not entirely up to speed on how Rails determines what fixes land where. Que recently deprecated parts of its API in preparation for Ruby 3, which makes Rails 7 spit a lot of deprecation warnings. This is fixed in Rails main with 6c933738421bec6ad266f2fa0037942eb0605c00. Any chance we can get that cherry-picked back to a v7 release? I'd be happy to propose exactly that to the 7-0-stable branch if that's the proper process.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45392/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45392/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45390","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45390/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45390/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45390/events","html_url":"https://github.com/rails/rails/issues/45390","id":1275315412,"node_id":"I_kwDNIULOTAPE1A","number":45390,"title":"Rails 7.0.3 vs Rails 6.1.4.4 regression when using shards in production","user":{"login":"net1957","id":17736,"node_id":"MDQ6VXNlcjE3NzM2","avatar_url":"https://avatars.githubusercontent.com/u/17736?v=4","gravatar_id":"","url":"https://api.github.com/users/net1957","html_url":"https://github.com/net1957","followers_url":"https://api.github.com/users/net1957/followers","following_url":"https://api.github.com/users/net1957/following{/other_user}","gists_url":"https://api.github.com/users/net1957/gists{/gist_id}","starred_url":"https://api.github.com/users/net1957/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/net1957/subscriptions","organizations_url":"https://api.github.com/users/net1957/orgs","repos_url":"https://api.github.com/users/net1957/repos","events_url":"https://api.github.com/users/net1957/events{/privacy}","received_events_url":"https://api.github.com/users/net1957/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":13,"created_at":"2022-06-17T17:50:57Z","updated_at":"2022-09-04T12:41:52Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# I'm using sharding for some models.\r\nmodule Cmdmary\r\n  # base class for AR\r\n  class CmdmaryRecord < ApplicationRecord\r\n    self.abstract_class = true\r\n\r\n    connects_to shards: {\r\n      fr: { writing: :comdev_fr },\r\n      de: { writing: :comdev_de }\r\n    }\r\n  end\r\nend\r\n\r\ndatabase.yml contain:\r\ndefault: &default\r\n  adapter: oracle_enhanced\r\n  pool: 5\r\n  timeout: 5000\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\n  comdev_fr:\r\n    <<: *default\r\n    migrations_paths: db/migrate_none\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\n  comdev_de:\r\n    <<: *default\r\n    migrations_paths: db/migrate_none\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\nproduction:\r\n  primary:\r\n    <<: *default\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\n  comdev_fr:\r\n    <<: *default\r\n    migrations_paths: db/migrate_none\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\n  comdev_de:\r\n    <<: *default\r\n    migrations_paths: db/migrate_none\r\n    database: sk-oracle11.sk.loc/XE\r\n    username: xx\r\n    password: xx\r\n\r\nin the controller the connection is managed by:\r\n        def handle_tenant\r\n          ::Cmdmary::CmdmaryRecord.connected_to(shard: api_params[:tenant].to_sym, role: :writing) do\r\n            Rails.logger.warn { \"Tenant used:'#{api_params[:tenant]}', api:'#{api}'\" }\r\n            yield\r\n          end\r\n        end\r\n      around_action :handle_tenant\r\n```\r\n\r\n### Expected behavior\r\nin rails 7.0.3 Rails should boot without error in production mode\r\n\r\n### Actual behavior\r\nthe rails server crash with:\r\n````\r\nSECRET_KEY_BASE=xx DEVISE_SECRET_KEY=xx RAILS_SERVE_STATIC_FILES=1 bundle exec rails server -b 0.0.0.0 -e production --log-to-stdout\r\n=> Booting Puma\r\n=> Rails 7.0.3 application starting in production\r\n=> Run `bin/rails server --help` for more startup options\r\nExiting\r\n/home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:309:in `connection_pool': ActiveRecord::ConnectionNotEstablished (ActiveRecord::ConnectionNotEstablished)\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:305:in `connection_db_config'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/activerecord-7.0.3/lib/active_record/type.rb:50:in `adapter_name_from'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/activerecord-7.0.3/lib/active_record/attributes.rb:216:in `attribute'\r\n        from /var/www/dbpresenter-test/html/app/models/cmdmary/etudprix.rb:11:in `<class:Etudprix>'\r\n        from /var/www/dbpresenter-test/html/app/models/cmdmary/etudprix.rb:5:in `<module:Cmdmary>'\r\n        from /var/www/dbpresenter-test/html/app/models/cmdmary/etudprix.rb:3:in `<main>'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/kernel.rb:27:in `require'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader/helpers.rb:127:in `const_get'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader/helpers.rb:127:in `cget'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:239:in `block (2 levels) in eager_load'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader/helpers.rb:41:in `block in ls'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader/helpers.rb:27:in `each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader/helpers.rb:27:in `ls'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:234:in `block in eager_load'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:219:in `synchronize'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:219:in `eager_load'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:318:in `each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/zeitwerk-2.6.0/lib/zeitwerk/loader.rb:318:in `eager_load_all'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/application/finisher.rb:74:in `block in <module:Finisher>'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/initializable.rb:32:in `instance_exec'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/initializable.rb:32:in `run'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:228:in `block in tsort_each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:347:in `each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:347:in `call'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:347:in `each_strongly_connected_component'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:226:in `tsort_each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/3.0.0/tsort.rb:205:in `tsort_each'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/initializable.rb:60:in `run_initializers'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/application.rb:372:in `initialize!'\r\n        from /var/www/dbpresenter-test/html/config/environment.rb:7:in `<main>'\r\n        from config.ru:5:in `require_relative'\r\n        from config.ru:5:in `block in <main>'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/builder.rb:116:in `eval'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/builder.rb:116:in `new_from_string'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/builder.rb:105:in `load_file'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/builder.rb:66:in `parse_file'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/server.rb:349:in `build_app_and_options_from_config'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/server.rb:249:in `app'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/rack-2.2.3.1/lib/rack/server.rb:422:in `wrapped_app'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/commands/server/server_command.rb:76:in `log_to_stdout'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/commands/server/server_command.rb:36:in `start'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/commands/server/server_command.rb:143:in `block in perform'\r\n        from <internal:kernel>:90:in `tap'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/commands/server/server_command.rb:134:in `perform'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/command/base.rb:87:in `perform'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/command.rb:48:in `invoke'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/railties-7.0.3/lib/rails/commands.rb:18:in `<main>'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n        from /home/serge/.rbenv/versions/3.0.4/lib/ruby/gems/3.0.0/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n        from bin/rails:4:in `<main>'\r\n````\r\n\r\n### System configuration\r\n**Rails 7.0.3**:\r\n\r\n**Ruby 3.0.4**:\r\n\r\nIn development mode it work in rails 7.0.3 ans in rails 6.1.4.4\r\nIn production mode it work in rails 6.1.4.4 and fail in rails 7.0.3\r\n\r\nwhile debuging I found this in ActiveRecord::ConnectionAdapters\r\n      def retrieve_connection_pool(owner, role: ActiveRecord::Base.current_role, shard: ActiveRecord::Base.current_shard)\r\n        pool_config = get_pool_manager(owner)&.get_pool_config(role, shard)\r\n        pool_config&.pool\r\n      end\r\n\r\nthe shard value  is :default so the result is nil\r\n\r\nThis method is used for all models at **initialization** time and the shard is not specified at this time (my code is not run)\r\nBut in 6.1.4.4 I didn't find this behavior during **initialization**\r\n\r\nzeitwerk is used in the 2 cases and it fail with or without bootsnap gem.\r\n\r\nIs this behavior normal or not ?\r\nthis should be specified in the documentation\r\n\r\nAs a workaround I modified the model abstract class:\r\n    connects_to shards: {\r\n      fr: { writing: :comdev_fr },\r\n      de: { writing: :comdev_de },\r\n      default: { writing: :comdev_fr },\r\n    }\r\nand with this it's working, but I'm not sure it's the correct solution...\r\n\r\n\r\n\r\n\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45390/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45390/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/45389","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45389/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45389/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45389/events","html_url":"https://github.com/rails/rails/issues/45389","id":1275311736,"node_id":"I_kwDNIULOTAO2eA","number":45389,"title":"updated_at is not affected by attribute changes in before_update callback","user":{"login":"etherbob","id":5025990,"node_id":"MDQ6VXNlcjUwMjU5OTA=","avatar_url":"https://avatars.githubusercontent.com/u/5025990?v=4","gravatar_id":"","url":"https://api.github.com/users/etherbob","html_url":"https://github.com/etherbob","followers_url":"https://api.github.com/users/etherbob/followers","following_url":"https://api.github.com/users/etherbob/following{/other_user}","gists_url":"https://api.github.com/users/etherbob/gists{/gist_id}","starred_url":"https://api.github.com/users/etherbob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etherbob/subscriptions","organizations_url":"https://api.github.com/users/etherbob/orgs","repos_url":"https://api.github.com/users/etherbob/repos","events_url":"https://api.github.com/users/etherbob/events{/privacy}","received_events_url":"https://api.github.com/users/etherbob/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-17T17:46:49Z","updated_at":"2022-06-17T17:46:49Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n* Modify an attribute in a before_update callback.\r\n* call save on an instance of a model with said callback\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| 'https://github.com/#{repo}.git' }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem 'activerecord', '~> 6.1.4.1'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :updaty_posts, force: true do |t|\r\n    t.string :name\r\n    t.timestamps\r\n  end\r\n\r\n  create_table :savy_posts, force: true do |t|\r\n    t.string :name\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass UpdatyPost < ActiveRecord::Base\r\n  before_update :mutate_name\r\n\r\n  private\r\n\r\n  def mutate_name\r\n    return if new_record?\r\n\r\n    self.name = 'something different'\r\n  end\r\nend\r\n\r\nclass SavyPost < ActiveRecord::Base\r\n  before_save :mutate_name\r\n\r\n  private\r\n\r\n  def mutate_name\r\n    return if new_record?\r\n\r\n    self.name = 'something different'\r\n  end\r\nend\r\n\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    upost = UpdatyPost.create!\r\n    spost = SavyPost.create!\r\n\r\n    before_upost_updated_at = upost.updated_at\r\n    before_spost_updated_at = spost.updated_at\r\n\r\n    refute_equal 'something different', spost.name\r\n    refute_equal 'something different', upost.name\r\n\r\n    sleep 2\r\n\r\n    upost.save!\r\n    spost.save!\r\n\r\n    assert_equal 'something different', spost.name\r\n    assert_equal 'something different', upost.name\r\n\r\n    refute_equal spost.updated_at, before_spost_updated_at, 'changed attribute did not change timestamps in before_save'\r\n    refute_equal upost.updated_at, before_upost_updated_at, 'changed attribute did not change timestamps in before_update'\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nBased on the warning in [the guide](https://guides.rubyonrails.org/active_record_callbacks.html#updating-an-object) \r\n\r\n> Avoid updating or saving attributes in callbacks. For example, don't call update(attribute: \"value\") within a callback. This can alter the state of the model and may result in unexpected side effects during commit. Instead, you can safely assign values directly (for example, self.attribute = \"value\") in before_create / before_update or earlier callbacks.\r\n\r\nI would expect updated_at to change when changing an attr in a before_update callback.\r\n\r\n### Actual behavior\r\nupdated_at does not change.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.1 (but tested my reproduction above in rails 7 with same result)\r\n\r\n**Ruby version**: ruby 2.7.6p219 (2022-04-12 revision c9c2245c0a) [x86_64-darwin21]\r\n(but also seen on other ruby 2.7.x versions on heroku-20 stack)\r\n\r\nNot sure if this is an actual bug or intended behavior, but I be happy to open a PR against the guides if it's the latter.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45389/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45389/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45384","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45384/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45384/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45384/events","html_url":"https://github.com/rails/rails/issues/45384","id":1274198914,"node_id":"I_kwDNIULOS_K7gg","number":45384,"title":"Confusing behavior using SQL functions (eg: pluck, count) on associations of unpersisted objects","user":{"login":"anchit-desai","id":26801391,"node_id":"MDQ6VXNlcjI2ODAxMzkx","avatar_url":"https://avatars.githubusercontent.com/u/26801391?v=4","gravatar_id":"","url":"https://api.github.com/users/anchit-desai","html_url":"https://github.com/anchit-desai","followers_url":"https://api.github.com/users/anchit-desai/followers","following_url":"https://api.github.com/users/anchit-desai/following{/other_user}","gists_url":"https://api.github.com/users/anchit-desai/gists{/gist_id}","starred_url":"https://api.github.com/users/anchit-desai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anchit-desai/subscriptions","organizations_url":"https://api.github.com/users/anchit-desai/orgs","repos_url":"https://api.github.com/users/anchit-desai/repos","events_url":"https://api.github.com/users/anchit-desai/events{/privacy}","received_events_url":"https://api.github.com/users/anchit-desai/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-16T23:18:34Z","updated_at":"2022-06-18T20:31:13Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi, this is my first time here, sorry if I make any mistakes :)\r\n\r\n### Steps to reproduce\r\nLet's say I have a model `Region` and a model `Location`. A region `has_many` locations, and a location `belongs_to` a region. Consider the following code:\r\n\r\n```ruby\r\nregion = Region.new\r\nlocation = Location.create!\r\nregion.locations = [location]\r\n```\r\nAt this point, `region` is not persisted and I understand why functions like `pluck`, `count`, and `order` (there are probably more) don't work as expected on `region.locations`.\r\n\r\n### Expected Behavior\r\nI think these functions (`count`, `pluck`, etc.) should either\r\n- give the expected value (e.g. `region.locations.count` should return `1` and `region.locations.pluck(:id)` should return `[location.id]`) OR\r\n- raise an error\r\n\r\n### Actual Behavior\r\nThe actual behavior does not seem intuitive to me.\r\n```ruby\r\nregion.locations.count # gives 0\r\nregion.locations.pluck(:id) # gives []\r\n```\r\n\r\nThanks for considering!\r\n\r\n### Reproduction script\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_count\r\n    post = Post.new\r\n    post.comments << Comment.create!\r\n\r\n    # this fails\r\n    assert_equal 1, post.comments.count\r\n  end\r\n\r\n  def test_pluck\r\n    post = Post.new\r\n    post.comments << Comment.create!\r\n\r\n    # this fails\r\n    assert_equal [Comment.first.id], post.comments.pluck(:id)\r\n  end\r\nend\r\n\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: 5.2.5\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45384/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45371","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45371/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45371/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45371/events","html_url":"https://github.com/rails/rails/issues/45371","id":1272601137,"node_id":"I_kwDNIULOS9paMQ","number":45371,"title":"Improved time field support ","user":{"login":"dssjoblom","id":12595797,"node_id":"MDQ6VXNlcjEyNTk1Nzk3","avatar_url":"https://avatars.githubusercontent.com/u/12595797?v=4","gravatar_id":"","url":"https://api.github.com/users/dssjoblom","html_url":"https://github.com/dssjoblom","followers_url":"https://api.github.com/users/dssjoblom/followers","following_url":"https://api.github.com/users/dssjoblom/following{/other_user}","gists_url":"https://api.github.com/users/dssjoblom/gists{/gist_id}","starred_url":"https://api.github.com/users/dssjoblom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dssjoblom/subscriptions","organizations_url":"https://api.github.com/users/dssjoblom/orgs","repos_url":"https://api.github.com/users/dssjoblom/repos","events_url":"https://api.github.com/users/dssjoblom/events{/privacy}","received_events_url":"https://api.github.com/users/dssjoblom/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-15T18:40:21Z","updated_at":"2022-06-30T04:33:25Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I ran into the following bug in a codebase I'm working on:\r\n\r\na) front-end validates a time input field with `Time.parse`, considering an exception a validation failure\r\nb) on success, the string value is assigned to a database field of type time\r\n\r\nThe bug here is that `Time.parse(foo_string)` and `model.time_field = foo_string` don't use the same logic for deciding what is a valid time. For example, Time.parse('11.21') is valid, but assigning '11.21' to a database field sets it to nil, while it works as expected for '11:21' or '11:21am'.\r\n\r\nObviously, the code in question makes invalid assumptions, but I think this bug would have been prevented if:\r\n\r\n1. Rails had a built-in validator for time strings that does the right thing, meaning if the validation passes, the string can be assigned to a database time field. Now people have to write their own custom validators which may or may not have bugs like this. It would also be nice if this was configurable to a degree, e.g. some applications might want just hh:mm input, while others need seconds as well.\r\n2. The valid time string format (for DB fields) was documented. In what ways is it different from Time.parse? For the record, I think Time.parse is too lax, and the database field code looks better.\r\n3. This last part I'm not sure of, but is it a good idea in general to coerce invalid assignments to nil? Wouldn't raising an exception be more appropriate?\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5.1\r\n\r\n**Ruby version**: 2.7.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45371/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45364","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45364/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45364/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45364/events","html_url":"https://github.com/rails/rails/issues/45364","id":1271900966,"node_id":"I_kwDNIULOS8-rJg","number":45364,"title":"Setting input character","user":{"login":"pr0jectorist","id":95993562,"node_id":"U_kgDOBbi-2g","avatar_url":"https://avatars.githubusercontent.com/u/95993562?v=4","gravatar_id":"","url":"https://api.github.com/users/pr0jectorist","html_url":"https://github.com/pr0jectorist","followers_url":"https://api.github.com/users/pr0jectorist/followers","following_url":"https://api.github.com/users/pr0jectorist/following{/other_user}","gists_url":"https://api.github.com/users/pr0jectorist/gists{/gist_id}","starred_url":"https://api.github.com/users/pr0jectorist/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pr0jectorist/subscriptions","organizations_url":"https://api.github.com/users/pr0jectorist/orgs","repos_url":"https://api.github.com/users/pr0jectorist/repos","events_url":"https://api.github.com/users/pr0jectorist/events{/privacy}","received_events_url":"https://api.github.com/users/pr0jectorist/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-15T08:56:48Z","updated_at":"2022-06-15T22:19:00Z","closed_at":"2022-06-15T22:18:40Z","author_association":"NONE","active_lock_reason":null,"body":"Salvete,Rubyists.\nCan I ask you question,how to set input character like...\n\n`stdin> #user's input here`\n\nThanks for all answers.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45364/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45364/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45363","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45363/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45363/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45363/events","html_url":"https://github.com/rails/rails/issues/45363","id":1271897724,"node_id":"I_kwDNIULOS8-efA","number":45363,"title":"ActionMailbox::Ingresses::Mailgun::InboundEmailsController raises ActionController::ParameterMissing: body-mime ","user":{"login":"ronald","id":69295,"node_id":"MDQ6VXNlcjY5Mjk1","avatar_url":"https://avatars.githubusercontent.com/u/69295?v=4","gravatar_id":"","url":"https://api.github.com/users/ronald","html_url":"https://github.com/ronald","followers_url":"https://api.github.com/users/ronald/followers","following_url":"https://api.github.com/users/ronald/following{/other_user}","gists_url":"https://api.github.com/users/ronald/gists{/gist_id}","starred_url":"https://api.github.com/users/ronald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ronald/subscriptions","organizations_url":"https://api.github.com/users/ronald/orgs","repos_url":"https://api.github.com/users/ronald/repos","events_url":"https://api.github.com/users/ronald/events{/privacy}","received_events_url":"https://api.github.com/users/ronald/received_events","type":"User","site_admin":false},"labels":[{"id":1174770998,"node_id":"MDU6TGFiZWwxMTc0NzcwOTk4","url":"https://api.github.com/repos/rails/rails/labels/actionmailbox","name":"actionmailbox","color":"f4a6cb","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-15T08:54:03Z","updated_at":"2022-06-17T07:25:07Z","closed_at":"2022-06-17T07:25:07Z","author_association":"NONE","active_lock_reason":null,"body":"Sorry, I don't know if this is Rails or Mailgun issue. But it happened with real mail.\r\n\r\n### Steps to reproduce\r\n* Follow guide: https://guides.rubyonrails.org/action_mailbox_basics.html#mailgun\r\n  * setup app\r\n  * setup mailgun\r\n  * setup domain / dns\r\n  * setup inbound routing in mailgun\r\n  * wait for special email (?)\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\nrequire 'bundler'\r\nBundler.configure\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"action_mailbox/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.hosts << \"www.example.com\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\n\r\n  config.action_mailbox.ingress = :mailgun\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\nrequire ActionMailbox::Engine.root.join(\"db/migrate/20180917164000_create_action_mailbox_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n  CreateActionMailboxTables.new.change\r\nend\r\n\r\nclass ApplicationMailbox < ActionMailbox::Base\r\n  routing (/^replies@/i) => :replies\r\nend\r\n\r\nclass RepliesMailbox < ActionMailbox::Base\r\n  def process\r\n    $processed = mail.subject\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass RepliesMailboxTest < ActionDispatch::IntegrationTest\r\n  test \"successful mailbox processing\" do\r\n    mailgun_data = {\r\n      \"Content-Transfer-Encoding\" => \"quoted-printable\",\r\n      \"Content-Type\" => \"text/plain; charset=UTF-8\",\r\n      \"Date\" => \"Tue, 14 Jun 2022 12:51:19 +0200\",\r\n      \"Dkim-Signature\" => \"v=1; a=rsa-sha256; c=relaxed/simple; d=gmx.net; s=badeba3b8450; t=1655203879; bh=DYmnKUrsf5NAQ+4CRIGtqAVfjOYPsxx5/GZFXbQx03Q=; h=X-UI-Sender-Class:From:To:Subject:Date:In-Reply-To:References; b=jNxvHED/i4ZCk2UzsYAEZEtUpmTXBAr58RwVvNHUL7/Rk/HwACn4MWvHlUlzEFQfe IBDua18JJ90HDlmo8ZFNVSfFK2OEKgXoLEQ/iK8C8yxMdXNEpcWx8Mdi7pvYAfVbpH 3d5Dn31l1h8/CuxZCToB/r5wkGGkyR44A/OvlSgs=\",\r\n      \"From\" => \"sender@example.com\",\r\n      \"Importance\" => \"normal\",\r\n      \"In-Reply-To\" => \"<20220613124501.a85d004da0076719@mailgun.example.com>\",\r\n      \"Message-Id\" => \"<trinity-6f85bc1e-522d-4fd7-864c-c7084c58984f-1655203879102@msvc-mesg-example120>\",\r\n      \"Mime-Version\" => \"1.0\",\r\n      \"Received\" => \"from [ip.ip.ip.ip] ([ip.ip.ip.ip]) by msvc-mesg-example101.server.lan (via HTTP); Tue, 14 Jun 2022 12:51:19 +0200\",\r\n      \"References\" => \"<20220613124501.a85d004da0076719@mailgun.example.com>\",\r\n      \"Sensitivity\" => \"Normal\",\r\n      \"Subject\" => \"Re: sample subject\",\r\n      \"To\" => \"Original Sender <original-sender@example.com>\",\r\n      \"X-Envelope-From\" => \"sender@example.com\",\r\n      \"X-Mailgun-Incoming\" => \"Yes\",\r\n      \"X-Priority\" => \"3\",\r\n      \"X-Provags-Id\" => \"V03:K1:Th/2DNln7AR4UbYKV5Strm+uGXrJk7Z3ga9jwRfOa1D7+TPiRkzqHQAC6jsaAjWUfh3vL ninoy2c+n8fjqEV9VbTQqcFTWEfNdOCgJUfyTyIPHORs/VHeQd7fei9V9eJQ5Rw45Slt6e49SW9N G4BR8TBnFXGluRW1T/5OIz8xCgQuDnsBBHlclYxNNBw4i5wmZo5qTmUip8YTAb2QPkpiyjioZGL0 /Lj+TIBhIUlOE0T1F7h9Q3Dm4n0e7MN+B5D9SUwES65xlT4Q/566ZlqzvM1m+HQTEkbB8BJOEWBG GM=\",\r\n      \"X-Spam-Flag\" => \"NO\",\r\n      \"X-Ui-Out-Filterresults\" => \"notjunk:1;V03:K0:wxZJn05k68s=:zDrMb29rwJQpShwrQsUWsG S2eomxxXAD19/Y3U2Fpi6YaUkia/B5mHjNViCo05oGKApKn+j1VevFkx0fS/3V1HHLlGLuoEX BgoE9XiLh6a6mMrePZvES1kfdID3hAtu/YsrjYw4l8xSMpoB+EnZE5NftH9IuYvemN+SEOQH+ XmpVV0i3n5u1QTx+8c7TnSHOAWhBNB3YR6ykbwvqSrhJpxubqn7Jo0EiL01SPfbKpCvpaGPh6 JJ6yPapox2ZJaCetkJgUSbjnjz7sgLO/MAKptVLRe/WRtAISW+PjWgtUjIBW6e94tayO9PHND Y6SDrBRamAGLbBvrJXzw2G52jx5IRQ71LYkIeUuuNBAUXeb+VIuu5LCF1TNbN4mAPbo9DyzBU qyvCit81umKFfL0Brdy7ilyBIRcDH0FPnfulH6/mboctjvNruYF9ijixk4QpaVEnSe6FTLGOC l+MXNQGztXgpG19a0TaUYdLr4HIF1zRe080ohK+WCELnyHU8ZvyuL6KXTO+nF03yrbSn0wkod nKPzLUdCuskLDFJy+IQ8ZUGMaZyrIrtxKb+juf6ATe/AH8Jc3y2XiPvxCTWGq3LsW+HiovT95 v1NM+KhGqtlNAPBv9lZLcD/SQd9FzXbR6cDYF1BttEpcFtslzKYxUlO9YMT4c31IPscRPepRE /A9bWr6mlVjZpYyWx4aboVk+XcmjJxgvjd9Lzm7GJVBXPu9aezH6m6eh0hYREe6qpNXfQGWD9 qxtj3xRt246s+kDQ7f5m+PT2mjgd6z4bvVqybXyS0RkTY7OToGdLRMfCyXiBFlvGtWDVLImYF u1Vg4Hs\",\r\n      \"X-Ui-Sender-Class\" => \"01bb95c1-4bf8-414a-932a-4f6e2808ef9c\",\r\n      \"action\" => \"create\",\r\n      \"body-plain\" => \"\\nLorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim.\\n\\nDonec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus.\\n\",\r\n      \"controller\" => \"action_mailbox/ingresses/mailgun/inbound_emails\",\r\n      \"domain\" => \"mailgun.example.com\",\r\n      \"from\" => \"sender@example.com\",\r\n      \"message-headers\" => \"[[\\\"Received\\\",\\\"from mout.example.com (mout.example.com [ip.ip.ip.ip]) by smtp-out-n02.prod.eu-central-1.postgun.com with SMTP id <undefined> (version=TLS1.3, cipher=TLS_AES_128_GCM_SHA256); Tue, 14 Jun 2022 10:51:19 UTC\\\"],[\\\"Received\\\",\\\"from [10.236.195.3] ([10.236.195.3]) by msvc-mesg-gmx101.server.lan (via HTTP); Tue, 14 Jun 2022 12:51:19 +0200\\\"],[\\\"X-Envelope-From\\\",\\\"ferienhaus-kleeblatt@gmx.de\\\"],[\\\"X-Mailgun-Incoming\\\",\\\"Yes\\\"],[\\\"Dkim-Signature\\\",\\\"v=1; a=rsa-sha256; c=relaxed/simple; d=gmx.net; s=badeba3b8450; t=1655203879; bh=DYmnKUrsf5NAQ+4CRIGtqAVfjOYPsxx5/GZFXbQx03Q=; h=X-UI-Sender-Class:From:To:Subject:Date:In-Reply-To:References; b=jNxvHED/i4ZCk2UzsYAEZEtUpmTXBAr58RwVvNHUL7/Rk/HwACn4MWvHlUlzEFQfe IBDua18JJ90HDlmo8ZFNVSfFK2OEKgXoLEQ/iK8C8yxMdXNEpcWx8Mdi7pvYAfVbpH 3d5Dn31l1h8/CuxZCToB/r5wkGGkyR44A/OvlSgs=\\\"],[\\\"X-Ui-Sender-Class\\\",\\\"01bb95c1-4bf8-414a-932a-4f6e2808ef9c\\\"],[\\\"Mime-Version\\\",\\\"1.0\\\"],[\\\"Message-Id\\\",\\\"<trinity-6f85bc1e-522d-4fd7-864c-c7084c58984f-1655203879102@msvc-mesg-gmx120>\\\"],[\\\"From\\\",\\\"ferienhaus-kleeblatt@gmx.de\\\"],[\\\"To\\\",\\\"\\\\\\\"Hans Dannehl via mvp.de\\\\\\\" <keineAntwortEMailAdresse@anfrage.mvp.de>\\\"],[\\\"Subject\\\",\\\"Aw: Ferienhaus Kleeblatt - Kontakt aus dem Tourismusportal www.mvp.de der MANET Marketing GmbH\\\"],[\\\"Content-Type\\\",\\\"text/plain; charset=UTF-8\\\"],[\\\"Importance\\\",\\\"normal\\\"],[\\\"Sensitivity\\\",\\\"Normal\\\"],[\\\"Content-Transfer-Encoding\\\",\\\"quoted-printable\\\"],[\\\"Date\\\",\\\"Tue, 14 Jun 2022 12:51:19 +0200\\\"],[\\\"In-Reply-To\\\",\\\"<20220613124501.a85d004da0076719@anfrage.mvp.de>\\\"],[\\\"References\\\",\\\"<20220613124501.a85d004da0076719@anfrage.mvp.de>\\\"],[\\\"X-Priority\\\",\\\"3\\\"],[\\\"X-Provags-Id\\\",\\\"V03:K1:Th/2DNln7AR4UbYKV5Strm+uGXrJk7Z3ga9jwRfOa1D7+TPiRkzqHQAC6jsaAjWUfh3vL ninoy2c+n8fjqEV9VbTQqcFTWEfNdOCgJUfyTyIPHORs/VHeQd7fei9V9eJQ5Rw45Slt6e49SW9N G4BR8TBnFXGluRW1T/5OIz8xCgQuDnsBBHlclYxNNBw4i5wmZo5qTmUip8YTAb2QPkpiyjioZGL0 /Lj+TIBhIUlOE0T1F7h9Q3Dm4n0e7MN+B5D9SUwES65xlT4Q/566ZlqzvM1m+HQTEkbB8BJOEWBG GM=\\\"],[\\\"X-Spam-Flag\\\",\\\"NO\\\"],[\\\"X-Ui-Out-Filterresults\\\",\\\"notjunk:1;V03:K0:wxZJn05k68s=:zDrMb29rwJQpShwrQsUWsG S2eomxxXAD19/Y3U2Fpi6YaUkia/B5mHjNViCo05oGKApKn+j1VevFkx0fS/3V1HHLlGLuoEX BgoE9XiLh6a6mMrePZvES1kfdID3hAtu/YsrjYw4l8xSMpoB+EnZE5NftH9IuYvemN+SEOQH+ XmpVV0i3n5u1QTx+8c7TnSHOAWhBNB3YR6ykbwvqSrhJpxubqn7Jo0EiL01SPfbKpCvpaGPh6 JJ6yPapox2ZJaCetkJgUSbjnjz7sgLO/MAKptVLRe/WRtAISW+PjWgtUjIBW6e94tayO9PHND Y6SDrBRamAGLbBvrJXzw2G52jx5IRQ71LYkIeUuuNBAUXeb+VIuu5LCF1TNbN4mAPbo9DyzBU qyvCit81umKFfL0Brdy7ilyBIRcDH0FPnfulH6/mboctjvNruYF9ijixk4QpaVEnSe6FTLGOC l+MXNQGztXgpG19a0TaUYdLr4HIF1zRe080ohK+WCELnyHU8ZvyuL6KXTO+nF03yrbSn0wkod nKPzLUdCuskLDFJy+IQ8ZUGMaZyrIrtxKb+juf6ATe/AH8Jc3y2XiPvxCTWGq3LsW+HiovT95 v1NM+KhGqtlNAPBv9lZLcD/SQd9FzXbR6cDYF1BttEpcFtslzKYxUlO9YMT4c31IPscRPepRE /A9bWr6mlVjZpYyWx4aboVk+XcmjJxgvjd9Lzm7GJVBXPu9aezH6m6eh0hYREe6qpNXfQGWD9 qxtj3xRt246s+kDQ7f5m+PT2mjgd6z4bvVqybXyS0RkTY7OToGdLRMfCyXiBFlvGtWDVLImYF u1Vg4Hs\\\"]]\",\r\n      \"message-url\" => \"https://storage.eu.mailgun.net/v3/domains/mailgun.example.com/messages/AwABBQO_ojydE8Ysn3tCf4hAJrtU6kNFRA==\",\r\n      \"recipient\" => \"original-sender@example.com\",\r\n      \"sender\" => \"sender@example.com\",\r\n      \"signature\" => \"071bb937e7d7ed057793b99815a9e01e6e68ebe9bb2369903c14fbc76922f0b9\",\r\n      \"stripped-html\" => \"\\n<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim.</p>\\n\\n<p>Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus.</p>\\n\",\r\n      \"stripped-text\" => \"\\nLorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim.\\n\\nDonec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus.\\n\",\r\n      \"subject\" => \"Re: sample subject\",\r\n      \"timestamp\" => \"1655203880\",\r\n      \"token\" => \"874f74eb9a00ecc13bcd35cd620baddda2c120a8e7880da4ac\"\r\n    }\r\n    travel_to \"Tue, 14 Jun 2022 12:51:19 +0200\"\r\n    post rails_mailgun_inbound_emails_url, params: mailgun_data\r\n    assert_response :no_content\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n* mail should get parsed and stored. returning 204\r\n\r\n### Actual behavior\r\n* 500 ActionController::ParameterMissing: param is missing or the value is empty: body-mime \r\n  in https://github.com/rails/rails/blob/v7.0.3/actionmailbox/app/controllers/action_mailbox/ingresses/mailgun/inbound_emails_controller.rb#L54\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 2.7.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45363/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45363/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45357","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45357/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45357/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45357/events","html_url":"https://github.com/rails/rails/issues/45357","id":1271185593,"node_id":"I_kwDNIULOS8TAuQ","number":45357,"title":"Active Record logger method in enum.rb is overriden by Httparty logger method","user":{"login":"maniSHarma7575","id":39980734,"node_id":"MDQ6VXNlcjM5OTgwNzM0","avatar_url":"https://avatars.githubusercontent.com/u/39980734?v=4","gravatar_id":"","url":"https://api.github.com/users/maniSHarma7575","html_url":"https://github.com/maniSHarma7575","followers_url":"https://api.github.com/users/maniSHarma7575/followers","following_url":"https://api.github.com/users/maniSHarma7575/following{/other_user}","gists_url":"https://api.github.com/users/maniSHarma7575/gists{/gist_id}","starred_url":"https://api.github.com/users/maniSHarma7575/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maniSHarma7575/subscriptions","organizations_url":"https://api.github.com/users/maniSHarma7575/orgs","repos_url":"https://api.github.com/users/maniSHarma7575/repos","events_url":"https://api.github.com/users/maniSHarma7575/events{/privacy}","received_events_url":"https://api.github.com/users/maniSHarma7575/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-06-14T18:23:25Z","updated_at":"2022-06-17T08:37:13Z","closed_at":"2022-06-16T23:57:47Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create a new rails application.\r\n```ruby\r\nrails new reproduce-behaviour-app\r\n```\r\n\r\n2. Generate Scaffold for post\r\n```ruby\r\nbin/rails generate scaffold Post name:string title:string content:text category:integer\r\n```\r\n\r\n3. Migrate database\r\n```ruby\r\nbin/rails db:migrate RAILS_ENV=development\r\n```\r\n4. Define enum category in  `post.rb`\r\n```ruby\r\n  class Post < ApplicationRecord\r\n    enum :category, [:technology, :marketing, :sales]\r\n  end\r\n```\r\n5. Modify `app/views/posts/_form.html.erb`\r\n\r\nReplace\r\n\r\n```ruby\r\n    <%= form.number_field :category %>\r\n```\r\nWith\r\n\r\n```ruby\r\n    <%= form.select :category, options_for_select(Post.categories.map {|key, value| [key.titleize, Post.categories.key(value)]}, post.category) %>\r\n```\r\n\r\n6. Create new posts by visting the url `/posts/new`\r\n\r\n7. Modify `gemfile`\r\n```ruby\r\ngem 'httparty'\r\n```\r\n\r\n8.  Do Bundle install\r\n```ruby\r\n  bundle install\r\n```\r\n9. Modify `post.rb`\r\n```ruby\r\n  class Post < ApplicationRecord\r\n    include HTTParty\r\n    enum :category, [:technology, :marketing, :sales]\r\n  end\r\n```\r\n\r\n10. visit the url `http://127.0.0.1:3000/posts/1`\r\n\r\nThe above mentioned code will give the following error :\r\n\r\n<img width=\"1440\" alt=\"Screenshot 2022-06-14 at 11 49 10 PM\" src=\"https://user-images.githubusercontent.com/39980734/173661083-d3f5c0ba-e5e9-472a-bf1f-73370913dc6c.png\">\r\n\r\n\r\n\r\n### Expected behavior\r\nLogger method should not be overriden by the Httparty logger method.\r\n\r\n### Actual behavior\r\nAnd in the rails source code, in the file lib/active_record/enum.rb:, the logger is being overridden by HTTParty's logger.\r\n```ruby\r\n\r\n     def detect_negative_enum_conditions!(method_names)\r\n        return unless logger       # problematic code, temp solution is to replace logger with ActiveRecord::Base.logger\r\n\r\n        method_names.select { |m| m.start_with?(\"not_\") }.each do |potential_not|\r\n          inverted_form = potential_not.sub(\"not_\", \"\")\r\n          if method_names.include?(inverted_form)\r\n            logger.warn \"Enum element '#{potential_not}' in #{self.name} uses the prefix 'not_'.\" \\\r\n              \" This has caused a conflict with auto generated negative scopes.\" \\\r\n              \" Avoid using enum elements starting with 'not' where the positive form is also an element.\"\r\n          end\r\n        end\r\n      end\r\n\r\nIt looks like the HTTParty's logger function defined in lib/httparty.rb:77 is overriding the rails logger.\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**:3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45357/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45357/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45350","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45350/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45350/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45350/events","html_url":"https://github.com/rails/rails/issues/45350","id":1270635538,"node_id":"I_kwDNIULOS7xcEg","number":45350,"title":"#http_basic_authenticate_with breaks in edge case with env vars","user":{"login":"MGPalmer","id":300129,"node_id":"MDQ6VXNlcjMwMDEyOQ==","avatar_url":"https://avatars.githubusercontent.com/u/300129?v=4","gravatar_id":"","url":"https://api.github.com/users/MGPalmer","html_url":"https://github.com/MGPalmer","followers_url":"https://api.github.com/users/MGPalmer/followers","following_url":"https://api.github.com/users/MGPalmer/following{/other_user}","gists_url":"https://api.github.com/users/MGPalmer/gists{/gist_id}","starred_url":"https://api.github.com/users/MGPalmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MGPalmer/subscriptions","organizations_url":"https://api.github.com/users/MGPalmer/orgs","repos_url":"https://api.github.com/users/MGPalmer/repos","events_url":"https://api.github.com/users/MGPalmer/events{/privacy}","received_events_url":"https://api.github.com/users/MGPalmer/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-14T11:07:02Z","updated_at":"2022-06-16T10:54:54Z","closed_at":"2022-06-16T10:54:54Z","author_association":"NONE","active_lock_reason":null,"body":"Hello! I've encountered an edge case with our basic auth setup after the latest Rails updade, specifically this change: https://github.com/rails/rails/commit/9ebfb149ed362697c042bb030bddcb3ba2fceb97 .\r\n\r\nAs you can see below in the script, we have a setup where basic auth is enabled via ENV variables (on staging, for example) but is also configurable on a per-controller, per-request basis in some subcontrollers.\r\n\r\nThe newly added check for the user/pass to be a String raises the exception `Expected name: to be a String, got NilClass` in some cases, like on production, as there is no user/pass. The check is good in principle but basically happening too early as it only becomes relevant in our case after the optional :if clause is applied.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get \"/\" => \"test#index\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  http_basic_authenticate_with(\r\n    name: ENV['HTTP_BASIC_AUTH_NAME'],\r\n    password: ENV['HTTP_BASIC_AUTH_PASSWORD'],\r\n    if: -> { auth_credentials_present? && !skip_http_basic_authentication? }\r\n  )\r\n\r\n  def index\r\n    render plain: \"Home\"\r\n  end\r\n\r\n  private\r\n\r\n  def auth_credentials_present?\r\n    ENV['HTTP_BASIC_AUTH_NAME'].present? && ENV['HTTP_BASIC_AUTH_PASSWORD'].present?\r\n  end\r\n\r\n  # to be overwritten in subclasses\r\n  def skip_http_basic_authentication?\r\n    false\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    get \"/\"\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45350/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45350/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45349","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45349/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45349/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45349/events","html_url":"https://github.com/rails/rails/issues/45349","id":1270582150,"node_id":"I_kwDNIULOS7uLhg","number":45349,"title":"Migration converts references and polymorphic associations from bigint to integer","user":{"login":"matteo-rossi-wise","id":60428992,"node_id":"MDQ6VXNlcjYwNDI4OTky","avatar_url":"https://avatars.githubusercontent.com/u/60428992?v=4","gravatar_id":"","url":"https://api.github.com/users/matteo-rossi-wise","html_url":"https://github.com/matteo-rossi-wise","followers_url":"https://api.github.com/users/matteo-rossi-wise/followers","following_url":"https://api.github.com/users/matteo-rossi-wise/following{/other_user}","gists_url":"https://api.github.com/users/matteo-rossi-wise/gists{/gist_id}","starred_url":"https://api.github.com/users/matteo-rossi-wise/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matteo-rossi-wise/subscriptions","organizations_url":"https://api.github.com/users/matteo-rossi-wise/orgs","repos_url":"https://api.github.com/users/matteo-rossi-wise/repos","events_url":"https://api.github.com/users/matteo-rossi-wise/events{/privacy}","received_events_url":"https://api.github.com/users/matteo-rossi-wise/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-14T10:19:03Z","updated_at":"2022-06-14T10:28:01Z","closed_at":"2022-06-14T10:28:01Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nOn Rails 6.1.6 app, when running the `bin/rails db:migrate` task, each `t.references` (included polymorphic) that were written as `bigint` in the `schema.rb` are automatically converted to `integer`. This happens for migration inheriting from `ActiveRecord::Migration[6.0]` and below, the ones who inherit from `ActiveRecord::Migration[6.1]` are not affected.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# setup a Rails 6.1.6 app\r\n# create a db migration with version [6.0] that references an attribute as foreign key\r\n# create a db migration with version [6.1] that references an attribute as foreign key\r\n# run `bin/rails db:migrate`\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nI'd expect each referenced field to have `bigint` type even for pre [6.1] migrations\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nEach previous `bigint` reference is converted to `int`\r\n\r\n### System configuration\r\n**Rails version**: 6.1.6\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45349/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45349/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45343","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45343/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45343/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45343/events","html_url":"https://github.com/rails/rails/issues/45343","id":1269670539,"node_id":"I_kwDNIULOS62iiw","number":45343,"title":"New rails projects have hello_controller.js created, despite there being no other files related to it","user":{"login":"unikitty37","id":139183,"node_id":"MDQ6VXNlcjEzOTE4Mw==","avatar_url":"https://avatars.githubusercontent.com/u/139183?v=4","gravatar_id":"","url":"https://api.github.com/users/unikitty37","html_url":"https://github.com/unikitty37","followers_url":"https://api.github.com/users/unikitty37/followers","following_url":"https://api.github.com/users/unikitty37/following{/other_user}","gists_url":"https://api.github.com/users/unikitty37/gists{/gist_id}","starred_url":"https://api.github.com/users/unikitty37/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/unikitty37/subscriptions","organizations_url":"https://api.github.com/users/unikitty37/orgs","repos_url":"https://api.github.com/users/unikitty37/repos","events_url":"https://api.github.com/users/unikitty37/events{/privacy}","received_events_url":"https://api.github.com/users/unikitty37/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-13T16:17:37Z","updated_at":"2022-08-02T10:54:25Z","closed_at":"2022-08-02T10:54:25Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```sh\r\n$ rails new testapp\r\n```\r\n\r\n(I ran this using `docker run -it --rm ruby:3.1.2 bash` to avoid any incompatibilities with my system)\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nThe Rails application is created without any superfluous files.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n`app/javascript/controllers/hello_controller.js` is created:\r\n\r\n```\r\nCreate controllers directory\r\n      create  app/javascript/controllers\r\n      create  app/javascript/controllers/index.js\r\n      create  app/javascript/controllers/application.js\r\n      create  app/javascript/controllers/hello_controller.js\r\n```\r\n\r\nNo other files relating to this controller are created, including the Rails controller itself. It looks like a bit of an example project has been included by mistake.\r\n\r\n(It's possible it's there as an example of how to write a Stimulus controller, of course, but no other parts of Rails are included this. I wonder how many projects ship with it still in there? :)\r\n\r\nI've looked through the rails/rails repo, but the only references I can find to the file are in railties/test/commands/notes_test.rb, so I can't see where it's coming from…\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45343/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45341","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45341/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45341/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45341/events","html_url":"https://github.com/rails/rails/issues/45341","id":1269654145,"node_id":"I_kwDNIULOS61igQ","number":45341,"title":"AR Relation #reset method does not correctly reset cache_version","user":{"login":"austenmadden","id":7366727,"node_id":"MDQ6VXNlcjczNjY3Mjc=","avatar_url":"https://avatars.githubusercontent.com/u/7366727?v=4","gravatar_id":"","url":"https://api.github.com/users/austenmadden","html_url":"https://github.com/austenmadden","followers_url":"https://api.github.com/users/austenmadden/followers","following_url":"https://api.github.com/users/austenmadden/following{/other_user}","gists_url":"https://api.github.com/users/austenmadden/gists{/gist_id}","starred_url":"https://api.github.com/users/austenmadden/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/austenmadden/subscriptions","organizations_url":"https://api.github.com/users/austenmadden/orgs","repos_url":"https://api.github.com/users/austenmadden/repos","events_url":"https://api.github.com/users/austenmadden/events{/privacy}","received_events_url":"https://api.github.com/users/austenmadden/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-13T16:03:32Z","updated_at":"2022-06-14T17:05:33Z","closed_at":"2022-06-14T17:05:33Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"PR with fix and test: https://github.com/rails/rails/pull/45342\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nActiveRecord::Base.collection_cache_versioning = true\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    Post.create!\r\n\r\n    posts = Post.all\r\n    cache_version = posts.cache_version\r\n\r\n    Post.update_all(updated_at: Time.now.utc + 1.second)\r\n\r\n    assert_equal cache_version, posts.cache_version # Stale cache_version\r\n    posts.reset\r\n    assert_equal Post.all.cache_version, posts.cache_version # This will fail to return the correct cache_version\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe relation object's `reset` method should appropriately clear `cache_version` state such that it returns a cache_version inline with the relation data.\r\n\r\n### Actual behavior\r\nThe `reset` method does not clear cache_version state resulting in a stale `cache_version` return value.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.1\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45341/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45341/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45340","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45340/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45340/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45340/events","html_url":"https://github.com/rails/rails/issues/45340","id":1269442052,"node_id":"I_kwDNIULOS6omBA","number":45340,"title":"Report bug template does not work","user":{"login":"morgoth","id":10766,"node_id":"MDQ6VXNlcjEwNzY2","avatar_url":"https://avatars.githubusercontent.com/u/10766?v=4","gravatar_id":"","url":"https://api.github.com/users/morgoth","html_url":"https://github.com/morgoth","followers_url":"https://api.github.com/users/morgoth/followers","following_url":"https://api.github.com/users/morgoth/following{/other_user}","gists_url":"https://api.github.com/users/morgoth/gists{/gist_id}","starred_url":"https://api.github.com/users/morgoth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morgoth/subscriptions","organizations_url":"https://api.github.com/users/morgoth/orgs","repos_url":"https://api.github.com/users/morgoth/repos","events_url":"https://api.github.com/users/morgoth/events{/privacy}","received_events_url":"https://api.github.com/users/morgoth/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-06-13T13:29:30Z","updated_at":"2022-06-14T08:14:51Z","closed_at":"2022-06-14T06:31:42Z","author_association":"MEMBER","active_lock_reason":null,"body":"I'm trying to report a bug - a different one ;-) and the bug report template does not work for me.\r\n\r\nI'm trying to run this one https://github.com/rails/rails/blob/main/guides/bug_report_templates/active_record_gem.rb\r\n\r\nand getting:\r\n```\r\nFetching gem metadata from https://rubygems.org/........\r\nResolving dependencies...\r\nUsing bundler 2.3.15\r\nbug.rb:15:in `require': cannot load such file -- active_record (LoadError)\r\n\tfrom bug.rb:15:in `<main>'\r\n```\r\n\r\n\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2p20\r\n\r\n**Bundler version**: 2.3.15\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45340/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45340/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45339","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45339/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45339/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45339/events","html_url":"https://github.com/rails/rails/issues/45339","id":1269358854,"node_id":"I_kwDNIULOS6jhBg","number":45339,"title":"Attachments in a single transaction are uploaded multiple times","user":{"login":"georgeclaghorn","id":94129,"node_id":"MDQ6VXNlcjk0MTI5","avatar_url":"https://avatars.githubusercontent.com/u/94129?v=4","gravatar_id":"","url":"https://api.github.com/users/georgeclaghorn","html_url":"https://github.com/georgeclaghorn","followers_url":"https://api.github.com/users/georgeclaghorn/followers","following_url":"https://api.github.com/users/georgeclaghorn/following{/other_user}","gists_url":"https://api.github.com/users/georgeclaghorn/gists{/gist_id}","starred_url":"https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/georgeclaghorn/subscriptions","organizations_url":"https://api.github.com/users/georgeclaghorn/orgs","repos_url":"https://api.github.com/users/georgeclaghorn/repos","events_url":"https://api.github.com/users/georgeclaghorn/events{/privacy}","received_events_url":"https://api.github.com/users/georgeclaghorn/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-13T12:23:24Z","updated_at":"2022-06-17T22:42:26Z","closed_at":"2022-06-17T22:42:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Rails: latest main (https://github.com/rails/rails/commit/34934071c61bcc89edb805ccc50430df93b96f73 currently).\r\nRuby: `ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]`.\r\n\r\nReproduction script:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", ref: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\n\r\n  config.active_storage.replace_on_assign_to_many = true\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_many_attached :files\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_upload_and_download\r\n    user = User.create! do |user|\r\n      user.files.attach \\\r\n        io: StringIO.new(\"hello\"),\r\n        content_type: \"text/plain\",\r\n        filename: \"1.txt\"\r\n\r\n      user.files.attach \\\r\n        io: StringIO.new(\"world\"),\r\n        content_type: \"text/plain\",\r\n        filename: \"2.txt\"\r\n    end\r\n\r\n    assert_equal 2, user.files.count\r\n  end\r\nend\r\n```\r\n\r\nExpected: pass.\r\n\r\nActual:\r\n\r\n```\r\nError:\r\nBugTest#test_upload_and_download:\r\nActiveStorage::IntegrityError: ActiveStorage::IntegrityError\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/service/disk_service.rb:164:in `ensure_integrity_of'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/service/disk_service.rb:22:in `block in upload'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/notifications.rb:206:in `block in instrument'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/notifications/instrumenter.rb:58:in `instrument'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/notifications.rb:206:in `instrument'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/service.rb:163:in `instrument'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/service/disk_service.rb:20:in `upload'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/app/models/active_storage/blob.rb:268:in `upload_without_unfurling'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/attached/changes/create_one.rb:28:in `upload'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/attached/changes/create_many.rb:23:in `each'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/attached/changes/create_many.rb:23:in `upload'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/core_ext/object/try.rb:15:in `public_send'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/core_ext/object/try.rb:15:in `try'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/attached/model.rb:200:in `block in has_many_attached'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:445:in `instance_exec'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:445:in `block in make_lambda'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:261:in `block in conditional'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:599:in `block in invoke_after'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:599:in `each'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:599:in `invoke_after'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:108:in `run_callbacks'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/callbacks.rb:929:in `_run_commit_callbacks'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/transactions.rb:321:in `committed!'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:177:in `commit_records'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:412:in `block in commit_transaction'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:396:in `commit_transaction'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:473:in `block in within_new_transaction'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/transaction.rb:425:in `within_new_transaction'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:316:in `transaction'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/transactions.rb:350:in `with_transaction_returning_status'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/transactions.rb:302:in `save!'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/suppressor.rb:54:in `save!'\r\n    /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activerecord/lib/active_record/persistence.rb:55:in `create!'\r\n    bug.rb:59:in `test_upload_and_download'\r\n```\r\n\r\nWith a debugger stopped at `ActiveStorage::Attached::Changes::CreateMany#upload`, `pending_uploads` contains two `ActiveStorage::Attached::Changes::CreateOneOfMany` objects for the first attachable:\r\n\r\n```\r\n[18, 27] in /Users/george/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/bundler/gems/rails-34934071c61b/activestorage/lib/active_storage/attached/changes/create_many.rb\r\n   18:     def blobs\r\n   19:       @blobs ||= subchanges.collect(&:blob)\r\n   20:     end\r\n   21: \r\n   22:     def upload\r\n=> 23:       pending_uploads.each(&:upload)\r\n   24:     end\r\n   25: \r\n   26:     def save\r\n   27:       assign_associated_attachments\r\n(byebug) pending_uploads\r\n[#<ActiveStorage::Attached::Changes::CreateOneOfMany:0x000000010b1a2e38 @attachable={:io=>#<StringIO:0x000000010b728920>, :content_type=>\"text/plain\", :filename=>\"1.txt\"}, @record=#<User id: 1>, @name=\"files\", @blob=#<ActiveStorage::Blob id: nil, key: nil, filename: \"1.txt\", content_type: \"text/plain\", metadata: {\"identified\"=>true}, service_name: \"local\", byte_size: 5, checksum: \"XUFAKrxLKna5cZ2REBfFkg==\", created_at: nil>, @attachment=#<ActiveStorage::Attachment id: nil, name: \"files\", record_type: \"User\", record_id: nil, blob_id: nil, created_at: nil>>, #<ActiveStorage::Attached::Changes::CreateOneOfMany:0x000000010ad0ff10 @attachable={:io=>#<StringIO:0x000000010b728920>, :content_type=>\"text/plain\", :filename=>\"1.txt\"}, @record=#<User id: 1>, @name=\"files\", @blob=#<ActiveStorage::Blob id: 1, key: \"w7lb7ia2gwqwwrcacww3w2q47elk\", filename: \"1.txt\", content_type: \"text/plain\", metadata: {\"identified\"=>true}, service_name: \"local\", byte_size: 5, checksum: \"XUFAKrxLKna5cZ2REBfFkg==\", created_at: \"2022-06-13 12:21:19.589382000 +0000\">, @attachment=#<ActiveStorage::Attachment id: 1, name: \"files\", record_type: \"User\", record_id: 1, blob_id: 1, created_at: \"2022-06-13 12:21:19.592854000 +0000\">>, #<ActiveStorage::Attached::Changes::CreateOneOfMany:0x000000010b910b70 @attachable={:io=>#<StringIO:0x000000010ad1f460>, :content_type=>\"text/plain\", :filename=>\"2.txt\"}, @record=#<User id: 1>, @name=\"files\", @blob=#<ActiveStorage::Blob id: 2, key: \"c2gp0zf92yt9h746mdq0ygcv7hcj\", filename: \"2.txt\", content_type: \"text/plain\", metadata: {\"identified\"=>true}, service_name: \"local\", byte_size: 5, checksum: \"fXkwN6B2AYZXSwKC8vQ15w==\", created_at: \"2022-06-13 12:21:19.597202000 +0000\">, @attachment=#<ActiveStorage::Attachment id: 2, name: \"files\", record_type: \"User\", record_id: 1, blob_id: 2, created_at: \"2022-06-13 12:21:19.599980000 +0000\">>]\r\n```\r\n\r\nThe `ActiveStorage::IntegrityError` occurs because the second attempt to upload `1.txt` reads from the end of the IO.\r\n\r\nBisects to #42300. /cc @santib @Jeremy","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45339/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45339/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45331","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45331/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45331/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45331/events","html_url":"https://github.com/rails/rails/issues/45331","id":1268331261,"node_id":"I_kwDNIULOS5ky_Q","number":45331,"title":"Problems with URL generation","user":{"login":"alec-c4","id":25312,"node_id":"MDQ6VXNlcjI1MzEy","avatar_url":"https://avatars.githubusercontent.com/u/25312?v=4","gravatar_id":"","url":"https://api.github.com/users/alec-c4","html_url":"https://github.com/alec-c4","followers_url":"https://api.github.com/users/alec-c4/followers","following_url":"https://api.github.com/users/alec-c4/following{/other_user}","gists_url":"https://api.github.com/users/alec-c4/gists{/gist_id}","starred_url":"https://api.github.com/users/alec-c4/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alec-c4/subscriptions","organizations_url":"https://api.github.com/users/alec-c4/orgs","repos_url":"https://api.github.com/users/alec-c4/repos","events_url":"https://api.github.com/users/alec-c4/events{/privacy}","received_events_url":"https://api.github.com/users/alec-c4/received_events","type":"User","site_admin":false},"labels":[{"id":35206628,"node_id":"MDU6TGFiZWwzNTIwNjYyOA==","url":"https://api.github.com/repos/rails/rails/labels/routing","name":"routing","color":"e102d8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-06-11T17:23:56Z","updated_at":"2022-06-14T01:30:49Z","closed_at":"2022-06-14T01:30:49Z","author_association":"NONE","active_lock_reason":null,"body":"Hey!\r\nIn my rails7 application, I have following code:\r\n\r\nroutes.rb\r\n```ruby\r\n    resources :animals, controller: \"customer/animals\"  do\r\n      resources :animal_documents, as: :documents,\r\n                controller: \"customer/animal_documents\", except: :show, shallow: true\r\n    end\r\n```\r\n\r\napp/views/customer/animal_documents/_form.html.erb\r\n```ruby\r\n<%= simple_form_for(@animal_document) do |f| %>\r\n  <div class=\"form-inputs\">\r\n    <%= f.input :attachment %>\r\n  </div>\r\n\r\n  <div class=\"form-actions mt-3\">\r\n    <%= f.button :submit, class: \"btn btn-primary\" %>\r\n  </div>\r\n<% end %>\r\n```\r\n\r\nWhen i create a resource - everything works fine, but when i try to edit resource - I see following error\r\n\r\n```\r\nundefined method `animal_document_path' for #<ActionView::Base:0x000000001445d8>\r\n\r\n              recipient.public_send(method, *args, options)\r\n                       ^^^^^^^^^^^^\r\nDid you mean?  animal_documents_path\r\n               animal_documents_url\r\n```\r\n\r\nMy routes looks like\r\n\r\n```\r\n                        animal_documents GET      /animals/:animal_id/animal_documents(.:format)                                                    customer/animal_documents#index\r\n                                         POST     /animals/:animal_id/animal_documents(.:format)                                                    customer/animal_documents#create\r\n                     new_animal_document GET      /animals/:animal_id/animal_documents/new(.:format)                                                customer/animal_documents#new\r\n                           edit_document GET      /animal_documents/:id/edit(.:format)                                                              customer/animal_documents#edit\r\n                                document PATCH    /animal_documents/:id(.:format)                                                                   customer/animal_documents#update\r\n                                         PUT      /animal_documents/:id(.:format)                                                                   customer/animal_documents#update\r\n                                         DELETE   /animal_documents/:id(.:format)                                                                   customer/animal_documents#destroy\r\n```\r\n\r\n\r\n```\r\n>> url_for @animal_document\r\n\r\nNoMethodError: undefined method `animal_document_path' for #<ActionView::Base:0x000000001445d8>\r\n\r\n              target.public_send(method, *args)\r\n                    ^^^^^^^^^^^^\r\nDid you mean?  animal_documents_path\r\n               animal_documents_url\r\n```\r\n\r\nHow to fix url generation? It looks like url_for does not take into account the presence of `as:` ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45331/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45331/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45323","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45323/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45323/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45323/events","html_url":"https://github.com/rails/rails/issues/45323","id":1267753757,"node_id":"I_kwDNIULOS5BjHQ","number":45323,"title":"documentation question: Active Record Query Interface","user":{"login":"jeffbuzz","id":29044811,"node_id":"MDQ6VXNlcjI5MDQ0ODEx","avatar_url":"https://avatars.githubusercontent.com/u/29044811?v=4","gravatar_id":"","url":"https://api.github.com/users/jeffbuzz","html_url":"https://github.com/jeffbuzz","followers_url":"https://api.github.com/users/jeffbuzz/followers","following_url":"https://api.github.com/users/jeffbuzz/following{/other_user}","gists_url":"https://api.github.com/users/jeffbuzz/gists{/gist_id}","starred_url":"https://api.github.com/users/jeffbuzz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeffbuzz/subscriptions","organizations_url":"https://api.github.com/users/jeffbuzz/orgs","repos_url":"https://api.github.com/users/jeffbuzz/repos","events_url":"https://api.github.com/users/jeffbuzz/events{/privacy}","received_events_url":"https://api.github.com/users/jeffbuzz/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-10T16:10:48Z","updated_at":"2022-06-14T20:05:05Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I am trying to learn Ruby active records.  Specifically how models define and/or use cross-reference tables.  The documentation (https://guides.rubyonrails.org/active_record_querying.html) visually shows a table named \"Book Orders\".  The text describes a join table named \"books_orders\".  Are those supposed to be the same thing?  If so, should they be spelled the same?  If not, how does this reference work?\r\n\r\n\r\n### Expected behavior\r\nI expected the table names to match in the documentation.\r\n\r\n### Actual behavior\r\nI see different names.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**: 7.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45323/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45323/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45321","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45321/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45321/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45321/events","html_url":"https://github.com/rails/rails/issues/45321","id":1267708026,"node_id":"I_kwDNIULOS4-weg","number":45321,"title":"Actiontext inserting `record_id`: 0 instead of real record ID","user":{"login":"markvanlan","id":16214023,"node_id":"MDQ6VXNlcjE2MjE0MDIz","avatar_url":"https://avatars.githubusercontent.com/u/16214023?v=4","gravatar_id":"","url":"https://api.github.com/users/markvanlan","html_url":"https://github.com/markvanlan","followers_url":"https://api.github.com/users/markvanlan/followers","following_url":"https://api.github.com/users/markvanlan/following{/other_user}","gists_url":"https://api.github.com/users/markvanlan/gists{/gist_id}","starred_url":"https://api.github.com/users/markvanlan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markvanlan/subscriptions","organizations_url":"https://api.github.com/users/markvanlan/orgs","repos_url":"https://api.github.com/users/markvanlan/repos","events_url":"https://api.github.com/users/markvanlan/events{/privacy}","received_events_url":"https://api.github.com/users/markvanlan/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-10T15:32:34Z","updated_at":"2022-06-13T13:28:30Z","closed_at":"2022-06-13T13:28:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I am having an issue that _looks_ like a race condition with actiontext. Actiontext is trying to create a record with the correct `record_type`, but `record_id` is _sometimes_ `0`. Other times this logic works, which is making me think race condition with saving the associated polymorphic record.\r\n\r\n### Steps to reproduce\r\n```ruby\r\nnote = Note.new(record: record, note_type: :note, submitted_by: current_user, content: params[:content])\r\nnote.save!\r\n```\r\nOr!\r\n```ruby\r\nnote = new(record: record, note_type: :note, submitted_by: current_user)\r\nnote.build_rich_text_content(body: params[:content])\r\nnote.save!\r\n```\r\nOr!\r\n```ruby\r\nnote = create!(record: record, note_type: :note, submitted_by: current_user)\r\nnote.create_rich_text_content(body: params[:content])\r\n```\r\n\r\nWhat makes me _not_ think this is a race condition issue is that even calling reload on the record before creating the rich text content, results in the same situation: `note.reload.create_rich_text_content(body: params[:content])`\r\n\r\nI then added `sleep 1` in-between creating the `note` and creating rich text. No go. I am thinking it is not a race condition; I don't see how it could be.\r\n\r\n### Expected behavior\r\nRich text is created :)\r\n\r\n### Actual behavior\r\nError! (sorry for weird blocked out stuff.. private repo)\r\n\r\n![Screen Shot 2022-06-10 at 10 18 48 AM](https://user-images.githubusercontent.com/16214023/173100362-4c60f394-bbfa-4b44-a2a7-b4da9feac60b.png)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.0.3p157\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45321/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45321/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45320","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45320/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45320/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45320/events","html_url":"https://github.com/rails/rails/issues/45320","id":1267536894,"node_id":"I_kwDNIULOS40T_g","number":45320,"title":"[Bug] ActiveRecord: Association's validations are ran only on create when assigning with *_ids=","user":{"login":"james-em","id":63726983,"node_id":"MDQ6VXNlcjYzNzI2OTgz","avatar_url":"https://avatars.githubusercontent.com/u/63726983?v=4","gravatar_id":"","url":"https://api.github.com/users/james-em","html_url":"https://github.com/james-em","followers_url":"https://api.github.com/users/james-em/followers","following_url":"https://api.github.com/users/james-em/following{/other_user}","gists_url":"https://api.github.com/users/james-em/gists{/gist_id}","starred_url":"https://api.github.com/users/james-em/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james-em/subscriptions","organizations_url":"https://api.github.com/users/james-em/orgs","repos_url":"https://api.github.com/users/james-em/repos","events_url":"https://api.github.com/users/james-em/events{/privacy}","received_events_url":"https://api.github.com/users/james-em/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-10T13:21:30Z","updated_at":"2022-06-14T17:23:29Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n**Models:**\r\n```\r\nclass User < ApplicationRecord\r\n  has_many :project_users, dependent: :destroy, inverse_of: :user\r\n  has_many :projects, through: :project_users\r\n  \r\n  validates :name, presence: true\r\nend\r\n\r\nclass Project < ApplicationRecord\r\n  has_many :project_users, dependent: :destroy\r\n  has_many :users, through: :project_users\r\nend\r\n\r\nclass ProjectUser < ApplicationRecord\r\n  belongs_to :project\r\n  belongs_to :user\r\nend\r\n```\r\n\r\n```\r\nu = User.new(\"email: \"test@example.com\", name: nil)\r\nu.valid? => false (name is nil)\r\nu.save(validate: false) => true\r\n\r\nGenerates an error:\r\nProject.create!(name: \"Test\", user_ids: [u.id])\r\n=> Exception because user is invalid\r\n\r\nThis doesn't generate an error\r\np = Project.create!(name: \"test\")\r\np.update!(user_ids: [u.id])\r\n=> true\r\n```\r\n\r\n### Expected behavior\r\n\r\nOne of these 2:\r\n1. Run validation in every case\r\n2. Never run validation\r\n\r\n\r\n### Actual behavior\r\n\r\nValidations are executed on create but not on update.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45320/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45320/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45316","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45316/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45316/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45316/events","html_url":"https://github.com/rails/rails/issues/45316","id":1267267331,"node_id":"I_kwDNIULOS4j3Aw","number":45316,"title":"undefined local variable or method `before_add_for' for Class","user":{"login":"naftis","id":1322608,"node_id":"MDQ6VXNlcjEzMjI2MDg=","avatar_url":"https://avatars.githubusercontent.com/u/1322608?v=4","gravatar_id":"","url":"https://api.github.com/users/naftis","html_url":"https://github.com/naftis","followers_url":"https://api.github.com/users/naftis/followers","following_url":"https://api.github.com/users/naftis/following{/other_user}","gists_url":"https://api.github.com/users/naftis/gists{/gist_id}","starred_url":"https://api.github.com/users/naftis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/naftis/subscriptions","organizations_url":"https://api.github.com/users/naftis/orgs","repos_url":"https://api.github.com/users/naftis/repos","events_url":"https://api.github.com/users/naftis/events{/privacy}","received_events_url":"https://api.github.com/users/naftis/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-10T09:02:47Z","updated_at":"2022-06-21T13:15:04Z","closed_at":"2022-06-21T13:15:03Z","author_association":"NONE","active_lock_reason":null,"body":"I'm updating from `7.0.0.alpha2` to `7.0.3`. I just ran the update scripts and I'm now getting \r\n```rb\r\nNameError (undefined local variable or method `before_add_for_contributors' for Question:Class):\r\napp/models/question.rb:71:in `<class:Question>'\r\napp/models/question.rb:3:in `<top (required)>'\r\n```\r\n\r\nQuestion-model configuration with contributors:\r\n```rb\r\nhas_many :contributors, through: :questions_users, source: :user\r\nbefore_add_for_contributors << ->(_method, owner, change) { owner.send(:mail_new_contributor, change) }\r\n```\r\n\r\nThe odd thing is though that if I add `before_add` to the `has_many`, the latter `before_add_for_contributors` also seems to starts working like it should:\r\n```rb\r\nhas_many :contributors, through: :questions_users, source: :user, before_add: ->(owner, change) {}\r\n```\r\n\r\nWonder what could cause this behaviour?\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3\r\n\r\n**Ruby version**:  ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [arm64-darwin20]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45316/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45316/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45311","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45311/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45311/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45311/events","html_url":"https://github.com/rails/rails/issues/45311","id":1266418897,"node_id":"I_kwDNIULOS3wE0Q","number":45311,"title":"Rails.cache.fetch unable to retrieve previous cached value if expired","user":{"login":"poloka","id":6907677,"node_id":"MDQ6VXNlcjY5MDc2Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/6907677?v=4","gravatar_id":"","url":"https://api.github.com/users/poloka","html_url":"https://github.com/poloka","followers_url":"https://api.github.com/users/poloka/followers","following_url":"https://api.github.com/users/poloka/following{/other_user}","gists_url":"https://api.github.com/users/poloka/gists{/gist_id}","starred_url":"https://api.github.com/users/poloka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/poloka/subscriptions","organizations_url":"https://api.github.com/users/poloka/orgs","repos_url":"https://api.github.com/users/poloka/repos","events_url":"https://api.github.com/users/poloka/events{/privacy}","received_events_url":"https://api.github.com/users/poloka/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2022-06-09T17:01:56Z","updated_at":"2022-06-18T06:58:54Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nkey = 'foo'\r\nargs = { expires_in: 10 }\r\nRails.cache.fetch(key, args) { 'bing' }\r\nsleep(10)\r\nentry = Rails.cache.send(:read_entry, key, args)\nbegin\r\n  Rails.cache.fetch(key, expires_in: 10) { raise 'error' }\r\nrescue StandardError\r\n  # nice to have to reset original cache value\r\n  Rails.cache.write(key, entry.value, args) if entry&.expired? # write back into the cache the original value and reset cache \r\n  entry&.value\r\nend\r\n```\r\n\r\n### Problem statement\r\nIf an unexpected error occurs within the yield block say to a service call being down for a short period, it would be nice to provide the option to retrieve the existing cached value and re inject the value back into the cache to check again when the new cache period expires.  This would allow servers to continue to function with a value rather than crashing because a consuming service went down for retrieving updates making my server more resilient to other consuming service problems. \r\n\r\n### Actual behavior\r\nIf the yield block fails, the previous cached value is deleted and no longer accessible after the fact.\r\n\r\n### Enhancement request\r\nMy suggestion is to move `read_entry` to be publicly accessible allowing consumers to first hold the previous result prior to calling the `fetch`.  If the `fetch` yields an error, the consumer can then catch their acceptable errors, determine their acceptable retries for exponential backoff, and then `write` back into the cache their wait period for attempting the 'refresh' of their cached content.  \r\n\r\n### System configuration\r\n**Rails version**:\r\n5.2 or greater\r\n**Ruby version**:\r\n2.6 or greater\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45311/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45311/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45307","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45307/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45307/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45307/events","html_url":"https://github.com/rails/rails/issues/45307","id":1266026685,"node_id":"I_kwDNIULOS3YIvQ","number":45307,"title":"Documentation issue: StiPreload causes circular dependency issues","user":{"login":"marvinthepa","id":51218,"node_id":"MDQ6VXNlcjUxMjE4","avatar_url":"https://avatars.githubusercontent.com/u/51218?v=4","gravatar_id":"","url":"https://api.github.com/users/marvinthepa","html_url":"https://github.com/marvinthepa","followers_url":"https://api.github.com/users/marvinthepa/followers","following_url":"https://api.github.com/users/marvinthepa/following{/other_user}","gists_url":"https://api.github.com/users/marvinthepa/gists{/gist_id}","starred_url":"https://api.github.com/users/marvinthepa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marvinthepa/subscriptions","organizations_url":"https://api.github.com/users/marvinthepa/orgs","repos_url":"https://api.github.com/users/marvinthepa/repos","events_url":"https://api.github.com/users/marvinthepa/events{/privacy}","received_events_url":"https://api.github.com/users/marvinthepa/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-06-09T12:01:24Z","updated_at":"2022-07-06T01:36:51Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### tl;dr\r\n\r\nThe way how to autoload as described in the  [\"Single Table Inheritance\" section in the \"Autoloading and Reloading Constants\" guide](https://guides.rubyonrails.org/autoloading_and_reloading_constants.html#single-table-inheritance) seems to be broken with Rails 7.\r\n\r\n### Steps to reproduce\r\n\r\nCheck out https://github.com/marvinthepa/sti_preload_broken. Follow the steps described in https://github.com/marvinthepa/sti_preload_broken/blob/main/README.md\r\n\r\nThis repo is a very minimal rails application that uses STI and the recommended way to load the STI hierarchy as described in https://guides.rubyonrails.org/autoloading_and_reloading_constants.html#single-table-inheritance\r\n\r\n### Expected behavior\r\n\r\nWhen loading the `Dog` STI model from the controller, the `Animal` parent model should load without error.\r\n\r\n### Actual behavior\r\n\r\nAn error is thrown.\r\n```\r\nuninitialized constant Dog\r\n```\r\n\r\nBreakdown on why this happens:\r\n\r\n1. The controller references the Dog model, which zeitwerk tries to load.\r\n2. As `Dog < Animal`, zeitwerk tries to load `Animal`\r\n3. Animal contains a `before_save` hook, which is installed, eventually leading to `ActiveSupport::Callbacks::__update_callbacks` being called.\r\n4. As of ffae3bd8d69, `__update_callbacks` calls `Animal.descendants`\r\n5. StiPreload kicks in, and finds and entry with `type == Dog` in the db, and tries to load it\r\n6. As zeitwerk is already in the process of loading `Dog`, it fails the above mentioned error message\r\n\r\nI have only found a very stupid workaround, which I do not want to keep using:\r\n\r\n```ruby\r\n      def descendants\r\n        # HACK\r\n        return super unless caller.grep(/__update_callbacks/).empty?\r\n\r\n        preload_sti unless preloaded\r\n        super   \r\n      end\r\n```\r\n\r\nMaybe there is some way to ask zeitwerk which classes it currently tries to load and skip loading those?\r\nAnyway, I think the documentation should be updated with a `StiPreload` that also works with rails 7.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.0.2p107\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45307/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45307/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45299","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45299/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45299/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45299/events","html_url":"https://github.com/rails/rails/issues/45299","id":1264710935,"node_id":"I_kwDNIULOS2H1Fw","number":45299,"title":"Migrations ignores `shared` section in database.yml","user":{"login":"jandudulski","id":153103,"node_id":"MDQ6VXNlcjE1MzEwMw==","avatar_url":"https://avatars.githubusercontent.com/u/153103?v=4","gravatar_id":"","url":"https://api.github.com/users/jandudulski","html_url":"https://github.com/jandudulski","followers_url":"https://api.github.com/users/jandudulski/followers","following_url":"https://api.github.com/users/jandudulski/following{/other_user}","gists_url":"https://api.github.com/users/jandudulski/gists{/gist_id}","starred_url":"https://api.github.com/users/jandudulski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jandudulski/subscriptions","organizations_url":"https://api.github.com/users/jandudulski/orgs","repos_url":"https://api.github.com/users/jandudulski/repos","events_url":"https://api.github.com/users/jandudulski/events{/privacy}","received_events_url":"https://api.github.com/users/jandudulski/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-06-08T13:02:02Z","updated_at":"2022-06-09T12:55:11Z","closed_at":"2022-06-09T12:52:24Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n* create a new app\r\n* add multiple databases\r\n* separate migrations for each one with `migrations_paths` config value\r\n* create migrations & run them - everything should be fine at this point\r\n* [extract migrations_paths](https://github.com/jandudulski/shared_migrations_bug/commit/c81319a75b22c287b133d7ecfa0d32799a8382b2) from each stage to `shared` section\r\n* `Rails.application.config_for(:database)` loads yaml as expected with merged values\r\n* `rails db:migrate` and `db:migrate:status` ignores shared config\r\n\r\nExample app with reproduce: https://github.com/jandudulski/shared_migrations_bug\r\n\r\n### Expected behavior\r\n\r\nUse shared section for migrations.\r\n\r\n### Actual behavior\r\n\r\nShared section is ignored.\r\n\r\n### System configuration\r\n**Rails version**: verified on 6.1 and 7.0\r\n\r\n**Ruby version**: N/A\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45299/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45299/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45296","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45296/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45296/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45296/events","html_url":"https://github.com/rails/rails/issues/45296","id":1264159077,"node_id":"I_kwDNIULOS1mJZQ","number":45296,"title":"Document ActiveSupport::MessageVerifier#generate generates non urlsafe strings","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-08T04:03:16Z","updated_at":"2022-06-22T15:12:48Z","closed_at":"2022-06-22T15:12:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It seems that `ActiveSupport::MessageVerifier#generate` generates url safe strings but is not obvious from the documentation. If it generates url safe strings, we should clarify that in the document. Thanks.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45296/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45296/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45295","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45295/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45295/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45295/events","html_url":"https://github.com/rails/rails/issues/45295","id":1264065602,"node_id":"I_kwDNIULOS1gcQg","number":45295,"title":"app:update (selecting All) results in NoMethodError on config/initializers/assets.rb:4","user":{"login":"josh-m-sharpe","id":39473,"node_id":"MDQ6VXNlcjM5NDcz","avatar_url":"https://avatars.githubusercontent.com/u/39473?v=4","gravatar_id":"","url":"https://api.github.com/users/josh-m-sharpe","html_url":"https://github.com/josh-m-sharpe","followers_url":"https://api.github.com/users/josh-m-sharpe/followers","following_url":"https://api.github.com/users/josh-m-sharpe/following{/other_user}","gists_url":"https://api.github.com/users/josh-m-sharpe/gists{/gist_id}","starred_url":"https://api.github.com/users/josh-m-sharpe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josh-m-sharpe/subscriptions","organizations_url":"https://api.github.com/users/josh-m-sharpe/orgs","repos_url":"https://api.github.com/users/josh-m-sharpe/repos","events_url":"https://api.github.com/users/josh-m-sharpe/events{/privacy}","received_events_url":"https://api.github.com/users/josh-m-sharpe/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-08T01:21:54Z","updated_at":"2022-07-06T06:34:39Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n1) rails 6.1 app\r\n2) bundle update to rails 7.0.3\r\n3) rake app:update\r\n4) select 'a' for all\r\n\r\nSo, app:update replaces `config/initializers/assets.rb`, and then it looks like `rails  active_storage:update` fails on line 4 of that file: \r\n`NoMethodError: undefined method `assets'`\r\n\r\n```\r\n√ (9:14:15 PM) ~/fin {3.0.4p208} (master) 😜 be rake app:update\r\nTop level ::CompositeIO is deprecated, require 'multipart/post' and use `Multipart::Post::CompositeReadIO` instead!\r\nTop level ::Parts is deprecated, require 'multipart/post' and use `Multipart::Post::Parts` instead!\r\n    conflict  config/boot.rb\r\nOverwrite /Users/jsharpe/fin/config/boot.rb? (enter \"h\" for help) [Ynaqdhm] a\r\n       force  config/boot.rb\r\n       exist  config\r\n    conflict  config/application.rb\r\n       force  config/application.rb\r\n   identical  config/environment.rb\r\n       exist  config/environments\r\n    conflict  config/environments/development.rb\r\n       force  config/environments/development.rb\r\n    conflict  config/environments/production.rb\r\n       force  config/environments/production.rb\r\n    conflict  config/environments/test.rb\r\n       force  config/environments/test.rb\r\n       exist  config/initializers\r\n    conflict  config/initializers/assets.rb\r\n       force  config/initializers/assets.rb\r\n    conflict  config/initializers/content_security_policy.rb\r\n       force  config/initializers/content_security_policy.rb\r\n      create  config/initializers/cors.rb\r\n    conflict  config/initializers/filter_parameter_logging.rb\r\n       force  config/initializers/filter_parameter_logging.rb\r\n    conflict  config/initializers/inflections.rb\r\n       force  config/initializers/inflections.rb\r\n      create  config/initializers/new_framework_defaults_7_0.rb\r\n   identical  config/initializers/permissions_policy.rb\r\n      remove  app/assets/stylesheets/application.css\r\n      remove  config/initializers/cors.rb\r\n       exist  bin\r\n    conflict  bin/rails\r\n       force  bin/rails\r\n   identical  bin/rake\r\n    conflict  bin/setup\r\n       force  bin/setup\r\n        gsub  db/schema.rb\r\n       rails  active_storage:update\r\nrails aborted!\r\nNoMethodError: undefined method `assets' for #<Rails::Application::Configuration:0x000000010f3869a8 @root=#<Pathname:/Users/jsharpe/fin>, @generators=#<Rails::Configuration::Generators:0x000000010922b7d0 @aliases={}, @options={:rails=>{:orm=>:active_record, :test_framework=>:test_unit, :integration_tool=>:test_unit, :system_tests=>:test_unit}, :active_record=>{:migration=>true, :timestamps=>true}, :test_unit=>{:fixture=>false, :fixture_replacement=>:factory_bot}}, @fallbacks={}, @templates=[], @colorize_logging=true, @api_only=false, @hidden_namespaces=[], @after_generate_callbacks=[]>, @middleware=#<Rails::Configuration::MiddlewareStackProxy:0x000000010f386700 @operations=[#<Proc:0x000000010f801a78 /Users/jsharpe/.rvm/gems/ruby-3.0.4@fin/gems/railties-7.0.3/lib/rails/configuration.rb:53 (lambda)>, #<Proc:0x0000000110657078 /Users/jsh\r\narpe/.rvm/gems/ruby-3.0.4@fin/gems/railties-7.0.3/lib/rails/configuration.rb:59 (lambda)>], @delete_operations=[]>, @javascript_path=\"javascript\", @encoding=#<Encoding:UTF-8>, @allow_concurrency=nil, @consider_all_requests_local=true, @filter_parameters=[], @filter_redirect=[], @helpers_paths=[\"/Users/jsharpe/fin/app/helpers\"], @hosts=[\".localhost\", #<IPAddr: IPv4:0.0.0.0/0.0.0.0>, #<IPAddr: IPv6:0000:0000:0000:0000:0000:0000:0000:0000/0000:0000:0000:0000:0000:0000:0000:0000>], @host_authorization={}, @public_file_server=#<ActiveSupport::OrderedOptions {:enabled=>true, :index_name=>\"index\"}>, @force_ssl=false, @ssl_options={:hsts=>{:subdomains=>true}}, @session_store=nil, @time_zone=\"UTC\", @beginning_of_week=:monday, @log_level=:debug, @cache_store=:null_store, @railties_order=[:all], @relative_url_root=nil, @reload_classes_only_on_ch\r\nange=true, @file_watcher=ActiveSupport::FileUpdateChecker, @exceptions_app=nil, @autoflush_log=true, @log_formatter=#<ActiveSupport::Logger::SimpleFormatter:0x000000010f39c848 @datetime_format=nil>, @eager_load=false, @secret_key_base=nil, @api_only=false, @debug_exception_response_format=nil, @x=#<Rails::Application::Configuration::Custom:0x000000010f39c7a8 @configurations={}>, @enable_dependency_loading=false, @read_encrypted_secrets=false, @content_security_policy=nil, @content_security_policy_report_only=false, @content_security_policy_nonce_generator=nil, @content_security_policy_nonce_directives=nil, @require_master_key=false, @loaded_config_version=6.0, @credentials=#<ActiveSupport::OrderedOptions {:content_path=>#<Pathname:/Users/jsharpe/fin/config/credentials.yml.enc>, :key_path=>#<Pathname:/Users/jsharpe/fin/config/mast\r\ner.key>}>, @disable_sandbox=false, @add_autoload_paths_to_load_path=true, @permissions_policy=nil, @rake_eager_load=false, @server_timing=true, @paths=#<Rails::Paths::Root:0x000000010f4d5098 @path=#<Pathname:/Users/jsharpe/fin>, @root={\"app\"=>#<Rails::Paths::Path:0x000000010f4d4eb8 @paths=[\"app\"], @current=\"app\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"{*,*/concerns}\", @exclude=[\"assets\", \"javascript\"], @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/assets\"=>#<Rails::Paths::Path:0x000000010f4d4d50 @paths=[\"app/assets\"], @current=\"app/assets\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"*\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"app/controllers\"=>#<Rails::Paths::Path:0x000000010f4d4c88 @paths=[\"app/controllers\"], @curren\r\nt=\"app/controllers\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/channels\"=>#<Rails::Paths::Path:0x000000010f4d4be8 @paths=[\"app/channels\"], @current=\"app/channels\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/helpers\"=>#<Rails::Paths::Path:0x000000010f4d4b48 @paths=[\"app/helpers\"], @current=\"app/helpers\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/models\"=>#<Rails::Paths::Path:0x000000010f4d4aa8 @paths=[\"app/models\"], @current=\"app/models\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclud\r\ne=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/mailers\"=>#<Rails::Paths::Path:0x000000010f4d4a08 @paths=[\"app/mailers\"], @current=\"app/mailers\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=true, @autoload=false, @load_path=false>, \"app/views\"=>#<Rails::Paths::Path:0x000000010f4d4968 @paths=[\"app/views\"], @current=\"app/views\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"lib\"=>#<Rails::Paths::Path:0x000000010f4d48c8 @paths=[\"lib\"], @current=\"lib\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=true>, \"lib/assets\"=>#<Rails::Paths::Path:0x\r\n000000010f4d4800 @paths=[\"lib/assets\"], @current=\"lib/assets\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"*\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"lib/tasks\"=>#<Rails::Paths::Path:0x000000010f4d4760 @paths=[\"lib/tasks\"], @current=\"lib/tasks\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"**/*.rake\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config\"=>#<Rails::Paths::Path:0x000000010f4d46e8 @paths=[\"config\"], @current=\"config\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/environments\"=>#<Rails::Paths::Path:0x000000010f4d45a8 @paths=[\"config/environments\"], @current=\"config/environments\", @root=#<Rails:\r\n:Paths::Root:0x000000010f4d5098 ...>, @glob=\"development.rb\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/initializers\"=>#<Rails::Paths::Path:0x000000010f4d4508 @paths=[\"config/initializers\"], @current=\"config/initializers\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"**/*.rb\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/locales\"=>#<Rails::Paths::Path:0x000000010f4d4468 @paths=[\"config/locales\"], @current=\"config/locales\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"**/*.{rb,yml}\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/routes.rb\"=>#<Rails::Paths::Path:0x000000010f4d43f0 @paths=[\"config/routes.rb\"], @current=\"config/routes.rb\", @root=#<Rails::Paths::R\r\noot:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/routes\"=>#<Rails::Paths::Path:0x000000010f4d4350 @paths=[\"config/routes\"], @current=\"config/routes\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"**/*.rb\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"db\"=>#<Rails::Paths::Path:0x000000010f4d42d8 @paths=[\"db\"], @current=\"db\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"db/migrate\"=>#<Rails::Paths::Path:0x000000010f4d4260 @paths=[\"db/migrate\"], @current=\"db/migrate\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=f\r\nalse, @load_path=false>, \"db/seeds.rb\"=>#<Rails::Paths::Path:0x000000010f4d41e8 @paths=[\"db/seeds.rb\"], @current=\"db/seeds.rb\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"vendor\"=>#<Rails::Paths::Path:0x000000010f4d4148 @paths=[\"vendor\"], @current=\"vendor\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=true>, \"vendor/assets\"=>#<Rails::Paths::Path:0x000000010f4d40a8 @paths=[\"vendor/assets\"], @current=\"vendor/assets\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"*\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/database\"=>#<Rails::Paths::Path:0x000000010f4d4008 @paths=[\"confi\r\ng/database.yml\"], @current=\"config/database\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/secrets\"=>#<Rails::Paths::Path:0x000000010f4ebf50 @paths=[\"config\"], @current=\"config/secrets\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=\"secrets.yml{,.enc}\", @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"config/environment\"=>#<Rails::Paths::Path:0x000000010f4ebeb0 @paths=[\"config/environment.rb\"], @current=\"config/environment\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"lib/templates\"=>#<Rails::Paths::Path:0x000000010f4ebe38 @paths=[\"lib/templates\"], @current=\"lib/templa\r\ntes\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"log\"=>#<Rails::Paths::Path:0x000000010f4ebd48 @paths=[\"log/development.log\"], @current=\"log\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"public\"=>#<Rails::Paths::Path:0x000000010f4ebcd0 @paths=[\"public\"], @current=\"public\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"public/javascripts\"=>#<Rails::Paths::Path:0x000000010f4ebc58 @paths=[\"public/javascripts\"], @current=\"public/javascripts\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autolo\r\nad_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"public/stylesheets\"=>#<Rails::Paths::Path:0x000000010f4ebbe0 @paths=[\"public/stylesheets\"], @current=\"public/stylesheets\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>, \"tmp\"=>#<Rails::Paths::Path:0x000000010f4ebb68 @paths=[\"tmp\"], @current=\"tmp\", @root=#<Rails::Paths::Root:0x000000010f4d5098 ...>, @glob=nil, @exclude=nil, @autoload_once=false, @eager_load=false, @autoload=false, @load_path=false>}>, @cache_classes=false, @autoload_paths=[], @eager_load_paths=[\"/Users/jsharpe/fin/app/channels\", \"/Users/jsharpe/fin/app/classes\", \"/Users/jsharpe/fin/app/controllers\", \"/Users/jsharpe/fin/app/controllers/concerns\", \"/Users/jsharpe/fin/app/helpers\", \"/Users/jsharpe/fin/app/jobs\", \"/Users/jsharpe/fin/app/mailers\", \"/Users/jsharpe/fin/app/models\", \"/Users/jsharpe/fin/app/models/concerns\", \"/Users/jsharpe/fin/app/sidekiq\"], @autoload_once_paths=[]>\r\nDid you mean?  asset_host\r\n/Users/jsharpe/fin/config/initializers/assets.rb:4:in `<top (required)>'\r\n/Users/jsharpe/fin/config/environment.rb:5:in `<top (required)>'\r\nTasks: TOP => active_storage:update => environment\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n```\r\nbe rails --version\r\nRails 7.0.3\r\n```\r\n\r\n**Ruby version**:\r\n```\r\nruby --version\r\nruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [arm64-darwin21]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45295/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45295/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45292","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45292/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45292/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45292/events","html_url":"https://github.com/rails/rails/issues/45292","id":1263864891,"node_id":"I_kwDNIULOS1UMOw","number":45292,"title":"link_to with \"turbo_method: :delete\" triggers DELETE request for consecutive redirect (instead of GET)","user":{"login":"stomar","id":1112299,"node_id":"MDQ6VXNlcjExMTIyOTk=","avatar_url":"https://avatars.githubusercontent.com/u/1112299?v=4","gravatar_id":"","url":"https://api.github.com/users/stomar","html_url":"https://github.com/stomar","followers_url":"https://api.github.com/users/stomar/followers","following_url":"https://api.github.com/users/stomar/following{/other_user}","gists_url":"https://api.github.com/users/stomar/gists{/gist_id}","starred_url":"https://api.github.com/users/stomar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stomar/subscriptions","organizations_url":"https://api.github.com/users/stomar/orgs","repos_url":"https://api.github.com/users/stomar/repos","events_url":"https://api.github.com/users/stomar/events{/privacy}","received_events_url":"https://api.github.com/users/stomar/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-06-07T21:04:45Z","updated_at":"2022-09-09T19:50:21Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In a nested resource scenario this might lead to unwanted deletion of the \"parent\" resource with all its dependent resources when only a dependent resource was meant to be deleted. E.g. for articles with comments, deleting a comment might cause the deletion of the relevant article (and all its other comments).\r\n\r\n### Steps to reproduce\r\n\r\nI worked through the example in the [Getting Started guide](https://guides.rubyonrails.org/getting_started.html#deleting-comments), and stumbled over a somewhat surprising behavior when deleting a comment from an article.\r\n\r\nRelevant code in `app/views/articles/show.html.erb`:\r\n\r\n```ruby\r\n  <li><%= link_to \"Destroy\", article_path(@article), data: {\r\n                      turbo_method: :delete,\r\n                      turbo_confirm: \"Are you sure?\"\r\n                    } %></li>\r\n```\r\n\r\nRelevant code in `app/controllers/comments_controller.rb`:\r\n\r\n```ruby\r\n  def destroy\r\n    @article = Article.find(params[:article_id])\r\n    @comment = @article.comments.find(params[:id])\r\n    @comment.destroy\r\n    redirect_to article_path(@article), status: :see_other  # or: status: 303\r\n  end\r\n```\r\n\r\nAt some time I omitted the explicitly given `status` option, using the following line:\r\n\r\n``` ruby\r\n    redirect_to article_path(@article)\r\n``` \r\n\r\nSimilar to other occurrences of `redirect_to` without `status` in the code examples of the Getting Started guide.\r\n\r\n### Expected behavior\r\n\r\nAfter clicking on \"Destroy\" the comment should be deleted and the article page should be displayed (regardless of the given status).\r\n\r\n### Actual behavior\r\n\r\nWithout the `status` option, the `redirect_to` triggers a DELETE request for the article instead of a GET request, thereby also **deleting the article and all its other comments** (when `has_many :comments, dependent: :destroy` is specified in the Article model), instead of only deleting the intended comment. See also the relevant lines from the log further below.\r\n\r\nI must note that I have not much experience with Rails, and know absolutely nothing about the `turbo-` stuff, but it seems to me this is a **serious problem**. If I am mistaken, then at least the guide should clearly state the **crucial importance** of using the `status: :see_other` option with the redirect in this case.\r\n\r\nExcerpt from the log:\r\n\r\n```\r\nStarted DELETE \"/articles/10/comments/18\" for ::1 at 2022-06-07 [...]\r\nProcessing by CommentsController#destroy as TURBO_STREAM\r\n[...]\r\nRedirected to http://localhost:3000/articles/10\r\nCompleted 302 Found in 23ms (ActiveRecord: 10.6ms | Allocations: 3850)\r\n\r\nStarted DELETE \"/articles/10\" for ::1 at 2022-06-07 [...]\r\nProcessing by ArticlesController#destroy as TURBO_STREAM\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: Rails 7.0.3\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45292/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45292/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45291","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45291/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45291/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45291/events","html_url":"https://github.com/rails/rails/issues/45291","id":1263861994,"node_id":"I_kwDNIULOS1UA6g","number":45291,"title":"Should ActiveRecord::Relation#null_relation? be made public?","user":{"login":"ziggythehamster","id":66674,"node_id":"MDQ6VXNlcjY2Njc0","avatar_url":"https://avatars.githubusercontent.com/u/66674?v=4","gravatar_id":"","url":"https://api.github.com/users/ziggythehamster","html_url":"https://github.com/ziggythehamster","followers_url":"https://api.github.com/users/ziggythehamster/followers","following_url":"https://api.github.com/users/ziggythehamster/following{/other_user}","gists_url":"https://api.github.com/users/ziggythehamster/gists{/gist_id}","starred_url":"https://api.github.com/users/ziggythehamster/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ziggythehamster/subscriptions","organizations_url":"https://api.github.com/users/ziggythehamster/orgs","repos_url":"https://api.github.com/users/ziggythehamster/repos","events_url":"https://api.github.com/users/ziggythehamster/events{/privacy}","received_events_url":"https://api.github.com/users/ziggythehamster/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-06-07T21:01:37Z","updated_at":"2022-06-23T00:39:37Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I will admit this is a bit of a niche use-case, but there is currently (to my knowledge, at least) no _public_ way to determine if a relation is `none?` without executing it in the case that it is not a null relation. The protected method `null_relation?` does the right thing, but it's protected, so one must use a refinement to change its visibility. You could alternatively do `.is_a?(ActiveRecord::NullRelation)` but that seems worse.\r\n\r\nMy specific use case is that I have a scope which will short-circuit by returning `none` when the argument to that scope doesn't exist in a look-up table. I don't want to expose the details of this look-up table to callers because there are multiple callers and I don't want to repeat myself.\r\n\r\nThis scope is used in a subquery, and if the scope is `none?` we can avoid running that outer query as well. The outer query is pretty complex and involves another few queries and some joins, and it will return zero rows if the inner query is `none?`. There are also a few of these outer queries.\r\n\r\nWhat we landed on is to create a refinement that implements the existing `null_relation?` method:\r\n\r\n```ruby\r\n      def null_relation?\r\n        is_a?(ActiveRecord::NullRelation)\r\n      end\r\n```\r\n\r\n...and then we short-circuit the outer query by going `return none if subquery_scope.null_relation?`. This works exactly the same as `return none if subquery_scope.none?`, except that it doesn't execute the query when it is something.\r\n\r\nThe simplest way to make this advanced usage work is to make the protected method public, but this might confuse new users who don't know what the difference is between `none?` and `null_relation?`. I don't like the idea of doing the `is_a?` check every time (because then `NullRelation` leaks into our code in more than one place). I also think that doing something like `none?(execute: false)` is potentially surprising (it returns false when it may actually still be false if you called `.none?`), but this might be a good enough compromise in the API if others feel that `null_relation?` is potentially confusing to new users.\r\n\r\nI did some searching and I didn't see any discussion on whether this should be public or not in the context of more modern versions of Rails. It seems like when this was introduced, it was a performance optimization primarily, and that's why the method was made protected, but that's about all I came across. I'm curious what others' thoughts are about this today.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45291/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45291/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45289","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45289/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45289/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45289/events","html_url":"https://github.com/rails/rails/issues/45289","id":1263794480,"node_id":"I_kwDNIULOS1P5MA","number":45289,"title":"Rails.cache uses 6.1 coder when 7.0 configuration defaults are loaded","user":{"login":"dinjas","id":15596,"node_id":"MDQ6VXNlcjE1NTk2","avatar_url":"https://avatars.githubusercontent.com/u/15596?v=4","gravatar_id":"","url":"https://api.github.com/users/dinjas","html_url":"https://github.com/dinjas","followers_url":"https://api.github.com/users/dinjas/followers","following_url":"https://api.github.com/users/dinjas/following{/other_user}","gists_url":"https://api.github.com/users/dinjas/gists{/gist_id}","starred_url":"https://api.github.com/users/dinjas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinjas/subscriptions","organizations_url":"https://api.github.com/users/dinjas/orgs","repos_url":"https://api.github.com/users/dinjas/repos","events_url":"https://api.github.com/users/dinjas/events{/privacy}","received_events_url":"https://api.github.com/users/dinjas/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-07T19:54:54Z","updated_at":"2022-06-08T18:55:16Z","closed_at":"2022-06-08T18:55:16Z","author_association":"NONE","active_lock_reason":null,"body":"Sorry I am not providing a script below - wasn't sure how to best illustrate the issue in a test given the lack of public APIs here.\r\n\r\n### Steps to reproduce\r\n\r\n1. Set `config.cache_store = :file_store, 'tmp/cache'` in environment file (eg. `config/environments/development.rb`)\r\n2. Load `bin/rails console` in 7.0.x Rails application\r\n3. Note that `Rails.cache.instance_variable_get(:@coder)` returns `ActiveSupport::Cache::Coders::Rails61Coder`\r\n4. Note that `Rails.cache.class.new('tmp/cache').instance_variable_get(:@coder)` returns `ActiveSupport::Cache::Coders::Rails70Coder`\r\n\r\nThe problem seems to be that `Rails.cache` is initialized before the app configuration is loaded. The default coder is \r\n[hardcoded to 6.1](https://github.com/rails/rails/blob/3872bc0e54d32e8bf3a6299b0bfe173d94b072fc/activesupport/lib/active_support/cache.rb#L38) but is overridden when the [app configuration is loaded](https://github.com/rails/rails/blob/ad409d5c3a7dbc1c16b5583d7fa9248099bf5360/railties/lib/rails/application/configuration.rb#L228).\r\n\r\nThis can be worked around by manually setting `ActiveSupport::Cache.format_version = 7.0` before the app is initialized, or by re-initializing `Rails.cache` after the app configuration is loaded.\r\n\r\n[The configuration docs](https://guides.rubyonrails.org/configuring.html#config-active-support-cache-format-version) seemed to indicate no special handling would be needed to use the 7.0 serializer. \r\n\r\n### Expected behavior\r\n\r\nWhen `application.rb` uses `load_defaults 7.0` and doesn't override the `cache_format_version`, `Rails.cache` should use the 7.0 cache coder.\r\n\r\n### Actual behavior\r\n\r\nWhen `application.rb` uses `load_defaults 7.0` and doesn't override the `cache_format_version`, `Rails.cache` use the 6.1 cache coder by default.\r\n\r\n### System configuration\r\n\r\nI've seen this using `FileStore` and `NullStore`, but have not looked at the behavior of the other cache store types.\r\n\r\n**Rails version**: \r\n7.0.3\r\n\r\n**Ruby version**: \r\n3.0.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45289/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45289/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45287","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45287/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45287/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45287/events","html_url":"https://github.com/rails/rails/issues/45287","id":1263510942,"node_id":"I_kwDNIULOS0-lng","number":45287,"title":"RuntimeError: can't add a new key into hash during iteration on lib/active_record/connection_adapters/abstract/query_cache.rb","user":{"login":"sobrinho","id":26460,"node_id":"MDQ6VXNlcjI2NDYw","avatar_url":"https://avatars.githubusercontent.com/u/26460?v=4","gravatar_id":"","url":"https://api.github.com/users/sobrinho","html_url":"https://github.com/sobrinho","followers_url":"https://api.github.com/users/sobrinho/followers","following_url":"https://api.github.com/users/sobrinho/following{/other_user}","gists_url":"https://api.github.com/users/sobrinho/gists{/gist_id}","starred_url":"https://api.github.com/users/sobrinho/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sobrinho/subscriptions","organizations_url":"https://api.github.com/users/sobrinho/orgs","repos_url":"https://api.github.com/users/sobrinho/repos","events_url":"https://api.github.com/users/sobrinho/events{/privacy}","received_events_url":"https://api.github.com/users/sobrinho/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-06-07T15:50:40Z","updated_at":"2022-07-12T17:09:53Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nNo idea how to reproduce.\r\n\r\n### Expected behavior\r\nNo concurrency errors in query cache.\r\n\r\n### Actual behavior\r\nA concurrency error in query cache.\r\n\r\nIt is happening inside a Sidekiq worker, FWIW.\r\n\r\nAnd it has been happening for at least a year now:\r\n\r\n<img width=\"839\" alt=\"Screen Shot 2022-06-07 at 12 46 42\" src=\"https://user-images.githubusercontent.com/26460/172424269-6e8cc3b9-b5ca-41a4-a438-5f3c03976d80.png\">\r\n\r\nHere's the backtrace:\r\n\r\n```\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/query_cache.rb:118:in `block in cache_sql'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activesupport-6.1.3.2/lib/active_support/concurrency/load_interlock_aware_monitor.rb:26:in `block (2 levels) in synchronize'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activesupport-6.1.3.2/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activesupport-6.1.3.2/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activesupport-6.1.3.2/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activesupport-6.1.3.2/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/query_cache.rb:109:in `cache_sql'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/query_cache.rb:101:in `select_all'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/querying.rb:47:in `find_by_sql'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/scout_apm-2.6.6/lib/scout_apm/instruments/active_record.rb:333:in `find_by_sql_with_scout_instruments'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/statement_cache.rb:150:in `execute'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/association.rb:227:in `find_target'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/singular_association.rb:39:in `find_target'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/association.rb:174:in `load_target'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/association.rb:67:in `reload'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/singular_association.rb:9:in `reader'\",\r\n      \"/app/vendor/cache/ruby/2.7.0/gems/activerecord-6.1.3.2/lib/active_record/associations/builder/association.rb:103:in `location'\",\r\n      \"/app/app/services/my_service.rb:9:in `initialize'\",\r\n```\r\n\r\nPseudo code from the original source code:\r\n\r\n```ruby\r\nclass MyWorker\r\n  include Sidekiq::Worker\r\n\r\n  def perform\r\n    MyModel.where('x < ?', 1.month.ago).where(a_column: A_VALUE).find_each do |my_model|\r\n      MyService.new(lead_source).something\r\n    end\r\n  end\r\nend\r\n\r\nclass MyService\r\n  def initialize(my_model)\r\n    @my_model = my_model\r\n    @something = my_model.a_standard_belongs_to_relation # error is triggered here!\r\n  end\r\n\r\n  def something\r\n    # ...\r\n  end\r\nend\r\n```\r\n\r\nThis has been reported before [here](https://github.com/rails/rails/issues/40608) but without a specific solution.\r\n\r\n`sentry-raven`, `sentry-ruby` and `activerecord-import` were mentioned but we aren't using it but we do have `prometheus_exporter`.\r\n\r\nWhat I don't get is how this error could happen considering there is a monitor around the query cache.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.3.2\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45287/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45287/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45286","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45286/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45286/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45286/events","html_url":"https://github.com/rails/rails/issues/45286","id":1263484300,"node_id":"I_kwDNIULOS089jA","number":45286,"title":"Enumerable::index_with will share the memory of the default value between keys","user":{"login":"dsusviela","id":18326941,"node_id":"MDQ6VXNlcjE4MzI2OTQx","avatar_url":"https://avatars.githubusercontent.com/u/18326941?v=4","gravatar_id":"","url":"https://api.github.com/users/dsusviela","html_url":"https://github.com/dsusviela","followers_url":"https://api.github.com/users/dsusviela/followers","following_url":"https://api.github.com/users/dsusviela/following{/other_user}","gists_url":"https://api.github.com/users/dsusviela/gists{/gist_id}","starred_url":"https://api.github.com/users/dsusviela/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dsusviela/subscriptions","organizations_url":"https://api.github.com/users/dsusviela/orgs","repos_url":"https://api.github.com/users/dsusviela/repos","events_url":"https://api.github.com/users/dsusviela/events{/privacy}","received_events_url":"https://api.github.com/users/dsusviela/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-06-07T15:30:09Z","updated_at":"2022-06-08T02:15:43Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nApologies if I'm misunderstanding the method, but AFAIK each default value should be independent.\r\n\r\nSo far as I've tested, arrays and hashes. Those are being shared. However if the value is a string, this one will not be shared.\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nThis will fail:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/enumerable\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_index_with_shared_memory\r\n    keys = [:only_i_should_change, :i_should_stay_empty]\r\n    subject = keys.index_with({})\r\n\r\n    subject[:only_i_should_change][:a_key] = \"value\"\r\n\r\n    assert subject[:only_i_should_change][:a_key] == \"value\"\r\n    assert subject[:i_should_stay_empty] == {}\r\n  end\r\nend\r\n```\r\n\r\nThis will succeed however.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/enumerable\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_index_with_shared_memory\r\n    keys = [:only_i_should_change, :i_should_stay_empty]\r\n    subject = keys.index_with(\"a_string\")\r\n\r\n    subject[:only_i_should_change] = \"value\"\r\n\r\n    assert subject[:only_i_should_change] == \"value\"\r\n    assert subject[:i_should_stay_empty] == \"a_string\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nWhen using arrays or hashes, the values should be independent. In the failed example that means that the hash under the key `:is_should_stay_empty` should be empty\r\n\r\n### Actual behavior\r\nWhen using arrays or hashes, the values are not independent. In the failed example the hash under the key `:is_should_stay_empty` is the same as `:only_i_should_change`.\r\n\r\n### System configuration\r\n**Rails version**:\r\n[v7.0.3](https://github.com/rails/rails/releases/tag/v7.0.3)\r\n\r\n**Ruby version**:\r\nRuby version 2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45286/reactions","total_count":7,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45286/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45283","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45283/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45283/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45283/events","html_url":"https://github.com/rails/rails/issues/45283","id":1262691290,"node_id":"I_kwDNIULOS0Mj2g","number":45283,"title":"Regression: Filtering a timestamp with timezone by date range","user":{"login":"DanielHeath","id":47430,"node_id":"MDQ6VXNlcjQ3NDMw","avatar_url":"https://avatars.githubusercontent.com/u/47430?v=4","gravatar_id":"","url":"https://api.github.com/users/DanielHeath","html_url":"https://github.com/DanielHeath","followers_url":"https://api.github.com/users/DanielHeath/followers","following_url":"https://api.github.com/users/DanielHeath/following{/other_user}","gists_url":"https://api.github.com/users/DanielHeath/gists{/gist_id}","starred_url":"https://api.github.com/users/DanielHeath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DanielHeath/subscriptions","organizations_url":"https://api.github.com/users/DanielHeath/orgs","repos_url":"https://api.github.com/users/DanielHeath/repos","events_url":"https://api.github.com/users/DanielHeath/events{/privacy}","received_events_url":"https://api.github.com/users/DanielHeath/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-07T04:04:04Z","updated_at":"2022-06-13T18:37:26Z","closed_at":"2022-06-13T18:37:26Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"v6.1.6\"\r\n  # gem \"rails\", github: \"rails/rails\"\r\n  gem \"pg\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"postgresql\", database: \"bugreport\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\nActiveRecord::Base.time_zone_aware_attributes = true\r\n\r\nActiveRecord::Schema.define do\r\n  connection.execute <<-SQL\r\n    DROP TABLE IF EXISTS public.courses;\r\n    CREATE TABLE public.courses (\r\n      id bigint NOT NULL,\r\n      start_date timestamp with time zone\r\n    );\r\n\r\n    CREATE SEQUENCE public.courses_id_seq\r\n      START WITH 1\r\n      INCREMENT BY 1\r\n      NO MINVALUE\r\n      NO MAXVALUE\r\n      CACHE 1;\r\n    ALTER SEQUENCE public.courses_id_seq OWNED BY public.courses.id;\r\n    ALTER TABLE ONLY public.courses ALTER COLUMN id SET DEFAULT nextval('public.courses_id_seq'::regclass);\r\n    ALTER TABLE ONLY public.courses\r\n      ADD CONSTRAINT courses_pkey PRIMARY KEY (id);\r\n  SQL\r\nend\r\n\r\nclass Course < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_matching_date_range\r\n    Course.where(start_date: 3.days.ago.to_date..1.days.ago.to_date)\r\n  end\r\nend\r\n```\r\n\r\nThis works in 6.1.6 and throws an exception in the latest rails.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45283/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45283/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45274","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45274/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45274/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45274/events","html_url":"https://github.com/rails/rails/issues/45274","id":1261946147,"node_id":"I_kwDNIULOSzfFIw","number":45274,"title":"Cyrillic","user":{"login":"CarlosCD","id":814717,"node_id":"MDQ6VXNlcjgxNDcxNw==","avatar_url":"https://avatars.githubusercontent.com/u/814717?v=4","gravatar_id":"","url":"https://api.github.com/users/CarlosCD","html_url":"https://github.com/CarlosCD","followers_url":"https://api.github.com/users/CarlosCD/followers","following_url":"https://api.github.com/users/CarlosCD/following{/other_user}","gists_url":"https://api.github.com/users/CarlosCD/gists{/gist_id}","starred_url":"https://api.github.com/users/CarlosCD/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CarlosCD/subscriptions","organizations_url":"https://api.github.com/users/CarlosCD/orgs","repos_url":"https://api.github.com/users/CarlosCD/repos","events_url":"https://api.github.com/users/CarlosCD/events{/privacy}","received_events_url":"https://api.github.com/users/CarlosCD/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-06T14:43:46Z","updated_at":"2022-06-06T14:43:55Z","closed_at":"2022-06-06T14:43:55Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45274/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45274/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45273","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45273/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45273/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45273/events","html_url":"https://github.com/rails/rails/issues/45273","id":1261676366,"node_id":"I_kwDNIULOSzOnTg","number":45273,"title":"Segmentation fault on `rails db:create`","user":{"login":"sivagollapalli","id":280199,"node_id":"MDQ6VXNlcjI4MDE5OQ==","avatar_url":"https://avatars.githubusercontent.com/u/280199?v=4","gravatar_id":"","url":"https://api.github.com/users/sivagollapalli","html_url":"https://github.com/sivagollapalli","followers_url":"https://api.github.com/users/sivagollapalli/followers","following_url":"https://api.github.com/users/sivagollapalli/following{/other_user}","gists_url":"https://api.github.com/users/sivagollapalli/gists{/gist_id}","starred_url":"https://api.github.com/users/sivagollapalli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sivagollapalli/subscriptions","organizations_url":"https://api.github.com/users/sivagollapalli/orgs","repos_url":"https://api.github.com/users/sivagollapalli/repos","events_url":"https://api.github.com/users/sivagollapalli/events{/privacy}","received_events_url":"https://api.github.com/users/sivagollapalli/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-06T10:49:18Z","updated_at":"2022-06-08T07:36:45Z","closed_at":"2022-06-06T13:31:49Z","author_association":"NONE","active_lock_reason":null,"body":"Whenever I run `bin/rails db:create` it gives the following segmentation fault error. I am using Postgres 14.1 with rails `6.0.5`\r\n\r\n[segmentation.log](https://github.com/rails/rails/files/8843819/segmentation.log)\r\n\r\nHere is the Gemfile.lock\r\n\r\n```\r\nGIT\r\n  remote: https://github.com/faker-ruby/faker.git\r\n  revision: 7846d10edaa0786a7b7df707533dbc7e995d3299\r\n  branch: master\r\n  specs:\r\n    faker (2.21.0)\r\n      i18n (>= 1.8.11, < 2)\r\n\r\nGEM\r\n  remote: https://rubygems.org/\r\n  specs:\r\n    actioncable (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      nio4r (~> 2.0)\r\n      websocket-driver (>= 0.6.1)\r\n    actionmailbox (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      activejob (= 6.0.5)\r\n      activerecord (= 6.0.5)\r\n      activestorage (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n      mail (>= 2.7.1)\r\n    actionmailer (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      actionview (= 6.0.5)\r\n      activejob (= 6.0.5)\r\n      mail (~> 2.5, >= 2.5.4)\r\n      rails-dom-testing (~> 2.0)\r\n    actionpack (6.0.5)\r\n      actionview (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n      rack (~> 2.0, >= 2.0.8)\r\n      rack-test (>= 0.6.3)\r\n      rails-dom-testing (~> 2.0)\r\n      rails-html-sanitizer (~> 1.0, >= 1.2.0)\r\n    actiontext (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      activerecord (= 6.0.5)\r\n      activestorage (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n      nokogiri (>= 1.8.5)\r\n    actionview (6.0.5)\r\n      activesupport (= 6.0.5)\r\n      builder (~> 3.1)\r\n      erubi (~> 1.4)\r\n      rails-dom-testing (~> 2.0)\r\n      rails-html-sanitizer (~> 1.1, >= 1.2.0)\r\n    activejob (6.0.5)\r\n      activesupport (= 6.0.5)\r\n      globalid (>= 0.3.6)\r\n    activemodel (6.0.5)\r\n      activesupport (= 6.0.5)\r\n    activerecord (6.0.5)\r\n      activemodel (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n    activestorage (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      activejob (= 6.0.5)\r\n      activerecord (= 6.0.5)\r\n      marcel (~> 1.0)\r\n    activesupport (6.0.5)\r\n      concurrent-ruby (~> 1.0, >= 1.0.2)\r\n      i18n (>= 0.7, < 2)\r\n      minitest (~> 5.1)\r\n      tzinfo (~> 1.1)\r\n      zeitwerk (~> 2.2, >= 2.2.2)\r\n    addressable (2.8.0)\r\n      public_suffix (>= 2.0.2, < 5.0)\r\n    ast (2.4.2)\r\n    autoprefixer-rails (10.4.7.0)\r\n      execjs (~> 2)\r\n    aws-eventstream (1.2.0)\r\n    aws-partitions (1.591.0)\r\n    aws-sdk-cloudfront (1.65.0)\r\n      aws-sdk-core (~> 3, >= 3.127.0)\r\n      aws-sigv4 (~> 1.1)\r\n    aws-sdk-core (3.131.1)\r\n      aws-eventstream (~> 1, >= 1.0.2)\r\n      aws-partitions (~> 1, >= 1.525.0)\r\n      aws-sigv4 (~> 1.1)\r\n      jmespath (~> 1, >= 1.6.1)\r\n    aws-sdk-kms (1.57.0)\r\n      aws-sdk-core (~> 3, >= 3.127.0)\r\n      aws-sigv4 (~> 1.1)\r\n    aws-sdk-s3 (1.114.0)\r\n      aws-sdk-core (~> 3, >= 3.127.0)\r\n      aws-sdk-kms (~> 1)\r\n      aws-sigv4 (~> 1.4)\r\n    aws-sdk-sns (1.21.0)\r\n      aws-sdk-core (~> 3, >= 3.71.0)\r\n      aws-sigv4 (~> 1.1)\r\n    aws-sdk-sqs (1.23.1)\r\n      aws-sdk-core (~> 3, >= 3.71.0)\r\n      aws-sigv4 (~> 1.1)\r\n    aws-sigv4 (1.5.0)\r\n      aws-eventstream (~> 1, >= 1.0.2)\r\n    bcrypt (3.1.18)\r\n    bindex (0.8.1)\r\n    bootsnap (1.11.1)\r\n      msgpack (~> 1.2)\r\n    bootstrap (5.1.3)\r\n      autoprefixer-rails (>= 9.1.0)\r\n      popper_js (>= 2.9.3, < 3)\r\n      sassc-rails (>= 2.0.0)\r\n    bootstrap5-kaminari-views (0.0.1)\r\n      kaminari (>= 0.13)\r\n      rails (>= 3.1)\r\n    bugsnag (6.24.2)\r\n      concurrent-ruby (~> 1.0)\r\n    builder (3.2.4)\r\n    bullet (6.1.0)\r\n      activesupport (>= 3.0.0)\r\n      uniform_notifier (~> 1.11)\r\n    carrierwave (2.2.2)\r\n      activemodel (>= 5.0.0)\r\n      activesupport (>= 5.0.0)\r\n      addressable (~> 2.6)\r\n      image_processing (~> 1.1)\r\n      marcel (~> 1.0.0)\r\n      mini_mime (>= 0.1.3)\r\n      ssrf_filter (~> 1.0)\r\n    carrierwave-aws (1.5.0)\r\n      aws-sdk-s3 (~> 1.0)\r\n      carrierwave (~> 2.0)\r\n    chronic (0.10.2)\r\n    chronic_duration (0.10.6)\r\n      numerizer (~> 0.1.1)\r\n    coderay (1.1.3)\r\n    concurrent-ruby (1.1.10)\r\n    connection_pool (2.2.5)\r\n    crass (1.0.6)\r\n    elasticsearch (7.13.3)\r\n      elasticsearch-api (= 7.13.3)\r\n      elasticsearch-transport (= 7.13.3)\r\n    elasticsearch-api (7.13.3)\r\n      multi_json\r\n    elasticsearch-transport (7.13.3)\r\n      faraday (~> 1)\r\n      multi_json\r\n    erubi (1.10.0)\r\n    erubis (2.7.0)\r\n    execjs (2.8.1)\r\n    faraday (1.10.0)\r\n      faraday-em_http (~> 1.0)\r\n      faraday-em_synchrony (~> 1.0)\r\n      faraday-excon (~> 1.1)\r\n      faraday-httpclient (~> 1.0)\r\n      faraday-multipart (~> 1.0)\r\n      faraday-net_http (~> 1.0)\r\n      faraday-net_http_persistent (~> 1.0)\r\n      faraday-patron (~> 1.0)\r\n      faraday-rack (~> 1.0)\r\n      faraday-retry (~> 1.0)\r\n      ruby2_keywords (>= 0.0.4)\r\n    faraday-em_http (1.0.0)\r\n    faraday-em_synchrony (1.0.0)\r\n    faraday-excon (1.1.0)\r\n    faraday-httpclient (1.0.1)\r\n    faraday-multipart (1.0.3)\r\n      multipart-post (>= 1.2, < 3)\r\n    faraday-net_http (1.0.1)\r\n    faraday-net_http_persistent (1.2.0)\r\n    faraday-patron (1.0.0)\r\n    faraday-rack (1.0.0)\r\n    faraday-retry (1.0.3)\r\n    faraday_middleware-aws-sigv4 (0.6.1)\r\n      aws-sigv4 (~> 1.0)\r\n      faraday (>= 1.8, < 2)\r\n    fast_jsonapi (1.5)\r\n      activesupport (>= 4.2)\r\n    ffi (1.15.5)\r\n    geocoder (1.6.7)\r\n    globalid (1.0.0)\r\n      activesupport (>= 5.0)\r\n    groupdate (5.0.0)\r\n      activesupport (>= 5)\r\n    haml (5.2.2)\r\n      temple (>= 0.8.0)\r\n      tilt\r\n    haml-rails (2.0.1)\r\n      actionpack (>= 5.1)\r\n      activesupport (>= 5.1)\r\n      haml (>= 4.0.6, < 6.0)\r\n      html2haml (>= 1.0.1)\r\n      railties (>= 5.1)\r\n    hashie (5.0.0)\r\n    html2haml (2.2.0)\r\n      erubis (~> 2.7.0)\r\n      haml (>= 4.0, < 6)\r\n      nokogiri (>= 1.6.0)\r\n      ruby_parser (~> 3.5)\r\n    i18n (1.10.0)\r\n      concurrent-ruby (~> 1.0)\r\n    image_processing (1.12.2)\r\n      mini_magick (>= 4.9.5, < 5)\r\n      ruby-vips (>= 2.0.17, < 3)\r\n    jmespath (1.6.1)\r\n    jquery-rails (4.5.0)\r\n      rails-dom-testing (>= 1, < 3)\r\n      railties (>= 4.2.0)\r\n      thor (>= 0.14, < 2.0)\r\n    jwt (2.2.1)\r\n    kaminari (1.2.0)\r\n      activesupport (>= 4.1.0)\r\n      kaminari-actionview (= 1.2.0)\r\n      kaminari-activerecord (= 1.2.0)\r\n      kaminari-core (= 1.2.0)\r\n    kaminari-actionview (1.2.0)\r\n      actionview\r\n      kaminari-core (= 1.2.0)\r\n    kaminari-activerecord (1.2.0)\r\n      activerecord\r\n      kaminari-core (= 1.2.0)\r\n    kaminari-core (1.2.0)\r\n    libv8-node (16.10.0.0)\r\n    libv8-node (16.10.0.0-aarch64-linux)\r\n    libv8-node (16.10.0.0-x86_64-darwin-19)\r\n    libv8-node (16.10.0.0-x86_64-linux)\r\n    listen (3.1.5)\r\n      rb-fsevent (~> 0.9, >= 0.9.4)\r\n      rb-inotify (~> 0.9, >= 0.9.7)\r\n      ruby_dep (~> 1.2)\r\n    loofah (2.18.0)\r\n      crass (~> 1.0.2)\r\n      nokogiri (>= 1.5.9)\r\n    mail (2.7.1)\r\n      mini_mime (>= 0.1.1)\r\n    marcel (1.0.2)\r\n    method_source (1.0.0)\r\n    mini_magick (4.10.1)\r\n    mini_mime (1.1.2)\r\n    mini_portile2 (2.8.0)\r\n    mini_racer (0.6.2)\r\n      libv8-node (~> 16.10.0.0)\r\n    minitest (5.15.0)\r\n    msgpack (1.5.1)\r\n    multi_json (1.15.0)\r\n    multipart-post (2.1.1)\r\n    nio4r (2.5.8)\r\n    nokogiri (1.13.6)\r\n      mini_portile2 (~> 2.8.0)\r\n      racc (~> 1.4)\r\n    nokogiri (1.13.6-aarch64-linux)\r\n      racc (~> 1.4)\r\n    nokogiri (1.13.6-x86_64-darwin)\r\n      racc (~> 1.4)\r\n    nokogiri (1.13.6-x86_64-linux)\r\n      racc (~> 1.4)\r\n    numerizer (0.1.1)\r\n    parallel (1.22.1)\r\n    parser (3.1.2.0)\r\n      ast (~> 2.4.1)\r\n    pg (1.3.5)\r\n    popper_js (2.9.3)\r\n    pry (0.14.1)\r\n      coderay (~> 1.1)\r\n      method_source (~> 1.0)\r\n    pry-nav (1.0.0)\r\n      pry (>= 0.9.10, < 0.15)\r\n    public_suffix (4.0.7)\r\n    puma (4.3.12)\r\n      nio4r (~> 2.0)\r\n    racc (1.6.0)\r\n    rack (2.2.3)\r\n    rack-test (1.1.0)\r\n      rack (>= 1.0, < 3)\r\n    rails (6.0.5)\r\n      actioncable (= 6.0.5)\r\n      actionmailbox (= 6.0.5)\r\n      actionmailer (= 6.0.5)\r\n      actionpack (= 6.0.5)\r\n      actiontext (= 6.0.5)\r\n      actionview (= 6.0.5)\r\n      activejob (= 6.0.5)\r\n      activemodel (= 6.0.5)\r\n      activerecord (= 6.0.5)\r\n      activestorage (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n      bundler (>= 1.3.0)\r\n      railties (= 6.0.5)\r\n      sprockets-rails (>= 2.0.0)\r\n    rails-dom-testing (2.0.3)\r\n      activesupport (>= 4.2.0)\r\n      nokogiri (>= 1.6)\r\n    rails-html-sanitizer (1.4.2)\r\n      loofah (~> 2.3)\r\n    railties (6.0.5)\r\n      actionpack (= 6.0.5)\r\n      activesupport (= 6.0.5)\r\n      method_source\r\n      rake (>= 0.8.7)\r\n      thor (>= 0.20.3, < 2.0)\r\n    rainbow (3.1.1)\r\n    rake (13.0.6)\r\n    rb-fsevent (0.11.1)\r\n    rb-inotify (0.10.1)\r\n      ffi (~> 1.0)\r\n    redis (4.6.0)\r\n    redis-actionpack (5.3.0)\r\n      actionpack (>= 5, < 8)\r\n      redis-rack (>= 2.1.0, < 3)\r\n      redis-store (>= 1.1.0, < 2)\r\n    redis-activesupport (5.3.0)\r\n      activesupport (>= 3, < 8)\r\n      redis-store (>= 1.3, < 2)\r\n    redis-namespace (1.8.2)\r\n      redis (>= 3.0.4)\r\n    redis-rack (2.1.4)\r\n      rack (>= 2.0.8, < 3)\r\n      redis-store (>= 1.2, < 2)\r\n    redis-rails (5.0.2)\r\n      redis-actionpack (>= 5.0, < 6)\r\n      redis-activesupport (>= 5.0, < 6)\r\n      redis-store (>= 1.2, < 2)\r\n    redis-store (1.9.1)\r\n      redis (>= 4, < 5)\r\n    regexp_parser (2.4.0)\r\n    rexml (3.2.5)\r\n    rubocop (1.29.1)\r\n      parallel (~> 1.10)\r\n      parser (>= 3.1.0.0)\r\n      rainbow (>= 2.2.2, < 4.0)\r\n      regexp_parser (>= 1.8, < 3.0)\r\n      rexml (>= 3.2.5, < 4.0)\r\n      rubocop-ast (>= 1.17.0, < 2.0)\r\n      ruby-progressbar (~> 1.7)\r\n      unicode-display_width (>= 1.4.0, < 3.0)\r\n    rubocop-ast (1.18.0)\r\n      parser (>= 3.1.1.0)\r\n    rubocop-performance (1.14.0)\r\n      rubocop (>= 1.7.0, < 2.0)\r\n      rubocop-ast (>= 0.4.0)\r\n    rubocop-rails (2.14.2)\r\n      activesupport (>= 4.2.0)\r\n      rack (>= 1.1)\r\n      rubocop (>= 1.7.0, < 2.0)\r\n    ruby-progressbar (1.11.0)\r\n    ruby-vips (2.1.4)\r\n      ffi (~> 1.12)\r\n    ruby2_keywords (0.0.5)\r\n    ruby_dep (1.5.0)\r\n    ruby_parser (3.19.1)\r\n      sexp_processor (~> 4.16)\r\n    sass-rails (6.0.0)\r\n      sassc-rails (~> 2.1, >= 2.1.1)\r\n    sassc (2.4.0)\r\n      ffi (~> 1.9)\r\n    sassc-rails (2.1.2)\r\n      railties (>= 4.0.0)\r\n      sassc (>= 2.0)\r\n      sprockets (> 3.0)\r\n      sprockets-rails\r\n      tilt\r\n    searchkick (4.6.3)\r\n      activemodel (>= 5)\r\n      elasticsearch (>= 6, < 7.14)\r\n      hashie\r\n    sexp_processor (4.16.1)\r\n    sidekiq (6.4.2)\r\n      connection_pool (>= 2.2.2)\r\n      rack (~> 2.0)\r\n      redis (>= 4.2.0)\r\n    sidekiq-limit_fetch (3.4.0)\r\n      sidekiq (>= 4)\r\n    sidekiq-status (1.1.4)\r\n      chronic_duration\r\n      sidekiq (>= 3.0)\r\n    simple_form (5.0.2)\r\n      actionpack (>= 5.0)\r\n      activemodel (>= 5.0)\r\n    skylight (4.3.2)\r\n      skylight-core (= 4.3.2)\r\n    skylight-core (4.3.2)\r\n      activesupport (>= 4.2.0)\r\n    sprockets (4.0.3)\r\n      concurrent-ruby (~> 1.0)\r\n      rack (> 1, < 3)\r\n    sprockets-rails (3.4.2)\r\n      actionpack (>= 5.2)\r\n      activesupport (>= 5.2)\r\n      sprockets (>= 3.0.0)\r\n    ssrf_filter (1.0.7)\r\n    stripe (5.22.0)\r\n    temple (0.8.2)\r\n    thor (1.2.1)\r\n    thread_safe (0.3.6)\r\n    tilt (2.0.10)\r\n    turbolinks (5.2.1)\r\n      turbolinks-source (~> 5.2)\r\n    turbolinks-source (5.2.0)\r\n    tzinfo (1.2.9)\r\n      thread_safe (~> 0.1)\r\n    uglifier (4.2.0)\r\n      execjs (>= 0.3.0, < 3)\r\n    uncouple (0.2.2)\r\n    unicode-display_width (2.1.0)\r\n    uniform_notifier (1.16.0)\r\n    versionist (2.0.1)\r\n      activesupport (>= 3)\r\n      railties (>= 3)\r\n      yard (~> 0.9.20)\r\n    web-console (4.2.0)\r\n      actionview (>= 6.0.0)\r\n      activemodel (>= 6.0.0)\r\n      bindex (>= 0.4.0)\r\n      railties (>= 6.0.0)\r\n    webrick (1.7.0)\r\n    websocket-driver (0.7.5)\r\n      websocket-extensions (>= 0.1.0)\r\n    websocket-extensions (0.1.5)\r\n    whenever (1.0.0)\r\n      chronic (>= 0.6.3)\r\n    yard (0.9.27)\r\n      webrick (~> 1.7.0)\r\n    zeitwerk (2.5.4)\r\n\r\nPLATFORMS\r\n  aarch64-linux\r\n  ruby\r\n  x86_64-darwin-19\r\n  x86_64-linux\r\n\r\nDEPENDENCIES\r\n  aws-sdk-cloudfront (~> 1.32)\r\n  aws-sdk-sns (= 1.21.0)\r\n  aws-sdk-sqs (= 1.23.1)\r\n  bcrypt (~> 3.1, >= 3.1.13)\r\n  bootsnap (>= 1.1.0)\r\n  bootstrap (~> 5.1.3)\r\n  bootstrap5-kaminari-views\r\n  bugsnag (~> 6.13)\r\n  bullet (= 6.1.0)\r\n  carrierwave-aws (~> 1.4)\r\n  faker!\r\n  faraday_middleware-aws-sigv4\r\n  fast_jsonapi (~> 1.5)\r\n  geocoder (~> 1.6.3)\r\n  groupdate (= 5.0.0)\r\n  haml-rails (~> 2.0, >= 2.0.1)\r\n  jquery-rails\r\n  jwt (= 2.2.1)\r\n  kaminari\r\n  libv8-node (= 16.10.0.0)\r\n  listen (>= 3.0.5, < 3.2)\r\n  mini_magick (= 4.10.1)\r\n  mini_racer (~> 0.6.2)\r\n  pg (>= 0.18, < 2.0)\r\n  pry\r\n  pry-nav\r\n  puma (~> 4.1)\r\n  rails (~> 6.0.2, >= 6.0.2.1)\r\n  redis (~> 4.1)\r\n  redis-namespace (~> 1.7)\r\n  redis-rails (~> 5.0, >= 5.0.2)\r\n  rubocop-performance\r\n  rubocop-rails\r\n  sass-rails (>= 6)\r\n  searchkick (~> 4.6.3)\r\n  sidekiq (~> 6.0, >= 6.0.7)\r\n  sidekiq-limit_fetch (~> 3.4)\r\n  sidekiq-status (= 1.1.4)\r\n  simple_form (= 5.0.2)\r\n  skylight (~> 4.2)\r\n  sprockets-rails\r\n  stripe (= 5.22.0)\r\n  turbolinks (~> 5)\r\n  tzinfo-data\r\n  uglifier (>= 1.3.0)\r\n  uncouple\r\n  versionist (~> 2.0)\r\n  web-console (>= 3.3.0)\r\n  whenever (~> 1.0)\r\n\r\nRUBY VERSION\r\n   ruby 2.7.6p219\r\n\r\nBUNDLED WITH\r\n   2.3.15\r\n\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45273/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45273/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45270","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45270/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45270/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45270/events","html_url":"https://github.com/rails/rails/issues/45270","id":1261435005,"node_id":"I_kwDNIULOSy_4fQ","number":45270,"title":"Regression: Setting datetime inside Time#use_zone does not work","user":{"login":"DanielHeath","id":47430,"node_id":"MDQ6VXNlcjQ3NDMw","avatar_url":"https://avatars.githubusercontent.com/u/47430?v=4","gravatar_id":"","url":"https://api.github.com/users/DanielHeath","html_url":"https://github.com/DanielHeath","followers_url":"https://api.github.com/users/DanielHeath/followers","following_url":"https://api.github.com/users/DanielHeath/following{/other_user}","gists_url":"https://api.github.com/users/DanielHeath/gists{/gist_id}","starred_url":"https://api.github.com/users/DanielHeath/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DanielHeath/subscriptions","organizations_url":"https://api.github.com/users/DanielHeath/orgs","repos_url":"https://api.github.com/users/DanielHeath/repos","events_url":"https://api.github.com/users/DanielHeath/events{/privacy}","received_events_url":"https://api.github.com/users/DanielHeath/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-06-06T06:59:53Z","updated_at":"2022-07-10T23:23:04Z","closed_at":"2022-07-10T23:23:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.datetime :publish_after\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    Time.use_zone(\"Perth\") do\r\n      post.publish_after = '2015-03-02 09:00:00.000000000 +0000'\r\n    end\r\n\r\n    assert_equal \"2015-03-02 09:00:00 AWST\", post.publish_after.to_s\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe timezone specified (Perth) is used\r\n\r\n### Actual behavior\r\n\r\nThe timezone used is UTC\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\n`rails 7.1.0.alpha (was 6.1.6) from https://github.com/rails/rails.git (at main@e494efd)`\r\n\r\n\r\n**Ruby version**:\r\n`ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45270/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45270/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45269","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45269/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45269/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45269/events","html_url":"https://github.com/rails/rails/issues/45269","id":1261067077,"node_id":"I_kwDNIULOSypbRQ","number":45269,"title":"`rails new` reports files that are not actually created","user":{"login":"kazzix14","id":29710855,"node_id":"MDQ6VXNlcjI5NzEwODU1","avatar_url":"https://avatars.githubusercontent.com/u/29710855?v=4","gravatar_id":"","url":"https://api.github.com/users/kazzix14","html_url":"https://github.com/kazzix14","followers_url":"https://api.github.com/users/kazzix14/followers","following_url":"https://api.github.com/users/kazzix14/following{/other_user}","gists_url":"https://api.github.com/users/kazzix14/gists{/gist_id}","starred_url":"https://api.github.com/users/kazzix14/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kazzix14/subscriptions","organizations_url":"https://api.github.com/users/kazzix14/orgs","repos_url":"https://api.github.com/users/kazzix14/repos","events_url":"https://api.github.com/users/kazzix14/events{/privacy}","received_events_url":"https://api.github.com/users/kazzix14/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-06-05T14:46:28Z","updated_at":"2022-06-26T04:15:06Z","closed_at":"2022-06-26T04:15:06Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrails new . --database=postgresql --no-skip-git --no-skip-keeps --no-skip-action-mailer --skip-mailbox --skip-action-text --no-skip-active-record --skip-active-job --no-skip-active-storage --skip-action-cable --skip-asset-pipeline --skip-javascript --skip-hotwire --skip-jbuilder --skip-test --skip-system-test --no-skip-bootsnap --api --skip-bundle --force --pretend\r\n```\r\n\r\n### Expected behavior\r\nit prints only files that are going to be created.\r\n\r\n### Actual behavior\r\nIt prints files that are not going to be created as I passing `--skip-*` parameters.  \r\nWhen I remove `--pretend` from my options, it prints the same thing although it does not create those files actually.\r\n\r\n```\r\n       force  README.md\r\n      create  Rakefile\r\n      create  .ruby-version\r\n      create  config.ru\r\n       force  .gitignore\r\n      create  .gitattributes\r\n       force  Gemfile\r\n         run  git init from \".\"\r\nReinitialized existing Git repository in /usr/local/app/.git/\r\n      create  app\r\n      create  app/assets/config/manifest.js\r\n      create  app/assets/stylesheets/application.css\r\n      create  app/channels/application_cable/channel.rb\r\n      create  app/channels/application_cable/connection.rb\r\n      create  app/controllers/application_controller.rb\r\n      create  app/helpers/application_helper.rb\r\n      create  app/jobs/application_job.rb\r\n      create  app/mailers/application_mailer.rb\r\n      create  app/models/application_record.rb\r\n      create  app/views/layouts/application.html.erb\r\n      create  app/views/layouts/mailer.html.erb\r\n      create  app/views/layouts/mailer.text.erb\r\n      create  app/assets/images\r\n      create  app/assets/images/.keep\r\n      create  app/controllers/concerns/.keep\r\n      create  app/models/concerns/.keep\r\n      create  bin\r\n      create  bin/rails\r\n      create  bin/rake\r\n      create  bin/setup\r\n      create  config\r\n      create  config/routes.rb\r\n      create  config/application.rb\r\n      create  config/environment.rb\r\n      create  config/puma.rb\r\n      create  config/storage.yml\r\n      create  config/environments\r\n      create  config/environments/development.rb\r\n      create  config/environments/production.rb\r\n      create  config/environments/test.rb\r\n      create  config/initializers\r\n      create  config/initializers/assets.rb\r\n      create  config/initializers/content_security_policy.rb\r\n      create  config/initializers/cors.rb\r\n      create  config/initializers/filter_parameter_logging.rb\r\n      create  config/initializers/inflections.rb\r\n      create  config/initializers/new_framework_defaults_7_0.rb\r\n      create  config/initializers/permissions_policy.rb\r\n      create  config/locales\r\n      create  config/locales/en.yml\r\n      create  config/master.key\r\n      append  .gitignore\r\n      create  config/boot.rb\r\n      create  config/database.yml\r\n      create  db\r\n      create  db/seeds.rb\r\n      create  lib\r\n      create  lib/tasks\r\n      create  lib/tasks/.keep\r\n      create  lib/assets\r\n      create  lib/assets/.keep\r\n      create  log\r\n      create  log/.keep\r\n       exist  public\r\n   identical  public/404.html\r\n   identical  public/422.html\r\n   identical  public/500.html\r\n   identical  public/apple-touch-icon-precomposed.png\r\n   identical  public/apple-touch-icon.png\r\n   identical  public/favicon.ico\r\n   identical  public/robots.txt\r\n      create  tmp\r\n      create  tmp/.keep\r\n      create  tmp/pids\r\n      create  tmp/pids/.keep\r\n      create  tmp/cache\r\n      create  tmp/cache/assets\r\n       exist  vendor\r\n   identical  vendor/.keep\r\n      create  storage\r\n      create  storage/.keep\r\n      create  tmp/storage\r\n      create  tmp/storage/.keep\r\n      remove  app/assets\r\n      remove  lib/assets\r\n      remove  tmp/cache/assets\r\n      remove  app/helpers\r\n      remove  test/helpers\r\n      remove  app/views/layouts/application.html.erb\r\n      remove  public/404.html\r\n      remove  public/422.html\r\n      remove  public/500.html\r\n      remove  public/apple-touch-icon-precomposed.png\r\n      remove  public/apple-touch-icon.png\r\n      remove  public/favicon.ico\r\n      remove  config/initializers/assets.rb\r\n      remove  app/assets/config/manifest.js\r\n      remove  app/assets/config\r\n      remove  app/assets/stylesheets/application.css\r\n      remove  app/jobs\r\n      remove  app/javascript/channels\r\n      remove  app/channels\r\n      remove  test/channels\r\n      remove  config/initializers/content_security_policy.rb\r\n      remove  config/initializers/permissions_policy.rb\r\n      remove  config/initializers/new_framework_defaults_7_0.rb\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n```\r\n> rails version\r\nRails 7.0.2.4\r\n```\r\n**Ruby version**:\r\n```\r\n> ruby -v\r\nruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45269/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45269/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45267","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45267/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45267/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45267/events","html_url":"https://github.com/rails/rails/issues/45267","id":1260861350,"node_id":"I_kwDNIULOSyc3pg","number":45267,"title":"Rails.cache.read() is not working as expected in Rails 7.0.3","user":{"login":"AfolabiOlaoluwa","id":15254043,"node_id":"MDQ6VXNlcjE1MjU0MDQz","avatar_url":"https://avatars.githubusercontent.com/u/15254043?v=4","gravatar_id":"","url":"https://api.github.com/users/AfolabiOlaoluwa","html_url":"https://github.com/AfolabiOlaoluwa","followers_url":"https://api.github.com/users/AfolabiOlaoluwa/followers","following_url":"https://api.github.com/users/AfolabiOlaoluwa/following{/other_user}","gists_url":"https://api.github.com/users/AfolabiOlaoluwa/gists{/gist_id}","starred_url":"https://api.github.com/users/AfolabiOlaoluwa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AfolabiOlaoluwa/subscriptions","organizations_url":"https://api.github.com/users/AfolabiOlaoluwa/orgs","repos_url":"https://api.github.com/users/AfolabiOlaoluwa/repos","events_url":"https://api.github.com/users/AfolabiOlaoluwa/events{/privacy}","received_events_url":"https://api.github.com/users/AfolabiOlaoluwa/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-04T18:18:50Z","updated_at":"2022-06-13T18:47:29Z","closed_at":"2022-06-13T18:47:29Z","author_association":"NONE","active_lock_reason":null,"body":"Is there anything I am missing? Rails.cache.read() is not behaving as expected. Is there any configurations I need to do?\r\n### Steps to reproduce\r\n\r\n```ruby\r\nrails c\r\nRails.cache.write(\"my-cache-key\", 123)\r\n=> true\r\n```\r\n\r\n### Expected behavior\r\n```ruby\r\nRails.cache.read(\"my-cache-key\")\r\n=> 123\r\n```\r\n\r\n### Actual behavior\r\n```ruby\r\nRails.cache.read(\"my-cache-key\")\r\n=> nil\r\n```\r\n\r\n### System configuration\r\n**Rails 7.0.3**\r\n\r\n**Ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-darwin20]**:\r\n\r\n### Image\r\n<img width=\"448\" alt=\"Screenshot 2022-06-04 at 19 00 07\" src=\"https://user-images.githubusercontent.com/15254043/172020488-b7046c36-baf4-4848-8910-454514f27ad3.png\">\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45267/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45267/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45263","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45263/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45263/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45263/events","html_url":"https://github.com/rails/rails/issues/45263","id":1260427172,"node_id":"I_kwDNIULOSyCXpA","number":45263,"title":"ActiveSupport: MessageEncryptor rotation fails to decrypt 'nil' values","user":{"login":"sbosio","id":1291288,"node_id":"MDQ6VXNlcjEyOTEyODg=","avatar_url":"https://avatars.githubusercontent.com/u/1291288?v=4","gravatar_id":"","url":"https://api.github.com/users/sbosio","html_url":"https://github.com/sbosio","followers_url":"https://api.github.com/users/sbosio/followers","following_url":"https://api.github.com/users/sbosio/following{/other_user}","gists_url":"https://api.github.com/users/sbosio/gists{/gist_id}","starred_url":"https://api.github.com/users/sbosio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbosio/subscriptions","organizations_url":"https://api.github.com/users/sbosio/orgs","repos_url":"https://api.github.com/users/sbosio/repos","events_url":"https://api.github.com/users/sbosio/events{/privacy}","received_events_url":"https://api.github.com/users/sbosio/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-03T22:01:05Z","updated_at":"2022-09-09T18:50:21Z","closed_at":"2022-09-09T18:50:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nCreate two instances of MessageEncryptor. The first one with only an old secret and the second one with a new secret. Add to the second one another rotation with the old secret (this is a standard scenario when rotating secrets).\r\n\r\nThe second encryptor will be able to decrypt any data encrypted with the old secret, except for `nil` values, where it will raise an exception.\r\n\r\n#### Test case\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activesupport\", \"7.0.3\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    old_secret = SecureRandom.base64(24)\r\n    old_encryptor = ActiveSupport::MessageEncryptor.new old_secret\r\n\r\n    current_secret = SecureRandom.base64(24)\r\n    current_encryptor = ActiveSupport::MessageEncryptor.new current_secret\r\n    current_encryptor.rotate old_secret\r\n\r\n    # Old encryptor roundtrips a 'nil' value correctly\r\n    assert_nil old_encryptor.decrypt_and_verify(old_encryptor.encrypt_and_sign(nil))\r\n\r\n    # New encryptor roundtrips a 'nil' value correctly\r\n    assert_nil current_encryptor.decrypt_and_verify(current_encryptor.encrypt_and_sign(nil))\r\n\r\n    # Old encryptor cannot decrypt data encrypted with the current secret\r\n    assert_raises(ActiveSupport::MessageVerifier::InvalidSignature) do\r\n      old_encryptor.decrypt_and_verify(current_encryptor.encrypt_and_sign(\"test\"))\r\n    end\r\n\r\n    # New encryptor correctly decrypts data encrypted with the old secret (being rotated)\r\n    assert_equal \"test\", current_encryptor.decrypt_and_verify(old_encryptor.encrypt_and_sign(\"test\"))\r\n\r\n    # New encryptor should be able to decrypt a 'nil' value encrypted with the old secret --THIS FAILS--\r\n    assert_nil current_encryptor.decrypt_and_verify(old_encryptor.encrypt_and_sign(nil))\r\n  end\r\nend\r\n```\r\n\r\n#### Possible root cause\r\nThe [method `verified`](https://github.com/rails/rails/blob/3872bc0e54d32e8bf3a6299b0bfe173d94b072fc/activesupport/lib/active_support/message_verifier.rb#L152) of MessageVerifier uses the special value `nil` to signal some error conditions to the caller, but `nil` is also a valid message itself, so the [`verify` method](https://github.com/rails/rails/blob/3872bc0e54d32e8bf3a6299b0bfe173d94b072fc/activesupport/lib/active_support/message_verifier.rb#L177) interprets this as a failure and raises.\r\n\r\n### Expected behavior\r\nA `nil` value encrypted with an old secret should be correctly decrypted as `nil` by an encryptor that has the old secret available as a rotation.\r\n\r\n### Actual behavior\r\nAn `ActiveSupport::MessageVerifier::InvalidSignature` exception is raised.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45263/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45263/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45261","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45261/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45261/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45261/events","html_url":"https://github.com/rails/rails/issues/45261","id":1260189224,"node_id":"I_kwDNIULOSxz2KA","number":45261,"title":"KeyError: Missing configuration for the s3 Active Storage service","user":{"login":"rohandey","id":126836,"node_id":"MDQ6VXNlcjEyNjgzNg==","avatar_url":"https://avatars.githubusercontent.com/u/126836?v=4","gravatar_id":"","url":"https://api.github.com/users/rohandey","html_url":"https://github.com/rohandey","followers_url":"https://api.github.com/users/rohandey/followers","following_url":"https://api.github.com/users/rohandey/following{/other_user}","gists_url":"https://api.github.com/users/rohandey/gists{/gist_id}","starred_url":"https://api.github.com/users/rohandey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rohandey/subscriptions","organizations_url":"https://api.github.com/users/rohandey/orgs","repos_url":"https://api.github.com/users/rohandey/repos","events_url":"https://api.github.com/users/rohandey/events{/privacy}","received_events_url":"https://api.github.com/users/rohandey/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-03T17:51:39Z","updated_at":"2022-06-03T18:27:17Z","closed_at":"2022-06-03T18:27:17Z","author_association":"NONE","active_lock_reason":null,"body":"We have upgraded our rails 6 app to rails 7 and now in the process of migration paperclip to activestorage.\r\n\r\nstorage.yml \r\n```ruby\r\ncustom_storage:\r\n  service: Disk\r\n  root: <%= Rails.root.join(\"tmp/storage\") %>\r\n```\r\n\r\nIn development.rb\r\n```ruby\r\nconfig.active_storage.service = :custom_storage\r\n```\r\n\r\nmodel has this: \r\n```ruby\r\n has_one_attached :asset\r\n```\r\n\r\nWhen we run model_obj.asset.url it throws this error \r\n\r\nKeyError: Missing configuration for the s3 Active Storage service. Configurations available for the custom_storage services.\r\n\r\nNot sure from where we get this s3 KeyError\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n \r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45261/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45261/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45254","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45254/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45254/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45254/events","html_url":"https://github.com/rails/rails/issues/45254","id":1259834554,"node_id":"I_kwDNIULOSxeMug","number":45254,"title":"Customize Generator Docs Missing Links","user":{"login":"philippneugebauer","id":1623885,"node_id":"MDQ6VXNlcjE2MjM4ODU=","avatar_url":"https://avatars.githubusercontent.com/u/1623885?v=4","gravatar_id":"","url":"https://api.github.com/users/philippneugebauer","html_url":"https://github.com/philippneugebauer","followers_url":"https://api.github.com/users/philippneugebauer/followers","following_url":"https://api.github.com/users/philippneugebauer/following{/other_user}","gists_url":"https://api.github.com/users/philippneugebauer/gists{/gist_id}","starred_url":"https://api.github.com/users/philippneugebauer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/philippneugebauer/subscriptions","organizations_url":"https://api.github.com/users/philippneugebauer/orgs","repos_url":"https://api.github.com/users/philippneugebauer/repos","events_url":"https://api.github.com/users/philippneugebauer/events{/privacy}","received_events_url":"https://api.github.com/users/philippneugebauer/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-03T12:08:04Z","updated_at":"2022-06-17T17:50:51Z","closed_at":"2022-06-17T17:50:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"from: https://guides.rubyonrails.org/v7.0/generators.html#customizing-your-workflow-by-changing-generators-templates\r\n> If you generate another resource, you can see that we get exactly the same result! This is useful if you want to customize your scaffold templates and/or layout by just creating edit.html.erb, index.html.erb and so on inside lib/templates/erb/scaffold.\r\n\r\nI wonder why we don't have some kind of links to the [current files](https://github.com/rails/rails/tree/5257da7bb543e2b5a51da72a3e4bb77bf96eaefc/railties/lib/rails/generators/erb/scaffold/templates) here so you can easily customize based on them? I was searching for some while and just found it after searching for \"display: block\" in the rails repository.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45254/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45254/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45253","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45253/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45253/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45253/events","html_url":"https://github.com/rails/rails/issues/45253","id":1259602962,"node_id":"I_kwDNIULOSxQEEg","number":45253,"title":"ActiveSupport::ParameterFilter in config/initializers/**.rb cause NameError: uninitialized constant ActiveSupport::ParameterFilter in Rails7, but not cause in Rails6","user":{"login":"hamilton-keisuke","id":79962363,"node_id":"MDQ6VXNlcjc5OTYyMzYz","avatar_url":"https://avatars.githubusercontent.com/u/79962363?v=4","gravatar_id":"","url":"https://api.github.com/users/hamilton-keisuke","html_url":"https://github.com/hamilton-keisuke","followers_url":"https://api.github.com/users/hamilton-keisuke/followers","following_url":"https://api.github.com/users/hamilton-keisuke/following{/other_user}","gists_url":"https://api.github.com/users/hamilton-keisuke/gists{/gist_id}","starred_url":"https://api.github.com/users/hamilton-keisuke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hamilton-keisuke/subscriptions","organizations_url":"https://api.github.com/users/hamilton-keisuke/orgs","repos_url":"https://api.github.com/users/hamilton-keisuke/repos","events_url":"https://api.github.com/users/hamilton-keisuke/events{/privacy}","received_events_url":"https://api.github.com/users/hamilton-keisuke/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-03T08:13:53Z","updated_at":"2022-06-29T18:42:56Z","closed_at":"2022-06-29T18:42:56Z","author_association":"NONE","active_lock_reason":null,"body":"Excuse me. I'm sorry for your busy schedule. \r\nThere is a problem that I just don't understand.\r\n\r\nMy rails project is using Sentry.\r\n\r\nI am using `ActiveSupport::ParameterFilter` in `config/initializers/sentry.rb` as shown below.\r\n\r\nhttps://docs.sentry.io/platforms/ruby/guides/rails/configuration/filtering/#using-platformidentifier-namebefore-send-\r\n\r\nIn my project, I'm working on updating from rails v6 to v7.\r\nWhen I ran the `$ rspec`, I didn't get any error in v6, but when I updated v7, I got the following error.\r\n(RSpec and Sentry versions are not updated.)\r\n\r\n```\r\nAn error occurred while loading ./spec/helpers/posts_helper_spec.rb.\r\nFailure/Error: require_relative '../config/environment'\r\n\r\nNameError:\r\n  uninitialized constant ActiveSupport::ParameterFilter\r\n# ./config/initializers/content_security_policy.rb:6:in `<main>'\r\n# /usr/local/bundle/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:39:in `load'\r\n# /usr/local/bundle/gems/bootsnap-1.12.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:39:in `load'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/engine.rb:667:in `block in load_config_initializer'\r\n# /usr/local/bundle/gems/activesupport-7.0.3/lib/active_support/notifications.rb:208:in `instrument'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/engine.rb:666:in `load_config_initializer'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/engine.rb:620:in `block (2 levels) in <class:Engine>'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/engine.rb:619:in `each'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/engine.rb:619:in `block in <class:Engine>'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:32:in `instance_exec'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:32:in `run'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:50:in `each'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:50:in `tsort_each_child'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/initializable.rb:60:in `run_initializers'\r\n# /usr/local/bundle/gems/railties-7.0.3/lib/rails/application.rb:372:in `initialize!'\r\n# ./config/environment.rb:5:in `<top (required)>'\r\n# ./spec/rails_helper.rb:4:in `require_relative'\r\n# ./spec/rails_helper.rb:4:in `<top (required)>'\r\n# ./spec/helpers/posts_helper_spec.rb:1:in `<top (required)>'\r\n```\r\n\r\nI know that adding `require active_support/parameter_filter` doesn't cause this errors, but I don't understand why this happens.\r\n\r\nCound you please tell me why the error did not occur in Rails6 and the error occurred in Rails7.\r\n\r\n### Steps to reproduce\r\n\r\nIt reproduce in my sample repository below.\r\n(Sentry is not included for simplicity.)\r\n\r\nhttps://github.com/hamilton-keisuke/activesupport_parameter_filter_probrem_sample\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3\r\n(no error happen in 6.1.6)\r\n\r\n**Ruby version**:\r\n3.0.1\r\n\r\n**rspec-rails**\r\n5.1.2\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45253/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45253/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45248","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45248/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45248/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45248/events","html_url":"https://github.com/rails/rails/issues/45248","id":1258587892,"node_id":"I_kwDNIULOSwSG9A","number":45248,"title":"Datetime end_of_day.strftime(\"%Q\") to return time in milliseconds just returns string \"%Q\"","user":{"login":"rodrigogaldino553","id":63233782,"node_id":"MDQ6VXNlcjYzMjMzNzgy","avatar_url":"https://avatars.githubusercontent.com/u/63233782?v=4","gravatar_id":"","url":"https://api.github.com/users/rodrigogaldino553","html_url":"https://github.com/rodrigogaldino553","followers_url":"https://api.github.com/users/rodrigogaldino553/followers","following_url":"https://api.github.com/users/rodrigogaldino553/following{/other_user}","gists_url":"https://api.github.com/users/rodrigogaldino553/gists{/gist_id}","starred_url":"https://api.github.com/users/rodrigogaldino553/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rodrigogaldino553/subscriptions","organizations_url":"https://api.github.com/users/rodrigogaldino553/orgs","repos_url":"https://api.github.com/users/rodrigogaldino553/repos","events_url":"https://api.github.com/users/rodrigogaldino553/events{/privacy}","received_events_url":"https://api.github.com/users/rodrigogaldino553/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-06-02T19:17:09Z","updated_at":"2022-06-02T21:39:18Z","closed_at":"2022-06-02T21:39:18Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhen type DateTime.yesterday.end_of_day.strftime(\"%Q\") it just returns \"%Q\" instead of correct milliseconds\r\nobs: period could be yesterday, tomorrow... it happens with the others periods too\r\n\r\n![image](https://user-images.githubusercontent.com/63233782/171719559-6999f1a8-81d8-4d78-85f3-d23e0d04e4a3.png)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45248/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45248/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45239","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45239/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45239/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45239/events","html_url":"https://github.com/rails/rails/issues/45239","id":1256522560,"node_id":"I_kwDNIULOSuUDQA","number":45239,"title":"Inconsistent method signature","user":{"login":"chbach","id":1646184,"node_id":"MDQ6VXNlcjE2NDYxODQ=","avatar_url":"https://avatars.githubusercontent.com/u/1646184?v=4","gravatar_id":"","url":"https://api.github.com/users/chbach","html_url":"https://github.com/chbach","followers_url":"https://api.github.com/users/chbach/followers","following_url":"https://api.github.com/users/chbach/following{/other_user}","gists_url":"https://api.github.com/users/chbach/gists{/gist_id}","starred_url":"https://api.github.com/users/chbach/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chbach/subscriptions","organizations_url":"https://api.github.com/users/chbach/orgs","repos_url":"https://api.github.com/users/chbach/repos","events_url":"https://api.github.com/users/chbach/events{/privacy}","received_events_url":"https://api.github.com/users/chbach/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-01T17:08:04Z","updated_at":"2022-06-13T18:33:17Z","closed_at":"2022-06-13T18:33:17Z","author_association":"NONE","active_lock_reason":null,"body":"https://github.com/rails/rails/blob/920fcce54c9e112dc724d587e58182c5603de2d0/activesupport/lib/active_support/cache/strategy/local_cache.rb#L75\r\n\r\nShouldn’t this be `options = nil` like in every other Cache/Store in ActiveSupport?\r\nThis leads to `ArgumentError (wrong number of arguments (given 1, expected 0))` when passed `nil`, which can happen if the Store is abstracted and duck-typed with the original method definition `def clear(options = nil)`. E.g. it would crash in the RedisStore, if the LocalCache strategy is used, but would run fine otherwise. Even the internal LocalCache has a different signature. ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45239/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45239/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45238","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45238/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45238/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45238/events","html_url":"https://github.com/rails/rails/issues/45238","id":1256279341,"node_id":"I_kwDNIULOSuFNLQ","number":45238,"title":"Multiple fileupload error: Invalid request parameters: expected Array (got String) for param","user":{"login":"zebleck","id":10833180,"node_id":"MDQ6VXNlcjEwODMzMTgw","avatar_url":"https://avatars.githubusercontent.com/u/10833180?v=4","gravatar_id":"","url":"https://api.github.com/users/zebleck","html_url":"https://github.com/zebleck","followers_url":"https://api.github.com/users/zebleck/followers","following_url":"https://api.github.com/users/zebleck/following{/other_user}","gists_url":"https://api.github.com/users/zebleck/gists{/gist_id}","starred_url":"https://api.github.com/users/zebleck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zebleck/subscriptions","organizations_url":"https://api.github.com/users/zebleck/orgs","repos_url":"https://api.github.com/users/zebleck/repos","events_url":"https://api.github.com/users/zebleck/events{/privacy}","received_events_url":"https://api.github.com/users/zebleck/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-01T15:24:09Z","updated_at":"2022-06-23T11:30:37Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate a form with file_field to upload multiple files.\r\n\r\n`\r\n<%= form_with model: submission do |f| %>\r\n<%= f.file_field :manuscript,\r\n                         class: 'form-control-file',\r\n                         id: 'upload-userManuscript',\r\n                         multiple: true,\r\n                         accept: assignment.accepted_for_file_input %>\r\n<% end %>\r\n`\r\n\r\nTry to submit this form after selecting a file. Instead of just submitting the file as parameter, there will be an empty parameter added, which causes this error.\r\n\r\n![image](https://user-images.githubusercontent.com/10833180/171440254-8d527143-76ed-49c2-94b4-fbec429d328f.png)\r\n\r\nThe file_field adds an empty input field that causes this parameter to be added in the form:\r\n![image](https://user-images.githubusercontent.com/10833180/171440603-35e96b71-e791-49ce-aeb6-81afbcbd182a.png)\r\n\r\nThis does not happen when the \"multiple\" option is set to false or when using Rails 6.\r\n\r\n### Expected behavior\r\n\r\nSubmit request should be executed normally (status code 200)\r\n\r\n### Actual behavior\r\n\r\nSubmit request causes an error (status code 400). See below for trace.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.2\r\n\r\nFull trace:\r\n\r\nActionController::BadRequest\r\nInvalid request parameters: expected Array (got String) for param `manuscript'\r\nExtracted source (around line #104):\r\n\r\n#102       elsif after == \"[]\"\r\n#103         params[k] ||= []\r\n*104         raise ParameterTypeError, \"expected Array (got #{params[k].class.name}) for param `#{k}'\" unless params[k].is_a?(Array)\r\n#105         params[k] << v\r\n#106       elsif after =~ %r(^\\[\\]\\[([^\\[\\]]+)\\]$) || after =~ %r(^\\[\\](.+)$)\r\n#107         child_key = $1\r\n\r\nExtracted source (around line #118):\r\n\r\n#116         params[k] ||= make_params\r\n#117         raise ParameterTypeError, \"expected Hash (got #{params[k].class.name}) for param `#{k}'\" unless params_hash_type?(params[k])\r\n*118         params[k] = normalize_params(params[k], after, v, depth - 1)\r\n#119       end\r\n#120 \r\n#121       params\r\n\r\nExtracted source (around line #195):\r\n\r\n#193           part.get_data do |data|\r\n#194             tag_multipart_encoding(part.filename, part.content_type, part.name, data)\r\n*195             @query_parser.normalize_params(@params, part.name, data, @query_parser.param_depth_limit)\r\n#196           end\r\n#197         end\r\n#198         MultipartInfo.new @params.to_params_hash, @collector.find_all(&:file?).map(&:body)\r\n\r\n\r\nRails.root: /usr/src/app\r\n\r\nFramework Trace\r\nrack (2.2.3) lib/rack/query_parser.rb:104:in `normalize_params'\r\nrack (2.2.3) lib/rack/query_parser.rb:118:in `normalize_params'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:195:in `block (2 levels) in result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:104:in `get_data'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:193:in `block in result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `block in each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:192:in `result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:81:in `parse'\r\nrack (2.2.3) lib/rack/multipart.rb:54:in `extract_multipart'\r\nrack (2.2.3) lib/rack/request.rb:594:in `parse_multipart'\r\nrack (2.2.3) lib/rack/request.rb:446:in `POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:391:in `block (2 levels) in POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `block in parse_formatted_parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `fetch'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `parse_formatted_parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:390:in `block in POST'\r\nrack (2.2.3) lib/rack/request.rb:69:in `fetch'\r\nrack (2.2.3) lib/rack/request.rb:69:in `fetch_header'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:389:in `POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:55:in `parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/filter_parameters.rb:48:in `filtered_parameters'\r\nactionpack (7.0.2.4) lib/action_controller/metal/instrumentation.rb:57:in `process_action'\r\nactionpack (7.0.2.4) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'\r\nactiverecord (7.0.2.4) lib/active_record/railties/controller_runtime.rb:27:in `process_action'\r\nactionpack (7.0.2.4) lib/abstract_controller/base.rb:151:in `process'\r\nactionview (7.0.2.4) lib/action_view/rendering.rb:39:in `process'\r\nactionpack (7.0.2.4) lib/action_controller/metal.rb:188:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_controller/metal.rb:251:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:49:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:32:in `serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:32:in `each'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:32:in `serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:850:in `call'\r\nwarden (1.2.9) lib/warden/manager.rb:36:in `block in call'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `catch'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `call'\r\nrack (2.2.3) lib/rack/tempfile_reaper.rb:15:in `call'\r\nrack (2.2.3) lib/rack/etag.rb:27:in `call'\r\nrack (2.2.3) lib/rack/conditional_get.rb:40:in `call'\r\nrack (2.2.3) lib/rack/head.rb:12:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/permissions_policy.rb:22:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/content_security_policy.rb:18:in `call'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:266:in `context'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:260:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/cookies.rb:693:in `call'\r\nactiverecord (7.0.2.4) lib/active_record/migration.rb:603:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\nactivesupport (7.0.2.4) lib/active_support/callbacks.rb:99:in `run_callbacks'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/actionable_exceptions.rb:17:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:132:in `call_app'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:28:in `block in call'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:17:in `catch'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:17:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:36:in `call_app'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:25:in `block in call'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:99:in `block in tagged'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:37:in `tagged'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:99:in `tagged'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:25:in `call'\r\nsprockets-rails (7137bb169839) lib/sprockets/rails/quiet_assets.rb:13:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/remote_ip.rb:93:in `call'\r\nrequest_store (1.5.1) lib/request_store/middleware.rb:19:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\nrack (2.2.3) lib/rack/method_override.rb:24:in `call'\r\nrack (2.2.3) lib/rack/runtime.rb:22:in `call'\r\nactivesupport (7.0.2.4) lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/static.rb:23:in `call'\r\nrack (2.2.3) lib/rack/sendfile.rb:110:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/host_authorization.rb:131:in `call'\r\nprometheus_exporter (2.0.2) lib/prometheus_exporter/middleware.rb:34:in `call'\r\nwebpacker (5.4.3) lib/webpacker/dev_server_proxy.rb:25:in `perform_request'\r\nrack-proxy (0.7.2) lib/rack/proxy.rb:67:in `call'\r\nrailties (7.0.2.4) lib/rails/engine.rb:530:in `call'\r\npuma (4.3.12) lib/puma/configuration.rb:228:in `call'\r\npuma (4.3.12) lib/puma/server.rb:727:in `handle_request'\r\npuma (4.3.12) lib/puma/server.rb:476:in `process_client'\r\npuma (4.3.12) lib/puma/server.rb:332:in `block in run'\r\npuma (4.3.12) lib/puma/thread_pool.rb:134:in `block in spawn_thread'\r\n\r\nFull Trace\r\nrack (2.2.3) lib/rack/query_parser.rb:104:in `normalize_params'\r\nrack (2.2.3) lib/rack/query_parser.rb:118:in `normalize_params'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:195:in `block (2 levels) in result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:104:in `get_data'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:193:in `block in result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `block in each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:127:in `each'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:192:in `result'\r\nrack (2.2.3) lib/rack/multipart/parser.rb:81:in `parse'\r\nrack (2.2.3) lib/rack/multipart.rb:54:in `extract_multipart'\r\nrack (2.2.3) lib/rack/request.rb:594:in `parse_multipart'\r\nrack (2.2.3) lib/rack/request.rb:446:in `POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:391:in `block (2 levels) in POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `block in parse_formatted_parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `fetch'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:90:in `parse_formatted_parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:390:in `block in POST'\r\nrack (2.2.3) lib/rack/request.rb:69:in `fetch'\r\nrack (2.2.3) lib/rack/request.rb:69:in `fetch_header'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/request.rb:389:in `POST'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/parameters.rb:55:in `parameters'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/filter_parameters.rb:48:in `filtered_parameters'\r\nactionpack (7.0.2.4) lib/action_controller/metal/instrumentation.rb:57:in `process_action'\r\nactionpack (7.0.2.4) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'\r\nactiverecord (7.0.2.4) lib/active_record/railties/controller_runtime.rb:27:in `process_action'\r\nactionpack (7.0.2.4) lib/abstract_controller/base.rb:151:in `process'\r\nactionview (7.0.2.4) lib/action_view/rendering.rb:39:in `process'\r\nactionpack (7.0.2.4) lib/action_controller/metal.rb:188:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_controller/metal.rb:251:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:49:in `dispatch'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:32:in `serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:32:in `each'\r\nactionpack (7.0.2.4) lib/action_dispatch/journey/router.rb:32:in `serve'\r\nactionpack (7.0.2.4) lib/action_dispatch/routing/route_set.rb:850:in `call'\r\nwarden (1.2.9) lib/warden/manager.rb:36:in `block in call'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `catch'\r\nwarden (1.2.9) lib/warden/manager.rb:34:in `call'\r\nrack (2.2.3) lib/rack/tempfile_reaper.rb:15:in `call'\r\nrack (2.2.3) lib/rack/etag.rb:27:in `call'\r\nrack (2.2.3) lib/rack/conditional_get.rb:40:in `call'\r\nrack (2.2.3) lib/rack/head.rb:12:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/permissions_policy.rb:22:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/http/content_security_policy.rb:18:in `call'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:266:in `context'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:260:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/cookies.rb:693:in `call'\r\nactiverecord (7.0.2.4) lib/active_record/migration.rb:603:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\nactivesupport (7.0.2.4) lib/active_support/callbacks.rb:99:in `run_callbacks'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/actionable_exceptions.rb:17:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:132:in `call_app'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:28:in `block in call'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:17:in `catch'\r\nweb-console (4.2.0) lib/web_console/middleware.rb:17:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:36:in `call_app'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:25:in `block in call'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:99:in `block in tagged'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:37:in `tagged'\r\nactivesupport (7.0.2.4) lib/active_support/tagged_logging.rb:99:in `tagged'\r\nrailties (7.0.2.4) lib/rails/rack/logger.rb:25:in `call'\r\nsprockets-rails (7137bb169839) lib/sprockets/rails/quiet_assets.rb:13:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/remote_ip.rb:93:in `call'\r\nrequest_store (1.5.1) lib/request_store/middleware.rb:19:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\nrack (2.2.3) lib/rack/method_override.rb:24:in `call'\r\nrack (2.2.3) lib/rack/runtime.rb:22:in `call'\r\nactivesupport (7.0.2.4) lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/static.rb:23:in `call'\r\nrack (2.2.3) lib/rack/sendfile.rb:110:in `call'\r\nactionpack (7.0.2.4) lib/action_dispatch/middleware/host_authorization.rb:131:in `call'\r\nprometheus_exporter (2.0.2) lib/prometheus_exporter/middleware.rb:34:in `call'\r\nwebpacker (5.4.3) lib/webpacker/dev_server_proxy.rb:25:in `perform_request'\r\nrack-proxy (0.7.2) lib/rack/proxy.rb:67:in `call'\r\nrailties (7.0.2.4) lib/rails/engine.rb:530:in `call'\r\npuma (4.3.12) lib/puma/configuration.rb:228:in `call'\r\npuma (4.3.12) lib/puma/server.rb:727:in `handle_request'\r\npuma (4.3.12) lib/puma/server.rb:476:in `process_client'\r\npuma (4.3.12) lib/puma/server.rb:332:in `block in run'\r\npuma (4.3.12) lib/puma/thread_pool.rb:134:in `block in spawn_thread'\r\n\r\n\r\n\r\nRequest parameters\r\nNone\r\n\r\nSession dump\r\n_csrf_token: \"az0j6WdcULwly1XMUlOF-Bz3R2g1gRWb01nYLW4njyI\"\r\nsession_id: \"8e5e5fca8599eaca9e7de41f2096fa39\"\r\nuser_return_to: \"/\"\r\nwarden.user.user.key: [[5], \"$2a$11$8xWSW0PTFhR2j18uAuXIw.\"]\r\n\r\nEnv dump\r\nGATEWAY_INTERFACE: \"CGI/1.2\"\r\nHTTP_ACCEPT: \"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01\"\r\nHTTP_ACCEPT_ENCODING: \"gzip, deflate, br\"\r\nHTTP_ACCEPT_LANGUAGE: \"de-DE,de;q=0.9\"\r\nHTTP_ORIGIN: \"http://127.0.0.1:3000\"\r\nHTTP_VERSION: \"HTTP/1.1\"\r\nHTTP_X_CSRF_TOKEN: \"mhmv50gFefhN-pOC8i9vUIb8T3h5ChcK5Hzw7WqM7LBRBM_9JHywaTlw77rY1w2FyO3QSfopANzPR5Mcx6zHhA\"\r\nHTTP_X_FORWARDED_FOR: \"172.18.0.1\"\r\nORIGINAL_SCRIPT_NAME: \"\"\r\nREMOTE_ADDR: \"172.18.0.6\"\r\nSERVER_NAME: \"127.0.0.1\"\r\nSERVER_PROTOCOL: \"HTTP/1.1\"\r\n\r\nResponse headers\r\nNone\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45238/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45238/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45234","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45234/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45234/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45234/events","html_url":"https://github.com/rails/rails/issues/45234","id":1255566293,"node_id":"I_kwDNIULOStZr1Q","number":45234,"title":"Write sql query detection for Postgres extremely slow","user":{"login":"urmomwx","id":76976083,"node_id":"MDQ6VXNlcjc2OTc2MDgz","avatar_url":"https://avatars.githubusercontent.com/u/76976083?v=4","gravatar_id":"","url":"https://api.github.com/users/urmomwx","html_url":"https://github.com/urmomwx","followers_url":"https://api.github.com/users/urmomwx/followers","following_url":"https://api.github.com/users/urmomwx/following{/other_user}","gists_url":"https://api.github.com/users/urmomwx/gists{/gist_id}","starred_url":"https://api.github.com/users/urmomwx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/urmomwx/subscriptions","organizations_url":"https://api.github.com/users/urmomwx/orgs","repos_url":"https://api.github.com/users/urmomwx/repos","events_url":"https://api.github.com/users/urmomwx/events{/privacy}","received_events_url":"https://api.github.com/users/urmomwx/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-06-01T10:05:17Z","updated_at":"2022-06-02T11:07:14Z","closed_at":"2022-06-02T11:07:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nFeed reasonably large SQL (in my case ~ 600 lines) file with multiple query statements to ActiveRecord::Base.connection.execute while using Postgresql as database adapter and wait for results. For a long time. It is working ok in Rails 6.0.4.8 but when migrating to rails 7.0.3 one of my tests hangs for more than 5 minutes.\r\n\r\n### To check it's the issue:\r\nFetched READ_QUERY from debugger just before the line that hangs:\r\nhttps://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/postgresql/database_statements.rb#L30\r\n\r\n```\r\nread_query_regex = /\\A(?:[(\\s]|(?m-ix:(?:--.*\\n)|\\/\\*(?:[^*]|\\*[^\\/])*\\*\\/))*(?-mix:(?i-mx:close)|(?i-mx:declare)|(?i-mx:fetch)|(?i-mx:move)|(?i-mx:set)|(?i-mx:show)|(?i-mx:begin)|(?i-mx:commit)|(?i-mx:explain)|(?i-mx:release)|(?i-mx:rollback)|(?i-mx:savepoint)|(?i-mx:select)|(?i-mx:with))/\r\nsql = STDIN.read\r\nputs read_query_regex.match?(sql)\r\n```\r\n### Expected behavior\r\nIt should perform the match in reasonable time, even in 1 second it would be fine\r\n\r\n### Actual behavior\r\nIt does not finish in at least 5 minutes keeping CPU at 100%.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45234/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45234/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45232","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45232/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45232/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45232/events","html_url":"https://github.com/rails/rails/issues/45232","id":1254976746,"node_id":"I_kwDNIULOSs1s6g","number":45232,"title":"Kindle version no table of contents?","user":{"login":"gustiando","id":681278,"node_id":"MDQ6VXNlcjY4MTI3OA==","avatar_url":"https://avatars.githubusercontent.com/u/681278?v=4","gravatar_id":"","url":"https://api.github.com/users/gustiando","html_url":"https://github.com/gustiando","followers_url":"https://api.github.com/users/gustiando/followers","following_url":"https://api.github.com/users/gustiando/following{/other_user}","gists_url":"https://api.github.com/users/gustiando/gists{/gist_id}","starred_url":"https://api.github.com/users/gustiando/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gustiando/subscriptions","organizations_url":"https://api.github.com/users/gustiando/orgs","repos_url":"https://api.github.com/users/gustiando/repos","events_url":"https://api.github.com/users/gustiando/events{/privacy}","received_events_url":"https://api.github.com/users/gustiando/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-01T05:12:27Z","updated_at":"2022-08-12T18:57:34Z","closed_at":"2022-08-12T18:57:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I just downloaded the guide in my kindle and noticed no table of contents. is that expected?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45232/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45232/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45228","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45228/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45228/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45228/events","html_url":"https://github.com/rails/rails/issues/45228","id":1254100009,"node_id":"I_kwDNIULOSsAMKQ","number":45228,"title":"API only apps do not have an `enabled?` method on the session.","user":{"login":"jcoyne","id":92044,"node_id":"MDQ6VXNlcjkyMDQ0","avatar_url":"https://avatars.githubusercontent.com/u/92044?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoyne","html_url":"https://github.com/jcoyne","followers_url":"https://api.github.com/users/jcoyne/followers","following_url":"https://api.github.com/users/jcoyne/following{/other_user}","gists_url":"https://api.github.com/users/jcoyne/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoyne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoyne/subscriptions","organizations_url":"https://api.github.com/users/jcoyne/orgs","repos_url":"https://api.github.com/users/jcoyne/repos","events_url":"https://api.github.com/users/jcoyne/events{/privacy}","received_events_url":"https://api.github.com/users/jcoyne/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-31T16:16:47Z","updated_at":"2022-05-31T19:21:05Z","closed_at":"2022-05-31T19:21:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I have a rails 7.0 application that is set for `api_mode = true`. \r\n\r\nWhen I run an integration tests I get an error like this:\r\n\r\n```\r\nNoMethodError: undefined method `enabled?' for {}:Hash\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/flash.rb:63:in `commit_flash'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_controller/metal.rb:189:in `dispatch'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_controller/metal.rb:251:in `dispatch'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/routing/route_set.rb:49:in `dispatch'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/routing/route_set.rb:32:in `serve'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/journey/router.rb:32:in `each'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/journey/router.rb:32:in `serve'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/routing/route_set.rb:852:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-2.2.3.1/lib/rack/etag.rb:27:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-2.2.3.1/lib/rack/conditional_get.rb:40:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-2.2.3.1/lib/rack/head.rb:12:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activesupport-7.0.3/lib/active_support/callbacks.rb:99:in `run_callbacks'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/actionable_exceptions.rb:17:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/railties-7.0.3/lib/rails/rack/logger.rb:40:in `call_app'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/railties-7.0.3/lib/rails/rack/logger.rb:25:in `block in call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activesupport-7.0.3/lib/active_support/tagged_logging.rb:114:in `block in tagged'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activesupport-7.0.3/lib/active_support/tagged_logging.rb:38:in `tagged'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activesupport-7.0.3/lib/active_support/tagged_logging.rb:114:in `tagged'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/railties-7.0.3/lib/rails/rack/logger.rb:25:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/remote_ip.rb:93:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/request_store-1.5.1/lib/request_store/middleware.rb:19:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-2.2.3.1/lib/rack/runtime.rb:22:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activesupport-7.0.3/lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/executor.rb:14:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/static.rb:23:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-2.2.3.1/lib/rack/sendfile.rb:110:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/middleware/host_authorization.rb:131:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/honeybadger-4.12.1/lib/honeybadger/rack/error_notifier.rb:33:in `block in call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/honeybadger-4.12.1/lib/honeybadger/agent.rb:426:in `with_rack_env'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/honeybadger-4.12.1/lib/honeybadger/rack/error_notifier.rb:30:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/honeybadger-4.12.1/lib/honeybadger/rack/user_feedback.rb:31:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/honeybadger-4.12.1/lib/honeybadger/rack/user_informer.rb:21:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/railties-7.0.3/lib/rails/engine.rb:530:in `call'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/mock_session.rb:29:in `request'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test.rb:266:in `process_request'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test.rb:119:in `request'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/testing/integration.rb:279:in `process'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/testing/integration.rb:34:in `put'\r\n    /Users/jcoyne85/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/actionpack-7.0.3/lib/action_dispatch/testing/integration.rb:370:in `put'\r\n    /Users/jcoyne85/workspace/sul-dlss/workflow-server-rails/test/integration/update_step_test.rb:11:in `block in <class:UpdateStepTest>'\r\n ```\r\n\r\nI believe this regression was introduced in https://github.com/rails/rails/commit/ca7c820c6962788d510c99a68e725de83cbe9cad where the code was refactored to depend this method: https://github.com/rails/rails/commit/ca7c820c6962788d510c99a68e725de83cbe9cad#diff-5f81b06a0e3051b576daee16c960b21e715a6cc26d97d020c546d2fa697c9bc6R203-R205\r\n\r\nHowever that module is not used by API only applications\r\nhttps://github.com/rails/rails/blob/ca7c820c6962788d510c99a68e725de83cbe9cad/actionpack/lib/action_controller/metal/request_forgery_protection.rb#L48-L49\r\n\r\nSo when `commit_flash` is called there is no `enabled?` method defined on the `session` variable.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45228/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45228/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45227","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45227/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45227/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45227/events","html_url":"https://github.com/rails/rails/issues/45227","id":1254086195,"node_id":"I_kwDNIULOSr_WMw","number":45227,"title":"Where clauses with arrays including nil aren't removed by unscope","user":{"login":"jmeberlein","id":14060305,"node_id":"MDQ6VXNlcjE0MDYwMzA1","avatar_url":"https://avatars.githubusercontent.com/u/14060305?v=4","gravatar_id":"","url":"https://api.github.com/users/jmeberlein","html_url":"https://github.com/jmeberlein","followers_url":"https://api.github.com/users/jmeberlein/followers","following_url":"https://api.github.com/users/jmeberlein/following{/other_user}","gists_url":"https://api.github.com/users/jmeberlein/gists{/gist_id}","starred_url":"https://api.github.com/users/jmeberlein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmeberlein/subscriptions","organizations_url":"https://api.github.com/users/jmeberlein/orgs","repos_url":"https://api.github.com/users/jmeberlein/repos","events_url":"https://api.github.com/users/jmeberlein/events{/privacy}","received_events_url":"https://api.github.com/users/jmeberlein/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-31T16:04:57Z","updated_at":"2022-05-31T16:44:58Z","closed_at":"2022-05-31T16:43:34Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\nActiveRecord::Schema.define do\r\n  create_table :books, force: true do |t|\r\n    t.string :genre\r\n    t.string :title\r\n  end\r\nend\r\n\r\nclass Book < ActiveRecord::Base\r\n  attr_accessible :genre, :title\r\nend\r\n\r\nBook.create!(genre: :mystery, title: 'A Study in Scarlet')\r\nBook.create!(genre: :romance, title: 'Pride and Prejudice')\r\nBook.create!(genre: nil, title: 'An empty book')\r\n\r\nBook.where(genre: [nil, :romance]).unscope(where: :genre)\r\n```\r\n\r\n### Expected behavior\r\nIt should return all three books, regardless of genre\r\n\r\n### Actual behavior\r\nThe SQL query still includes `WHERE (\"books\".\"genre\" = 'romance' OR \"books\".\"genre\" IS NULL)` and doesn't return A Study in Scarlet\r\n\r\n### System configuration\r\n**Rails version**: 4.2.11.3\r\n\r\n**Ruby version**: 2.6.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45227/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45225","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45225/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45225/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45225/events","html_url":"https://github.com/rails/rails/issues/45225","id":1254001398,"node_id":"I_kwDNIULOSr6K9g","number":45225,"title":"How to get blob service_url in Javascript","user":{"login":"JoaoPedroAssis","id":38732089,"node_id":"MDQ6VXNlcjM4NzMyMDg5","avatar_url":"https://avatars.githubusercontent.com/u/38732089?v=4","gravatar_id":"","url":"https://api.github.com/users/JoaoPedroAssis","html_url":"https://github.com/JoaoPedroAssis","followers_url":"https://api.github.com/users/JoaoPedroAssis/followers","following_url":"https://api.github.com/users/JoaoPedroAssis/following{/other_user}","gists_url":"https://api.github.com/users/JoaoPedroAssis/gists{/gist_id}","starred_url":"https://api.github.com/users/JoaoPedroAssis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoaoPedroAssis/subscriptions","organizations_url":"https://api.github.com/users/JoaoPedroAssis/orgs","repos_url":"https://api.github.com/users/JoaoPedroAssis/repos","events_url":"https://api.github.com/users/JoaoPedroAssis/events{/privacy}","received_events_url":"https://api.github.com/users/JoaoPedroAssis/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-31T15:00:22Z","updated_at":"2022-05-31T19:59:01Z","closed_at":"2022-05-31T19:58:27Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nHey, I'm trying to fetch images from S3 in a JS script, which reads from a rich text editor html and extracts images src's. The problem is that when i use js `fetch`function in the redirect url, i have a cors issue and cannot get the image (that will be later converted to base64)\r\n\r\nHow can I download the blob directly from S3 in JS?\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45225/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45220","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45220/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45220/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45220/events","html_url":"https://github.com/rails/rails/issues/45220","id":1253053441,"node_id":"I_kwDNIULOSrAUAQ","number":45220,"title":"Flaky bug in ActionController::Parameters#permit!","user":{"login":"olefriis","id":134527,"node_id":"MDQ6VXNlcjEzNDUyNw==","avatar_url":"https://avatars.githubusercontent.com/u/134527?v=4","gravatar_id":"","url":"https://api.github.com/users/olefriis","html_url":"https://github.com/olefriis","followers_url":"https://api.github.com/users/olefriis/followers","following_url":"https://api.github.com/users/olefriis/following{/other_user}","gists_url":"https://api.github.com/users/olefriis/gists{/gist_id}","starred_url":"https://api.github.com/users/olefriis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olefriis/subscriptions","organizations_url":"https://api.github.com/users/olefriis/orgs","repos_url":"https://api.github.com/users/olefriis/repos","events_url":"https://api.github.com/users/olefriis/events{/privacy}","received_events_url":"https://api.github.com/users/olefriis/received_events","type":"User","site_admin":true},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-30T19:10:40Z","updated_at":"2022-06-01T23:51:27Z","closed_at":"2022-06-01T23:51:26Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nIn GitHub, after upgrading to Rails 7.1 de12c18a99, a few tests have become flaky. They call endpoints with `params` that contain lists with hashes.\r\n\r\nWhen the tests fail, the failure is\r\n```\r\nActiveSupport::DeprecationException: DEPRECATION WARNING: Comparing equality between `ActionController::Parameters` and a `Hash` is deprecated and will be removed in Rails 7.2. Please only do comparisons between instances of `ActionController::Parameters`. If you need to compare to a hash, first convert it using `ActionController::Parameters#new`. To disable the deprecated behaviour set `Rails.application.config.action_controller.allow_deprecated_parameters_hash_equality = false`. (called from [...] at [...])\r\n```\r\n\r\n## Reproduction\r\nThe error is reproducible locally by running one of the tests over, over, and over again (e.g. `while bin/rails test <path-to-test>; do echo next; done`). We instrumented `ActionController::Parameters#==` (in `actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb`) with a bit of backtrace stuff so it now looks like this:\r\n```ruby\r\n    def ==(other)\r\n      if other.respond_to?(:permitted?)\r\n        permitted? == other.permitted? && parameters == other.parameters\r\n      else\r\n        begin\r\n          raise \"We're here!\"\r\n        rescue => e\r\n          puts e.backtrace\r\n        end\r\n        puts \"Other class: #{other.class}\"\r\n        if Hash === other\r\n          puts 'It is a Hash!'\r\n        end\r\n        if self.class.allow_deprecated_parameters_hash_equality && Hash === other\r\n          ActiveSupport::Deprecation.warn <<-WARNING.squish\r\n            Comparing equality between `ActionController::Parameters` and a\r\n            `Hash` is deprecated and will be removed in Rails 7.2. Please only do\r\n            comparisons between instances of `ActionController::Parameters`. If\r\n            you need to compare to a hash, first convert it using\r\n            `ActionController::Parameters#new`.\r\n            To disable the deprecated behaviour set\r\n            `Rails.application.config.action_controller.allow_deprecated_parameters_hash_equality = false`.\r\n          WARNING\r\n          @parameters == other\r\n        else\r\n          super\r\n        end\r\n      end\r\n    end\r\n```\r\n...and got this nice, little stack trace:\r\n```\r\nRun options: --seed 55159\r\n\r\n# Running:\r\n\r\n......................................................................................We're here!\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:287:in `=='\r\n/workspaces/github/vendor/ruby/4a0738122107d0d7af669feed62452ce64568692/lib/ruby/3.1.0/set.rb:404:in `eql?'\r\n/workspaces/github/vendor/ruby/4a0738122107d0d7af669feed62452ce64568692/lib/ruby/3.1.0/set.rb:404:in `eql?'\r\n/workspaces/github/vendor/ruby/4a0738122107d0d7af669feed62452ce64568692/lib/ruby/3.1.0/set.rb:404:in `include?'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:1004:in `convert_value_to_parameters'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:996:in `convert_hashes_to_parameters'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:407:in `block in each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:464:in `permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:466:in `block (2 levels) in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `each'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `block in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:407:in `block in each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:464:in `permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:466:in `block (2 levels) in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `each'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `block in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:407:in `block in each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:464:in `permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:466:in `block (2 levels) in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `each'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:465:in `block in permit!'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:407:in `block in each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:406:in `each_pair'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/action_controller/metal/strong_parameters.rb:464:in `permit!'\r\n[...here is our controller code calling permit! on an ActiveSupport::Parameters instance...]\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:400:in `block in make_lambda'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:180:in `block (2 levels) in halting_and_conditional'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/actionpack-7.1.0.alpha.de12c18a99/lib/abstract_controller/callbacks.rb:34:in `block (2 levels) in <module:Callbacks>'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:181:in `block in halting_and_conditional'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:595:in `block in invoke_before'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:595:in `each'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:595:in `invoke_before'\r\n/workspaces/github/vendor/gems/3.1.2/ruby/3.1.0/gems/activesupport-7.1.0.alpha.de12c18a99/lib/active_support/callbacks.rb:116:in `block in run_callbacks'\r\n[...more lines probably irrelevant for this issue...]\r\n[...our test, POSTing to the endpoint...]\r\n[...and MiniTest stack trace etc...]\r\nOther class: ActiveSupport::HashWithIndifferentAccess\r\nIt is a Hash!\r\n```\r\n\r\n## Analysis\r\nSo sometimes, the implementation of `permit!` compares an `ActiveSupport::HashWithIndifferentAccess` with an `ActionController::Parameters` all by itself.\r\n\r\nAs the stack trace suggests, it happens here:\r\n```ruby\r\n      def convert_value_to_parameters(value)\r\n        case value\r\n        when Array\r\n          return value if converted_arrays.member?(value)\r\n          converted = value.map { |_| convert_value_to_parameters(_) }\r\n          converted_arrays << converted.dup\r\n          converted\r\n        when Hash\r\n          self.class.new(value, @logging_context)\r\n        else\r\n          value\r\n        end\r\n      end\r\n```\r\n(The `return value if converted_arrays.member?(value)` line.)\r\n\r\nMost of the time, the `converted_arrays` object, which is a `Set`, will have no hash collisions with `value`, but sometimes it will, and then it needs to compare existing entries in the `Set` with `value`. And since `value` has not been converted to an `ActionController::Parameters` object, we get the error.\r\n\r\nWe have changed the `convert_value_to_parameters` method to provoke this error deterministically by making it a bit uglier and much less performant, so we compare all existing elements with `value` 😃\r\n```ruby\r\n      def convert_value_to_parameters(value)\r\n        case value\r\n        when Array\r\n          match = false\r\n          converted_arrays.each do |element|\r\n            match ||= element == value\r\n          end\r\n\r\n          return value if match\r\n          converted = value.map { |_| convert_value_to_parameters(_) }\r\n          converted_arrays << converted.dup\r\n          converted\r\n        when Hash\r\n          self.class.new(value, @logging_context)\r\n        else\r\n          value\r\n        end\r\n      end\r\n```\r\n\r\n## Minimal (?) test\r\nWith the changes to `convert_value_to_parameters` above, this test triggers the issue consistently:\r\n```ruby\r\n  test \"strong parameters may be buggy\" do\r\n    ActionController::Parameters.new(\r\n      \"iterations\": [\r\n        {\r\n          \"title\": \"Iteration 1\",\r\n        },\r\n      ],\r\n      \"completedIterations\": [\r\n        {\r\n          \"title\": \"Iteration 2\",\r\n        },\r\n      ],\r\n    ).permit!\r\n  end\r\n```\r\nMaybe it can be made even smaller, but we're not sure.\r\n\r\n## Possible work-around\r\nChanging the above test a bit so that it does part of the work of `convert_value_to_parameters` can make it pass:\r\n```ruby\r\n  test \"strong parameters may be buggy\" do\r\n    ActionController::Parameters.new(\r\n      \"iterations\": [\r\n        ActionController::Parameters.new(\r\n          \"title\": \"Iteration 1\",\r\n        ),\r\n      ],\r\n      \"completedIterations\": [\r\n        ActionController::Parameters.new(\r\n          \"title\": \"Iteration 2\",\r\n        ),\r\n      ],\r\n    ).permit!\r\n  end\r\n```\r\n...but this just seems wrong...? I believe the failing test should not fail, or...?\r\n\r\n## Proposed Fix\r\nThis should fix the issue:\r\n```ruby\r\n      def convert_value_to_parameters(value)\r\n        case value\r\n        when Array\r\n          converted = value.map { |_| convert_value_to_parameters(_) }\r\n          return value if converted_arrays.member?(converted)\r\n          converted_arrays << converted.dup\r\n          converted\r\n        when Hash\r\n          self.class.new(value, @logging_context)\r\n        else\r\n          value\r\n        end\r\n      end\r\n```\r\nNow we convert the value before trying to check for membership in `converted_arrays`. This is less performant, but is maybe not too bad, since `convert_value_to_parameters` will just return the given value if it is already converted.\r\n\r\nMaybe we can just remove the cache:\r\n```ruby\r\n      def convert_value_to_parameters(value)\r\n        case value\r\n        when Array\r\n          value.map { |_| convert_value_to_parameters(_) }\r\n        when Hash\r\n          self.class.new(value, @logging_context)\r\n        else\r\n          value\r\n        end\r\n      end\r\n```\r\n\r\nAlso, writing a test that shows a _lack_ of flakiness also needs to be done...\r\n\r\n## Further Context\r\nInterestingly, there was a fix in 2021 in the same method: https://github.com/rails/rails/issues/43681\r\n\r\nBut this seems to be a different issue that is related to the phasing-out of comparison between `ActionController::Parameters` and `Hash`: https://github.com/rails/rails/commit/8af86c997c7bfbb05afa7dbde8847cf9b55a7b47\r\n\r\n(Sorry, I haven't created a reproduction script according to the template. I can do that, though the above test should be easy to get working. Let me know if I should expand on this.)\r\n\r\n### Expected behavior\r\n`ActionController::Parameters#permit!` shouldn't be flaky 😄 \r\n\r\n### Actual behavior\r\n`ActionController::Parameters#permit!` is flaky 😄 \r\n\r\n### System configuration\r\n**Rails version**: Rails 7.1.0.alpha.de12c18a99\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4a07381221) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45220/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45220/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45215","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45215/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45215/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45215/events","html_url":"https://github.com/rails/rails/issues/45215","id":1252617510,"node_id":"I_kwDNIULOSqltJg","number":45215,"title":"Codespaces is broken","user":{"login":"Ivanov-Anton","id":10907664,"node_id":"MDQ6VXNlcjEwOTA3NjY0","avatar_url":"https://avatars.githubusercontent.com/u/10907664?v=4","gravatar_id":"","url":"https://api.github.com/users/Ivanov-Anton","html_url":"https://github.com/Ivanov-Anton","followers_url":"https://api.github.com/users/Ivanov-Anton/followers","following_url":"https://api.github.com/users/Ivanov-Anton/following{/other_user}","gists_url":"https://api.github.com/users/Ivanov-Anton/gists{/gist_id}","starred_url":"https://api.github.com/users/Ivanov-Anton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ivanov-Anton/subscriptions","organizations_url":"https://api.github.com/users/Ivanov-Anton/orgs","repos_url":"https://api.github.com/users/Ivanov-Anton/repos","events_url":"https://api.github.com/users/Ivanov-Anton/events{/privacy}","received_events_url":"https://api.github.com/users/Ivanov-Anton/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-30T11:41:46Z","updated_at":"2022-06-01T12:19:02Z","closed_at":"2022-06-01T12:19:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n1. On the Rails repository click the \"Code\" button\r\n2. Click \"Create Codespaces on main\"\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behaviour\r\n<!-- Tell us what should happen -->\r\nI see a dev environment that is ready to run any test and contribute to the Rails repo\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nI see errors while creating an environment\r\n\r\n### System configuration\r\nCodespaces creation log\r\n\r\n```\r\n&& echo '2022-04-25T16:27:19.241083961Z' > '/home/codespace/.vscode-remote/data/Machine/.updateContentCommandMarker'\r\n2022-04-25 16:27:34.591Z: Stop (331 ms): Resolving Remote\r\n2022-05-30 11:31:58.687Z: Configuration starting...\r\n2022-05-30 11:31:58.737Z: $ git -C \"/var/lib/docker/codespacemount/workspace/rails\" fetch origin main\r\n2022-05-30 11:31:58.755Z: fatal: cannot change to '/var/lib/docker/codespacemount/workspace/rails': No such file or directory\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45215/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45209","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45209/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45209/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45209/events","html_url":"https://github.com/rails/rails/issues/45209","id":1252184290,"node_id":"I_kwDNIULOSqLQ4g","number":45209,"title":"Associated records are validated when passing context","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-30T04:45:47Z","updated_at":"2022-08-31T01:10:54Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n    t.string :body\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\n\r\n  after_create :create_invalid_comment!\r\n\r\n  def create_invalid_comment!\r\n    c = comments.new\r\n    c.save!(validate: false)\r\n  end\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\n\r\n  validates :body, presence: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_save\r\n    post = Post.create\r\n    assert post.save\r\n  end\r\n\r\n  def test_save_with_context\r\n    post = Post.create\r\n    assert post.save(context: :whatever)\r\n  end\r\n\r\n  def test_save_with_context_reloaded\r\n    post = Post.create.reload\r\n    assert post.save(context: :whatever)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nAssociated records are not validated.\r\n\r\n### Actual behavior\r\n\r\nAssociated records are validated.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45209/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45209/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45202","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45202/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45202/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45202/events","html_url":"https://github.com/rails/rails/issues/45202","id":1251852966,"node_id":"I_kwDNIULOSp3Cpg","number":45202,"title":"Improve documentation on discarding active storage files during and after system tests","user":{"login":"matthee","id":547653,"node_id":"MDQ6VXNlcjU0NzY1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/547653?v=4","gravatar_id":"","url":"https://api.github.com/users/matthee","html_url":"https://github.com/matthee","followers_url":"https://api.github.com/users/matthee/followers","following_url":"https://api.github.com/users/matthee/following{/other_user}","gists_url":"https://api.github.com/users/matthee/gists{/gist_id}","starred_url":"https://api.github.com/users/matthee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matthee/subscriptions","organizations_url":"https://api.github.com/users/matthee/orgs","repos_url":"https://api.github.com/users/matthee/repos","events_url":"https://api.github.com/users/matthee/events{/privacy}","received_events_url":"https://api.github.com/users/matthee/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-29T10:45:15Z","updated_at":"2022-05-29T11:12:08Z","closed_at":"2022-05-29T11:12:07Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI am running system tests using minitest and active-storage file fixtures. `#destroy` callbacks are not run when database transactions are rolled back. Therefore we need to cleanup after ourselves. [The documentation](https://guides.rubyonrails.org/active_storage_overview.html#discarding-files-created-during-tests) suggests the following method should be added to `ApplicationSystemTestCase`:\r\n\r\n```ruby\r\nclass ApplicationSystemTestCase < ActionDispatch::SystemTestCase\r\n  # ...\r\n  def after_teardown\r\n    super\r\n    FileUtils.rm_rf(ActiveStorage::Blob.service.root)\r\n  end\r\n  # ...\r\nend\r\n```\r\n\r\nHowever, if this technique is used in combination with [ActiveStorage File Fixtures](https://edgeguides.rubyonrails.org/active_storage_overview.html#adding-attachments-to-fixtures), the files added by the fixture files (`active_storage/blobs.yml` and `active_storage/attachments.yml`) get cleaned up as well. The results are cryptic and random `ActiveStorage::FileNotFoundError` errors when running system tests. Debugging is also very hard, since these errors are not reproducible when running single tests in order to isolate the problem.\r\n\r\nIt is also important to note that `after_teardown` gets run after test, instead of after the whole suite finishes. \r\n\r\n### Expected behavior\r\n\r\nThe documentation should either warn about this problem, or suggest a different solution.\r\n\r\n### Actual behavior\r\n\r\nThe code copy-and-pasted from the documentation results in random system test failures, which are hard to get a hold of.\r\n\r\n### Proposed Changes\r\n\r\n#### My preferred solution\r\nFile name collisions in the disk service are very unlikely to happen when performing a single-test run of the whole test suite. Therefore, I am suggesting to just cleanup the active storage directory after the whole test suite has finished by using minitest's `after_run` hook:\r\n\r\n```ruby\r\n# test/test_helper.rb\r\n\r\n# ...\r\n\r\nMinitest.after_run do\r\n  FileUtils.rm_rf(ActiveStorage::Blob.service.root)\r\nend\r\n```\r\n\r\n#### Alternate solution\r\n\r\nWe could also suggest using a different storage location for files added by fixture files. I would need to look into how we could implement this solution.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.3\r\n\r\n**Ruby version**:\r\n3.0.2p107","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45202/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45199","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45199/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45199/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45199/events","html_url":"https://github.com/rails/rails/issues/45199","id":1251708888,"node_id":"I_kwDNIULOSpuP2A","number":45199,"title":"Deterministically encrypted attributes are uniquely validated N + 1 times when `extend_queries` is enabled","user":{"login":"agrobbin","id":46724,"node_id":"MDQ6VXNlcjQ2NzI0","avatar_url":"https://avatars.githubusercontent.com/u/46724?v=4","gravatar_id":"","url":"https://api.github.com/users/agrobbin","html_url":"https://github.com/agrobbin","followers_url":"https://api.github.com/users/agrobbin/followers","following_url":"https://api.github.com/users/agrobbin/following{/other_user}","gists_url":"https://api.github.com/users/agrobbin/gists{/gist_id}","starred_url":"https://api.github.com/users/agrobbin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/agrobbin/subscriptions","organizations_url":"https://api.github.com/users/agrobbin/orgs","repos_url":"https://api.github.com/users/agrobbin/repos","events_url":"https://api.github.com/users/agrobbin/events{/privacy}","received_events_url":"https://api.github.com/users/agrobbin/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-05-28T19:33:03Z","updated_at":"2022-06-09T04:31:18Z","closed_at":"2022-06-09T04:31:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Encryption.configure(\r\n  primary_key: SecureRandom.alphanumeric(32),\r\n  deterministic_key: SecureRandom.alphanumeric(32),\r\n  key_derivation_salt: SecureRandom.alphanumeric(32),\r\n)\r\n\r\nActiveRecord::Encryption::ExtendedDeterministicUniquenessValidator.install_support\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :companies, force: true do |t|\r\n    t.string :a, null: false, index: { unique: true }\r\n    t.string :b, null: false, index: { unique: true }\r\n  end\r\nend\r\n\r\nclass Company < ActiveRecord::Base\r\n  validates :a, uniqueness: true\r\n  validates :b, uniqueness: true\r\n\r\n  encrypts :a, deterministic: true\r\n  encrypts :b, deterministic: true\r\nend\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  include ActiveRecord::TestFixtures\r\n\r\n  self.use_transactional_tests = true\r\n\r\n  def test_uniqueness_validations_for_deterministically_encrypted_attributes\r\n    Company.create!(a: '1', b: '2')\r\n    Company.create!(a: '1', b: '2')\r\n\r\n    # look at the # of queries performed in the SQL output\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n`Company#a` and `Company#b` are only validated for uniqueness once (unless `:previous` is configured, in which case it would do `1 + n`, where `n` is the number of previous encryption schemes for that _single_ attribute).\r\n\r\n### Actual behavior\r\n\r\n`Company#a` and `Company#b` are validated 3 times each, even with no previous encryption schemes for either attribute.\r\n\r\nIf `ActiveRecord::Encryption.config.extend_queries` has been enabled, uniqueness validation is extended here:\r\n\r\nhttps://github.com/rails/rails/blob/01f58d62c2f31f42d0184e0add2b6aa710513695/activerecord/lib/active_record/railtie.rb#L350-L354\r\n\r\nI would expect this to run additional validations against previous encryption schemes, if any existed. However, it appears to be iterating over the # of deterministically encrypted attributes, performing the validation many additional times.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45199/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45197","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45197/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45197/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45197/events","html_url":"https://github.com/rails/rails/issues/45197","id":1251623364,"node_id":"I_kwDNIULOSppBxA","number":45197,"title":"ActiveSupport::Reloader.to_prepare do runs before autoload_paths","user":{"login":"rgaufman","id":33842342,"node_id":"MDQ6VXNlcjMzODQyMzQy","avatar_url":"https://avatars.githubusercontent.com/u/33842342?v=4","gravatar_id":"","url":"https://api.github.com/users/rgaufman","html_url":"https://github.com/rgaufman","followers_url":"https://api.github.com/users/rgaufman/followers","following_url":"https://api.github.com/users/rgaufman/following{/other_user}","gists_url":"https://api.github.com/users/rgaufman/gists{/gist_id}","starred_url":"https://api.github.com/users/rgaufman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rgaufman/subscriptions","organizations_url":"https://api.github.com/users/rgaufman/orgs","repos_url":"https://api.github.com/users/rgaufman/repos","events_url":"https://api.github.com/users/rgaufman/events{/privacy}","received_events_url":"https://api.github.com/users/rgaufman/received_events","type":"User","site_admin":false},"labels":[{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-28T12:50:21Z","updated_at":"2022-05-28T16:33:54Z","closed_at":"2022-05-28T16:25:01Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have this in my application.rb\r\n```\r\nclass Application < Rails::Application\r\n    config.load_defaults 7.0\r\n    config.autoload_paths += Dir[\"#{config.root}/lib/**/\"]\r\n    ...\r\n```\r\n\r\nI have this in a file config/initializers/good_job.rb:\r\n\r\n```\r\nActiveSupport::Reloader.to_prepare do\r\n  Cameras::Hikvision\r\nend\r\n```\r\n\r\nI have this in my ./lib/cameras/hikvision.rb:\r\n```\r\nclass Cameras::Hikvision\r\nend\r\n```\r\n\r\nWhen I start my app, I see:\r\n\r\n```\r\nuninitialized constant Cameras::Hikvision\r\n```\r\n\r\n### Expected behaviour\r\n\r\nI am expecting Rails to load the autoload_paths (which include \"#{config.root}/lib/**/\") before loading my initializers, which depend on the former.\r\n\r\n\r\n### Actual behaviour\r\n\r\nIt seems to first load the initializers before my libraries.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n**Ruby version**: 3.1.2\r\n\r\n\r\nAny ideas? - Maybe I need to use something other than ActiveSupport::Reloader.to_prepare?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45197/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45197/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45193","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45193/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45193/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45193/events","html_url":"https://github.com/rails/rails/issues/45193","id":1251296567,"node_id":"I_kwDNIULOSpVFNw","number":45193,"title":"ActiveStorage direct upload bug in safari","user":{"login":"silva96","id":4019924,"node_id":"MDQ6VXNlcjQwMTk5MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/4019924?v=4","gravatar_id":"","url":"https://api.github.com/users/silva96","html_url":"https://github.com/silva96","followers_url":"https://api.github.com/users/silva96/followers","following_url":"https://api.github.com/users/silva96/following{/other_user}","gists_url":"https://api.github.com/users/silva96/gists{/gist_id}","starred_url":"https://api.github.com/users/silva96/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silva96/subscriptions","organizations_url":"https://api.github.com/users/silva96/orgs","repos_url":"https://api.github.com/users/silva96/repos","events_url":"https://api.github.com/users/silva96/events{/privacy}","received_events_url":"https://api.github.com/users/silva96/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-27T21:39:01Z","updated_at":"2022-06-14T02:36:18Z","closed_at":"2022-06-14T02:36:18Z","author_association":"NONE","active_lock_reason":null,"body":"I found a bug where ActiveStorage direct uploads are not working in safari, in chrome works perfectly. This happens in ipad safari and mac safari (haven't tried in iphone).\r\n\r\nPlease see this gif of how it works in chrome:\r\n\r\n![direct_upload_chrome](https://user-images.githubusercontent.com/4019924/170791938-01dd2047-beeb-45fe-8ca2-f167608291fc.gif)\r\n\r\nBut in safari it gets stuck and never calls the form action after the direct upload. I'm looking at Aws S3 and the files are there, but the rails form that attaches the direct uploads to the actual records is never posted so the files are not  associated with the records.\r\n\r\n![direct_upload_safari](https://user-images.githubusercontent.com/4019924/170792058-c61ebe16-4114-4f18-96de-c747b14c01be.gif)\r\n\r\nthe relevant code:\r\n\r\n```erb\r\n<%= form_with(model: @product, url: update_cover_media_product_path(@product)) do |f| %>\r\n  <%= f.file_field :cover_media, class: 'file-input is-hidden', direct_upload: true, multiple: true %>\r\n\r\n  ...\r\n<% end %>\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45193/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45193/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45183","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45183/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45183/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45183/events","html_url":"https://github.com/rails/rails/issues/45183","id":1249340444,"node_id":"I_kwDNIULOSndsHA","number":45183,"title":"with_options does not work if first argument is proc and arity > 1","user":{"login":"gooocho","id":1038379,"node_id":"MDQ6VXNlcjEwMzgzNzk=","avatar_url":"https://avatars.githubusercontent.com/u/1038379?v=4","gravatar_id":"","url":"https://api.github.com/users/gooocho","html_url":"https://github.com/gooocho","followers_url":"https://api.github.com/users/gooocho/followers","following_url":"https://api.github.com/users/gooocho/following{/other_user}","gists_url":"https://api.github.com/users/gooocho/gists{/gist_id}","starred_url":"https://api.github.com/users/gooocho/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gooocho/subscriptions","organizations_url":"https://api.github.com/users/gooocho/orgs","repos_url":"https://api.github.com/users/gooocho/repos","events_url":"https://api.github.com/users/gooocho/events{/privacy}","received_events_url":"https://api.github.com/users/gooocho/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-26T09:43:03Z","updated_at":"2022-05-28T20:33:38Z","closed_at":"2022-05-28T20:33:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire 'active_support'\r\nrequire 'active_support/core_ext'\r\n\r\nclass Foo\r\n  def self.foo(val1, **hash1)\r\n    p val1, hash1\r\n  end\r\nend\r\nFoo.foo(10, b: 20) # ok\r\nFoo.foo(proc {}, b: 20) # ok\r\n\r\nclass Foo\r\n  with_options(a: 30) { foo(10, b: 20) } # ok\r\n  with_options(a: 30) { foo(proc {}, b: 20) } # raise\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nwith_options parameter is merged into last hash-like argument\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nraises error\r\n```\r\n`foo': wrong number of arguments (given 2, expected 1) (ArgumentError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.5\r\n\r\n**Ruby version**:\r\n3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45183/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45183/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45182","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45182/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45182/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45182/events","html_url":"https://github.com/rails/rails/issues/45182","id":1249337665,"node_id":"I_kwDNIULOSndhQQ","number":45182,"title":"`minitest` is a runtime dependency of `activesupport`","user":{"login":"pirj","id":6916,"node_id":"MDQ6VXNlcjY5MTY=","avatar_url":"https://avatars.githubusercontent.com/u/6916?v=4","gravatar_id":"","url":"https://api.github.com/users/pirj","html_url":"https://github.com/pirj","followers_url":"https://api.github.com/users/pirj/followers","following_url":"https://api.github.com/users/pirj/following{/other_user}","gists_url":"https://api.github.com/users/pirj/gists{/gist_id}","starred_url":"https://api.github.com/users/pirj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pirj/subscriptions","organizations_url":"https://api.github.com/users/pirj/orgs","repos_url":"https://api.github.com/users/pirj/repos","events_url":"https://api.github.com/users/pirj/events{/privacy}","received_events_url":"https://api.github.com/users/pirj/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-26T09:40:22Z","updated_at":"2022-08-17T00:46:22Z","closed_at":"2022-05-26T14:21:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI've noticed `minitest` in a project's `Gemfile.lock`, while the project exclusively uses RSpec.\r\nIt turns out that [`minitest` is a runtime dependency of `activesupport`](https://github.com/rails/rails/blob/4d5a570cfe1890f71a1d198a5fe40d528f2b60d4/activesupport/activesupport.gemspec#L40).\r\nOther Rails gems don't seem to specify `minitest` at all, e.g. [`activerecord`](https://github.com/rails/rails/blob/4d5a570cfe1890f71a1d198a5fe40d528f2b60d4/activerecord/activerecord.gemspec#L38), [`activejob`](https://github.com/rails/rails/blob/4d5a570cfe1890f71a1d198a5fe40d528f2b60d4/activejob/activejob.gemspec#L35).\r\n\r\nIt's not a big deal, but shaving off 150KB of code from each deployment is a nice bonus.\r\n\r\nI can track this down to [this commit](https://github.com/rails/rails/commit/6f74d36c4263a6cbbc6dc32a03edeed04faefbd9) that moved `minitest` from the `Gemfile` (development only) to `gemspec`.\r\n`add_development_dependency` was introduced a couple of years before this commit, [in `rubygems` 1.2](https://github.com/rubygems/rubygems/blob/master/CHANGELOG.md#120--2008-06-21) but probably Rails couldn't rely on a wider adoption. Now, nearly a decade later, this should be possible.\r\n\r\nI'll be happy to work on a PR for that.\r\n\r\n### Expected behavior\r\n\r\n1. `minitest` is a development dependency\r\n2. `minitest` is explicitly specified as a development dependency for each Rails gem\r\n\r\n### Actual behavior\r\n\r\n`minitest` is bundled along with the application code for production deployment\r\n\r\n### System configuration\r\n\r\n**Rails version**: 6.0.5 (4.0.0 up to latest 7.0)\r\n\r\n**Ruby version**: any\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45182/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45182/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45176","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45176/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45176/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45176/events","html_url":"https://github.com/rails/rails/issues/45176","id":1247744238,"node_id":"I_kwDNIULOSl8Q7g","number":45176,"title":"Rails.configuration.to_prepare","user":{"login":"fxn","id":3387,"node_id":"MDQ6VXNlcjMzODc=","avatar_url":"https://avatars.githubusercontent.com/u/3387?v=4","gravatar_id":"","url":"https://api.github.com/users/fxn","html_url":"https://github.com/fxn","followers_url":"https://api.github.com/users/fxn/followers","following_url":"https://api.github.com/users/fxn/following{/other_user}","gists_url":"https://api.github.com/users/fxn/gists{/gist_id}","starred_url":"https://api.github.com/users/fxn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fxn/subscriptions","organizations_url":"https://api.github.com/users/fxn/orgs","repos_url":"https://api.github.com/users/fxn/repos","events_url":"https://api.github.com/users/fxn/events{/privacy}","received_events_url":"https://api.github.com/users/fxn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-05-25T08:26:56Z","updated_at":"2022-07-30T12:22:21Z","closed_at":"2022-07-30T12:22:21Z","author_association":"MEMBER","active_lock_reason":null,"body":"(Moved from https://github.com/fxn/zeitwerk/issues/217).\r\n\r\nI'm updating from redmine 4 to redmine 5. When updating a plugin, it didn't work. I think the plugin's libraries couldn't be loaded. In the plugin's init.rb file, it's configured below\r\n`Rails.configuration.to_prepare do #ActiveSupport::Reloader.to_prepare`\r\n    `User.send :include, Patch::UserPatch`\r\n    `ApplicationController.send :include, Patch::ApplicationControllerPatch`\r\n`end`\r\nSo, what will be replaced for Rails.configuration.to_prepare in Zeitwerk?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45176/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45176/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45175","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45175/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45175/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45175/events","html_url":"https://github.com/rails/rails/issues/45175","id":1247382527,"node_id":"I_kwDNIULOSlmL_w","number":45175,"title":"DateTime#parse setting time zone not accounting for DST","user":{"login":"softwaregravy","id":426690,"node_id":"MDQ6VXNlcjQyNjY5MA==","avatar_url":"https://avatars.githubusercontent.com/u/426690?v=4","gravatar_id":"","url":"https://api.github.com/users/softwaregravy","html_url":"https://github.com/softwaregravy","followers_url":"https://api.github.com/users/softwaregravy/followers","following_url":"https://api.github.com/users/softwaregravy/following{/other_user}","gists_url":"https://api.github.com/users/softwaregravy/gists{/gist_id}","starred_url":"https://api.github.com/users/softwaregravy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/softwaregravy/subscriptions","organizations_url":"https://api.github.com/users/softwaregravy/orgs","repos_url":"https://api.github.com/users/softwaregravy/repos","events_url":"https://api.github.com/users/softwaregravy/events{/privacy}","received_events_url":"https://api.github.com/users/softwaregravy/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-25T02:41:52Z","updated_at":"2022-05-25T20:39:08Z","closed_at":"2022-05-25T17:57:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI believe `DateTime#parse` is not correctly accounting for daylight savings time in the date parse. \r\n\r\nWhen I run:\r\n```ruby\r\n3.1.2 :033 > DateTime.parse(\"2022-05-24T19:00 Pacific Time (US & Canada)\")\r\n => Tue, 24 May 2022 19:00:00 -0800\r\n```\r\nBut I would expect to get a -7 offset because in May, Pacific time is -7, not -8. We know this because today happens to be May 24th, so I can run:\r\n\r\n```ruby \r\n3.1.2 :032 > DateTime.current.in_time_zone(\"Pacific Time (US & Canada)\")\r\n => Tue, 24 May 2022 19:37:09.580579000 PDT -07:00\r\n```\r\n\r\n### Expected behavior\r\n```ruby \r\nDateTime.parse(\"2022-05-24T09:00 Pacific Time (US & Canada)\")\r\n=> Tue, 24 May 2022 09:00:00 -0700\r\n```\r\n\r\n### Additional Note\r\nThis leads us to this unfortunate state:\r\n\r\n```ruby\r\n3.1.2 :035 > DateTime.parse(\"2022-05-24T19:00 Pacific Time (US & Canada)\").in_time_zone(\"Pacific Time (US & Canada)\")\r\n => Tue, 24 May 2022 20:00:00.000000000 PDT -07:00\r\n```\r\nConverting into the time zone we thought we parsed in \"changes\" the time by an hour\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**:  3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45175/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45175/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45170","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45170/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45170/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45170/events","html_url":"https://github.com/rails/rails/issues/45170","id":1246601115,"node_id":"I_kwDNIULOSk2fmw","number":45170,"title":"Hash#to_xml generates invalid XML when keys are numbers","user":{"login":"lexafesyk","id":105284804,"node_id":"U_kgDOBkaExA","avatar_url":"https://avatars.githubusercontent.com/u/105284804?v=4","gravatar_id":"","url":"https://api.github.com/users/lexafesyk","html_url":"https://github.com/lexafesyk","followers_url":"https://api.github.com/users/lexafesyk/followers","following_url":"https://api.github.com/users/lexafesyk/following{/other_user}","gists_url":"https://api.github.com/users/lexafesyk/gists{/gist_id}","starred_url":"https://api.github.com/users/lexafesyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lexafesyk/subscriptions","organizations_url":"https://api.github.com/users/lexafesyk/orgs","repos_url":"https://api.github.com/users/lexafesyk/repos","events_url":"https://api.github.com/users/lexafesyk/events{/privacy}","received_events_url":"https://api.github.com/users/lexafesyk/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-05-24T13:56:56Z","updated_at":"2022-05-24T17:00:38Z","closed_at":"2022-05-24T16:55:36Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nCall to_xml on a hash that has integers/stringified integers keys.\r\n\r\n```ruby\r\n> hash = { 1 => 'foo' }\r\n=> {1=>\"foo\"}\r\n> hash.to_xml\r\n=> \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<hash>\\n  <1>foo</1>\\n</hash>\\n\"\r\n\r\n> hash = { '1' => 'foo' }\r\n=> {\"1\"=>\"foo\"}\r\n> hash.to_xml\r\n=> \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\\n<hash>\\n  <1>foo</1>\\n</hash>\\n\"\r\n```\r\n\r\n### Expected behavior\r\nValid XMLs expected\r\n\r\n### Actual behavior\r\nBoth generated XMLs are invalid since \"1\" is not a valid XML element. Element names must start with a letter or underscore. \r\n\r\n### System configuration\r\n**Rails version**: 6.1.5.1\r\n\r\n**Ruby version**: 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45170/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45170/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45167","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45167/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45167/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45167/events","html_url":"https://github.com/rails/rails/issues/45167","id":1245815829,"node_id":"I_kwDNIULOSkGkFQ","number":45167,"title":"CI against MariaDB has been failing","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":776781281,"node_id":"MDU6TGFiZWw3NzY3ODEyODE=","url":"https://api.github.com/repos/rails/rails/labels/ci%20issues","name":"ci issues","color":"aaafff","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-23T23:59:30Z","updated_at":"2022-05-24T15:19:08Z","closed_at":"2022-05-24T15:19:07Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nIt reproduces at Rails CI environment. \r\n\r\n- The first failing build\r\nhttps://buildkite.com/rails/rails/builds/86711#ebc53e55-14aa-4abf-819b-5928cbbe9938\r\n\r\n- The last successful build\r\nhttps://buildkite.com/rails/rails/builds/86701#2f3a5396-4237-47a5-b27c-cf6774c90bb6\r\n\r\n### Expected behavior\r\nCI against MariaDB should work.\r\n\r\n### Actual behavior\r\nhttps://buildkite.com/rails/rails/builds/86711#ebc53e55-14aa-4abf-819b-5928cbbe9938/1174-1175\r\n\r\n```sql\r\nmysqladmin: connect to server at 'mysql' failed\r\n--\r\n  | error: 'Unknown MySQL server host 'mysql' (-2)'\r\n  | Check that mysqld is running on mysql and that the port is 3306.\r\n  | You can check this by doing 'telnet mysql 3306'\r\n  | \u0007mysqladmin: connect to server at 'mysql' failed\r\n  | error: 'Unknown MySQL server host 'mysql' (-2)'\r\n  | Check that mysqld is running on mysql and that the port is 3306.\r\n  | You can check this by doing 'telnet mysql 3306'\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n  | ERROR 2005 (HY000): Unknown MySQL server host 'mysql' (-2)\r\n\r\n\r\n```\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:3.1.2p20 (2022-04-12 revision 4491bb740a9506d76391ac44bb2fe6e483fec952) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45167/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45167/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45165","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45165/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45165/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45165/events","html_url":"https://github.com/rails/rails/issues/45165","id":1245662679,"node_id":"I_kwDNIULOSj9N1w","number":45165,"title":"Error after upgrading: undefined method `content_tag' for ActionView::Base:Class.","user":{"login":"gregschmit","id":14255284,"node_id":"MDQ6VXNlcjE0MjU1Mjg0","avatar_url":"https://avatars.githubusercontent.com/u/14255284?v=4","gravatar_id":"","url":"https://api.github.com/users/gregschmit","html_url":"https://github.com/gregschmit","followers_url":"https://api.github.com/users/gregschmit/followers","following_url":"https://api.github.com/users/gregschmit/following{/other_user}","gists_url":"https://api.github.com/users/gregschmit/gists{/gist_id}","starred_url":"https://api.github.com/users/gregschmit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregschmit/subscriptions","organizations_url":"https://api.github.com/users/gregschmit/orgs","repos_url":"https://api.github.com/users/gregschmit/repos","events_url":"https://api.github.com/users/gregschmit/events{/privacy}","received_events_url":"https://api.github.com/users/gregschmit/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-05-23T20:28:25Z","updated_at":"2022-06-22T10:07:58Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I found this in a large project by upgrading to Rails 7 and I noticed a ton of Active Scaffold errors but after turning `BACKTRACE=1` on I found the culprit. In a Rails 6.0 project I can run `ActionView::Base.field_error_proc.call` and I get `\"<div class=\\\"field_with_errors\\\"></div>\"`, but in Rails 7 I get:\r\n\r\n```\r\n[1] pry(main)> ActionView::Base.field_error_proc.call\r\nNoMethodError: undefined method `content_tag' for ActionView::Base:Class\r\nDid you mean?  const_get\r\nfrom /Users/gns/.rvm/gems/ruby-2.7.2@rxg/gems/actionview-7.0.3/lib/action_view/base.rb:145:in `block in <class:Base>'\r\n```\r\n\r\n### Steps to reproduce\r\nOpen console in a Rail 7.0.3 project and run `ActionView::Base.field_error_proc.call`.\r\n\r\n### Expected behavior\r\nI would assume that `ActionView::Base.field_error_proc.call` should work just like it did in Rails 6.\r\n\r\n### Actual behavior\r\n```\r\n[1] pry(main)> ActionView::Base.field_error_proc.call\r\nNoMethodError: undefined method `content_tag' for ActionView::Base:Class\r\nDid you mean?  const_get\r\nfrom /Users/gns/.rvm/gems/ruby-2.7.2@rxg/gems/actionview-7.0.3/lib/action_view/base.rb:145:in `block in <class:Base>'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x86_64-darwin20]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45165/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45165/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45162","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45162/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45162/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45162/events","html_url":"https://github.com/rails/rails/issues/45162","id":1245583155,"node_id":"I_kwDNIULOSj4XMw","number":45162,"title":"config/initializers/multi_db doesn't work","user":{"login":"nate-at-gusto","id":82843455,"node_id":"MDQ6VXNlcjgyODQzNDU1","avatar_url":"https://avatars.githubusercontent.com/u/82843455?v=4","gravatar_id":"","url":"https://api.github.com/users/nate-at-gusto","html_url":"https://github.com/nate-at-gusto","followers_url":"https://api.github.com/users/nate-at-gusto/followers","following_url":"https://api.github.com/users/nate-at-gusto/following{/other_user}","gists_url":"https://api.github.com/users/nate-at-gusto/gists{/gist_id}","starred_url":"https://api.github.com/users/nate-at-gusto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nate-at-gusto/subscriptions","organizations_url":"https://api.github.com/users/nate-at-gusto/orgs","repos_url":"https://api.github.com/users/nate-at-gusto/repos","events_url":"https://api.github.com/users/nate-at-gusto/events{/privacy}","received_events_url":"https://api.github.com/users/nate-at-gusto/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2022-05-23T19:04:13Z","updated_at":"2022-08-11T04:02:24Z","closed_at":"2022-06-15T17:27:07Z","author_association":"NONE","active_lock_reason":null,"body":"It doesn't insert the database selector middleware, because the railtie which inserts it has already run by the time the initializer is run.\r\n\r\n## Repro \r\n\r\n[See repo here.](https://github.com/nate-at-gusto/multidb-dont-work)\r\n\r\n```\r\nbin/rails test test/integration/replica_test.rb \r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45162/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45162/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45158","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45158/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45158/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45158/events","html_url":"https://github.com/rails/rails/issues/45158","id":1245394925,"node_id":"I_kwDNIULOSjs37Q","number":45158,"title":"test_db:prepare_creates_test_database_if_it_does_not_exist fails","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":776781281,"node_id":"MDU6TGFiZWw3NzY3ODEyODE=","url":"https://api.github.com/repos/rails/rails/labels/ci%20issues","name":"ci issues","color":"aaafff","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-23T15:59:24Z","updated_at":"2022-05-26T15:46:16Z","closed_at":"2022-05-26T15:46:16Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/86697#914ae9c5-1469-4269-b24b-202e6b5e07f0 via https://github.com/rails/rails/pull/45157\r\n\r\n### Steps to reproduce\r\n```ruby\r\n$ cd railties\r\n$ bin/test test/application/rake/dbs_test.rb --seed 8301 -n \"/^(?:ApplicationTests::RakeTests::RakeDbsTest#(?:test_db:drop_failure_because_database_does_not_exist|test_db:create_works_when_schema_cache_exists_and_database_does_not_exist|test_db:prepare_creates_test_database_if_it_does_not_exist))$/\"\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ bin/test test/application/rake/dbs_test.rb --seed 8301 -n \"/^(?:ApplicationTests::RakeTests::RakeDbsTest#(?:test_db:drop_failure_because_database_does_not_exist|test_db:create_works_when_schema_cache_exists_and_database_does_not_exist|test_db:prepare_creates_test_database_if_it_does_not_exist))$/\"\r\nRun options: --seed 8301 -n \"/^(?:ApplicationTests::RakeTests::RakeDbsTest#(?:test_db:drop_failure_because_database_does_not_exist|test_db:create_works_when_schema_cache_exists_and_database_does_not_exist|test_db:prepare_creates_test_database_if_it_does_not_exist))$/\"\r\n\r\n# Running:\r\n\r\n.E\r\n\r\nError:\r\nApplicationTests::RakeTests::RakeDbsTest#test_db:prepare_creates_test_database_if_it_does_not_exist:\r\nRuntimeError: rails command failed (1): bin/rails db:drop db:create 2>&1\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:687: warning: conflicting chdir during another chdir block\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:708: warning: conflicting chdir during another chdir block\r\nDropped database 'railties_development'\r\nDropped database 'railties_test'\r\nPG::UniqueViolation: ERROR:  duplicate key value violates unique constraint \"pg_database_datname_index\"\r\nDETAIL:  Key (datname)=(railties_development) already exists.\r\nCouldn't create 'railties_development' database. Please check your configuration.\r\nrails aborted!\r\nActiveRecord::RecordNotUnique: PG::UniqueViolation: ERROR:  duplicate key value violates unique constraint \"pg_database_datname_index\"\r\nDETAIL:  Key (datname)=(railties_development) already exists.\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220524-106385-tf2m4v/app/bin/rails:4:in `<top (required)>'\r\n\r\nCaused by:\r\nPG::UniqueViolation: ERROR:  duplicate key value violates unique constraint \"pg_database_datname_index\"\r\nDETAIL:  Key (datname)=(railties_development) already exists.\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220524-106385-tf2m4v/app/bin/rails:4:in `<top (required)>'\r\nTasks: TOP => db:create\r\n(See full trace by running task with --trace)\r\n\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/isolation/abstract_unit.rb:390:in `rails'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/dbs_test.rb:739:in `block (2 levels) in <class:RakeDbsTest>'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/dbs_test.rb:737:in `chdir'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/dbs_test.rb:737:in `block in <class:RakeDbsTest>'\r\n\r\n\r\nbin/test test/application/rake/dbs_test.rb:736\r\n\r\n.\r\n\r\nFinished in 3.422332s, 0.8766 runs/s, 0.8766 assertions/s.\r\n3 runs, 3 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45158/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45158/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45152","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45152/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45152/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45152/events","html_url":"https://github.com/rails/rails/issues/45152","id":1244195516,"node_id":"I_kwDNIULOSijqvA","number":45152,"title":"Delegator parent is never touched ","user":{"login":"lazaronixon","id":2651240,"node_id":"MDQ6VXNlcjI2NTEyNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2651240?v=4","gravatar_id":"","url":"https://api.github.com/users/lazaronixon","html_url":"https://github.com/lazaronixon","followers_url":"https://api.github.com/users/lazaronixon/followers","following_url":"https://api.github.com/users/lazaronixon/following{/other_user}","gists_url":"https://api.github.com/users/lazaronixon/gists{/gist_id}","starred_url":"https://api.github.com/users/lazaronixon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazaronixon/subscriptions","organizations_url":"https://api.github.com/users/lazaronixon/orgs","repos_url":"https://api.github.com/users/lazaronixon/repos","events_url":"https://api.github.com/users/lazaronixon/events{/privacy}","received_events_url":"https://api.github.com/users/lazaronixon/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-22T09:09:11Z","updated_at":"2022-08-29T23:57:49Z","closed_at":"2022-08-29T23:57:49Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n    t.datetime :created_at, null: false\r\n    t.datetime :updated_at, null: false\r\n  end\r\n\r\n  create_table :profiles, force: true do |t|\r\n    t.bigint :user_id\r\n    t.string :profilable_type\r\n    t.bigint :profilable_id\r\n\r\n    #t.datetime :created_at, null: false\r\n    #t.datetime :updated_at, null: false\r\n  end\r\n\r\n  create_table :doctors, force: true do |t|\r\n    t.string :name\r\n\r\n    #t.datetime :created_at, null: false\r\n    #t.datetime :updated_at, null: false\r\n  end\r\n\r\n  create_table :patients, force: true do |t|\r\n    t.string :name\r\n\r\n    #t.datetime :created_at, null: false\r\n    #t.datetime :updated_at, null: false\r\n  end\r\n\r\n  create_table :skills, force: true do |t|\r\n    t.bigint :doctor_id\r\n    t.string :name\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one :profile\r\nend\r\n\r\nclass Profile < ActiveRecord::Base\r\n  delegated_type :profilable, types: %w[ doctor patient ]\r\n\r\n  belongs_to :user, touch: true\r\nend\r\n\r\nclass Patient < ActiveRecord::Base\r\n  has_one :profile, as: :profilable, touch: true\r\nend\r\n\r\nclass Doctor < ActiveRecord::Base\r\n  has_one  :profile, as: :profilable, touch: true\r\n  has_many :skills\r\nend\r\n\r\nclass Skill < ActiveRecord::Base\r\n  belongs_to :doctor, touch: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_touching_user_after_add_doctors_skill\r\n    new_doctor  = Doctor.new name: \"sebastian\"\r\n    new_profile = Profile.new profilable: new_doctor\r\n\r\n    user = User.create!(profile: new_profile)\r\n\r\n    # previously_doctor_updated_at  = user.profile.profilable.updated_at\r\n    # previously_profile_updated_at = user.profile.updated_at\r\n    previously_user_updated_at    = user.updated_at\r\n\r\n    user.profile.profilable.skills.create!(name: \"diabetes_management\")\r\n\r\n    # assert(previously_doctor_updated_at  != user.profile.profilable.reload.updated_at) # ok\r\n    # assert(previously_profile_updated_at != user.profile.reload.updated_at) # ok\r\n    assert(previously_user_updated_at    != user.reload.updated_at) # failed\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n1 - When a doctors' skill is added, the user should be touched since the touch flow is skill -> doctor -> profile -> user. \r\n2 - If there's no timestamps on the doctor, the profile should be touched as well.\r\n\r\n### Actual behavior\r\n1 - When a doctor's skill is added, doctor and profile are touched, but not the user.\r\n2 - If there's no timestamps on the doctor, the profile is not touched along with the user.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.3\r\n\r\n**Ruby version**:\r\nRuby ruby 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45152/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45152/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45146","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45146/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45146/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45146/events","html_url":"https://github.com/rails/rails/issues/45146","id":1243920536,"node_id":"I_kwDNIULOSiS4mA","number":45146,"title":"img src changes to http://example.org after a partial broadcast_update","user":{"login":"giuseb","id":10086,"node_id":"MDQ6VXNlcjEwMDg2","avatar_url":"https://avatars.githubusercontent.com/u/10086?v=4","gravatar_id":"","url":"https://api.github.com/users/giuseb","html_url":"https://github.com/giuseb","followers_url":"https://api.github.com/users/giuseb/followers","following_url":"https://api.github.com/users/giuseb/following{/other_user}","gists_url":"https://api.github.com/users/giuseb/gists{/gist_id}","starred_url":"https://api.github.com/users/giuseb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/giuseb/subscriptions","organizations_url":"https://api.github.com/users/giuseb/orgs","repos_url":"https://api.github.com/users/giuseb/repos","events_url":"https://api.github.com/users/giuseb/events{/privacy}","received_events_url":"https://api.github.com/users/giuseb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-05-21T08:53:42Z","updated_at":"2022-06-14T16:18:41Z","closed_at":"2022-06-14T16:18:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThe model:\r\n```ruby\r\nclass User < ApplicationRecord\r\n  has_one_attached :avatar\r\nend\r\n```\r\n\r\nThe view:\r\n```erb\r\n<%= turbo_stream_from @user %>\r\n<p><%= @user.name %></p>\r\n<div id=\"avatar\">\r\n  <%= render partial: \"users/avatar\", locals: {user: @user} %>\r\n</div>\r\n```\r\n\r\nThe partial:\r\n```erb\r\n<%= image_tag user.avatar %>\r\n```\r\n\r\nWith this resulting HTML, the image looks fine:\r\n```html\r\n<img src=\"http://localhost:3000/rails/active_storage/blobs/redirect/YADAYADA/b6dd.jpg\">\r\n```\r\n\r\nNow, however, in the console:\r\n```irb\r\nirb(main):001:0> User.last.broadcast_update target: \"avatar\", partial: \"users/avatar\"\r\n```\r\n### Expected behavior\r\n\r\nNothing should change on the page\r\n\r\n### Actual behavior\r\n\r\nIn the broadcast, `localhost` is replaced with `example.org`:\r\n\r\n```\r\nTurbo::StreamsChannel transmitting \"<turbo-stream action=\\\"update\\\" target=\\\"avatar\\\"><template><img src=\\\"http://example.org/rails/active_storage/blobs/redirect/YADAYADA/b6dd.jpg\\\" />\\n</te... (via streamed from Z2lkOi8vaGd1aWRlL1VzZXJ2aWV3LzE2Mw)\r\n```\r\n\r\nThe image is now broken, as the rendered HTML changes to:\r\n\r\n``` html\r\n<div id=\"avatar>\r\n  <img src=\"http://example.org/rails/active_storage/blobs/redirect/YADAYADA/b6dd.jpg\">\r\n</div>\r\n```\r\n\r\n_**Please note that the same problem occurs in a production environment.**_\r\n\r\n### System configuration\r\n\r\n- ruby 3.1.2\r\n- rails 7.0.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45146/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45146/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45139","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45139/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45139/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45139/events","html_url":"https://github.com/rails/rails/issues/45139","id":1242770844,"node_id":"I_kwDNIULOShMtnA","number":45139,"title":"Proposal: Improve logging format from QueryLogs","user":{"login":"modulitos","id":4207017,"node_id":"MDQ6VXNlcjQyMDcwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/4207017?v=4","gravatar_id":"","url":"https://api.github.com/users/modulitos","html_url":"https://github.com/modulitos","followers_url":"https://api.github.com/users/modulitos/followers","following_url":"https://api.github.com/users/modulitos/following{/other_user}","gists_url":"https://api.github.com/users/modulitos/gists{/gist_id}","starred_url":"https://api.github.com/users/modulitos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/modulitos/subscriptions","organizations_url":"https://api.github.com/users/modulitos/orgs","repos_url":"https://api.github.com/users/modulitos/repos","events_url":"https://api.github.com/users/modulitos/events{/privacy}","received_events_url":"https://api.github.com/users/modulitos/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-20T07:54:02Z","updated_at":"2022-09-02T21:15:15Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"**Note: This proposal is currently being implemented here: https://github.com/rails/rails/pull/45081**\r\n\r\nI’m looking for feedback on a proposal to improve the formatting of auto-injected SQL comments in Rails 7 (via [QueryLogs](https://blog.saeloun.com/2021/09/15/rails-maginalia-query-logs.html)). It seems like the current format for SQL comments isn’t correct, because:\r\n\r\n1. It isn’t really machine-readable\r\n2. It doesn’t adhere to existing standards, like [sqlcommenter](https://open-telemetry.github.io/opentelemetry-sqlcommenter/ruby/)\r\n\r\nFor example, auto-commented SQL queries using Marginalia/Rails look like this:\r\n`\"select id from posts; /*application:Joe's app,controller:my_controller*/\"`\r\n\r\nand I'm proposing a format to use the “sqlcommenter” syntax like so:\r\n`\"select id from posts; /*application='Joe\\\\'s app',controller='my_controller'*/\"`\r\n\r\nThe latter can be parsed much more easily, and will also automatically report metrics by [databases that support the sqlcommenter formatting](https://cloud.google.com/sql/docs/postgres/using-query-insights#adding-tags-to-sql-queries).\r\n\r\nThis also feels like a good time to propose a change because it's relatively new functionality, before too many folks develop a dependency on the format.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45139/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45139/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45133","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45133/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45133/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45133/events","html_url":"https://github.com/rails/rails/issues/45133","id":1242035995,"node_id":"I_kwDNIULOSgf3Gw","number":45133,"title":"Suggestion: \"ActiveDocument\" Rails + NoSql","user":{"login":"johnnyshields","id":27655,"node_id":"MDQ6VXNlcjI3NjU1","avatar_url":"https://avatars.githubusercontent.com/u/27655?v=4","gravatar_id":"","url":"https://api.github.com/users/johnnyshields","html_url":"https://github.com/johnnyshields","followers_url":"https://api.github.com/users/johnnyshields/followers","following_url":"https://api.github.com/users/johnnyshields/following{/other_user}","gists_url":"https://api.github.com/users/johnnyshields/gists{/gist_id}","starred_url":"https://api.github.com/users/johnnyshields/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/johnnyshields/subscriptions","organizations_url":"https://api.github.com/users/johnnyshields/orgs","repos_url":"https://api.github.com/users/johnnyshields/repos","events_url":"https://api.github.com/users/johnnyshields/events{/privacy}","received_events_url":"https://api.github.com/users/johnnyshields/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-19T16:35:27Z","updated_at":"2022-05-19T17:12:15Z","closed_at":"2022-05-19T17:12:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Throwing an idea out there: \"ActiveDocument\", equivalent to ActiveRecord but to provide first class support for NoSQL databases.\r\n\r\nThere are a number of DBs out there: Couchbase, MongoDB, Elasticsearch, Amazon DynamoDB, etc. In many of these cases the vendor is making its own platform-specific gem. Perhaps its time for Rails team to take ownership here? Thoughts?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45133/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45133/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45132","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45132/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45132/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45132/events","html_url":"https://github.com/rails/rails/issues/45132","id":1242019726,"node_id":"I_kwDNIULOSge3jg","number":45132,"title":"has_one generates incorrect queries","user":{"login":"danielwaterworth","id":663767,"node_id":"MDQ6VXNlcjY2Mzc2Nw==","avatar_url":"https://avatars.githubusercontent.com/u/663767?v=4","gravatar_id":"","url":"https://api.github.com/users/danielwaterworth","html_url":"https://github.com/danielwaterworth","followers_url":"https://api.github.com/users/danielwaterworth/followers","following_url":"https://api.github.com/users/danielwaterworth/following{/other_user}","gists_url":"https://api.github.com/users/danielwaterworth/gists{/gist_id}","starred_url":"https://api.github.com/users/danielwaterworth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielwaterworth/subscriptions","organizations_url":"https://api.github.com/users/danielwaterworth/orgs","repos_url":"https://api.github.com/users/danielwaterworth/repos","events_url":"https://api.github.com/users/danielwaterworth/events{/privacy}","received_events_url":"https://api.github.com/users/danielwaterworth/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-19T16:20:03Z","updated_at":"2022-08-26T19:10:44Z","closed_at":"2022-08-26T19:10:44Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n### Expected behavior\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :things, force: true do |t|\r\n    t.integer :parent_id\r\n  end\r\nend\r\n\r\nclass Thing < ActiveRecord::Base\r\n  belongs_to :parent, foreign_key: :parent_id, class_name: :Thing\r\n  has_one :child, foreign_key: :parent_id, class_name: :Thing\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    parent_without_child = Thing.create!(parent_id: nil)\r\n    parent_with_child = Thing.create!(parent_id: nil)\r\n    child = Thing.create!(parent: parent_with_child)\r\n\r\n    # Here are 4 queries that I believe should be equivalent, but they are not.\r\n\r\n    # These two queries produce correct results\r\n    correct_queries = [\r\n      Thing.where.not(child: Thing.all.to_a).to_a,\r\n      Thing.where.not(child: Thing.where.not(parent_id: nil)).to_a,\r\n    ]\r\n\r\n    correct_queries.each do |things_without_children|\r\n      assert_includes(things_without_children, parent_without_child)\r\n      refute_includes(things_without_children, parent_with_child)\r\n      assert_includes(things_without_children, child)\r\n    end\r\n\r\n    # These two produce incorrect results\r\n    incorrect_queries = [\r\n      Thing.where.not(child: Thing.all).to_a,\r\n      Thing.where(child: nil).to_a,\r\n    ]\r\n\r\n    incorrect_queries.each do |things_without_children|\r\n      assert_includes(things_without_children, parent_without_child)\r\n      refute_includes(things_without_children, parent_with_child)\r\n      assert_includes(things_without_children, child)\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.3\r\n\r\n**Ruby version**:\r\n\r\n3.0.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45132/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45132/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45131","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45131/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45131/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45131/events","html_url":"https://github.com/rails/rails/issues/45131","id":1241835698,"node_id":"I_kwDNIULOSgTosg","number":45131,"title":"WebSocket connection failed: WebSocket is closed before the connection is established.","user":{"login":"salmagomaa","id":11189174,"node_id":"MDQ6VXNlcjExMTg5MTc0","avatar_url":"https://avatars.githubusercontent.com/u/11189174?v=4","gravatar_id":"","url":"https://api.github.com/users/salmagomaa","html_url":"https://github.com/salmagomaa","followers_url":"https://api.github.com/users/salmagomaa/followers","following_url":"https://api.github.com/users/salmagomaa/following{/other_user}","gists_url":"https://api.github.com/users/salmagomaa/gists{/gist_id}","starred_url":"https://api.github.com/users/salmagomaa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/salmagomaa/subscriptions","organizations_url":"https://api.github.com/users/salmagomaa/orgs","repos_url":"https://api.github.com/users/salmagomaa/repos","events_url":"https://api.github.com/users/salmagomaa/events{/privacy}","received_events_url":"https://api.github.com/users/salmagomaa/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-19T13:59:53Z","updated_at":"2022-09-04T17:43:48Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I am facing a problem when the connected users be more than 2 users (2 channels not sessions)\r\n\r\nThe error is:\r\n```\r\nWebSocket connection  failed: WebSocket is closed before the connection is established.\r\n```\r\nHere you are the recent scenario we have:\r\n1. Browser 1: Login with user 1 and create a post\r\n2. Browser 2: Login with user 2\r\n3. Browser 3: Login with user 3\r\n--------------------------------------------------------------\r\n5. Browser 2: Add a comment to the post created by user 1 in browser 1\r\n6. Browser 3: Add a comment to the post created by user 1 in browser 1\r\n--------------------------------------------------------------\r\n7. Browser 1: Should receives the notifications of the two comments without refreshing\r\n--------------------------------------------------------------\r\n8. Browser 1: Reply for the comment added by user 2 in browser 2\r\n9. Browser 1: Reply for the comment added by user 3 in browser 3\r\n--------------------------------------------------------------\r\n10. Browser 2: Should receives the notification of replying without refresh\r\n11. Browser 3: Should receives the notification of replying without refresh\r\n----------------------------------------------------------------\r\nBut unfortunately, I didn't receive any notifications\r\nWhen I tried the same scenario using 2 users only, it works properly\r\n\r\nConclusion:\r\nThe real-time stops and websocket error appears depending on the number of connected users\r\n\r\nAnyone can help me please?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45131/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45131/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45130","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45130/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45130/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45130/events","html_url":"https://github.com/rails/rails/issues/45130","id":1241820374,"node_id":"I_kwDNIULOSgSs1g","number":45130,"title":"`rename_table` does not work for tables with very long table names when using PostgreSQL","user":{"login":"martingregoire","id":16133932,"node_id":"MDQ6VXNlcjE2MTMzOTMy","avatar_url":"https://avatars.githubusercontent.com/u/16133932?v=4","gravatar_id":"","url":"https://api.github.com/users/martingregoire","html_url":"https://github.com/martingregoire","followers_url":"https://api.github.com/users/martingregoire/followers","following_url":"https://api.github.com/users/martingregoire/following{/other_user}","gists_url":"https://api.github.com/users/martingregoire/gists{/gist_id}","starred_url":"https://api.github.com/users/martingregoire/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martingregoire/subscriptions","organizations_url":"https://api.github.com/users/martingregoire/orgs","repos_url":"https://api.github.com/users/martingregoire/repos","events_url":"https://api.github.com/users/martingregoire/events{/privacy}","received_events_url":"https://api.github.com/users/martingregoire/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-05-19T13:51:33Z","updated_at":"2022-06-13T18:27:40Z","closed_at":"2022-06-13T18:27:40Z","author_association":"NONE","active_lock_reason":null,"body":"Index names in PostgreSQL are limited to 64 characters. When creating a table with a very long name, the name of the index for the primary key is automatically truncated (by PotsgreSQL) so that it fits in 64 characters.\r\n\r\nWhen trying to rename such a table, ActiveRecord apparently infers a wrong index name.\r\n\r\n### Steps to reproduce\r\n:warning: First you have to start a postgres server. Do this with `docker run --rm -e POSTGRES_PASSWORD=mysecretpassword -p \"5432:5432\" postgres:14.3`\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"postgresql\", host: \"localhost\", username: 'postgres', password: 'mysecretpassword')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass BlorgMigration < ActiveRecord::Migration[7.0]\r\n  def change\r\n    create_table(:this_works)\r\n    create_table(:this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet)\r\n    rename_table(:this_works, :this_still_works)\r\n    rename_table(:this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet, :this_is_broken)\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    BlorgMigration.migrate(:up)\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nThis migration should run without throwing an error\r\n\r\n### Actual behavior\r\nThis migration throws the following error:\r\n\r\n```\r\nActiveRecord::StatementInvalid: PG::UndefinedTable: ERROR:  relation \"this_is_a_really_long_table_name_for_all_banana_plants_on_this_\" does not exist\r\n```\r\n\r\n### Log\r\n\r\nIn the logfile we can see that renaming the table does work, but renaming the index (created for the primary key) does not:\r\n\r\n```\r\n==  BlorgMigration: migrating =================================================\r\n-- create_table(:this_works)\r\nD, [2022-05-19T15:40:45.310776 #158967] DEBUG -- :    (11.4ms)  CREATE TABLE \"this_works\" (\"id\" bigserial primary key)\r\n   -> 0.0120s\r\n-- create_table(:this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet)\r\nD, [2022-05-19T15:40:45.318886 #158967] DEBUG -- :    (7.5ms)  CREATE TABLE \"this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet\" (\"id\" bigserial primary key)\r\n   -> 0.0079s\r\n-- rename_table(:this_works, :this_still_works)\r\nD, [2022-05-19T15:40:45.322836 #158967] DEBUG -- :    (2.6ms)  ALTER TABLE \"this_works\" RENAME TO \"this_still_works\"\r\nD, [2022-05-19T15:40:45.328821 #158967] DEBUG -- :    (2.8ms)  ALTER INDEX \"this_works_pkey\" RENAME TO \"this_still_works_pkey\"\r\nD, [2022-05-19T15:40:45.331602 #158967] DEBUG -- :    (2.6ms)  ALTER TABLE \"public\".\"this_works_id_seq\" RENAME TO \"this_still_works_id_seq\"\r\n   -> 0.0144s\r\n-- rename_table(:this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet, :this_is_broken)\r\nD, [2022-05-19T15:40:45.336856 #158967] DEBUG -- :    (2.9ms)  ALTER TABLE \"this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet\" RENAME TO \"this_is_broken\"\r\nD, [2022-05-19T15:40:45.338502 #158967] DEBUG -- :    (0.4ms)  ALTER INDEX \"this_is_a_really_long_table_name_for_all_banana_plants_on_this_planet_pkey\" RENAME TO \"this_is_broken_pkey\"\r\nE\r\n```\r\n\r\n### System configuration\r\n**Ruby version**: ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45130/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45130/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45128","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45128/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45128/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45128/events","html_url":"https://github.com/rails/rails/issues/45128","id":1240742947,"node_id":"I_kwDNIULOSfQ8Iw","number":45128,"title":"Decryption is not working for IN queries","user":{"login":"lazaronixon","id":2651240,"node_id":"MDQ6VXNlcjI2NTEyNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2651240?v=4","gravatar_id":"","url":"https://api.github.com/users/lazaronixon","html_url":"https://github.com/lazaronixon","followers_url":"https://api.github.com/users/lazaronixon/followers","following_url":"https://api.github.com/users/lazaronixon/following{/other_user}","gists_url":"https://api.github.com/users/lazaronixon/gists{/gist_id}","starred_url":"https://api.github.com/users/lazaronixon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazaronixon/subscriptions","organizations_url":"https://api.github.com/users/lazaronixon/orgs","repos_url":"https://api.github.com/users/lazaronixon/repos","events_url":"https://api.github.com/users/lazaronixon/events{/privacy}","received_events_url":"https://api.github.com/users/lazaronixon/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-18T23:45:34Z","updated_at":"2022-05-19T00:15:12Z","closed_at":"2022-05-19T00:04:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Active record encryption is not decrypting array parameters. \r\n- It doesn't work. `Physician.where(occupation: [\"one\", \"two\"])`\r\n- It works with arrays with a single value. `Physician.where(occupation: [\"one\"])`\r\n- It works with has_many. `Physician.where(languages: { name: [\"PT\", \"EN\"] })`\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nclass Physician < ApplicationRecord\r\n  encrypts :medical_school, :degree, :occupation, deterministic: true\r\nend\r\n```\r\n\r\n```ruby\r\nPhysician.where(occupation: [\"one\", \"two\"])\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n```SQL\r\nSELECT * FROM \"physicians\" WHERE \"physicians\".\"occupation\" IN ($1, $2) [\"occupation\", \"one\"], [\"occupation\", \"two\"]\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n```SQL\r\nSELECT * FROM \"physicians\" WHERE \"physicians\".\"occupation\" IN ($1, $2) [\"occupation\", \"encrypted\"], [\"occupation\", \"encrypted\"]\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45128/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45128/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45121","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45121/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45121/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45121/events","html_url":"https://github.com/rails/rails/issues/45121","id":1239293187,"node_id":"I_kwDNIULOSd4dAw","number":45121,"title":"Very long test output even for simple failing tests","user":{"login":"mhartl","id":6232,"node_id":"MDQ6VXNlcjYyMzI=","avatar_url":"https://avatars.githubusercontent.com/u/6232?v=4","gravatar_id":"","url":"https://api.github.com/users/mhartl","html_url":"https://github.com/mhartl","followers_url":"https://api.github.com/users/mhartl/followers","following_url":"https://api.github.com/users/mhartl/following{/other_user}","gists_url":"https://api.github.com/users/mhartl/gists{/gist_id}","starred_url":"https://api.github.com/users/mhartl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mhartl/subscriptions","organizations_url":"https://api.github.com/users/mhartl/orgs","repos_url":"https://api.github.com/users/mhartl/repos","events_url":"https://api.github.com/users/mhartl/events{/privacy}","received_events_url":"https://api.github.com/users/mhartl/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-18T00:34:28Z","updated_at":"2022-08-24T20:45:52Z","closed_at":"2022-08-24T20:45:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThe test output in some cases is extremely long, making it difficult to see what the error is. (As far as I can tell, this is a regression; I don’t recall the issue being present in earlier versions of Rails.) The issue is currently affecting readers of the *Ruby on Rails Tutorial* 7th edition, including me (its author).\r\n\r\nThe issue is easy to reproduce with the latest version of Rails (7.0.3 as of this writing) and a simple generated Pages controller (with one action, `home`):\r\n\r\n```\r\n$ gem install rails -v 7.0.3\r\n$ rails _7.0.3_ new test_output_app\r\n$ cd test_output_app/\r\n$ rails generate controller Pages home\r\n$ rails test\r\nRunning 1 tests in a single process (parallelization threshold is 50)\r\nRun options: --seed 60583\r\n\r\n# Running:\r\n\r\n.\r\n\r\nFinished in 0.616127s, 1.6230 runs/s, 1.6230 assertions/s.\r\n1 runs, 1 assertions, 0 failures, 0 errors, 0 skips\r\n```\r\n\r\nThe tests initially pass, but we can reproduce the issue by commenting out the route for the home page in `config/routes.rb`:\r\n\r\n```\r\nRails.application.routes.draw do\r\n  # get 'pages/home'        <-- this is the line that should be commented out\r\n  # Define your application routes per the DSL in https://guides.rubyonrails.org/routing.html\r\n\r\n  # Defines the root path route (\"/\")\r\n  # root \"articles#index\"\r\nend\r\n```\r\n\r\nThis causes the generated test in `test/controllers/pages_controller_test.rb` to fail because `pages_home_url` is no longer defined:\r\n\r\n```\r\nrequire \"test_helper\"\r\n\r\nclass PagesControllerTest < ActionDispatch::IntegrationTest\r\n  test \"should get home\" do\r\n    get pages_home_url\r\n    assert_response :success\r\n  end\r\nend\r\n```\r\n\r\nAt this point, running `rails test` outputs a tremendous volume of text:\r\n\r\n```\r\n$ rails test\r\nRunning 1 tests in a single process (parallelization threshold is 50)\r\nRun options: --seed 23908\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nPagesControllerTest#test_should_get_home:\r\nNameError: undefined local variable or method `pages_home_url' for \r\n.\r\n.\r\n.\r\n```\r\n\r\nThe vertical dots here indicate a large amount of omitted text.\r\n\r\n### Expected behavior\r\n\r\nThe output of `rails test` for this single failing test should be fairly short, making it easy to identify the precise issue and file line number—something like this:\r\n\r\n```\r\n$ rails test\r\nRunning 1 tests in a single process (parallelization threshold is 50)\r\nRun options: --seed 23908\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nPagesControllerTest#test_should_get_home:\r\nNameError: undefined local variable or method `pages_home_url' for #<PagesControllerTest:0x0000000104f598a8>\r\nrails test test/controllers/pages_controller_test.rb:4\r\n\r\n\r\n\r\nFinished in 0.122953s, 8.1332 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n```\r\n\r\nThis would work out to around 50 words and 440 characters of total output.\r\n\r\n### Actual behavior\r\n\r\nThe actual output is enormous—over 9,000 words and nearly 320,000 characters of total output:\r\n\r\n```\r\n$ rails test | wc\r\n      18    9049  319394\r\n```\r\n\r\nThe output is so voluminous that on many systems (including mine) it overflows the terminal’s ability to scroll back. It’s possible to route around the problem in a narrow sense by piping to `grep`, but this is an awkward hack, doesn’t work well when there are multiple failing tests, and doesn’t work at all with an automated test runner like Guard.\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n\r\nI have reproduced the issue both on my MacBook (running macOS Monterey 12.3.1) and on AWS Cloud9 (running Ubuntu Linux).\r\n\r\nN.B. [This Stack Overflow issue](https://stackoverflow.com/questions/66593801/rails-test-command-prints-out-a-very-long-output) seems to allude to the same behavior, though unfortunately no solution has been forthcoming.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45121/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45121/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45117","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45117/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45117/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45117/events","html_url":"https://github.com/rails/rails/issues/45117","id":1238922915,"node_id":"I_kwDNIULOSdh2ow","number":45117,"title":"ComparisonValidator example code does not work","user":{"login":"shiroemons","id":800753,"node_id":"MDQ6VXNlcjgwMDc1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/800753?v=4","gravatar_id":"","url":"https://api.github.com/users/shiroemons","html_url":"https://github.com/shiroemons","followers_url":"https://api.github.com/users/shiroemons/followers","following_url":"https://api.github.com/users/shiroemons/following{/other_user}","gists_url":"https://api.github.com/users/shiroemons/gists{/gist_id}","starred_url":"https://api.github.com/users/shiroemons/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shiroemons/subscriptions","organizations_url":"https://api.github.com/users/shiroemons/orgs","repos_url":"https://api.github.com/users/shiroemons/repos","events_url":"https://api.github.com/users/shiroemons/events{/privacy}","received_events_url":"https://api.github.com/users/shiroemons/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-17T16:59:11Z","updated_at":"2022-05-18T18:08:47Z","closed_at":"2022-05-18T18:08:47Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", \"7.0.3\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :people, force: true do |t|\r\n    t.date :birth_date\r\n  end\r\nend\r\n\r\nclass Person < ActiveRecord::Base\r\n  validates_comparison_of :birth_date, less_than_or_equal_to: -> { Date.today }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_comparison_validator\r\n    person = Person.create!(birth_date: Date.yesterday)\r\n\r\n    assert_equal 1, Person.count\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n```\r\n1 runs, 1 assertions, 0 failures, 0 errors, 0 skips\r\n```\r\n\r\n### Actual behavior\r\n\r\n```\r\nError:\r\nBugTest#test_comparison_validator:\r\nActiveRecord::RecordInvalid: Validation failed: Birth date wrong number of arguments (given 1, expected 0)\r\n\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n```\r\n\r\nI tried example code.\r\nhttps://github.com/rails/rails/blob/v7.0.3/activemodel/lib/active_model/validations/comparison.rb#L74=\r\n```ruby\r\n      # For example:\r\n      #\r\n      #   class Person < ActiveRecord::Base\r\n      #     validates_comparison_of :birth_date, less_than_or_equal_to: -> { Date.today }\r\n      #     validates_comparison_of :preferred_name, other_than: :given_name, allow_nil: true\r\n      #   end\r\n```\r\n\r\nPR: https://github.com/rails/rails/pull/40095\r\nThere seems to be no test for `-> { }`.\r\n\r\nThis works.\r\n```ruby\r\nvalidates_comparison_of :birth_date, less_than_or_equal_to: Proc.new { Date.today }\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45117/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45117/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45114","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45114/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45114/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45114/events","html_url":"https://github.com/rails/rails/issues/45114","id":1237866820,"node_id":"I_kwDNIULOSchZRA","number":45114,"title":"test_db:prepare_runs_seeds_once fails as ERROR:  relation \"dogs\" already exists","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":776781281,"node_id":"MDU6TGFiZWw3NzY3ODEyODE=","url":"https://api.github.com/repos/rails/rails/labels/ci%20issues","name":"ci issues","color":"aaafff","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-16T23:47:34Z","updated_at":"2022-05-26T15:46:15Z","closed_at":"2022-05-26T15:46:15Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/86357#61382cfd-f8b2-43b6-978d-6bc5fab4f780\r\n\r\n### Steps to reproduce\r\n```ruby\r\n$ cd railties\r\n$ bin/test test/application/rake/multi_dbs_test.rb --seed 32117 -n \"/^(?:ApplicationTests::RakeTests::RakeMultiDbsTest#(?:test_db:abort_if_pending_migrations_works_on_all_databases|test_db:prepare_runs_seeds_once|test_db:prepare_setups_missing_database_without_clearing_existing_one))$/\"\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ bin/test test/application/rake/multi_dbs_test.rb --seed 32117 -n \"/^(?:ApplicationTests::RakeTests::RakeMultiDbsTest#(?:test_db:abort_if_pending_migrations_works_on_all_databases|test_db:prepare_runs_seeds_once|test_db:prepare_setups_missing_database_without_clearing_existing_one))$/\"\r\nRun options: --seed 32117 -n \"/^(?:ApplicationTests::RakeTests::RakeMultiDbsTest#(?:test_db:abort_if_pending_migrations_works_on_all_databases|test_db:prepare_runs_seeds_once|test_db:prepare_setups_missing_database_without_clearing_existing_one))$/\"\r\n\r\n# Running:\r\n\r\n.E\r\n\r\nError:\r\nApplicationTests::RakeTests::RakeMultiDbsTest#test_db:prepare_runs_seeds_once:\r\nRuntimeError: rails command failed (1): bin/rails db:prepare 2>&1\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:687: warning: conflicting chdir during another chdir block\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:708: warning: conflicting chdir during another chdir block\r\nCreated database 'railties_test'\r\n== 20220516233707 CreateBooks: migrating ======================================\r\n-- create_table(:books)\r\n   -> 0.0035s\r\n== 20220516233707 CreateBooks: migrated (0.0036s) =============================\r\n\r\n== 20220516233708 CreateRecipes: migrating ====================================\r\n-- create_table(:recipes)\r\n   -> 0.0031s\r\n== 20220516233708 CreateRecipes: migrated (0.0031s) ===========================\r\n\r\n== 20220516233708 CreateDogs: migrating =======================================\r\n-- create_table(:dogs)\r\nrails aborted!\r\nStandardError: An error has occurred, this and all later migrations canceled:\r\n\r\nPG::DuplicateTable: ERROR:  relation \"dogs\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/db/animals_migrate/20220516233708_create_dogs.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/bin/rails:4:in `<top (required)>'\r\n\r\nCaused by:\r\nActiveRecord::StatementInvalid: PG::DuplicateTable: ERROR:  relation \"dogs\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/db/animals_migrate/20220516233708_create_dogs.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/bin/rails:4:in `<top (required)>'\r\n\r\nCaused by:\r\nPG::DuplicateTable: ERROR:  relation \"dogs\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/db/animals_migrate/20220516233708_create_dogs.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166172-cg0j15/app/bin/rails:4:in `<top (required)>'\r\nTasks: TOP => db:prepare\r\n(See full trace by running task with --trace)\r\n\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/isolation/abstract_unit.rb:390:in `rails'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:868:in `block (2 levels) in <class:RakeMultiDbsTest>'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:857:in `chdir'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:857:in `block in <class:RakeMultiDbsTest>'\r\n\r\n\r\nbin/test test/application/rake/multi_dbs_test.rb:855\r\n\r\nE\r\n\r\nError:\r\nApplicationTests::RakeTests::RakeMultiDbsTest#test_db:prepare_setups_missing_database_without_clearing_existing_one:\r\nRuntimeError: rails command failed (1): bin/rails db:prepare 2>&1\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:687: warning: conflicting chdir during another chdir block\r\n/home/yahonda/.rbenv/versions/3.1.2/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:708: warning: conflicting chdir during another chdir block\r\n== 20220516233706 CreateBooks: migrating ======================================\r\n-- create_table(:books)\r\nrails aborted!\r\nStandardError: An error has occurred, this and all later migrations canceled:\r\n\r\nPG::DuplicateTable: ERROR:  relation \"books\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/db/migrate/20220516233706_create_books.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/bin/rails:4:in `<top (required)>'\r\n\r\nCaused by:\r\nActiveRecord::StatementInvalid: PG::DuplicateTable: ERROR:  relation \"books\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/db/migrate/20220516233706_create_books.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/bin/rails:4:in `<top (required)>'\r\n\r\nCaused by:\r\nPG::DuplicateTable: ERROR:  relation \"books\" already exists\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/db/migrate/20220516233706_create_books.rb:3:in `change'\r\n/home/yahonda/src/github.com/rails/rails/tmp/d20220517-166171-cg0j15/app/bin/rails:4:in `<top (required)>'\r\nTasks: TOP => db:prepare\r\n(See full trace by running task with --trace)\r\n\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/isolation/abstract_unit.rb:390:in `rails'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:845:in `block (2 levels) in <class:RakeMultiDbsTest>'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:837:in `chdir'\r\n    /home/yahonda/src/github.com/rails/rails/railties/test/application/rake/multi_dbs_test.rb:837:in `block in <class:RakeMultiDbsTest>'\r\n\r\n\r\nbin/test test/application/rake/multi_dbs_test.rb:835\r\n\r\n\r\n\r\nFinished in 2.963446s, 1.0123 runs/s, 0.6749 assertions/s.\r\n3 runs, 2 assertions, 0 failures, 2 errors, 0 skips\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45114/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45114/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45113","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45113/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45113/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45113/events","html_url":"https://github.com/rails/rails/issues/45113","id":1237710919,"node_id":"I_kwDNIULOScX4Rw","number":45113,"title":"ActiveSupport::Duration#iso8601 number with e notation","user":{"login":"stanig2106","id":65514998,"node_id":"MDQ6VXNlcjY1NTE0OTk4","avatar_url":"https://avatars.githubusercontent.com/u/65514998?v=4","gravatar_id":"","url":"https://api.github.com/users/stanig2106","html_url":"https://github.com/stanig2106","followers_url":"https://api.github.com/users/stanig2106/followers","following_url":"https://api.github.com/users/stanig2106/following{/other_user}","gists_url":"https://api.github.com/users/stanig2106/gists{/gist_id}","starred_url":"https://api.github.com/users/stanig2106/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stanig2106/subscriptions","organizations_url":"https://api.github.com/users/stanig2106/orgs","repos_url":"https://api.github.com/users/stanig2106/repos","events_url":"https://api.github.com/users/stanig2106/events{/privacy}","received_events_url":"https://api.github.com/users/stanig2106/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-16T20:58:03Z","updated_at":"2022-05-16T21:10:42Z","closed_at":"2022-05-16T21:10:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nbig_number = 1_000_000_000\r\n\r\niso_duration_string = big_number.seconds.iso8601 # \"PT1e+09S\"\r\n\r\nparsed_duration = ActiveSupport::Duration.parse(iso_duration_string) \r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nThe `iso_duration_string` should be equal to `\"PT1000000000S\"`\r\nor \r\n`ActiveSupport::Duration#parse` should be able to parse it back \r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nan error is raised :  \r\n```ruby\r\nActiveSupport::Duration::ISO8601Parser::ParsingError: Invalid ISO 8601 duration: \"PT1e+09S\" \r\n# at \r\nactive_support/duration/iso8601_parser.rb:97:in `raise_parsing_error'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: Rails 6.0.3.2\r\n\r\n**Ruby version**: ruby 2.6.5p114\r\n\r\n\r\n### Informations\r\nstrangely, when specifying a precision, the bug does not appear\r\n```ruby\r\nbig_number.seconds.iso8601(precision: 0) # \"PT1000000000S\"\r\n```\r\nOr when it comes to hours\r\n```ruby\r\nbig_number.hours.iso8601 # \"PT1000000000H\"\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45113/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45113/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45112","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45112/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45112/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45112/events","html_url":"https://github.com/rails/rails/issues/45112","id":1237667974,"node_id":"I_kwDNIULOScVQhg","number":45112,"title":"Action Cable: Client-initiated heartbeats","user":{"login":"jeremy","id":199,"node_id":"MDQ6VXNlcjE5OQ==","avatar_url":"https://avatars.githubusercontent.com/u/199?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremy","html_url":"https://github.com/jeremy","followers_url":"https://api.github.com/users/jeremy/followers","following_url":"https://api.github.com/users/jeremy/following{/other_user}","gists_url":"https://api.github.com/users/jeremy/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremy/subscriptions","organizations_url":"https://api.github.com/users/jeremy/orgs","repos_url":"https://api.github.com/users/jeremy/repos","events_url":"https://api.github.com/users/jeremy/events{/privacy}","received_events_url":"https://api.github.com/users/jeremy/received_events","type":"User","site_admin":false},"labels":[{"id":149514554,"node_id":"MDU6TGFiZWwxNDk1MTQ1NTQ=","url":"https://api.github.com/repos/rails/rails/labels/pinned","name":"pinned","color":"f7c6c7","default":false,"description":null},{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"jorgemanrubia","id":129938,"node_id":"MDQ6VXNlcjEyOTkzOA==","avatar_url":"https://avatars.githubusercontent.com/u/129938?v=4","gravatar_id":"","url":"https://api.github.com/users/jorgemanrubia","html_url":"https://github.com/jorgemanrubia","followers_url":"https://api.github.com/users/jorgemanrubia/followers","following_url":"https://api.github.com/users/jorgemanrubia/following{/other_user}","gists_url":"https://api.github.com/users/jorgemanrubia/gists{/gist_id}","starred_url":"https://api.github.com/users/jorgemanrubia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jorgemanrubia/subscriptions","organizations_url":"https://api.github.com/users/jorgemanrubia/orgs","repos_url":"https://api.github.com/users/jorgemanrubia/repos","events_url":"https://api.github.com/users/jorgemanrubia/events{/privacy}","received_events_url":"https://api.github.com/users/jorgemanrubia/received_events","type":"User","site_admin":false},"assignees":[{"login":"jorgemanrubia","id":129938,"node_id":"MDQ6VXNlcjEyOTkzOA==","avatar_url":"https://avatars.githubusercontent.com/u/129938?v=4","gravatar_id":"","url":"https://api.github.com/users/jorgemanrubia","html_url":"https://github.com/jorgemanrubia","followers_url":"https://api.github.com/users/jorgemanrubia/followers","following_url":"https://api.github.com/users/jorgemanrubia/following{/other_user}","gists_url":"https://api.github.com/users/jorgemanrubia/gists{/gist_id}","starred_url":"https://api.github.com/users/jorgemanrubia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jorgemanrubia/subscriptions","organizations_url":"https://api.github.com/users/jorgemanrubia/orgs","repos_url":"https://api.github.com/users/jorgemanrubia/repos","events_url":"https://api.github.com/users/jorgemanrubia/events{/privacy}","received_events_url":"https://api.github.com/users/jorgemanrubia/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-05-16T20:17:44Z","updated_at":"2022-08-30T02:16:20Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"Tracking issue for a new feature we're extracting from Basecamp: Relying on clients to send heartbeats.\r\n\r\nMotivation: Preventing defunct session cruft from building up on WebSockets load balancers / proxies (e.g. Nginx or F5 BIG-IP) during network failovers and anycast IP changes.\r\n* Basecamp runs in multiple datacenters for high availability. During failover events and network changes, existing Action Cable sessions are severed. Hence they stop receiving server-sent heartbeats and attempt a reconnect, now landing on the new network destination. All good, as expected.\r\n* On the server side, however, a proxy or load balancer sitting in front of the app can accumulate all these indeterminate maybe-dead NATted connections, eating a ton of memory and sockets. The proxy needs to ceremoniously tear down the suddenly-absent client TCP connection, but in the meantime it's getting heartbeat pings from the server side, suggesting the connection is alive and well, so it hangs onto all the connections until the client side is surely closed.\r\n\r\nShifting the heartbeat responsibility from the server → client to client → server neatly resolves this. When network routing changes, the client reconnects to the new destination and ceases heartbeats to the old one. The proxy at the old destination no longer sees client _or_ server traffic on the connection, so it gracefully & expeditiously closes it out.\r\n\r\nThis feels like a strong default behavior as well, considering the client is already responsible for all other aspects of connection management.\r\n\r\nNeeds some care with backward and forward compatibility, anticipating that one, both, or neither heartbeating mechanisms could be in play during initial deployments or rollback therefrom.\r\n\r\nImplementation:\r\n* Introduce native heartbeating to the connection monitor\r\n* Introduce a native ping/heartbeat message\r\n* Skip `ActionCable::Server::Base#setup_heartbeat_timer` when client-initiated heartbeats are enabled\r\n\r\nExample from Basecamp, implemented using a Cable channel to \"drive\" the connection monitor:\r\n```javascript\r\nBC.cableReady(function() {\r\n  const pingInterval = (ActionCable.ConnectionMonitor.staleThreshold * 1000) / 2 // 3 seconds\r\n\r\n  BC.cableMonitor = BC.cable.subscriptions.create(\"MonitoringChannel\", {\r\n    initialized() {\r\n      ({monitor: this.monitor} = this.consumer.connection)\r\n      this.ping = this.ping.bind(this)\r\n    },\r\n\r\n    connected() {\r\n      this.monitor.recordConnect()\r\n      return this.ping()\r\n    },\r\n\r\n    received(data) {\r\n      switch (data.action) {\r\n        case \"pong\":\r\n          return this.pong()\r\n        case \"pubsub_pong\":\r\n          return this.pong()\r\n      }\r\n    },\r\n\r\n    ping() {\r\n      this.perform(\"ping\")\r\n      return this.schedulePing()\r\n    },\r\n\r\n    pong() {\r\n      this.monitor.recordPing()\r\n      return this.schedulePing()\r\n    },\r\n\r\n    schedulePing() {\r\n      clearTimeout(this.scheduledPing)\r\n      this.scheduledPing = setTimeout(this.ping, pingInterval)\r\n    }\r\n  }\r\n  )\r\n})\r\n```\r\n```ruby\r\nrequire \"securerandom\"\r\nrequire \"benchmark\"\r\n\r\n# Send our own pings and answer monitoring questions.\r\n#\r\n# This gives us forward compat with Action Cable protocol changes,\r\n# like pings changing from subscriptions to message types.\r\nclass MonitoringChannel < ApplicationCable::Channel\r\n  def subscribed\r\n    @subscription_uuid = SecureRandom.uuid\r\n    @last_received_at = Time.now.to_f\r\n\r\n    stream_for @subscription_uuid, ->(json) {\r\n      instrument_pubsub_latency ActiveSupport::JSON.decode(json) do |message|\r\n        transmit message\r\n      end\r\n    }\r\n  end\r\n\r\n  def ping\r\n    transmit({ action: \"pong\" })\r\n  end\r\n\r\n  def pubsub_ping\r\n    self.class.broadcast_to @subscription_uuid, action: \"pubsub_pong\", sent_at: Time.now.to_f\r\n  end\r\n\r\n  private\r\n    def instrument_pubsub_latency(message)\r\n      received_at = Time.now.to_f\r\n\r\n      if sent_at = message.delete(\"sent_at\")\r\n        latency = received_at - sent_at.to_f\r\n        message[\"latency_ms\"] = ms(latency)\r\n      end\r\n\r\n      message[\"period_ms\"] = ms(received_at - @last_received_at)\r\n      @last_received_at = received_at\r\n\r\n      ActiveSupport::Notifications.instrument :performance, measurement: \"Chat.pubsub_delay\", value: latency, action: :timing\r\n\r\n      yield message if block_given?\r\n      message\r\n    end\r\n\r\n    def ms(seconds)\r\n      (1000 * seconds).round(2)\r\n    end\r\nend\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45112/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45112/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/45108","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45108/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45108/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45108/events","html_url":"https://github.com/rails/rails/issues/45108","id":1237281818,"node_id":"I_kwDNIULOSb9sGg","number":45108,"title":"QueryCacheTest#test_query_cache_does_not_allow_sql_key_mutation fails","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-16T14:51:39Z","updated_at":"2022-05-16T16:48:32Z","closed_at":"2022-05-16T16:48:32Z","author_association":"MEMBER","active_lock_reason":null,"body":"Managed to reproduce https://buildkite.com/rails/rails/builds/86503#8b66cfc1-cbec-4331-a5ce-5fbac2a37ee8/1053-1064\r\n\r\n### Steps to reproduce\r\n```\r\n$ cd activerecord\r\n$ ARCONN=postgresql bin/test test/cases/adapters/postgresql/composite_test.rb test/cases/query_cache_test.rb  -n \"/^(?:PostgresqlCompositeWithCustomOIDTest#(?:test_column)|QueryCacheTest#(?:test_query_cache_does_not_allow_sql_key_mutation))$/\" --seed 50299\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ cd activerecord\r\n$ ARCONN=postgresql bin/test test/cases/adapters/postgresql/composite_test.rb test/cases/query_cache_test.rb  -n \"/^(?:PostgresqlCompositeWithCustomOIDTest#(?:test_column)|QueryCacheTest#(?:test_query_cache_does_not_allow_sql_key_mutation))$/\" --seed 50299\r\nUsing postgresql\r\nRun options: -n \"/^(?:PostgresqlCompositeWithCustomOIDTest#(?:test_column)|QueryCacheTest#(?:test_query_cache_does_not_allow_sql_key_mutation))$/\" --seed 50299\r\n\r\n# Running:\r\n\r\n.F\r\n\r\nFailure:\r\nQueryCacheTest#test_query_cache_does_not_allow_sql_key_mutation [/home/yahonda/src/github.com/rails/rails/activerecord/test/cases/query_cache_test.rb:395]:\r\n0 instead of 1 queries were executed..\r\nExpected: 1\r\n  Actual: 0\r\n\r\n\r\nbin/test test/cases/query_cache_test.rb:389\r\n\r\n\r\n\r\nFinished in 0.096603s, 20.7033 runs/s, 72.4617 assertions/s.\r\n2 runs, 7 assertions, 1 failures, 0 errors, 0 skips\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45108/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45107","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45107/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45107/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45107/events","html_url":"https://github.com/rails/rails/issues/45107","id":1236777669,"node_id":"I_kwDNIULOSbe6xQ","number":45107,"title":"Configuration for multiple databases unable to establish connection.","user":{"login":"dvodvo","id":716130,"node_id":"MDQ6VXNlcjcxNjEzMA==","avatar_url":"https://avatars.githubusercontent.com/u/716130?v=4","gravatar_id":"","url":"https://api.github.com/users/dvodvo","html_url":"https://github.com/dvodvo","followers_url":"https://api.github.com/users/dvodvo/followers","following_url":"https://api.github.com/users/dvodvo/following{/other_user}","gists_url":"https://api.github.com/users/dvodvo/gists{/gist_id}","starred_url":"https://api.github.com/users/dvodvo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dvodvo/subscriptions","organizations_url":"https://api.github.com/users/dvodvo/orgs","repos_url":"https://api.github.com/users/dvodvo/repos","events_url":"https://api.github.com/users/dvodvo/events{/privacy}","received_events_url":"https://api.github.com/users/dvodvo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-16T08:04:26Z","updated_at":"2022-05-16T10:05:46Z","closed_at":"2022-05-16T08:44:55Z","author_association":"NONE","active_lock_reason":null,"body":"Context: Building a distributed database system with multiple mixed single vs main/replica databases.\r\n\r\n[not directly related to the issue, but relevant to this observer] I would like to mention that [the relative rails guide](https://guides.rubyonrails.org/active_record_multiple_databases.html) is lacking on a couple of fundamental points.\r\n1) postgresql has mechanisms for ensuring replication for users with that role attributed.  I have to assume that these users needed to be created with that attibuted role given the guide is totally mute on the subject of user creation.  \r\n2) postresql has its own instruction set for setting up replicating data. This leads to a second assumption : Rails handles this aspect as it knows about both data stores in database.yml.  If this assumption is wrong then the guide is utterly lacking.\r\n\r\nWith two assumptions we are entering a geometric sphere of possibilities.  Additionally these two are, on the face of it contradictory: first case => intervene on postgresql, second case => not.\r\n[end of mention]\r\n\r\n### Steps to reproduce\r\n```\r\nproduction:\r\n  primary:\r\n    adapter: postgresql\r\n    encoding: unicode\r\n    host: central.domain.ws\r\n    username: deploy_root\r\n    password: pwd_root\r\n    database: users\r\n    pool: 50\r\n  primary_replica:\r\n    adapter: postgresql\r\n    encoding: unicode\r\n    host: replica.domain.ws\r\n    username: deploy_readonly\r\n    password: pwd_readonly\r\n    database: users\r\n    pool: 50\r\n    replica: true\r\n  forum:\r\n    adapter: postgresql\r\n    encoding: unicode\r\n    database: fora\r\n    username: deploy_root\r\n    password: pwd_root\r\n    host: central.domain.ws\r\n    migrations_paths: db/forum_migrate\r\n  forum_replica:\r\n    adapter: postgresql\r\n    encoding: unicode\r\n    database: fora\r\n    username: deploy_readonly\r\n    password: pwd_readonly\r\n    host: replica.domain.ws\r\n    replica: true\r\n  franchise:\r\n    adapter: postgresql\r\n    encoding: unicode\r\n    database: franchise\r\n    username: deploy_root\r\n    password: pwd_root\r\n    host: central.domain.ws\r\n    migrations_paths: db/franchise_migrate\r\n```\r\n### Expected behavior\r\nMigration proceeds as by design\r\n\r\n### Actual behavior\r\nTwo error behaviours are observed and they are not consistent with each other.\r\n\r\nThe second came about as a means of testing the migration command.  Note: `bin/rails db:migrate` would not run.\r\nLogging into the server and launching from the releases directory\r\n```\r\nbundle exec rake db:migrate\r\nrake aborted!\r\nActiveRecord::DatabaseConnectionError: There is an issue connecting to your database with your username/password, username: deploy_root.\r\n\r\nPlease check your database configuration to ensure the username/password are valid.\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:83:in `rescue in new_client'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:77:in `new_client'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:37:in `postgresql_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `public_send'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `new_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:700:in `checkout_new_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:679:in `try_to_checkout_new_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:640:in `acquire_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:341:in `checkout'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:181:in `connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_handler.rb:211:in `retrieve_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:313:in `retrieve_connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:280:in `connection'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:282:in `block in db_configs_with_versions'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `each'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `db_configs_with_versions'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/railties/databases.rake:95:in `block (2 levels) in <main>'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/rake-13.0.6/exe/rake:27:in `<top (required)>'\r\n/home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `load'\r\n/home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `<main>'\r\n\r\nCaused by:\r\nPG::ConnectionBad: connection to server at \"::1\", port 5432 failed: FATAL:  password authentication failed for user \"deploy_root\"\r\nconnection to server at \"::1\", port 5432 failed: FATAL:  password authentication failed for user \"deploy_root\"\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg/connection.rb:637:in `async_connect_or_reset'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg/connection.rb:707:in `new'\r\n/home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg.rb:69:in `connect'\r\n```\r\nThe authentication error is curious - have tried encapsulating the strings in quotes, but there is no change in behaviour.  This is also different messaging form the first set of errors\r\n\r\nThe initial error was observed upon a migration task. In production mode, upon deployment (domains sanitised):\r\n\r\n```\r\n      01 $HOME/.rbenv/bin/rbenv exec bundle exec rake db:migrate\r\n      01 rake aborted!\r\n      01 ActiveRecord::ConnectionNotEstablished: could not translate host name \"central.domain.ws\" to address: Name or service not known\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:87:in `rescue in new_client'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:77:in `new_client'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:37:in `postgresql_connectio…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `public_send'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `new_connectio…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:700:in `checkout_new_…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:679:in `try_to_checko…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:640:in `acquire_conne…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:341:in `checkout'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:181:in `connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_handler.rb:211:in `retrieve_c…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:313:in `retrieve_connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:280:in `connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:282:in `block in db_configs_with_versions'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `each'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `db_configs_with_versions'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/railties/databases.rake:95:in `block (2 levels) in <main>'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/rake-13.0.6/exe/rake:27:in `<top (required)>'\r\n      01 /home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `load'\r\n      01 /home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `<main>'\r\n      01\r\n      01 Caused by:\r\n      01 PG::ConnectionBad: could not translate host name \"central.domain.ws\" to address: Name or service not known\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg/connection.rb:702:in `connect_start'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg/connection.rb:702:in `new'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/pg-1.3.5/lib/pg.rb:69:in `connect'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:78:in `new_client'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/postgresql_adapter.rb:37:in `postgresql_connectio…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `public_send'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:656:in `new_connectio…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:700:in `checkout_new_…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:679:in `try_to_checko…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:640:in `acquire_conne…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:341:in `checkout'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:181:in `connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/connection_handler.rb:211:in `retrieve_c…\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:313:in `retrieve_connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/connection_handling.rb:280:in `connection'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:282:in `block in db_configs_with_versions'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `each'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/tasks/database_tasks.rb:280:in `db_configs_with_versions'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/activerecord-7.0.3/lib/active_record/railties/databases.rake:95:in `block (2 levels) in <main>'\r\n      01 /home/deploy_root/franchise/shared/bundle/ruby/3.1.0/gems/rake-13.0.6/exe/rake:27:in `<top (required)>'\r\n      01 /home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `load'\r\n      01 /home/deploy_root/.rbenv/versions/3.1.0/bin/bundle:25:in `<main>'\r\n      01 Tasks: TOP => db:migrate\r\n      01 (See full trace by running task with --trace)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45107/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45107/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45105","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45105/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45105/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45105/events","html_url":"https://github.com/rails/rails/issues/45105","id":1236411137,"node_id":"I_kwDNIULOSbIjAQ","number":45105,"title":"Should \"defaults\" initializer be loaded at the same time that defaults version is?","user":{"login":"brandoncc","id":543973,"node_id":"MDQ6VXNlcjU0Mzk3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/543973?v=4","gravatar_id":"","url":"https://api.github.com/users/brandoncc","html_url":"https://github.com/brandoncc","followers_url":"https://api.github.com/users/brandoncc/followers","following_url":"https://api.github.com/users/brandoncc/following{/other_user}","gists_url":"https://api.github.com/users/brandoncc/gists{/gist_id}","starred_url":"https://api.github.com/users/brandoncc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brandoncc/subscriptions","organizations_url":"https://api.github.com/users/brandoncc/orgs","repos_url":"https://api.github.com/users/brandoncc/repos","events_url":"https://api.github.com/users/brandoncc/events{/privacy}","received_events_url":"https://api.github.com/users/brandoncc/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-15T21:15:07Z","updated_at":"2022-08-21T11:09:34Z","closed_at":"2022-08-21T11:09:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Important note: I reference Rails 5 as our current working app version, but I created a test app and gem on Rails main branch (7.1.0-alpha) and Ruby 3.0.1. I verified the same issue still exists using that configuration.\r\n\r\n---\r\n\r\nWe are working on upgrading a Rails 5 app and we were confused why a change in `config/initializers/new_framework_defaults_5_2.rb` didn't seem to be working. It was:\r\n\r\n```ruby\r\nRails.application.config.action_controller.default_protect_from_forgery = true\r\n```\r\n\r\nIt turns out we had older versions of a couple of gems that were causing `ActionController` to be loaded earlier than it should have been. \r\n\r\n#### Expected execution order\r\n\r\nThe expected execution order of the code is:\r\n\r\n- `application.rb`\r\n- initializers in `config/initializers`\r\n- https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/railtie.rb#L101-L107\r\n\r\nWhen the code executes in this order, forgery is setup as expected. However, this is not the case if a gem accesses `ActionController::Base` prematurely by not using a railtie.\r\n\r\n#### Actual execution order\r\n\r\nWhen a gem accesses `ActionController::Base` without using a railtie containing something like `ActiveSupport.on_load(:action_controller_base)`, the execution order is:\r\n\r\n- `application.rb`\r\n- https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/railtie.rb#L101-L107\r\n- initializers in `config/initializers`\r\n\r\nSince the initializers haven't run when the second item (`railtie.rb#L101-L107`) is executed, forgery protection isn't setup as expected. You can see a screenshot of my debuggers being hit in the unexpected order below:\r\n\r\n<img width=\"1314\" alt=\"image\" src=\"https://user-images.githubusercontent.com/543973/168491959-fed657d5-9a9f-4ec7-9f89-92d107289d17.png\">\r\n\r\n---\r\n\r\nThere are numerous other examples of this bug, as seen [here](https://github.com/rails/rails/issues/39855#issuecomment-659670294).\r\n\r\nWe believe the reason that this is happening is because gems are loaded between `application.rb` and the `config/initializers` files. Because of this, gems have a chance to access things too early and cause premature loading of Rails components.\r\n\r\nWe have come up with two conceptual ways to fix this.\r\n\r\n#### 1. Move default overrides out of initializers\r\n\r\nIf default overrides were loaded at the same place as defaults, it could look something like this:\r\n\r\n```ruby\r\n# application.rb\r\n\r\n...\r\nload_defaults 5.0\r\nload_default_overrides\r\n...\r\n```\r\n\r\n```ruby\r\n# elsewhere in Rails bootstrap or config object\r\n\r\ndef load_default_overrides\r\n  Dir.glob('config/defaults/*.rb').each do |f|\r\n    require f\r\n  end\r\nend\r\n```\r\n\r\nThe overrides could then live in files like `config/defaults/5_2.rb`.\r\n\r\nThis solution would remove the chance for any gem to load between `load_defaults` being called and overrides being set.\r\n\r\n#### 2. Raise on early loading\r\n\r\nIf a gem loads any of the rails components before Rails is ready for them to be loaded, Rails could raise an error.\r\n\r\nThe bug presented in this issue could affect any initializer in an application. Raising an error if Rails isn't done loading when one of the components is accessed would protect every initializer in the application.\r\n\r\n### Main branch reproduction\r\n\r\nI created a test gem with this code:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire_relative \"test_rails_initializers/version\"\r\n\r\nmodule TestRailsInitializers\r\n  ActionController::Base.prepend Module.new\r\nend\r\n```\r\n\r\nThis code replicates the bug on the current main branch:\r\n\r\n![image](https://user-images.githubusercontent.com/543973/168493558-1ef88c2d-7abe-4a8f-aa6a-a21c059295c5.png)\r\n\r\n### System configuration\r\n**Rails version**: 5.x all the way through main branch (currently 7.1.0-alpha)\r\n\r\n**Ruby version**:\r\n2.6 - 3.0.1 tested","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45105/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45105/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45093","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45093/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45093/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45093/events","html_url":"https://github.com/rails/rails/issues/45093","id":1235859439,"node_id":"I_kwDNIULOSam37w","number":45093,"title":"Rails 7.0.3 changes `t.references` in 6.0 migrations from `t.integer` to `t.bigint` on PostgreSQL.","user":{"login":"andrewculver","id":217218,"node_id":"MDQ6VXNlcjIxNzIxOA==","avatar_url":"https://avatars.githubusercontent.com/u/217218?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewculver","html_url":"https://github.com/andrewculver","followers_url":"https://api.github.com/users/andrewculver/followers","following_url":"https://api.github.com/users/andrewculver/following{/other_user}","gists_url":"https://api.github.com/users/andrewculver/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewculver/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewculver/subscriptions","organizations_url":"https://api.github.com/users/andrewculver/orgs","repos_url":"https://api.github.com/users/andrewculver/repos","events_url":"https://api.github.com/users/andrewculver/events{/privacy}","received_events_url":"https://api.github.com/users/andrewculver/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-14T03:55:48Z","updated_at":"2022-06-02T01:37:00Z","closed_at":"2022-06-02T01:37:00Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"After upgrading Rails from 7.0.2.4 to 7.0.3, `rake db:drop db:create db:migrate` is producing changes in our `db/schema.rb`, from our `6.0` migrations which I wouldn't expect after an upgrade. I can't tell whether this is a new bug being introduced or a previous bug being fixed.\r\n\r\n### Steps to reproduce\r\n\r\n - Here is a newly generated example 7.0.2.4 application with some 6.0 migrations and 7.0 migrations: https://github.com/andrewculver/rails-migration-issue\r\n - Here is a PR on that same repository where we upgrade from 7.0.2.4 to 7.0.3 and ran `rake db:drop db:create db:migrate` to produce the delta in `db/schema.rb`: https://github.com/andrewculver/rails-migration-issue/pull/1/files\r\n\r\nHere are the steps I performed to generate that repository and PR:\r\n\r\n```bash\r\nmkdir old-rails\r\ncd old-rails\r\necho \"source 'https://rubygems.org'\" > \"Gemfile\"\r\necho \"gem 'rails', '7.0.2.4'\" >> \"Gemfile\"\r\nbundle install\r\nbundle exec rails -v\r\n# Confirm it says \"7.0.2.4\"\r\nrails new migration-issue-app --database=postgresql\r\ncd migration-issue-app\r\n\r\nrm ./Gemfile.lock\r\nvim ./Gemfile\r\n# Lock \"rails\" at \"7.0.2.4\".\r\nbundle install\r\n\r\nrails g model Project name:string\r\nrails g model Idea project:references name:string\r\nvim db/migrate/*_create_projects.rb\r\n# Change migration version to \"6.0\".\r\nvim db/migrate/*_create_ideas.rb\r\n# Change migration version to \"6.0\".\r\n\r\nrails g model Site name:string\r\nrails g model Page site:references name:string\r\n\r\nrake db:create\r\nrake db:migrate\r\n\r\ncat db/schema.rb\r\n# Confirm that `project_id` is `t.integer` and `site_id` is `t.bigint`.\r\n\r\ngit add -A\r\ngit commit -m \"Set up the test condition.\"\r\n\r\nrm ./Gemfile.lock\r\nvim ./Gemfile\r\n# Lock \"rails\" at \"7.0.3\".\r\nbundle install\r\nbundle exec rails -v\r\n# Confirm it says \"7.0.3\"\r\n\r\nrake db:drop\r\nrake db:create\r\nrake db:migrate\r\n\r\ngit diff db/schema.rb\r\n# `project_id` should not have changed, but it has gone from `t.integer` to `t.bigint`.\r\n```\r\n\r\n### Expected behavior\r\nI would not expect the 6.0 migrations to start producing changes in `db/schema.rb` when rebuilding it from scratch.\r\n\r\n### Actual behavior\r\nI do see changes to `db/schema.rb`:\r\n\r\n```diff\r\n--- a/db/schema.rb\r\n+++ b/db/schema.rb\r\n@@ -15,7 +15,7 @@ ActiveRecord::Schema[7.0].define(version: 2022_05_14_034501) do\r\n   enable_extension \"plpgsql\"\r\n \r\n   create_table \"ideas\", force: :cascade do |t|\r\n-    t.integer \"project_id\", null: false\r\n+    t.bigint \"project_id\", null: false\r\n     t.string \"name\"\r\n     t.datetime \"created_at\", null: false\r\n     t.datetime \"updated_at\", null: false\r\n```\r\n\r\n### System configuration\r\n**Rails version**: `Rails 7.0.3`\r\n**Ruby version**: `ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [arm64-darwin21]`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45093/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45093/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45092","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45092/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45092/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45092/events","html_url":"https://github.com/rails/rails/issues/45092","id":1235832707,"node_id":"I_kwDNIULOSalPgw","number":45092,"title":"Confusing error message when no server is available","user":{"login":"keisukeYamagishi","id":5553852,"node_id":"MDQ6VXNlcjU1NTM4NTI=","avatar_url":"https://avatars.githubusercontent.com/u/5553852?v=4","gravatar_id":"","url":"https://api.github.com/users/keisukeYamagishi","html_url":"https://github.com/keisukeYamagishi","followers_url":"https://api.github.com/users/keisukeYamagishi/followers","following_url":"https://api.github.com/users/keisukeYamagishi/following{/other_user}","gists_url":"https://api.github.com/users/keisukeYamagishi/gists{/gist_id}","starred_url":"https://api.github.com/users/keisukeYamagishi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/keisukeYamagishi/subscriptions","organizations_url":"https://api.github.com/users/keisukeYamagishi/orgs","repos_url":"https://api.github.com/users/keisukeYamagishi/repos","events_url":"https://api.github.com/users/keisukeYamagishi/events{/privacy}","received_events_url":"https://api.github.com/users/keisukeYamagishi/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-14T02:08:56Z","updated_at":"2022-05-14T13:50:56Z","closed_at":"2022-05-14T13:50:56Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nexecute `rails new newApp`, \r\nAfter execute \r\n`bundle install`\r\nWhen I run `rails s`, \r\nI get the following log and cannot start the server.\r\n```\r\nCould not find server ''.\r\nRun `bin/rails server --help` for more options.\r\n```\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nExecute `rails s`\r\n\r\n```ruby\r\nbash-5.1# bundle exec rails s -p 3000 \r\nCould not find server ''.\r\nRun `bin/rails server --help` for more options.\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nExecute rails server\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nnot execute rails server\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n```\r\nbash-5.1# rails -v\r\nRails 7.0.3\r\n```\r\n\r\n**Ruby version**:\r\n\r\n```\r\nbash-5.1# ruby -v\r\nruby 3.0.0p0 (2020-12-25 revision 95aff21468) [aarch64-linux-musl]\r\nbash-5.1# \r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45092/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45088","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45088/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45088/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45088/events","html_url":"https://github.com/rails/rails/issues/45088","id":1235459470,"node_id":"I_kwDNIULOSaOdjg","number":45088,"title":"ActionMailbox passes an empty string for Attachments on submit","user":{"login":"joshzandman","id":5635133,"node_id":"MDQ6VXNlcjU2MzUxMzM=","avatar_url":"https://avatars.githubusercontent.com/u/5635133?v=4","gravatar_id":"","url":"https://api.github.com/users/joshzandman","html_url":"https://github.com/joshzandman","followers_url":"https://api.github.com/users/joshzandman/followers","following_url":"https://api.github.com/users/joshzandman/following{/other_user}","gists_url":"https://api.github.com/users/joshzandman/gists{/gist_id}","starred_url":"https://api.github.com/users/joshzandman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshzandman/subscriptions","organizations_url":"https://api.github.com/users/joshzandman/orgs","repos_url":"https://api.github.com/users/joshzandman/repos","events_url":"https://api.github.com/users/joshzandman/events{/privacy}","received_events_url":"https://api.github.com/users/joshzandman/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":1174770998,"node_id":"MDU6TGFiZWwxMTc0NzcwOTk4","url":"https://api.github.com/repos/rails/rails/labels/actionmailbox","name":"actionmailbox","color":"f4a6cb","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-05-13T16:36:45Z","updated_at":"2022-05-15T21:07:06Z","closed_at":"2022-05-15T21:07:06Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nWhen submitting the local form from `/rails/conductor/action_mailbox/inbound_emails` in development, Rails is passing an empty string to the attachments array, resulting in this error `undefined method original_filename' for \"\":String`.\r\n\r\n### Expected behavior\r\nWhen submitting the form with or without an attachment, there should not be an empty string that gets passed into the array.\r\n\r\n### Actual behavior\r\n`\"attachments\"=>[\"\"]`\r\n\r\n### System configuration\r\n**Rails version**: `Rails 7.0.2.4`\r\n\r\n**Ruby version**: `ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [arm64-darwin21]`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45088/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45088/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45087","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45087/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45087/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45087/events","html_url":"https://github.com/rails/rails/issues/45087","id":1235426784,"node_id":"I_kwDNIULOSaMd4A","number":45087,"title":"Normalize `ActiveSupport::Duration` when substracting durations","user":{"login":"amomchilov","id":5703449,"node_id":"MDQ6VXNlcjU3MDM0NDk=","avatar_url":"https://avatars.githubusercontent.com/u/5703449?v=4","gravatar_id":"","url":"https://api.github.com/users/amomchilov","html_url":"https://github.com/amomchilov","followers_url":"https://api.github.com/users/amomchilov/followers","following_url":"https://api.github.com/users/amomchilov/following{/other_user}","gists_url":"https://api.github.com/users/amomchilov/gists{/gist_id}","starred_url":"https://api.github.com/users/amomchilov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amomchilov/subscriptions","organizations_url":"https://api.github.com/users/amomchilov/orgs","repos_url":"https://api.github.com/users/amomchilov/repos","events_url":"https://api.github.com/users/amomchilov/events{/privacy}","received_events_url":"https://api.github.com/users/amomchilov/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-13T16:01:52Z","updated_at":"2022-08-29T07:00:21Z","closed_at":"2022-08-29T07:00:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n  \r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n  \r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activesupport\", \"~> 7.0.2.3\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/numeric/time.rb\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    assert_equal \"1 hour and 1 minute\", (1.hour + 1.minute).inspect # ✅\r\n    assert_equal \"59 minutes\", (1.hour - 1.minute).inspect # ❌ actual: \"1 hour and -1 minutes\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n```\r\n1 hour and 1 minute\r\n59 minutes\r\n```\r\n\r\n### Actual behavior\r\n\r\n```\r\n1 hour and 1 minute\r\n1 hour and -1 minutes\r\n```\r\n\r\nThis can be achieved by passing the result back through a `.build`:\r\n\r\n```ruby\r\np ActiveSupport::Duration.build(1.hour - 1.minute) # => \"59 minutes\"\r\n```\r\n\r\nIt would be nice if this was the built-in behavior of subtracting durations. If backwards compatibility or perforance concerns are an issue, then I thing the next-best-thing would be to add a `#normalize` method:\r\n\r\n```ruby\r\np (1.hour - 1.minute).normalize # => \"59 minutes\"\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: `rails (7.0.2.3)`\r\n**Ruby version**: `ruby 3.1.2p20`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45087/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45087/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45084","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45084/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45084/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45084/events","html_url":"https://github.com/rails/rails/issues/45084","id":1234633452,"node_id":"I_kwDNIULOSZcC7A","number":45084,"title":"Passing filename with leading `./` to rails test executes all tests","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-05-13T01:20:40Z","updated_at":"2022-05-13T11:02:45Z","closed_at":"2022-05-13T11:02:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nGenerate a new rails project, create tests (maybe by scaffolding), run tests by passing filename starts with `./`.\r\n\r\n```sh\r\n$ rails test ./test/models/post_test.rb\r\n```\r\n\r\n### Expected behavior\r\n\r\nRails runs a single test file.\r\n\r\n### Actual behavior\r\n\r\nRails runs all tests.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.3\r\n\r\n**Ruby version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45084/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45084/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45079","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45079/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45079/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45079/events","html_url":"https://github.com/rails/rails/issues/45079","id":1234144418,"node_id":"I_kwDNIULOSY-Mog","number":45079,"title":"number_to_currency helper fails for integer amounts","user":{"login":"dmazan","id":8730296,"node_id":"MDQ6VXNlcjg3MzAyOTY=","avatar_url":"https://avatars.githubusercontent.com/u/8730296?v=4","gravatar_id":"","url":"https://api.github.com/users/dmazan","html_url":"https://github.com/dmazan","followers_url":"https://api.github.com/users/dmazan/followers","following_url":"https://api.github.com/users/dmazan/following{/other_user}","gists_url":"https://api.github.com/users/dmazan/gists{/gist_id}","starred_url":"https://api.github.com/users/dmazan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dmazan/subscriptions","organizations_url":"https://api.github.com/users/dmazan/orgs","repos_url":"https://api.github.com/users/dmazan/repos","events_url":"https://api.github.com/users/dmazan/events{/privacy}","received_events_url":"https://api.github.com/users/dmazan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-12T15:19:00Z","updated_at":"2022-05-12T17:26:05Z","closed_at":"2022-05-12T17:26:05Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nf = Float(3.00)\r\nActionController::Base.helpers.number_to_currency(f)\r\n\r\n### Expected behavior\r\n> \"$3.00\"\r\n\r\n### Actual behavior\r\nactivesupport-7.0.2.3/lib/active_support/number_helper/number_to_rounded_converter.rb:27:in `convert': undefined method `<<' for nil:NilClass (NoMethodError)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1p18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45079/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45079/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45076","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45076/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45076/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45076/events","html_url":"https://github.com/rails/rails/issues/45076","id":1233680430,"node_id":"I_kwDNIULOSYh4Lg","number":45076,"title":"Deprecation warning after patch upgrade from Rails 6.0.4.8 to Rails 6.0.5","user":{"login":"diesl","id":3629547,"node_id":"MDQ6VXNlcjM2Mjk1NDc=","avatar_url":"https://avatars.githubusercontent.com/u/3629547?v=4","gravatar_id":"","url":"https://api.github.com/users/diesl","html_url":"https://github.com/diesl","followers_url":"https://api.github.com/users/diesl/followers","following_url":"https://api.github.com/users/diesl/following{/other_user}","gists_url":"https://api.github.com/users/diesl/gists{/gist_id}","starred_url":"https://api.github.com/users/diesl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diesl/subscriptions","organizations_url":"https://api.github.com/users/diesl/orgs","repos_url":"https://api.github.com/users/diesl/repos","events_url":"https://api.github.com/users/diesl/events{/privacy}","received_events_url":"https://api.github.com/users/diesl/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":1180817762,"node_id":"MDU6TGFiZWwxMTgwODE3NzYy","url":"https://api.github.com/repos/rails/rails/labels/actiontext","name":"actiontext","color":"3bc667","default":false,"description":""},{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2022-05-12T09:00:58Z","updated_at":"2022-05-31T19:43:04Z","closed_at":"2022-05-31T19:43:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have a Rails app that runs fine with Rails 6.0.4.8, but after a new build with Rails 6.0.5, I get a Deprecation warning during startup (with setting  `config.active_support.deprecation = :raise`). \r\n\r\nWith another setting like `:log`, it works fine of course, but I think this deprecation warning should not occur in a minor patch version?\r\n\r\n### Expected behavior\r\nStartup should work without deprecation warning\r\n\r\n### Actual behavior\r\nAt startup I get the following error:\r\n\r\n```\r\n=> Booting Puma\r\n=> Rails 6.0.5 application starting in development\r\n=> Run `rails server --help` for more startup options\r\nExiting\r\n/usr/local/bundle/gems/railties-6.0.5/lib/rails/initializable.rb:32:in `instance_exec': DEPRECATION WARNING: Initialization autoloaded the constants ActionText::ContentHelper and ActionText::TagHelper. (ActiveSupport::DeprecationException)\r\n\r\nBeing able to do this is deprecated. Autoloading during initialization is going\r\nto be an error condition in future versions of Rails.\r\n\r\nReloading does not reboot the application, and therefore code executed during\r\ninitialization does not run again. So, if you reload ActionText::ContentHelper, for example,\r\nthe expected changes won't be reflected in that stale Module object.\r\n\r\nThese autoloaded constants have been unloaded.\r\n\r\nPlease, check the \"Autoloading and Reloading Constants\" guide for solutions.\r\n (called from <main> at /myapp/config/environment.rb:5)\r\n       from /usr/local/bundle/gems/railties-6.0.5/lib/rails/initializable.rb:32:in `run'\r\n       from /usr/local/bundle/gems/railties-6.0.5/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n```\r\n\r\nDigging a bit further with the script from [here](https://github.com/rails/rails/issues/36546#issuecomment-558773961), I got the following result:\r\n\r\n```\r\n=> Booting Puma\r\n=> Rails 6.0.5 application starting in development\r\n=> Run `rails server --help` for more startup options\r\nCleaned backtrace:\r\n       actiontext (6.0.5) lib/action_text/engine.rb:42:in `block (3 levels) in <class:Engine>'\r\n       actiontext (6.0.5) lib/action_text/engine.rb:41:in `block (2 levels) in <class:Engine>'\r\n       actiontext (6.0.5) lib/action_text/engine.rb:40:in `each'\r\n       actiontext (6.0.5) lib/action_text/engine.rb:40:in `block in <class:Engine>'\r\n       /myapp/config/environment.rb:5:in `<main>'\r\n       config.ru:3:in `require_relative'\r\n       config.ru:3:in `block in <main>'\r\n       <internal:kernel>:90:in `tap'\r\nMost probably the cause is: actiontext (6.0.5) lib/action_text/engine.rb:42:in `block (3 levels) in <class:Engine>'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.0.5\r\n\r\n**Ruby version**: 3.0.4p208\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45076/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45076/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45069","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45069/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45069/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45069/events","html_url":"https://github.com/rails/rails/issues/45069","id":1232954815,"node_id":"I_kwDNIULOSX1lvw","number":45069,"title":"Inconsistency between Cache #increment behaviors","user":{"login":"alan-pie","id":65185890,"node_id":"MDQ6VXNlcjY1MTg1ODkw","avatar_url":"https://avatars.githubusercontent.com/u/65185890?v=4","gravatar_id":"","url":"https://api.github.com/users/alan-pie","html_url":"https://github.com/alan-pie","followers_url":"https://api.github.com/users/alan-pie/followers","following_url":"https://api.github.com/users/alan-pie/following{/other_user}","gists_url":"https://api.github.com/users/alan-pie/gists{/gist_id}","starred_url":"https://api.github.com/users/alan-pie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alan-pie/subscriptions","organizations_url":"https://api.github.com/users/alan-pie/orgs","repos_url":"https://api.github.com/users/alan-pie/repos","events_url":"https://api.github.com/users/alan-pie/events{/privacy}","received_events_url":"https://api.github.com/users/alan-pie/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-05-11T17:14:13Z","updated_at":"2022-07-19T01:15:34Z","closed_at":"2022-07-19T01:15:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n1. Set cache to :memory_store\r\n2. Call `#increment('key')` where 'key' does not already exist\r\n\r\n### Expected behavior\r\n`#increment` returns 1 for a key that does not already exist\r\n\r\n### Actual behavior\r\n`:memory_store` and `:file_store` return nil and do nothing, `:redis_cache_store` and `:mem_cache_store` return 1.\r\n\r\nTechnically this discrepancy is documented in the implementations and the tests `CacheIncrementDecrementBehavior`, but it is not desirable. It prevents me from using `:memory_store` in my tests and `:redis_cache_store` in other environments. I want to use `:memory_store` in the tests because I want to use the TimeHelpers. If we have to be backwards compatible here can we at least implement an option on Memory store to initialize the increment operations the same way Redis and Memcache do? I'm happy to provide a PR if that strategy will work.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7\r\n\r\n**Ruby version**:\r\n2.7.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45069/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45069/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45062","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45062/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45062/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45062/events","html_url":"https://github.com/rails/rails/issues/45062","id":1232180095,"node_id":"I_kwDNIULOSXGTfw","number":45062,"title":"using mysql view causes NoMethodError in activerecord-7.0.3","user":{"login":"hoshi-sano","id":1905688,"node_id":"MDQ6VXNlcjE5MDU2ODg=","avatar_url":"https://avatars.githubusercontent.com/u/1905688?v=4","gravatar_id":"","url":"https://api.github.com/users/hoshi-sano","html_url":"https://github.com/hoshi-sano","followers_url":"https://api.github.com/users/hoshi-sano/followers","following_url":"https://api.github.com/users/hoshi-sano/following{/other_user}","gists_url":"https://api.github.com/users/hoshi-sano/gists{/gist_id}","starred_url":"https://api.github.com/users/hoshi-sano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hoshi-sano/subscriptions","organizations_url":"https://api.github.com/users/hoshi-sano/orgs","repos_url":"https://api.github.com/users/hoshi-sano/repos","events_url":"https://api.github.com/users/hoshi-sano/events{/privacy}","received_events_url":"https://api.github.com/users/hoshi-sano/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-11T08:08:16Z","updated_at":"2022-05-12T00:46:39Z","closed_at":"2022-05-11T11:41:37Z","author_association":"NONE","active_lock_reason":null,"body":"Calling `count`, `where` (, ...and so on) for a mysql view causes an error.\r\n\r\n```\r\nNoMethodError: undefined method `match' for nil:NilClass\r\n\r\n            match = create_table_info(table_name).match(/`#{field_name}` (.+) DEFAULT ('|\\d+|[A-z]+)/)\r\n                                                 ^^^^^^\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nI hope you could reproduce with [this](https://github.com/hoshi-sano/reproduction-AR7.0.3).\r\n\r\n<details>\r\n<summary>backtrace:</summary>\r\n\r\n```\r\nNoMethodError: undefined method `match' for nil:NilClass\r\n\r\n            match = create_table_info(table_name).match(/`#{field_name}` (.+) DEFAULT ('|\\d+|[A-z]+)/)\r\n                                                 ^^^^^^\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/mysql/schema_statements.rb:162:in `default_type'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/mysql/schema_statements.rb:190:in `new_column_from_field'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/schema_statements.rb:117:in `block in columns'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/mysql2_adapter.rb:94:in `each'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/mysql2_adapter.rb:94:in `each_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/schema_statements.rb:116:in `each'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/schema_statements.rb:116:in `map'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/abstract/schema_statements.rb:116:in `columns'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:117:in `block in columns'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:116:in `fetch'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:116:in `columns'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:125:in `block in columns_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:124:in `fetch'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/connection_adapters/schema_cache.rb:124:in `columns_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:568:in `load_schema!'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/attributes.rb:264:in `load_schema!'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/encryption/encryptable_record.rb:122:in `load_schema!'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:554:in `block in load_schema'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:551:in `synchronize'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:551:in `load_schema'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:417:in `attribute_types'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/model_schema.rb:443:in `type_for_attribute'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/type_caster/map.rb:16:in `type_for_attribute'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/arel/table.rb:107:in `type_for_attribute'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/table_metadata.rb:18:in `type'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:59:in `build'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:54:in `[]'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:126:in `block in expand_from_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:79:in `each'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:79:in `flat_map'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:79:in `expand_from_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/predicate_builder.rb:25:in `build_from_hash'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/query_methods.rb:1299:in `build_where_clause'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/query_methods.rb:742:in `where!'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/relation/query_methods.rb:737:in `where'\r\n/usr/local/bundle/gems/activerecord-7.0.3/lib/active_record/querying.rb:22:in `where'\r\n/usr/local/bundle/gems/railties-7.0.3/lib/rails/commands/runner/runner_command.rb:46:in `<main>'\r\n/usr/local/bundle/gems/railties-7.0.3/lib/rails/commands/runner/runner_command.rb:46:in `eval'\r\n/usr/local/bundle/gems/railties-7.0.3/lib/rails/commands/runner/runner_command.rb:46:in `perform'\r\n```\r\n\r\n</details>\r\n\r\n### Expected behavior\r\n\r\noccured here:\r\n\r\nhttps://github.com/rails/rails/blob/v7.0.3/activerecord/lib/active_record/connection_adapters/mysql/schema_statements.rb#L162\r\n```rb\r\n\r\n          def default_type(table_name, field_name)\r\n            match = create_table_info(table_name).match(/`#{field_name}` (.+) DEFAULT ('|\\d+|[A-z]+)/)\r\n```\r\nhttps://github.com/rails/rails/blob/v7.0.3/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb#L826-L828\r\n```rb\r\n        def create_table_info(table_name) # :nodoc:\r\n          exec_query(\"SHOW CREATE TABLE #{quote_table_name(table_name)}\", \"SCHEMA\").first[\"Create Table\"]\r\n        end\r\n```\r\n\r\nShould work without error even if `table_name` is for a view.\r\n\r\n### Actual behavior\r\n\r\nWhen using the SHOW CREATE TABLE syntax, a \"Create Table\" column could be get for a normal table,\r\n\r\n```\r\n$ bin/rails console\r\nLoading development environment (Rails 7.0.3)\r\nirb(main):001:0> con = ActiveRecord::Base.connection\r\n=>\r\n#<ActiveRecord::ConnectionAdapters::Mysql2Adapter:0x00007f31cdbcb5a0\r\n...\r\nirb(main):002:0> con.exec_query(\"SHOW CREATE TABLE `articles`\", \"SCHEMA\").first\r\n=>\r\n{\"Table\"=>\"articles\",\r\n \"Create Table\"=>\"CREATE TABLE `articles` (\\n  `id` varchar(36) NOT NULL,\\n  PRIMARY KEY (`id`)\\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\"}\r\n```\r\n\r\nbut for a view, a \"Create View\" column is generated, so the expected value could not be obtained.\r\n\r\n```\r\nirb(main):003:0> con.exec_query(\"SHOW CREATE TABLE `test_views`\", \"SCHEMA\").first\r\n=>\r\n{\"View\"=>\"test_views\",\r\n \"Create View\"=>\"CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`%` SQL SECURITY DEFINER VIEW `test_views` AS select `a`.`id` AS `id` from `articles` `a` union select `c`.`id` AS `id` from `comments` `c`\",\r\n \"character_set_client\"=>\"utf8mb4\",\r\n \"collation_connection\"=>\"utf8mb4_0900_ai_ci\"}\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.1.2\r\n\r\n**MySQL**: 8.0.29\r\n\r\n### Probable cause\r\n\r\n- #44654\r\n- #44712","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45062/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45062/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45057","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45057/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45057/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45057/events","html_url":"https://github.com/rails/rails/issues/45057","id":1231427535,"node_id":"I_kwDNIULOSWYXzw","number":45057,"title":"`rails new` creates an app that is incompatible with CSP","user":{"login":"iainbeeston","id":111963,"node_id":"MDQ6VXNlcjExMTk2Mw==","avatar_url":"https://avatars.githubusercontent.com/u/111963?v=4","gravatar_id":"","url":"https://api.github.com/users/iainbeeston","html_url":"https://github.com/iainbeeston","followers_url":"https://api.github.com/users/iainbeeston/followers","following_url":"https://api.github.com/users/iainbeeston/following{/other_user}","gists_url":"https://api.github.com/users/iainbeeston/gists{/gist_id}","starred_url":"https://api.github.com/users/iainbeeston/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iainbeeston/subscriptions","organizations_url":"https://api.github.com/users/iainbeeston/orgs","repos_url":"https://api.github.com/users/iainbeeston/repos","events_url":"https://api.github.com/users/iainbeeston/events{/privacy}","received_events_url":"https://api.github.com/users/iainbeeston/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-10T16:44:25Z","updated_at":"2022-05-16T13:52:27Z","closed_at":"2022-05-16T13:41:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI've created a sample rails app that reproduces the issue [here](https://github.com/iainbeeston/cors_test) and I've deployed it to heroku [here](https://cors-test.herokuapp.com/) but what I did was:\r\n\r\n1. Create a new rails app using `rails new` (no options)\r\n2. Add a controller, with an index action and view, then add that action to `routes.rb`\r\n3. Uncomment `config/initializers/content_security_policy.rb`\r\n4. Start up the app with `rails server`\r\n5. Load the page in the browser and open the javascript console\r\n\r\n### Expected behavior\r\n\r\nThere should be no javascript errors in the browser console, because I've done nothing other than generate a new rails app and I'm only using core rails components.\r\n\r\n### Actual behavior\r\n\r\nI see two CSP errors:\r\n\r\n```\r\nRefused to frame 'blob:http://localhost:3000/477a88e6-fb4c-48fd-a677-2ba7fb69fc45' because it violates the following Content Security Policy directive: \"default-src 'self' https:\". Note that 'frame-src' was not explicitly set, so 'default-src' is used as a fallback.\r\nRefused to apply inline style because it violates the following Content Security Policy directive: \"style-src 'self' https:\". Either the 'unsafe-inline' keyword, a hash ('sha256-rql2tlBWA4Hb3HHbUfw797urk+ifBd6EAovoOUGt0oI='), or a nonce ('nonce-...') is required to enable inline execution.\r\n```\r\n\r\nThe first is coming from `es-module-shims.js` and the second is from `turbo.es2017-esm.js`\r\n\r\n![Screenshot 2022-05-11 at 14 49 09](https://user-images.githubusercontent.com/111963/167865595-f67a2bd4-3e9c-429a-9787-78116bb7c4c4.jpg)\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.1\r\n\r\n### Notes\r\n\r\nIt looks like the es-module-shims error is appearing because es-module-shims creates an iframe and injects a blob into it. I believe that since es-module-shims 1.3.4 it [should automatically use a nonce](https://github.com/guybedford/es-module-shims/pull/223) to be compatible with CSP. Rails 7.0.2 comes with es-module-shims 1.4.6 and AFAIK rails is doing everything it needs to do to help es-module-shims be compatible with CSP (ie. add a nonce inside a `<script type=\"esms-options\">` tag).\r\n\r\nThe turbo error is coming about because turbo [injects css into the page](https://github.com/hotwired/turbo/blob/e30d36bf56d020d63d87a8350d9d0361edd9b804/src/core/drive/progress_bar.ts#L109) for the turbo progress bar. Turbo does check for a `<meta name=\"csp-nonce\">` tag on the page and injects a nonce into the stylesheet for that, but it also does not seem to be working and I can see a CSP error.\r\n\r\nI suspect in both cases there is configuration missing in the default rails install somewhere? Even if it's not a code fix, it should probably be documented in the rails security guide if there's an obvious fix that developers need to make.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45057/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45057/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45056","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45056/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45056/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45056/events","html_url":"https://github.com/rails/rails/issues/45056","id":1231096543,"node_id":"I_kwDNIULOSWEK3w","number":45056,"title":"Preload doesn't work properly for has_many through associations with STI model","user":{"login":"vitalinfo","id":7523182,"node_id":"MDQ6VXNlcjc1MjMxODI=","avatar_url":"https://avatars.githubusercontent.com/u/7523182?v=4","gravatar_id":"","url":"https://api.github.com/users/vitalinfo","html_url":"https://github.com/vitalinfo","followers_url":"https://api.github.com/users/vitalinfo/followers","following_url":"https://api.github.com/users/vitalinfo/following{/other_user}","gists_url":"https://api.github.com/users/vitalinfo/gists{/gist_id}","starred_url":"https://api.github.com/users/vitalinfo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vitalinfo/subscriptions","organizations_url":"https://api.github.com/users/vitalinfo/orgs","repos_url":"https://api.github.com/users/vitalinfo/repos","events_url":"https://api.github.com/users/vitalinfo/events{/privacy}","received_events_url":"https://api.github.com/users/vitalinfo/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-10T12:41:05Z","updated_at":"2022-08-24T22:05:21Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nIt does work for Rails versions less than 7, but doesn't for 7+.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  gem 'rails', '7.0.3'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new($stdout)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table 'companies', force: :cascade, &:timestamps\r\n\r\n  create_table 'memberships', force: :cascade do |t|\r\n    t.integer 'company_id'\r\n    t.integer 'user_id'\r\n    t.timestamps\r\n  end\r\n\r\n  create_table 'profiles', force: :cascade do |t|\r\n    t.integer 'user_id'\r\n    t.timestamps\r\n  end\r\n\r\n  create_table 'user_settings', force: :cascade do |t|\r\n    t.integer 'user_id'\r\n    t.timestamps\r\n  end\r\n\r\n  create_table 'users', force: :cascade do |t|\r\n    t.string 'type', null: false\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass Company < ActiveRecord::Base\r\n  has_many :memberships, inverse_of: :company, dependent: :destroy\r\n  has_many :users, through: :memberships\r\n\r\n  has_many :profiles, through: :users\r\n  has_many :user_settings, through: :users\r\nend\r\n\r\nclass Membership < ActiveRecord::Base\r\n  belongs_to :company, inverse_of: :memberships\r\n  belongs_to :user, inverse_of: :memberships, class_name: 'User::Simple'\r\nend\r\n\r\nclass Profile < ActiveRecord::Base\r\n  belongs_to :user, inverse_of: :profile, class_name: 'User::Simple'\r\nend\r\n\r\nclass UserSetting < ActiveRecord::Base\r\n  belongs_to :user, inverse_of: :user_setting, class_name: 'User::Simple'\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one :profile, inverse_of: :user, dependent: :destroy\r\n  has_one :user_setting, inverse_of: :user, dependent: :destroy\r\n\r\n  has_many :memberships, inverse_of: :user, dependent: :destroy\r\n\r\n  after_create do\r\n    create_profile(user: self)\r\n    create_user_setting(user: self)\r\n  end\r\nend\r\n\r\nclass User\r\n  class Simple < User\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_preload\r\n    count = rand(1..10)\r\n    company = Company.create!\r\n    count.times { Membership.create!(company: company, user: User::Simple.create!) }\r\n\r\n    list = Company.all.preload(:profiles, :user_settings)\r\n\r\n    assert_equal count, list.map(&:profiles).flatten.size\r\n    assert_equal count, list.map(&:user_settings).flatten.size\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n`through` (`memberships` in example) association loads once and preload associations present in the parent object.\r\n\r\n### Actual behavior\r\n`through` (`memberships` in example) association loads as many times as preload associations provided. Second and further associations always are empty. If remove `class_name: 'User::Simple'` from the `Membership` model, everything works fine (`through` association loads once and preload associations as well), but this isn't an option, this's just shows that problem in the STI approach and `associate_records_to_owner`? behaviour.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.3\r\n\r\n**Ruby version**: 3.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45056/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45056/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45055","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45055/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45055/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45055/events","html_url":"https://github.com/rails/rails/issues/45055","id":1231037832,"node_id":"I_kwDNIULOSWAliA","number":45055,"title":"Time#advance and Time#change behave incorrectly at fall Daylight Saving Time change","user":{"login":"ikaronen-relex","id":38075778,"node_id":"MDQ6VXNlcjM4MDc1Nzc4","avatar_url":"https://avatars.githubusercontent.com/u/38075778?v=4","gravatar_id":"","url":"https://api.github.com/users/ikaronen-relex","html_url":"https://github.com/ikaronen-relex","followers_url":"https://api.github.com/users/ikaronen-relex/followers","following_url":"https://api.github.com/users/ikaronen-relex/following{/other_user}","gists_url":"https://api.github.com/users/ikaronen-relex/gists{/gist_id}","starred_url":"https://api.github.com/users/ikaronen-relex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ikaronen-relex/subscriptions","organizations_url":"https://api.github.com/users/ikaronen-relex/orgs","repos_url":"https://api.github.com/users/ikaronen-relex/repos","events_url":"https://api.github.com/users/ikaronen-relex/events{/privacy}","received_events_url":"https://api.github.com/users/ikaronen-relex/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-10T11:51:00Z","updated_at":"2022-06-29T22:26:12Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nRun the following RSpec:\r\n\r\n```ruby\r\nrequire 'active_support/time'\r\n\r\ndescribe Time do\r\n  before { Time.zone = 'Europe/Lisbon' }\r\n  let(:time) { Time.new(2021, 10, 31, 0, 0, 0, Time.zone).advance(hours: 2) }\r\n\r\n  context '#advance' do\r\n    it 'works correctly at fall DST change' do\r\n      expect(time.advance(seconds: 0) - time).to eq(0)\r\n    end\r\n  end\r\n\r\n  context '#change' do\r\n    it 'works correctly at fall DST change' do\r\n      expect(time.change(sec: 0) - time).to eq(0)\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nSpecs pass.\r\n\r\n### Actual behavior\r\n\r\nSpecs fail as follows:\r\n\r\n```\r\n  1) Time#advance works correctly at fall DST change\r\n     Failure/Error: expect(time.advance(seconds: 0) - time).to eq(0)\r\n     \r\n       expected: 0\r\n            got: 3600.0\r\n     \r\n       (compared using ==)\r\n     # ./backend/spec/rails_time_advance_dst_spec.rb:7:in `block in <main>'\r\n\r\n  2) Time#change works correctly at fall DST change\r\n     Failure/Error: expect(time.change(sec: 0) - time).to eq(0)\r\n     \r\n       expected: 0\r\n            got: 3600.0\r\n     \r\n       (compared using ==)\r\n     # ./backend/spec/rails_time_advance_dst_spec.rb:13:in `block in <main>'\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: 6.1.5.1\r\n\r\n**Ruby version**: 2.6.8p0 (jruby 9.3.4.0)\r\n\r\n### Notes\r\n\r\nThe bug is probably also reproducible on Rails 7.0.3, since [the relevant code](https://github.com/rails/rails/blob/v7.0.3//activesupport/lib/active_support/core_ext/time/calculations.rb#L138) hasn't changed [since 6.1.5.1](https://github.com/rails/rails/blob/v6.1.5.1/activesupport/lib/active_support/core_ext/time/calculations.rb#L139).\r\n\r\nUsing ActiveSupport::TimeWithZone instead of Time (i.e. replacing `Time.new(..., Time.zone)` with `Time.zone.local(...)`) makes the specs pass, and can be an acceptable workaround. Nonetheless, since ActiveSupport does attempt and claim to support working with Time objects, and provides the `change` and `advance` methods for them, I consider this a bug. FWIW, it has bit me in practice while writing tests for DST handling in our time-related code. \r\n\r\nThe specs above are the shortest and simplest examples I've found that clearly display the incorrect behavior. There's probably some need for more comprehensive test coverage for time handling around DST changes in general, as I can think of several possible tweaks to the behavior that could probably make the specs above pass while still leaving the underlying bug(s) unfixed.\r\n\r\nIn particular, note that the `time` fixture set up for the specs above is arguably already a somewhat broken object: it stringifies to \"2021-10-31 02:00:00 +0100\", which is not a time that exists in the Lisbon time zone, as the clock should've jumped back to 01:00:00 +0000 at that moment. My original code, of which the above is a condensed version, stepped the time forward by one minute increments using `advance(minutes: 1)`; the `time` value above is where things broke down when doing that.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45055/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45055/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45054","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45054/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45054/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45054/events","html_url":"https://github.com/rails/rails/issues/45054","id":1230810879,"node_id":"I_kwDNIULOSVyu_w","number":45054,"title":"7.0.3 introduces breaking change to `touch` and `update_columns`","user":{"login":"mroach","id":79006,"node_id":"MDQ6VXNlcjc5MDA2","avatar_url":"https://avatars.githubusercontent.com/u/79006?v=4","gravatar_id":"","url":"https://api.github.com/users/mroach","html_url":"https://github.com/mroach","followers_url":"https://api.github.com/users/mroach/followers","following_url":"https://api.github.com/users/mroach/following{/other_user}","gists_url":"https://api.github.com/users/mroach/gists{/gist_id}","starred_url":"https://api.github.com/users/mroach/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mroach/subscriptions","organizations_url":"https://api.github.com/users/mroach/orgs","repos_url":"https://api.github.com/users/mroach/repos","events_url":"https://api.github.com/users/mroach/events{/privacy}","received_events_url":"https://api.github.com/users/mroach/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-05-10T08:35:13Z","updated_at":"2022-05-11T11:40:50Z","closed_at":"2022-05-11T11:40:50Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThis test works with `7.0.2` but fails with `7.0.3`:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"rails\", \"7.0.3\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.datetime :archived_at\r\n    t.timestamps\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\n\r\n  def readonly?\r\n    persisted? && archived_at?\r\n  end\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post, touch: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_unarchiving_post\r\n    post = Post.create!(archived_at: Time.now)\r\n    post.update_columns(archived_at: nil)\r\n\r\n    assert_nil post.archived_at\r\n  end\r\n\r\n  def test_touching_archived_post\r\n    post = Post.create!(archived_at: Time.now)\r\n    post.comments.create!\r\n\r\n    assert_equal 1, post.comments.count\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n`update_columns` and `touch` continue to work on `readonly?` records at least until the next major version. If the behaviour is to change, a deprecation warning for using these methods on `readonly?` records would be desirable.\r\n\r\n### Actual behavior\r\n\r\n`update_columns` and `touch` now raise `ActiveRecord::ReadOnlyRecord` when the record is readonly.\r\n\r\n### System configuration\r\n**Rails version**: `7.0.3`\r\n\r\n**Ruby version**: `3.1.1`\r\n\r\n### Probable cause\r\n\r\nhttps://github.com/rails/rails/pull/44845","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45054/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45054/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45050","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45050/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45050/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45050/events","html_url":"https://github.com/rails/rails/issues/45050","id":1230263033,"node_id":"I_kwDNIULOSVRS-Q","number":45050,"title":"XMLMini does not requre IsolatedExecutionState","user":{"login":"singpolyma","id":12770,"node_id":"MDQ6VXNlcjEyNzcw","avatar_url":"https://avatars.githubusercontent.com/u/12770?v=4","gravatar_id":"","url":"https://api.github.com/users/singpolyma","html_url":"https://github.com/singpolyma","followers_url":"https://api.github.com/users/singpolyma/followers","following_url":"https://api.github.com/users/singpolyma/following{/other_user}","gists_url":"https://api.github.com/users/singpolyma/gists{/gist_id}","starred_url":"https://api.github.com/users/singpolyma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/singpolyma/subscriptions","organizations_url":"https://api.github.com/users/singpolyma/orgs","repos_url":"https://api.github.com/users/singpolyma/repos","events_url":"https://api.github.com/users/singpolyma/events{/privacy}","received_events_url":"https://api.github.com/users/singpolyma/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-09T21:19:07Z","updated_at":"2022-05-11T14:52:01Z","closed_at":"2022-05-11T14:52:01Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\nrequire \"active_support/xml_mini\"\r\n\r\nActiveSupport::XmlMini.parse(\"<stuff />\")\r\n```\r\n\r\n### Expected behavior\r\n\r\nIt should parse.\r\n\r\n### Actual behavior\r\n\r\nIt raises:\r\n\r\n```\r\n3: from /home/singpolyma/src/sgx-jmp/.gems/ruby/2.7.0/gems/activesupport-7.0.3/lib/active_support/xml_mini.rb:11:in `<top (required)>'\r\n\t2: from .../gems/activesupport-7.0.3/lib/active_support/xml_mini.rb:201:in `<module:ActiveSupport>'\r\n\t1: from .../gems/activesupport-7.0.3/lib/active_support/xml_mini.rb:103:in `backend='\r\n.../.gems/ruby/2.7.0/gems/activesupport-7.0.3/lib/active_support/xml_mini.rb:184:in `current_thread_backend': uninitialized constant ActiveSupport::XmlMini::IsolatedExecutionState (NameError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 2.7.4\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45050/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45050/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45049","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45049/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45049/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45049/events","html_url":"https://github.com/rails/rails/issues/45049","id":1230152268,"node_id":"I_kwDNIULOSVKiTA","number":45049,"title":"upsert_all causes PG::NotNullViolation","user":{"login":"varg90","id":2902480,"node_id":"MDQ6VXNlcjI5MDI0ODA=","avatar_url":"https://avatars.githubusercontent.com/u/2902480?v=4","gravatar_id":"","url":"https://api.github.com/users/varg90","html_url":"https://github.com/varg90","followers_url":"https://api.github.com/users/varg90/followers","following_url":"https://api.github.com/users/varg90/following{/other_user}","gists_url":"https://api.github.com/users/varg90/gists{/gist_id}","starred_url":"https://api.github.com/users/varg90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/varg90/subscriptions","organizations_url":"https://api.github.com/users/varg90/orgs","repos_url":"https://api.github.com/users/varg90/repos","events_url":"https://api.github.com/users/varg90/events{/privacy}","received_events_url":"https://api.github.com/users/varg90/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-05-09T19:26:17Z","updated_at":"2022-05-09T23:04:49Z","closed_at":"2022-05-09T22:51:48Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nCreate a model with some attributes that is `null: false` in the db schema (I use PostgreSQL). For example, a `Book` with attributes `title` and `color`. Then try to update existing records using `upsert_all` method. Let's say we already have books with the next attributes:\r\n```\r\nid: 1, title: 'Red Book', color: 'Red'\r\nid: 2, title: 'Blue Book', color: 'Blue'\r\n```\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nBook.upsert_all([\r\n    {id: 1, title: 'Actually Crimson Book'}, \r\n    {id: 2, title: 'Azure Book'}\r\n  ], update_only: [:title])\r\n```\r\n\r\n### Expected behavior\r\nIt is expected that it will ignore skipped `color` attribute for two reasons: we didn't list it in the upsert_all attributes and we didn't put it in the upsert_all `update_only` option. It should successfully update just titles by the books' ids (as a default index for `unique_by`)\r\n\r\n### Actual behavior\r\nWe get an error:\r\n```\r\nBook Bulk Upsert (0.9ms)  INSERT INTO \"books\" (\"id\",\"title\",\"created_at\",\"updated_at\") VALUES (1, 'Actually Crimson Book', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP), (2, 'Azure Book', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) ON CONFLICT (\"id\") DO UPDATE SET updated_at=(CASE WHEN (\"books\".\"title\" IS NOT DISTINCT FROM excluded.\"title\") THEN \"books\".updated_at ELSE CURRENT_TIMESTAMP END),\"title\"=excluded.\"title\" RETURNING \"id\"\r\n\r\n/my/path/to/gems/activerecord-7.0.2.4/lib/active_record/connection_adapters/postgresql_adapter.rb:768:in `exec_params':\r\nPG::NotNullViolation: ERROR:  null value in column \"color\" of relation \"books\" violates not-null constraint (ActiveRecord::NotNullViolation)\r\nDETAIL:  Failing row contains (1, null, Actually Crimson Book, 2022-05-09 19:06:09.0335, 2022-05-09 19:06:09.0335).\r\n\r\n/my/path/to/gems/activerecord-7.0.2.4/lib/active_record/connection_adapters/postgresql_adapter.rb:768:in `exec_params':\r\nERROR:  null value in column \"color\" of relation \"books\" violates not-null constraint (PG::NotNullViolation)\r\nDETAIL:  Failing row contains (1, null, Actually Crimson Book, 2022-05-09 19:06:09.0335, 2022-05-09 19:06:09.0335).\r\n```\r\nWhich is strange since we don't see anything about the `color` in the SQL request `ON CONFLICT (\"id\") DO UPDATE SET ... `\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2.4\r\n**Ruby version**:\r\n3.0.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45049/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45049/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45046","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45046/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45046/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45046/events","html_url":"https://github.com/rails/rails/issues/45046","id":1229686491,"node_id":"I_kwDNIULOSUuG2w","number":45046,"title":"Incorrect SQL creation for numbers","user":{"login":"walterhorstman","id":105590,"node_id":"MDQ6VXNlcjEwNTU5MA==","avatar_url":"https://avatars.githubusercontent.com/u/105590?v=4","gravatar_id":"","url":"https://api.github.com/users/walterhorstman","html_url":"https://github.com/walterhorstman","followers_url":"https://api.github.com/users/walterhorstman/followers","following_url":"https://api.github.com/users/walterhorstman/following{/other_user}","gists_url":"https://api.github.com/users/walterhorstman/gists{/gist_id}","starred_url":"https://api.github.com/users/walterhorstman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/walterhorstman/subscriptions","organizations_url":"https://api.github.com/users/walterhorstman/orgs","repos_url":"https://api.github.com/users/walterhorstman/repos","events_url":"https://api.github.com/users/walterhorstman/events{/privacy}","received_events_url":"https://api.github.com/users/walterhorstman/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-09T13:11:11Z","updated_at":"2022-05-12T00:52:20Z","closed_at":"2022-05-12T00:52:20Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nEnter in the console.\r\n\r\n```ruby\r\nItem.where('amount > ?', 3).to_sql\r\n```\r\n\r\n### Expected behavior\r\nSELECT `items`.* FROM `items` WHERE (amount > 3)\r\n\r\n### Actual behavior\r\nSELECT `items`.* FROM `items` WHERE (amount > '3')\r\n\r\nThe comparison value for amount should not have been quoted. I've found this while migrating a Rails 4.2 application to 7.0. In Rails 4.2 this does not happen.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n\r\n**Ruby version**: 3.1.2p20\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45046/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45046/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45045","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45045/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45045/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45045/events","html_url":"https://github.com/rails/rails/issues/45045","id":1229667192,"node_id":"I_kwDNIULOSUs7eA","number":45045,"title":"RedisCacheStore doesn't set a TTL in Redis when called with expires_at","user":{"login":"Hugo-Hache","id":5188983,"node_id":"MDQ6VXNlcjUxODg5ODM=","avatar_url":"https://avatars.githubusercontent.com/u/5188983?v=4","gravatar_id":"","url":"https://api.github.com/users/Hugo-Hache","html_url":"https://github.com/Hugo-Hache","followers_url":"https://api.github.com/users/Hugo-Hache/followers","following_url":"https://api.github.com/users/Hugo-Hache/following{/other_user}","gists_url":"https://api.github.com/users/Hugo-Hache/gists{/gist_id}","starred_url":"https://api.github.com/users/Hugo-Hache/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hugo-Hache/subscriptions","organizations_url":"https://api.github.com/users/Hugo-Hache/orgs","repos_url":"https://api.github.com/users/Hugo-Hache/repos","events_url":"https://api.github.com/users/Hugo-Hache/events{/privacy}","received_events_url":"https://api.github.com/users/Hugo-Hache/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-09T12:56:01Z","updated_at":"2022-05-10T12:37:51Z","closed_at":"2022-05-10T12:22:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\"\r\n  gem 'redis'\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  setup do\r\n    @cache = ActiveSupport::Cache::RedisCacheStore.new\r\n  end\r\n\r\n  test 'ttl with_expires_at' do\r\n    @cache.write('key_with_expires_in', 'xxx', expires_in: 30.minutes)\r\n\r\n    # Passes\r\n    assert @cache.send(:redis).ttl('key_with_expires_in') > 0\r\n  end\r\n\r\n  test 'test ttl_with_expires_at' do\r\n    @cache.write('key_with_expires_at', 'xxx', expires_at: 30.minutes.from_now)\r\n    \r\n    # Fails\r\n    assert @cache.send(:redis).ttl('key_with_expires_at') > 0\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nExpires_at option should set a TTL in Redis.  \r\n\r\nAs the documentation states \r\n\r\n```\r\n      # Setting <tt>:expires_at</tt> will set an absolute expiration time on the cache.\r\n      # All caches support auto-expiring content after a specified number of\r\n      # seconds. This value can only be supplied to the +fetch+ or +write+ method to\r\n      # affect just one entry.\r\n```\r\n### Actual behavior\r\nExpires_at doesn't set a TLL in Redis.  \r\n\r\nIt leads to a cache size progressively increasing, as key is never evicted except if queried again.\r\n\r\n### System configuration\r\n**Rails version**: master\r\n\r\n**Ruby version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [arm64-darwin21]\r\n\r\n### Explanation\r\n\r\nTTL is not set because options are transparently passed from [Cache#write](https://github.com/rails/rails/blob/3520cc77df1b52a6c808083214b583c769e9a4b2/activesupport/lib/active_support/cache.rb#L494) to [RedisCacheStore#write_entry](https://github.com/rails/rails/blob/3520cc77df1b52a6c808083214b583c769e9a4b2/activesupport/lib/active_support/cache/redis_cache_store.rb#L369) and `write_entry` expects only an `expires_in` option","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45045/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45045/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45040","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45040/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45040/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45040/events","html_url":"https://github.com/rails/rails/issues/45040","id":1228780218,"node_id":"I_kwDNIULOST2yug","number":45040,"title":"Memory consumption problem when creating jobs from another job","user":{"login":"panovek","id":4404014,"node_id":"MDQ6VXNlcjQ0MDQwMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/4404014?v=4","gravatar_id":"","url":"https://api.github.com/users/panovek","html_url":"https://github.com/panovek","followers_url":"https://api.github.com/users/panovek/followers","following_url":"https://api.github.com/users/panovek/following{/other_user}","gists_url":"https://api.github.com/users/panovek/gists{/gist_id}","starred_url":"https://api.github.com/users/panovek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/panovek/subscriptions","organizations_url":"https://api.github.com/users/panovek/orgs","repos_url":"https://api.github.com/users/panovek/repos","events_url":"https://api.github.com/users/panovek/events{/privacy}","received_events_url":"https://api.github.com/users/panovek/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-08T03:16:43Z","updated_at":"2022-05-09T08:31:59Z","closed_at":"2022-05-09T08:31:58Z","author_association":"NONE","active_lock_reason":null,"body":"If we have some kind of job that creates a large number (for example, hundreds of thousands) of other jobs in the course of its work, then the problem with memory consumption becomes clearly visible, which depends solely on the number of created jobs and is freed only after the main job finishes its work.\r\n\r\n### Steps to reproduce\r\nTest example: https://github.com/panovek/test_jobs\r\nThis example with sidekiq, but it is just for visualization. Problem reproduced with plain AJ also.\r\nTo see the problem, you can run this test application, click \"Start test\" link and observe the memory consumption of ruby process while the main job is running.\r\n\r\nOr you can create new simple rails app with 2 simple jobs:\r\n\r\n```ruby\r\nclass MainJob < ApplicationJob\r\n  def perform\r\n      400000.times { ChildJob.perform_later(\"asdfasdfasdf\", options: { a: 1, b: 2 }) }\r\n  end\r\nend\r\n\r\nclass ChildJob < ApplicationJob\r\n  def perform(some_text, options = {})\r\n  end\r\nend\r\n\r\nMainJob.perform_later\r\n```\r\n\r\n\r\n### Expected behavior\r\nJobs generated, memory does not grow significantly.\r\n\r\n### Actual behavior\r\nJobs generated, but memory grow and freed only when main job finished.\r\n\r\n### System configuration\r\n**Rails version**: Rails 6.1.5.1\r\n\r\n**Ruby version**: ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [arm64-darwin20]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45040/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45040/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45039","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45039/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45039/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45039/events","html_url":"https://github.com/rails/rails/issues/45039","id":1228751174,"node_id":"I_kwDNIULOST1BRg","number":45039,"title":"default_scope overrides default model values","user":{"login":"exocode","id":1597621,"node_id":"MDQ6VXNlcjE1OTc2MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1597621?v=4","gravatar_id":"","url":"https://api.github.com/users/exocode","html_url":"https://github.com/exocode","followers_url":"https://api.github.com/users/exocode/followers","following_url":"https://api.github.com/users/exocode/following{/other_user}","gists_url":"https://api.github.com/users/exocode/gists{/gist_id}","starred_url":"https://api.github.com/users/exocode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/exocode/subscriptions","organizations_url":"https://api.github.com/users/exocode/orgs","repos_url":"https://api.github.com/users/exocode/repos","events_url":"https://api.github.com/users/exocode/events{/privacy}","received_events_url":"https://api.github.com/users/exocode/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-07T23:56:32Z","updated_at":"2022-05-09T15:41:15Z","closed_at":"2022-05-09T15:41:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n\r\nSCHEMA:\r\n```ruby\r\ncreate_table \"user\", force: :cascade do |t|\r\n    t.string \"name\"\r\n    t.boolean \"active\", default: false\r\nend\r\n```\r\n\r\nModel\r\n```ruby\r\nclass User < ApplicationRecord\r\n  default_scope { where(active: true) }\r\nend\r\n\r\nu = User.create!(name: \"test\")\r\nu.active? # returns true (should be false)\r\n```\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n\r\n  create_table :users, force: true do |t|\r\n    t.string :name\r\n    t.boolean :active, default: false # <<<< default false\r\n    \r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  \r\nend\r\n\r\n\r\nclass UserWithDefaultScope < User\r\n  default_scope { where(active: true) }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  # WORKS\r\n    def test_built_user\r\n    new_user = User.new(name: \"test\")\r\n\r\n    assert_equal false, new_user.active?\r\n  end\r\n\r\n  def test_created_user\r\n    saved_user = User.create!(name: \"test2\")   \r\n\r\n    assert_equal false, saved_user.active?\r\n  end \r\n\r\n  # FAILS\r\n  def test_with_default_scope_built_user\r\n    new_user = UserWithDefaultScope.new(name: \"test\")\r\n\r\n    assert_equal false, new_user.active?\r\n  end\r\n\r\n  def test_with_default_scope_created_user\r\n    saved_user = UserWithDefaultScope.create!(name: \"test2\")   \r\n\r\n    assert_equal false, saved_user.active?\r\n  end\r\n\r\nend\r\n\r\n\r\n```\r\n\r\n### Expected behavior\r\nuser.active should be false\r\n\r\n### Actual behavior\r\nuser.active is false\r\n\r\n### System configuration\r\n**Rails version**:\r\nrails 6.1.4.1\r\n\r\n**Ruby version**:\r\nruby '2.7.2'\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45039/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45039/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45038","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45038/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45038/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45038/events","html_url":"https://github.com/rails/rails/issues/45038","id":1228710615,"node_id":"I_kwDNIULOSTyi1w","number":45038,"title":"ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.reconnect doesn't seem to reach rescue block","user":{"login":"eshults35","id":83674726,"node_id":"MDQ6VXNlcjgzNjc0NzI2","avatar_url":"https://avatars.githubusercontent.com/u/83674726?v=4","gravatar_id":"","url":"https://api.github.com/users/eshults35","html_url":"https://github.com/eshults35","followers_url":"https://api.github.com/users/eshults35/followers","following_url":"https://api.github.com/users/eshults35/following{/other_user}","gists_url":"https://api.github.com/users/eshults35/gists{/gist_id}","starred_url":"https://api.github.com/users/eshults35/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eshults35/subscriptions","organizations_url":"https://api.github.com/users/eshults35/orgs","repos_url":"https://api.github.com/users/eshults35/repos","events_url":"https://api.github.com/users/eshults35/events{/privacy}","received_events_url":"https://api.github.com/users/eshults35/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":128692,"node_id":"MDU6TGFiZWwxMjg2OTI=","url":"https://api.github.com/repos/rails/rails/labels/needs%20feedback","name":"needs feedback","color":"ededed","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-07T19:58:01Z","updated_at":"2022-06-15T09:35:15Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Regarding the reconnect! function\r\n\r\n```\r\ndef reconnect!\r\n        @lock.synchronize do\r\n          super\r\n          @connection.reset\r\n          configure_connection\r\n        rescue PG::ConnectionBad\r\n          connect\r\n        end\r\n      end\r\n```\r\n\r\nIn debugging a gem that enables RDS IAM authentication, we are hitting a potential bug on reconnect! as described here: https://github.com/haines/pg-aws_rds_iam/issues/290\r\n\r\nThe obvious fix was to add PG:Error to the caught exceptions as that was the error being encountered in configure_connection which is being called by reconnect!. However, after further debugging, the exception still wasn't being caught.\r\n\r\nI found that the exception was finally caught by moving the rescue block within the do block like so:\r\n\r\n```\r\ndef reconnect!\r\n        @lock.synchronize do\r\n          super\r\n          @connection.reset\r\n          configure_connection\r\n          rescue PG::ConnectionBad, PG::Error\r\n            connect\r\n        end\r\n      end\r\n```\r\n\r\nOfcourse this is totally unrelated with the issue we are trying to solve in the gem. But since the only code block within the function is contained in that do, and since the @lock.synchronize doesn't seem to contain any PG class functionality (as far as I know), it seems that the rescue block in general may be wrongly placed. \r\n\r\nAt the least, I think it would be important to discuss the background of this function and the intention of that rescue block, as the least impactful change on my end, if in fact that rescue PG::ConnectionBad is rightfully placed for a specific purpose, just may be this:\r\n\r\n```\r\ndef reconnect!\r\n        @lock.synchronize do\r\n          super\r\n          @connection.reset\r\n          configure_connection\r\n          rescue PG::Error\r\n            connect\r\n        rescue PG::ConnectionBad\r\n          connect\r\n        end\r\n      end\r\n```\r\n\r\n\r\n\r\n### Steps to reproduce \r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nUnfortunately outside of the context of temporary passwords, there doesn't seem to be a clear reproducible way of reaching that rescue block. But in the context of utilizing the pg-aws_rds_iam gem, I was able to reproduce the PG:Error issue as follows:\r\n--connection established\r\n>> ActiveRecord::Base.connection.execute(\"SELECT pg_sleep(10000);\")\r\nSSL SYSCALL error: Operation timed out\r\n>> ActiveRecord::Base.connection.reconnect!\r\nPG::Error: connection to server at \"xxx\" (xxx), port 5432 failed: FATAL:  PAM authentication failed for user \"xxx\"\r\nconnection to server at \"xxx\" (xxx), port 5432 failed: FATAL:  pg_hba.conf rejects connection for host \"10.249.250.113\", user \"xxx\", database \"xxx\", SSL off\r\n```\r\n\r\n### Expected behavior\r\nWhen adding the PG:Error exception to existing rescue block, failure in configure_connection should hit this block.\r\n\r\n### Actual behavior\r\nRescue block is never reached and connection never happens. \r\n\r\n### System configuration\r\n**Rails version**: 6.0.4.4\r\n\r\n**Ruby version**: 2.7.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45038/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45038/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45037","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45037/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45037/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45037/events","html_url":"https://github.com/rails/rails/issues/45037","id":1228612121,"node_id":"I_kwDNIULOSTsiGQ","number":45037,"title":"content_tag is not setting an option tag with a blank value","user":{"login":"lotus-eye","id":64725977,"node_id":"MDQ6VXNlcjY0NzI1OTc3","avatar_url":"https://avatars.githubusercontent.com/u/64725977?v=4","gravatar_id":"","url":"https://api.github.com/users/lotus-eye","html_url":"https://github.com/lotus-eye","followers_url":"https://api.github.com/users/lotus-eye/followers","following_url":"https://api.github.com/users/lotus-eye/following{/other_user}","gists_url":"https://api.github.com/users/lotus-eye/gists{/gist_id}","starred_url":"https://api.github.com/users/lotus-eye/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lotus-eye/subscriptions","organizations_url":"https://api.github.com/users/lotus-eye/orgs","repos_url":"https://api.github.com/users/lotus-eye/repos","events_url":"https://api.github.com/users/lotus-eye/events{/privacy}","received_events_url":"https://api.github.com/users/lotus-eye/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-05-07T12:06:25Z","updated_at":"2022-05-16T14:40:04Z","closed_at":"2022-05-16T14:40:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n <%= content_tag(\"option\", \"Select\", value: '') %>\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n```<option value>Select</option>```\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n`<option>Select</option>`\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.2.3\r\n**Ruby version**:\r\nruby 3.0.2p107\r\n\r\nSince this option is not setting a blank value, whenever I try to get the value of the select tag using JS, it returns me `Select`(the text of the option) instead of a blank string. This is not happening with the earlier rails version. I have just updated my app to Rails 7 and used dropdown at a lot of places. I am facing a hard time due to this. \r\n\r\nThanks a lot in advance.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45037/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45037/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45034","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45034/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45034/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45034/events","html_url":"https://github.com/rails/rails/issues/45034","id":1228067244,"node_id":"I_kwDNIULOSTLRrA","number":45034,"title":"Ability to use helpers within content_security_policy controller method","user":{"login":"lavaturtle","id":1977279,"node_id":"MDQ6VXNlcjE5NzcyNzk=","avatar_url":"https://avatars.githubusercontent.com/u/1977279?v=4","gravatar_id":"","url":"https://api.github.com/users/lavaturtle","html_url":"https://github.com/lavaturtle","followers_url":"https://api.github.com/users/lavaturtle/followers","following_url":"https://api.github.com/users/lavaturtle/following{/other_user}","gists_url":"https://api.github.com/users/lavaturtle/gists{/gist_id}","starred_url":"https://api.github.com/users/lavaturtle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lavaturtle/subscriptions","organizations_url":"https://api.github.com/users/lavaturtle/orgs","repos_url":"https://api.github.com/users/lavaturtle/repos","events_url":"https://api.github.com/users/lavaturtle/events{/privacy}","received_events_url":"https://api.github.com/users/lavaturtle/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-05-06T16:28:02Z","updated_at":"2022-05-18T20:51:36Z","closed_at":"2022-05-18T20:51:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hi! I'm using Rails 7.0, with ruby 3.1.1, and have just started using the controller `content_security_policy` method.\r\n\r\nI have a helper method something like this:\r\n```\r\nmodule TrackingHelper\r\n  def use_google_analytics?\r\n    # Some logic based on the current hostname and account that returns either true or false\r\n  end\r\nend\r\n```\r\n\r\nI would like to be able to write a content security policy like this:\r\n```\r\nclass MyController\r\n  content_security_policy do |policy|\r\n    script_sources = [:self, 'https://example.com']\r\n    if helpers.use_google_analytics?\r\n      script_sources << 'https://www.googletagmanager.com'\r\n    end\r\n    policy.script_src script_sources\r\n  end\r\nend\r\n```\r\n\r\nBut when I try that, I get errors from within my helper method, because it seems the controller is nil within the helper method. I'm able to successfully use `helpers` methods from _other_ `before_action` methods, so I assume it's something about `content_security_policy` that results in the controller not being passed along to the helper method. Is this a known issue? Would it be possible to enable `helpers` within `content_security_policy`?\r\n\r\nThanks for your time!","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45034/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45034/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45031","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45031/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45031/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45031/events","html_url":"https://github.com/rails/rails/issues/45031","id":1227505053,"node_id":"I_kwDNIULOSSo9nQ","number":45031,"title":"request.remote_ip doesn't equal first value of request.env['HTTP_X_FORWARDED_FOR'] on Render.com","user":{"login":"HalfBloody","id":8057033,"node_id":"MDQ6VXNlcjgwNTcwMzM=","avatar_url":"https://avatars.githubusercontent.com/u/8057033?v=4","gravatar_id":"","url":"https://api.github.com/users/HalfBloody","html_url":"https://github.com/HalfBloody","followers_url":"https://api.github.com/users/HalfBloody/followers","following_url":"https://api.github.com/users/HalfBloody/following{/other_user}","gists_url":"https://api.github.com/users/HalfBloody/gists{/gist_id}","starred_url":"https://api.github.com/users/HalfBloody/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HalfBloody/subscriptions","organizations_url":"https://api.github.com/users/HalfBloody/orgs","repos_url":"https://api.github.com/users/HalfBloody/repos","events_url":"https://api.github.com/users/HalfBloody/events{/privacy}","received_events_url":"https://api.github.com/users/HalfBloody/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-06T07:16:20Z","updated_at":"2022-05-17T14:59:19Z","closed_at":"2022-05-17T14:58:44Z","author_association":"NONE","active_lock_reason":null,"body":"Just found out that request.remote_ip returns the wrong ip address for some request. So, I decided to post this here.\r\n\r\nI'm fairly sure that this is correct, but I don't know enough to pinpoint the exact issue. So I decided to post this here:\r\n\r\n```request.remote_ip``` returns ```172.70.322.178```, the same as ```request.ip```\r\n\r\n```request.env['HTTP_X_FORWARDED_FOR']``` returned ```\"185.249.144.13, 172.70.322.178\"```\r\n\r\n```request.env['HTTP_TRUE_CLIENT_IP']``` equals 185.249.144.13\r\n\r\nThe ip address in HTTP_TRUE_CLIENT_IP is my correct ip address, but somehow request.remote_ip picks up the wrong one.\r\n\r\n```request.env['HTTP_CF_CONNECTING_IP']``` equals 185.249.144.13.\r\n\r\nrequest.env[\"HTTP_CDN_LOOP\"]```  is \"cloudflare\", so this should. be quite common.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nEdit: I created a small app which shows you the value of request.remote_ip and request.env[\"HTTP_X_FORWARDED_FOR\"] and other values on Render.com: https://remote-ip-checker.onrender.com/ (Here is the repo of the app: https://github.com/HalfBloody/remote-ip)\r\n\r\n### Expected behaviour\r\nWhen my ip is ```185.249.144.13``` \r\nand \r\nI'm in a controller \r\nand\r\n```request.env['HTTP_X_FORWARDED_FOR']``` equals ```\"185.249.144.13, 172.70.322.178\"```\r\nand\r\n```request.env['HTTP_TRUE_CLIENT_IP']``` equals ```185.249.144.13```\r\nthen\r\nrequest.remote_ip should return ```185.249.144.13```\r\n\r\nhttps://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For\r\n\r\n\r\n### Actual behavior\r\nWhen my ip is ```185.249.144.13``` \r\nand \r\nI'm in a controller \r\nand\r\n```request.env['HTTP_X_FORWARDED_FOR']``` equals ```\"185.249.144.13, 172.70.322.178\"```\r\nand\r\n```request.env['HTTP_TRUE_CLIENT_IP']``` equals ```185.249.144.13``` < \r\nthen\r\nrequest.remote_ip returns ```172.70.322.178```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.1\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45031/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45031/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45028","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45028/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45028/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45028/events","html_url":"https://github.com/rails/rails/issues/45028","id":1226793960,"node_id":"I_kwDNIULOSR9j6A","number":45028,"title":"[Doc] \"Getting Started\" - the status select is incorrect","user":{"login":"duzenko","id":1481807,"node_id":"MDQ6VXNlcjE0ODE4MDc=","avatar_url":"https://avatars.githubusercontent.com/u/1481807?v=4","gravatar_id":"","url":"https://api.github.com/users/duzenko","html_url":"https://github.com/duzenko","followers_url":"https://api.github.com/users/duzenko/followers","following_url":"https://api.github.com/users/duzenko/following{/other_user}","gists_url":"https://api.github.com/users/duzenko/gists{/gist_id}","starred_url":"https://api.github.com/users/duzenko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/duzenko/subscriptions","organizations_url":"https://api.github.com/users/duzenko/orgs","repos_url":"https://api.github.com/users/duzenko/repos","events_url":"https://api.github.com/users/duzenko/events{/privacy}","received_events_url":"https://api.github.com/users/duzenko/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-05T14:59:59Z","updated_at":"2022-05-08T19:38:33Z","closed_at":"2022-05-08T01:18:22Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nFollowing the Getting started guide, progress to status select section\r\n\r\n### Expected behavior\r\nThe status select should match the DB value (nil - empty)\r\n\r\n### Actual behavior\r\nThe status select is hardcoded to show 'public'\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.4\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [i386-mingw32]\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45028/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45028/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45026","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45026/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45026/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45026/events","html_url":"https://github.com/rails/rails/issues/45026","id":1226649382,"node_id":"I_kwDNIULOSR0vJg","number":45026,"title":"Joining different subclasses of STI table produces wrong SQL (alias missing in WHERE clause)","user":{"login":"lowercase1024","id":52529496,"node_id":"MDQ6VXNlcjUyNTI5NDk2","avatar_url":"https://avatars.githubusercontent.com/u/52529496?v=4","gravatar_id":"","url":"https://api.github.com/users/lowercase1024","html_url":"https://github.com/lowercase1024","followers_url":"https://api.github.com/users/lowercase1024/followers","following_url":"https://api.github.com/users/lowercase1024/following{/other_user}","gists_url":"https://api.github.com/users/lowercase1024/gists{/gist_id}","starred_url":"https://api.github.com/users/lowercase1024/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lowercase1024/subscriptions","organizations_url":"https://api.github.com/users/lowercase1024/orgs","repos_url":"https://api.github.com/users/lowercase1024/repos","events_url":"https://api.github.com/users/lowercase1024/events{/privacy}","received_events_url":"https://api.github.com/users/lowercase1024/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-05T13:06:43Z","updated_at":"2022-08-15T10:20:45Z","closed_at":"2022-08-15T10:20:45Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nThe code is just an example, because I'm not allowed to share sources of my project. \r\nI need to filter `Parent` records based on a condition for `Item1` and another condition for `Item2`. `Item1` and `Item2` are subclasses of STI class `Item`. `Parent` has `has_many` for both of the subclasses through a mapping table (`ItemParent` record). The problem is that the generated SQL has wrong condition for `Item2`. Though it generated an alias for the join condition, it does not use the alias in `where` clause.\r\n\r\n### Steps to reproduce\r\nSee the code below.\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n\r\n  # These are extensions that must be enabled in order to support this database\r\n  enable_extension \"plpgsql\"\r\n\r\n  create_table \"item_parents\", id: :serial, force: :cascade do |t|\r\n    t.integer \"item_id\", null: false\r\n    t.integer \"parent_id\", null: false\r\n    t.index %w[item_id parent_id], name: \"item_parents_item_id_parent_id_uindex\", unique: true\r\n  end\r\n\r\n  create_table \"items\", id: :serial, force: :cascade do |t|\r\n    t.string \"name\", limit: 100, null: false\r\n    t.string \"item_type\", limit: 100, null: false\r\n  end\r\n\r\n  create_table \"parents\", id: :serial, force: :cascade do |t|\r\n    t.string \"name\", limit: 100, null: false\r\n  end\r\n\r\n  add_foreign_key \"item_parents\", \"items\", name: \"item_parents_items_id_fk\"\r\n  add_foreign_key \"item_parents\", \"parents\", name: \"item_parents_parents_id_fk\"\r\nend\r\n\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  self.abstract_class = true\r\nend\r\n\r\nclass Item < ApplicationRecord\r\n  self.primary_key = 'id'\r\n  self.inheritance_column = 'item_type'\r\n\r\n  has_many :item_parents\r\n  has_many :parents, through: :item_parents, class_name: 'Parent', inverse_of: :items\r\nend\r\n\r\nclass Item::Item1 < Item\r\nend\r\n\r\nclass Item::Item2 < Item\r\nend\r\n\r\nclass Parent < ApplicationRecord\r\n  has_many :item_parents, inverse_of: :parent, primary_key: :id, foreign_key: :parent_id\r\n\r\n  has_many :item1s, through: :item_parents, class_name: \"Item::Item1\", source: :item\r\n  has_many :item2s, through: :item_parents, class_name: \"Item::Item2\", source: :item\r\nend\r\n\r\nclass ItemParent < ApplicationRecord\r\n  belongs_to :item\r\n  belongs_to :parent, class_name: 'Parent', inverse_of: :ItemParent, primary_key: :parent_id\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n\r\n    sql_string = Parent\r\n          .joins(:item1s)\r\n          .where(Item::Item1.arel_table[:name].eq(\"i1\"))\r\n          .joins(:item2s)\r\n          .where(Item::Item2.arel_table[:name].eq(\"i2\"))\r\n          .to_sql\r\n\r\n    assert sql_string.include?(\"JOIN \\\"item_parents\\\" \\\"item_parents_parents_join\\\"\")\r\n    assert sql_string.include?(\"JOIN \\\"items\\\" \\\"item2s_parents\\\"\")\r\n    assert !sql_string.include?(\"\\\"items\\\".\\\"name\\\" = 'i2'\"), \"Must use an alias for Item2 condition\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n```sql\r\nSELECT \"parents\".*\r\nFROM \"parents\"\r\n         INNER JOIN \"item_parents\"\r\n                    ON \"item_parents\".\"parent_id\" = \"parents\".\"id\"\r\n         INNER JOIN \"items\"\r\n                    ON \"items\".\"id\" = \"item_parents\".\"item_id\"\r\n                        AND \"items\".\"item_type\" = 'Item::Item1'\r\n\r\n         INNER JOIN \"item_parents\" \"item_parents_parents_join\"\r\n                    ON \"item_parents_parents_join\".\"parent_id\" = \"parents\".\"id\"\r\n         INNER JOIN \"items\" \"item2s_parents\"\r\n                    ON \"item2s_parents\".\"id\" = \"item_parents_parents_join\".\"item_id\"\r\n                        AND \"item2s_parents\".\"item_type\" = 'Item::Item2'\r\n\r\nWHERE \"items\".\"name\" = 'i1' \r\n  AND \"item2s_parents\".\"name\" = 'i2'\r\n```\r\n\r\n### Actual behavior\r\n```sql\r\nSELECT \"parents\".*\r\nFROM \"parents\"\r\n         INNER JOIN \"item_parents\"\r\n                    ON \"item_parents\".\"parent_id\" = \"parents\".\"id\"\r\n         INNER JOIN \"items\"\r\n                    ON \"items\".\"id\" = \"item_parents\".\"item_id\"\r\n                        AND \"items\".\"item_type\" = 'Item::Item1'\r\n\r\n         INNER JOIN \"item_parents\" \"item_parents_parents_join\"\r\n                    ON \"item_parents_parents_join\".\"parent_id\" = \"parents\".\"id\"\r\n         INNER JOIN \"items\" \"item2s_parents\" -- OK. join has an alias\r\n                    ON \"item2s_parents\".\"id\" = \"item_parents_parents_join\".\"item_id\"\r\n                        AND \"item2s_parents\".\"item_type\" = 'Item::Item2'\r\n\r\nWHERE \"items\".\"name\" = 'i1' \r\n  AND \"items\".\"name\" = 'i2' -- Wrong! Must be \"item2s_parents\".\"name\" = 'i2'\r\n```\r\nAnother problem is that I cannot use raw SQL queries instead. We have many filters that applied dynamically based on HTTP requests, many scopes and ordering rules. Keeping track of what's already joined will be a nightmare.\r\n\r\nAny  workarounds for this?\r\n\r\n### System configuration\r\n**Rails version**: \r\n6.0.4.8\r\n**Ruby version**: \r\n2.7.3p183 (2021-04-05 revision 6847ee089d) [arm64-darwin20]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45026/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45026/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45023","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45023/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45023/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45023/events","html_url":"https://github.com/rails/rails/issues/45023","id":1226313978,"node_id":"I_kwDNIULOSRgQ-g","number":45023,"title":"Migration: change_column_default removes column options from schema.rb","user":{"login":"rikvanderkemp","id":347308,"node_id":"MDQ6VXNlcjM0NzMwOA==","avatar_url":"https://avatars.githubusercontent.com/u/347308?v=4","gravatar_id":"","url":"https://api.github.com/users/rikvanderkemp","html_url":"https://github.com/rikvanderkemp","followers_url":"https://api.github.com/users/rikvanderkemp/followers","following_url":"https://api.github.com/users/rikvanderkemp/following{/other_user}","gists_url":"https://api.github.com/users/rikvanderkemp/gists{/gist_id}","starred_url":"https://api.github.com/users/rikvanderkemp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rikvanderkemp/subscriptions","organizations_url":"https://api.github.com/users/rikvanderkemp/orgs","repos_url":"https://api.github.com/users/rikvanderkemp/repos","events_url":"https://api.github.com/users/rikvanderkemp/events{/privacy}","received_events_url":"https://api.github.com/users/rikvanderkemp/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-05T07:51:46Z","updated_at":"2022-05-06T07:52:08Z","closed_at":"2022-05-06T07:52:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nPlease be aware that the test succeeds! The problem lies on the changes in `schema.rb`\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"6.1.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :payments, force: true do |t|\r\n    t.decimal \"amount\", precision: 10, scale: 2, default: \"0.0\", null: false\r\n  end\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass ChangeAmountToAddScale < ActiveRecord::Migration[6.0]\r\n  def change\r\n    reversible do |dir|\r\n      dir.up do\r\n        change_column_default :payments, :amount, nil\r\n      end\r\n\r\n      dir.down do\r\n        change_column_default :payments, :amount, \"0.0\"\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    ChangeAmountToAddScale.migrate(:up)\r\n    Payment.reset_column_information\r\n\r\n    assert_equal \"decimal(10,2)\", Payment.columns.last.sql_type\r\n  end\r\n\r\n  def test_migration_down\r\n    ChangeAmountToAddScale.migrate(:down)\r\n    Payment.reset_column_information\r\n\r\n    assert_equal \"decimal(10,2)\", Payment.columns.last.sql_type\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expected to see the following change in `schema.rb`\r\n\r\n```ruby\r\ncreate_table \"payments\", force: :cascade do |t| \r\n    t.decimal \"amount\", precision: 10, scale: 2, default:  nil, null: false\r\nend\r\n```\r\n\r\n### Actual behavior\r\n\r\nAll options are gone, except for the change in default value.\r\n\r\n```ruby\r\ncreate_table \"payments\", force: :cascade do |t| \r\n    t.decimal \"amount\", default:  nil, null: false\r\nend\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5.1\r\n\r\n**Ruby version**:  2.7.3p183\r\n\r\n\r\n### Additional note\r\nMaybe I misunderstand the underlying functionality but the [documentation only mentions](https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-change_column_default) changes to the default value.\r\n\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45023/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45023/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45017","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45017/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45017/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45017/events","html_url":"https://github.com/rails/rails/issues/45017","id":1225413007,"node_id":"I_kwDNIULOSQpRjw","number":45017,"title":"ActiveRecord silently triggers a rollback when using return in the transaction block in Rails 7","user":{"login":"majkelcc","id":1869402,"node_id":"MDQ6VXNlcjE4Njk0MDI=","avatar_url":"https://avatars.githubusercontent.com/u/1869402?v=4","gravatar_id":"","url":"https://api.github.com/users/majkelcc","html_url":"https://github.com/majkelcc","followers_url":"https://api.github.com/users/majkelcc/followers","following_url":"https://api.github.com/users/majkelcc/following{/other_user}","gists_url":"https://api.github.com/users/majkelcc/gists{/gist_id}","starred_url":"https://api.github.com/users/majkelcc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/majkelcc/subscriptions","organizations_url":"https://api.github.com/users/majkelcc/orgs","repos_url":"https://api.github.com/users/majkelcc/repos","events_url":"https://api.github.com/users/majkelcc/events{/privacy}","received_events_url":"https://api.github.com/users/majkelcc/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-05-04T13:57:57Z","updated_at":"2022-08-16T05:21:24Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\nRAILS_VERSION = \"7.0.2.4\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  gem \"activerecord\", RAILS_VERSION\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :records, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Record < ActiveRecord::Base\r\nend\r\n\r\ndef transaction_with_return\r\n  ActiveRecord::Base.transaction { return Record.create! }\r\nend\r\n\r\ndef transaction_without_return\r\n  ActiveRecord::Base.transaction { Record.create! }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    Record.delete_all\r\n  end\r\n\r\n  def test_transaction_block_with_return\r\n    transaction_with_return\r\n    assert_equal 1, Record.count\r\n  end\r\n\r\n  def test_transaction_block_without_return\r\n    transaction_without_return\r\n    assert_equal 1, Record.count\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nSince using `return` in the transaction block was deprecated in https://github.com/rails/rails/pull/29333, I would expect that ActiveRecord is not triggering a rollback silently.\r\n\r\n### Actual behavior\r\n\r\nActiveRecord silently triggers a rollback when `return` is used in the transaction block.\r\n\r\n### System configuration\r\n**Rails version**: 7.0\r\n\r\n**Ruby version**: 3.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45017/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45017/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45014","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45014/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45014/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45014/events","html_url":"https://github.com/rails/rails/issues/45014","id":1224875648,"node_id":"I_kwDNIULOSQIegA","number":45014,"title":"content_tag HTML attributes beginning with `@` are escaped to `_`","user":{"login":"Lordnibbler","id":199422,"node_id":"MDQ6VXNlcjE5OTQyMg==","avatar_url":"https://avatars.githubusercontent.com/u/199422?v=4","gravatar_id":"","url":"https://api.github.com/users/Lordnibbler","html_url":"https://github.com/Lordnibbler","followers_url":"https://api.github.com/users/Lordnibbler/followers","following_url":"https://api.github.com/users/Lordnibbler/following{/other_user}","gists_url":"https://api.github.com/users/Lordnibbler/gists{/gist_id}","starred_url":"https://api.github.com/users/Lordnibbler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Lordnibbler/subscriptions","organizations_url":"https://api.github.com/users/Lordnibbler/orgs","repos_url":"https://api.github.com/users/Lordnibbler/repos","events_url":"https://api.github.com/users/Lordnibbler/events{/privacy}","received_events_url":"https://api.github.com/users/Lordnibbler/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-05-04T03:02:09Z","updated_at":"2022-05-19T23:18:37Z","closed_at":"2022-05-09T14:08:44Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# rails 7.0.2.4\r\ncontent_tag(:div, \"test\", \"@click\": \"triggerNav()\")\r\n# => \"<div _click=\\\"triggerNav()\\\">test</div>\"\r\n\r\n# rails <=7.0.2.3\r\ncontent_tag(:div, \"test\", \"@click\": \"triggerNav()\")\r\n# => \"<div @click=\\\"triggerNav()\\\">test</div>\"\r\n\r\n```\r\n\r\n### Expected behavior\r\n`content_tag` should output HTML attributes beginning with `@` symbol into the HTML.\r\n\r\n### Actual behavior\r\nCVE 27777 caused a change in behavior in `content_tag` and related HTML helper functions. Providing HTML attributes which begin with a `@` symbol (as used in alpine.js and other libraries) now are escaped to `_`, rendering these helper functions unusable.\r\n\r\nhttps://github.com/rails/rails/commit/649516ce0feb699ae06a8c5e81df75d460cc9a85\r\nhttps://discuss.rubyonrails.org/t/cve-2022-27777-possible-xss-vulnerability-in-action-view-tag-helpers/80534\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45014/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45014/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45011","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45011/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45011/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45011/events","html_url":"https://github.com/rails/rails/issues/45011","id":1223806094,"node_id":"I_kwDNIULOSPHMjg","number":45011,"title":"Executing raw SQL with comments can be very slow","user":{"login":"yassenb","id":531223,"node_id":"MDQ6VXNlcjUzMTIyMw==","avatar_url":"https://avatars.githubusercontent.com/u/531223?v=4","gravatar_id":"","url":"https://api.github.com/users/yassenb","html_url":"https://github.com/yassenb","followers_url":"https://api.github.com/users/yassenb/followers","following_url":"https://api.github.com/users/yassenb/following{/other_user}","gists_url":"https://api.github.com/users/yassenb/gists{/gist_id}","starred_url":"https://api.github.com/users/yassenb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yassenb/subscriptions","organizations_url":"https://api.github.com/users/yassenb/orgs","repos_url":"https://api.github.com/users/yassenb/repos","events_url":"https://api.github.com/users/yassenb/events{/privacy}","received_events_url":"https://api.github.com/users/yassenb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-03T08:13:28Z","updated_at":"2022-05-31T21:34:53Z","closed_at":"2022-05-03T12:49:06Z","author_association":"NONE","active_lock_reason":null,"body":"I noticed the problem after upgrading to Rails 6.1 which starts considering comments starting with `--`. We have some ugly tests executing raw SQL fixture files that have some comments in them and those tests started running so slowly they practically hang. The issue is the Regexp here: https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L39 Unfortunately I'm not so good with regular expressions to explain why this is slow but intuitively it's something to do with multiline matching and a lot of `*`-s causing an exponential number of backtracks when scanning the string. I tested with the corresponding regex in Java so it's not Ruby's regex implementation to blame. A faster solution should be to strip the comments in advance and then run the rest of the regex on the remaining SQL. The problem should boil down to the following script:\r\n\r\n```ruby\r\n# simplified version of https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L39\r\nr = Regexp.new('\\A(?m:(--.*\\n)*)*SELECT')\r\ns = \"-- SELECT 1\\n\"\r\nr.match?(s * 17) # takes several seconds on my laptop\r\n```\r\n\r\n### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"6-1-stable\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\n\r\n# This connection will do for database-independent bug reports.\r\n# Have to set replica: true so that `write_query?` is executed\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\", replica: true)\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_ignoring_comments_in_raw_sql\r\n    Timeout::timeout(1) do\r\n      sql = \"-- select 1\\n\"\r\n      ActiveRecord::Base.connection.execute(sql * 20)\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe comments in the raw SQL are ignored and the query runs fast\r\n\r\n### Actual behavior\r\nThe query runs exponentially slow, based on the amount of comments in it\r\n\r\n### System configuration\r\n**Rails version**: 7-0-stable\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45011/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45011/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45010","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45010/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45010/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45010/events","html_url":"https://github.com/rails/rails/issues/45010","id":1223726693,"node_id":"I_kwDNIULOSPCWZQ","number":45010,"title":"Rails version 7+ breaks with Ruby 3.1+","user":{"login":"MarkusAbtion","id":56392248,"node_id":"MDQ6VXNlcjU2MzkyMjQ4","avatar_url":"https://avatars.githubusercontent.com/u/56392248?v=4","gravatar_id":"","url":"https://api.github.com/users/MarkusAbtion","html_url":"https://github.com/MarkusAbtion","followers_url":"https://api.github.com/users/MarkusAbtion/followers","following_url":"https://api.github.com/users/MarkusAbtion/following{/other_user}","gists_url":"https://api.github.com/users/MarkusAbtion/gists{/gist_id}","starred_url":"https://api.github.com/users/MarkusAbtion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarkusAbtion/subscriptions","organizations_url":"https://api.github.com/users/MarkusAbtion/orgs","repos_url":"https://api.github.com/users/MarkusAbtion/repos","events_url":"https://api.github.com/users/MarkusAbtion/events{/privacy}","received_events_url":"https://api.github.com/users/MarkusAbtion/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-03T06:10:17Z","updated_at":"2022-05-03T19:44:56Z","closed_at":"2022-05-03T19:44:54Z","author_association":"NONE","active_lock_reason":null,"body":"It seems like [this addition](https://github.com/rails/rails/commit/1e56b1d1152e8ab74203db30625116844614cc78#r71711767) broke the integration with Psych 4 and Ruby 3.1.\r\n\r\n### Steps to reproduce\r\n- Install Rails 7\r\n- Install Ruby 3.1\r\n- Setup databases (it should fail here)\r\n\r\n### Expected behavior\r\nThat it works\r\n\r\n### Actual behavior\r\n`Psych 4: aliases in database.yml cause Psych::BadAlias exception`\r\n\r\n### System configuration\r\n**Rails version**: 7+\r\n\r\n**Ruby version**: 3.1+\r\n\r\n@byroot ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45010/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45010/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45008","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45008/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45008/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45008/events","html_url":"https://github.com/rails/rails/issues/45008","id":1223223862,"node_id":"I_kwDNIULOSOjqNg","number":45008,"title":"Unable to Install Rails 5.2 on Ruby 2.5 due to Nokogiri Version Requirement","user":{"login":"obahareth","id":3428118,"node_id":"MDQ6VXNlcjM0MjgxMTg=","avatar_url":"https://avatars.githubusercontent.com/u/3428118?v=4","gravatar_id":"","url":"https://api.github.com/users/obahareth","html_url":"https://github.com/obahareth","followers_url":"https://api.github.com/users/obahareth/followers","following_url":"https://api.github.com/users/obahareth/following{/other_user}","gists_url":"https://api.github.com/users/obahareth/gists{/gist_id}","starred_url":"https://api.github.com/users/obahareth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obahareth/subscriptions","organizations_url":"https://api.github.com/users/obahareth/orgs","repos_url":"https://api.github.com/users/obahareth/repos","events_url":"https://api.github.com/users/obahareth/events{/privacy}","received_events_url":"https://api.github.com/users/obahareth/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-02T18:49:11Z","updated_at":"2022-05-02T19:21:55Z","closed_at":"2022-05-02T19:21:54Z","author_association":"NONE","active_lock_reason":null,"body":"(Originally opened on the repository causing the issue rails/rails-dom-testing#100)\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n1. Install any version of Ruby 2.5\r\n2. Install Rails 5.2\r\n\r\n\r\n```sh\r\ndocker run -it ruby:2.5.9-buster bash\r\ngem install rails -v '5.2.7.1'\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nRuby on Rails should install successfully\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nRuby on Rails fails to install and shows this error:\r\n\r\n```\r\nERROR:  Error installing rails:\r\n\tThe last version of nokogiri (>= 1.6) to support your Ruby & RubyGems was 1.12.5. Try installing it with `gem install nokogiri -v 1.12.5` and then running the current command again\r\n\tnokogiri requires Ruby version >= 2.6, < 3.2.dev. The current ruby version is 2.5.9.229.\r\n```\r\n\r\nThis is due to `actionview` requiring `rails-dom-testing`, which requires `nokogiri \">= 1.6\"`. Since nokogiri release 1.13 Ruby 2.5 is no longer supported.\r\n\r\n### System configuration\r\n**Rails version**:\r\n5.2.7.1\r\n\r\n**Ruby version**:\r\n2.5.9\r\n\r\n### Notes\r\nI know Ruby 2.5 reached EOL but I want to run a legacy app and gradually walk it through the upgrade process.\r\n\r\nAlso Rails 5.2 gem spec says Ruby >= 2.2.2 is required, so is it still expected to work for Ruby >= 2.2?\r\n\r\nWhat's a good way to do solve this issue on my end? \r\nI thought of forking rails and rails-dom-testing but I don't think I can specify a git source in a gemspec file.\r\n\r\nThanks!","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45008/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45008/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45007","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45007/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45007/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45007/events","html_url":"https://github.com/rails/rails/issues/45007","id":1223213671,"node_id":"I_kwDNIULOSOjCZw","number":45007,"title":"Contrast between text and background is too low when searching routes on the routing error page in development in dark mode","user":{"login":"dhughes","id":573772,"node_id":"MDQ6VXNlcjU3Mzc3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/573772?v=4","gravatar_id":"","url":"https://api.github.com/users/dhughes","html_url":"https://github.com/dhughes","followers_url":"https://api.github.com/users/dhughes/followers","following_url":"https://api.github.com/users/dhughes/following{/other_user}","gists_url":"https://api.github.com/users/dhughes/gists{/gist_id}","starred_url":"https://api.github.com/users/dhughes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dhughes/subscriptions","organizations_url":"https://api.github.com/users/dhughes/orgs","repos_url":"https://api.github.com/users/dhughes/repos","events_url":"https://api.github.com/users/dhughes/events{/privacy}","received_events_url":"https://api.github.com/users/dhughes/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-02T18:37:25Z","updated_at":"2022-05-03T15:25:23Z","closed_at":"2022-05-02T19:18:42Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Enable dark mode on your OS. \r\n2. Create a new Rails 6.1 app with `rails new someapp`.  \r\n3. Start the app and navigate to any URL without a matching route. EG: http://localhost:3000/hi_mom\r\n4. Use the provided search field and search for a route that exists. For example: \"conductor/action_mailbox/inbound_emails\"\r\n5. Observe that the matching routes output at the top of the table are exceptionally hard to read and are definitely not accessible.\r\n\r\nHere's an example screenshot:\r\n\r\n![Screen Shot 2022-05-02 at 2 18 09 PM](https://user-images.githubusercontent.com/573772/166302711-97ae5c98-91bc-42c9-bd96-9b71257f1e64.png)\r\n\r\nThis problem is known to occur in Chrome, Firefiox, Safari, and Edge on Mac OS. It is presumed to occur in Windows, though I don't have access to a Windows machine to test and confirm this.\r\n\r\n### Expected behavior\r\nI would expect that the table's search data show highlighted results and with high enough contrast that the text is legible.  For example, something like this:\r\n\r\n![Screen Shot 2022-05-02 at 2 30 30 PM](https://user-images.githubusercontent.com/573772/166304483-5cbe4482-ff6e-4117-a07a-b6ce4f8f2a0c.png)\r\n\r\nThis screenshot shows the CSS having been manually edited in the browser's developer tools to make search result text bold and colored #ddd.\r\n\r\n### Actual behavior\r\nAs shown in the initial screenshot, the contrast of the text shown in the search results in the routes table is too low-contrast to be readable.\r\n\r\n### System configuration\r\n**Rails version**:\r\nThis appears to have been introduced in Rails 6.1. I have explicitly reproduced this in Rails 6.1.4.1. It does _not_ occur in Rails 6.0 or 5.1 which do not appear to support OS dark mode.\r\n\r\n**Ruby version**:\r\n This is known to occur with Ruby 2.6.9, 2.7.4, and 3.03.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45007/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45007/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45006","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45006/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45006/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45006/events","html_url":"https://github.com/rails/rails/issues/45006","id":1223152000,"node_id":"I_kwDNIULOSOfRgA","number":45006,"title":"I can not migrate from webpacker to esbuild ","user":{"login":"dima4p","id":25119,"node_id":"MDQ6VXNlcjI1MTE5","avatar_url":"https://avatars.githubusercontent.com/u/25119?v=4","gravatar_id":"","url":"https://api.github.com/users/dima4p","html_url":"https://github.com/dima4p","followers_url":"https://api.github.com/users/dima4p/followers","following_url":"https://api.github.com/users/dima4p/following{/other_user}","gists_url":"https://api.github.com/users/dima4p/gists{/gist_id}","starred_url":"https://api.github.com/users/dima4p/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dima4p/subscriptions","organizations_url":"https://api.github.com/users/dima4p/orgs","repos_url":"https://api.github.com/users/dima4p/repos","events_url":"https://api.github.com/users/dima4p/events{/privacy}","received_events_url":"https://api.github.com/users/dima4p/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-05-02T17:36:38Z","updated_at":"2022-05-03T13:01:54Z","closed_at":"2022-05-03T13:01:53Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nMy project is using sass, coffeescript, and vue.js. All works perfectly with `webpacker`. It was created with Rails6 and I have upgraded it to Rails7.\r\nSince the `webpacker` is soft deprecated I am trying to migrate do `esbuild`. And there are problems.\r\n\r\n1. There is no official guide how to do that. I have found some unofficial guides but none of them is 100% compatible with my project.\r\n2. To get the assets compiled I have tried 4 or more guides until I got a single `.css` and `.js` files. OK, I've done it.\r\n3. But it turned out, I can not receive `Source map` files. To get the source map for js I was requesting the same file adding to the end \".map\". (See the line 398 in the atttached `.diff` file). Now it does not work. The code below is the failing attempt to get the source map file.\r\n4. The same problem is with source map file for `css`. With both variants for `config.assets.debug`. With `true` value I see in the browser only one file `app.css`, and at the end there is two the magic comments `/*# sourceMappingURL=`. The first has no fingerprint, the second does, but requesting the file results in 404. With `false` value I see the list of all the files that are present in the project. But the content is available only for the `.css` that comes from vue.js. For all other files I see the following message\r\n```\r\nError loading the readable source text: request failed with status 404\r\nAddress of the readable source text: <unknown>\r\n```\r\n5. I should mention that vue.js code does not work as well. \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\nrails (7.0.2.3)\r\n**Ruby version**:\r\nruby '3.1.1'\r\n\r\nI need help!!!\r\n\r\n[esbuild.diff](https://github.com/rails/rails/files/8604971/esbuild.txt)\r\n[Gemfile](https://github.com/rails/rails/files/8604979/Gemfile.txt)\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45006/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45006/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45003","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45003/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45003/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45003/events","html_url":"https://github.com/rails/rails/issues/45003","id":1222977379,"node_id":"I_kwDNIULOSOUnYw","number":45003,"title":"ActiveModel::Type::Date raises for strings longer than 128 characters","user":{"login":"f-mer","id":17234623,"node_id":"MDQ6VXNlcjE3MjM0NjIz","avatar_url":"https://avatars.githubusercontent.com/u/17234623?v=4","gravatar_id":"","url":"https://api.github.com/users/f-mer","html_url":"https://github.com/f-mer","followers_url":"https://api.github.com/users/f-mer/followers","following_url":"https://api.github.com/users/f-mer/following{/other_user}","gists_url":"https://api.github.com/users/f-mer/gists{/gist_id}","starred_url":"https://api.github.com/users/f-mer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f-mer/subscriptions","organizations_url":"https://api.github.com/users/f-mer/orgs","repos_url":"https://api.github.com/users/f-mer/repos","events_url":"https://api.github.com/users/f-mer/events{/privacy}","received_events_url":"https://api.github.com/users/f-mer/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-05-02T14:43:21Z","updated_at":"2022-05-11T15:03:30Z","closed_at":"2022-05-11T15:03:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activemodel\", \"~> 7.0.0\"\r\n\r\nend\r\n\r\nrequire \"active_model\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    assert_nil ActiveModel::Type::Date.new.cast(\" \" * 129)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nAn invalid string longer than 128 characters should parse to `nil`. \r\n\r\n### Actual behavior\r\nIt raises an error: `ArgumentError: string length (129) exceeds the limit 128`.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n\r\n**Ruby version**: ruby 3.1.2p20 (2022-04-12 revision 4491bb740a) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45003/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45003/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/45002","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45002/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45002/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45002/events","html_url":"https://github.com/rails/rails/issues/45002","id":1222892810,"node_id":"I_kwDNIULOSOPdCg","number":45002,"title":"Action Cable: Subscriptions.notify \"Cannot read received of undefined\"","user":{"login":"ppascualv","id":2453682,"node_id":"MDQ6VXNlcjI0NTM2ODI=","avatar_url":"https://avatars.githubusercontent.com/u/2453682?v=4","gravatar_id":"","url":"https://api.github.com/users/ppascualv","html_url":"https://github.com/ppascualv","followers_url":"https://api.github.com/users/ppascualv/followers","following_url":"https://api.github.com/users/ppascualv/following{/other_user}","gists_url":"https://api.github.com/users/ppascualv/gists{/gist_id}","starred_url":"https://api.github.com/users/ppascualv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppascualv/subscriptions","organizations_url":"https://api.github.com/users/ppascualv/orgs","repos_url":"https://api.github.com/users/ppascualv/repos","events_url":"https://api.github.com/users/ppascualv/events{/privacy}","received_events_url":"https://api.github.com/users/ppascualv/received_events","type":"User","site_admin":false},"labels":[{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-05-02T13:30:19Z","updated_at":"2022-06-14T15:18:57Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"This error is still happening I'm using    `\"actioncable\": \"^5.2.7-1\"` and graphql\r\n```\r\nimport ActionCableLink from \"graphql-ruby-client/subscriptions/ActionCableLink\"\r\nimport { relayStylePagination } from \"@apollo/client/utilities\"\r\n\r\nif (typeof window !== \"undefined\") {\r\n  const ActionCable = require(\"actioncable\")\r\n}\r\n\r\nconst wsClient =\r\n  typeof window === \"undefined\"\r\n    ? null\r\n    : ActionCable.createConsumer(`${process.env.NEXT_PUBLIC_WS_URL}?auth_token=${getAuth()}`)\r\n\r\nconst wsLink = typeof window === \"undefined\" ? null : new ActionCableLink({ cable: wsClient })\r\n```\r\n![Screenshot from 2022-04-26 15-26-04](https://user-images.githubusercontent.com/2453682/165997078-4001646d-37e7-4978-a8f2-c1b8ca2e4fba.png)\r\n\r\nThe library that I'm using is handling subscriptions according to docs.\r\nhttps://github.com/rmosolgo/graphql-ruby/blob/master/javascript_client/src/subscriptions/ActionCableSubscriber.ts#L33\r\n\r\n_Originally posted by @ppascualv in https://github.com/rails/rails/issues/43340#issuecomment-1113530439_","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45002/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/45001","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/45001/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/45001/comments","events_url":"https://api.github.com/repos/rails/rails/issues/45001/events","html_url":"https://github.com/rails/rails/issues/45001","id":1222890114,"node_id":"I_kwDNIULOSOPSgg","number":45001,"title":"Wrong links in docs for Ruby on Rails 6","user":{"login":"Kapeli","id":1445635,"node_id":"MDQ6VXNlcjE0NDU2MzU=","avatar_url":"https://avatars.githubusercontent.com/u/1445635?v=4","gravatar_id":"","url":"https://api.github.com/users/Kapeli","html_url":"https://github.com/Kapeli","followers_url":"https://api.github.com/users/Kapeli/followers","following_url":"https://api.github.com/users/Kapeli/following{/other_user}","gists_url":"https://api.github.com/users/Kapeli/gists{/gist_id}","starred_url":"https://api.github.com/users/Kapeli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kapeli/subscriptions","organizations_url":"https://api.github.com/users/Kapeli/orgs","repos_url":"https://api.github.com/users/Kapeli/repos","events_url":"https://api.github.com/users/Kapeli/events{/privacy}","received_events_url":"https://api.github.com/users/Kapeli/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-05-02T13:28:04Z","updated_at":"2022-08-29T18:00:21Z","closed_at":"2022-08-29T18:00:21Z","author_association":"NONE","active_lock_reason":null,"body":"The links at https://api.rubyonrails.org/v6.1.5.1/ point to Ruby on Rails 7. For example, the \"Getting Started with Rails\" link at the bottom takes you to https://guides.rubyonrails.org/getting_started.html, which is for Ruby on Rails 7.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/45001/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/45001/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44997","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44997/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44997/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44997/events","html_url":"https://github.com/rails/rails/issues/44997","id":1222659849,"node_id":"I_kwDNIULOSOBPCQ","number":44997,"title":"`store_accessor` does not work with both MySQL and MariaDB","user":{"login":"mamhoff","id":703401,"node_id":"MDQ6VXNlcjcwMzQwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/703401?v=4","gravatar_id":"","url":"https://api.github.com/users/mamhoff","html_url":"https://github.com/mamhoff","followers_url":"https://api.github.com/users/mamhoff/followers","following_url":"https://api.github.com/users/mamhoff/following{/other_user}","gists_url":"https://api.github.com/users/mamhoff/gists{/gist_id}","starred_url":"https://api.github.com/users/mamhoff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mamhoff/subscriptions","organizations_url":"https://api.github.com/users/mamhoff/orgs","repos_url":"https://api.github.com/users/mamhoff/repos","events_url":"https://api.github.com/users/mamhoff/events{/privacy}","received_events_url":"https://api.github.com/users/mamhoff/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-05-02T09:12:35Z","updated_at":"2022-07-06T11:23:42Z","closed_at":"2022-05-02T13:47:29Z","author_association":"NONE","active_lock_reason":null,"body":" We're maintaining a [Rails Engine](https://github.com/AlchemyCMS/alchemy_cms) that is supposed to work independent of the database in use. In one of our STI models, we use the \r\n`store_accessor` API in order to store some values that depend on the instance type. \r\n\r\nThe syntax we use is: \r\n```rb\r\nclass Alchemy::Ingredient\r\n  self.abstract_class = true\r\nend\r\n```\r\n\r\n```rb\r\nclass Alchemy::Ingredients::Text < Alchemy::Ingredient\r\n  store_accessor :data, :link_target\r\nend\r\n```\r\n\r\nThis works great with Postgres, MySQL and SQLite, as all of those databases have a native JSON(B) column type. With MariaDB, however, we run into a problem: MariaDB does [not natively support JSON](https://mariadb.com/kb/en/json-data-type/), but instead aliases it to `TEXT`. \r\n\r\nThis means that in order to use `store_accessor`, we would need to run `store data, coder: JSON` in the superclass. However, if we do that, the code breaks for those databases that support JSON natively. \r\n\r\nWe've tried several workarounds: \r\n\r\n```rb\r\nclass Alchemy::Ingredient\r\n  self.abstract_class = true\r\n  \r\n    class << self\r\n      # This is done for MariaDB, which needs to be told that\r\n      # `data` is not text, but needs to behave like a JSON column.\r\n      def load_schema!\r\n        super\r\n        if # insert conditions here\r\n           store :data, coder: JSON\r\n        end\r\n      end\r\n    end\r\nend\r\n```\r\n\r\nThis approach fails because `store` needs to be called before the schema is loaded. We've also tried overriding `store_attribute_for` from the [store.rb](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/store.rb#L216-L218) file - also calls `store` too late. \r\n\r\nThis is not so much a bug report as a feature request. I'm not sure what the best path forward could be: \r\n1. Allow running `store` on columns that are already JSON without breaking past behavior\r\n2. Add an extra configuration option to the `database.yml` hash (`flavor: mariadb`), upon which certain model configurations can be made\r\n3. Allow `store` to be called after loading the schema.\r\n\r\n### Expected behavior\r\n\r\nWe would like to be able to use `store_accessor` on MariaDB, MySQL, Postgres and SQLite databases.\r\n\r\n### Actual behavior\r\n\r\nWe have to forgo the benefits of the native JSON type in MySQL, SQLite, and Postgres and use `TEXT`, or we cannot support MariaDB.\r\n\r\n### System configuration\r\n\r\nWe've tried with every permutation of Ruby 2.6 - 3.1 and Rails 6 through 7. See  https://github.com/AlchemyCMS/alchemy_cms/runs/6249316280 for spec runs and https://github.com/AlchemyCMS/alchemy_cms for implementation details.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44997/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44997/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44989","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44989/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44989/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44989/events","html_url":"https://github.com/rails/rails/issues/44989","id":1221839667,"node_id":"I_kwDNIULOSNPLMw","number":44989,"title":"bbgg","user":{"login":"StephanH90","id":88476449,"node_id":"MDQ6VXNlcjg4NDc2NDQ5","avatar_url":"https://avatars.githubusercontent.com/u/88476449?v=4","gravatar_id":"","url":"https://api.github.com/users/StephanH90","html_url":"https://github.com/StephanH90","followers_url":"https://api.github.com/users/StephanH90/followers","following_url":"https://api.github.com/users/StephanH90/following{/other_user}","gists_url":"https://api.github.com/users/StephanH90/gists{/gist_id}","starred_url":"https://api.github.com/users/StephanH90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/StephanH90/subscriptions","organizations_url":"https://api.github.com/users/StephanH90/orgs","repos_url":"https://api.github.com/users/StephanH90/repos","events_url":"https://api.github.com/users/StephanH90/events{/privacy}","received_events_url":"https://api.github.com/users/StephanH90/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-30T14:06:23Z","updated_at":"2022-04-30T14:07:51Z","closed_at":"2022-04-30T14:07:32Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44989/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44989/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44986","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44986/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44986/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44986/events","html_url":"https://github.com/rails/rails/issues/44986","id":1221437808,"node_id":"I_kwDNIULOSM2pcA","number":44986,"title":"Inconsistent behavior when updating polymorphic association from one model to another","user":{"login":"sshao","id":1361309,"node_id":"MDQ6VXNlcjEzNjEzMDk=","avatar_url":"https://avatars.githubusercontent.com/u/1361309?v=4","gravatar_id":"","url":"https://api.github.com/users/sshao","html_url":"https://github.com/sshao","followers_url":"https://api.github.com/users/sshao/followers","following_url":"https://api.github.com/users/sshao/following{/other_user}","gists_url":"https://api.github.com/users/sshao/gists{/gist_id}","starred_url":"https://api.github.com/users/sshao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sshao/subscriptions","organizations_url":"https://api.github.com/users/sshao/orgs","repos_url":"https://api.github.com/users/sshao/repos","events_url":"https://api.github.com/users/sshao/events{/privacy}","received_events_url":"https://api.github.com/users/sshao/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-29T19:26:28Z","updated_at":"2022-06-08T13:07:29Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :pictures, force: true do |t|\r\n    t.references :imageable, polymorphic: true\r\n  end\r\n\r\n  create_table :employees, force: true do |t|\r\n  end\r\n\r\n  create_table :products, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Picture < ActiveRecord::Base\r\n  belongs_to :imageable, polymorphic: true, optional: true\r\nend\r\n\r\nclass Employee < ActiveRecord::Base\r\n  has_one :picture, as: :imageable\r\nend\r\n\r\nclass Product < ActiveRecord::Base\r\n  has_one :picture, as: :imageable\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def swap_pictures(employee, product)\r\n    product.picture = employee.picture\r\n    product.save!\r\n    employee.save!\r\n  end\r\n\r\n  def test_association_stuff\r\n    picture_a = Picture.create!(id: 1)\r\n    picture_b = Picture.create!(id: 2)\r\n    picture_c = Picture.create!(id: 3)\r\n\r\n    employee_a = Employee.create!(id: 1, picture: picture_a)\r\n    employee_b = Employee.create!(id: 4, picture: picture_b) # <- Purposeful ID setting\r\n    employee_c = Employee.create!(id: 3, picture: picture_c)\r\n\r\n    product_a = Product.create!(id: 1)\r\n    product_b = Product.create!(id: 2) # <- ID does not match employee_b's.\r\n    product_c = Product.create!(id: 3)\r\n\r\n    # This passes (employee.id != product.id)\r\n    swap_pictures(employee_b, product_b)\r\n    assert_equal true, employee_b.reload.picture.present?\r\n    assert_equal false, product_b.reload.picture.present?\r\n\r\n    # But these don't (employee.id == product.id)\r\n    swap_pictures(employee_a, product_a)\r\n    assert_equal true, employee_a.reload.picture.present?\r\n    assert_equal false, product_a.reload.picture.present?\r\n\r\n    swap_pictures(employee_c, product_c)\r\n    assert_equal true, employee_c.reload.picture.present?\r\n    assert_equal false, product_c.reload.picture.present?\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nAll 3 should behave the same way with respect to where the `picture` association winds up. In practice it seems like the expected behavior is that the `picture` should remain on Employee after the reload, due to association caching + autosave behavior.\r\n\r\n### Actual behavior\r\nWhen the Employee/Product IDs **do not** match, the expected behavior is seen: the picture remains associated to the Employee. (`employee_b`/`product_b` test case demonstrates this)\r\n\r\nWhen the Employee/Product IDs **do** match, the picture ends up associated to the Product. (both `employee_a`/`product_a` and `employee_c`/`product_c` test cases demonstrate this)\r\n\r\nI think this is due to https://github.com/rails/rails/blob/18707ab17fa492eb25ad2e8f9818a320dc20b823/activerecord/lib/active_record/autosave_association.rb#L470-L474\r\n\r\nAs in the latter 2 cases, Employee.id value happens to == the Product.id value. So `#association_foreign_key_changed` returns false, causing `#save_has_one_association` not to do the autosave.\r\n\r\nThis is probably a fairly specific edge case too: it requires polymorphic associations, this \"association swapping\" behavior, two records that have the same ID, and an autosave.\r\n\r\n### System configuration\r\n**Rails version**:\r\n`rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@89471b2)`\r\n**Ruby version**:\r\n`ruby 3.1.2p20 (2022-04-12 revision 4491bb740a)`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44986/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44986/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44982","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44982/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44982/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44982/events","html_url":"https://github.com/rails/rails/issues/44982","id":1221190370,"node_id":"I_kwDNIULOSMni4g","number":44982,"title":"Cache.fetch error in storing HTTP responses","user":{"login":"cwli24","id":28714891,"node_id":"MDQ6VXNlcjI4NzE0ODkx","avatar_url":"https://avatars.githubusercontent.com/u/28714891?v=4","gravatar_id":"","url":"https://api.github.com/users/cwli24","html_url":"https://github.com/cwli24","followers_url":"https://api.github.com/users/cwli24/followers","following_url":"https://api.github.com/users/cwli24/following{/other_user}","gists_url":"https://api.github.com/users/cwli24/gists{/gist_id}","starred_url":"https://api.github.com/users/cwli24/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cwli24/subscriptions","organizations_url":"https://api.github.com/users/cwli24/orgs","repos_url":"https://api.github.com/users/cwli24/repos","events_url":"https://api.github.com/users/cwli24/events{/privacy}","received_events_url":"https://api.github.com/users/cwli24/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-04-29T16:19:09Z","updated_at":"2022-05-02T20:20:45Z","closed_at":"2022-05-02T20:20:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n      threads[idx] = Thread.new do\r\n        # We'll read from the cache first to see if the data already lives there. \r\n        response = Rails.cache.fetch( tags[idx], expires_in: 3.hours, race_condition_ttl: 2) do\r\n          HTTP.get(EXTDATA_URL, :params => {:tag => tags[idx]})\r\n        end\r\n\r\n        if response.status.success?\r\n          # do some stuff here\r\n        end\r\n      end\r\n    threads.each(&:join) \r\n```\r\n\r\n### Expected behavior\r\nThe GET request to the external URL returns a 'content/json' response, which should be stored into the cache under the respective tag name.\r\n\r\n### Actual behavior\r\nI get this error:\r\n![image](https://user-images.githubusercontent.com/28714891/165983561-f49e92d5-db0a-4fe3-933a-95444dfaed6d.png)\r\nI should note that I tried it with Concurrent-Ruby's Promise, and it was also this cache.fetch line messing causing issues.\r\nIn both cases, to what I can tell, the GET returns with a healthy OK response & associated data, but it seems like the cache just does not like storing it. Can't be a concurrency issue, right, since 3.1 made them thread-safe?\r\n\r\n### System configuration\r\n**Rails version**:  7.0.2.4\r\n\r\n**Ruby version**: 3.1.2p20\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44982/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44982/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44978","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44978/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44978/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44978/events","html_url":"https://github.com/rails/rails/issues/44978","id":1219276820,"node_id":"I_kwDNIULOSKywFA","number":44978,"title":"Recommendations for linking an icloud email address to a mailing function","user":{"login":"LightningRpper","id":54909296,"node_id":"MDQ6VXNlcjU0OTA5Mjk2","avatar_url":"https://avatars.githubusercontent.com/u/54909296?v=4","gravatar_id":"","url":"https://api.github.com/users/LightningRpper","html_url":"https://github.com/LightningRpper","followers_url":"https://api.github.com/users/LightningRpper/followers","following_url":"https://api.github.com/users/LightningRpper/following{/other_user}","gists_url":"https://api.github.com/users/LightningRpper/gists{/gist_id}","starred_url":"https://api.github.com/users/LightningRpper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LightningRpper/subscriptions","organizations_url":"https://api.github.com/users/LightningRpper/orgs","repos_url":"https://api.github.com/users/LightningRpper/repos","events_url":"https://api.github.com/users/LightningRpper/events{/privacy}","received_events_url":"https://api.github.com/users/LightningRpper/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-28T20:50:06Z","updated_at":"2022-05-01T23:40:01Z","closed_at":"2022-05-01T23:40:01Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\r\n\r\nI'm currently working on a website with a contact function and I would like to program that function to link to my icloud email address to send me any emails created through it. But I am not sure on how to fully link the two sources. What are some of your recommendations for using Rails to link to an icloud email account?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44978/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44978/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44975","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44975/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44975/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44975/events","html_url":"https://github.com/rails/rails/issues/44975","id":1218795220,"node_id":"I_kwDNIULOSKVW1A","number":44975,"title":"has_one_attached purges old ttachment on update before any hooks or validations are called","user":{"login":"D4uS1","id":36318394,"node_id":"MDQ6VXNlcjM2MzE4Mzk0","avatar_url":"https://avatars.githubusercontent.com/u/36318394?v=4","gravatar_id":"","url":"https://api.github.com/users/D4uS1","html_url":"https://github.com/D4uS1","followers_url":"https://api.github.com/users/D4uS1/followers","following_url":"https://api.github.com/users/D4uS1/following{/other_user}","gists_url":"https://api.github.com/users/D4uS1/gists{/gist_id}","starred_url":"https://api.github.com/users/D4uS1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/D4uS1/subscriptions","organizations_url":"https://api.github.com/users/D4uS1/orgs","repos_url":"https://api.github.com/users/D4uS1/repos","events_url":"https://api.github.com/users/D4uS1/events{/privacy}","received_events_url":"https://api.github.com/users/D4uS1/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-28T14:13:41Z","updated_at":"2022-08-21T17:15:11Z","closed_at":"2022-08-21T17:15:11Z","author_association":"NONE","active_lock_reason":null,"body":"Hi guys,\r\n\r\nif i use the __has_one_attached__ relation in an active record i am not able to get any information about an old attachment if the attachment has changed. There is no chance, because the blob gets purged before any hook or validation happens.\r\n\r\nIn my opinion this is a very bad behavior, because even if validations on the record fail, the records has_one_attached relation gets updated and there is no chance to prevent this.\r\n\r\n### Steps to reproduce\r\n1. Append an active storage attachment to some active record using\r\n```\r\nhas_one_attached :file\r\n```\r\n\r\n2. Add some __before_validation__ hook to the record that should be called as first callback on create or update\r\n```\r\nbefore_validation :validate_storage_usage\r\n\r\ndef validate_storage_usage\r\n   # try to find out the byte_size of the old blob using attachment_changes[:file]\r\nend\r\n```\r\n\r\n3. Update the record by changing the attachment\r\n\r\n### Expected behavior\r\nInside the hook __validate_storage_usage__ i should be able to get information about the old assigned attachment by using __attachment_changes[:file]__.\r\n\r\n### Actual behavior\r\n__attachment_changes[:file]__ only deliveres information about the new file. At this time the old file got already purged from the blobs.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.1\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44975/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44975/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44974","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44974/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44974/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44974/events","html_url":"https://github.com/rails/rails/issues/44974","id":1218684753,"node_id":"I_kwDNIULOSKOnUQ","number":44974,"title":"fresh_when in combination with CSP not working since 7.0.2.4","user":{"login":"fschwahn","id":57876,"node_id":"MDQ6VXNlcjU3ODc2","avatar_url":"https://avatars.githubusercontent.com/u/57876?v=4","gravatar_id":"","url":"https://api.github.com/users/fschwahn","html_url":"https://github.com/fschwahn","followers_url":"https://api.github.com/users/fschwahn/followers","following_url":"https://api.github.com/users/fschwahn/following{/other_user}","gists_url":"https://api.github.com/users/fschwahn/gists{/gist_id}","starred_url":"https://api.github.com/users/fschwahn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fschwahn/subscriptions","organizations_url":"https://api.github.com/users/fschwahn/orgs","repos_url":"https://api.github.com/users/fschwahn/repos","events_url":"https://api.github.com/users/fschwahn/events{/privacy}","received_events_url":"https://api.github.com/users/fschwahn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-04-28T12:52:01Z","updated_at":"2022-04-30T07:59:22Z","closed_at":"2022-04-29T04:45:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"7.0.2.4\"\r\n  gem 'capybara'\r\n  gem 'selenium-webdriver'\r\n  gem 'webdrivers'\r\n  gem 'puma'\r\nend\r\n\r\nrequire \"rack/test\"\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.content_security_policy do |policy|\r\n    policy.base_uri    :none\r\n    policy.script_src  :strict_dynamic\r\n  end\r\n  config.content_security_policy_nonce_generator = ->(_request) { SecureRandom.base64(16) }\r\n  config.content_security_policy_nonce_directives = %w(script-src)\r\n  config.content_security_policy_report_only = false\r\n\r\n  routes.draw do\r\n    get \"/\" => \"test#index\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  TEMPLATE = DATA.read\r\n\r\n  def index\r\n    fresh_when(etag: \"9b4e7e16173dd6780e9584a68bc5ef07\", last_modified: Time.new(2020, 1, 1).utc) and return\r\n    render inline: TEMPLATE\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < ActionDispatch::SystemTestCase\r\n  driven_by :selenium, using: :chrome\r\n\r\n  def test_returns_success\r\n    page.accept_alert(\"Hello\") do\r\n      page.visit \"/\"\r\n    end\r\n\r\n    page.accept_alert(\"Hello\") do\r\n      page.visit \"/\"\r\n    end\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n__END__\r\n<html>\r\n<head>\r\n  <%= javascript_tag(\"alert('Hello')\", nonce: true) %>\r\n</head>\r\n</html>\r\n```\r\n\r\n### Expected behavior\r\nI'm not sure what's expected here, or if this is just fundamentally incompatible. Cached responses probably shouldn't include CSP headers?\r\n\r\n### Actual behavior\r\nSince #44635 cached responses (using `fresh_when`) also return CSP headers, breaking JS in such pages.\r\n\r\n### System configuration\r\n**Rails version**: 7.2.0.4 (also affects 6.1.5.1, and probably all versions with above mentioned PR).\r\n\r\n**Ruby version**: 2.7.4p191\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44974/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44974/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44972","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44972/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44972/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44972/events","html_url":"https://github.com/rails/rails/issues/44972","id":1218080819,"node_id":"I_kwDNIULOSJpwMw","number":44972,"title":"Rails escapes Vue syntax","user":{"login":"hiromichinomata","id":11964840,"node_id":"MDQ6VXNlcjExOTY0ODQw","avatar_url":"https://avatars.githubusercontent.com/u/11964840?v=4","gravatar_id":"","url":"https://api.github.com/users/hiromichinomata","html_url":"https://github.com/hiromichinomata","followers_url":"https://api.github.com/users/hiromichinomata/followers","following_url":"https://api.github.com/users/hiromichinomata/following{/other_user}","gists_url":"https://api.github.com/users/hiromichinomata/gists{/gist_id}","starred_url":"https://api.github.com/users/hiromichinomata/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hiromichinomata/subscriptions","organizations_url":"https://api.github.com/users/hiromichinomata/orgs","repos_url":"https://api.github.com/users/hiromichinomata/repos","events_url":"https://api.github.com/users/hiromichinomata/events{/privacy}","received_events_url":"https://api.github.com/users/hiromichinomata/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-04-28T01:58:24Z","updated_at":"2022-05-19T23:17:56Z","closed_at":"2022-05-09T14:08:33Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nhttps://github.com/rails/rails/commit/123f42a573f7fcbf391885c135ca809f21615180 changed the behavior of Rails. \r\nAs far as I checked code, `@` in not included in COMMON_DANGEROUS_CHARS.\r\nIs this expected behavior?\r\n\r\nin haml file\r\n\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```haml\r\n= select_tag :some_field_1, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', '@change': 'someFunc()', 'v-model': 'someModel'\r\n= select_tag :some_field_2, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', '@change': 'someFunc()', 'v-model': 'someModel', escape: true\r\n= select_tag :some_field_3, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', '@change': 'someFunc()', 'v-model': 'someModel', escape: false\r\n= select_tag :some_field_4, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', 'v-on:change': 'someFunc()', 'v-model': 'someModel'\r\n= select_tag :some_field_5, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', 'v-on:change': 'someFunc()', 'v-model': 'someModel', escape: true\r\n= select_tag :some_field_6, raw(\"<option>Read</option><option>Write</option>\"), class: 'some-class', 'v-on:change': 'someFunc()', 'v-model': 'someModel', escape: false\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nIn 6.1.5, `@change` still appears in generated HTML\r\n\r\n```html\r\n<select name=\"some_field_1\" id=\"some_field_1\" class=\"some-class\" @change=\"someFunc()\" v-model=\"someModel\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_2\" id=\"some_field_2\" class=\"some-class\" @change=\"someFunc()\" v-model=\"someModel\" escape=\"true\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_3\" id=\"some_field_3\" class=\"some-class\" @change=\"someFunc()\" v-model=\"someModel\" escape=\"false\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_4\" id=\"some_field_4\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_5\" id=\"some_field_5\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\" escape=\"true\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_6\" id=\"some_field_6\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\" escape=\"false\"><option>Read</option><option>Write</option></select>\r\n\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nIn 6.1.5.1, `@change` is escaped\r\n\r\n```html\r\n<select name=\"some_field_1\" id=\"some_field_1\" class=\"some-class\" _change=\"someFunc()\" v-model=\"someModel\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_2\" id=\"some_field_2\" class=\"some-class\" _change=\"someFunc()\" v-model=\"someModel\" escape=\"true\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_3\" id=\"some_field_3\" class=\"some-class\" _change=\"someFunc()\" v-model=\"someModel\" escape=\"false\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_4\" id=\"some_field_4\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_5\" id=\"some_field_5\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\" escape=\"true\"><option>Read</option><option>Write</option></select>\r\n<select name=\"some_field_6\" id=\"some_field_6\" class=\"some-class\" v-on:change=\"someFunc()\" v-model=\"someModel\" escape=\"false\"><option>Read</option><option>Write</option></select>\r\n\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.5.1\r\n\r\n**Ruby version**:\r\n2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44972/reactions","total_count":7,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44972/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44968","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44968/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44968/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44968/events","html_url":"https://github.com/rails/rails/issues/44968","id":1217345458,"node_id":"I_kwDNIULOSI83sg","number":44968,"title":"SQL logging breaks with unnamed query binds","user":{"login":"ushi-as","id":11179182,"node_id":"MDQ6VXNlcjExMTc5MTgy","avatar_url":"https://avatars.githubusercontent.com/u/11179182?v=4","gravatar_id":"","url":"https://api.github.com/users/ushi-as","html_url":"https://github.com/ushi-as","followers_url":"https://api.github.com/users/ushi-as/followers","following_url":"https://api.github.com/users/ushi-as/following{/other_user}","gists_url":"https://api.github.com/users/ushi-as/gists{/gist_id}","starred_url":"https://api.github.com/users/ushi-as/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ushi-as/subscriptions","organizations_url":"https://api.github.com/users/ushi-as/orgs","repos_url":"https://api.github.com/users/ushi-as/repos","events_url":"https://api.github.com/users/ushi-as/events{/privacy}","received_events_url":"https://api.github.com/users/ushi-as/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-27T13:15:54Z","updated_at":"2022-04-28T19:39:20Z","closed_at":"2022-04-28T19:39:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The active record log subscriber raises, when dealing with a query with unnamed binds. The issue was introduced with https://github.com/rails/rails/commit/17c7607167a9294edc64cec43ef32778eb2bd677 A solution could be to disable parameter filtering for unnamed binds.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n::ActiveRecord.connection.exec_query(\"select * from users where username = $1\", \"SQL\", [\"user1\"])\r\n```\r\n\r\n### Expected behavior\r\n\r\nExpected is a log like\r\n\r\n```\r\nDEBUG -- :   SQL (0.1ms)  select * from users where username = $1  [\"user1\"]\r\n```\r\n\r\n### Actual behavior\r\n\r\nIt actually produces the following log\r\n\r\n```\r\nERROR -- : Could not log \"sql.active_record\" event. NoMethodError: undefined method `name' for \"u\":String [\"/var/lib/gems/2.7.0/gems/activerecord-7.0.2.4/lib/active_record/log_subscriber.rb:54:in `block in sql'\"\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.4\r\n\r\n**Ruby version**: 2.7.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44968/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44968/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44964","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44964/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44964/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44964/events","html_url":"https://github.com/rails/rails/issues/44964","id":1216333452,"node_id":"I_kwDNIULOSH_GjA","number":44964,"title":"ActiveRecord malformed SQL statements with `where.missing` and `where.associated` clauses for parent/children associations","user":{"login":"EmCousin","id":9846489,"node_id":"MDQ6VXNlcjk4NDY0ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9846489?v=4","gravatar_id":"","url":"https://api.github.com/users/EmCousin","html_url":"https://github.com/EmCousin","followers_url":"https://api.github.com/users/EmCousin/followers","following_url":"https://api.github.com/users/EmCousin/following{/other_user}","gists_url":"https://api.github.com/users/EmCousin/gists{/gist_id}","starred_url":"https://api.github.com/users/EmCousin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EmCousin/subscriptions","organizations_url":"https://api.github.com/users/EmCousin/orgs","repos_url":"https://api.github.com/users/EmCousin/repos","events_url":"https://api.github.com/users/EmCousin/events{/privacy}","received_events_url":"https://api.github.com/users/EmCousin/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-04-26T18:33:04Z","updated_at":"2022-08-20T06:43:17Z","closed_at":"2022-08-20T06:43:17Z","author_association":"NONE","active_lock_reason":null,"body":"There is an edge case with ActiveRecord's `where.associated` and `where.missing` clauses when using them with same-table parent/children associations, causing those to generate what I believe is not the expected SQL statement.\r\n\r\n## Classic behavior ✅ \r\n\r\n```ruby\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post\r\nend\r\n\r\nPost.where.associated(:comments).to_sql\r\n# => \"SELECT \\\"posts\\\".* FROM \\\"posts\\\" INNER JOIN \\\"comments\\\" ON \\\"comments\\\".\\\"post_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"comments\\\".\\\"id\\\" IS NOT NULL\"\r\n\r\nPost.where.missing(:comments).to_sql\r\n# => \"SELECT \\\"posts\\\".* FROM \\\"posts\\\" LEFT OUTER JOIN \\\"comments\\\" ON \\\"comments\\\".\\\"post_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"comments\\\".\\\"id\\\" IS NULL\"\r\n```\r\n\r\n## Edge case behavior 👁️ \r\n\r\n```ruby\r\nclass Post < ActiveRecord::Base\r\n  belongs_to :template, class_name: \"Post\", inverse_of: :children, optional: true\r\n  has_many :children, class_name: \"Post\", inverse_of: :template, foreign_key: :template_id\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nActiveRecord's `joins` method generates an alias `children_posts`. This alias is properly used in the SQL statement\r\n\r\n```ruby\r\nPost.where.associated(:children).to_sql\r\n# => \"\"SELECT \\\"posts\\\".* FROM \\\"posts\\\" INNER JOIN \\\"posts\\\" \\\"children_posts\\\" ON \\\"children_posts\\\".\\\"template_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"children_posts\\\".\\\"id\\\" IS NOT NULL\"\"\r\n\r\nPost.where.missing(:children).to_sql\r\n# => \"SELECT \\\"posts\\\".* FROM \\\"posts\\\" LEFT OUTER JOIN \\\"posts\\\" \\\"children_posts\\\" ON \\\"children_posts\\\".\\\"template_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"children_posts\\\".\\\"id\\\" IS NULL\"\"\r\n```\r\n\r\n### Actual behavior ❌ \r\n<!-- Tell us what happens instead -->\r\nActiveRecord's `joins` method generates an alias `children_posts`. but that alias is not used in the SQL statement. Instead, it's the original table name `posts`\r\n\r\n```ruby\r\nPost.where.associated(:children).to_sql\r\n# => \"\"SELECT \\\"posts\\\".* FROM \\\"posts\\\" INNER JOIN \\\"posts\\\" \\\"children_posts\\\" ON \\\"children_posts\\\".\\\"template_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"posts\\\".\\\"id\\\" IS NOT NULL\"\"\r\n\r\nPost.where.missing(:children).to_sql\r\n# => \"SELECT \\\"posts\\\".* FROM \\\"posts\\\" LEFT OUTER JOIN \\\"posts\\\" \\\"children_posts\\\" ON \\\"children_posts\\\".\\\"template_id\\\" = \\\"posts\\\".\\\"id\\\" WHERE \\\"posts\\\".\\\"id\\\" IS NULL\"\"\r\n```\r\n\r\n### System configuration\r\n**Rails version**: Edge, `main` branch (to the date of creation of this issue)\r\n\r\n**Ruby version**:  tested on  2.7.4\r\n\r\n### Steps to reproduce\r\n\r\n[This branch](https://github.com/EmCousin/rails/tree/bug/active-record-where-missing-same-table) contains a test that reproduces the problem as well as a proposition to fix it. The solution I came up with is to add a `#aliased_table_name` instance method to the `Reflection` class, that returns the proper alias if needed.\r\n\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nYou can also run the test below. It fails with `rails/rails`'s `main` branch, whereas it succeeds in [`EmCousin/rails/bug/active-record-where-missing-same-table`](https://github.com/EmCousin/rails/tree/bug/active-record-where-missing-same-table) \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  ### The test fails with \"rails/rails\"'s `main` branch ###\r\n  # gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"rails\", github: \"EmCousin/rails\", branch: \"bug/active-record-where-missing-same-table\"\r\n\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.references :template, foreign_key: { to_table: :posts }\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  belongs_to :template, class_name: \"Post\", optional: true\r\n  has_many :children, class_name: \"Post\", inverse_of: :template, foreign_key: :template_id, dependent: :nullify\r\nend\r\n\r\nclass WhereAssociatedMissingTest < Minitest::Test\r\n  def test_where_associated_expected_sql_statement\r\n    expected_sql_statement = <<-SQL.squish\r\n      SELECT \"posts\".*\r\n      FROM \"posts\"\r\n      INNER JOIN \"posts\" \"children_posts\" ON \"children_posts\".\"template_id\" = \"posts\".\"id\"\r\n      WHERE \"children_posts\".\"id\" IS NOT NULL\r\n    SQL\r\n\r\n    assert_equal expected_sql_statement, Post.where.associated(:children).to_sql\r\n  end\r\n\r\n  def test_where_associated_unexpected_sql_statement\r\n    unexpected_sql_statement = <<-SQL.squish\r\n      SELECT \"posts\".*\r\n      FROM \"posts\"\r\n      INNER JOIN \"posts\" \"children_posts\" ON \"children_posts\".\"template_id\" = \"posts\".\"id\"\r\n      WHERE \"posts\".\"id\" IS NOT NULL\r\n    SQL\r\n\r\n    assert unexpected_sql_statement != Post.where.associated(:children).to_sql\r\n  end\r\n\r\n  def test_where_associated\r\n    Post.destroy_all\r\n    post = Post.create!\r\n    post.children << Post.create!\r\n\r\n    assert_equal 2, Post.count\r\n    assert_equal 1, Post.where.associated(:children).count\r\n  end\r\n\r\n  def test_where_missing_expected_sql_statement\r\n    expected_sql_statement = <<-SQL.squish\r\n      SELECT \"posts\".*\r\n      FROM \"posts\"\r\n      LEFT OUTER JOIN \"posts\" \"children_posts\" ON \"children_posts\".\"template_id\" = \"posts\".\"id\"\r\n      WHERE \"children_posts\".\"id\" IS NULL\r\n    SQL\r\n\r\n    assert_equal expected_sql_statement, Post.where.missing(:children).to_sql\r\n  end\r\n\r\n  def test_where_missing_unexpected_sql_statement\r\n    unexpected_sql_statement = <<-SQL.squish\r\n      SELECT \"posts\".*\r\n      FROM \"posts\"\r\n      LEFT OUTER JOIN \"posts\" \"children_posts\" ON \"children_posts\".\"template_id\" = \"posts\".\"id\"\r\n      WHERE \"posts\".\"id\" IS NULL\r\n    SQL\r\n\r\n    assert unexpected_sql_statement != Post.where.missing(:children).to_sql\r\n  end\r\n\r\n  def test_where_missing\r\n    Post.destroy_all\r\n    post = Post.create!\r\n    post.children << Post.create!\r\n\r\n    assert_equal 2, Post.count\r\n    assert_equal 1, Post.where.missing(:children).count\r\n  end\r\nend\r\n\r\n```\r\n\r\nNote : my sincerest apologies for my imperfect English. This is my first issue to the Rails repository. Any suggestions welcome so I can improve it 🙏 ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44964/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44964/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44960","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44960/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44960/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44960/events","html_url":"https://github.com/rails/rails/issues/44960","id":1215827192,"node_id":"I_kwDNIULOSHgM-A","number":44960,"title":"Gem::LoadError on azure-storage-blob (AzureStorage adapter) in  Rails 7","user":{"login":"equivalent","id":721990,"node_id":"MDQ6VXNlcjcyMTk5MA==","avatar_url":"https://avatars.githubusercontent.com/u/721990?v=4","gravatar_id":"","url":"https://api.github.com/users/equivalent","html_url":"https://github.com/equivalent","followers_url":"https://api.github.com/users/equivalent/followers","following_url":"https://api.github.com/users/equivalent/following{/other_user}","gists_url":"https://api.github.com/users/equivalent/gists{/gist_id}","starred_url":"https://api.github.com/users/equivalent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/equivalent/subscriptions","organizations_url":"https://api.github.com/users/equivalent/orgs","repos_url":"https://api.github.com/users/equivalent/repos","events_url":"https://api.github.com/users/equivalent/events{/privacy}","received_events_url":"https://api.github.com/users/equivalent/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-26T11:39:03Z","updated_at":"2022-04-26T19:34:32Z","closed_at":"2022-04-26T19:31:49Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI've upgraded my Ruby form 2.7.4 to 3.1.1 & Rails from 6.1 to 7.0.2.3 \r\n\r\nin my Gemfile I have:\r\n\r\n```\r\ngem \"rails\", \"~> 7.0.0\"\r\n# ...\r\ngem 'mini_magick', '~> 4.8'               # not important\r\ngem \"image_processing\", \"~> 1.2\"          # not importnat\r\ngem \"azure-storage-blob\", require: false  #important\r\ngem 'active_storage_validations'        # https://github.com/igorkasyanchuk/active_storage_validations not imporrtant\r\ngem 'aws-sdk-s3', require: false   \r\n# ...\r\n```\r\n\r\n\r\n\r\nrunning code from https://github.com/rails/rails/blob/main/activestorage/lib/active_storage/service/configurator.rb#L30 in rails console :\r\n\r\n```ruby\r\n bin/rails c\r\nLoading development environment (Rails 7.0.2.3)\r\n3.1.1 :001 > class_name = \"AzureStorage\"\r\n => \"AzureStorage\" \r\n3.1.1 :002 > require \"active_storage/service/#{class_name.to_s.underscore}_service\"\r\n/Users/t/.rvm/gems/ruby-3.1.1@pobble-api/gems/bundler-2.3.12/lib/bundler/rubygems_integration.rb:291:in `block (2 levels) in replace_gem': can't activate azure-storage-blob (>= 2.0), already activated azure-storage-blob-1.1.0. Make sure all dependencies are added to Gemfile. (Gem::LoadError)\r\n3.1.1 :003 > class_name = \"S3\"\r\n => \"S3\" \r\n3.1.1 :004 > require \"active_storage/service/#{class_name.to_s.underscore}_service\"\r\n => true \r\n```\r\n\r\n\r\n### Reason\r\n\r\nin https://github.com/rails/rails/blob/main/activestorage/lib/active_storage/service/azure_storage_service.rb:3\r\n\r\n\r\nthere is a line:\r\n\r\n```\r\ngem \"azure-storage-blob\", \">= 2.0\"\r\n```\r\n\r\n```irb\r\n# in bin/rails c in Ruby 3.1.1 && Rails 7.0.2.3\r\n :001 > gem \"azure-storage-blob\", \">= 2.0\"\r\n/Users/t/.rvm/gems/ruby-3.1.1@pobble-apix/gems/bundler-2.2.27/lib/bundler/rubygems_integration.rb:336:in `block (2 levels) in replace_gem': can't activate azure-storage-blob (>= 2.0), already activated azure-storage-blob-1.1.0. Make sure all dependencies are added to Gemfile. (Gem::LoadError)\r\n```\r\n\r\nI'm suspecting that there's something in Rails 7   causing this not to load properly .\r\n\r\n    \r\n\r\n#### one more note: \r\n\r\nIn my app I use AWS S3 (primary) mirrored to Azure(seconday)   If I disable AzureStorage and only use S3 adapter it's fine, but with Azure storage setup fails. Therefore S3 adapter is not affected by this and [this line is working in s3 adapter  ](https://github.com/rails/rails/blob/main/activestorage/lib/active_storage/service/s3_service.rb#L3)\r\n\r\n```\r\n# in bin/rails c in Ruby 3.1.1 && Rails 7.0.2.3\r\ngem \"aws-sdk-s3\", \"~> 1.48\"\r\n => true \r\n```\r\n\r\n\r\nSeems like  something how azure_storage_blob is being loaded in Ruby 3.1 / Rails 7.0.2.3 because same version of azure_storage_blob in Ruby2.7.4/RoR 6.1 worked  (comment bellow)\r\n\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1\r\n\r\n**bundler version**:  2.3.12\r\n\r\n**azure-storage-blob version:** (1.1.0)\r\n\r\n\r\n\r\n```\r\n# config/storage.yml\r\n\r\namazon_production:\r\n  service: S3\r\n  access_key_id: xxxxx\r\n  secret_access_key: xxxxx\r\n  region: eu-west-2\r\n  bucket: xxxxx\r\n\r\nazure_production:\r\n service: AzureStorage\r\n storage_account_name:  xxxxxx\r\n storage_access_key: xxxxx\r\n container: xxxxx\r\n\r\naws_production_mirrored_to_azure:\r\n  service: Mirror\r\n  primary: amazon_production\r\n  mirrors: [ azure_production ]\r\n\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44960/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44960/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44957","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44957/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44957/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44957/events","html_url":"https://github.com/rails/rails/issues/44957","id":1214935763,"node_id":"I_kwDNIULOSGpy0w","number":44957,"title":"Seed task runs multiple times and breaks with multi-database setup","user":{"login":"vahe","id":1486701,"node_id":"MDQ6VXNlcjE0ODY3MDE=","avatar_url":"https://avatars.githubusercontent.com/u/1486701?v=4","gravatar_id":"","url":"https://api.github.com/users/vahe","html_url":"https://github.com/vahe","followers_url":"https://api.github.com/users/vahe/followers","following_url":"https://api.github.com/users/vahe/following{/other_user}","gists_url":"https://api.github.com/users/vahe/gists{/gist_id}","starred_url":"https://api.github.com/users/vahe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vahe/subscriptions","organizations_url":"https://api.github.com/users/vahe/orgs","repos_url":"https://api.github.com/users/vahe/repos","events_url":"https://api.github.com/users/vahe/events{/privacy}","received_events_url":"https://api.github.com/users/vahe/received_events","type":"User","site_admin":false},"labels":[{"id":107186,"node_id":"MDU6TGFiZWwxMDcxODY=","url":"https://api.github.com/repos/rails/rails/labels/regression","name":"regression","color":"e10c02","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"fatkodima","id":5657035,"node_id":"MDQ6VXNlcjU2NTcwMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5657035?v=4","gravatar_id":"","url":"https://api.github.com/users/fatkodima","html_url":"https://github.com/fatkodima","followers_url":"https://api.github.com/users/fatkodima/followers","following_url":"https://api.github.com/users/fatkodima/following{/other_user}","gists_url":"https://api.github.com/users/fatkodima/gists{/gist_id}","starred_url":"https://api.github.com/users/fatkodima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatkodima/subscriptions","organizations_url":"https://api.github.com/users/fatkodima/orgs","repos_url":"https://api.github.com/users/fatkodima/repos","events_url":"https://api.github.com/users/fatkodima/events{/privacy}","received_events_url":"https://api.github.com/users/fatkodima/received_events","type":"User","site_admin":false},"assignees":[{"login":"fatkodima","id":5657035,"node_id":"MDQ6VXNlcjU2NTcwMzU=","avatar_url":"https://avatars.githubusercontent.com/u/5657035?v=4","gravatar_id":"","url":"https://api.github.com/users/fatkodima","html_url":"https://github.com/fatkodima","followers_url":"https://api.github.com/users/fatkodima/followers","following_url":"https://api.github.com/users/fatkodima/following{/other_user}","gists_url":"https://api.github.com/users/fatkodima/gists{/gist_id}","starred_url":"https://api.github.com/users/fatkodima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatkodima/subscriptions","organizations_url":"https://api.github.com/users/fatkodima/orgs","repos_url":"https://api.github.com/users/fatkodima/repos","events_url":"https://api.github.com/users/fatkodima/events{/privacy}","received_events_url":"https://api.github.com/users/fatkodima/received_events","type":"User","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/82","html_url":"https://github.com/rails/rails/milestone/82","labels_url":"https://api.github.com/repos/rails/rails/milestones/82/labels","id":7758309,"node_id":"MI_kwDNIULOAHZh5Q","number":82,"title":"7.1.0","description":"","creator":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"open_issues":1,"closed_issues":10,"state":"open","created_at":"2022-03-11T16:33:03Z","updated_at":"2022-09-06T18:15:10Z","due_on":null,"closed_at":null},"comments":2,"created_at":"2022-04-25T19:16:31Z","updated_at":"2022-04-26T12:16:22Z","closed_at":"2022-04-26T12:16:22Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create a rails app with Rails version pointing to latest `7-0-stable` branch\r\n2. Create multiple databases [as per docs](https://guides.rubyonrails.org/active_record_multiple_databases.html)\r\n3. Add a print statement in `seeds.rb` file\r\n4. Run db prepare task: `bin/rake db:prepare` - **Notice how print statement is executed multiple times**\r\n6. Create a migration and model for the non-primary database [as per docs](https://guides.rubyonrails.org/active_record_multiple_databases.html#generators-and-migrations), eg:\r\n```\r\nbin/rails generate migration CreateDogs name:string --database animals\r\nbin/rails generate scaffold Dog name:string --database animals\r\n```\r\n7. Add the following to `seeds.rb`\r\n```\r\nDog.create!(name: \"Harry\")\r\n```\r\n\r\n8. Run db prepare task: `bin/rake db:prepare` - **Notice `ActiveRecord::NoDatabaseError` is thrown**\r\n\r\n\r\n### Expected behavior\r\n`seeds.rb` should run (once per environment?) after all the databases are created/migrated.\r\n\r\n### Actual behavior\r\n`seeds.rb` runs for every database after it's created/migrated. If there's an attempt to connect to any database other than the first one created/migrate, an exception is thrown eg:\r\n\r\n```\r\nActiveRecord::NoDatabaseError: We could not find your database: animals.\r\n```\r\n\r\nI think this broke after https://github.com/rails/rails/pull/44820\r\n\r\n### System configuration\r\n**Rails version**: `7-0-stable` branch (ref: 391505c3f2d0859f7394e6bc685ba18567154ad7)\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44957/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44957/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44955","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44955/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44955/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44955/events","html_url":"https://github.com/rails/rails/issues/44955","id":1214692427,"node_id":"I_kwDNIULOSGa8Sw","number":44955,"title":"Savepoints are not used anymore on main","user":{"login":"janko","id":795488,"node_id":"MDQ6VXNlcjc5NTQ4OA==","avatar_url":"https://avatars.githubusercontent.com/u/795488?v=4","gravatar_id":"","url":"https://api.github.com/users/janko","html_url":"https://github.com/janko","followers_url":"https://api.github.com/users/janko/followers","following_url":"https://api.github.com/users/janko/following{/other_user}","gists_url":"https://api.github.com/users/janko/gists{/gist_id}","starred_url":"https://api.github.com/users/janko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janko/subscriptions","organizations_url":"https://api.github.com/users/janko/orgs","repos_url":"https://api.github.com/users/janko/repos","events_url":"https://api.github.com/users/janko/events{/privacy}","received_events_url":"https://api.github.com/users/janko/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-25T15:34:53Z","updated_at":"2022-04-26T14:56:38Z","closed_at":"2022-04-26T14:56:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Background\r\n\r\nI wanted to start testing [sequel-activerecord_connection](https://github.com/janko/sequel-activerecord_connection) with edge Active Record, to be on top of any potential breaking changes.\r\n\r\n### Steps to reproduce\r\n\r\n```rb\r\nrequire \"bundler/inline\"\r\n\r\ngemfile do\r\n  source \"https://rubygems.org\"\r\n  gem \"activerecord\", github: \"rails/rails\", glob: \"activerecord/activerecord.gemspec\"\r\n  gem \"activesupport\", github: \"rails/rails\", glob: \"activesupport/activesupport.gemspec\"\r\n  gem \"activemodel\", github: \"rails/rails\", glob: \"activemodel/activemodel.gemspec\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"postgresql\", database: \"janko\")\r\nActiveRecord::Base.connection.disable_lazy_transactions!\r\nActiveRecord::Base.logger = Logger.new($stdout)\r\n\r\nActiveRecord::Base.transaction do\r\n  ActiveRecord::Base.transaction(requires_new: true) do\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expected savepoints to be used, like they have been up to version 7.0:\r\n\r\n```sql\r\nBEGIN\r\nSAVEPOINT active_record_1\r\nRELEASE SAVEPOINT active_record_1\r\nCOMMIT\r\n```\r\n\r\n### Actual behavior\r\n\r\nInstead, the SQL generated is starting a new transaction:\r\n\r\n```sql\r\nBEGIN\r\nBEGIN\r\nCOMMIT\r\n```\r\n\r\nI understand this is the result of https://github.com/rails/rails/pull/44526, but I don't see any mentions of this change in behaviour in the changelog. If I understand correctly, the new transaction restarting should have the exact same behaviour as savepoints?\r\n\r\nI noticed ruby-pg/libpq is printing out a warning before the second `BEGIN`, is that expected?\r\n\r\n```\r\nWARNING:  there is already a transaction in progress\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: edge\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44955/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44952","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44952/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44952/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44952/events","html_url":"https://github.com/rails/rails/issues/44952","id":1213737275,"node_id":"I_kwDNIULOSFgpOw","number":44952,"title":"JavaScript directory missing in my rails 7.0.2.3 app directory","user":{"login":"omokehinde","id":13729974,"node_id":"MDQ6VXNlcjEzNzI5OTc0","avatar_url":"https://avatars.githubusercontent.com/u/13729974?v=4","gravatar_id":"","url":"https://api.github.com/users/omokehinde","html_url":"https://github.com/omokehinde","followers_url":"https://api.github.com/users/omokehinde/followers","following_url":"https://api.github.com/users/omokehinde/following{/other_user}","gists_url":"https://api.github.com/users/omokehinde/gists{/gist_id}","starred_url":"https://api.github.com/users/omokehinde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/omokehinde/subscriptions","organizations_url":"https://api.github.com/users/omokehinde/orgs","repos_url":"https://api.github.com/users/omokehinde/repos","events_url":"https://api.github.com/users/omokehinde/events{/privacy}","received_events_url":"https://api.github.com/users/omokehinde/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":21,"created_at":"2022-04-24T18:55:38Z","updated_at":"2022-06-29T14:16:18Z","closed_at":"2022-06-29T14:14:15Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI am using 7.0.2.3 and ruby ruby 3.1.0p0 on windows 11 to build a rails application. when I run\r\n<!-- rails new app_name  -->\r\n\r\n<!--Bundle complete! 15 Gemfile dependencies, 69 gems now installed.\r\nUse `bundle info [gemname]` to see where a bundled gem is installed.\r\n         run  bundle binstubs bundler\r\n       rails  importmap:install\r\nrails aborted!\r\nTZInfo::DataSourceNotFound: tzinfo-data is not present. Please add gem 'tzinfo-data' to your Gemfile and run bundle install\r\nC:/Users/OMOKEHINDE/Documents/RailsProjects/app_name/config/environment.rb:5:in `<main>'\r\n\r\nCaused by:\r\nTZInfo::DataSources::ZoneinfoDirectoryNotFound: None of the paths included in TZInfo::DataSources::ZoneinfoDataSource.search_path are valid zoneinfo directories.\r\nC:/Users/OMOKEHINDE/Documents/RailsProjects/app_name/config/environment.rb:5:in `<main>'\r\nTasks: TOP => app:template => environment -->\r\n```ruby\r\n# rails new app_name\r\n```\r\n\r\n### Expected behavior\r\n<!-- I expected this to run, complete the installation with the javascript directory inside the app directory of my project -->\r\n\r\n### Actual behavior\r\n<!-- I can't find the javascript directory inside my project app directory -->\r\n\r\n### System configuration\r\n**Rails 7.0.2.3**:\r\n\r\n**Ruby 3.1.0p0**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44952/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44952/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44948","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44948/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44948/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44948/events","html_url":"https://github.com/rails/rails/issues/44948","id":1213589208,"node_id":"I_kwDNIULOSFXm2A","number":44948,"title":"`simple_format` with blank `wrapper_tag` option returns nonsence HTML tag","user":{"login":"JunichiIto","id":1148320,"node_id":"MDQ6VXNlcjExNDgzMjA=","avatar_url":"https://avatars.githubusercontent.com/u/1148320?v=4","gravatar_id":"","url":"https://api.github.com/users/JunichiIto","html_url":"https://github.com/JunichiIto","followers_url":"https://api.github.com/users/JunichiIto/followers","following_url":"https://api.github.com/users/JunichiIto/following{/other_user}","gists_url":"https://api.github.com/users/JunichiIto/gists{/gist_id}","starred_url":"https://api.github.com/users/JunichiIto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JunichiIto/subscriptions","organizations_url":"https://api.github.com/users/JunichiIto/orgs","repos_url":"https://api.github.com/users/JunichiIto/repos","events_url":"https://api.github.com/users/JunichiIto/events{/privacy}","received_events_url":"https://api.github.com/users/JunichiIto/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-24T08:44:14Z","updated_at":"2022-04-24T18:36:05Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nUse `simple_format` method with blank `wrapper_tag` option.\r\n\r\n```ruby\r\nsimple_format(nil, {}, { wrapper_tag: \"\" })\r\n```\r\n\r\nSome people try to remove wrapper tag from the result of `simple_format` method, so they give an empty string to `wrapper_tag` option.\r\n\r\n### Expected behavior\r\n\r\nIt should fallback to `p` tag:\r\n\r\n```ruby\r\n\"<p></p>\"\r\n```\r\n\r\nOr return no wrapper tags:\r\n\r\n```ruby\r\n\"\"\r\n```\r\n\r\nOr raise ArgumentError.\r\n\r\n### Actual behavior\r\n\r\nIt returns the following HTML:\r\n\r\n```ruby\r\n\"<></>\"\r\n```\r\n\r\nBut it is nonsense.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44948/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44948/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44946","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44946/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44946/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44946/events","html_url":"https://github.com/rails/rails/issues/44946","id":1213451475,"node_id":"I_kwDNIULOSFPM0w","number":44946,"title":"Cannot create model with attached activestorage file with strict_loading set to true","user":{"login":"javinto","id":363831,"node_id":"MDQ6VXNlcjM2MzgzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/363831?v=4","gravatar_id":"","url":"https://api.github.com/users/javinto","html_url":"https://github.com/javinto","followers_url":"https://api.github.com/users/javinto/followers","following_url":"https://api.github.com/users/javinto/following{/other_user}","gists_url":"https://api.github.com/users/javinto/gists{/gist_id}","starred_url":"https://api.github.com/users/javinto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javinto/subscriptions","organizations_url":"https://api.github.com/users/javinto/orgs","repos_url":"https://api.github.com/users/javinto/repos","events_url":"https://api.github.com/users/javinto/events{/privacy}","received_events_url":"https://api.github.com/users/javinto/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","site_admin":false},"assignees":[{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-04-23T20:46:46Z","updated_at":"2022-08-30T21:40:39Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nCreate a simple model with\r\n\r\nhas_one_attached :profile, strict_loading: true\r\n\r\nThen create the model with a such a profile (file). \r\n\r\nAn ActiveRecord::StrictLoadingViolationError is raised while the model is being created. \r\n\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one_attached :profile, strict_loading: true\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_upload_and_download\r\n    user = User.create!(\r\n      profile: {\r\n        content_type: \"text/plain\",\r\n        filename: \"dummy.txt\",\r\n        io: ::StringIO.new(\"dummy\"),\r\n      }\r\n    )\r\n\r\n    assert_equal \"dummy\", user.profile.download\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nThe strict_loading validation should not occur on creating the record, only on reading it. \r\n\r\n### Actual behavior\r\nAn ActiveRecord::StrictLoadingViolationError is raised. \r\n\r\n### System configuration\r\n**Rails 7.0.2.3**:\r\n\r\n**Ruby 3.1.2**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44946/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44946/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44940","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44940/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44940/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44940/events","html_url":"https://github.com/rails/rails/issues/44940","id":1212885906,"node_id":"I_kwDNIULOSEsrkg","number":44940,"title":"`params.permit(...)` causes \"Comparing equality between `ActionController::Parameters` and a `Hash`\" deprecation","user":{"login":"nvasilevski","id":5512772,"node_id":"MDQ6VXNlcjU1MTI3NzI=","avatar_url":"https://avatars.githubusercontent.com/u/5512772?v=4","gravatar_id":"","url":"https://api.github.com/users/nvasilevski","html_url":"https://github.com/nvasilevski","followers_url":"https://api.github.com/users/nvasilevski/followers","following_url":"https://api.github.com/users/nvasilevski/following{/other_user}","gists_url":"https://api.github.com/users/nvasilevski/gists{/gist_id}","starred_url":"https://api.github.com/users/nvasilevski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nvasilevski/subscriptions","organizations_url":"https://api.github.com/users/nvasilevski/orgs","repos_url":"https://api.github.com/users/nvasilevski/repos","events_url":"https://api.github.com/users/nvasilevski/events{/privacy}","received_events_url":"https://api.github.com/users/nvasilevski/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-22T22:32:52Z","updated_at":"2022-06-01T23:51:34Z","closed_at":"2022-06-01T23:51:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI'm willing to have a closer look myself, just wanted to make the issue visible while I'm gathering context.\r\n\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    post \"/\" => \"test#do_thing\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def do_thing\r\n    params[:params].permit(\r\n      key1: {}\r\n    )\r\n\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    params = {\r\n      key1: {\r\n        a:[{same_key: {c: 1}}],\r\n        b:[{same_key: {c: 1}}]\r\n      }\r\n    }\r\n    \r\n    post \"/\", params: params\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nNo deprecation output\r\n\r\n### Actual behavior\r\n\r\nDeprecation shown:\r\n\r\n```\r\nDEPRECATION WARNING: Comparing equality between `ActionController::Parameters` and a `Hash` is deprecated and will be removed in Rails 7.2. Please only do comparisons between instances of `ActionController::Parameters`. If you need to compare to a hash, first convert it using `ActionController::Parameters#new`. To disable the deprecated behaviour set `Rails.application.config.action_controller.allow_deprecated_parameters_hash_equality = false`. (called from do_thing at permit_params.rb:30)\r\n```\r\n\r\nThe stack trace is misleading, it actually caused by `Set#<<` call here:\r\nhttps://github.com/rails/rails/blob/86980d1a9d6978cffc4282747d7c9906ead55ff7/actionpack/lib/action_controller/metal/strong_parameters.rb#L995\r\n\r\nWhere `converted_arrays` is a set `#<Set: {[#<ActionController::Parameters {\"same_key\"=>#<ActionController::Parameters {\"c\"=>\"1\"} permitted: false>} permitted: false>]}>` and `converted.dup` is an `Array` `[#<ActionController::Parameters {\"same_key\"=>{\"c\"=>\"1\"}} permitted: false>]`\r\n\r\n\r\n### System configuration\r\n**Rails version**: `main` branch, presumably starting from https://github.com/rails/rails/pull/44816\r\n\r\n**Ruby version**: Should be reproducible on `2.7`, `3.0`, `3.1`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44940/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44940/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44939","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44939/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44939/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44939/events","html_url":"https://github.com/rails/rails/issues/44939","id":1212877159,"node_id":"I_kwDNIULOSEsJZw","number":44939,"title":"Jezyk","user":{"login":"Suis94","id":101783554,"node_id":"U_kgDOBhEYAg","avatar_url":"https://avatars.githubusercontent.com/u/101783554?v=4","gravatar_id":"","url":"https://api.github.com/users/Suis94","html_url":"https://github.com/Suis94","followers_url":"https://api.github.com/users/Suis94/followers","following_url":"https://api.github.com/users/Suis94/following{/other_user}","gists_url":"https://api.github.com/users/Suis94/gists{/gist_id}","starred_url":"https://api.github.com/users/Suis94/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Suis94/subscriptions","organizations_url":"https://api.github.com/users/Suis94/orgs","repos_url":"https://api.github.com/users/Suis94/repos","events_url":"https://api.github.com/users/Suis94/events{/privacy}","received_events_url":"https://api.github.com/users/Suis94/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-22T22:25:20Z","updated_at":"2022-04-22T23:01:21Z","closed_at":"2022-04-22T23:01:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44939/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44936","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44936/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44936/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44936/events","html_url":"https://github.com/rails/rails/issues/44936","id":1212467295,"node_id":"I_kwDNIULOSETIXw","number":44936,"title":"ActionController exception classes are not available when application first starts up","user":{"login":"chrisbloom7","id":21250,"node_id":"MDQ6VXNlcjIxMjUw","avatar_url":"https://avatars.githubusercontent.com/u/21250?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisbloom7","html_url":"https://github.com/chrisbloom7","followers_url":"https://api.github.com/users/chrisbloom7/followers","following_url":"https://api.github.com/users/chrisbloom7/following{/other_user}","gists_url":"https://api.github.com/users/chrisbloom7/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisbloom7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisbloom7/subscriptions","organizations_url":"https://api.github.com/users/chrisbloom7/orgs","repos_url":"https://api.github.com/users/chrisbloom7/repos","events_url":"https://api.github.com/users/chrisbloom7/events{/privacy}","received_events_url":"https://api.github.com/users/chrisbloom7/received_events","type":"User","site_admin":true},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-22T14:57:11Z","updated_at":"2022-05-03T17:03:54Z","closed_at":"2022-05-03T17:03:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWe have an error reporting & handling library that is bootstrapped from `config/application.rb` after all of the boilerplate railties `requires`. It has a setting that allows it to ignore certain error classes based on an ENV variable. It works fine for standard error classes like `\"NameError, ZeroDivisionError\"`, but we've found that in some Rails apps adding certain ActionController exceptions causes the server to fail upon starting with `uninitialized constant ActionController::UnknownHttpMethod (NameError)`\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\nend\r\n\r\nrequire \"rack/test\"\r\nrequire \"rails\"\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  # UNCOMMENT THIS LINE TO RESOLVE THE NameError EXCEPTION\r\n  # require \"action_controller/metal/exceptions\"\r\n\r\n  ENV[\"IGNORED_ERROR_CLASSES\"] = \"ActionController::UnknownHttpMethod\"\r\n  MyExceptionHandler.ignored_error_classes = ENV[\"IGNORED_ERROR_CLASSES\"].split(\",\").map do |class_name|\r\n    # Results in uninitialized constant ActionController::UnknownHttpMethod (NameError)\r\n    Module.const_get(class_name.strip)\r\n  end\r\n\r\n  routes.draw do\r\n    get \"/\" => \"test#index\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    get \"/\"\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expect the ActionController exceptions to be available via autoloading early on so I can reference them in exception handlers or other aspects of the application boot process. While this can currently be achieved by calling `require \"action_controller/metal/exceptions\"`, that's only useful when you know to expect that you will need one of these exceptions. Since our error handling gem looks to an ENV variable to decide what to load, it can't know ahead of time if it will need them, nor can including applications since we might set different values per environment or deploy type, or just-in-time via command line.\r\n\r\n### Actual behavior\r\n\r\nThe Rails app fails to load with a `uninitialized constant ActionController::UnknownHttpMethod (NameError)` exception.\r\n\r\nIf we add some puts debugging to that block to examine what constants are available on ActionController at that moment we won't see `UnknownHttpMethod` or any of its siblings. Those are defined in [actionpack/lib/action_controller/metal/exceptions.rb](https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/metal/exceptions.rb), and we do indeed see the `Metal` constant in the list of registered constants. In [actionpack/lib/action_controller.rb](https://github.com/rails/rails/blob/main/actionpack/lib/action_controller.rb#L20-L50) we see that `autoload_under \"metal\"` includes many modules, but not an `Exceptions` module - indeed the exceptions in `actionpack/lib/action_controller/metal/exceptions.rb` are not wrapped in an exception module that could be autoloaded nor are they `required` like `action_controller/metal/strong_parameters.rb` (also not wrapped in a module). These exceptions only appear to be [loaded from other modules](https://github.com/rails/rails/search?q=metal%2Fexceptions+-path%3Aguides) under ActionDispatch and ActionController, such as `actionpack/lib/action_controller/metal/data_streaming.rb` and `actionpack/lib/action_controller/metal/[request_forgery_protection.rb` which _are_ marked for autoloading, but still only make the exceptions available on ActionController once they are loaded.\r\n\r\n### System configuration\r\n\r\n**Rails version**: Tested in Rails 7.0 and 6.1.4\r\n\r\n**Ruby version**: 2.7.1, 3.0.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44936/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44936/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44933","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44933/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44933/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44933/events","html_url":"https://github.com/rails/rails/issues/44933","id":1212121461,"node_id":"I_kwDNIULOSD-BdQ","number":44933,"title":"When using upsert_all, one cannot update only the timestamp attributes","user":{"login":"zog","id":254393,"node_id":"MDQ6VXNlcjI1NDM5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/254393?v=4","gravatar_id":"","url":"https://api.github.com/users/zog","html_url":"https://github.com/zog","followers_url":"https://api.github.com/users/zog/followers","following_url":"https://api.github.com/users/zog/following{/other_user}","gists_url":"https://api.github.com/users/zog/gists{/gist_id}","starred_url":"https://api.github.com/users/zog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zog/subscriptions","organizations_url":"https://api.github.com/users/zog/orgs","repos_url":"https://api.github.com/users/zog/repos","events_url":"https://api.github.com/users/zog/events{/privacy}","received_events_url":"https://api.github.com/users/zog/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-04-22T09:47:07Z","updated_at":"2022-07-31T10:55:33Z","closed_at":"2022-07-31T10:55:33Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\n# Make sure tu run `createdb railstestdb` beforehand\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"postgresql\", database: \"railstestdb\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.string :title\r\n    t.timestamps\r\n    t.index :title, unique: true\r\n  end\r\n\r\n  create_table :others, force: true do |t|\r\n    t.string :title\r\n    t.string :label\r\n    t.timestamps\r\n    t.index :title, unique: true\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass Other < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_working\r\n    Other.create title: \"foo\"\r\n   \r\n    # as `label` is not in uniqueness key, we get \"ON CONFLICT UPDATE ...\"\r\n    res = Other.upsert_all(\r\n      [{ title: \"foo\", label: \"bar\" }],\r\n      unique_by: :title,\r\n      returning: [:id, :title]\r\n    )\r\n\r\n    assert_equal 1, res.count\r\n  end\r\n\r\n  def test_failing\r\n    Post.create title: \"foo\"\r\n   \r\n    # all the fields we want to update are in the uniqueness key, we get \"ON CONFLICT DO NOTHING\"\r\n    res = Post.upsert_all(\r\n      [{ title: \"foo\" }],\r\n      unique_by: :title,\r\n      returning: [:id, :title]\r\n    )\r\n\r\n    assert_equal 1, res.count\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nWhen trying to upsert values in a table, if all the fields are present in the uniqueness key, it should update timestamps attributes on conflict, and return the corresponding rows .\r\n\r\n### Actual behavior\r\nIt does nothing on conflict, and returns an empty collection.\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44933/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44930","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44930/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44930/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44930/events","html_url":"https://github.com/rails/rails/issues/44930","id":1211119877,"node_id":"I_kwDNIULOSDA5BQ","number":44930,"title":"Getting error on wsl visual studio on running terraspace command ","user":{"login":"Vikram-96","id":82946675,"node_id":"MDQ6VXNlcjgyOTQ2Njc1","avatar_url":"https://avatars.githubusercontent.com/u/82946675?v=4","gravatar_id":"","url":"https://api.github.com/users/Vikram-96","html_url":"https://github.com/Vikram-96","followers_url":"https://api.github.com/users/Vikram-96/followers","following_url":"https://api.github.com/users/Vikram-96/following{/other_user}","gists_url":"https://api.github.com/users/Vikram-96/gists{/gist_id}","starred_url":"https://api.github.com/users/Vikram-96/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vikram-96/subscriptions","organizations_url":"https://api.github.com/users/Vikram-96/orgs","repos_url":"https://api.github.com/users/Vikram-96/repos","events_url":"https://api.github.com/users/Vikram-96/events{/privacy}","received_events_url":"https://api.github.com/users/Vikram-96/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-21T14:24:00Z","updated_at":"2022-04-21T15:53:54Z","closed_at":"2022-04-21T15:53:54Z","author_association":"NONE","active_lock_reason":null,"body":"\r\nTraceback (most recent call last):\r\n        20: from /opt/terraspace/embedded/bin/terraspace:23:in `<main>'\r\n        19: from /opt/terraspace/embedded/bin/terraspace:23:in `load'\r\n        18: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/terraspace-0.6.19/exe/terraspace:11:in `<top (required)>'\r\n        17: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n        16: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n        15: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/terraspace-0.6.19/lib/terraspace.rb:10:in `<top (required)>'\r\n        14: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:35:in `require'\r\n        13: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n        12: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n        11: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/core_ext/hash.rb:3:in `<top (required)>'\r\n        10: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:35:in `require'\r\n         9: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n         8: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n         7: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/core_ext/hash/conversions.rb:3:in `<top (required)>'\r\n         6: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:35:in `require'\r\n         5: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n         4: from /opt/terraspace/embedded/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:83:in `require'\r\n         3: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/xml_mini.rb:11:in `<top (required)>'\r\n         2: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/xml_mini.rb:201:in `<module:ActiveSupport>'\r\n         1: from /opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/xml_mini.rb:103:in `backend='\r\n/opt/terraspace/embedded/lib/ruby/gems/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/xml_mini.rb:184:in `current_thread_backend': uninitialized constant ActiveSupport::XmlMini::IsolatedExecutionState (NameError)\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44930/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44930/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44926","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44926/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44926/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44926/events","html_url":"https://github.com/rails/rails/issues/44926","id":1209721966,"node_id":"I_kwDNIULOSBrkbg","number":44926,"title":"Rails 6.1: where.not raises ArgumentError: Unsupported argument type: chain (Symbol)","user":{"login":"guillaumebriday","id":8252238,"node_id":"MDQ6VXNlcjgyNTIyMzg=","avatar_url":"https://avatars.githubusercontent.com/u/8252238?v=4","gravatar_id":"","url":"https://api.github.com/users/guillaumebriday","html_url":"https://github.com/guillaumebriday","followers_url":"https://api.github.com/users/guillaumebriday/followers","following_url":"https://api.github.com/users/guillaumebriday/following{/other_user}","gists_url":"https://api.github.com/users/guillaumebriday/gists{/gist_id}","starred_url":"https://api.github.com/users/guillaumebriday/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guillaumebriday/subscriptions","organizations_url":"https://api.github.com/users/guillaumebriday/orgs","repos_url":"https://api.github.com/users/guillaumebriday/repos","events_url":"https://api.github.com/users/guillaumebriday/events{/privacy}","received_events_url":"https://api.github.com/users/guillaumebriday/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-20T13:50:58Z","updated_at":"2022-04-22T08:49:38Z","closed_at":"2022-04-22T08:49:35Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\nAfter upgrading from Rails `6.0` to Rails `6.1`, I have this error when using a simple `where.not`.\r\n\r\nI have no idea why but it seems to be raised at this line: https://github.com/rails/rails/blob/6-1-stable/activerecord/lib/active_record/relation/query_methods.rb#L1097\r\n\r\nIn my example, the parameter `opts` is equal to `:chain` in Rails 6.1 and `{:id => 5}` in Rails 6.0. That is why it raises an error.\r\n\r\nAny idea why? Thanks in advance\r\n\r\n### Expected behavior\r\n```ruby\r\nStatus.where.not(id: 5)\r\n#=> []\r\n```\r\n\r\n### Actual behavior\r\n```ruby\r\nStatus.where.not(id: 5)\r\n#=> ArgumentError: Unsupported argument type: chain (Symbol)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 2.7.6\r\n\r\nI'm using `config.autoloader = :classic` I'm not sure if it could have an impact...\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44926/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44926/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44924","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44924/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44924/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44924/events","html_url":"https://github.com/rails/rails/issues/44924","id":1208860037,"node_id":"I_kwDNIULOSA29hQ","number":44924,"title":"Rails 6.1: has_many_inversing breaks belongs_to relations when having multple belongs_to for a given model","user":{"login":"jonasporto","id":2723477,"node_id":"MDQ6VXNlcjI3MjM0Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/2723477?v=4","gravatar_id":"","url":"https://api.github.com/users/jonasporto","html_url":"https://github.com/jonasporto","followers_url":"https://api.github.com/users/jonasporto/followers","following_url":"https://api.github.com/users/jonasporto/following{/other_user}","gists_url":"https://api.github.com/users/jonasporto/gists{/gist_id}","starred_url":"https://api.github.com/users/jonasporto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonasporto/subscriptions","organizations_url":"https://api.github.com/users/jonasporto/orgs","repos_url":"https://api.github.com/users/jonasporto/repos","events_url":"https://api.github.com/users/jonasporto/events{/privacy}","received_events_url":"https://api.github.com/users/jonasporto/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-19T21:05:00Z","updated_at":"2022-07-25T21:45:40Z","closed_at":"2022-07-25T21:45:40Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", tag: \"v6.1.5\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# Support for inversing belongs_to -> has_many Active Record associations.\r\n# default to true on rails 6.1\r\nActiveRecord::Base.has_many_inversing = true\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :accounts, force: true do |t|\r\n    t.string \"name\", limit: 255\r\n  end\r\n\r\n  create_table :account_settings, force: true do |t|\r\n    t.integer \"account_id\"\r\n    t.integer \"cost_account_id\"\r\n  end\r\nend\r\n\r\nclass Account < ActiveRecord::Base\r\n  has_many :cost_accounts, class_name: 'AccountSetting'\r\nend\r\n\r\nclass AccountSetting < ActiveRecord::Base\r\n  belongs_to :account\r\n  belongs_to :cost_account, class_name: 'Account', inverse_of: :cost_accounts\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_assigning\r\n    account = Account.new(name: 'Main Account')\r\n    cost_account = Account.new(name: 'Cost Account')\r\n\r\n    account_setting = AccountSetting.new(account: account, cost_account: cost_account)\r\n\r\n    assert_equal account_setting.account, account\r\n    assert_equal account_setting.cost_account, cost_account\r\n  end\r\n\r\n  def test_unset_main_account\r\n    cost_account = Account.new(name: 'Cost Account')\r\n\r\n    account_setting = AccountSetting.new(cost_account: cost_account)\r\n\r\n    assert_equal account_setting.cost_account, cost_account\r\n    assert_nil account_setting.account\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n- On `test_association_assigning` scenario, is expected `account` and `cost_account` to return the same objects provided on instantiating\r\n- For `test_unset_main_account`, is expected `account` to not be set (because only `cost_account` is provided)\r\n- I believe another expected behavior would be raising an error if the has_many association doesn't correspond to the belongs_to + inverse_of\r\n\r\nIt works as expected when:\r\n- Adding the `inverse_of :cost_account` on `has_many :cost_accounts, class_name: 'AccountSetting'`\r\n- Setting `ActiveRecord::Base.has_many_inversing` to `false`\r\n- Adding `foreign_key: :account_id` to `belongs_to :account`\r\n\r\n### Actual behavior\r\n- When assigning `AccountSetting#cost_account` it also sets `account` as the same value received for `cost_account`\r\n- When providing `account` and `cost_account`, `account` is ignored and `cost_account` is set as value for both attributes.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n**Ruby version**: 2.6.5\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44924/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44924/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44923","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44923/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44923/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44923/events","html_url":"https://github.com/rails/rails/issues/44923","id":1208825641,"node_id":"I_kwDNIULOSA03KQ","number":44923,"title":"Frozen string as a subdomain route default should work with skip_parameter_encoding","user":{"login":"jason-o-matic","id":13733,"node_id":"MDQ6VXNlcjEzNzMz","avatar_url":"https://avatars.githubusercontent.com/u/13733?v=4","gravatar_id":"","url":"https://api.github.com/users/jason-o-matic","html_url":"https://github.com/jason-o-matic","followers_url":"https://api.github.com/users/jason-o-matic/followers","following_url":"https://api.github.com/users/jason-o-matic/following{/other_user}","gists_url":"https://api.github.com/users/jason-o-matic/gists{/gist_id}","starred_url":"https://api.github.com/users/jason-o-matic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jason-o-matic/subscriptions","organizations_url":"https://api.github.com/users/jason-o-matic/orgs","repos_url":"https://api.github.com/users/jason-o-matic/repos","events_url":"https://api.github.com/users/jason-o-matic/events{/privacy}","received_events_url":"https://api.github.com/users/jason-o-matic/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-19T20:24:43Z","updated_at":"2022-05-14T12:48:22Z","closed_at":"2022-05-14T12:48:22Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  gem 'rails', '6.1.4.4'\r\n  # gem 'rails', '7.0.2.3' # also fails\r\nend\r\n\r\nrequire 'rack/test'\r\nrequire 'action_controller/railtie'\r\n\r\nclass TestApp < Rails::Application\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  # Emulate constants from environment files\r\n  MAIN_DOMAIN = if true # Rails.env.production?\r\n    \"example.org\"\r\n  else\r\n    \"staging.example.org\"\r\n  end\r\n\r\n  config.root = __dir__\r\n  config.hosts << \".#{MAIN_DOMAIN}\"\r\n  config.session_store :cookie_store, key: 'cookie_store_key'\r\n  secrets.secret_key_base = 'secret_key_base'\r\n\r\n  routes.draw do\r\n    defaults(subdomain: MAIN_DOMAIN.split(\".\").reverse[2].to_s) do\r\n      get '/' => 'test#index'\r\n    end\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  skip_parameter_encoding :index\r\n\r\n  def index\r\n    render plain: 'Home'\r\n  end\r\nend\r\n\r\nrequire 'minitest/autorun'\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_routes_defaults_frozen_subdomain_returns_success\r\n    get '/'\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n\r\n  def app\r\n    Rails.application\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nUsing `defaults(subdomain: \"foo\".freeze)` along with `skip_parameter_encoding` should work.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nThis produces a FrozenError, here's the most relevant bit:\r\n```\r\nFrozenError (can't modify frozen String: \"\"):\r\n\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:87:in `force_encoding'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:87:in `block (2 levels) in encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:17:in `each_param_value'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:85:in `block in encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:84:in `each'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:84:in `encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:45:in `set_binary_encoding'\r\nactionpack (6.1.4.4) lib/action_dispatch/http/parameters.rb:68:in `path_parameters='\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:48:in `block in serve'\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:32:in `each'\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:32:in `serve'\r\nactionpack (6.1.4.4) lib/action_dispatch/routing/route_set.rb:842:in `call'\r\n```\r\n\r\nThe issue seems to be using `skip_parameter_encoding` along with `defaults(subdomain: \"\".freeze)`. This results in an attempt to `force_encoding` on a frozen string, which errors. This took a while to debug because the error message wasn't super helpful.\r\n\r\nIn my particular case I have different domains in different environments, and I parse out the subdomain to pass to `defaults`. In production this effectively resulted in `defaults(subdomain: nil.to_s)`, which returns a frozen empty string.\r\n\r\nIf Rails is going to call `force_encoding` on the `subdomain` argument I would expect it to `dup` the string first.\r\n\r\nFull output:\r\n```\r\nFetching gem metadata from https://rubygems.org/...........\r\nFetching gem metadata from https://rubygems.org/.\r\nResolving dependencies...\r\nUsing rake 13.0.6\r\nUsing concurrent-ruby 1.1.10\r\nUsing i18n 1.10.0\r\nUsing minitest 5.15.0\r\nUsing tzinfo 2.0.4\r\nUsing zeitwerk 2.5.4\r\nUsing activesupport 6.1.4.4\r\nUsing builder 3.2.4\r\nUsing erubi 1.10.0\r\nUsing mini_portile2 2.8.0\r\nUsing racc 1.6.0\r\nUsing nokogiri 1.13.4 (arm64-darwin)\r\nUsing rails-dom-testing 2.0.3\r\nUsing crass 1.0.6\r\nUsing loofah 2.16.0\r\nUsing rails-html-sanitizer 1.4.2\r\nUsing actionview 6.1.4.4\r\nUsing rack 2.2.3\r\nUsing rack-test 1.1.0\r\nUsing actionpack 6.1.4.4\r\nUsing nio4r 2.5.8\r\nUsing websocket-extensions 0.1.5\r\nUsing websocket-driver 0.7.5\r\nUsing actioncable 6.1.4.4\r\nUsing globalid 1.0.0\r\nUsing activejob 6.1.4.4\r\nUsing activemodel 6.1.4.4\r\nUsing activerecord 6.1.4.4\r\nUsing marcel 1.0.2\r\nUsing mini_mime 1.1.2\r\nUsing activestorage 6.1.4.4\r\nUsing mail 2.7.1\r\nUsing actionmailbox 6.1.4.4\r\nUsing actionmailer 6.1.4.4\r\nUsing actiontext 6.1.4.4\r\nUsing bundler 1.17.2\r\nUsing method_source 1.0.0\r\nUsing thor 1.2.1\r\nUsing railties 6.1.4.4\r\nUsing sprockets 4.0.3\r\nUsing sprockets-rails 3.4.2\r\nUsing rails 6.1.4.4\r\n~/.rbenv/versions/2.7.5/lib/ruby/2.7.0/timeout.rb:50: warning: already initialized constant Timeout::THIS_FILE\r\n~/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/timeout-0.2.0/lib/timeout.rb:53: warning: previous definition of THIS_FILE was here\r\n~/.rbenv/versions/2.7.5/lib/ruby/2.7.0/timeout.rb:51: warning: already initialized constant Timeout::CALLER_OFFSET\r\n~/.rbenv/versions/2.7.5/lib/ruby/gems/2.7.0/gems/timeout-0.2.0/lib/timeout.rb:54: warning: previous definition of CALLER_OFFSET was here\r\n~/.rbenv/versions/2.7.5/lib/ruby/2.7.0/arm64-darwin21/strscan.bundle: warning: already initialized constant StringScanner::Version\r\n~/.rbenv/versions/2.7.5/lib/ruby/2.7.0/arm64-darwin21/strscan.bundle: warning: already initialized constant StringScanner::Id\r\nRun options: --seed 148\r\n\r\n# Running:\r\n\r\nI, [2022-04-19T16:07:08.206010 #53711]  INFO -- : Started GET \"/\" for 127.0.0.1 at 2022-04-19 16:07:08 -0400\r\nF, [2022-04-19T16:07:08.207280 #53711] FATAL -- :\r\nFrozenError (can't modify frozen String: \"\"):\r\n\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:87:in `force_encoding'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:87:in `block (2 levels) in encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:17:in `each_param_value'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:85:in `block in encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:84:in `each'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:84:in `encode'\r\nactionpack (6.1.4.4) lib/action_dispatch/request/utils.rb:45:in `set_binary_encoding'\r\nactionpack (6.1.4.4) lib/action_dispatch/http/parameters.rb:68:in `path_parameters='\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:48:in `block in serve'\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:32:in `each'\r\nactionpack (6.1.4.4) lib/action_dispatch/journey/router.rb:32:in `serve'\r\nactionpack (6.1.4.4) lib/action_dispatch/routing/route_set.rb:842:in `call'\r\nrack (2.2.3) lib/rack/tempfile_reaper.rb:15:in `call'\r\nrack (2.2.3) lib/rack/etag.rb:27:in `call'\r\nrack (2.2.3) lib/rack/conditional_get.rb:27:in `call'\r\nrack (2.2.3) lib/rack/head.rb:12:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/http/permissions_policy.rb:22:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/http/content_security_policy.rb:18:in `call'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:266:in `context'\r\nrack (2.2.3) lib/rack/session/abstract/id.rb:260:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/cookies.rb:689:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\nactivesupport (6.1.4.4) lib/active_support/callbacks.rb:98:in `run_callbacks'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/debug_exceptions.rb:29:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/show_exceptions.rb:33:in `call'\r\nrailties (6.1.4.4) lib/rails/rack/logger.rb:37:in `call_app'\r\nrailties (6.1.4.4) lib/rails/rack/logger.rb:28:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/remote_ip.rb:81:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\nrack (2.2.3) lib/rack/method_override.rb:24:in `call'\r\nrack (2.2.3) lib/rack/runtime.rb:22:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/static.rb:24:in `call'\r\nrack (2.2.3) lib/rack/sendfile.rb:110:in `call'\r\nactionpack (6.1.4.4) lib/action_dispatch/middleware/host_authorization.rb:119:in `call'\r\nrailties (6.1.4.4) lib/rails/engine.rb:539:in `call'\r\nrack-test (1.1.0) lib/rack/mock_session.rb:29:in `request'\r\nrack-test (1.1.0) lib/rack/test.rb:266:in `process_request'\r\nrack-test (1.1.0) lib/rack/test.rb:129:in `custom_request'\r\nrack-test (1.1.0) lib/rack/test.rb:58:in `get'\r\n~/.rbenv/versions/2.7.5/lib/ruby/2.7.0/forwardable.rb:235:in `get'\r\nsubdomain_frozen_issue.rb:53:in `test_routes_defaults_frozen_subdomain_returns_success'\r\nminitest (5.15.0) lib/minitest/test.rb:98:in `block (3 levels) in run'\r\nminitest (5.15.0) lib/minitest/test.rb:195:in `capture_exceptions'\r\nminitest (5.15.0) lib/minitest/test.rb:95:in `block (2 levels) in run'\r\nminitest (5.15.0) lib/minitest.rb:281:in `time_it'\r\nminitest (5.15.0) lib/minitest/test.rb:94:in `block in run'\r\nminitest (5.15.0) lib/minitest.rb:376:in `on_signal'\r\nminitest (5.15.0) lib/minitest/test.rb:221:in `with_info_handler'\r\nminitest (5.15.0) lib/minitest/test.rb:93:in `run'\r\nminitest (5.15.0) lib/minitest.rb:1042:in `run_one_method'\r\nminitest (5.15.0) lib/minitest.rb:350:in `run_one_method'\r\nminitest (5.15.0) lib/minitest.rb:337:in `block (2 levels) in run'\r\nminitest (5.15.0) lib/minitest.rb:336:in `each'\r\nminitest (5.15.0) lib/minitest.rb:336:in `block in run'\r\nminitest (5.15.0) lib/minitest.rb:376:in `on_signal'\r\nminitest (5.15.0) lib/minitest.rb:363:in `with_info_handler'\r\nminitest (5.15.0) lib/minitest.rb:335:in `run'\r\nminitest (5.15.0) lib/minitest.rb:169:in `block in __run'\r\nminitest (5.15.0) lib/minitest.rb:169:in `map'\r\nminitest (5.15.0) lib/minitest.rb:169:in `__run'\r\nminitest (5.15.0) lib/minitest.rb:146:in `run'\r\nminitest (5.15.0) lib/minitest.rb:73:in `block in autorun'\r\nF\r\n\r\nFailure:\r\nBugTest#test_routes_defaults_frozen_subdomain_returns_success [subdomain_frozen_issue.rb:54]:\r\nExpected false to be truthy.\r\n\r\n\r\nrails test subdomain_frozen_issue.rb:52\r\n\r\n\r\n\r\nFinished in 0.025211s, 39.6652 runs/s, 39.6652 assertions/s.\r\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.4\r\n\r\nAlso fails on 7.0.2.3.\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44923/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44923/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44922","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44922/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44922/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44922/events","html_url":"https://github.com/rails/rails/issues/44922","id":1208650688,"node_id":"I_kwDNIULOSAqLwA","number":44922,"title":"Multiple joins on the same table are broken in 6.1 and above","user":{"login":"mikdiet","id":426230,"node_id":"MDQ6VXNlcjQyNjIzMA==","avatar_url":"https://avatars.githubusercontent.com/u/426230?v=4","gravatar_id":"","url":"https://api.github.com/users/mikdiet","html_url":"https://github.com/mikdiet","followers_url":"https://api.github.com/users/mikdiet/followers","following_url":"https://api.github.com/users/mikdiet/following{/other_user}","gists_url":"https://api.github.com/users/mikdiet/gists{/gist_id}","starred_url":"https://api.github.com/users/mikdiet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikdiet/subscriptions","organizations_url":"https://api.github.com/users/mikdiet/orgs","repos_url":"https://api.github.com/users/mikdiet/repos","events_url":"https://api.github.com/users/mikdiet/events{/privacy}","received_events_url":"https://api.github.com/users/mikdiet/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-19T17:28:32Z","updated_at":"2022-07-24T13:20:13Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I'm upgrading my Rails 6.0 application, and got an error (that is reproducible in 7.0 as well).\r\n\r\nI'm not sure what exactly causes this issue, because as you could see below I have a very edge case, containing:\r\n- polymorphic association;\r\n- has_one associations;\r\n- STI;\r\n- left joins.\r\n\r\nSo, the test first\r\n\r\n### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 6.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :locations, force: true do |t|\r\n    t.string :type\r\n  end\r\n\r\n  create_table :libraries, force: true do |t|\r\n    t.integer :storing_location_id\r\n  end\r\n\r\n  create_table :settings, force: true do |t|\r\n    t.string :value\r\n  end\r\n\r\n  create_table :setting_associations, force: true do |t|\r\n    t.integer :setting_id\r\n    t.integer :target_id\r\n    t.string :target_type\r\n  end\r\n\r\n  create_table :books, force: true do |t|\r\n    t.integer :library_id\r\n    t.integer :current_location_id\r\n  end\r\nend\r\n\r\nclass Book < ActiveRecord::Base\r\n  belongs_to :library\r\n  belongs_to :current_location\r\nend\r\n\r\nclass Setting < ActiveRecord::Base\r\nend\r\n\r\nclass SettingAssociation < ActiveRecord::Base\r\n  belongs_to :target, polymorphic: true\r\n  belongs_to :setting\r\nend\r\n\r\nclass Library < ActiveRecord::Base\r\n  has_many :books\r\n  belongs_to :storing_location\r\nend\r\n\r\nclass Location < ActiveRecord::Base\r\n  has_one :setting_association, as: :target\r\n  has_one :setting, through: :setting_association\r\nend\r\n\r\nclass CurrentLocation < Location\r\n  has_many :books\r\nend\r\n\r\nclass StoringLocation < Location\r\n  has_many :libraries\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    join_query = Book.left_joins(current_location: :setting, library: { storing_location: :setting })\r\n    puts join_query.to_sql\r\n\r\n    current_location = CurrentLocation.create\r\n    storing_location = StoringLocation.create\r\n    library = Library.create storing_location: storing_location\r\n    book = Book.create current_location: current_location, library: library\r\n    setting1 = Setting.create value: '1'\r\n    setting2 = Setting.create value: '2'\r\n    current_location.create_setting_association setting: setting1\r\n    storing_location.create_setting_association setting: setting2\r\n\r\n    assert_equal ['1', '2'], join_query.pluck('settings.value', 'settings_locations.value').first\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nIn Rails 6.0 it passes, and SQL generated is \r\n\r\n```sql\r\nSELECT \"books\".* FROM \"books\" \r\nLEFT OUTER JOIN \"locations\" ON \"locations\".\"id\" = \"books\".\"current_location_id\" AND \"locations\".\"type\" = 'CurrentLocation' \r\nLEFT OUTER JOIN \"setting_associations\" ON \"setting_associations\".\"location_id\" = \"locations\".\"id\" \r\nLEFT OUTER JOIN \"settings\" ON \"settings\".\"id\" = \"setting_associations\".\"setting_id\" \r\nLEFT OUTER JOIN \"libraries\" ON \"libraries\".\"id\" = \"books\".\"library_id\" \r\nLEFT OUTER JOIN \"locations\" \"storing_locations_libraries\" ON \"storing_locations_libraries\".\"id\" = \"libraries\".\"storing_location_id\" AND \"storing_locations_libraries\".\"type\" = 'StoringLocation' \r\nLEFT OUTER JOIN \"setting_associations\" \"setting_associations_locations_join\" ON \"setting_associations_locations_join\".\"location_id\" = \"storing_locations_libraries\".\"id\" \r\nLEFT OUTER JOIN \"settings\" \"settings_locations\" ON \"settings_locations\".\"id\" = \"setting_associations_locations_join\".\"setting_id\"\r\n```\r\n\r\n### Actual behavior\r\nIn Rails 6.1 and 7.0 the test fails with a message\r\n\r\n```\r\nExpected: [\"1\", \"2\"]\r\nActual: [\"1\", \"1\"]\r\n```\r\n\r\nand SQL generated is \r\n\r\n```sql\r\nSELECT \"books\".* FROM \"books\" \r\nLEFT OUTER JOIN \"locations\" ON \"locations\".\"id\" = \"books\".\"current_location_id\" AND \"locations\".\"type\" = 'CurrentLocation' \r\nLEFT OUTER JOIN \"setting_associations\" ON \"setting_associations\".\"location_id\" = \"locations\".\"id\" \r\nLEFT OUTER JOIN \"settings\" ON \"settings\".\"id\" = \"setting_associations\".\"setting_id\" \r\nLEFT OUTER JOIN \"libraries\" ON \"libraries\".\"id\" = \"books\".\"library_id\" \r\nLEFT OUTER JOIN \"locations\" \"storing_locations_libraries\" ON \"storing_locations_libraries\".\"id\" = \"libraries\".\"storing_location_id\" AND \"storing_locations_libraries\".\"type\" = 'StoringLocation' \r\nLEFT OUTER JOIN \"settings\" \"settings_locations\" ON \"settings_locations\".\"id\" = \"setting_associations\".\"setting_id\"\r\n```\r\n\r\nNotice this missing part:\r\n\r\n```sql\r\nLEFT OUTER JOIN \"setting_associations\" \"setting_associations_locations_join\" ON \"setting_associations_locations_join\".\"location_id\" = \"storing_locations_libraries\".\"id\"\r\n```\r\n\r\nso then it joins with wrong table  `ON \"settings_locations\".\"id\" = \"setting_associations\".\"setting_id\"` instead of `ON \"settings_locations\".\"id\" = \"setting_associations_locations_join\".\"setting_id\"` originally.\r\n\r\n### System configuration\r\n**Rails version**:\r\n- current 6.0.4.7\r\n- tested on 6.1.5 and 7.0.2.3\r\n\r\n**Ruby version**: 2.7.6p219 (2022-04-12 revision c9c2245c0a) [x86_64-darwin21]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44922/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44922/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44921","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44921/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44921/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44921/events","html_url":"https://github.com/rails/rails/issues/44921","id":1208172241,"node_id":"I_kwDNIULOSAM-0Q","number":44921,"title":"Hosts permitting: only one level of domains supported","user":{"login":"cmrd-senya","id":10187586,"node_id":"MDQ6VXNlcjEwMTg3NTg2","avatar_url":"https://avatars.githubusercontent.com/u/10187586?v=4","gravatar_id":"","url":"https://api.github.com/users/cmrd-senya","html_url":"https://github.com/cmrd-senya","followers_url":"https://api.github.com/users/cmrd-senya/followers","following_url":"https://api.github.com/users/cmrd-senya/following{/other_user}","gists_url":"https://api.github.com/users/cmrd-senya/gists{/gist_id}","starred_url":"https://api.github.com/users/cmrd-senya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cmrd-senya/subscriptions","organizations_url":"https://api.github.com/users/cmrd-senya/orgs","repos_url":"https://api.github.com/users/cmrd-senya/repos","events_url":"https://api.github.com/users/cmrd-senya/events{/privacy}","received_events_url":"https://api.github.com/users/cmrd-senya/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-19T10:49:56Z","updated_at":"2022-04-19T21:15:21Z","closed_at":"2022-04-19T21:15:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Use the special \"starting dot\" syntax\r\n2. Try opening subdomain of the second level, e.g \"level2.level1.product.com\r\n\r\nThis is from the Rails docs: \r\n```ruby\r\n# Allow requests from subdomains like `www.product.com` and\r\n# `beta1.product.com`.\r\nRails.application.config.hosts << \".product.com\"\r\n```\r\n\r\nRespective code entry point: https://github.com/rails/rails/blob/8ace32c4ccdc760d17548de777b08c13bc9e07bd/actionpack/lib/action_dispatch/middleware/host_authorization.rb#L72-L73\r\n\r\n### Expected behavior\r\nThe request is served, the validation is passing\r\n\r\n### Actual behavior\r\nHost getting blocked. Only \"level 1\" hosts is supported with the \"dot syntax\". This is controversial with the statement from the documentation that this is \"A special case is supported that allows you to permit all sub-domains\" \r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.6\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44921/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44921/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44919","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44919/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44919/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44919/events","html_url":"https://github.com/rails/rails/issues/44919","id":1207942006,"node_id":"I_kwDNIULOR_-7dg","number":44919,"title":"Documentation of relative root deployment setup","user":{"login":"dssjoblom","id":12595797,"node_id":"MDQ6VXNlcjEyNTk1Nzk3","avatar_url":"https://avatars.githubusercontent.com/u/12595797?v=4","gravatar_id":"","url":"https://api.github.com/users/dssjoblom","html_url":"https://github.com/dssjoblom","followers_url":"https://api.github.com/users/dssjoblom/followers","following_url":"https://api.github.com/users/dssjoblom/following{/other_user}","gists_url":"https://api.github.com/users/dssjoblom/gists{/gist_id}","starred_url":"https://api.github.com/users/dssjoblom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dssjoblom/subscriptions","organizations_url":"https://api.github.com/users/dssjoblom/orgs","repos_url":"https://api.github.com/users/dssjoblom/repos","events_url":"https://api.github.com/users/dssjoblom/events{/privacy}","received_events_url":"https://api.github.com/users/dssjoblom/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-19T08:08:10Z","updated_at":"2022-08-12T07:10:45Z","closed_at":"2022-08-12T07:10:45Z","author_association":"NONE","active_lock_reason":null,"body":"### Description\r\n\r\nIt seems like the documentation (https://guides.rubyonrails.org/configuring.html#deploy-to-a-subdirectory-relative-url-root) for setting up relative root deployments is lacking. In some (most?) cases, it is not enough to specify the `RAILS_RELATIVE_URL_ROOT` variable, but you have to make changes to `config.ru` and occasionally modify `SCRIPT_NAME` as well.\r\n\r\n### Expected behavior\r\n\r\nSetting the RAILS_RELATIVE_URL_ROOT environment variable should automatically use the specified subdirectory in all cases, without requiring further setup.\r\n\r\n### Actual behavior\r\n\r\n1. Engine paths are created incorrectly. `MyEngine::Engine.routes.url_helpers.xyz_path` does not include the root prefix. This can be fixed by doing `Rails.application.routes.default_url_options[:script_name] = ENV['RAILS_RELATIVE_URL_ROOT']` before the routes are generated, but this is not documented anywhere, nor is it clear why it works.\r\n\r\n2. In most use cases, you need to modify config.ru so that the application routes end up using the prefix as well:\r\n\r\n```\r\nmap ENV['RAILS_RELATIVE_URL_ROOT'] || '/' do\r\n  run Rails.application\r\n  Rails.application.load_server\r\nend\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: 6.1.4.7\r\n\r\n**Ruby version**: 2.7.6p219\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44919/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44919/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44918","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44918/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44918/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44918/events","html_url":"https://github.com/rails/rails/issues/44918","id":1207913946,"node_id":"I_kwDNIULOR_9N2g","number":44918,"title":"Error in ActiveRecord save(validate: false)","user":{"login":"pavankuppa","id":936542,"node_id":"MDQ6VXNlcjkzNjU0Mg==","avatar_url":"https://avatars.githubusercontent.com/u/936542?v=4","gravatar_id":"","url":"https://api.github.com/users/pavankuppa","html_url":"https://github.com/pavankuppa","followers_url":"https://api.github.com/users/pavankuppa/followers","following_url":"https://api.github.com/users/pavankuppa/following{/other_user}","gists_url":"https://api.github.com/users/pavankuppa/gists{/gist_id}","starred_url":"https://api.github.com/users/pavankuppa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pavankuppa/subscriptions","organizations_url":"https://api.github.com/users/pavankuppa/orgs","repos_url":"https://api.github.com/users/pavankuppa/repos","events_url":"https://api.github.com/users/pavankuppa/events{/privacy}","received_events_url":"https://api.github.com/users/pavankuppa/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-04-19T07:52:22Z","updated_at":"2022-04-20T10:55:29Z","closed_at":"2022-04-20T10:55:25Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.2.3\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :persons, force: true do |t|\r\n    t.string :name\r\n    t.integer :age\r\n  end\r\nend\r\n\r\nclass Person < ApplicationRecord\r\n  validates_uniqueness_of :name\r\nend\r\nperson = Person.new\r\nperson.name = \"Ruby\"\r\nperson.age = 30\r\nperson.save(validate: false)\r\n\r\n```\r\n\r\n### Expected behavior\r\nSkip validation and record should save\r\n\r\n### Actual behavior\r\nruby-3.1.1/gems/activerecord-7.0.2.3/lib/active_record/suppressor.rb:49:in `save': wrong number of arguments (given 1, expected 0) (ArgumentError)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44918/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44918/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44917","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44917/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44917/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44917/events","html_url":"https://github.com/rails/rails/issues/44917","id":1207734530,"node_id":"I_kwDNIULOR_yRAg","number":44917,"title":"ArgumentError:  wrong number of arguments (given 2, expected 1)","user":{"login":"IamDevil","id":5432310,"node_id":"MDQ6VXNlcjU0MzIzMTA=","avatar_url":"https://avatars.githubusercontent.com/u/5432310?v=4","gravatar_id":"","url":"https://api.github.com/users/IamDevil","html_url":"https://github.com/IamDevil","followers_url":"https://api.github.com/users/IamDevil/followers","following_url":"https://api.github.com/users/IamDevil/following{/other_user}","gists_url":"https://api.github.com/users/IamDevil/gists{/gist_id}","starred_url":"https://api.github.com/users/IamDevil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/IamDevil/subscriptions","organizations_url":"https://api.github.com/users/IamDevil/orgs","repos_url":"https://api.github.com/users/IamDevil/repos","events_url":"https://api.github.com/users/IamDevil/events{/privacy}","received_events_url":"https://api.github.com/users/IamDevil/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-19T04:32:53Z","updated_at":"2022-05-04T23:24:38Z","closed_at":"2022-05-04T23:24:37Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```\r\nclass Time\r\n  def next_wday(wday_number, beginning_of_day = true)\r\n    day_span = 1 + ((wday_number - wday - 1) % 7)\r\n    next_weekday = self + day_span.day\r\n    return next_weekday unless beginning_of_day\r\n    next_weekday.beginning_of_day\r\n  end\r\nend\r\n\r\nTime.now.asctime.in_time_zone('UTC').at_next_wday(0, beginning_of_day: true)\r\n```\r\n\r\n### Expected behavior\r\n```\r\nSun, 24 Apr 2022 00:00:00.000000000 UTC +00:00\r\n```\r\n\r\n### Actual behavior\r\n```\r\nwrong number of arguments (given 2, expected 1)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails version: 7.0.2\r\n\r\n**Ruby version**:\r\nRuby version: ruby 3.1.2-p20","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44917/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44917/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44912","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44912/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44912/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44912/events","html_url":"https://github.com/rails/rails/issues/44912","id":1206663175,"node_id":"I_kwDNIULOR-w4Bw","number":44912,"title":"Wrong error is show when an enum validation is misspell","user":{"login":"TanZng","id":25267490,"node_id":"MDQ6VXNlcjI1MjY3NDkw","avatar_url":"https://avatars.githubusercontent.com/u/25267490?v=4","gravatar_id":"","url":"https://api.github.com/users/TanZng","html_url":"https://github.com/TanZng","followers_url":"https://api.github.com/users/TanZng/followers","following_url":"https://api.github.com/users/TanZng/following{/other_user}","gists_url":"https://api.github.com/users/TanZng/gists{/gist_id}","starred_url":"https://api.github.com/users/TanZng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TanZng/subscriptions","organizations_url":"https://api.github.com/users/TanZng/orgs","repos_url":"https://api.github.com/users/TanZng/repos","events_url":"https://api.github.com/users/TanZng/events{/privacy}","received_events_url":"https://api.github.com/users/TanZng/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-18T04:58:46Z","updated_at":"2022-07-24T18:41:50Z","closed_at":"2022-07-24T18:41:50Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create a class with a enum and add a validation for the enum. Misspell the name of the enum in this example I wrote `in: parentesco_proveedores.keys` instead of the correct value `{ in: parentesco_proveedors.keys }`.\r\n\r\n```ruby\r\nclass Seguro < ApplicationRecord\r\n  enum parentesco_proveedor: { madre: \"Madre\", padre: \"Padre\"}, _prefix: true\r\n\r\n  validates :parentesco_proveedor, inclusion: { in: parentesco_proveedores.keys }\r\nend\r\n```\r\n\r\n2. Go to http://127.0.0.1:3000/ you will see the correct error, then refreh the page.\r\n3. The error chage.\r\n\r\n### Expected behavior\r\n\r\nThe error should be the same even after refesh\r\n```\r\nundefined local variable or method `parentesco_proveedores' for Seguro:Class\r\nDid you mean?\r\nparentesco_proveedors\r\n...\r\n```\r\n\r\n### Actual behavior\r\n\r\nAt first the error is (what actually is happening)\r\n```\r\nundefined local variable or method `parentesco_proveedores' for Seguro:Class\r\nDid you mean?\r\nparentesco_proveedors\r\n...\r\n```\r\n\r\nBut when the site is refresh the error changes to:\r\n\r\n```\r\nYou tried to define an enum named \"parentesco_proveedor\" on the model \"Seguro\", but this will generate a instance method \"parentesco_proveedor_madre?\", which is already defined by another enum.\r\n\r\n```\r\nIf you keepo refreshing this error will continue showing and the one about the `undefined local ` will not show again\r\n\r\n### System configuration\r\n**Rails version**:\r\ngem \"rails\", \"~> 7.0.2\", \">= 7.0.2.3\"\r\n\r\n**Ruby version**:\r\nruby \"3.1.1\"","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44912/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44912/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44906","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44906/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44906/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44906/events","html_url":"https://github.com/rails/rails/issues/44906","id":1205954018,"node_id":"I_kwDNIULOR-Fl4g","number":44906,"title":"`ActiveRecord::StrictLoadingViolationError` is not raised when loading polymorphic relations.","user":{"login":"madogiwa0124","id":17684091,"node_id":"MDQ6VXNlcjE3Njg0MDkx","avatar_url":"https://avatars.githubusercontent.com/u/17684091?v=4","gravatar_id":"","url":"https://api.github.com/users/madogiwa0124","html_url":"https://github.com/madogiwa0124","followers_url":"https://api.github.com/users/madogiwa0124/followers","following_url":"https://api.github.com/users/madogiwa0124/following{/other_user}","gists_url":"https://api.github.com/users/madogiwa0124/gists{/gist_id}","starred_url":"https://api.github.com/users/madogiwa0124/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/madogiwa0124/subscriptions","organizations_url":"https://api.github.com/users/madogiwa0124/orgs","repos_url":"https://api.github.com/users/madogiwa0124/repos","events_url":"https://api.github.com/users/madogiwa0124/events{/privacy}","received_events_url":"https://api.github.com/users/madogiwa0124/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","site_admin":false},"assignees":[{"login":"adrianna-chang-shopify","id":22918438,"node_id":"MDQ6VXNlcjIyOTE4NDM4","avatar_url":"https://avatars.githubusercontent.com/u/22918438?v=4","gravatar_id":"","url":"https://api.github.com/users/adrianna-chang-shopify","html_url":"https://github.com/adrianna-chang-shopify","followers_url":"https://api.github.com/users/adrianna-chang-shopify/followers","following_url":"https://api.github.com/users/adrianna-chang-shopify/following{/other_user}","gists_url":"https://api.github.com/users/adrianna-chang-shopify/gists{/gist_id}","starred_url":"https://api.github.com/users/adrianna-chang-shopify/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adrianna-chang-shopify/subscriptions","organizations_url":"https://api.github.com/users/adrianna-chang-shopify/orgs","repos_url":"https://api.github.com/users/adrianna-chang-shopify/repos","events_url":"https://api.github.com/users/adrianna-chang-shopify/events{/privacy}","received_events_url":"https://api.github.com/users/adrianna-chang-shopify/received_events","type":"User","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/rails/rails/milestones/81","html_url":"https://github.com/rails/rails/milestone/81","labels_url":"https://api.github.com/repos/rails/rails/milestones/81/labels","id":7591006,"node_id":"MI_kwDNIULOAHPUXg","number":81,"title":"7.0.4","description":"","creator":{"login":"rafaelfranca","id":47848,"node_id":"MDQ6VXNlcjQ3ODQ4","avatar_url":"https://avatars.githubusercontent.com/u/47848?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelfranca","html_url":"https://github.com/rafaelfranca","followers_url":"https://api.github.com/users/rafaelfranca/followers","following_url":"https://api.github.com/users/rafaelfranca/following{/other_user}","gists_url":"https://api.github.com/users/rafaelfranca/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelfranca/subscriptions","organizations_url":"https://api.github.com/users/rafaelfranca/orgs","repos_url":"https://api.github.com/users/rafaelfranca/repos","events_url":"https://api.github.com/users/rafaelfranca/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelfranca/received_events","type":"User","site_admin":false},"open_issues":2,"closed_issues":3,"state":"open","created_at":"2022-01-20T01:51:07Z","updated_at":"2022-08-30T13:21:37Z","due_on":null,"closed_at":null},"comments":0,"created_at":"2022-04-15T23:47:51Z","updated_at":"2022-05-05T15:32:16Z","closed_at":"2022-05-05T15:32:16Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nAfter performing `strict_loading!` on a model with polymorphic relationships, loading the related model raises an `ArgumentError`. However, it seems to me that `ActiveRecord::StrictLoadingViolationError` should be raised.\r\n\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", ENV.fetch('RAILS_VERSION',  \"~> 7.0.0\")\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.belongs_to :target, polymorphic: true\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments, as: :target\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :target, polymorphic: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_strict_loading_to_polymofic_model\r\n    post = Post.create!\r\n    Comment.create!(target: post)\r\n    comment = Comment.last\r\n    comment.strict_loading!\r\n    error = assert_raises(ArgumentError) { comment.target }\r\n    assert_equal error.message, 'Polymorphic associations do not support computing the class.'\r\n  end\r\nend\r\n```\r\n\r\nBelow is the repository from which the above reproduced code was pushed.\r\n\r\nhttps://github.com/madogiwa0124/strict_loading_polymorphic_model_error_demo\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nRaise `ActiveRecord::StrictLoadingViolationError`.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nRaise `ArgumentError`\r\n\r\n```ruby\r\nArgumentError: Polymorphic associations do not support computing the class.\r\n  activerecord-7.0.2.3/lib/active_record/reflection.rb:417:in `compute_class'\r\n  activerecord-7.0.2.3/lib/active_record/reflection.rb:376:in `klass'\r\n  activerecord-7.0.2.3/lib/active_record/core.rb:241:in `strict_loading_violation!'\r\n  activerecord-7.0.2.3/lib/active_record/associations/association.rb:220:in `find_target'\r\n  activerecord-7.0.2.3/lib/active_record/associations/singular_association.rb:44:in `find_target'\r\n  activerecord-7.0.2.3/lib/active_record/associations/association.rb:173:in `load_target'\r\n  activerecord-7.0.2.3/lib/active_record/associations/association.rb:67:in `reload'\r\n  activerecord-7.0.2.3/lib/active_record/associations/singular_association.rb:11:in `reader'\r\n  activerecord-7.0.2.3/lib/active_record/associations/builder/association.rb:104:in `target'\r\n  active_record_gem.rb:46:in `test_strict_loading_to_Polymorphic_model'\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: 6.1.5, 7.0.2.3\r\n\r\n**Ruby version**: 2.7, 3.0, 3.1\r\n\r\nHere are the reproduced verification results of the above combination in my repository\r\n\r\nhttps://github.com/madogiwa0124/strict_loading_polymorphic_model_error_demo/actions/runs/2142890874\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44906/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44906/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44905","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44905/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44905/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44905/events","html_url":"https://github.com/rails/rails/issues/44905","id":1205677722,"node_id":"I_kwDNIULOR90umg","number":44905,"title":"ActiveRecord::Base abstract class with method none invalid for comparison","user":{"login":"Viktor-Ivliev","id":6106270,"node_id":"MDQ6VXNlcjYxMDYyNzA=","avatar_url":"https://avatars.githubusercontent.com/u/6106270?v=4","gravatar_id":"","url":"https://api.github.com/users/Viktor-Ivliev","html_url":"https://github.com/Viktor-Ivliev","followers_url":"https://api.github.com/users/Viktor-Ivliev/followers","following_url":"https://api.github.com/users/Viktor-Ivliev/following{/other_user}","gists_url":"https://api.github.com/users/Viktor-Ivliev/gists{/gist_id}","starred_url":"https://api.github.com/users/Viktor-Ivliev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Viktor-Ivliev/subscriptions","organizations_url":"https://api.github.com/users/Viktor-Ivliev/orgs","repos_url":"https://api.github.com/users/Viktor-Ivliev/repos","events_url":"https://api.github.com/users/Viktor-Ivliev/events{/privacy}","received_events_url":"https://api.github.com/users/Viktor-Ivliev/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-04-15T15:49:55Z","updated_at":"2022-07-23T22:03:26Z","closed_at":"2022-07-23T22:03:26Z","author_association":"NONE","active_lock_reason":null,"body":"Rails: 7.0.2.3\r\nruby: 3.1.2\r\ngem: pg (1.3.5) and pg (1.3.4)\r\n\r\n```\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  self.abstract_class = true\r\nend\r\n\r\nclass User < ApplicationRecord\r\nend\r\n\r\n```\r\n\r\nexamples:\r\n\r\n```\r\nApplicationRecord.none => []\r\nApplicationRecord.none.to_sql\r\nTypeError: no implicit conversion of nil into String \r\nfrom /home/karl/.rbenv/versions/3.1.2/gemsets/mobile_coach/gems/activerecord-7.0.2.3/lib/active_record/connection_adapters/postgresql/utils.rb:26:in `quote_ident'\r\n```\r\n\r\n```\r\nUser.none == User.none => true\r\n```\r\n\r\n```\r\nApplicationRecord.none == User.none \r\nTypeError: no implicit conversion of nil into String \r\nfrom /home/karl/.rbenv/versions/3.1.2/gemsets/mobile_coach/gems/activerecord-7.0.2.3/lib/active_record/connection_adapters/postgresql/utils.rb:26:in `quote_ident'\r\n```\r\n\r\nquote_ident - can't work with [nil, nil].\r\n\r\n-----\r\n\r\nIn rails 6.1.5 it works correctly:\r\npg (1.3.4)\r\n\r\n```\r\nApplicationRecord.none.to_sql => \"\"\r\nApplicationRecord.none == User.none => true\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44905/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44905/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44901","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44901/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44901/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44901/events","html_url":"https://github.com/rails/rails/issues/44901","id":1204964944,"node_id":"I_kwDNIULOR9JOUA","number":44901,"title":"Rolback remove_column with defined type in migration change method causes ArgumentError: wrong number of arguments (given 2, expected 3)","user":{"login":"deepj","id":33736,"node_id":"MDQ6VXNlcjMzNzM2","avatar_url":"https://avatars.githubusercontent.com/u/33736?v=4","gravatar_id":"","url":"https://api.github.com/users/deepj","html_url":"https://github.com/deepj","followers_url":"https://api.github.com/users/deepj/followers","following_url":"https://api.github.com/users/deepj/following{/other_user}","gists_url":"https://api.github.com/users/deepj/gists{/gist_id}","starred_url":"https://api.github.com/users/deepj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/deepj/subscriptions","organizations_url":"https://api.github.com/users/deepj/orgs","repos_url":"https://api.github.com/users/deepj/repos","events_url":"https://api.github.com/users/deepj/events{/privacy}","received_events_url":"https://api.github.com/users/deepj/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-14T20:49:07Z","updated_at":"2022-04-14T21:14:32Z","closed_at":"2022-04-14T21:14:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :payments, force: true do |t|\r\n    t.bigint :region_id\r\n  end\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass RollbackBug < ActiveRecord::Migration[7.0]\r\n  def change\r\n    remove_column :payments, :region_id, type: :bigint\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_down\r\n    RollbackBug.migrate(:down)\r\n    Payment.reset_column_information\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI can use rollback in this type of migration. According Rails docs this would be a legit call of `remove_column` method https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-remove_column\r\n\r\n### Actual behavior\r\n\r\n```\r\n==  RollbackBug: reverting ====================================================\r\n-- add_column(:payments, :region_id, {:type=>:bigint})\r\nE\r\n\r\nFinished in 0.001362s, 734.2144 runs/s, 0.0000 assertions/s.\r\n\r\n  1) Error:\r\nBugTest#test_migration_down:\r\nArgumentError: wrong number of arguments (given 2, expected 3)\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/connection_adapters/sqlite3_adapter.rb:244:in `add_column'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:931:in `block in method_missing'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:899:in `block in say_with_time'\r\n    ~/.rubies/ruby-3.1.2/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:899:in `say_with_time'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:920:in `method_missing'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration/command_recorder.rb:126:in `block in replay'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration/command_recorder.rb:125:in `each'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration/command_recorder.rb:125:in `replay'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:743:in `revert'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:867:in `exec_migration'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:853:in `block (2 levels) in migrate'\r\n    ~/.rubies/ruby-3.1.2/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:852:in `block in migrate'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/connection_adapters/abstract/connection_pool.rb:215:in `with_connection'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:851:in `migrate'\r\n    ~/.gem/ruby/3.1.2/gems/activerecord-7.0.2.3/lib/active_record/migration.rb:665:in `migrate'\r\n    ar_bug.rb:40:in `test_migration_down'\r\n\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n~\r\n\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: Ruby 3.1.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44901/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44901/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44899","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44899/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44899/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44899/events","html_url":"https://github.com/rails/rails/issues/44899","id":1204890347,"node_id":"I_kwDNIULOR9Eq6w","number":44899,"title":"Duplicate check constraints being generated in schema:dump with multiple db schemas","user":{"login":"frank-west-iii","id":329205,"node_id":"MDQ6VXNlcjMyOTIwNQ==","avatar_url":"https://avatars.githubusercontent.com/u/329205?v=4","gravatar_id":"","url":"https://api.github.com/users/frank-west-iii","html_url":"https://github.com/frank-west-iii","followers_url":"https://api.github.com/users/frank-west-iii/followers","following_url":"https://api.github.com/users/frank-west-iii/following{/other_user}","gists_url":"https://api.github.com/users/frank-west-iii/gists{/gist_id}","starred_url":"https://api.github.com/users/frank-west-iii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frank-west-iii/subscriptions","organizations_url":"https://api.github.com/users/frank-west-iii/orgs","repos_url":"https://api.github.com/users/frank-west-iii/repos","events_url":"https://api.github.com/users/frank-west-iii/events{/privacy}","received_events_url":"https://api.github.com/users/frank-west-iii/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-14T19:15:11Z","updated_at":"2022-04-14T23:33:14Z","closed_at":"2022-04-14T23:33:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\nI've create a repo with more information and reproduction steps here: https://github.com/frank-west-iii/check_demo\r\n\r\nAdditional tracing info:\r\n\r\nhttps://github.com/rails/rails/blob/a9bbc926429ea0ac56bfc608dee105d94704de2e/activerecord/lib/active_record/connection_adapters/postgresql/schema_statements.rb#L535\r\n```\r\ncheck_info\r\n[\r\n  {\"conname\"=>\"users_email_null\", \"constraintdef\"=>\"CHECK (email IS NOT NULL) NOT VALID\", \"valid\"=>false},\r\n  {\"conname\"=>\"users_email_null\", \"constraintdef\"=>\"CHECK (email IS NOT NULL) NOT VALID\", \"valid\"=>false}\r\n]\r\n```\r\n\r\nUpdating to use DISTINCT \"fixes\" the issue, but that is very likely not the right fix for this issue and is now approaching my edge of knowledge.\r\n```\r\n          check_info = exec_query(<<-SQL, \"SCHEMA\")\r\n            SELECT DISTINCT conname, pg_get_constraintdef(c.oid, true) AS constraintdef, c.convalidated AS valid\r\n            FROM pg_constraint c\r\n            JOIN pg_class t ON c.conrelid = t.oid\r\n            WHERE c.contype = 'c'\r\n              AND t.relname = #{scope[:name]}\r\n          SQL\r\n```\r\n\r\n### Expected behavior\r\nDumping the db schema should not duplicate check constraints when multiple schemas are present in the database\r\n\r\n```\r\nApplicationRecord.connection.check_constraints(\"users\")\r\n=> [#<struct ActiveRecord::ConnectionAdapters::CheckConstraintDefinition table_name=\"users\", expression=\"email IS NOT NULL\", options={:name=>\"users_email_null\", :validate=>false}>]\r\n```\r\n\r\n### Actual behavior\r\nDumping the db schema creates a duplicate check constraints entry when multiple schemas are present in the database\r\n\r\n```\r\nApplicationRecord.connection.check_constraints(\"users\")\r\n=> [#<struct ActiveRecord::ConnectionAdapters::CheckConstraintDefinition table_name=\"users\", expression=\"email IS NOT NULL\", options={:name=>\"users_email_null\", :validate=>false}>, #<struct ActiveRecord::ConnectionAdapters::CheckConstraintDefinition table_name=\"users\", expression=\"email IS NOT NULL\", options={:name=>\"users_email_null\", :validate=>false}>]\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1p18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44899/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44899/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44895","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44895/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44895/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44895/events","html_url":"https://github.com/rails/rails/issues/44895","id":1204373178,"node_id":"I_kwDNIULOR8lGug","number":44895,"title":"Postgresql `create_enum` fails to create the enum type in the current schema.","user":{"login":"philip-maina","id":76848245,"node_id":"MDQ6VXNlcjc2ODQ4MjQ1","avatar_url":"https://avatars.githubusercontent.com/u/76848245?v=4","gravatar_id":"","url":"https://api.github.com/users/philip-maina","html_url":"https://github.com/philip-maina","followers_url":"https://api.github.com/users/philip-maina/followers","following_url":"https://api.github.com/users/philip-maina/following{/other_user}","gists_url":"https://api.github.com/users/philip-maina/gists{/gist_id}","starred_url":"https://api.github.com/users/philip-maina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/philip-maina/subscriptions","organizations_url":"https://api.github.com/users/philip-maina/orgs","repos_url":"https://api.github.com/users/philip-maina/repos","events_url":"https://api.github.com/users/philip-maina/events{/privacy}","received_events_url":"https://api.github.com/users/philip-maina/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-14T10:48:06Z","updated_at":"2022-06-06T19:17:18Z","closed_at":"2022-05-31T12:48:19Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nReproduction script:\r\n```ruby\r\nrequire 'bundler/inline'\r\n\r\ngemfile do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem 'activerecord', '~> 7.0.0'\r\n  gem 'pg'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire \"minitest/autorun\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"postgresql\", database: \"postgresql_enums\")\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  # Create on public schema: ✓\r\n  def setup\r\n    @connection = ActiveRecord::Base.connection\r\n    @connection.transaction do\r\n      @connection.create_enum(\"mood\", [\"sad\", \"ok\", \"happy\"])\r\n      @connection.create_table(\"postgresql_enums\") do |t|\r\n        t.column :current_mood, :mood\r\n      end\r\n    end\r\n  end\r\n\r\n  # Create on test_schema: ✕\r\n  def test_works_with_schemas\r\n    @connection.create_schema \"test_schema\"\r\n    @connection.schema_search_path = \"test_schema\"\r\n    @connection.create_enum(\"mood\", [\"sad\", \"ok\", \"happy\"])\r\n    assert_nothing_raised do\r\n      @connection.create_table(\"postgresql_enums\") do |t|\r\n        t.column :current_mood, :mood\r\n      end\r\n    end\r\n  end\r\nend \r\n```\r\n\r\n### Expected behavior\r\nThe test should pass\r\n\r\n### Actual behavior\r\nThe test fails with exception `ActiveRecord::StatementInvalid: PG::UndefinedObject: ERROR:  type \"mood\" does not exist`\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 2.7\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44895/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44895/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44891","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44891/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44891/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44891/events","html_url":"https://github.com/rails/rails/issues/44891","id":1203695010,"node_id":"I_kwDNIULOR77tog","number":44891,"title":"Introduce option to set app name in the app generator","user":{"login":"nicolasiensen","id":208312,"node_id":"MDQ6VXNlcjIwODMxMg==","avatar_url":"https://avatars.githubusercontent.com/u/208312?v=4","gravatar_id":"","url":"https://api.github.com/users/nicolasiensen","html_url":"https://github.com/nicolasiensen","followers_url":"https://api.github.com/users/nicolasiensen/followers","following_url":"https://api.github.com/users/nicolasiensen/following{/other_user}","gists_url":"https://api.github.com/users/nicolasiensen/gists{/gist_id}","starred_url":"https://api.github.com/users/nicolasiensen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicolasiensen/subscriptions","organizations_url":"https://api.github.com/users/nicolasiensen/orgs","repos_url":"https://api.github.com/users/nicolasiensen/repos","events_url":"https://api.github.com/users/nicolasiensen/events{/privacy}","received_events_url":"https://api.github.com/users/nicolasiensen/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-13T19:26:12Z","updated_at":"2022-04-15T05:06:05Z","closed_at":"2022-04-14T23:17:53Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nWhen generating a new app in the current folder, I have no option to set the application name.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```shell\r\nrails new .\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nI wish we could provide a name for the application when we are creating it in the current folder, something like the following:\r\n\r\n```shell\r\nrails new --name=the-next-unicorn .\r\n```\r\n\r\nThis command would generate the Rails application in the current folder, and the file `./config/application.rb` would like the following:\r\n\r\n```ruby\r\nmodule TheNextUnicorn\r\n  class Application < Rails::Application\r\n    # ...\r\n  end\r\nend\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nWhen we generate the Rails application in the current folder, the file `./config/application.rb` looks like the following:\r\n\r\n```ruby\r\nmodule App\r\n  class Application < Rails::Application\r\n    # ...\r\n  end\r\nend\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.0.2p107\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44891/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44891/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44886","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44886/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44886/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44886/events","html_url":"https://github.com/rails/rails/issues/44886","id":1202891417,"node_id":"I_kwDNIULOR7KqmQ","number":44886,"title":"Collection singular ids attribute should insert objects in bulk","user":{"login":"hboisgibault","id":16622475,"node_id":"MDQ6VXNlcjE2NjIyNDc1","avatar_url":"https://avatars.githubusercontent.com/u/16622475?v=4","gravatar_id":"","url":"https://api.github.com/users/hboisgibault","html_url":"https://github.com/hboisgibault","followers_url":"https://api.github.com/users/hboisgibault/followers","following_url":"https://api.github.com/users/hboisgibault/following{/other_user}","gists_url":"https://api.github.com/users/hboisgibault/gists{/gist_id}","starred_url":"https://api.github.com/users/hboisgibault/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hboisgibault/subscriptions","organizations_url":"https://api.github.com/users/hboisgibault/orgs","repos_url":"https://api.github.com/users/hboisgibault/repos","events_url":"https://api.github.com/users/hboisgibault/events{/privacy}","received_events_url":"https://api.github.com/users/hboisgibault/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-13T07:47:16Z","updated_at":"2022-08-29T07:00:22Z","closed_at":"2022-08-29T07:00:22Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nUsing the _collection_singular_ids_ attribute to update N objects of a has_many relationships (for example book_ids) makes N insert statements.\r\n\r\n### Expected behavior\r\n\r\nSince Rails 6, it should make use of the insert_all function and insert objects in one statement. It would drastically improve performance.\r\n\r\n### Actual behavior\r\n\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4.4\r\n\r\n**Ruby version**:\r\n2.7\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44886/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44886/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44881","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44881/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44881/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44881/events","html_url":"https://github.com/rails/rails/issues/44881","id":1202171533,"node_id":"I_kwDNIULOR6eujQ","number":44881,"title":"Rails autoloader/zeitwerk not loading files correctly on application boot","user":{"login":"christopherdbull","id":392904,"node_id":"MDQ6VXNlcjM5MjkwNA==","avatar_url":"https://avatars.githubusercontent.com/u/392904?v=4","gravatar_id":"","url":"https://api.github.com/users/christopherdbull","html_url":"https://github.com/christopherdbull","followers_url":"https://api.github.com/users/christopherdbull/followers","following_url":"https://api.github.com/users/christopherdbull/following{/other_user}","gists_url":"https://api.github.com/users/christopherdbull/gists{/gist_id}","starred_url":"https://api.github.com/users/christopherdbull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/christopherdbull/subscriptions","organizations_url":"https://api.github.com/users/christopherdbull/orgs","repos_url":"https://api.github.com/users/christopherdbull/repos","events_url":"https://api.github.com/users/christopherdbull/events{/privacy}","received_events_url":"https://api.github.com/users/christopherdbull/received_events","type":"User","site_admin":false},"labels":[{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-04-12T17:27:17Z","updated_at":"2022-04-13T16:02:54Z","closed_at":"2022-04-13T15:56:24Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nSince upgrading from 6.0 to ~7.0 my rails application won't boot due to constant autoloading failure.\r\n\r\nThe Constant in question is a file defined below, living at `app/adapters/content_api/http_client.rb`\r\n```ruby\r\nmodule ContentApi\r\n  class HttpClient\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe file should be autoloaded correctly such that when referenced in environment configuration doesn't crash \r\n`config.x.adapters.content_api = ContentApi::HttpClient`. This was the behaviour under 6.0\r\n### Actual behavior\r\nSystem crashes as the constant hasn't been correctly loaded\r\n\r\n```\r\nrails aborted!\r\nNameError: uninitialized constant ContentApi\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 2.7.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44881/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44880","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44880/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44880/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44880/events","html_url":"https://github.com/rails/rails/issues/44880","id":1202024804,"node_id":"I_kwDNIULOR6VxZA","number":44880,"title":"Active Storage doesn't work with temporary credentials","user":{"login":"ritaamritkar1212","id":15156265,"node_id":"MDQ6VXNlcjE1MTU2MjY1","avatar_url":"https://avatars.githubusercontent.com/u/15156265?v=4","gravatar_id":"","url":"https://api.github.com/users/ritaamritkar1212","html_url":"https://github.com/ritaamritkar1212","followers_url":"https://api.github.com/users/ritaamritkar1212/followers","following_url":"https://api.github.com/users/ritaamritkar1212/following{/other_user}","gists_url":"https://api.github.com/users/ritaamritkar1212/gists{/gist_id}","starred_url":"https://api.github.com/users/ritaamritkar1212/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ritaamritkar1212/subscriptions","organizations_url":"https://api.github.com/users/ritaamritkar1212/orgs","repos_url":"https://api.github.com/users/ritaamritkar1212/repos","events_url":"https://api.github.com/users/ritaamritkar1212/events{/privacy}","received_events_url":"https://api.github.com/users/ritaamritkar1212/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-12T15:33:48Z","updated_at":"2022-04-12T16:02:14Z","closed_at":"2022-04-12T16:02:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n1. When have temporary credentials created for AWS, which expires in certain amount of time.\r\n2. trying to use active_storage to save user avatar in s3 \r\n3. User.rb has\r\n   ` has_one_attached :avatar, dependent: :destroy`\r\n4. storage.yml has\r\n\r\n```\r\namazon:\r\n       service: S3\r\n       access_key_id: ENV[\"AWS_ACCESS_KEY_ID\"]\r\n       secret_access_key: ENV[\"AWS_SECRET_ACCESS_KEY\"]\r\n       session_token: ENV[\"AWS_SESSION_TOKEN\"]\r\n       region: us-east-1\r\n       bucket: ENV[\"BUCKET_NAME\"]\r\n```\r\n\r\n5. in controller,\r\n    `user.avatar.attach(io: File.open('public/test.jpeg'), filename: 'test.jpeg')`\r\n\r\nThis results in below error\r\n **The AWS Access Key Id you provided does not exist in our records. (Aws::S3::Errors::InvalidAccessKeyId)**\r\n\r\n6. If we try to upload the image directly to s3 Bucket it gets uploaded\r\n  ```\r\noptions = {\r\n      region: ENV[\"AWS_REGION\"],\r\n      access_key_id: ENV[\"AWS_ACCESS_KEY_ID\"],\r\n      secret_access_key: ENV[\"AWS_SECRET_ACCESS_KEY\"],\r\n      session_token: ENV[\"AWS_SECURITY_TOKEN\"]\r\n    }\r\n\r\n    r = Aws::S3::Resource.new(options)\r\n    obj = r.bucket(ENV[\"BUCKET_NAME\"]).object('test.jpeg')\r\n    obj.put(body: params[:avatar].to_io)\r\n```\r\n\r\n### Expected behavior\r\nImage should have been uploaded in S3 bucket.\r\n\r\n\r\n### Actual behavior\r\n**The AWS Access Key Id you provided does not exist in our records. (Aws::S3::Errors::InvalidAccessKeyId)**\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.2.3\r\n**Ruby version**:\r\nruby 3.1.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44880/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44880/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44879","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44879/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44879/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44879/events","html_url":"https://github.com/rails/rails/issues/44879","id":1202010663,"node_id":"I_kwDNIULOR6U6Jw","number":44879,"title":"Getting started - 7.5 deleting an article -  add reference to turbo_include_tags","user":{"login":"lind25","id":7740508,"node_id":"MDQ6VXNlcjc3NDA1MDg=","avatar_url":"https://avatars.githubusercontent.com/u/7740508?v=4","gravatar_id":"","url":"https://api.github.com/users/lind25","html_url":"https://github.com/lind25","followers_url":"https://api.github.com/users/lind25/followers","following_url":"https://api.github.com/users/lind25/following{/other_user}","gists_url":"https://api.github.com/users/lind25/gists{/gist_id}","starred_url":"https://api.github.com/users/lind25/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lind25/subscriptions","organizations_url":"https://api.github.com/users/lind25/orgs","repos_url":"https://api.github.com/users/lind25/repos","events_url":"https://api.github.com/users/lind25/events{/privacy}","received_events_url":"https://api.github.com/users/lind25/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-04-12T15:22:23Z","updated_at":"2022-06-29T14:15:43Z","closed_at":"2022-06-29T14:15:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nFollowing the getting started guide on step 7.5 deleting an article - click on the \"Destroy\" link.\r\n\r\n### Expected behavior\r\nA pop up should appear saying \"Are you sure?\"\r\n\r\n### Actual behavior\r\nNothing.\r\n\r\nExpected behaviour can be produced by adding\r\n<%= turbo_include_tags %>\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2.3\r\n**Ruby version**:\r\n3.1.1p18 2022-02-18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44879/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44879/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44877","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44877/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44877/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44877/events","html_url":"https://github.com/rails/rails/issues/44877","id":1201479145,"node_id":"I_kwDNIULOR50d6Q","number":44877,"title":"change_null to false with default raises error when change_table has bulk: true","user":{"login":"oninbo","id":8857825,"node_id":"MDQ6VXNlcjg4NTc4MjU=","avatar_url":"https://avatars.githubusercontent.com/u/8857825?v=4","gravatar_id":"","url":"https://api.github.com/users/oninbo","html_url":"https://github.com/oninbo","followers_url":"https://api.github.com/users/oninbo/followers","following_url":"https://api.github.com/users/oninbo/following{/other_user}","gists_url":"https://api.github.com/users/oninbo/gists{/gist_id}","starred_url":"https://api.github.com/users/oninbo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oninbo/subscriptions","organizations_url":"https://api.github.com/users/oninbo/orgs","repos_url":"https://api.github.com/users/oninbo/repos","events_url":"https://api.github.com/users/oninbo/events{/privacy}","received_events_url":"https://api.github.com/users/oninbo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-12T09:08:22Z","updated_at":"2022-05-21T22:22:20Z","closed_at":"2022-05-21T22:22:20Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nGiven that there are records with nulls in the table\r\n```ruby\r\nclass ChangeAmountNull < ActiveRecord::Migration[7.0]\r\n  def change\r\n    change_table(:payments, bulk: true) do |t|\r\n      t.change_null(:amount, false, 0)\r\n    end\r\n  end\r\nend\r\n```\r\nIt works fine without `bulk: true`\r\n[Gist with tests](https://gist.github.com/oninbo/4822df1f4625f6416cfc857f5482e9ef) \r\n### Expected behavior\r\nColumn is set to not null and records are updated with given default value\r\n\r\n### Actual behavior\r\n`ActiveRecord::NotNullViolation: PG::NotNullViolation` is raised\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44877/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44877/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44876","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44876/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44876/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44876/events","html_url":"https://github.com/rails/rails/issues/44876","id":1201476141,"node_id":"I_kwDNIULOR50SLQ","number":44876,"title":"Rails 6.1.5 fails to launch rails server with config.eager_load = true","user":{"login":"krhitoshi","id":395572,"node_id":"MDQ6VXNlcjM5NTU3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/395572?v=4","gravatar_id":"","url":"https://api.github.com/users/krhitoshi","html_url":"https://github.com/krhitoshi","followers_url":"https://api.github.com/users/krhitoshi/followers","following_url":"https://api.github.com/users/krhitoshi/following{/other_user}","gists_url":"https://api.github.com/users/krhitoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/krhitoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krhitoshi/subscriptions","organizations_url":"https://api.github.com/users/krhitoshi/orgs","repos_url":"https://api.github.com/users/krhitoshi/repos","events_url":"https://api.github.com/users/krhitoshi/events{/privacy}","received_events_url":"https://api.github.com/users/krhitoshi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-12T09:06:22Z","updated_at":"2022-04-13T02:37:46Z","closed_at":"2022-04-12T13:01:07Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```\r\n$ docker run -it --name rails6.1 --rm ruby:3.1.1 bash\r\n# gem install rails -v 6.1.5\r\n# rails new myapp\r\n# cd myapp/\r\n\r\n# curl -sL https://deb.nodesource.com/setup_14.x | bash - && wget -O - https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && echo \"deb https://dl.yarnpkg.com/debian/ stable main\" | tee /etc/apt/sources.list.d/yarn.list && apt-get update && apt-get install -y --no-install-recommends nodejs yarn\r\n# rails webpacker:install\r\n\r\n# rails server -e production\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nYou can launch rails server in both development and production.\r\nHere is the behavior of Rails  7.0.2.3 with Ruby 3.1.1.\r\n\r\n```\r\n$ docker run -it --name rails7.0 --rm ruby:3.1.1 bash\r\n# gem install rails -v 7.0.2.3\r\n# rails new myapp\r\n# cd myapp/\r\n\r\n# rails server\r\n=> Booting Puma\r\n=> Rails 7.0.2.3 application starting in development\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.1-p18) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: development\r\n*          PID: 513\r\n* Listening on http://127.0.0.1:3000\r\nUse Ctrl-C to stop\r\n\r\n# rails server -e production\r\n=> Booting Puma\r\n=> Rails 7.0.2.3 application starting in production\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.1-p18) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: production\r\n*          PID: 525\r\n* Listening on http://0.0.0.0:3000\r\nUse Ctrl-C to stop\r\n```\r\n\r\n`Mail.eager_autoload!` and `Mail.new` works well on rails console.\r\n\r\n```\r\n# rails console\r\nLoading development environment (Rails 7.0.2.3)\r\nirb(main):001:0>  Mail.eager_autoload!\r\n=>\r\n{:SMTP=>\"mail/network/delivery_methods/smtp\",\r\n :FileDelivery=>\"mail/network/delivery_methods/file_delivery\",\r\n :LoggerDelivery=>\"mail/network/delivery_methods/logger_delivery\",\r\n :Sendmail=>\"mail/network/delivery_methods/sendmail\",\r\n :Exim=>\"mail/network/delivery_methods/exim\",\r\n :SMTPConnection=>\"mail/network/delivery_methods/smtp_connection\",\r\n :TestMailer=>\"mail/network/delivery_methods/test_mailer\",\r\n :POP3=>\"mail/network/retriever_methods/pop3\",\r\n :IMAP=>\"mail/network/retriever_methods/imap\",\r\n :TestRetriever=>\"mail/network/retriever_methods/test_retriever\",\r\n :UnstructuredField=>\"mail/fields/unstructured_field\",\r\n :StructuredField=>\"mail/fields/structured_field\",\r\n :OptionalField=>\"mail/fields/optional_field\",\r\n :BccField=>\"mail/fields/bcc_field\",\r\n :CcField=>\"mail/fields/cc_field\",\r\n :CommentsField=>\"mail/fields/comments_field\",\r\n :ContentDescriptionField=>\"mail/fields/content_description_field\",\r\n :ContentDispositionField=>\"mail/fields/content_disposition_field\",\r\n :ContentIdField=>\"mail/fields/content_id_field\",\r\n :ContentLocationField=>\"mail/fields/content_location_field\",\r\n :ContentTransferEncodingField=>\"mail/fields/content_transfer_encoding_field\",\r\n :ContentTypeField=>\"mail/fields/content_type_field\",\r\n :DateField=>\"mail/fields/date_field\",\r\n :FromField=>\"mail/fields/from_field\",\r\n :InReplyToField=>\"mail/fields/in_reply_to_field\",\r\n :KeywordsField=>\"mail/fields/keywords_field\",\r\n :MessageIdField=>\"mail/fields/message_id_field\",\r\n :MimeVersionField=>\"mail/fields/mime_version_field\",\r\n :ReceivedField=>\"mail/fields/received_field\",\r\n :ReferencesField=>\"mail/fields/references_field\",\r\n :ReplyToField=>\"mail/fields/reply_to_field\",\r\n :ResentBccField=>\"mail/fields/resent_bcc_field\",\r\n :ResentCcField=>\"mail/fields/resent_cc_field\",\r\n :ResentDateField=>\"mail/fields/resent_date_field\",\r\n :ResentFromField=>\"mail/fields/resent_from_field\",\r\n :ResentMessageIdField=>\"mail/fields/resent_message_id_field\",\r\n :ResentSenderField=>\"mail/fields/resent_sender_field\",\r\n :ResentToField=>\"mail/fields/resent_to_field\",\r\n :ReturnPathField=>\"mail/fields/return_path_field\",\r\n :SenderField=>\"mail/fields/sender_field\",\r\n :SubjectField=>\"mail/fields/subject_field\",\r\n :ToField=>\"mail/fields/to_field\",\r\n :Parsers=>\"mail/parsers\",\r\n :Address=>\"mail/elements/address\",\r\n :AddressList=>\"mail/elements/address_list\",\r\n :ContentDispositionElement=>\"mail/elements/content_disposition_element\",\r\n :ContentLocationElement=>\"mail/elements/content_location_element\",\r\n :ContentTransferEncodingElement=>\"mail/elements/content_transfer_encoding_element\",\r\n :ContentTypeElement=>\"mail/elements/content_type_element\",\r\n :DateTimeElement=>\"mail/elements/date_time_element\",\r\n :EnvelopeFromElement=>\"mail/elements/envelope_from_element\",\r\n :MessageIdsElement=>\"mail/elements/message_ids_element\",\r\n :MimeVersionElement=>\"mail/elements/mime_version_element\",\r\n :PhraseList=>\"mail/elements/phrase_list\",\r\n :ReceivedElement=>\"mail/elements/received_element\"}\r\nirb(main):002:0> Mail.new\r\n=> #<Mail::Message:29080, Multipart: false, Headers: >\r\n```\r\n\r\nRails  6.1.5 with Ruby 3.0.3 worked as well, anyway.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nYou can launch rails server in development. But not in production.\r\n\r\n```\r\n# rails server\r\n=> Booting Puma\r\n=> Rails 6.1.5 application starting in development\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.1-p18) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: development\r\n*          PID: 2956\r\n* Listening on http://127.0.0.1:3000\r\nUse Ctrl-C to stop\r\n\r\n# rails server -e production\r\n=> Booting Puma\r\n=> Rails 6.1.5 application starting in production\r\n=> Run `bin/rails server --help` for more startup options\r\nExiting\r\n/usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/delivery_methods.rb:42:in `<module:ClassMethods>': uninitialized constant Mail::TestMailer (NameError)\r\n\r\n      delegate :deliveries, :deliveries=, to: Mail::TestMailer\r\n                                                  ^^^^^^^^^^^^\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/delivery_methods.rb:40:in `<module:DeliveryMethods>'\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/delivery_methods.rb:8:in `<module:ActionMailer>'\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/delivery_methods.rb:5:in `<main>'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:35:in `require'\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/base.rb:438:in `<class:Base>'\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/base.rb:437:in `<module:ActionMailer>'\r\n\tfrom /usr/local/bundle/gems/actionmailer-6.1.5/lib/action_mailer/base.rb:12:in `<main>'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:35:in `require'\r\n\tfrom /myapp/app/mailers/application_mailer.rb:1:in `<main>'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/kernel.rb:27:in `require'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/helpers.rb:95:in `const_get'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/helpers.rb:95:in `cget'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:237:in `block (2 levels) in eager_load'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/helpers.rb:26:in `block in ls'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/helpers.rb:18:in `each_child'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader/helpers.rb:18:in `ls'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:232:in `block in eager_load'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:217:in `synchronize'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:217:in `eager_load'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:317:in `each'\r\n\tfrom /usr/local/bundle/gems/zeitwerk-2.5.4/lib/zeitwerk/loader.rb:317:in `eager_load_all'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/application/finisher.rb:133:in `block in <module:Finisher>'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/initializable.rb:32:in `instance_exec'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/initializable.rb:32:in `run'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/initializable.rb:61:in `block in run_initializers'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:228:in `block in tsort_each'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:347:in `each'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:347:in `call'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:347:in `each_strongly_connected_component'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:226:in `tsort_each'\r\n\tfrom /usr/local/lib/ruby/3.1.0/tsort.rb:205:in `tsort_each'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/initializable.rb:60:in `run_initializers'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/application.rb:391:in `initialize!'\r\n\tfrom /myapp/config/environment.rb:5:in `<main>'\r\n\tfrom config.ru:3:in `require_relative'\r\n\tfrom config.ru:3:in `block in <main>'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/builder.rb:116:in `eval'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/builder.rb:116:in `new_from_string'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/builder.rb:105:in `load_file'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/builder.rb:66:in `parse_file'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:349:in `build_app_and_options_from_config'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:249:in `app'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:422:in `wrapped_app'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:312:in `block in start'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:379:in `handle_profiling'\r\n\tfrom /usr/local/bundle/gems/rack-2.2.3/lib/rack/server.rb:311:in `start'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/commands/server/server_command.rb:39:in `start'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/commands/server/server_command.rb:144:in `block in perform'\r\n\tfrom <internal:kernel>:90:in `tap'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/commands/server/server_command.rb:135:in `perform'\r\n\tfrom /usr/local/bundle/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\tfrom /usr/local/bundle/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /usr/local/bundle/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/command/base.rb:69:in `perform'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/command.rb:48:in `invoke'\r\n\tfrom /usr/local/bundle/gems/railties-6.1.5/lib/rails/commands.rb:18:in `<main>'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /usr/local/bundle/gems/bootsnap-1.11.1/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n\tfrom /myapp/bin/rails:5:in `<top (required)>'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/client/rails.rb:30:in `load'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/client/rails.rb:30:in `call'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/client/command.rb:7:in `call'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/client.rb:30:in `run'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/bin/spring:49:in `<top (required)>'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/binstub.rb:11:in `load'\r\n\tfrom /usr/local/bundle/gems/spring-4.0.0/lib/spring/binstub.rb:11:in `<top (required)>'\r\n\tfrom <internal:/usr/local/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/local/lib/ruby/3.1.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /myapp/bin/spring:10:in `block in <top (required)>'\r\n\tfrom <internal:kernel>:90:in `tap'\r\n\tfrom /myapp/bin/spring:7:in `<top (required)>'\r\n\tfrom bin/rails:2:in `load'\r\n\tfrom bin/rails:2:in `<main>'\r\n```\r\n\r\nI found that it is possible to launch rails server even in production when I disable ` config.eager_load`.\r\n\r\n```\r\n# apt update\r\n# apt install vim\r\n# vi config/environments/production.rb\r\n  #config.eager_load = true\r\n  config.eager_load = false\r\n\r\n# rails server -e production\r\n=> Booting Puma\r\n=> Rails 6.1.5 application starting in production\r\n=> Run `bin/rails server --help` for more startup options\r\nPuma starting in single mode...\r\n* Puma version: 5.6.4 (ruby 3.1.1-p18) (\"Birdie's Version\")\r\n*  Min threads: 5\r\n*  Max threads: 5\r\n*  Environment: production\r\n*          PID: 2945\r\n* Listening on http://0.0.0.0:3000\r\nUse Ctrl-C to stop\r\n```\r\n\r\n`Mail` module seems to work strangely.\r\nEither `Mail.eager_autoload!` or `Mail.new` does not work well on rails console.\r\n\r\n```\r\n# rails console\r\nRunning via Spring preloader in process 2986\r\nLoading development environment (Rails 6.1.5)\r\nirb(main):001:0> Mail.eager_autoload!\r\n(irb):1:in `<main>': undefined method `eager_autoload!' for Mail:Module (NoMethodError)\r\nirb(main):002:0> Mail.new\r\n(irb):2:in `<main>': undefined method `new' for Mail:Module (NoMethodError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44876/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44876/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44875","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44875/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44875/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44875/events","html_url":"https://github.com/rails/rails/issues/44875","id":1200954432,"node_id":"I_kwDNIULOR5UcQA","number":44875,"title":"Database connections opened in routes not closed","user":{"login":"kuahyeow","id":16723,"node_id":"MDQ6VXNlcjE2NzIz","avatar_url":"https://avatars.githubusercontent.com/u/16723?v=4","gravatar_id":"","url":"https://api.github.com/users/kuahyeow","html_url":"https://github.com/kuahyeow","followers_url":"https://api.github.com/users/kuahyeow/followers","following_url":"https://api.github.com/users/kuahyeow/following{/other_user}","gists_url":"https://api.github.com/users/kuahyeow/gists{/gist_id}","starred_url":"https://api.github.com/users/kuahyeow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kuahyeow/subscriptions","organizations_url":"https://api.github.com/users/kuahyeow/orgs","repos_url":"https://api.github.com/users/kuahyeow/repos","events_url":"https://api.github.com/users/kuahyeow/events{/privacy}","received_events_url":"https://api.github.com/users/kuahyeow/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-04-12T03:40:17Z","updated_at":"2022-04-26T09:44:35Z","closed_at":"2022-04-14T01:31:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Problem\r\n\r\nWhen using multiple database connections, and opening a connection in `config/routes.rb`, the `db:test:prepare` task is broken due to not closing all connections before trying to drop the database.\r\n\r\nGitLab migrated to using multiple databases. Running tests sometimes fails when Rails reloads the test database (`db:test:prepare`) with ActiveRecord::StatementInvalid: PG::ObjectInUse: ERROR: database \"gitlabhq_test_ci\" is being accessed by other users`. See https://gitlab.com/gitlab-org/gitlab/-/issues/356656\r\n\r\nWe are  currently running on Rails 6.1.4.7, and still autoload in initializers. To exclude GitLab specific code, I have made a sample reproduction app (see below)\r\n\r\n### Detailed investigation\r\n\r\n1. In an `after_initialize`, Rails closes all connections opened during boot in [`active_record.clear_active_connections`](https://github.com/rails/rails/blob/fdf840f69a2e33d78a9d40b91d9b7fddb76711e9/activerecord/lib/active_record/railtie.rb#L308).\r\n2. However, there is a [`set_routes_reloader_hook`](https://github.com/rails/rails/blob/fdf840f69a2e33d78a9d40b91d9b7fddb76711e9/railties/lib/rails/application/finisher.rb#L149) which runs after `after_initialize`. Which means database connections opened in routes do not get closed.\r\n3. This affects rake tasks like `db:test:prepare` as these open connections prevent the test database from being dropped.\r\n4. However, this only affects multiple databases because by accident, Rails removes the previous connection_pool owned by `ActiveRecord::Base`. Follow [`establish_master_connection`](https://github.com/rails/rails/blob/b2669d7361fe43e1b1d5ce2add3cb63c9061b761/activerecord/lib/active_record/tasks/postgresql_database_tasks.rb#L31). Removing the connection_pool closes the database connection\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n1. Check out the reproduction rails app in https://gitlab.com/tkuah/test_prepare_multi\r\n1. Run `RAILS_ENV=test be rails db:test:prepare`. Observe the error.\r\n1. If you comment out the `TempAnimalsRecord.current_database` in `config/routes.rb`, the error does not happen.\r\n\r\n### Expected behavior\r\n\r\nThe rake test drops, and re-creates the test databases\r\n\r\n### Actual behavior\r\n\r\nA `PG::ObjectInUse` error occurs:\r\n\r\n```\r\nActiveRecord::StatementInvalid: PG::ObjectInUse: ERROR:  database \"test_prepare_multi_test_animals\" is being accessed by other users\r\nDETAIL:  There is 1 other session using the database.\r\n\r\n\r\nCaused by:\r\nPG::ObjectInUse: ERROR:  database \"test_prepare_multi_test_animals\" is being accessed by other users\r\nDETAIL:  There is 1 other session using the database.\r\n\r\nTasks: TOP => db:test:load => db:test:purge\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: `Rails 7.0.2.3`\r\n\r\n**Ruby version**: `ruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [arm64-darwin21]`\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44875/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44875/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44867","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44867/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44867/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44867/events","html_url":"https://github.com/rails/rails/issues/44867","id":1199226791,"node_id":"I_kwDNIULOR3q_pw","number":44867,"title":"Actions named `#alert` and `#notice` are not available from Rails 7","user":{"login":"r7kamura","id":111689,"node_id":"MDQ6VXNlcjExMTY4OQ==","avatar_url":"https://avatars.githubusercontent.com/u/111689?v=4","gravatar_id":"","url":"https://api.github.com/users/r7kamura","html_url":"https://github.com/r7kamura","followers_url":"https://api.github.com/users/r7kamura/followers","following_url":"https://api.github.com/users/r7kamura/following{/other_user}","gists_url":"https://api.github.com/users/r7kamura/gists{/gist_id}","starred_url":"https://api.github.com/users/r7kamura/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/r7kamura/subscriptions","organizations_url":"https://api.github.com/users/r7kamura/orgs","repos_url":"https://api.github.com/users/r7kamura/repos","events_url":"https://api.github.com/users/r7kamura/events{/privacy}","received_events_url":"https://api.github.com/users/r7kamura/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-10T23:56:57Z","updated_at":"2022-04-23T02:19:56Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nRun this test:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile do\r\n  source 'https://rubygems.org'\r\n\r\n  gem 'rails', '~> 7.0.0'\r\nend\r\n\r\nrequire 'rack/test'\r\nrequire 'action_controller/railtie'\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << 'example.org'\r\n  config.session_store :cookie_store, key: 'cookie_store_key'\r\n  secrets.secret_key_base = 'secret_key_base'\r\n\r\n  config.logger = ::Logger.new($stdout)\r\n  ::Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get '/notice' => 'test#notice'\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include ::Rails.application.routes.url_helpers\r\n\r\n  def notice\r\n    head :ok\r\n  end\r\nend\r\n\r\nrequire 'minitest/autorun'\r\n\r\nclass BugTest < Minitest::Test\r\n  include ::Rack::Test::Methods\r\n\r\n  def test_notice_action\r\n    get '/notice'\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n\r\n  def app\r\n    ::Rails.application\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nWhen I define an action named `#alert` or `#notice`, I expect it to work normally.\r\n\r\n### Actual behavior\r\n\r\nThis test succeeds on Rails 6.1, but fails on Rails 7.0.\r\n\r\n```console\r\n$ ruby test.rb \r\nFetching gem metadata from https://rubygems.org/...........\r\nResolving dependencies...\r\nUsing rake 13.0.6\r\nUsing concurrent-ruby 1.1.10\r\nUsing minitest 5.15.0\r\nUsing builder 3.2.4\r\nUsing erubi 1.10.0\r\nUsing racc 1.6.0\r\nUsing crass 1.0.6\r\nUsing rack 2.2.3\r\nUsing nio4r 2.5.8\r\nUsing websocket-extensions 0.1.5\r\nUsing marcel 1.0.2\r\nUsing mini_mime 1.1.2\r\nUsing digest 3.1.0\r\nUsing timeout 0.2.0\r\nUsing strscan 3.0.1\r\nUsing bundler 2.3.6\r\nUsing method_source 1.0.0\r\nUsing thor 1.2.1\r\nUsing zeitwerk 2.5.4\r\nUsing i18n 1.10.0\r\nUsing tzinfo 2.0.4\r\nUsing rack-test 1.1.0\r\nUsing activesupport 7.0.2.3\r\nUsing globalid 1.0.0\r\nUsing websocket-driver 0.7.5\r\nUsing activemodel 7.0.2.3\r\nUsing activejob 7.0.2.3\r\nUsing mail 2.7.1\r\nUsing nokogiri 1.13.3 (x86_64-linux)\r\nUsing net-protocol 0.1.3\r\nUsing rails-dom-testing 2.0.3\r\nUsing loofah 2.16.0\r\nUsing net-imap 0.2.3\r\nUsing net-pop 0.1.1\r\nUsing activerecord 7.0.2.3\r\nUsing net-smtp 0.3.1\r\nUsing rails-html-sanitizer 1.4.2\r\nUsing actionview 7.0.2.3\r\nUsing actionpack 7.0.2.3\r\nUsing actioncable 7.0.2.3\r\nUsing activestorage 7.0.2.3\r\nUsing actionmailer 7.0.2.3\r\nUsing railties 7.0.2.3\r\nUsing actionmailbox 7.0.2.3\r\nUsing actiontext 7.0.2.3\r\nUsing rails 7.0.2.3\r\nRun options: --seed 2353\r\n\r\n# Running:\r\n\r\nI, [2022-04-11T08:51:49.764647 #23370]  INFO -- : Started GET \"/notice\" for 127.0.0.1 at 2022-04-11 08:51:49 +0900\r\nF, [2022-04-11T08:51:49.834118 #23370] FATAL -- :   \r\nAbstractController::ActionNotFound (The action 'notice' could not be found for TestController):\r\n  \r\ntest.rb:42:in `test_notice_action'\r\nF\r\n\r\nFailure:\r\nBugTest#test_notice_action [test.rb:43]:\r\nExpected false to be truthy.\r\n\r\nrails test test.rb:41\r\n\r\n\r\n\r\nFinished in 0.085620s, 11.6795 runs/s, 11.6795 assertions/s.\r\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 2.7.2\r\n\r\n```console\r\n$ ruby -v\r\nruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x86_64-linux]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44867/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44867/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44863","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44863/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44863/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44863/events","html_url":"https://github.com/rails/rails/issues/44863","id":1197554225,"node_id":"I_kwDNIULOR2E6MQ","number":44863,"title":"link_to with data-turbo-method=\"post\"","user":{"login":"rctneil","id":774459,"node_id":"MDQ6VXNlcjc3NDQ1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/774459?v=4","gravatar_id":"","url":"https://api.github.com/users/rctneil","html_url":"https://github.com/rctneil","followers_url":"https://api.github.com/users/rctneil/followers","following_url":"https://api.github.com/users/rctneil/following{/other_user}","gists_url":"https://api.github.com/users/rctneil/gists{/gist_id}","starred_url":"https://api.github.com/users/rctneil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rctneil/subscriptions","organizations_url":"https://api.github.com/users/rctneil/orgs","repos_url":"https://api.github.com/users/rctneil/repos","events_url":"https://api.github.com/users/rctneil/events{/privacy}","received_events_url":"https://api.github.com/users/rctneil/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-04-08T16:56:41Z","updated_at":"2022-07-26T09:14:07Z","closed_at":"2022-05-21T07:24:41Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI have a link like below:\r\n\r\n        <%= link_to \"Tidy Gallery\",\r\n            admin_gallery_tidy_path,\r\n            \"am-button\": '',\r\n            data: {\r\n                turbo_method: :delete\r\n            }\r\n        %>\r\n\r\n### Expected behavior\r\nShould submit a POST request to the `admin_gallery_tidy_path`\r\n\r\n### Actual behavior\r\nA GET request is made to the `admin_gallery_tidy_path` instead\r\n\r\nI have tried suggestions from other issues. Tried reinstalling Stimulus and Turbo. If I switch to `button_to`, it works but I need a `link_to`.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44863/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44863/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44861","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44861/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44861/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44861/events","html_url":"https://github.com/rails/rails/issues/44861","id":1197328993,"node_id":"I_kwDNIULOR13KYQ","number":44861,"title":"ActiveRecord update_all ignoring the subquery from the from method","user":{"login":"layonferreira","id":5243855,"node_id":"MDQ6VXNlcjUyNDM4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/5243855?v=4","gravatar_id":"","url":"https://api.github.com/users/layonferreira","html_url":"https://github.com/layonferreira","followers_url":"https://api.github.com/users/layonferreira/followers","following_url":"https://api.github.com/users/layonferreira/following{/other_user}","gists_url":"https://api.github.com/users/layonferreira/gists{/gist_id}","starred_url":"https://api.github.com/users/layonferreira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/layonferreira/subscriptions","organizations_url":"https://api.github.com/users/layonferreira/orgs","repos_url":"https://api.github.com/users/layonferreira/repos","events_url":"https://api.github.com/users/layonferreira/events{/privacy}","received_events_url":"https://api.github.com/users/layonferreira/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-04-08T13:36:08Z","updated_at":"2022-08-29T07:00:23Z","closed_at":"2022-08-29T07:00:23Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem 'activerecord', '~> 7.0.0'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.string :title\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post2 = Post.create!\r\n    Post.from(Post.where(id: post)).update_all(title: 'a')\r\n\r\n    assert_equal 'a', post.reload.title\r\n    assert_equal nil, post2.reload.title\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nI would expect `Post.from(Post.where(id: post)).update_all(title: 'a')` to only update posts that matches the records returned by `Post.from(Post.where(id: post))`\r\n### Actual behavior\r\nIt ignores the subquery and updates all posts\r\n### System configuration\r\n**Rails version**:\r\n7.x and 6.x\r\n**Ruby version**:\r\n2.7.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44861/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44861/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44855","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44855/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44855/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44855/events","html_url":"https://github.com/rails/rails/issues/44855","id":1195387576,"node_id":"I_kwDNIULOR0AquA","number":44855,"title":"Active Storage Direct Upload problem","user":{"login":"resistorsoftware","id":123307,"node_id":"MDQ6VXNlcjEyMzMwNw==","avatar_url":"https://avatars.githubusercontent.com/u/123307?v=4","gravatar_id":"","url":"https://api.github.com/users/resistorsoftware","html_url":"https://github.com/resistorsoftware","followers_url":"https://api.github.com/users/resistorsoftware/followers","following_url":"https://api.github.com/users/resistorsoftware/following{/other_user}","gists_url":"https://api.github.com/users/resistorsoftware/gists{/gist_id}","starred_url":"https://api.github.com/users/resistorsoftware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/resistorsoftware/subscriptions","organizations_url":"https://api.github.com/users/resistorsoftware/orgs","repos_url":"https://api.github.com/users/resistorsoftware/repos","events_url":"https://api.github.com/users/resistorsoftware/events{/privacy}","received_events_url":"https://api.github.com/users/resistorsoftware/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-07T01:49:07Z","updated_at":"2022-04-12T17:55:27Z","closed_at":"2022-04-12T17:53:59Z","author_association":"NONE","active_lock_reason":null,"body":"ActiveStorage 7.0.2.2\r\n\r\nI render a form accepting one file, and have direct_upload set to true. So my input element in the form looks good. \r\n\r\n    <input accept=\"text/csv,.csv,application/vnd.ms-excel\" data-polaris-dropzone-target=\"input\" data-action=\"focus->polaris-dropzone#onFocus blur->polaris-dropzone#onBlur change->polaris-dropzone#onChange\" data-direct-upload-url=\"https://myserver.test/rails/active_storage/direct_uploads?shop=cold-cola.myshopify.com\" type=\"file\" name=\"upload-file\" id=\"upload-file\">\r\n\r\nIf I click the file browser and select a file to upload, and click submit on this button, the data-direct-upload-url is used and the blob is processed, and then the data is send via a POST to the form action, and all is well. But if I use the Dropzone to drop a file, and click the same submit button, instead, no direct upload is detected, and the form just submits to the form action URL and no direct upload happens. \r\n\r\nWhy can a form submit behave two ways? One is totally correct and great, yet the other is botched? I am unable to see where this for submit fails to get processed by DirectUpload correctly. \r\n\r\nThe form renders nice (uses a view component library but that should be neither here nor there). Any clues on where I should be looking? \r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44855/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44855/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44853","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44853/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44853/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44853/events","html_url":"https://github.com/rails/rails/issues/44853","id":1194908950,"node_id":"I_kwDNIULORzjdFg","number":44853,"title":"Rails 7: find_by_sql binding int to string","user":{"login":"robertochingon","id":4256081,"node_id":"MDQ6VXNlcjQyNTYwODE=","avatar_url":"https://avatars.githubusercontent.com/u/4256081?v=4","gravatar_id":"","url":"https://api.github.com/users/robertochingon","html_url":"https://github.com/robertochingon","followers_url":"https://api.github.com/users/robertochingon/followers","following_url":"https://api.github.com/users/robertochingon/following{/other_user}","gists_url":"https://api.github.com/users/robertochingon/gists{/gist_id}","starred_url":"https://api.github.com/users/robertochingon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robertochingon/subscriptions","organizations_url":"https://api.github.com/users/robertochingon/orgs","repos_url":"https://api.github.com/users/robertochingon/repos","events_url":"https://api.github.com/users/robertochingon/events{/privacy}","received_events_url":"https://api.github.com/users/robertochingon/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-06T17:30:47Z","updated_at":"2022-04-09T11:03:16Z","closed_at":"2022-04-09T11:03:16Z","author_association":"NONE","active_lock_reason":null,"body":"I have a ruby on rails Rails 7.0.2.2 webapp (ruby version 3.0.3) with a query to mysql 8.0.18 for macos10.14 on x86_64 database like:\r\n\r\npagIndex = params[:pagIndex].to_i\r\nlimitBoats = 20\r\noffset = pagIndex * 20  \r\nvalues = Array.new  \r\nindexValues = 0\r\n\r\nsQuery = \"SELECT DISTINCT b.id, ... FROM ... WHERE ... LIMIT ? OFFSET ?\"\r\n\r\nvalues.insert(indexValues + 1, limitBoats)\r\nvalues.insert(indexValues + 2, offset)    \r\nvalues.shift    \r\nvalues.insert(0, sQuery)\r\n@result = Entity.find_by_sql(values)\r\nThis code is working perfectly and it´s translating to a query like:\r\n\r\nSELECT ... LIMIT '20' OFFSET '0';\r\nwhere limit and offset are strings.\r\n\r\nThis has been working perfectly for years in my previous ruby 2.4, rails 4 and mysql 5.5. However, after migrating to ruby 3, Rails 7 and mysql 8, I get error in the limit and offset parameters, because mysql is expecting an integer.\r\n\r\nIf I just remove the '', the query works. How can I get this working with find_by_sql?\r\n\r\nI guess I´m missing something as I don´t even find any other issues like this one.\r\n\r\nNote: limit and offset are part of a pagination, so they are coming from variables and I cannot just use these values as constant integers.\r\n\r\nUPDATE just to debug it easier, if I just create a method with:\r\n\r\n@result = Entity.find_by_sql(['select * from entity limit ?', 11])\r\n    logger.debug \"Entities=\" + @result.inspect\r\nI´m getting this output:\r\n\r\nDEBUG -- :   Entity Load (0.5ms)  select * from boats limit '11'\r\nCompleted 500 Internal Server Error in 1ms (ActiveRecord: 0.5ms | Allocations: 324)\r\n\r\n\r\n  \r\nActiveRecord::StatementInvalid (Mysql2::Error: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''11'' at line 1):\r\nAs you can see it´s changing the int to string and mysql 8 complains.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44853/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44853/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44852","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44852/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44852/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44852/events","html_url":"https://github.com/rails/rails/issues/44852","id":1194510960,"node_id":"I_kwDNIULORzLKcA","number":44852,"title":"SQL sanitize LIKE and \\","user":{"login":"thibauds","id":5623472,"node_id":"MDQ6VXNlcjU2MjM0NzI=","avatar_url":"https://avatars.githubusercontent.com/u/5623472?v=4","gravatar_id":"","url":"https://api.github.com/users/thibauds","html_url":"https://github.com/thibauds","followers_url":"https://api.github.com/users/thibauds/followers","following_url":"https://api.github.com/users/thibauds/following{/other_user}","gists_url":"https://api.github.com/users/thibauds/gists{/gist_id}","starred_url":"https://api.github.com/users/thibauds/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thibauds/subscriptions","organizations_url":"https://api.github.com/users/thibauds/orgs","repos_url":"https://api.github.com/users/thibauds/repos","events_url":"https://api.github.com/users/thibauds/events{/privacy}","received_events_url":"https://api.github.com/users/thibauds/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-06T11:59:51Z","updated_at":"2022-04-06T13:09:52Z","closed_at":"2022-04-06T13:09:52Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\nThe [documentation](https://api.rubyonrails.org/classes/ActiveRecord/Sanitization/ClassMethods.html#method-i-sanitize_sql_like) says that this [sanitize_sql_like](https://github.com/rails/rails/blob/de53ba56cab69fb9707785a397a59ac4aaee9d6f/activerecord/lib/active_record/sanitization.rb#L108) function \r\n> uses +escape_character+ to escape all occurrences of \"\\\", \"_\" and \"%\".\r\n\r\nhttps://github.com/rails/rails/blob/de53ba56cab69fb9707785a397a59ac4aaee9d6f/activerecord/lib/active_record/sanitization.rb#L108\r\n\r\nNevertheless, the used Regexp is the union of 2 of the 3 aforementioned characters.\r\n```\r\npattern = Regexp.union(escape_character, \"%\", \"_\")\r\n```\r\nwhich does not include the \"\\\", is it on purpose ?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44852/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44852/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44851","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44851/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44851/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44851/events","html_url":"https://github.com/rails/rails/issues/44851","id":1194147589,"node_id":"I_kwDNIULORy0_BQ","number":44851,"title":"Cannot run rails test command","user":{"login":"koorizhizhi","id":83855880,"node_id":"MDQ6VXNlcjgzODU1ODgw","avatar_url":"https://avatars.githubusercontent.com/u/83855880?v=4","gravatar_id":"","url":"https://api.github.com/users/koorizhizhi","html_url":"https://github.com/koorizhizhi","followers_url":"https://api.github.com/users/koorizhizhi/followers","following_url":"https://api.github.com/users/koorizhizhi/following{/other_user}","gists_url":"https://api.github.com/users/koorizhizhi/gists{/gist_id}","starred_url":"https://api.github.com/users/koorizhizhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/koorizhizhi/subscriptions","organizations_url":"https://api.github.com/users/koorizhizhi/orgs","repos_url":"https://api.github.com/users/koorizhizhi/repos","events_url":"https://api.github.com/users/koorizhizhi/events{/privacy}","received_events_url":"https://api.github.com/users/koorizhizhi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-06T07:08:54Z","updated_at":"2022-04-06T13:12:36Z","closed_at":"2022-04-06T13:12:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, I'm new to Rails and following the rails tutorial book  to build a sample project.\r\nThis is what I get when _rails test_ command is used:\r\n<img width=\"616\" alt=\"image\" src=\"https://user-images.githubusercontent.com/83855880/161915637-605520fb-9904-4b76-bcc5-1062ada1e12e.png\">\r\nCan someone tell me why it is raised?\r\nEnv:\r\n<img width=\"498\" alt=\"image\" src=\"https://user-images.githubusercontent.com/83855880/161916199-eb7e9172-9230-407c-ad6b-1e7ea274b347.png\">\r\n<img width=\"227\" alt=\"image\" src=\"https://user-images.githubusercontent.com/83855880/161916262-a2ffc523-1ebe-44fb-b141-39937a7e7d73.png\">\r\n\r\nAppreciate your help.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44851/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44848","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44848/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44848/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44848/events","html_url":"https://github.com/rails/rails/issues/44848","id":1194118609,"node_id":"I_kwDNIULORyzN0Q","number":44848,"title":"ActiveStorage::Streaming not compatible with Variants/Representations","user":{"login":"adamdebono","id":1049190,"node_id":"MDQ6VXNlcjEwNDkxOTA=","avatar_url":"https://avatars.githubusercontent.com/u/1049190?v=4","gravatar_id":"","url":"https://api.github.com/users/adamdebono","html_url":"https://github.com/adamdebono","followers_url":"https://api.github.com/users/adamdebono/followers","following_url":"https://api.github.com/users/adamdebono/following{/other_user}","gists_url":"https://api.github.com/users/adamdebono/gists{/gist_id}","starred_url":"https://api.github.com/users/adamdebono/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adamdebono/subscriptions","organizations_url":"https://api.github.com/users/adamdebono/orgs","repos_url":"https://api.github.com/users/adamdebono/repos","events_url":"https://api.github.com/users/adamdebono/events{/privacy}","received_events_url":"https://api.github.com/users/adamdebono/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-06T06:37:31Z","updated_at":"2022-07-12T17:59:48Z","closed_at":"2022-07-12T17:59:48Z","author_association":"NONE","active_lock_reason":null,"body":"I have created my own controller to serve ActiveStorage blobs in my Rails application, using `ActiveStorage::Blobs::ProxyController` as a starting point. One of the features I'm working on is to allow passing query parameters to resize an image, however the methods in `ActiveStorage::Streaming` don't seem to support this.\r\n\r\n### Steps to reproduce\r\n\r\nSimplified a bit, but my controller looks like this:\r\n```ruby\r\nclass BlobsController < ApplicationController\r\n  include ActiveStorage::Streaming\r\n\r\n  def show\r\n    blob = ActiveStorage::Blob.find_signed!(params[:signed_id])\r\n    \r\n    if params[:size].present?\r\n      size = params[:size].to_i\r\n      blob = blob.representation({ resize_to_fit: [size, size] })\r\n    end\r\n\r\n    if request.headers['Range'].present?\r\n      send_blob_byte_range_data @blob, request.headers['Range']\r\n    else\r\n      response.headers['Accept-Ranges'] = 'bytes'\r\n      # response.headers['Content-Length'] = blob.byte_size.to_s\r\n\r\n      send_blob_stream blob, disposition: params[:disposition]\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nThe controller should create the variant representation of the image and serve it through the streaming methods.\r\n\r\n### Actual behavior\r\nThe controller raises `undefined method` errors because a variant (whether that be `ActiveStorage::Variant`, `ActiveStorage::VariantRecord` or `ActivateStorage::VariantWithRecord`) are missing attributes for `filename` and `byte_size`.\r\n\r\n\r\nThe filename is an easy issue to fix, we can simply delegate that back to the blob. The missing `byte_size` is more problematic, since (I assume) we couldn't look that up during the request without downloading the whole file, defeating the purpose of streaming the content in the first place. The best way I can think to do this would be to add a `byte_size` column to `active_storage_variant_records`, the same way as for `active_storage_blobs`.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44848/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44848/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44846","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44846/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44846/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44846/events","html_url":"https://github.com/rails/rails/issues/44846","id":1193958136,"node_id":"I_kwDNIULORypa-A","number":44846,"title":"Ruby 3.2.0.dev keyword arguments behavior introduces CI failures","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-04-06T03:25:03Z","updated_at":"2022-04-06T07:10:42Z","closed_at":"2022-04-06T07:10:42Z","author_association":"MEMBER","active_lock_reason":null,"body":"Ruby 3.2.0.dev keyword arguments behavior change https://github.com/ruby/ruby/pull/5684/commits/0456826180a0c9c3a5b33542ad4b4fc250c2f13d introduces Rails CI failures.\r\n\r\nRefer to the first failing jobs at https://buildkite.com/rails/rails/builds/85798\r\n\r\n### Steps to reproduce\r\n\r\nLet me provide steps to reproduce for Active Model in this case. Also Action Mailbox, Action Mailer, Active Record are affected.\r\n\r\n1. Install Ruby 3.2.0.dev\r\n\r\n2. Run unit tests as follows\r\n```\r\ngit clone https://github.com/rails/rails\r\ncd rails\r\nrm Gemfile.lock # To install nokogiri \r\nbundle install\r\ncd activemodel\r\nbin/test test/cases/attribute_methods_test.rb -n test_accessing_a_suffixed_attribute\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\n```ruby\r\n$ bin/test test/cases/attribute_methods_test.rb -n test_accessing_a_suffixed_attribute\r\nRun options: -n test_accessing_a_suffixed_attribute --seed 8234\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nAttributeMethodsTest#test_accessing_a_suffixed_attribute:\r\nArgumentError: wrong number of arguments (given 2, expected 1)\r\n    /home/yahonda/src/github.com/rails/rails/activemodel/test/cases/attribute_methods_test.rb:40:in `attribute_kw'\r\n    /home/yahonda/src/github.com/rails/rails/activemodel/lib/active_model/attribute_methods.rb:472:in `attribute_missing'\r\n    /home/yahonda/src/github.com/rails/rails/activemodel/lib/active_model/attribute_methods.rb:462:in `method_missing'\r\n    /home/yahonda/src/github.com/rails/rails/activemodel/test/cases/attribute_methods_test.rb:224:in `block in <class:AttributeMethodsTest>'\r\n\r\n\r\nbin/test test/cases/attribute_methods_test.rb:218\r\n\r\n\r\n\r\nFinished in 0.005740s, 174.2054 runs/s, 174.2054 assertions/s.\r\n1 runs, 1 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n\r\n```\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:$ ruby -v\r\nruby 3.2.0dev (2022-04-05T09:42:02Z master 752c3dad98) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44846/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44842","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44842/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44842/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44842/events","html_url":"https://github.com/rails/rails/issues/44842","id":1192487096,"node_id":"I_kwDNIULORxPouA","number":44842,"title":"Enum conflict error message is misleading","user":{"login":"gabo-cs","id":87103727,"node_id":"MDQ6VXNlcjg3MTAzNzI3","avatar_url":"https://avatars.githubusercontent.com/u/87103727?v=4","gravatar_id":"","url":"https://api.github.com/users/gabo-cs","html_url":"https://github.com/gabo-cs","followers_url":"https://api.github.com/users/gabo-cs/followers","following_url":"https://api.github.com/users/gabo-cs/following{/other_user}","gists_url":"https://api.github.com/users/gabo-cs/gists{/gist_id}","starred_url":"https://api.github.com/users/gabo-cs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gabo-cs/subscriptions","organizations_url":"https://api.github.com/users/gabo-cs/orgs","repos_url":"https://api.github.com/users/gabo-cs/repos","events_url":"https://api.github.com/users/gabo-cs/events{/privacy}","received_events_url":"https://api.github.com/users/gabo-cs/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2022-04-05T01:14:42Z","updated_at":"2022-08-04T02:43:17Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"The ArgumentError message being raised when some enums conflicts occur is sometimes misleading. \r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nAdd the following to any model:\r\n```ruby\r\nenum foo: { active: 0, inactive: 1 }\r\nenum bar: { on: 0, off: 1, inactive: 2 }\r\n```\r\n\r\nor simply add a brand new enum with any value that already exists in a previos enum inside the same model. \r\n\r\n### Expected behavior\r\nThe error message should be:\r\n\r\n> You tried to define an enum named \"bar\" on the model \"User\", but this will generate **an** instance method \"inactive?\", which is already defined by another enum. (ArgumentError)\r\n\r\n+ Notice the \"an\" determiner, that should probably be fixed too, it's currently `a %{type}` but type can be `instance`, for instance (no pun intended).\r\n\r\n\r\n### Actual behavior\r\nThe error message is:\r\n\r\n> You tried to define an enum named \"foo\" on the model \"User\", but this will generate a instance method \"active?\", which is already defined by another enum. (ArgumentError)\r\n\r\nIt seems to be taking `enum_name`, and `method_name` as the first value of the first enum, instead of displaying the ones that are actually causing the issue, in the repro steps example, `foo` is defined first so the problem should be with `bar`, and `active` is clearly not the conflictive enum value.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 6.1.3.1\r\n\r\n**Ruby version**:\r\nRuby 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44842/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44842/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44839","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44839/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44839/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44839/events","html_url":"https://github.com/rails/rails/issues/44839","id":1191583670,"node_id":"I_kwDNIULORwYftg","number":44839,"title":"ActiveRecord#touch updates readonly object","user":{"login":"lmumar","id":7017,"node_id":"MDQ6VXNlcjcwMTc=","avatar_url":"https://avatars.githubusercontent.com/u/7017?v=4","gravatar_id":"","url":"https://api.github.com/users/lmumar","html_url":"https://github.com/lmumar","followers_url":"https://api.github.com/users/lmumar/followers","following_url":"https://api.github.com/users/lmumar/following{/other_user}","gists_url":"https://api.github.com/users/lmumar/gists{/gist_id}","starred_url":"https://api.github.com/users/lmumar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmumar/subscriptions","organizations_url":"https://api.github.com/users/lmumar/orgs","repos_url":"https://api.github.com/users/lmumar/repos","events_url":"https://api.github.com/users/lmumar/events{/privacy}","received_events_url":"https://api.github.com/users/lmumar/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-04-04T10:34:17Z","updated_at":"2022-04-05T15:33:24Z","closed_at":"2022-04-05T15:31:25Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.string :name, default: 'default'\r\n    t.timestamps\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.readonly!\r\n    # does not raise an error\r\n    assert_raises(ActiveRecord::ReadOnlyRecord) do\r\n      post.touch\r\n    end        \r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n`post.touch` should raise an error for consistency since the code below raises an error:\r\n```\r\npost.updated_at = Time.current\r\npost.save!\r\n```\r\n### Actual behavior\r\n`post.touch` proceeds to update the timestamp without giving any error\r\n\r\n### System configuration\r\n**Rails version**:\r\nrails 7\r\n**Ruby version**:\r\nruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [x86_64-darwin21]\r\n\r\nIf this is an expected behavior, I will close this issue, if not I already prepared a fix and will open a pull request if needed.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44839/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44839/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44837","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44837/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44837/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44837/events","html_url":"https://github.com/rails/rails/issues/44837","id":1191381741,"node_id":"I_kwDNIULORwMK7Q","number":44837,"title":"ActiveSupport::FileUpdateChecker dramatically slows down Rails 7 on WSL","user":{"login":"spazer5","id":662725,"node_id":"MDQ6VXNlcjY2MjcyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/662725?v=4","gravatar_id":"","url":"https://api.github.com/users/spazer5","html_url":"https://github.com/spazer5","followers_url":"https://api.github.com/users/spazer5/followers","following_url":"https://api.github.com/users/spazer5/following{/other_user}","gists_url":"https://api.github.com/users/spazer5/gists{/gist_id}","starred_url":"https://api.github.com/users/spazer5/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spazer5/subscriptions","organizations_url":"https://api.github.com/users/spazer5/orgs","repos_url":"https://api.github.com/users/spazer5/repos","events_url":"https://api.github.com/users/spazer5/events{/privacy}","received_events_url":"https://api.github.com/users/spazer5/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-04-04T07:36:20Z","updated_at":"2022-07-11T23:36:54Z","closed_at":"2022-07-11T23:36:54Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n- Install Ubuntu on WSL 2\r\n- Install Ruby 3.1.1 via RVM\r\n- Create a Rails 7 app with at least 100 classes (models or controllers, doesn't matter)\r\n- Run `rails server` and observe high response latency for very simple requests.\r\n\r\n### Your reproduction script goes here\r\n```\r\nclass PingController < ApplicationController\r\n  def index\r\n     render json: { ok: true }\r\n  end\r\nend\r\n```\r\n\r\n### Behavior\r\nBy default, this simple action will produce over 400ms latency, even much higher on apps with a large amount of classes (more specifically watched paths by the Rails File Reloader).\r\n\r\n### Cause\r\nI ran `rbspy` and i tracked down the cause of 90% of latency. Is is `ActiveSupport::FileUpdateChecker` and specifically this section but more likely the entire approach on WSL:\r\n\r\n```\r\nblock in max_mtime - /usr/share/rvm/gems/ruby-3.1.1/gems/activesupport-7.0.2.3/lib/active_support/file_update_checker.rb:137\r\nmtime [c function] - (unknown):0\r\n```\r\n\r\nAs soon as i disabled it by switching to: `config.file_watcher = ActiveSupport::EventedFileUpdateChecker` and adding `gem 'listen'` as [mentioned here](https://stackoverflow.com/a/60134982), The latency immediately dropped from ~400ms to ~20ms.\r\n\r\nHowever now the classes don't reload when i make changes.\r\n\r\nKeep in mind this was tested on a speedy machine with an SSD drive so file seeking shouldn't be an issue.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44837/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44837/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44835","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44835/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44835/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44835/events","html_url":"https://github.com/rails/rails/issues/44835","id":1191178662,"node_id":"I_kwDNIULORv_xpg","number":44835,"title":"EnumerableTests#test_doesnt_bust_constant_cache error since https://github.com/ruby/ruby/pull/5716","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-04-04T02:53:38Z","updated_at":"2022-04-05T08:38:52Z","closed_at":"2022-04-05T08:30:30Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n- Install Ruby 3.2.0dev\r\n\r\n```ruby\r\ncd activesupport\r\nbin/test test/core_ext/enumerable_test.rb -n test_doesnt_bust_constant_cache\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\nIt gets `ArgumentError: unknown key: global_constant_state` error.\r\n\r\n```ruby\r\n$ bin/test test/core_ext/enumerable_test.rb -n test_doesnt_bust_constant_cache\r\nRunning 27 tests in a single process (parallelization threshold is 50)\r\nRun options: -n test_doesnt_bust_constant_cache --seed 22647\r\n\r\n# Running:\r\n\r\nE\r\n\r\nError:\r\nEnumerableTests#test_doesnt_bust_constant_cache:\r\nArgumentError: unknown key: global_constant_state\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/test/core_ext/enumerable_test.rb:365:in `stat'\r\n    /home/yahonda/src/github.com/rails/rails/activesupport/test/core_ext/enumerable_test.rb:365:in `test_doesnt_bust_constant_cache'\r\n\r\n\r\nbin/test test/core_ext/enumerable_test.rb:364\r\n\r\n\r\n\r\nFinished in 0.000558s, 1792.8216 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:$ ruby -v\r\nruby 3.2.0dev (2022-04-01T18:48:22Z master 6068da8937) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44835/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44835/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44829","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44829/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44829/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44829/events","html_url":"https://github.com/rails/rails/issues/44829","id":1190607331,"node_id":"I_kwDNIULORvc54w","number":44829,"title":"uninitialized constant Rails::Command::Base (NameError)","user":{"login":"sunil-lulla","id":13536350,"node_id":"MDQ6VXNlcjEzNTM2MzUw","avatar_url":"https://avatars.githubusercontent.com/u/13536350?v=4","gravatar_id":"","url":"https://api.github.com/users/sunil-lulla","html_url":"https://github.com/sunil-lulla","followers_url":"https://api.github.com/users/sunil-lulla/followers","following_url":"https://api.github.com/users/sunil-lulla/following{/other_user}","gists_url":"https://api.github.com/users/sunil-lulla/gists{/gist_id}","starred_url":"https://api.github.com/users/sunil-lulla/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sunil-lulla/subscriptions","organizations_url":"https://api.github.com/users/sunil-lulla/orgs","repos_url":"https://api.github.com/users/sunil-lulla/repos","events_url":"https://api.github.com/users/sunil-lulla/events{/privacy}","received_events_url":"https://api.github.com/users/sunil-lulla/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-04-02T11:39:57Z","updated_at":"2022-04-05T22:41:33Z","closed_at":"2022-04-05T22:41:33Z","author_association":"NONE","active_lock_reason":null,"body":"Facing this issue while running `rails c`, have upgraded from version 4 to 6.0.3.6 Rails\r\n\r\nTraceback (most recent call last):\r\n\t4: from bin/rails:3:in `<main>'\r\n\t3: from bin/rails:3:in `require'\r\n\t2: from railsApp/vendor/bundle/ruby/2.6.0/gems/railties-6.0.3.6/lib/rails/commands/server/server_command.rb:11:in `<top (required)>'\r\n\t1: from railsApp/vendor/bundle/ruby/2.6.0/gems/railties-6.0.3.6/lib/rails/commands/server/server_command.rb:93:in `<module:Rails>'\r\nrailsApp/vendor/bundle/ruby/2.6.0/gems/railties-6.0.3.6/lib/rails/commands/server/server_command.rb:94:in `<module:Command>': uninitialized constant Rails::Command::Base (NameError)\r\n\r\n\r\n### System configuration\r\n**Rails version**: 6.0.3.6\r\n\r\n**Ruby version**: 2.6.6\r\n\r\nAny inputs on debugging this further.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44829/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44829/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44828","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44828/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44828/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44828/events","html_url":"https://github.com/rails/rails/issues/44828","id":1190565052,"node_id":"I_kwDNIULORvaUvA","number":44828,"title":"Missing association filter query in sql","user":{"login":"MeterSoft","id":2736506,"node_id":"MDQ6VXNlcjI3MzY1MDY=","avatar_url":"https://avatars.githubusercontent.com/u/2736506?v=4","gravatar_id":"","url":"https://api.github.com/users/MeterSoft","html_url":"https://github.com/MeterSoft","followers_url":"https://api.github.com/users/MeterSoft/followers","following_url":"https://api.github.com/users/MeterSoft/following{/other_user}","gists_url":"https://api.github.com/users/MeterSoft/gists{/gist_id}","starred_url":"https://api.github.com/users/MeterSoft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MeterSoft/subscriptions","organizations_url":"https://api.github.com/users/MeterSoft/orgs","repos_url":"https://api.github.com/users/MeterSoft/repos","events_url":"https://api.github.com/users/MeterSoft/events{/privacy}","received_events_url":"https://api.github.com/users/MeterSoft/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-04-02T08:54:18Z","updated_at":"2022-04-05T22:22:08Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nclass Account < ApplicationRecord\r\n  has_many :orders\r\nend\r\n\r\nclass Order < ApplicationRecord\r\n  belongs_to :account\r\n\r\n  def self.search(name: name)\r\n    Order.where(name: name)\r\n  end\r\nend\r\n  \r\naccount.orders.search(name: 'hello')\r\n```\r\n\r\n### Expected behavior\r\nRails 5.2 it generate sql with `WHERE \"orders\".\"account_id\" = $1`\r\n\r\n### Actual behavior\r\nRails 6.0.3 missing sql filter by account\r\n\r\n### System configuration\r\n**Rails version**: 6.0.3\r\n\r\n**Ruby version**: 2.7.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44828/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44823","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44823/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44823/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44823/events","html_url":"https://github.com/rails/rails/issues/44823","id":1189994853,"node_id":"I_kwDNIULORu3hZQ","number":44823,"title":"All Queries Default Scopes can lead to \"ignored\" updates","user":{"login":"pjambet","id":717637,"node_id":"MDQ6VXNlcjcxNzYzNw==","avatar_url":"https://avatars.githubusercontent.com/u/717637?v=4","gravatar_id":"","url":"https://api.github.com/users/pjambet","html_url":"https://github.com/pjambet","followers_url":"https://api.github.com/users/pjambet/followers","following_url":"https://api.github.com/users/pjambet/following{/other_user}","gists_url":"https://api.github.com/users/pjambet/gists{/gist_id}","starred_url":"https://api.github.com/users/pjambet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pjambet/subscriptions","organizations_url":"https://api.github.com/users/pjambet/orgs","repos_url":"https://api.github.com/users/pjambet/repos","events_url":"https://api.github.com/users/pjambet/events{/privacy}","received_events_url":"https://api.github.com/users/pjambet/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-04-01T15:59:17Z","updated_at":"2022-07-27T18:36:18Z","closed_at":"2022-07-27T18:36:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n    t.integer :sharding_key\r\n    t.timestamps(null: false)\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n\r\n  default_scope -> {\r\n    if Current.sharding_key.present?\r\n      where(sharding_key: Current.sharding_key)\r\n    end\r\n  }, all_queries: true\r\n\r\n  belongs_to :post\r\nend\r\n\r\nclass Current < ActiveSupport::CurrentAttributes\r\n  attribute :sharding_key\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = Post.create!\r\n    post.comments << Comment.create!(sharding_key: 1)\r\n    comment = post.comments.first\r\n    comment.reload\r\n    assert comment\r\n\r\n    Current.sharding_key = 2\r\n\r\n    # a few checks to confirm things work as expected\r\n    assert_equal 0, post.comments.count # 0 because the sharding key filter ignores the existing comment\r\n    assert_equal 0, Comment.count # ditto\r\n    assert_nil Comment.first # ditto\r\n    assert_raises { comment.reload } # raises an exception, makes sense, no records match the conditions\r\n\r\n    original_updated_at = comment.updated_at\r\n\r\n    comment.update!(updated_at: Time.current) # silently does nothing\r\n\r\n    # \"Lies\" to you, making it look like the record was updated, the in-memory value was changed on the instance but not in the DB\r\n    refute comment.updated_at == original_updated_at\r\n\r\n    # Check with the record from the DB, and fails, since nothing was updated\r\n    refute Comment.unscoped { comment.reload.updated_at } == original_updated_at\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nEither an exception when calling `.update!` if the actual query ends up updating nothing and/or the values of the attributes that were expected to be changed to not be changed on the instance.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nThe call to `update!` does not fail, the generated query looks like:\r\n\r\n```sql\r\nUPDATE \"comments\" SET \"updated_at\" = ? WHERE \"comments\".\"id\" = ? AND \"comments\".\"sharding_key\" = ?  [[\"updated_at\", \"2022-04-01 15:45:13.927742\"], [\"id\", 1], [\"sharding_key\", 2]]\r\n```\r\n\r\nWhich matches nothing. (Interestingly, using `.touch` calls a rollback, whereas `update` sends a `commit`, not sure why it's different: `begin transaction;  UPDATE ... ;  commit transaction` with `.update!` and `begin transaction; UPDATE ...;  rollback transaction` with `.touch`\r\n\r\n### System configuration\r\n**Rails version**: `7.1.0.alpha from https://github.com/rails/rails.git (at main@3b9be03)`\r\n\r\n**Ruby version**: `ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [arm64-darwin21]`\r\n\r\n\r\n#### Final note\r\n\r\nA related potential issue — which I'd be happy to create a separate ticket for if useful — is that `.unscoped` does not seem to work with updates, which feels unexpected, in the example above, I would have expected\r\n\r\n```ruby\r\nComment.unscoped do\r\n  comment.update!(updated_at: Time.current)\r\nend\r\n```\r\n\r\nto issue the following SQL query:\r\n\r\n```sql\r\nUPDATE \"comments\" SET \"updated_at\" = ? WHERE \"comments\".\"id\" = ?  [[\"updated_at\", \"2022-04-01 15:55:43.523284\"], [\"id\", 1]]\r\n```\r\n\r\nBut it seems like `unscoped` does _not_ change the behavior of `update`\r\n\r\n\r\ncc @eileencodes @kaiyannameighu ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44823/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44823/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44819","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44819/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44819/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44819/events","html_url":"https://github.com/rails/rails/issues/44819","id":1189521124,"node_id":"I_kwDNIULORuam5A","number":44819,"title":"`Record#dup` adds this additional new record to associations this record belongs to when `inverse_of` specified","user":{"login":"aglushkov","id":3481507,"node_id":"MDQ6VXNlcjM0ODE1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/3481507?v=4","gravatar_id":"","url":"https://api.github.com/users/aglushkov","html_url":"https://github.com/aglushkov","followers_url":"https://api.github.com/users/aglushkov/followers","following_url":"https://api.github.com/users/aglushkov/following{/other_user}","gists_url":"https://api.github.com/users/aglushkov/gists{/gist_id}","starred_url":"https://api.github.com/users/aglushkov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aglushkov/subscriptions","organizations_url":"https://api.github.com/users/aglushkov/orgs","repos_url":"https://api.github.com/users/aglushkov/repos","events_url":"https://api.github.com/users/aglushkov/events{/privacy}","received_events_url":"https://api.github.com/users/aglushkov/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-04-01T09:33:38Z","updated_at":"2022-08-02T09:12:55Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n`Record#dup` adds this additional new record to associations this record belongs to when `inverse_of` specified.\r\n\r\nSo when parent association is saved, it saves this duplicated record.\r\n\r\n- It does not saves new records  with `config.load_defaults 6.0`\r\n- It does not saves new records when `inverse_of` option not specified\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\n  gem \"debug\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"debug\"\r\n\r\nclass Application < Rails::Application\r\n  config.load_defaults 6.1 #------------ WORKS with 6.0 ------------\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\nRails.application.initialize!\r\n\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :categories, force: true do |t|\r\n    t.string :name, default: 'default'\r\n  end\r\n\r\n  create_table :topics, force: true do |t|\r\n    t.belongs_to :category, null: false\r\n  end\r\nend\r\n\r\nclass Category < ActiveRecord::Base\r\n  has_many :topics, inverse_of: :category # WORKS without inverse_of even with load_defaults 6.1\r\nend\r\n\r\nclass Topic < ActiveRecord::Base\r\n  belongs_to :category, inverse_of: :topics # WORKS without inverse_of even with load_defaults 6.1\r\nend\r\n\r\ncategory = Category.create!\r\ntopic = Topic.create!(category: category)\r\n\r\n# Add topic duplicate\r\ntopic_dup = topic.dup\r\ncategory_from_dup = topic.dup.category\r\n\r\n# We have extra topic with id = nil\r\nputs category_from_dup.topics.size\r\nputs category_from_dup.topics.inspect\r\n\r\n# Save category\r\ncategory_from_dup.update!(name: 'name')\r\n\r\n# It creates additional topic\r\nputs category_from_dup.reload.topics.size\r\nputs category_from_dup.topics.inspect\r\n\r\n```\r\n\r\n### Expected behavior\r\nNo additional records should be created. Same as it works with load_defaults 6.0. Or same as it works without `inverse_of` option\r\n\r\n### Actual behavior\r\nWe've got additional `record.dup` assigned to parent association\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.3\r\n\r\n**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44819/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44819/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44817","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44817/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44817/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44817/events","html_url":"https://github.com/rails/rails/issues/44817","id":1189018407,"node_id":"I_kwDNIULORt77Jw","number":44817,"title":"SQL query cache does not work when configured with multiple databases after code is loaded/reloaded in dev mode","user":{"login":"evanlok","id":146904,"node_id":"MDQ6VXNlcjE0NjkwNA==","avatar_url":"https://avatars.githubusercontent.com/u/146904?v=4","gravatar_id":"","url":"https://api.github.com/users/evanlok","html_url":"https://github.com/evanlok","followers_url":"https://api.github.com/users/evanlok/followers","following_url":"https://api.github.com/users/evanlok/following{/other_user}","gists_url":"https://api.github.com/users/evanlok/gists{/gist_id}","starred_url":"https://api.github.com/users/evanlok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/evanlok/subscriptions","organizations_url":"https://api.github.com/users/evanlok/orgs","repos_url":"https://api.github.com/users/evanlok/repos","events_url":"https://api.github.com/users/evanlok/events{/privacy}","received_events_url":"https://api.github.com/users/evanlok/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-03-31T23:57:48Z","updated_at":"2022-04-01T16:55:10Z","closed_at":"2022-04-01T16:55:10Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create an application that utilizes multiple database connections\r\n2. Define a controller action that triggers duplicate SQL queries\r\n3. Send a request to the controller action\r\n4. Notice that no queries are cached\r\n5. Modify source code\r\n6. Send a request to the controller action\r\n7. Notice that no queries are cached\r\n\r\n```ruby\r\n# Base model with multiple database connections\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  self.abstract_class = true\r\n\r\n  connects_to database: { writing: :primary, reading: :primary_replica }\r\nend\r\n\r\n# Model for testing\r\nclass Post < ApplicationRecord\r\nend\r\n\r\nclass PostsController < ApplicationController\r\n  def index\r\n    8.times { Post.first }\r\n\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nRails.application.routes.draw do\r\n  resources :posts\r\n\r\n  root to: 'posts#index'\r\nend\r\n```\r\n\r\nDatabase config with multiple databases\r\n```yml\r\ndefault: &default\r\n  adapter: sqlite3\r\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\r\n  timeout: 5000\r\n  database: blog\r\n\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n\r\n  primary_replica:\r\n    <<: *default\r\n```\r\n\r\n### Expected behavior\r\n\r\nSQL queries are cached on the first request to the action and after subsequent code reloads.\r\n\r\n### Actual behavior\r\n\r\nQuery caching is not utilized for the first request after server boot and any request that occurs after a code reload. Caching does work after those initial uncached requests.\r\n\r\nThis is because the query cache is enabled at the start of the request on the existing connection pool. However, the `connect_to` method in base model triggers `establish_connection` which recreates the connection pool with query caching disabled. Since code is lazy loaded in development mode, the call to `connect_to` occurs after the code that enables query caching. Query caching works as expected with a single database because the connection pool is stored on `ActiveRecord::Base` and is never recreated since it's not an autoloaded constant.\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 2.7.3\r\n\r\n### Workaround\r\n\r\nEnable query caching with middleware\r\n```rb\r\nclass QueryCacheFix\r\n  def initialize(app)\r\n    @app = app\r\n  end\r\n\r\n  def call(env)\r\n    ActiveRecord::Base.connection.enable_query_cache!\r\n    @app.call(env)\r\n  end\r\nend\r\n\r\nconfig.middleware.insert_after(ActionDispatch::Reloader, QueryCacheFix)\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44817/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44817/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44815","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44815/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44815/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44815/events","html_url":"https://github.com/rails/rails/issues/44815","id":1188811841,"node_id":"I_kwDNIULORtvUQQ","number":44815,"title":"db:prepare task fails to create/migrate test db when dev db already exists","user":{"login":"jasonkarns","id":119972,"node_id":"MDQ6VXNlcjExOTk3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/119972?v=4","gravatar_id":"","url":"https://api.github.com/users/jasonkarns","html_url":"https://github.com/jasonkarns","followers_url":"https://api.github.com/users/jasonkarns/followers","following_url":"https://api.github.com/users/jasonkarns/following{/other_user}","gists_url":"https://api.github.com/users/jasonkarns/gists{/gist_id}","starred_url":"https://api.github.com/users/jasonkarns/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasonkarns/subscriptions","organizations_url":"https://api.github.com/users/jasonkarns/orgs","repos_url":"https://api.github.com/users/jasonkarns/repos","events_url":"https://api.github.com/users/jasonkarns/events{/privacy}","received_events_url":"https://api.github.com/users/jasonkarns/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-31T21:26:48Z","updated_at":"2022-04-01T15:21:34Z","closed_at":"2022-04-01T15:21:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When a dev db already exists, the test db is not created or setup by `db:prepare` task nor the `bin/setup` script that runs it.\r\n\r\nWe have our dev db provided (with data) by a docker image. The test db is stood up by the app. However, due to this issue, `bin/setup` nor `db:prepare` will correctly create the test db because the dev db already exists.\r\n\r\nGiven that `db:setup` _does_ properly create the test db (even when dev db exists), it seems reasonable that `db:prepare` would be similarly idempotent and result in a stable dev&test setup.\r\n\r\n### Steps to reproduce\r\n\r\nIn a brand new rails app (`rails new testcase --api --database mysql`)\r\n\r\n1. prepare databases\r\n```sh\r\n$ bin/rails db:prepare\r\nCreated database 'testcase_development'\r\nCreated database 'testcase_test'\r\n```\r\n2. Drop the test db leaving development db only. \r\n```sh\r\n$ RAILS_ENV=test rake db:drop\r\nDropped database 'testcase_test'\r\n```\r\n3. Re-run db:prepare\r\n```sh\r\n$ bin/rails db:prepare\r\n```\r\n\r\n### Expected behavior\r\n\r\nI would expect the test db to be created/seeded/migrated.\r\nThe `db:prepare` task (and the `bin/setup` in which it is used) both document that the task should be idempotent and that it will set up dev and test databases.\r\nIf the dev db already exists, it should continue on to migrate or seed (as appropriate) and then do a full setup by creating and seeding a test database as well.\r\n\r\nExpected output:\r\n```sh\r\n$ bin/rails db:prepare\r\nDatabase 'testcase_development' already exists\r\nCreated database 'testcase_test'\r\n```\r\n\r\n(For the record, this _is_ the actual behavior for `db:setup`; if the dev db already exists, it moves on to create+seed the test db.)\r\n\r\n### Actual behavior\r\n\r\nNothing happens. The dev db is detected, and then the test db preparation is skipped entirely.\r\n\r\n### System configuration\r\n**Rails version**:\r\n```\r\n$ rails --version\r\nRails 7.0.2.3\r\n```\r\n**Ruby version**:\r\n```\r\n$ ruby --version\r\nruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-darwin21]\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44815/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44815/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44814","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44814/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44814/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44814/events","html_url":"https://github.com/rails/rails/issues/44814","id":1188797235,"node_id":"I_kwDNIULORtubMw","number":44814,"title":"Use `nil` in values for `in_order_of`","user":{"login":"Flixt","id":1724355,"node_id":"MDQ6VXNlcjE3MjQzNTU=","avatar_url":"https://avatars.githubusercontent.com/u/1724355?v=4","gravatar_id":"","url":"https://api.github.com/users/Flixt","html_url":"https://github.com/Flixt","followers_url":"https://api.github.com/users/Flixt/followers","following_url":"https://api.github.com/users/Flixt/following{/other_user}","gists_url":"https://api.github.com/users/Flixt/gists{/gist_id}","starred_url":"https://api.github.com/users/Flixt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Flixt/subscriptions","organizations_url":"https://api.github.com/users/Flixt/orgs","repos_url":"https://api.github.com/users/Flixt/repos","events_url":"https://api.github.com/users/Flixt/events{/privacy}","received_events_url":"https://api.github.com/users/Flixt/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-03-31T21:18:53Z","updated_at":"2022-07-20T15:28:21Z","closed_at":"2022-07-20T15:28:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nUsing `nil` in the array of values for the `MyModel.in_order_of` query method returns inconsistent (and probably wrong?) results across different databases.\r\n\r\nGiven the following example:\r\n\r\n```ruby\r\nBook.create!(name: \"a\")\r\nBook.create!(name: \"b\")\r\nBook.create!(name: \"c\")\r\nBook.create!(name: nil)\r\n\r\norder = [\"a\", nil, \"c\", \"b\"]\r\nassert_equal order, Book.in_order_of(:name, order).pluck(:name)\r\n```\r\n\r\n**PostgreSQL& SQLite3**\r\n```\r\n# Expected: [nil, \"a\", \"c\", \"b\"]\r\n# Actual: [\"a\", \"c\", \"b\"]\r\n```\r\n\r\n**MySQL**\r\n\r\n```ruby\r\nUnsupported argument type: String. Construct an Arel node instead\r\n```\r\n\r\nThe other test in the executable example below also raises an exception for MySQL:\r\n```ruby\r\nUnsupported argument type: NilClass. Construct an Arel node instead.\r\n```\r\n\r\nI found this originally coming from the Postgres world, as we had an exact fit for the use of `in_order_of` in our code base (built our case statement for ordering before Rails 7). But the tests went red after switching over to `in_order_of`. So I investigated it a bit.\r\n\r\nHere is what I found:\r\n\r\n```sql\r\nSELECT NULL = NULL -- > NULL\r\n```\r\n\r\nThis means that a `case` statement like\r\n\r\n```\r\n...\r\nORDER BY CASE my_column\r\nWHEN NULL THEN 0\r\nWHEN 'value' THEN 1\r\n...\r\n```\r\n\r\nactually never uses the `NULL` (NULL is not true) case. On our side we were able to work around it, by using `COALESCE` in the case part of the condition.\r\n\r\n```\r\n...\r\nORDER BY CASE COALESCE(my_column, 'NULL_VALUE')\r\nWHEN 'NULL_VALUE' THEN 0\r\nWHEN 'value' THEN 1\r\n...\r\n```\r\n\r\nI tried to come up with a patch that would introduce the use of COALESCE for the `ActiveRecord::ConnectionAdapters::AbstractAdapter` and wrote some tests but then fell over several other things:\r\n\r\n- Even if the use of `COALESCE` would work, rows matching `nil` will never be part of the result scope, because \r\n https://github.com/rails/rails/blob/75e6c0ac5f7c1043178e9c43059fba3c15a9da87/activerecord/lib/active_record/relation/query_methods.rb#L464-L464\r\n\r\nwill not return any records with the value being `nil`/`NULL` (same reason as above, NULL is not equal to NULL).\r\n\r\n- Building a generic version using `COALESCE` was not that easy because of a limitation from Postgres ([here](https://www.postgresql.org/docs/current/functions-conditional.html#FUNCTIONS-COALESCE-NVL-IFNULL)):\r\n> The arguments must all be convertible to a common data type, which will be the type of the result\r\n\r\n- So I had a look at what MySQL is doing with `NULL` values and found [this](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_field): \r\n> If all arguments to FIELD() are strings, all arguments are compared as strings. If all arguments are numbers, they are compared as numbers. Otherwise, the arguments are compared as double.\r\n> If str is NULL, the return value is 0 because NULL fails equality comparison with any value. FIELD() is the complement of ELT()\r\n\r\n\r\nHere is an executable example, that I used to run against SQLite, PostgreSQL and MySQL.\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\n\r\n  # gem \"pg\"\r\n  # gem \"mysql2\", \"~> 0.5\", github: \"brianmario/mysql2\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# Use for SQLite\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\n\r\n# Use for Postgresql\r\n# ActiveRecord::Base.establish_connection(\r\n#   adapter: 'postgresql',\r\n#   encoding: 'unicode',\r\n#   host: ENV.fetch(\"POSTGRES_HOST\", \"127.0.0.1\"),\r\n#   port: ENV.fetch(\"POSTGRES_PORT\", 5432),\r\n#   database: 'rails_dev'\r\n# )\r\n\r\n# Use for MySQL\r\n# ActiveRecord::Base.establish_connection(\r\n#   adapter: \"mysql2\",\r\n#   encoding: \"utf8\",\r\n#   host: ENV.fetch(\"POSTGRES_HOST\", \"127.0.0.1\"),\r\n#   port: ENV.fetch(\"POSTGRES_PORT\", 3306),\r\n#   username: \"root\",\r\n#   database: \"rails_dev\"\r\n# )\r\n\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :books, force: true do |t|\r\n    t.string :name\r\n    t.integer :last_read\r\n  end\r\nend\r\n\r\nclass Book < ActiveRecord::Base\r\n  enum last_read: { unread: 0, reading: 2, read: 3, forgotten: nil }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_in_order_of_with_nil_values\r\n    Book.destroy_all\r\n    Book.create!(name: \"a\")\r\n    Book.create!(name: \"b\")\r\n    Book.create!(name: \"c\")\r\n    Book.create!(name: nil)\r\n\r\n    order = [\"a\", nil, \"c\", \"b\"]\r\n    assert_equal order, Book.in_order_of(:name, order).pluck(:name)\r\n  end\r\n\r\n  def test_in_order_of_with_nil_values_for_enum\r\n    Book.destroy_all\r\n    Book.create!(last_read: :unread)\r\n    Book.create!(last_read: :reading)\r\n    Book.create!(last_read: :read)\r\n    Book.create!(last_read: :forgotten) # mapped enum value is nil\r\n\r\n    order = [Book.last_reads[:forgotten], Book.last_reads[:reading], Book.last_reads[:unread], Book.last_reads[:read]]\r\n    books = Book.in_order_of(:last_read, order)\r\n\r\n    assert_equal(order, books.map { |book| Book.last_reads[book.last_read] })\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nThe whole thing puzzled me so hard, I barely know what I would have expected `in_order_of` to return 😄 but here is my try:\r\n\r\n- I'd expect the same AR API call with different databases to return the same result, and not some returning one and some raising an error.\r\n-  I'd expect ActiveRecord to order records correctly were I wrote `nil` in the array of values I want to order by\r\n\r\n### Actual behavior\r\n- When using Postgres/SQLite `nil` values are ignored.\r\n- When using MySQL and error is raised.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0, 7.0.2, 75e6c0ac5f7c1043178e9c43059fba3c15a9da87\r\n\r\n**Ruby version**:\r\n2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44814/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44814/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44813","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44813/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44813/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44813/events","html_url":"https://github.com/rails/rails/issues/44813","id":1188789621,"node_id":"I_kwDNIULORtt9dQ","number":44813,"title":"Rewrite delegate methods in ActionController::Parameters","user":{"login":"tenderlove","id":3124,"node_id":"MDQ6VXNlcjMxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/3124?v=4","gravatar_id":"","url":"https://api.github.com/users/tenderlove","html_url":"https://github.com/tenderlove","followers_url":"https://api.github.com/users/tenderlove/followers","following_url":"https://api.github.com/users/tenderlove/following{/other_user}","gists_url":"https://api.github.com/users/tenderlove/gists{/gist_id}","starred_url":"https://api.github.com/users/tenderlove/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tenderlove/subscriptions","organizations_url":"https://api.github.com/users/tenderlove/orgs","repos_url":"https://api.github.com/users/tenderlove/repos","events_url":"https://api.github.com/users/tenderlove/events{/privacy}","received_events_url":"https://api.github.com/users/tenderlove/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-03-31T21:14:35Z","updated_at":"2022-05-10T19:46:23Z","closed_at":"2022-05-10T19:46:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"We need to rewrite [the delegate methods on `ActionController::Parameters`](https://github.com/rails/rails/pull/44812) so that they no longer directly delegate to the underlying hash object.\r\n\r\n## Problem\r\n\r\nCurrently `AC::Parameters` [delegates some methods to the underlying object](https://github.com/rails/rails/pull/44812), and this causes the AC::Params to behave in inconsistent ways.  For example:\r\n\r\n```ruby\r\nrequire \"active_support/all\"\r\nrequire \"action_controller/metal/strong_parameters\"\r\n\r\nhash = { \"foo\" => { \"bar\" => :baz } }\r\nparams = ActionController::Parameters.new(hash)\r\np params.values\r\np params.each_value.to_a\r\n```\r\n\r\nThe `values` method should probably be equivalent to `each_value.to_a`, but the output of this script shows that they are clearly different:\r\n\r\n```\r\n$ bundle exec ruby -I activesupport/lib/:actionpack/lib thing.rb\r\n[{\"bar\"=>:baz}]\r\n[#<ActionController::Parameters {\"bar\"=>:baz} permitted: false>]\r\n```\r\n\r\n## Help Wanted (One possible solution)\r\n\r\nWe should re-implement each of these delegate methods so that the behavior of AC::Params is consistent.  If `each_value` does a conversion on objects, then `values` should do the same conversion.\r\n\r\nAs of #23733 and https://github.com/rails/rails/pull/44812, we are not supposed to be directly comparing hashes with AC::Params objects, so we should consider what to do with code like this:\r\n\r\n```ruby\r\nrequire \"active_support/all\"\r\nrequire \"action_controller/metal/strong_parameters\"\r\n\r\nhash = { \"foo\" => { \"bar\" => :baz } }\r\nparams = ActionController::Parameters.new(hash)\r\np hash.has_value?({ \"bar\" => :baz })             # true\r\np params.has_value?({ \"bar\" => :baz })           # true\r\n```\r\n\r\nShould we continue to support it, or?\r\n\r\nAnyway, we should start with rewriting `values` as it's clearly a bug, then maybe separate PRs / discussion about the other methods.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44813/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44813/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44810","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44810/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44810/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44810/events","html_url":"https://github.com/rails/rails/issues/44810","id":1188180904,"node_id":"I_kwDNIULORtIzqA","number":44810,"title":"Feature request: Encryption for Active Storage files","user":{"login":"john-999","id":3640027,"node_id":"MDQ6VXNlcjM2NDAwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/3640027?v=4","gravatar_id":"","url":"https://api.github.com/users/john-999","html_url":"https://github.com/john-999","followers_url":"https://api.github.com/users/john-999/followers","following_url":"https://api.github.com/users/john-999/following{/other_user}","gists_url":"https://api.github.com/users/john-999/gists{/gist_id}","starred_url":"https://api.github.com/users/john-999/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/john-999/subscriptions","organizations_url":"https://api.github.com/users/john-999/orgs","repos_url":"https://api.github.com/users/john-999/repos","events_url":"https://api.github.com/users/john-999/events{/privacy}","received_events_url":"https://api.github.com/users/john-999/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-31T14:31:42Z","updated_at":"2022-03-31T14:46:39Z","closed_at":"2022-03-31T14:46:38Z","author_association":"NONE","active_lock_reason":null,"body":"[Active Record Encryption](https://guides.rubyonrails.org/active_record_encryption.html) does a great job at helping defend _Personally identifiable information_ (PII) and _confidential data_ that is stored **encrypted in the database** against server intrusions.\r\n\r\nHowever, any files \"attached\" via [Active Storage](https://edgeguides.rubyonrails.org/active_storage_overview.html) are stored **unencrypted in the file system**, and thus remain open to attackers. Thus, it would be great to have these files encrypted as well, via a new Active Storage option `encrypted: true`, like:\r\n\r\n```\r\nclass User < ApplicationRecord\r\n  has_many_attached :financial_statements, encrypted: true\r\n  has_many_attached :confidential_inventions, encrypted: true\r\n  has_many_attached :sensitive_pictures, encrypted: true\r\nend\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44810/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44810/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44809","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44809/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44809/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44809/events","html_url":"https://github.com/rails/rails/issues/44809","id":1187806804,"node_id":"I_kwDNIULORsx-VA","number":44809,"title":"Rails 7: Can not call `javascript_importmap_tags` from console","user":{"login":"n00bvn","id":6227607,"node_id":"MDQ6VXNlcjYyMjc2MDc=","avatar_url":"https://avatars.githubusercontent.com/u/6227607?v=4","gravatar_id":"","url":"https://api.github.com/users/n00bvn","html_url":"https://github.com/n00bvn","followers_url":"https://api.github.com/users/n00bvn/followers","following_url":"https://api.github.com/users/n00bvn/following{/other_user}","gists_url":"https://api.github.com/users/n00bvn/gists{/gist_id}","starred_url":"https://api.github.com/users/n00bvn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/n00bvn/subscriptions","organizations_url":"https://api.github.com/users/n00bvn/orgs","repos_url":"https://api.github.com/users/n00bvn/repos","events_url":"https://api.github.com/users/n00bvn/events{/privacy}","received_events_url":"https://api.github.com/users/n00bvn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-31T09:44:15Z","updated_at":"2022-07-15T00:31:27Z","closed_at":"2022-07-15T00:31:27Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nGo to `bin/rails console` and try `helper.javascript_importmap_tags`\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nIt should show script tag for importmap, so we don't need to view the source code the see all the mappings.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nIt raised exception `actionpack-7.0.2.3/lib/action_controller/metal/content_security_policy.rb:14:in 'content_security_policy_nonce': undefined method 'content_security_policy_nonce' for nil:NilClass (NoMethodError)`\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.0.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44809/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44809/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44808","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44808/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44808/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44808/events","html_url":"https://github.com/rails/rails/issues/44808","id":1187459608,"node_id":"I_kwDNIULORscyGA","number":44808,"title":"MessageVerifier's expires_in and expires_at options can yield different expiries","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-03-31T03:55:27Z","updated_at":"2022-07-08T10:43:07Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n`ActiveSupport::MessageVerifier#generate` has two similar options: `expires_in` and `expires_at`. But they can yield different expiries when passing `expires_in: 1.month` or `expires_at: 1.month.from_now`.\r\n\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  gem \"activesupport\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext\"\r\nrequire \"active_support/testing/time_helpers\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include ActiveSupport::Testing::TimeHelpers\r\n\r\n  def setup\r\n    @verifier = ActiveSupport::MessageVerifier.new(\"secret\")\r\n    @edge_case_time = Time.parse(\"2022-03-30T23:59:59Z\")\r\n  end\r\n\r\n  def test_expires_in\r\n    message = travel_to(@edge_case_time) do\r\n      # Internally, it creates ActiveSupport::Messages::Metadata with\r\n      # @expire_at 2022-04-30T23:59:59.000Z\r\n      @verifier.generate(\"whatever\", expires_in: 1.month)\r\n    end\r\n\r\n    travel_to(@edge_case_time + 1.month - 1.second) do\r\n      assert_raises ActiveSupport::MessageVerifier::InvalidSignature do\r\n        @verifier.verify(message)\r\n      end\r\n    end\r\n  end\r\n\r\n  def test_expires_at\r\n    message = travel_to(@edge_case_time) do\r\n      # Internally, it creates ActiveSupport::Messages::Metadata with\r\n      # @expire_at 2022-04-29T23:59:59.000Z\r\n      @verifier.generate(\"whatever\", expires_at: 1.month.from_now)\r\n    end\r\n\r\n    travel_to(@edge_case_time + 1.month - 1.second) do\r\n      assert_raises ActiveSupport::MessageVerifier::InvalidSignature do\r\n        @verifier.verify(message)\r\n      end\r\n    end\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nBoth `expires_in: 1.month` and `expires_at: 1.month.from_now` yield the same expiry.\r\n\r\n### Actual behavior\r\n\r\nWhen the time is 2022-03-30T23:59:59Z, expiries are \r\n\r\n- `expires_in`: 2022-04-30T23:59:59.000Z\r\n- `expires_at`: 2022-04-29T23:59:59.000Z\r\n\r\nI believe this commit https://github.com/rails/rails/commit/9fbfb4bffe72320cc895e2f4eb4e30e108d58bb2 introduced this behavior.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44808/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44808/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44806","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44806/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44806/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44806/events","html_url":"https://github.com/rails/rails/issues/44806","id":1187020906,"node_id":"I_kwDNIULORsCAag","number":44806,"title":"Through associations ignore the joins option of the through association if merge is used","user":{"login":"jguecaimburu","id":56755880,"node_id":"MDQ6VXNlcjU2NzU1ODgw","avatar_url":"https://avatars.githubusercontent.com/u/56755880?v=4","gravatar_id":"","url":"https://api.github.com/users/jguecaimburu","html_url":"https://github.com/jguecaimburu","followers_url":"https://api.github.com/users/jguecaimburu/followers","following_url":"https://api.github.com/users/jguecaimburu/following{/other_user}","gists_url":"https://api.github.com/users/jguecaimburu/gists{/gist_id}","starred_url":"https://api.github.com/users/jguecaimburu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jguecaimburu/subscriptions","organizations_url":"https://api.github.com/users/jguecaimburu/orgs","repos_url":"https://api.github.com/users/jguecaimburu/repos","events_url":"https://api.github.com/users/jguecaimburu/events{/privacy}","received_events_url":"https://api.github.com/users/jguecaimburu/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-30T21:38:12Z","updated_at":"2022-08-22T22:09:13Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The example provided fails in a `has_many ... through: ...` association but `has_one ... through: ...` associations have the same behaviour.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true\r\n\r\n  create_table :users, force: true\r\n\r\n  create_table :sources, force: true do |t|\r\n    t.boolean :online, null: false, default: true\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.references :post\r\n    t.references :user\r\n    t.references :source\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\n  has_many :online_comments, ->{ joins(:source).merge(Source.where(online: true)) }, class_name: \"Comment\"\r\n  has_many :online_users, through: :online_comments, source: :user\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\nend\r\n\r\nclass Source < ActiveRecord::Base\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :source\r\n  belongs_to :post\r\n  belongs_to :user\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association\r\n    Comment.create!(post: Post.create!, source: Source.create!(online: true), user: User.create!)\r\n    post = Post.first!\r\n    assert_equal post.online_comments, [Comment.first!]\r\n    assert_equal post.online_users, [User.first!] # Fails with `ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: sources.online: SELECT \"users\".* FROM \"users\" INNER JOIN \"comments\" ON \"users\".\"id\" = \"comments\".\"user_id\" WHERE \"comments\".\"post_id\" = ? AND \"sources\".\"online\" = ?`\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nWhen using the `has_many :online_users` association on `Post` in the example above, the `joins(:source)` from the `online_comments` association is expected to be part of the query.\r\n\r\n### Actual behavior\r\n\r\nThe `joins(:source)` option gets removed from the final query causing it to fail.\r\nIf `:online_comments` is changed to `has_many :online_comments, ->{ joins(:source).where(sources: {online: true}) }, class_name: \"Comment\"`, the test pass. That was reported and and fixed in https://github.com/rails/rails/pull/39390.\r\nA similar issue was fixed in https://github.com/rails/rails/pull/41029.\r\n\r\n### System configuration\r\n\r\nTested on:\r\n6.1.3.1, ruby 2.6.6\r\nmain branch, ruby 2.7.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44806/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44806/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44804","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44804/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44804/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44804/events","html_url":"https://github.com/rails/rails/issues/44804","id":1186529070,"node_id":"I_kwDNIULORrj_Lg","number":44804,"title":"Easy XSS with Array#join and html_safe ActiveSupport::SafeBuffer","user":{"login":"mildred","id":33804,"node_id":"MDQ6VXNlcjMzODA0","avatar_url":"https://avatars.githubusercontent.com/u/33804?v=4","gravatar_id":"","url":"https://api.github.com/users/mildred","html_url":"https://github.com/mildred","followers_url":"https://api.github.com/users/mildred/followers","following_url":"https://api.github.com/users/mildred/following{/other_user}","gists_url":"https://api.github.com/users/mildred/gists{/gist_id}","starred_url":"https://api.github.com/users/mildred/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mildred/subscriptions","organizations_url":"https://api.github.com/users/mildred/orgs","repos_url":"https://api.github.com/users/mildred/repos","events_url":"https://api.github.com/users/mildred/events{/privacy}","received_events_url":"https://api.github.com/users/mildred/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-30T14:15:17Z","updated_at":"2022-03-30T19:03:28Z","closed_at":"2022-03-30T19:03:05Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nIt is too easy to introduce XSS security issues when using `Array#join` to concatenate both unsafe `String` and safe `ActiveSupport::SafeBuffer`. Today I found a bug in a library that I was using, the code looked like this:\r\n\r\n```ruby\r\n    def pre_render\r\n      [content_tag(:i, '', html_options), label].compact.join(' ').html_safe\r\n    end\r\n```\r\n\r\nHere, the problem is that `content_tag(:i, '', html_options)` is a safe string while `label` is unsafe. using `Array#join` instead of `+` and `<<` operators is removing the benefit of using html_safe as all strings are joined together in an unsafe manner\r\n\r\nThe correct way to write the above code would have been:\r\n\r\n```ruby\r\n    def pre_render\r\n      (content_tag(:i, '', html_options) + ' ' + label).html_safe\r\n    end\r\n```\r\n\r\nWhere the last `.html_safe` is actually optional.\r\n\r\nA suggestion would be to change the `Array#join` method to account for html_safe strings. The following code does the trick:\r\n\r\n```ruby\r\nmodule SecurityArray\r\n  def join(separator = \"\")\r\n    if any? { |i| i.class == ActiveSupport::SafeBuffer }\r\n      reduce(nil) { |buf, x| (buf ? (buf << separator) : \"\".html_safe) << x }\r\n    else\r\n      super(separator)\r\n    end\r\n  end\r\nend\r\n\r\nArray.class_eval do\r\n  prepend SecurityArray\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n```\r\n :002 > [\"<img alt=safe>\".html_safe, \"<img/src/onerror=foo()>\"].join(\" \")\r\n => \"<img alt=safe> &lt;img/src/onerror=foo()&gt;\" \r\n```\r\n\r\n### Actual behavior\r\n\r\n```\r\n :002 > [\"<img alt=safe>\".html_safe, \"<img/src/onerror=foo()>\"].join(\" \")\r\n => \"<img alt=safe> <img/src/onerror=foo()>\" \r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.7\r\n\r\n**Ruby version**:  3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44804/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44804/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44802","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44802/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44802/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44802/events","html_url":"https://github.com/rails/rails/issues/44802","id":1185781684,"node_id":"I_kwDNIULORq2XtA","number":44802,"title":"Hash.deep_merge should use deep_dup?","user":{"login":"perryn","id":40276,"node_id":"MDQ6VXNlcjQwMjc2","avatar_url":"https://avatars.githubusercontent.com/u/40276?v=4","gravatar_id":"","url":"https://api.github.com/users/perryn","html_url":"https://github.com/perryn","followers_url":"https://api.github.com/users/perryn/followers","following_url":"https://api.github.com/users/perryn/following{/other_user}","gists_url":"https://api.github.com/users/perryn/gists{/gist_id}","starred_url":"https://api.github.com/users/perryn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/perryn/subscriptions","organizations_url":"https://api.github.com/users/perryn/orgs","repos_url":"https://api.github.com/users/perryn/repos","events_url":"https://api.github.com/users/perryn/events{/privacy}","received_events_url":"https://api.github.com/users/perryn/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-30T02:35:53Z","updated_at":"2022-07-05T09:44:52Z","closed_at":"2022-07-05T09:44:52Z","author_association":"NONE","active_lock_reason":null,"body":"Just tracked down a very confusing bug to what I humbly submit is 'surprising' behaviour of `Hash.deep_merge`.\r\n\r\nThe surprising aspects are \r\n      1) under some circumstances changes to the returned hash will mutate the original hash \r\n      2) It provides a mechanism to silently mutate a frozen constant hash\r\n\r\nPerhaps the implementation should use `deep_dup` rather than `dup`?\r\n\r\n### Steps to reproduce\r\n```ruby\r\nDEFAULTS = { \r\n    \"section_one\" => { \"foo\" => false, \"bar\" => false},\r\n    \"section_two\" => { \"foo\" => false, \"bar\" => false},\r\n}.freeze\r\noveridden = DEFAULTS.deep_merge({\"section_one\" => { \"foo\" => true}})\r\noveridden[\"section_one\"][\"bar\"] = true\r\noveridden[\"section_two\"][\"bar\"] = true\r\nDEFAULTS\r\n```\r\n\r\n### Expected behavior\r\nDEFAULTS should be unchanged\r\n`{\"section_one\"=>{\"foo\"=>false, \"bar\"=>false}, \"section_two\"=>{\"foo\"=>false, \"bar\"=>false}}`\r\n\r\n\r\n### Actual behavior\r\nOne of the bar keys in DEFAULTS has been mutated (but only one)\r\n`{\"section_one\"=>{\"foo\"=>false, \"bar\"=>false}, \"section_two\"=>{\"foo\"=>false, \"bar\"=>true}}`\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4.6 \r\n**Ruby version**:\r\nruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [arm64-darwin20]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44802/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44802/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44801","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44801/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44801/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44801/events","html_url":"https://github.com/rails/rails/issues/44801","id":1185732079,"node_id":"I_kwDNIULORqzV7w","number":44801,"title":"Update module comment for ActiveRecord::Tasks::DatabaseTasks","user":{"login":"pedz","id":76111,"node_id":"MDQ6VXNlcjc2MTEx","avatar_url":"https://avatars.githubusercontent.com/u/76111?v=4","gravatar_id":"","url":"https://api.github.com/users/pedz","html_url":"https://github.com/pedz","followers_url":"https://api.github.com/users/pedz/followers","following_url":"https://api.github.com/users/pedz/following{/other_user}","gists_url":"https://api.github.com/users/pedz/gists{/gist_id}","starred_url":"https://api.github.com/users/pedz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pedz/subscriptions","organizations_url":"https://api.github.com/users/pedz/orgs","repos_url":"https://api.github.com/users/pedz/repos","events_url":"https://api.github.com/users/pedz/events{/privacy}","received_events_url":"https://api.github.com/users/pedz/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-30T02:02:49Z","updated_at":"2022-09-05T23:32:22Z","closed_at":"2022-09-05T23:32:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I could not get [this suggested line of code](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/tasks/database_tasks.rb#L37) to work.\r\n\r\n### Steps to reproduce\r\nRakefile\r\n```rake\r\nrequire 'active_record'\r\ninclude ActiveRecord::Tasks\r\n\r\nDatabaseTasks.database_configuration = YAML.load_file('db/config.yml')\r\nDatabaseTasks.db_dir = 'db'\r\nDatabaseTasks.env = 'production'\r\n\r\nDatabaseTasks.create_current('production')\r\n```\r\n\r\ndb/config.yml\r\n```yaml\r\n# SQLite. Versions 3.8.0 and up are supported.\r\n#   gem install sqlite3\r\n#\r\n#   Ensure the SQLite 3 gem is defined in your Gemfile\r\n#   gem \"sqlite3\"\r\n#\r\ndefault: &default\r\n  adapter: sqlite3\r\n  pool: <%= ENV.fetch(\"RAILS_MAX_THREADS\") { 5 } %>\r\n  timeout: 5000\r\n\r\ndevelopment:\r\n  <<: *default\r\n  database: db/development.sqlite3\r\n\r\n# Warning: The database defined as \"test\" will be erased and\r\n# re-generated from your development database when you run \"rake\".\r\n# Do not set this db to the same as development or production.\r\ntest:\r\n  <<: *default\r\n  database: db/test.sqlite3\r\n\r\nproduction:\r\n  <<: *default\r\n  database: db/production.sqlite3\r\n```\r\n\r\nGemfile\r\n```ruby\r\nsource 'https://rubygems.org'\r\n\r\ngem 'activerecord'\r\ngem 'rake'\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n`bundler exec rake --tasks` should list out the tasks\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n```\r\nrake aborted!\r\nPsych::BadAlias: Unknown alias: default\r\n/Users/pedz/Source/find-duplicates/Rakefile:5:in `<top (required)>'\r\n/Users/pedz/.config/rbenv/versions/3.1.1/bin/bundler:25:in `load'\r\n/Users/pedz/.config/rbenv/versions/3.1.1/bin/bundler:25:in `<main>'\r\n```\r\n\r\nIf `aliases: true` is added to the `YAML.load_file` call, then the error is:\r\n\r\n```\r\nrake aborted!\r\nActiveRecord::AdapterNotSpecified: The `production` database is not configured for the `default_env` environment.\r\n\r\n  Available database configurations are:\r\n\r\n  \r\n/Users/pedz/Source/find-duplicates/Rakefile:10:in `<top (required)>'\r\n/Users/pedz/.config/rbenv/versions/3.1.1/bin/bundler:25:in `load'\r\n/Users/pedz/.config/rbenv/versions/3.1.1/bin/bundler:25:in `<main>'\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\nactiverecord (7.0.2.3)\r\n**Ruby version**:\r\nruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-freebsd12.2]\r\n\r\nNot related to Rails but currently `standalone-migrations` has an issue since `schema_file` was removed.\r\n\r\nThe best solution to using ActiveRecord in a stand alone application is this [answer](https://stackoverflow.com/a/26046277/341980) in StackOverflow.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44801/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44801/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44800","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44800/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44800/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44800/events","html_url":"https://github.com/rails/rails/issues/44800","id":1185701394,"node_id":"I_kwDNIULORqxeEg","number":44800,"title":"Too much magic in `Rails.logger` and logging to `STDERR` causes duplicate output.","user":{"login":"ioquatix","id":30030,"node_id":"MDQ6VXNlcjMwMDMw","avatar_url":"https://avatars.githubusercontent.com/u/30030?v=4","gravatar_id":"","url":"https://api.github.com/users/ioquatix","html_url":"https://github.com/ioquatix","followers_url":"https://api.github.com/users/ioquatix/followers","following_url":"https://api.github.com/users/ioquatix/following{/other_user}","gists_url":"https://api.github.com/users/ioquatix/gists{/gist_id}","starred_url":"https://api.github.com/users/ioquatix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ioquatix/subscriptions","organizations_url":"https://api.github.com/users/ioquatix/orgs","repos_url":"https://api.github.com/users/ioquatix/repos","events_url":"https://api.github.com/users/ioquatix/events{/privacy}","received_events_url":"https://api.github.com/users/ioquatix/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":149514554,"node_id":"MDU6TGFiZWwxNDk1MTQ1NTQ=","url":"https://api.github.com/repos/rails/rails/labels/pinned","name":"pinned","color":"f7c6c7","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-03-30T01:35:55Z","updated_at":"2022-06-28T22:55:35Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With the following code in a Rails configuration file:\r\n\r\n```ruby\r\nRails.logger = Logger.new(STDERR)\r\n```\r\n\r\nCauses duplicate log statements when running the app with `rails s`. It's caused by the following:\r\n\r\nhttps://github.com/rails/rails/blob/346ae79d5a11152f508df8d5506f8a0682ddb74b/railties/lib/rails/commands/server/server_command.rb#L75-L85\r\n\r\nThe implementation of `logger_outputs_to?` uses private details of the logger instance to determine whether it's logging to `STDOUT`. In this specific case, adding `STDERR` as part of the check might also work. However, not all logger objects have the same private details causing this check to fail in those cases too.\r\n\r\nhttps://github.com/rails/rails/blob/346ae79d5a11152f508df8d5506f8a0682ddb74b/activesupport/lib/active_support/logger.rb#L16-L20\r\n\r\nI don't think we should be inspecting private object details and I believe that the implementation creates too many edge cases which are better handled by explicit configuration.\r\n\r\nMy advice would be:\r\n\r\n- Default to `Rails.logger = Logger.new(STDERR)` (& don't log to log files).\r\n- Don't use `instance_variable_get` and consider removing `logger_outputs_to?`.\r\n- Remove monkey patching (and private implementation introspection) of `Rails.logger`.\r\n- Educate users on how to get previous behaviour if it's desired.\r\n\r\nIf we want to support output to multiple targets, this should be a feature of the log library not the interface for logging. I suggest some kind of tee logger should be appropriate, but I think it's better if we keep this simple in Rails and let `logger` gem solve this problem. ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44800/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44800/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44799","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44799/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44799/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44799/events","html_url":"https://github.com/rails/rails/issues/44799","id":1185614114,"node_id":"I_kwDNIULORqsJIg","number":44799,"title":"Rails 6.1.5 ignores net-smtp LoadError","user":{"login":"JunichiIto","id":1148320,"node_id":"MDQ6VXNlcjExNDgzMjA=","avatar_url":"https://avatars.githubusercontent.com/u/1148320?v=4","gravatar_id":"","url":"https://api.github.com/users/JunichiIto","html_url":"https://github.com/JunichiIto","followers_url":"https://api.github.com/users/JunichiIto/followers","following_url":"https://api.github.com/users/JunichiIto/following{/other_user}","gists_url":"https://api.github.com/users/JunichiIto/gists{/gist_id}","starred_url":"https://api.github.com/users/JunichiIto/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JunichiIto/subscriptions","organizations_url":"https://api.github.com/users/JunichiIto/orgs","repos_url":"https://api.github.com/users/JunichiIto/repos","events_url":"https://api.github.com/users/JunichiIto/events{/privacy}","received_events_url":"https://api.github.com/users/JunichiIto/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-29T23:50:09Z","updated_at":"2022-03-30T00:08:15Z","closed_at":"2022-03-30T00:08:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n```\r\ngit clone git@github.com:JunichiIto/rails-6-1-mailer-sandbox.git\r\ncd rails-6-1-mailer-sandbox\r\nbin/setup\r\nbin/rails test:system\r\n```\r\n\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nFails to start server because of net-smtp LoadError\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nServer can start up, then test fails with the error below:\r\n\r\n```\r\n2022-03-30 08:36:43 +0900 Rack app (\"GET /\" - (127.0.0.1)): #<NameError: uninitialized constant Mail::TestMailer\r\n\r\n      delegate :deliveries, :deliveries=, to: Mail::TestMailer\r\n                                                  ^^^^^^^^^^^^>\r\nE\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n- 6.1.5\r\n\r\n**Ruby version**:\r\n\r\n- 3.1.1\r\n\r\n### My investigation\r\n\r\nThe changes below were introduced since Rails 6.1.5:\r\n\r\n- https://github.com/rails/rails/commit/13cdd7a6aef86b23c3410adff1d4f6eeefc72c67\r\n- https://github.com/rails/rails/commit/13cdd7a6aef86b23c3410adff1d4f6eeefc72c67\r\n\r\nHowever, the regexp should be `/net\\/stmp/` because `error.message` is \"cannot load such file -- net/smtp\":\r\n\r\n<img width=\"661\" alt=\"Screen Shot 2022-03-30 at 8 04 32\" src=\"https://user-images.githubusercontent.com/1148320/160723650-15782a6c-6ac1-43a3-8546-70e2b578d3e3.png\">\r\n\r\nSince net-smtp LoadError is ignored and mail gem is not loaded, the error \"NameError: uninitialized constant Mail::TestMailer\" is raised.\r\n\r\nWhen I changed the regexp in my local box, the test fails like this:\r\n\r\n```\r\nYou don't have net-smtp installed in your application. Please add it to your Gemfile and run bundle install\r\n2022-03-30 08:47:59 +0900 Rack app (\"GET /\" - (127.0.0.1)): #<LoadError: cannot load such file -- net/smtp>\r\nE\r\n\r\nError:\r\nHomesTest#test_visiting_the_index:\r\nLoadError: cannot load such file -- net/smtp\r\n    app/mailers/application_mailer.rb:1:in `<main>'\r\n    app/mailers/user_mailer.rb:1:in `<main>'\r\n    app/controllers/home_controller.rb:3:in `index'\r\n\r\n\r\nrails test test/system/homes_test.rb:4\r\n\r\n\r\n\r\nFinished in 2.118014s, 0.4721 runs/s, 0.0000 assertions/s.\r\n1 runs, 0 assertions, 0 failures, 1 errors, 0 skips\r\n```\r\n\r\nI guess this is the expected behavior.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44799/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44799/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44792","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44792/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44792/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44792/events","html_url":"https://github.com/rails/rails/issues/44792","id":1185054594,"node_id":"I_kwDNIULORqJ_gg","number":44792,"title":"Active Record class method scope leak","user":{"login":"abaldwin88","id":15172605,"node_id":"MDQ6VXNlcjE1MTcyNjA1","avatar_url":"https://avatars.githubusercontent.com/u/15172605?v=4","gravatar_id":"","url":"https://api.github.com/users/abaldwin88","html_url":"https://github.com/abaldwin88","followers_url":"https://api.github.com/users/abaldwin88/followers","following_url":"https://api.github.com/users/abaldwin88/following{/other_user}","gists_url":"https://api.github.com/users/abaldwin88/gists{/gist_id}","starred_url":"https://api.github.com/users/abaldwin88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abaldwin88/subscriptions","organizations_url":"https://api.github.com/users/abaldwin88/orgs","repos_url":"https://api.github.com/users/abaldwin88/repos","events_url":"https://api.github.com/users/abaldwin88/events{/privacy}","received_events_url":"https://api.github.com/users/abaldwin88/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-29T15:34:35Z","updated_at":"2022-07-05T13:25:46Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Active Record leaks scope on class methods directly defined on the model. This behavior is different than queries constructed within a `scope` definition. This issue is an extension of https://github.com/rails/rails/pull/32380\r\n\r\n### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :topics, force: true do |t|\r\n    t.references :topics, :parent\r\n  end\r\nend\r\n\r\nclass Topic < ActiveRecord::Base\r\n  # NOTE: Removing the class methods below and replacing with these\r\n  # scope calls will cause the assert to pass\r\n  #\r\n  # scope :toplevel, -> { where(parent_id: nil) }\r\n  # scope :children, -> { where.not(parent_id: nil) }\r\n  # scope :has_children, -> { where(id: Topic.children.select(:parent_id)) }\r\n\r\n  def self.toplevel\r\n    where(parent_id: nil)\r\n  end\r\n\r\n  def self.children\r\n    where.not(parent_id: nil)\r\n  end\r\n\r\n  def self.has_children\r\n    where(id: Topic.children.select(:parent_id))\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    parent_topic = Topic.create!\r\n    Topic.create!(parent_id: parent_topic.id)\r\n\r\n    assert_equal 1, Topic.toplevel.has_children.count\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nChained class methods do not leak scope\r\n\r\n### Actual behavior\r\n```\r\nFailure:\r\nBugTest#test_association_stuff [bug_report.rb:54]:\r\nExpected: 1\r\nActual: 0\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3 and main\r\n\r\n**Ruby version**: 2.7.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44792/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/44791","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44791/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44791/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44791/events","html_url":"https://github.com/rails/rails/issues/44791","id":1184951571,"node_id":"I_kwDNIULORqDtEw","number":44791,"title":"NoMethodError: undefined method `attribute?'","user":{"login":"artemave","id":23721,"node_id":"MDQ6VXNlcjIzNzIx","avatar_url":"https://avatars.githubusercontent.com/u/23721?v=4","gravatar_id":"","url":"https://api.github.com/users/artemave","html_url":"https://github.com/artemave","followers_url":"https://api.github.com/users/artemave/followers","following_url":"https://api.github.com/users/artemave/following{/other_user}","gists_url":"https://api.github.com/users/artemave/gists{/gist_id}","starred_url":"https://api.github.com/users/artemave/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/artemave/subscriptions","organizations_url":"https://api.github.com/users/artemave/orgs","repos_url":"https://api.github.com/users/artemave/repos","events_url":"https://api.github.com/users/artemave/events{/privacy}","received_events_url":"https://api.github.com/users/artemave/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-29T14:21:54Z","updated_at":"2022-08-12T19:19:22Z","closed_at":"2022-08-12T19:19:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. In an empty folder\r\n\r\n```sh\r\nmkdir fixtures\r\n```\r\n\r\n2. Create `fixtures/foos.yml`:\r\n\r\n```yml\r\none:\r\n  awesome: true\r\n```\r\n\r\n3. Create `bug.rb`:\r\n\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", '~> 7.0.2'\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\nrequire 'rails/test_help'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :foos, force: true do |t|\r\n    t.boolean :awesome\r\n  end\r\nend\r\n\r\nclass Foo < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  self.fixture_path = File.expand_path(\"../fixtures\", __FILE__)\r\n  fixtures :foos\r\n\r\n  def test_attribute_bug\r\n    foos(:one)\r\n\r\n    bar = Class.new do\r\n      include ActiveModel::Attributes\r\n\r\n      attribute :awesome?, :boolean\r\n    end\r\n\r\n    assert_nil bar.new.awesome?\r\n  end\r\nend\r\n```\r\n\r\n4. Run:\r\n\r\n```\r\n    ruby bug.rb\r\n```\r\n\r\n### Expected behavior\r\n\r\nTest is passing.\r\n\r\n### Actual behavior\r\n\r\n```\r\nError:\r\nBugTest#test_attribute_bug:\r\nNoMethodError: undefined method `attribute?' for #<#<Class:0x0000560ab1c1c098>:0x0000560ab1d34b60>\r\nDid you mean?  attribute\r\n               attribute=\r\n               attributes\r\n               attributes=\r\n    /home/artem/.rbenv/versions/2.7.4/lib/ruby/gems/2.7.0/gems/activemodel-7.0.2.3/lib/active_model/attribute_methods.rb:458:in `method_missing'\r\n    /home/artem/.rbenv/versions/2.7.4/lib/ruby/gems/2.7.0/gems/activemodel-7.0.2.3/lib/active_model/attribute_methods.rb:277:in `awesome?'\r\n    bug.rb:46:in `test_attribute_bug'\r\n```\r\n\r\n**Note**: commenting out `foos(:one)` makes the problem go away.\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2, Current main (as of 888ea75df13d9cb0320b9410b0905eb910f8e26f)\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44791/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44791/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44790","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44790/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44790/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44790/events","html_url":"https://github.com/rails/rails/issues/44790","id":1184377245,"node_id":"I_kwDNIULORpgpnQ","number":44790,"title":"Active record association not attached (or detached) with config.load_defaults 7.0","user":{"login":"aglushkov","id":3481507,"node_id":"MDQ6VXNlcjM0ODE1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/3481507?v=4","gravatar_id":"","url":"https://api.github.com/users/aglushkov","html_url":"https://github.com/aglushkov","followers_url":"https://api.github.com/users/aglushkov/followers","following_url":"https://api.github.com/users/aglushkov/following{/other_user}","gists_url":"https://api.github.com/users/aglushkov/gists{/gist_id}","starred_url":"https://api.github.com/users/aglushkov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aglushkov/subscriptions","organizations_url":"https://api.github.com/users/aglushkov/orgs","repos_url":"https://api.github.com/users/aglushkov/repos","events_url":"https://api.github.com/users/aglushkov/events{/privacy}","received_events_url":"https://api.github.com/users/aglushkov/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false},"assignees":[{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-03-29T06:37:22Z","updated_at":"2022-07-29T19:28:36Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThis works with load_defaults 6.0 and raises error with load_defaults 7.0\r\n\r\n- Build some User\r\n- Build some Order with buyer User\r\n- Build some OrderItem with Order and owner User\r\n- Save OrderItem\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\n\r\nclass Application < Rails::Application\r\n  config.load_defaults 7.0 #------------ WORKS with 6.0 ------------\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\nRails.application.initialize!\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n  end\r\n\r\n  create_table :orders, force: true do |t|\r\n    t.belongs_to :buyer, null: false\r\n  end\r\n\r\n  create_table :order_items, force: true do |t|\r\n    t.belongs_to :user, null: false\r\n    t.belongs_to :order, null: false\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_many :owned_order_items, class_name: 'OrderItem'\r\n  has_many :buyer_orders, class_name: 'Order', foreign_key: :buyer_id, inverse_of: :buyer\r\nend\r\n\r\nclass Order < ActiveRecord::Base\r\n  has_many :order_items\r\n  belongs_to :buyer, class_name: 'User', inverse_of: :buyer_orders\r\nend\r\n\r\nclass OrderItem < ActiveRecord::Base\r\n  belongs_to :order\r\n\r\n  belongs_to :owner,\r\n    class_name: 'User',\r\n    foreign_key: :user_id,\r\n    inverse_of: :owned_order_items\r\nend\r\n\r\nbuyer = User.new\r\norder = Order.new(buyer: buyer)\r\norder_item = OrderItem.new(owner: buyer, order: order)\r\n\r\norder_item.save!\r\n```\r\n\r\n### Expected behavior\r\nNo errors, order_item successfully saved\r\n\r\n### Actual behavior\r\nError order_item.order_id in nil\r\n```\r\nSQLite3::ConstraintException: NOT NULL constraint failed: order_items.order_id (ActiveRecord::NotNullViolation)\r\n```\r\n\r\n### System configuration\r\nRails 7.0.2.3\r\n\r\nruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44790/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44790/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44787","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44787/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44787/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44787/events","html_url":"https://github.com/rails/rails/issues/44787","id":1184052813,"node_id":"I_kwDNIULORpM2TQ","number":44787,"title":"Cache::Entry encoding changes in Rails 7 are leading to some confusing behaviour with the increment call","user":{"login":"andrejbl","id":36857192,"node_id":"MDQ6VXNlcjM2ODU3MTky","avatar_url":"https://avatars.githubusercontent.com/u/36857192?v=4","gravatar_id":"","url":"https://api.github.com/users/andrejbl","html_url":"https://github.com/andrejbl","followers_url":"https://api.github.com/users/andrejbl/followers","following_url":"https://api.github.com/users/andrejbl/following{/other_user}","gists_url":"https://api.github.com/users/andrejbl/gists{/gist_id}","starred_url":"https://api.github.com/users/andrejbl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrejbl/subscriptions","organizations_url":"https://api.github.com/users/andrejbl/orgs","repos_url":"https://api.github.com/users/andrejbl/repos","events_url":"https://api.github.com/users/andrejbl/events{/privacy}","received_events_url":"https://api.github.com/users/andrejbl/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-28T22:12:53Z","updated_at":"2022-08-04T19:56:19Z","closed_at":"2022-08-04T19:56:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWith https://github.com/rails/rails/pull/42025 and related changes, there is some confusing side-impact to how the `increment` method now works in combination with the `read` method. Prior to this change, in Rails 6.1 one could do the following:\r\n\r\n```ruby\r\nRails.cache.write(\"counter\", 1, raw: true)\r\n=> 2723551874652307456\r\nRails.cache.increment(\"counter\")\r\n=> 2\r\nRails.cache.read(\"counter\")\r\n=> \"2\"\r\n```\r\n\r\nIn Rails 7 the `Rails.cache.read(\"counter\")` will silently fail and return `nil` unless `raw: true` option is set making the behaviour indistinguishable from a cache miss, and there was no deprecation warning to indicate that this can happen - large codebases are particularly vulnerable to this change in behaviour. \r\n\r\nIn addition, the `Rails.cache.read(\"counter\", raw: true)` is returning a `String` even though the read of a raw counter value is asked for and one should expect an integer. I assume this is due to the counter value being converted to string on write https://github.com/rails/rails/commit/4b63c2700ffc5c646af0e728d4ec2fcb6770671b#diff-9378046eebcf3b1b838fdf05602c2711eb78c6f57123fb61760d78fadbcf74ac. Should this behaviour be deprecated? I do not know if `memcache-client` is still used in the wild, and afaik Dalli is the default memcached client since Rails 6.1.\r\n\r\n### Expected behavior\r\n```ruby\r\nRails.cache.write(\"counter\", 1, raw: true)\r\n=> 2723551874652307456\r\nRails.cache.increment(\"counter\")\r\n=> 2\r\nRails.cache.read(\"counter\") # at least with a deprecation warning raised, or perhaps an exception that the value cannot be decoded\r\n=> 2\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2\r\n\r\n**Ruby version**:\r\n2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44787/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44787/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44780","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44780/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44780/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44780/events","html_url":"https://github.com/rails/rails/issues/44780","id":1183403872,"node_id":"I_kwDNIULORolPYA","number":44780,"title":"Incorrect `foreign_key` in associations in models with namespaces (with load_defaults(7.0) only)","user":{"login":"aglushkov","id":3481507,"node_id":"MDQ6VXNlcjM0ODE1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/3481507?v=4","gravatar_id":"","url":"https://api.github.com/users/aglushkov","html_url":"https://github.com/aglushkov","followers_url":"https://api.github.com/users/aglushkov/followers","following_url":"https://api.github.com/users/aglushkov/following{/other_user}","gists_url":"https://api.github.com/users/aglushkov/gists{/gist_id}","starred_url":"https://api.github.com/users/aglushkov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aglushkov/subscriptions","organizations_url":"https://api.github.com/users/aglushkov/orgs","repos_url":"https://api.github.com/users/aglushkov/repos","events_url":"https://api.github.com/users/aglushkov/events{/privacy}","received_events_url":"https://api.github.com/users/aglushkov/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false},"assignees":[{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-03-28T12:59:34Z","updated_at":"2022-03-29T19:55:22Z","closed_at":"2022-03-29T19:55:21Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Now foreign key does not include namespace part.\r\n\r\nNot sure this is a bug, because foreign keys in associations can be specified manually. But there are no notices in UPGRADING guide about such possible issue.\r\n\r\nCan be fixed manually by adding correct foreign keys\r\nCan be fixed by using config.load_defaults(6.0)\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"logger\"\r\n\r\nclass Application < Rails::Application\r\n  config.load_defaults 7.0 #------------ WORKS with 6.0 ------------\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\nRails.application.initialize!\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :community_categories, force: true do |t|\r\n  end\r\n\r\n  create_table :community_topics, force: true do |t|\r\n    t.belongs_to :community_category\r\n  end\r\nend\r\n\r\nmodule Community\r\n  class Topic < ActiveRecord::Base\r\n    self.table_name = :community_topics\r\n\r\n    belongs_to :community_category,\r\n      class_name: 'Community::Category',\r\n      inverse_of: :community_topics\r\n      # foreign_key: :community_category_id # correct foreign key\r\n  end\r\n\r\n  class Category < ActiveRecord::Base\r\n    self.table_name = :community_categories\r\n\r\n    has_many :community_topics,\r\n      class_name: 'Community::Topic',\r\n      inverse_of: :community_category,\r\n      dependent: :restrict_with_exception\r\n      # foreign_key: :community_category_id # correct foreign key\r\n  end\r\nend\r\n\r\ncommunity_category = Community::Category.new\r\ntopic = Community::Topic.create!(community_category: community_category)\r\n```\r\n\r\n### Expected behavior\r\nRecord must be created without error\r\n\r\n### Actual behavior\r\nError: can't write unknown attribute `category_id` (ActiveModel::MissingAttributeError)\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.3\r\n\r\n**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44780/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44780/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44778","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44778/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44778/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44778/events","html_url":"https://github.com/rails/rails/issues/44778","id":1183259803,"node_id":"I_kwDNIULORoccmw","number":44778,"title":"Some strings passed to \"where.not(numeric_attribute: x)\" lead to unhelpful Postgres null equality comparison ","user":{"login":"patrick-gleeson","id":12064716,"node_id":"MDQ6VXNlcjEyMDY0NzE2","avatar_url":"https://avatars.githubusercontent.com/u/12064716?v=4","gravatar_id":"","url":"https://api.github.com/users/patrick-gleeson","html_url":"https://github.com/patrick-gleeson","followers_url":"https://api.github.com/users/patrick-gleeson/followers","following_url":"https://api.github.com/users/patrick-gleeson/following{/other_user}","gists_url":"https://api.github.com/users/patrick-gleeson/gists{/gist_id}","starred_url":"https://api.github.com/users/patrick-gleeson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/patrick-gleeson/subscriptions","organizations_url":"https://api.github.com/users/patrick-gleeson/orgs","repos_url":"https://api.github.com/users/patrick-gleeson/repos","events_url":"https://api.github.com/users/patrick-gleeson/events{/privacy}","received_events_url":"https://api.github.com/users/patrick-gleeson/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-28T10:58:22Z","updated_at":"2022-07-03T17:18:27Z","closed_at":"2022-07-03T17:18:27Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nHave a Postgres-backed ActiveRecord setup, with a User model that has a numeric 'id' attribute. In most cases, `User.where.not(id: x)` is handled very sensibly:\r\n\r\nCase A: `puts User.where.not(id: 1).to_sql` outputs: `SELECT \"users\".* FROM \"users\" WHERE \"users\".\"id\" != 1`, which makes total sense\r\n\r\nCase B: `puts User.where.not(id: nil).to_sql` outputs: `SELECT \"users\".* FROM \"users\" WHERE \"users\".\"id\" IS NOT NULL`, which also makes total sense\r\n\r\nCase C:`puts User.where.not(id: []).to_sql` outputs `SELECT \"users\".* FROM \"users\" WHERE 1=1` which makes sense when you think about it. _All_ ids are not equal to `[]`, so any `WHERE` clause that always returns true is equivalent\r\n\r\nHere's where it goes a bit weird and unhelpful:\r\n\r\n### Expected behavior\r\n```ruby\r\nputs User.where.not(id: 'foo').to_sql\r\n# I'd have thought this should output \"SELECT \"users\".* FROM \"users\" WHERE 1=1\" to match case C above\r\n```\r\n\r\n### Actual behavior\r\n```ruby\r\nputs User.where.not(id: 'foo').to_sql\r\n# outputs:  SELECT \"users\".* FROM \"users\" WHERE \"users\".\"id\" != NULL\r\n```\r\n\r\nThis is both weird in that it's not a literal translation to SQL of the slightly absurd statement I am making in Ruby, and unhelpful in that, unlike the empty array comparison, it doesn't say, in effect: \"no users have 'foo' as their ID, so all users do _not_ have 'foo' as their ID\". Instead, it uses \"!= NULL\", which always evaluates to false, so this query can never return any records.\r\n\r\nIt's particularly unhelpful because you _can_ pass not only `\"1\"` as an interpretable ID value, but also `\"1foo\"` or `\"0foo\"` (although not `\"foo1\"`), so there are plenty of instances where using a string is considered reasonable. \r\n\r\n### System configuration\r\n**Rails version**: 6.1.4.6\r\n\r\n**Ruby version**: 2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44778/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44778/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44776","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44776/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44776/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44776/events","html_url":"https://github.com/rails/rails/issues/44776","id":1182479374,"node_id":"I_kwDNIULORns0Dg","number":44776,"title":"Less records returned from a query with eager loading and ordering on a column from has_many association","user":{"login":"bli","id":417086,"node_id":"MDQ6VXNlcjQxNzA4Ng==","avatar_url":"https://avatars.githubusercontent.com/u/417086?v=4","gravatar_id":"","url":"https://api.github.com/users/bli","html_url":"https://github.com/bli","followers_url":"https://api.github.com/users/bli/followers","following_url":"https://api.github.com/users/bli/following{/other_user}","gists_url":"https://api.github.com/users/bli/gists{/gist_id}","starred_url":"https://api.github.com/users/bli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bli/subscriptions","organizations_url":"https://api.github.com/users/bli/orgs","repos_url":"https://api.github.com/users/bli/repos","events_url":"https://api.github.com/users/bli/events{/privacy}","received_events_url":"https://api.github.com/users/bli/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-27T10:34:13Z","updated_at":"2022-03-29T21:50:08Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nNote: This happens only on postgres (and likely mysql as well), not on sqllite.\r\n\r\n1. Let `Post` have a has_many association `comments` \r\n2. Create 5 posts, each with 3 comments.\r\n3. Run a query to get 3 posts with eager loading on comments and ordering on `created_at` of comments.\r\n`Post.includes(:comments).references(:comments).order(\"comments.created_at\").limit(3)`\r\n\r\nThe test to show the issue:\r\nhttps://gist.github.com/bli/cb5136e46a59c19293710ac345281dd7\r\n\r\n\r\n### Expected behavior\r\nReturn 3 posts\r\n\r\n### Actual behavior\r\nOnly 1 record is returned\r\n\r\n### System configuration\r\nAt least in versions 7, 6, 5\r\n\r\n### Cause\r\n\r\nDatabases like postgres requires the ORDER BY columns in the select list for distinct queries. So when ordering by `comments.created_at`, that column is included in the distinct select list of the query to fetch the Post ids:\r\n```\r\nSELECT DISTINCT comments.created_at AS alias_0, \"posts\".\"id\" FROM \"posts\" \r\nLEFT OUTER JOIN \"comments\" ON \"comments\".\"post_id\" = \"posts\".\"id\" \r\nORDER BY comments.created_at \r\nLIMIT $1  \r\n[[\"LIMIT\", 3]]\r\n```\r\nThis would result in 3 rows with the same Post id when that post happens to have the 3 earliest comments.\r\nHence the main query would return only 1 post:\r\n```\r\nSELECT \"posts\".\"id\" AS t0_r0, \"comments\".\"id\" AS t1_r0, \"comments\".\"post_id\" AS t1_r1, \r\n       \"comments\".\"created_at\" AS t1_r2, \"comments\".\"updated_at\" AS t1_r3 \r\nFROM \"posts\" \r\nLEFT OUTER JOIN \"comments\" ON \"comments\".\"post_id\" = \"posts\".\"id\" \r\nWHERE \"posts\".\"id\" IN ($1, $2, $3) \r\nORDER BY comments.created_at  \r\n[[\"id\", 1], [\"id\", 1], [\"id\", 1]]\r\n```\r\n\r\nCode related to the issue:\r\nRails 7:\r\nhttps://github.com/rails/rails/blob/af0733a8e7ceddf6b9128ad2aaf4f74c5b427c43/activerecord/lib/active_record/connection_adapters/abstract/schema_statements.rb#L1294\r\nRails 6:\r\nhttps://github.com/rails/rails/blob/53410537594be0c0a528cff53dce433dd386cb6a/activerecord/lib/active_record/relation/finder_methods.rb#L427\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44776/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44776/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44775","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44775/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44775/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44775/events","html_url":"https://github.com/rails/rails/issues/44775","id":1182243941,"node_id":"I_kwDNIULORnecZQ","number":44775,"title":"toastify-js not working hotwire/stimulus","user":{"login":"fabriciobonjorno","id":28460996,"node_id":"MDQ6VXNlcjI4NDYwOTk2","avatar_url":"https://avatars.githubusercontent.com/u/28460996?v=4","gravatar_id":"","url":"https://api.github.com/users/fabriciobonjorno","html_url":"https://github.com/fabriciobonjorno","followers_url":"https://api.github.com/users/fabriciobonjorno/followers","following_url":"https://api.github.com/users/fabriciobonjorno/following{/other_user}","gists_url":"https://api.github.com/users/fabriciobonjorno/gists{/gist_id}","starred_url":"https://api.github.com/users/fabriciobonjorno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabriciobonjorno/subscriptions","organizations_url":"https://api.github.com/users/fabriciobonjorno/orgs","repos_url":"https://api.github.com/users/fabriciobonjorno/repos","events_url":"https://api.github.com/users/fabriciobonjorno/events{/privacy}","received_events_url":"https://api.github.com/users/fabriciobonjorno/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-27T01:44:25Z","updated_at":"2022-03-28T14:37:26Z","closed_at":"2022-03-28T14:37:26Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nInstall Toastfy\r\n```\r\nyarn add toastify-js\r\n```\r\nadd in to application.js\r\n```\r\nimport Toastify from \"toastify-js\"\r\n\r\n  document.addEventListener('DOMContentLoaded', () => {\r\n    const backgroundColors = {\r\n      alert: \"#f44336\",\r\n      error: \"#f39c12\",\r\n      notice: \"#009688\"\r\n    }\r\n    JSON.parse(document.body.dataset.flashMessages).forEach(flashMessage => {\r\n      const [type, message] = flashMessage;\r\n      Toastify(\r\n        {\r\n          text: message,\r\n          duration: 3000,\r\n          close: true,\r\n          backgroundColor: backgroundColors[type],\r\n          stopOnFocus: true\r\n        }\r\n      ).showToast();\r\n    });\r\n  });\r\n```\r\nadd in to css file\r\n```\r\n@import \"toastify-js/src/toastify\";\r\n```\r\nadd in to application.html.erb (views/layout)\r\n```\r\n<body data-flash-messages=\"<%= JSON.dump(flash.to_a) %>\" >\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nExpected that renders the alert or confirmation message. In devise message it's working\r\n[Doc Toastfy](https://apvarun.github.io/toastify-js/)\r\n![ok](https://user-images.githubusercontent.com/28460996/160262999-c5bc2930-f79f-4f58-a4a3-b66da9723806.png)\r\n\r\n\r\n### Actual behavior\r\nIt renders the message but does not open the alarm popup.\r\nResult:\r\n![toastfy](https://user-images.githubusercontent.com/28460996/160262823-5f0ff0c3-0913-4964-b122-5dc646226412.png)\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2.3\r\n**Ruby version**:\r\n3.1.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44775/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44775/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44771","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44771/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44771/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44771/events","html_url":"https://github.com/rails/rails/issues/44771","id":1181447341,"node_id":"I_kwDNIULORmt0rQ","number":44771,"title":"Multi level subdomain is not allowed after Rails 6.1.4.2","user":{"login":"r7kamura","id":111689,"node_id":"MDQ6VXNlcjExMTY4OQ==","avatar_url":"https://avatars.githubusercontent.com/u/111689?v=4","gravatar_id":"","url":"https://api.github.com/users/r7kamura","html_url":"https://github.com/r7kamura","followers_url":"https://api.github.com/users/r7kamura/followers","following_url":"https://api.github.com/users/r7kamura/following{/other_user}","gists_url":"https://api.github.com/users/r7kamura/gists{/gist_id}","starred_url":"https://api.github.com/users/r7kamura/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/r7kamura/subscriptions","organizations_url":"https://api.github.com/users/r7kamura/orgs","repos_url":"https://api.github.com/users/r7kamura/repos","events_url":"https://api.github.com/users/r7kamura/events{/privacy}","received_events_url":"https://api.github.com/users/r7kamura/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-26T01:33:06Z","updated_at":"2022-03-27T14:48:54Z","closed_at":"2022-03-27T14:48:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nRun this test:\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  gem 'rails', '7.0.2.3'\r\nend\r\n\r\nrequire 'rack/test'\r\nrequire 'action_controller/railtie'\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << '.example.org'\r\n  config.session_store :cookie_store, key: 'cookie_store_key'\r\n  secrets.secret_key_base = 'secret_key_base'\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    get '/' => 'test#index'\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    render plain: 'Home'\r\n  end\r\nend\r\n\r\nrequire 'minitest/autorun'\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_two_level_subdomain_returns_success\r\n    header 'Host', 'b.a.example.org'\r\n    get '/'\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n\r\n  def app\r\n    Rails.application\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nIt passes.\r\n\r\nIn other words, when I set up `.example.org`, I expect `b.a.example.org` to be allowed as on Rails 6.1.4.1 and earlier.\r\n\r\n### Actual behavior\r\n\r\nIt fails.\r\n\r\nIt succeeded on Rails 6.1.4.1 and earlier, but started to fail on Rails 6.1.4.2. Is this an intended change?\r\n\r\n### System configuration\r\n\r\n**rails 7.0.2.3**:\r\n\r\n**ruby 2.7.2p137**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44771/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44771/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44768","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44768/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44768/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44768/events","html_url":"https://github.com/rails/rails/issues/44768","id":1180726446,"node_id":"I_kwDNIULORmB0rg","number":44768,"title":"why svg image is not treated as web image content types in active storage configuration?","user":{"login":"bijay3030","id":59387595,"node_id":"MDQ6VXNlcjU5Mzg3NTk1","avatar_url":"https://avatars.githubusercontent.com/u/59387595?v=4","gravatar_id":"","url":"https://api.github.com/users/bijay3030","html_url":"https://github.com/bijay3030","followers_url":"https://api.github.com/users/bijay3030/followers","following_url":"https://api.github.com/users/bijay3030/following{/other_user}","gists_url":"https://api.github.com/users/bijay3030/gists{/gist_id}","starred_url":"https://api.github.com/users/bijay3030/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bijay3030/subscriptions","organizations_url":"https://api.github.com/users/bijay3030/orgs","repos_url":"https://api.github.com/users/bijay3030/repos","events_url":"https://api.github.com/users/bijay3030/events{/privacy}","received_events_url":"https://api.github.com/users/bijay3030/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-25T12:17:16Z","updated_at":"2022-03-25T22:38:48Z","closed_at":"2022-03-25T22:38:48Z","author_association":"NONE","active_lock_reason":null,"body":"when uploading svg image to active storage via digital ocean s3 service  it gives downloadable link which is not render in browser  but we need to render it in browser\r\n\r\n### Steps to reproduce\r\nsvg image are included in active storage configuration as \r\nconfig.active_storage.content_types_to_serve_as_binary = %w(\r\n      text/html\r\n      text/javascript\r\n      image/svg+xml\r\n      application/postscript\r\n      application/x-shockwave-flash\r\n      text/xml\r\n      application/xml\r\n      application/xhtml+xml\r\n      application/mathml+xml\r\n      text/cache-manifest\r\n    )\r\nbut why svg image is not included in \r\n config.active_storage.web_image_content_types = %w(\r\n      image/png\r\n      image/jpeg\r\n      image/jpg\r\n      image/gif\r\n    )\r\n\r\n\r\n\r\n\r\n### Expected behavior\r\n config.active_storage.web_image_content_types = %w(\r\n      image/png\r\n      image/jpeg\r\n      image/jpg\r\n      image/gif\r\n      image/svg+xml\r\n    )\r\n\r\n    config.active_storage.content_types_to_serve_as_binary = %w(\r\n      text/html\r\n      text/javascript\r\n      application/postscript\r\n      application/x-shockwave-flash\r\n      text/xml\r\n      application/xml\r\n      application/xhtml+xml\r\n      application/mathml+xml\r\n      text/cache-manifest\r\n    )\r\n\r\n### Actual behavior\r\nconfig.active_storage.web_image_content_types = %w(\r\n      image/png\r\n      image/jpeg\r\n      image/jpg\r\n      image/gif\r\n    )\r\n\r\n    config.active_storage.content_types_to_serve_as_binary = %w(\r\n      text/html\r\n      text/javascript\r\n      image/svg+xml\r\n      application/postscript\r\n      application/x-shockwave-flash\r\n      text/xml\r\n      application/xml\r\n      application/xhtml+xml\r\n      application/mathml+xml\r\n      text/cache-manifest\r\n    )\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4\r\n\r\n**Ruby version**:3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44768/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44768/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44767","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44767/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44767/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44767/events","html_url":"https://github.com/rails/rails/issues/44767","id":1180134276,"node_id":"I_kwDNIULORldrhA","number":44767,"title":"Rails 6.1.5 id type regression on migration","user":{"login":"marocchino","id":128431,"node_id":"MDQ6VXNlcjEyODQzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/128431?v=4","gravatar_id":"","url":"https://api.github.com/users/marocchino","html_url":"https://github.com/marocchino","followers_url":"https://api.github.com/users/marocchino/followers","following_url":"https://api.github.com/users/marocchino/following{/other_user}","gists_url":"https://api.github.com/users/marocchino/gists{/gist_id}","starred_url":"https://api.github.com/users/marocchino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marocchino/subscriptions","organizations_url":"https://api.github.com/users/marocchino/orgs","repos_url":"https://api.github.com/users/marocchino/repos","events_url":"https://api.github.com/users/marocchino/events{/privacy}","received_events_url":"https://api.github.com/users/marocchino/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-24T22:52:20Z","updated_at":"2022-05-06T07:46:44Z","closed_at":"2022-03-25T03:26:44Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n```rb\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem 'rails', ENV.fetch('RAILS_VERSION', '6.1.5')\r\n  gem 'mysql2'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'logger'\r\n\r\nActiveRecord::Base.establish_connection(adapter: 'mysql2', database: 'migration_issue_development', username: 'root',\r\n                                        host: '127.0.0.1', password: 'root', port: 4306)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nclass CreateActiveStorageTables < ActiveRecord::Migration[5.2]\r\n  def change\r\n    create_table :active_storage_blobs do |t|\r\n      t.string   :key,        null: false\r\n      t.string   :filename,   null: false\r\n      t.string   :content_type\r\n      t.text     :metadata\r\n      t.bigint   :byte_size,  null: false\r\n      t.string   :checksum,   null: false\r\n      t.datetime :created_at, null: false\r\n\r\n      t.index [:key], unique: true\r\n    end\r\n\r\n    create_table :active_storage_attachments do |t|\r\n      t.string     :name,     null: false\r\n      t.references :record,   null: false, polymorphic: true, index: false\r\n      t.references :blob,     null: false\r\n\r\n      t.datetime :created_at, null: false\r\n\r\n      t.index %i[record_type record_id name blob_id], name: 'index_active_storage_attachments_uniqueness',\r\n                                                      unique: true\r\n      t.foreign_key :active_storage_blobs, column: :blob_id\r\n    end\r\n  end\r\nend\r\n\r\nclass CreateActiveStorageVariantRecords < ActiveRecord::Migration[6.0]\r\n  def change\r\n    create_table :active_storage_variant_records do |t|\r\n      t.belongs_to :blob, null: false, index: false\r\n      t.string :variation_digest, null: false\r\n\r\n      t.index %i[blob_id variation_digest], name: 'index_active_storage_variant_records_uniqueness', unique: true\r\n      t.foreign_key :active_storage_blobs, column: :blob_id\r\n    end\r\n  end\r\nend\r\n\r\nCreateActiveStorageTables.migrate(:up)\r\nCreateActiveStorageVariantRecords.migrate(:up)\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nComplete migration without errors. 6.1.4.7 version was fine.\r\n```\r\n$ RAILS_VERSION=6.1.4.7 ruby migration_bug.rb\r\nFetching gem metadata from https://rubygems.org/...........\r\nResolving dependencies...\r\nUsing rake 13.0.6\r\nUsing concurrent-ruby 1.1.10\r\nUsing minitest 5.15.0\r\nUsing zeitwerk 2.5.4\r\nUsing builder 3.2.4\r\nUsing erubi 1.10.0\r\nUsing racc 1.6.0\r\nUsing method_source 1.0.0\r\nUsing i18n 1.10.0\r\nUsing tzinfo 2.0.4\r\nUsing crass 1.0.6\r\nUsing activesupport 6.1.4.7\r\nUsing marcel 1.0.2\r\nUsing globalid 1.0.0\r\nUsing activemodel 6.1.4.7\r\nUsing bundler 2.3.9\r\nUsing activerecord 6.1.4.7\r\nUsing activejob 6.1.4.7\r\nUsing nio4r 2.5.8\r\nUsing websocket-extensions 0.1.5\r\nUsing mini_mime 1.1.2\r\nUsing nokogiri 1.13.3 (arm64-darwin)\r\nUsing mysql2 0.5.3\r\nUsing thor 1.2.1\r\nUsing rails-dom-testing 2.0.3\r\nUsing loofah 2.15.0\r\nUsing mail 2.7.1\r\nUsing rails-html-sanitizer 1.4.2\r\nUsing rack 2.2.3\r\nUsing websocket-driver 0.7.5\r\nUsing actionview 6.1.4.7\r\nUsing sprockets 4.0.3\r\nUsing rack-test 1.1.0\r\nUsing actionpack 6.1.4.7\r\nUsing actioncable 6.1.4.7\r\nUsing activestorage 6.1.4.7\r\nUsing actionmailer 6.1.4.7\r\nUsing railties 6.1.4.7\r\nUsing actiontext 6.1.4.7\r\nUsing sprockets-rails 3.4.2\r\nUsing actionmailbox 6.1.4.7\r\nUsing rails 6.1.4.7\r\n==  CreateActiveStorageTables: migrating ======================================\r\n-- create_table(:active_storage_blobs)\r\nD, [2022-03-25T07:47:34.880170 #91008] DEBUG -- :    (6.4ms)  CREATE TABLE `active_storage_blobs` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `key` varchar(255) NOT NULL, `filename` varchar(255) NOT NULL, `content_type` varchar(255), `metadata` text, `byte_size` bigint NOT NULL, `checksum` varchar(255) NOT NULL, `created_at` datetime NOT NULL, UNIQUE INDEX `index_active_storage_blobs_on_key` (`key`))\r\n   -> 0.0069s\r\n-- create_table(:active_storage_attachments)\r\nD, [2022-03-25T07:47:34.888578 #91008] DEBUG -- :    (8.1ms)  CREATE TABLE `active_storage_attachments` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `name` varchar(255) NOT NULL, `record_type` varchar(255) NOT NULL, `record_id` bigint NOT NULL, `blob_id` bigint NOT NULL, `created_at` datetime NOT NULL, INDEX `index_active_storage_attachments_on_blob_id` (`blob_id`), UNIQUE INDEX `index_active_storage_attachments_uniqueness` (`record_type`, `record_id`, `name`, `blob_id`), CONSTRAINT `fk_rails_c3b3935057`\r\nFOREIGN KEY (`blob_id`)\r\n  REFERENCES `active_storage_blobs` (`id`)\r\n)\r\n   -> 0.0084s\r\n==  CreateActiveStorageTables: migrated (0.0153s) =============================\r\n\r\n==  CreateActiveStorageVariantRecords: migrating ==============================\r\n-- create_table(:active_storage_variant_records)\r\nD, [2022-03-25T07:47:34.899508 #91008] DEBUG -- :    (9.5ms)  CREATE TABLE `active_storage_variant_records` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `blob_id` bigint NOT NULL, `variation_digest` varchar(255) NOT NULL, UNIQUE INDEX `index_active_storage_variant_records_uniqueness` (`blob_id`, `variation_digest`), CONSTRAINT `fk_rails_993965df05`\r\nFOREIGN KEY (`blob_id`)\r\n  REFERENCES `active_storage_blobs` (`id`)\r\n)\r\n   -> 0.0099s\r\n==  CreateActiveStorageVariantRecords: migrated (0.0100s) =====================\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nend with this error: Column `blob_id` on table `active_storage_variant_records` does not match column `id` on `active_storage_blobs`, which has type `bigint(20)`.\r\n\r\n```\r\n$ ruby migration_bug.rb\r\nFetching gem metadata from https://rubygems.org/...........\r\nResolving dependencies...\r\nUsing rake 13.0.6\r\nUsing concurrent-ruby 1.1.10\r\nUsing zeitwerk 2.5.4\r\nUsing builder 3.2.4\r\nUsing erubi 1.10.0\r\nUsing nio4r 2.5.8\r\nUsing method_source 1.0.0\r\nUsing rack 2.2.3\r\nUsing thor 1.2.1\r\nUsing tzinfo 2.0.4\r\nUsing rack-test 1.1.0\r\nUsing sprockets 4.0.3\r\nUsing marcel 1.0.2\r\nUsing bundler 2.3.9\r\nUsing crass 1.0.6\r\nUsing mysql2 0.5.3\r\nUsing websocket-extensions 0.1.5\r\nUsing minitest 5.15.0\r\nUsing websocket-driver 0.7.5\r\nUsing racc 1.6.0\r\nUsing i18n 1.10.0\r\nUsing mini_mime 1.1.2\r\nUsing activesupport 6.1.5\r\nUsing nokogiri 1.13.3 (arm64-darwin)\r\nUsing activemodel 6.1.5\r\nUsing globalid 1.0.0\r\nUsing mail 2.7.1\r\nUsing activerecord 6.1.5\r\nUsing rails-dom-testing 2.0.3\r\nUsing activejob 6.1.5\r\nUsing loofah 2.15.0\r\nUsing rails-html-sanitizer 1.4.2\r\nUsing actionview 6.1.5\r\nUsing actionpack 6.1.5\r\nUsing actioncable 6.1.5\r\nUsing activestorage 6.1.5\r\nUsing actionmailer 6.1.5\r\nUsing railties 6.1.5\r\nUsing sprockets-rails 3.4.2\r\nUsing actionmailbox 6.1.5\r\nUsing actiontext 6.1.5\r\nUsing rails 6.1.5\r\n==  CreateActiveStorageTables: migrating ======================================\r\n-- create_table(:active_storage_blobs)\r\nD, [2022-03-25T07:43:53.437458 #85774] DEBUG -- :    (8.0ms)  CREATE TABLE `active_storage_blobs` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `key` varchar(255) NOT NULL, `filename` varchar(255) NOT NULL, `content_type` varchar(255), `metadata` text, `byte_size` bigint NOT NULL, `checksum` varchar(255) NOT NULL, `created_at` datetime NOT NULL, UNIQUE INDEX `index_active_storage_blobs_on_key` (`key`))\r\n   -> 0.0084s\r\n-- create_table(:active_storage_attachments)\r\nD, [2022-03-25T07:43:53.449683 #85774] DEBUG -- :    (11.8ms)  CREATE TABLE `active_storage_attachments` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `name` varchar(255) NOT NULL, `record_type` varchar(255) NOT NULL, `record_id` bigint NOT NULL, `blob_id` bigint NOT NULL, `created_at` datetime NOT NULL, INDEX `index_active_storage_attachments_on_blob_id` (`blob_id`), UNIQUE INDEX `index_active_storage_attachments_uniqueness` (`record_type`, `record_id`, `name`, `blob_id`), CONSTRAINT `fk_rails_c3b3935057`\r\nFOREIGN KEY (`blob_id`)\r\n  REFERENCES `active_storage_blobs` (`id`)\r\n)\r\n   -> 0.0122s\r\n==  CreateActiveStorageTables: migrated (0.0207s) =============================\r\n\r\n==  CreateActiveStorageVariantRecords: migrating ==============================\r\n-- create_table(:active_storage_variant_records)\r\nD, [2022-03-25T07:43:53.462655 #85774] DEBUG -- :    (11.5ms)  CREATE TABLE `active_storage_variant_records` (`id` bigint NOT NULL AUTO_INCREMENT PRIMARY KEY, `blob_id` int NOT NULL, `variation_digest` varchar(255) NOT NULL, UNIQUE INDEX `index_active_storage_variant_records_uniqueness` (`blob_id`, `variation_digest`), CONSTRAINT `fk_rails_993965df05`\r\nFOREIGN KEY (`blob_id`)\r\n  REFERENCES `active_storage_blobs` (`id`)\r\n)\r\n/Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `_query': Column `blob_id` on table `active_storage_variant_records` does not match column `id` on `active_storage_blobs`, which has type `bigint(20)`. To resolve this issue, change the type of the `blob_id` column on `active_storage_variant_records` to be :bigint. (For example `t.bigint :blob_id`). (ActiveRecord::MismatchedForeignKey)\r\nOriginal message: Mysql2::Error: Cannot add foreign key constraint\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `block in query'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `query'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:206:in `block (2 levels) in execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/dependencies/interlock.rb:48:in `block in permit_concurrent_loads'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/dependencies/interlock.rb:47:in `permit_concurrent_loads'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:205:in `block in execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:696:in `block (2 levels) in log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:26:in `block (2 levels) in synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:695:in `block in log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:687:in `log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:204:in `execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/mysql/database_statements.rb:52:in `execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract/schema_statements.rb:322:in `create_table'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/mysql/schema_statements.rb:81:in `create_table'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:929:in `block in method_missing'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:897:in `block in say_with_time'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:897:in `say_with_time'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:918:in `method_missing'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration/compatibility.rb:52:in `create_table'\r\n\tfrom migration_bug.rb:51:in `change'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:867:in `exec_migration'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:851:in `block (2 levels) in migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:850:in `block in migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract/connection_pool.rb:462:in `with_connection'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:849:in `migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:663:in `migrate'\r\n\tfrom migration_bug.rb:62:in `<main>'\r\n/Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `_query': Cannot add foreign key constraint (Mysql2::Error)\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `block in query'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `query'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:206:in `block (2 levels) in execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/dependencies/interlock.rb:48:in `block in permit_concurrent_loads'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/dependencies/interlock.rb:47:in `permit_concurrent_loads'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:205:in `block in execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:696:in `block (2 levels) in log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:26:in `block (2 levels) in synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:695:in `block in log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-6.1.5/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_adapter.rb:687:in `log'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:204:in `execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/mysql/database_statements.rb:52:in `execute'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract/schema_statements.rb:322:in `create_table'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/mysql/schema_statements.rb:81:in `create_table'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:929:in `block in method_missing'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:897:in `block in say_with_time'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:897:in `say_with_time'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:918:in `method_missing'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration/compatibility.rb:52:in `create_table'\r\n\tfrom migration_bug.rb:51:in `change'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:867:in `exec_migration'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:851:in `block (2 levels) in migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/3.1.0/benchmark.rb:296:in `measure'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:850:in `block in migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/connection_adapters/abstract/connection_pool.rb:462:in `with_connection'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:849:in `migrate'\r\n\tfrom /Users/marocchino/.asdf/installs/ruby/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-6.1.5/lib/active_record/migration.rb:663:in `migrate'\r\n\tfrom migration_bug.rb:62:in `<main>'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 3.1.1\r\n\r\n**MySql version**:  5.7.31\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44767/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44767/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44762","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44762/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44762/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44762/events","html_url":"https://github.com/rails/rails/issues/44762","id":1179461903,"node_id":"I_kwDNIULORk0pDw","number":44762,"title":"rich_text_area field with model validation error doesn't get wrapped in div.field_with_errors","user":{"login":"scottdavis","id":11871,"node_id":"MDQ6VXNlcjExODcx","avatar_url":"https://avatars.githubusercontent.com/u/11871?v=4","gravatar_id":"","url":"https://api.github.com/users/scottdavis","html_url":"https://github.com/scottdavis","followers_url":"https://api.github.com/users/scottdavis/followers","following_url":"https://api.github.com/users/scottdavis/following{/other_user}","gists_url":"https://api.github.com/users/scottdavis/gists{/gist_id}","starred_url":"https://api.github.com/users/scottdavis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/scottdavis/subscriptions","organizations_url":"https://api.github.com/users/scottdavis/orgs","repos_url":"https://api.github.com/users/scottdavis/repos","events_url":"https://api.github.com/users/scottdavis/events{/privacy}","received_events_url":"https://api.github.com/users/scottdavis/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":1180817762,"node_id":"MDU6TGFiZWwxMTgwODE3NzYy","url":"https://api.github.com/repos/rails/rails/labels/actiontext","name":"actiontext","color":"3bc667","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-24T12:40:30Z","updated_at":"2022-06-23T21:27:56Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I'm happy to make a PR to address this if it's something the community deems is a bug. It just seemed inconsistent with the rest of the form helpers.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nRender an action text field that has model validation errors\r\nview `<%= f.rich_text_area :my_text %>`\r\n\r\nin model \r\n\r\n`validates_presence_of :my_text`\r\n\r\n### Expected behavior\r\nWhen the field has errors it should be wrapped in a div with the class `div.field_with_errors` like the other form helpers\r\n\r\n### Actual behavior\r\nThe fields are not wrapped in `div.field_with_errors` \r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.2.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44762/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44762/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44761","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44761/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44761/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44761/events","html_url":"https://github.com/rails/rails/issues/44761","id":1179424660,"node_id":"I_kwDNIULORkyXlA","number":44761,"title":"Railtie.respond_to_missing? creates an instance unexpectedly","user":{"login":"eregon","id":168854,"node_id":"MDQ6VXNlcjE2ODg1NA==","avatar_url":"https://avatars.githubusercontent.com/u/168854?v=4","gravatar_id":"","url":"https://api.github.com/users/eregon","html_url":"https://github.com/eregon","followers_url":"https://api.github.com/users/eregon/followers","following_url":"https://api.github.com/users/eregon/following{/other_user}","gists_url":"https://api.github.com/users/eregon/gists{/gist_id}","starred_url":"https://api.github.com/users/eregon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eregon/subscriptions","organizations_url":"https://api.github.com/users/eregon/orgs","repos_url":"https://api.github.com/users/eregon/repos","events_url":"https://api.github.com/users/eregon/events{/privacy}","received_events_url":"https://api.github.com/users/eregon/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-24T12:06:29Z","updated_at":"2022-03-28T15:55:13Z","closed_at":"2022-03-25T23:57:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThe code is https://github.com/rails/rails/blob/ad25dfad8797b5024d90592bdb6a5b2d725a4850/railties/lib/rails/railtie.rb#L216-L218\r\n\r\nThis can lead to very confusing bugs, because it's not safe to e.g. check `respond_to?(:ruby2_keywords, true)` on Railtie or any of the subclasses.\r\n\r\nSo this line in Rails 6.1 actually creates an instance of `Railtie`, that's very likely unexpected:\r\nhttps://github.com/rails/rails/blob/d38ff07a39c98f5db2b15ca3a51acee48c972205/railties/lib/rails/railtie.rb#L212\r\nhttps://github.com/rails/rails/blob/6-1-stable/railties/lib/rails/railtie.rb\r\n\r\nAn example bug caused by this is RSpec for instance can't use `respond_to?(:ruby2_keywords, true)` when mock'ing `::Rails.application` (and so defining methods on the singleton class of the `::Rails.application`).\r\n(details in https://github.com/rspec/rspec-mocks/pull/1385#issuecomment-755340298)\r\n\r\nIn short, this basically breaks `respond_to?` (or unintentionally creates instances of them) on Railtie and all its subclasses (on the class objects themselves), and so makes it difficult to check if e.g. some method defined is available on the class.\r\n\r\nI think ideally Rails should never define `respond_to_missing?` on modules/classes objects themselves, it should only do so for instances of classes.\r\n\r\nA workaround for the specific case of checking if ruby2_keywords is available is to use `Module.private_method_defined?(:ruby2_keywords)` instead.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44761/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44761/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44755","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44755/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44755/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44755/events","html_url":"https://github.com/rails/rails/issues/44755","id":1178580166,"node_id":"I_kwDNIULORj-0xg","number":44755,"title":"`Range#overlaps?` error when comparing beginless ranges","user":{"login":"donny741","id":20892205,"node_id":"MDQ6VXNlcjIwODkyMjA1","avatar_url":"https://avatars.githubusercontent.com/u/20892205?v=4","gravatar_id":"","url":"https://api.github.com/users/donny741","html_url":"https://github.com/donny741","followers_url":"https://api.github.com/users/donny741/followers","following_url":"https://api.github.com/users/donny741/following{/other_user}","gists_url":"https://api.github.com/users/donny741/gists{/gist_id}","starred_url":"https://api.github.com/users/donny741/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/donny741/subscriptions","organizations_url":"https://api.github.com/users/donny741/orgs","repos_url":"https://api.github.com/users/donny741/repos","events_url":"https://api.github.com/users/donny741/events{/privacy}","received_events_url":"https://api.github.com/users/donny741/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-23T19:38:59Z","updated_at":"2022-03-23T22:13:52Z","closed_at":"2022-03-23T22:13:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n(1..5).overlaps?(..10)\r\n(..5).overlaps?(..10)\r\n```\r\n\r\n### Expected behavior\r\nIt returns `true`\r\n\r\n### Actual behavior\r\nIt raises a `RangeError: cannot get the first element of beginless range`\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44755/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44755/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44751","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44751/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44751/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44751/events","html_url":"https://github.com/rails/rails/issues/44751","id":1177795173,"node_id":"I_kwDNIULORjO6ZQ","number":44751,"title":"Rails autoloading issues when used with \"async\" gem","user":{"login":"morgoth","id":10766,"node_id":"MDQ6VXNlcjEwNzY2","avatar_url":"https://avatars.githubusercontent.com/u/10766?v=4","gravatar_id":"","url":"https://api.github.com/users/morgoth","html_url":"https://github.com/morgoth","followers_url":"https://api.github.com/users/morgoth/followers","following_url":"https://api.github.com/users/morgoth/following{/other_user}","gists_url":"https://api.github.com/users/morgoth/gists{/gist_id}","starred_url":"https://api.github.com/users/morgoth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morgoth/subscriptions","organizations_url":"https://api.github.com/users/morgoth/orgs","repos_url":"https://api.github.com/users/morgoth/repos","events_url":"https://api.github.com/users/morgoth/events{/privacy}","received_events_url":"https://api.github.com/users/morgoth/received_events","type":"User","site_admin":false},"labels":[{"id":1907985386,"node_id":"MDU6TGFiZWwxOTA3OTg1Mzg2","url":"https://api.github.com/repos/rails/rails/labels/autoloading","name":"autoloading","color":"f4ff5e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-03-23T08:43:24Z","updated_at":"2022-03-24T11:39:49Z","closed_at":"2022-03-24T08:39:46Z","author_association":"MEMBER","active_lock_reason":null,"body":"I integrated [async](https://github.com/socketry/async) into the Rails app and I noticed issues with using this gem and Rails autoloder (powered by zeitwerk).\r\n\r\nI have the sample app that presents the bug - the setup is visible in this commit https://github.com/morgoth/async-autoload/commit/ed3a76c96cdc46903761226b30db6175f8bf680e\r\n\r\nSo the problem is that when autoloading some class inside the async tasks, the class is properly loaded only once and all other invocations are failed.\r\n\r\nAs simple as:\r\n```ruby\r\nAsync do |task|\r\n  3.times do |i|\r\n    task.async do\r\n      MyModel.run_something # Problems with autloading\r\n    rescue => e\r\n      puts e\r\n    end\r\n  end\r\nend.wait\r\n```\r\n\r\nI tried to produce a simple Zeitwerk script to present a failure, but I couldn't so somehow I can reproduce it in the Rails app only.\r\n\r\nIt can be workaround by manually requiring the file that should be autoloaded or by setting `config.eager_load = true` in the Rails app.\r\n\r\nI guess the \"async\" gem is the simplest way to parallelize something, but using it within the Rails app causes such problems, so it might not be that easy to popularize it in the Rails community.\r\n\r\nMy env:\r\nruby 3.1.1p18\r\nasync-2.0.1\r\nrails-7.0.2.3\r\nzeitwerk-2.5.4\r\n\r\nThis was originally reported on the zeitwerk repo https://github.com/fxn/zeitwerk/issues/214 but we came to conclusion that it has to be some Rails issue as we cannot reproduce this bug with pure zeitwerk.\r\n\r\nFYI @fxn @ioquatix @bruno-","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44751/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44751/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44745","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44745/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44745/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44745/events","html_url":"https://github.com/rails/rails/issues/44745","id":1176989513,"node_id":"I_kwDNIULORidvSQ","number":44745,"title":"`ActiveRecord::QueryMethods#in_order_of` error when passing an out-of-range Integer","user":{"login":"tejanium","id":1259814,"node_id":"MDQ6VXNlcjEyNTk4MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/1259814?v=4","gravatar_id":"","url":"https://api.github.com/users/tejanium","html_url":"https://github.com/tejanium","followers_url":"https://api.github.com/users/tejanium/followers","following_url":"https://api.github.com/users/tejanium/following{/other_user}","gists_url":"https://api.github.com/users/tejanium/gists{/gist_id}","starred_url":"https://api.github.com/users/tejanium/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tejanium/subscriptions","organizations_url":"https://api.github.com/users/tejanium/orgs","repos_url":"https://api.github.com/users/tejanium/repos","events_url":"https://api.github.com/users/tejanium/events{/privacy}","received_events_url":"https://api.github.com/users/tejanium/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-22T16:03:53Z","updated_at":"2022-06-29T14:23:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhen we pass an out-of-range integer to `in_order_of`, it will raise an `ActiveModel::RangeError` error.\r\n\r\n```ruby\r\n[1] pry(main)> Post.in_order_of(:id, [1, 9999999999999])\r\nActiveModel::RangeError: 9999999999999 is out of range for ActiveModel::Type::Integer with limit 4 bytes\r\n\r\n[2] pry(main)> Post.in_order_of(:id, [\"1\", \"9999999999999\"])\r\nActiveModel::RangeError: 9999999999999 is out of range for ActiveModel::Type::Integer with limit 4 bytes\r\n```\r\n\r\nBelow is the runnable script\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  # Fail\r\n  def test_out_of_range\r\n    post = Post.create!\r\n    out_of_range_id = Post.type_for_attribute(:id).send(:max_value)\r\n\r\n    assert_equal Post.in_order_of(:id, [post.id, out_of_range_id]).map(&:id), [post.id]\r\n  end\r\n\r\n  # Success\r\n  def test_where_with_out_of_range\r\n    post = Post.create!\r\n    out_of_range_id = Post.type_for_attribute(:id).send(:max_value)\r\n\r\n    assert_equal Post.where(id: [post.id, out_of_range_id]).map(&:id), [post.id]\r\n  end\r\n\r\n  def test_with_invalid_ids\r\n    post = Post.create!\r\n\r\n    assert_equal Post.where(id: [post.id, -1, :foo, \"bar\"]).map(&:id), [post.id]\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe Enumerable version will ignore it\r\n\r\n```ruby\r\n[3] pry(main)> [ Post.find(5), Post.find(3), Post.find(1) ].in_order_of(:id, [ 1, 5, 9999999999999 ]).map(&:id)\r\n=> [1, 5]\r\n```\r\n\r\nso does `where`\r\n\r\n```ruby\r\n[4] pry(main)> Post.where(id: [1, 9999999999999]).map(&:id)\r\n=> [1]\r\n```\r\n\r\nand `in_order_of` with non-existent value\r\n\r\n```ruby\r\n[5] pry(main)> Post.in_order_of(:id, [1, -1, :foo, \"bar\"]).map(&:id)\r\n=> [1]\r\n```\r\n\r\ntherefore, `in_order_of` should ignore out-of-range value\r\n\r\n### Actual behavior\r\n\r\nRaise an `ActiveModel::RangeError` error\r\n\r\n### System configuration\r\n\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 2.7.5p203\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44745/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44745/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/44743","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44743/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44743/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44743/events","html_url":"https://github.com/rails/rails/issues/44743","id":1176529739,"node_id":"I_kwDNIULORiBrSw","number":44743,"title":"params.to_yaml fails with TypeError (can't dump anonymous module ) in Rails 7","user":{"login":"RogerE","id":92803,"node_id":"MDQ6VXNlcjkyODAz","avatar_url":"https://avatars.githubusercontent.com/u/92803?v=4","gravatar_id":"","url":"https://api.github.com/users/RogerE","html_url":"https://github.com/RogerE","followers_url":"https://api.github.com/users/RogerE/followers","following_url":"https://api.github.com/users/RogerE/following{/other_user}","gists_url":"https://api.github.com/users/RogerE/gists{/gist_id}","starred_url":"https://api.github.com/users/RogerE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RogerE/subscriptions","organizations_url":"https://api.github.com/users/RogerE/orgs","repos_url":"https://api.github.com/users/RogerE/repos","events_url":"https://api.github.com/users/RogerE/events{/privacy}","received_events_url":"https://api.github.com/users/RogerE/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-22T09:48:44Z","updated_at":"2022-03-23T16:01:52Z","closed_at":"2022-03-23T15:46:38Z","author_association":"NONE","active_lock_reason":null,"body":"After upgrading to Rails 7 doing params.to_yaml in a controller fails with TypeError (can't dump anonymous module ). Works in Rails 6.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    post \"/\" => \"test#index\"\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    params_yaml = params.to_yaml\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"rack/test\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    post '/', params: { custom: \"a\", item_number: \"123\" }\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nSubmited parameters should be returned as YAML\r\n\r\n### Actual behavior\r\nRequest fails with TypeError (can't dump anonymous module ) \r\n\r\n### System configuration\r\n**Rails version**: example code is with branch: \"main\" (Affects all version from 7.0.0 and up as far as I can tell)\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44743/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44743/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44742","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44742/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44742/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44742/events","html_url":"https://github.com/rails/rails/issues/44742","id":1176354070,"node_id":"I_kwDNIULORh29Fg","number":44742,"title":"Inconsistent nil handling in ActiveRecord railtie.rb","user":{"login":"dssjoblom","id":12595797,"node_id":"MDQ6VXNlcjEyNTk1Nzk3","avatar_url":"https://avatars.githubusercontent.com/u/12595797?v=4","gravatar_id":"","url":"https://api.github.com/users/dssjoblom","html_url":"https://github.com/dssjoblom","followers_url":"https://api.github.com/users/dssjoblom/followers","following_url":"https://api.github.com/users/dssjoblom/following{/other_user}","gists_url":"https://api.github.com/users/dssjoblom/gists{/gist_id}","starred_url":"https://api.github.com/users/dssjoblom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dssjoblom/subscriptions","organizations_url":"https://api.github.com/users/dssjoblom/orgs","repos_url":"https://api.github.com/users/dssjoblom/repos","events_url":"https://api.github.com/users/dssjoblom/events{/privacy}","received_events_url":"https://api.github.com/users/dssjoblom/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":384913768,"node_id":"MDU6TGFiZWwzODQ5MTM3Njg=","url":"https://api.github.com/repos/rails/rails/labels/good%20first%20issue","name":"good first issue","color":"0e8a16","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-22T07:04:21Z","updated_at":"2022-03-31T11:43:40Z","closed_at":"2022-03-31T11:43:40Z","author_association":"NONE","active_lock_reason":null,"body":"See https://github.com/rails/rails/blob/main/activerecord/lib/active_record/railtie.rb#L146\r\n\r\n```\r\nfilename = ActiveRecord::Tasks::DatabaseTasks.cache_dump_filename(\r\n  db_config.name,\r\n  schema_cache_path: db_config&.schema_cache_path\r\n)\r\n```\r\n\r\nThis should either raise an error if db_config is nil or navigate safely, not both. The second safe navigation does nothing.\r\n\r\n**Rails version**: main branch","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44742/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44742/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44741","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44741/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44741/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44741/events","html_url":"https://github.com/rails/rails/issues/44741","id":1176283937,"node_id":"I_kwDNIULORhyrIQ","number":44741,"title":"Default scope erroneously sets attributes","user":{"login":"dchacke","id":2866749,"node_id":"MDQ6VXNlcjI4NjY3NDk=","avatar_url":"https://avatars.githubusercontent.com/u/2866749?v=4","gravatar_id":"","url":"https://api.github.com/users/dchacke","html_url":"https://github.com/dchacke","followers_url":"https://api.github.com/users/dchacke/followers","following_url":"https://api.github.com/users/dchacke/following{/other_user}","gists_url":"https://api.github.com/users/dchacke/gists{/gist_id}","starred_url":"https://api.github.com/users/dchacke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dchacke/subscriptions","organizations_url":"https://api.github.com/users/dchacke/orgs","repos_url":"https://api.github.com/users/dchacke/repos","events_url":"https://api.github.com/users/dchacke/events{/privacy}","received_events_url":"https://api.github.com/users/dchacke/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2022-03-22T05:25:12Z","updated_at":"2022-03-23T20:37:21Z","closed_at":"2022-03-23T05:05:18Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Assuming you have a boolean attribute `:foo` on a model, add the following `default_scope` to that model:\r\n\r\n```ruby\r\ndefault_scope -> { where(foo: true) }\r\n```\r\n\r\n2. Observe that new instances of the affected model have `:foo` set to `true` by default:\r\n\r\n```ruby\r\nModel.new\r\n=> #<Model id: nil, foo: true>\r\n```\r\n\r\n### Expected behavior\r\n\r\n```ruby\r\nModel.new\r\n=> #<Model id: nil, foo: false>\r\n                         ^\r\n```\r\n\r\n### Actual behavior\r\n\r\n```ruby\r\nModel.new\r\n=> #<Model id: nil, foo: true>\r\n                         ^\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.1.1\r\n**Ruby version**: 2.6.5\r\n\r\n### Notes\r\n\r\nI do not see why a `default_scope` using a conditional for retrieving subsets from a db table should mutate an in-memory model instance in any way. The observed behavior leads to a particularly egregious inconsistency when the db schema is set to `default: false` for the affected attribute.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44741/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44741/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44738","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44738/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44738/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44738/events","html_url":"https://github.com/rails/rails/issues/44738","id":1175672140,"node_id":"I_kwDNIULORhNVTA","number":44738,"title":"Missing Association Does Not Raise MissingAttributeError","user":{"login":"Neilshweky","id":8226355,"node_id":"MDQ6VXNlcjgyMjYzNTU=","avatar_url":"https://avatars.githubusercontent.com/u/8226355?v=4","gravatar_id":"","url":"https://api.github.com/users/Neilshweky","html_url":"https://github.com/Neilshweky","followers_url":"https://api.github.com/users/Neilshweky/followers","following_url":"https://api.github.com/users/Neilshweky/following{/other_user}","gists_url":"https://api.github.com/users/Neilshweky/gists{/gist_id}","starred_url":"https://api.github.com/users/Neilshweky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Neilshweky/subscriptions","organizations_url":"https://api.github.com/users/Neilshweky/orgs","repos_url":"https://api.github.com/users/Neilshweky/repos","events_url":"https://api.github.com/users/Neilshweky/events{/privacy}","received_events_url":"https://api.github.com/users/Neilshweky/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-21T17:00:22Z","updated_at":"2022-07-20T16:34:52Z","closed_at":"2022-06-26T18:22:16Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI have found unexpected behavior when trying to reference an association that was not in the \"select\" projection. Take the following code: \r\n```\r\nclass User < ActiveRecord::Base\r\n  self.table_name = 'user'\r\n\r\n  has_one :address\r\n  has_many :homes\r\nend\r\n\r\nclass Address < ActiveRecord::Base\r\n  self.table_name = 'address'\r\n\r\n  belongs_to :user\r\nend\r\n\r\nclass Home < ActiveRecord::Base\r\n  self.table_name = 'homes'\r\n\r\n  belongs_to :user\r\nend\r\n\r\nuser = User.create!(name: \"Sam\", age:12)\r\nuser.address = Address.new\r\nuser.homes = [Home.new]\r\nuser.save\r\n\r\nu = User.select(:name).first\r\nputs u.name # Sam\r\nputs u.address # nil\r\nputs u.homes # []\r\nputs u.age # MissingAttributeError\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nMy expected behavior would be:\r\n```\r\nu = User.select(:name).first\r\n> u.name \r\nSam \r\n> u.address\r\n# => raise MissingAttributeError\r\n> u.homes\r\n# => raise MissingAttributeError\r\n> u.age\r\n# => raise MissingAttributeError\r\n```\r\n\r\n### Actual behavior\r\n```\r\nu = User.select(:name).first\r\n> u.name \r\nSam \r\n> u.address\r\n# => nil\r\n> u.homes\r\n# => #<ActiveRecord::Associations::CollectionProxy []>\r\n> u.age\r\n# => raise MissingAttributeError\r\n```\r\nFor some reason, when referencing associations that were not selected, they return `nil` or `[]`, and they do not raise a MissingAttributeError. Is this working as intended?\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44738/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44738/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44737","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44737/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44737/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44737/events","html_url":"https://github.com/rails/rails/issues/44737","id":1175659369,"node_id":"I_kwDNIULORhMjaQ","number":44737,"title":"Abnormal query executes if ActiveRecord scope has OR clause.","user":{"login":"oohyun15","id":52606560,"node_id":"MDQ6VXNlcjUyNjA2NTYw","avatar_url":"https://avatars.githubusercontent.com/u/52606560?v=4","gravatar_id":"","url":"https://api.github.com/users/oohyun15","html_url":"https://github.com/oohyun15","followers_url":"https://api.github.com/users/oohyun15/followers","following_url":"https://api.github.com/users/oohyun15/following{/other_user}","gists_url":"https://api.github.com/users/oohyun15/gists{/gist_id}","starred_url":"https://api.github.com/users/oohyun15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oohyun15/subscriptions","organizations_url":"https://api.github.com/users/oohyun15/orgs","repos_url":"https://api.github.com/users/oohyun15/repos","events_url":"https://api.github.com/users/oohyun15/events{/privacy}","received_events_url":"https://api.github.com/users/oohyun15/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-21T16:49:35Z","updated_at":"2022-07-04T12:15:12Z","closed_at":"2022-07-04T12:15:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nYou can checkout this issue from [here](https://github.com/oohyun15/activerecord-scoping).\r\n\r\nor\r\n\r\n```ruby\r\nclass Post < ApplicationRecord\r\n  has_many :comments\r\n\r\n  scope :scope1, -> {\r\n    left_joins(:comments)\r\n    .where(status: 'open')\r\n    .or(where(comments: { status: 'open' }))\r\n  }\r\n\r\n  scope :scope2, -> {\r\n    left_joins(:comments)\r\n    .where(status: 'open')\r\n    .or(Comment.where(status: 'open'))\r\n  }\r\nend\r\n\r\nclass Comment < ApplicationRecord\r\n  belongs_to :post\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nI confirmed that `scope1` and `scope2` are the same query.\r\n\r\n```ruby\r\nPost.scope1.to_sql\r\n=> \"SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE (`posts`.`status` = 'open' OR `comments`.`status` = 'open')\"\r\n\r\nPost.scope2.to_sql\r\n=> \"SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE (`posts`.`status` = 'open' OR `comments`.`status` = 'open')\"\r\n\r\nPost.scope1.to_sql == Post.scope2.to_sql\r\n=> true\r\n```\r\n\r\nSo, I expected same query even if there is another where clause in front of scope.\r\n\r\n```ruby\r\nPost.where(id: [1, 2, 3]).scope1.to_sql == Post.where(id: [1, 2, 3]).scope2.to_sql\r\n...\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nUnlike my expectation, queries are not same if there is another where clause in front of scope.\r\n\r\n```ruby\r\nPost.where(id: [1, 2, 3]).scope1.to_sql\r\n=> \"SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id`\" \\\r\n   \"WHERE `posts`.`id` IN (1, 2, 3) AND (`posts`.`status` = 'open' OR `comments`.`status` = 'open')\"\r\n\r\nPost.where(id: [1, 2, 3]).scope2.to_sql\r\n=> \"SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id`\" \\\r\n   \"WHERE (`posts`.`id` IN (1, 2, 3) AND `posts`.`status` = 'open' OR `comments`.`status` = 'open')\"\r\n\r\nPost.where(id: [1, 2, 3]).scope1.to_sql == Post.where(id: [1, 2, 3]).scope2.to_sql\r\n=> false\r\n```\r\n\r\nAs you can see, bracket position is different. I wonder if this result was intended.\r\n\r\n**note1**: if use `merge` method between where and `scope2`, result is same as `scope1`'s query.\r\n```ruby\r\nPost.where(id: [1, 2, 3]).scope1.to_sql == Post.where(id: [1, 2, 3]).merge(Post.scope2).to_sql\r\n=> true\r\n```\r\n**note2**: if `scope2` calls before where clause, result is same as `scope1`'s query.\r\n```ruby\r\nPost.scope1.where(id: [1, 2, 3]).to_sql == Post.scope2.where(id: [1, 2, 3]).to_sql\r\n=> true\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3 (also 6.1.4.4)\r\n\r\n**Ruby version**: 2.7.4\r\n\r\nThanks, rails.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44737/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44737/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44736","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44736/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44736/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44736/events","html_url":"https://github.com/rails/rails/issues/44736","id":1175484588,"node_id":"I_kwDNIULORhB4rA","number":44736,"title":"Incorrect documentation on IntegrationTest header setting","user":{"login":"chaffeqa","id":287640,"node_id":"MDQ6VXNlcjI4NzY0MA==","avatar_url":"https://avatars.githubusercontent.com/u/287640?v=4","gravatar_id":"","url":"https://api.github.com/users/chaffeqa","html_url":"https://github.com/chaffeqa","followers_url":"https://api.github.com/users/chaffeqa/followers","following_url":"https://api.github.com/users/chaffeqa/following{/other_user}","gists_url":"https://api.github.com/users/chaffeqa/gists{/gist_id}","starred_url":"https://api.github.com/users/chaffeqa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chaffeqa/subscriptions","organizations_url":"https://api.github.com/users/chaffeqa/orgs","repos_url":"https://api.github.com/users/chaffeqa/repos","events_url":"https://api.github.com/users/chaffeqa/events{/privacy}","received_events_url":"https://api.github.com/users/chaffeqa/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-21T14:39:09Z","updated_at":"2022-03-21T15:43:56Z","closed_at":"2022-03-21T15:40:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n- section https://github.com/rails/rails/blob/main/guides/source/testing.md#functional-tests-for-your-controllers explains how the keyword `headers` can be passed to `process` method\r\n- `process` method does not accept that keyword: https://github.com/rails/rails/blob/de53ba56cab69fb9707785a397a59ac4aaee9d6f/actionpack/lib/action_controller/test_case.rb#L474\r\n\r\n\r\n\r\n### Solution options:\r\n\r\n- Add support for keyword\r\n- Change rails guide\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44736/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44736/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44735","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44735/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44735/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44735/events","html_url":"https://github.com/rails/rails/issues/44735","id":1175483924,"node_id":"I_kwDNIULORhB2FA","number":44735,"title":"Detecting if context is db:migrate (or other rake task) depends on executed command ","user":{"login":"dssjoblom","id":12595797,"node_id":"MDQ6VXNlcjEyNTk1Nzk3","avatar_url":"https://avatars.githubusercontent.com/u/12595797?v=4","gravatar_id":"","url":"https://api.github.com/users/dssjoblom","html_url":"https://github.com/dssjoblom","followers_url":"https://api.github.com/users/dssjoblom/followers","following_url":"https://api.github.com/users/dssjoblom/following{/other_user}","gists_url":"https://api.github.com/users/dssjoblom/gists{/gist_id}","starred_url":"https://api.github.com/users/dssjoblom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dssjoblom/subscriptions","organizations_url":"https://api.github.com/users/dssjoblom/orgs","repos_url":"https://api.github.com/users/dssjoblom/repos","events_url":"https://api.github.com/users/dssjoblom/events{/privacy}","received_events_url":"https://api.github.com/users/dssjoblom/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-21T14:38:39Z","updated_at":"2022-03-23T23:32:35Z","closed_at":"2022-03-23T23:32:21Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate an initializer that contains `puts ARGV`.\r\n\r\nRun\r\n\r\n`bundle exec rake db:migrate`\r\n\r\nand \r\n\r\n`rails db:migrate`\r\n\r\nFor more info on the use case, see https://stackoverflow.com/questions/1858230/how-to-check-if-rails-code-is-running-within-a-migration. \r\n\r\n### Expected behavior\r\n\r\nBoth should produce the same output (db:migrate), and it has been the behavior earlier in Rails 5.1. Also, if there is an official way of detecting the context it would be nice if it was clearly documented somewhere.\r\n\r\n### Actual behavior\r\n\r\nIn Rails 6.1, the latter command outputs nothing.\r\n\r\n### System configuration\r\n\r\n**Rails version**: 6.1.4.7 vs. 5.1.7\r\n\r\n**Ruby version**: ruby 2.7.5p203\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44735/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44735/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44731","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44731/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44731/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44731/events","html_url":"https://github.com/rails/rails/issues/44731","id":1174537679,"node_id":"I_kwDNIULORgIFzw","number":44731,"title":"Postgresql references/belongs_to column columns are created as integer in migration version 6.0","user":{"login":"BoKleynen","id":25830774,"node_id":"MDQ6VXNlcjI1ODMwNzc0","avatar_url":"https://avatars.githubusercontent.com/u/25830774?v=4","gravatar_id":"","url":"https://api.github.com/users/BoKleynen","html_url":"https://github.com/BoKleynen","followers_url":"https://api.github.com/users/BoKleynen/followers","following_url":"https://api.github.com/users/BoKleynen/following{/other_user}","gists_url":"https://api.github.com/users/BoKleynen/gists{/gist_id}","starred_url":"https://api.github.com/users/BoKleynen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BoKleynen/subscriptions","organizations_url":"https://api.github.com/users/BoKleynen/orgs","repos_url":"https://api.github.com/users/BoKleynen/repos","events_url":"https://api.github.com/users/BoKleynen/events{/privacy}","received_events_url":"https://api.github.com/users/BoKleynen/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-20T12:54:32Z","updated_at":"2022-03-20T19:14:02Z","closed_at":"2022-03-20T19:14:02Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nSince rails 6.1.5 adding a reference in a migration version 6.0 creates `integer` columns instead of `bigint` columns in a postgresql database. \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"6.1.5\"\r\n  gem 'pg'\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\nrequire \"rails/command\"\r\n\r\nActiveRecord::Base.establish_connection(\r\n  adapter:  \"postgresql\",\r\n  host:     \"localhost\",\r\n  username: \"\",     # TODO: Replace with actual username\r\n  password: \"\",     # TODO: Replace with actual password\r\n  database: \"somedatabase\"\r\n)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\nend\r\n\r\nclass Invoice < ActiveRecord::Base\r\nend\r\n\r\nclass Payment < ActiveRecord::Base\r\nend\r\n\r\nclass Migration < ActiveRecord::Migration[6.0]\r\n  def change\r\n    create_table :invoices\r\n\r\n    create_table :payments do |t|\r\n      t.references :invoice\r\n    end\r\n\r\n    # these inserts are needed to be able to use pg_typeof\r\n    invoice = Invoice.create!\r\n    Payment.create!(invoice_id: invoice.id)\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_migration_up\r\n    Migration.migrate(:up)\r\n\r\n    result = ActiveRecord::Base.connection.execute(<<~SQL)\r\n      SELECT pg_typeof(invoice_id)\r\n      FROM payments\r\n      LIMIT 1;\r\n    SQL\r\n\r\n    assert_equal \"bigint\", result.first[\"pg_typeof\"]\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n`t.references :invoice` should create a column `invoice_id` of type `bigint`\r\n\r\n### Actual behavior\r\n `t.references :invoice` creates a column of type `integer`\r\n\r\n### System configuration\r\n**Rails version**: 6.1.5\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44731/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44731/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44729","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44729/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44729/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44729/events","html_url":"https://github.com/rails/rails/issues/44729","id":1174495978,"node_id":"I_kwDNIULORgFi6g","number":44729,"title":"Rails quits after creating a rich text entry with an image in the database.","user":{"login":"Shetty-Tejas","id":74608924,"node_id":"MDQ6VXNlcjc0NjA4OTI0","avatar_url":"https://avatars.githubusercontent.com/u/74608924?v=4","gravatar_id":"","url":"https://api.github.com/users/Shetty-Tejas","html_url":"https://github.com/Shetty-Tejas","followers_url":"https://api.github.com/users/Shetty-Tejas/followers","following_url":"https://api.github.com/users/Shetty-Tejas/following{/other_user}","gists_url":"https://api.github.com/users/Shetty-Tejas/gists{/gist_id}","starred_url":"https://api.github.com/users/Shetty-Tejas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shetty-Tejas/subscriptions","organizations_url":"https://api.github.com/users/Shetty-Tejas/orgs","repos_url":"https://api.github.com/users/Shetty-Tejas/repos","events_url":"https://api.github.com/users/Shetty-Tejas/events{/privacy}","received_events_url":"https://api.github.com/users/Shetty-Tejas/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-03-20T10:15:50Z","updated_at":"2022-06-29T00:02:04Z","closed_at":"2022-06-29T00:02:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n1. Installing ActionText.\r\n2. Installing libvips, ruby-vips, ruby-ffi\r\n3. Adding config.active_storage.variant_processor = :vips to config/application.rb\r\n4. Adding has_rich_text :body to my Post.rb\r\n5. Adding the trix editor on the new post form.\r\n6. Adding a post with an image through the form.\r\n```\r\n\r\n### Expected behavior\r\nShould save the post and redirect to the newly created post page while rails continues to work.\r\n\r\n### Actual behavior\r\nRails saves the post and after redirection, the rails server crashes without any error.\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.2.2\r\n\r\n**Ruby version**:\r\nruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [x64-mingw-ucrt]\r\n\r\n### Log before crash\r\n```\r\nStarted GET \"/posts/new\" for 127.0.0.1 at 2022-03-20 15:32:43 +0530\r\nProcessing by PostsController#new as HTML\r\n  Rendering layout layouts/application.html.erb\r\n  Rendering posts/new.html.erb within layouts/application\r\n  Rendered posts/new.html.erb within layouts/application (Duration: 90.2ms | Allocations: 12092)\r\n  Rendered components/_navbar.html.erb (Duration: 0.1ms | Allocations: 53)\r\n  Rendered layout layouts/application.html.erb (Duration: 110.0ms | Allocations: 17229)\r\nCompleted 200 OK in 116ms (Views: 111.6ms | ActiveRecord: 0.0ms | Allocations: 17669)\r\n\r\n\r\nStarted POST \"/rails/active_storage/direct_uploads\" for 127.0.0.1 at 2022-03-20 15:32:49 +0530\r\nProcessing by ActiveStorage::DirectUploadsController#create as JSON\r\n  Parameters: {\"blob\"=>{\"filename\"=>\"Untitled.png\", \"content_type\"=>\"image/png\", \"byte_size\"=>67712, \"checksum\"=>\"JSkbfD1/qYR3jiMSQ4StXw==\"}, \"direct_upload\"=>{\"blob\"=>{\"filename\"=>\"Untitled.png\", \"content_type\"=>\"image/png\", \"byte_size\"=>67712, \"checksum\"=>\"JSkbfD1/qYR3jiMSQ4StXw==\"}}}\r\n  TRANSACTION (0.1ms)  begin transaction\r\n  ActiveStorage::Blob Create (1.8ms)  INSERT INTO \"active_storage_blobs\" (\"key\", \"filename\", \"content_type\", \"metadata\", \"service_name\", \"byte_size\", \"checksum\", \"created_at\") VALUES (?, ?, \r\n?, ?, ?, ?, ?, ?)  [[\"key\", \"yg3tcj8az8wejmz1hc0baej8cb6l\"], [\"filename\", \"Untitled.png\"], [\"content_type\", \"image/png\"], [\"metadata\", nil], [\"service_name\", \"local\"], [\"byte_size\", 67712], \r\n[\"checksum\", \"JSkbfD1/qYR3jiMSQ4StXw==\"], [\"created_at\", \"2022-03-20 10:02:49.678370\"]]        \r\n  TRANSACTION (4.8ms)  commit transaction\r\n  Disk Storage (0.9ms) Generated URL for file at key: yg3tcj8az8wejmz1hc0baej8cb6l (http://localhost:3000/rails/active_storage/disk/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdDam9JYTJWNVNTSWhlV2N6ZEdOcU9HRjZPSGRsYW0xNk1XaGpNR0poWldvNFkySTJiQVk2QmtWVU9oRmpiMjUwWlc1MFgzUjVjR1ZKSWc1cGJXRm5aUzl3Ym1jR093WlVPaE5qYjI1MFpXNTBYMnhsYm1kMGFHa0RnQWdCT2cxamFHVmphM04xYlVraUhVcFRhMkptUkRFdmNWbFNNMnBwVFZOUk5GTjBXSGM5UFFZN0JsUTZFWE5sY25acFkyVmZibUZ0WlRvS2JHOWpZV3c9IiwiZXhwIjoiMjAyMi0wMy0yMFQxMDowNzo0OS42OTRaIiwicHVyIjoiYmxvYl90b2tlbiJ9fQ==--dc343ddf348a3fa46f8d8b59c26e68893ed5ae00)       \r\nCompleted 200 OK in 27ms (Views: 0.6ms | ActiveRecord: 6.7ms | Allocations: 4744)\r\n\r\n\r\nStarted PUT \"/rails/active_storage/disk/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdDam9JYTJWNVNTSWhlV2N6ZEdOcU9HRjZPSGRsYW0xNk1XaGpNR0poWldvNFkySTJiQVk2QmtWVU9oRmpiMjUwWlc1MFgzUjVjR1ZKSWc1cGJXRm5aUzl3Ym1jR093WlVPaE5qYjI1MFpXNTBYMnhsYm1kMGFHa0RnQWdCT2cxamFHVmphM04xYlVraUhVcFRhMkptUkRFdmNWbFNNMnBwVFZOUk5GTjBXSGM5UFFZN0JsUTZFWE5sY25acFkyVmZibUZ0WlRvS2JHOWpZV3c9IiwiZXhwIjoiMjAyMi0wMy0yMFQxMDowNzo0OS42OTRaIiwicHVyIjoiYmxvYl90b2tlbiJ9fQ==--dc343ddf348a3fa46f8d8b59c26e68893ed5ae00\" for 127.0.0.1 at 2022-03-20 15:32:49 +0530\r\nProcessing by ActiveStorage::DiskController#update as */*\r\n  Parameters: {\"encoded_token\"=>\"[FILTERED]\"}\r\n  Disk Storage (5.0ms) Uploaded file to key: yg3tcj8az8wejmz1hc0baej8cb6l (checksum: JSkbfD1/qYR3jiMSQ4StXw==)\r\nCompleted 204 No Content in 13ms (ActiveRecord: 0.0ms | Allocations: 497)\r\n\r\n\r\nStarted GET \"/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBIdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--50e4c4426007be24eaa37994d19f26672b7c16aa/Untitled.png\" for 127.0.0.1 at 2022-03-20 15:32:49 +0530\r\nProcessing by ActiveStorage::Blobs::RedirectController#show as PNG\r\n  Parameters: {\"signed_id\"=>\"eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBIdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--50e4c4426007be24eaa37994d19f26672b7c16aa\", \"filename\"=>\"Untitled\"}\r\n   (0.1ms)  SELECT sqlite_version(*)\r\n  ActiveStorage::Blob Load (0.3ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  Disk Storage (1.1ms) Generated URL for file at key: yg3tcj8az8wejmz1hc0baej8cb6l (http://localhost:3000/rails/active_storage/disk/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdDVG9JYTJWNVNTSWhlV2N6ZEdOcU9HRjZPSGRsYW0xNk1XaGpNR0poWldvNFkySTJiQVk2QmtWVU9oQmthWE53YjNOcGRHbHZia2tpUTJsdWJHbHVaVHNnWm1sc1pXNWhiV1U5SWxWdWRHbDBiR1ZrTG5CdVp5STdJR1pwYkdWdVlXMWxLajFWVkVZdE9DY25WVzUwYVhSc1pXUXVjRzVuQmpzR1ZEb1JZMjl1ZEdWdWRGOTBlWEJsU1NJT2FXMWhaMlV2Y0c1bkJqc0dWRG9SYzJWeWRtbGpaVjl1WVcxbE9ncHNiMk5oYkE9PSIsImV4cCI6IjIwMjItMDMtMjBUMTA6MDc6NDkuOTg1WiIsInB1ciI6ImJsb2Jfa2V5In19--3335eeeb5946484b14537c654c35e2c04294fddf/Untitled.png)\r\nRedirected to http://localhost:3000/rails/active_storage/disk/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdDVG9JYTJWNVNTSWhlV2N6ZEdOcU9HRjZPSGRsYW0xNk1XaGpNR0poWldvNFkySTJiQVk2QmtWVU9oQmthWE53YjNOcGRHbHZia2tpUTJsdWJHbHVaVHNnWm1sc1pXNWhiV1U5SWxWdWRHbDBiR1ZrTG5CdVp5STdJR1pwYkdWdVlXMWxLajFWVkVZdE9DY25WVzUwYVhSc1pXUXVjRzVuQmpzR1ZEb1JZMjl1ZEdWdWRGOTBlWEJsU1NJT2FXMWhaMlV2Y0c1bkJqc0dWRG9SYzJWeWRtbGpaVjl1WVcxbE9ncHNiMk5oYkE9PSIsImV4cCI6IjIwMjItMDMtMjBUMTA6MDc6NDkuOTg1WiIsInB1ciI6ImJsb2Jfa2V5In19--3335eeeb5946484b14537c654c35e2c04294fddf/Untitled.png\r\nCompleted 302 Found in 15ms (ActiveRecord: 0.9ms | Allocations: 1939)\r\n\r\n\r\nStarted GET \"/rails/active_storage/disk/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdDVG9JYTJWNVNTSWhlV2N6ZEdOcU9HRjZPSGRsYW0xNk1XaGpNR0poWldvNFkySTJiQVk2QmtWVU9oQmthWE53YjNOcGRHbHZia2tpUTJsdWJHbHVaVHNnWm1sc1pXNWhiV1U5SWxWdWRHbDBiR1ZrTG5CdVp5STdJR1pwYkdWdVlXMWxLajFWVkVZdE9DY25WVzUwYVhSc1pXUXVjRzVuQmpzR1ZEb1JZMjl1ZEdWdWRGOTBlWEJsU1NJT2FXMWhaMlV2Y0c1bkJqc0dWRG9SYzJWeWRtbGpaVjl1WVcxbE9ncHNiMk5oYkE9PSIsImV4cCI6IjIwMjItMDMtMjBUMTA6MDc6NDkuOTg1WiIsInB1ciI6ImJsb2Jfa2V5In19--3335eeeb5946484b14537c654c35e2c04294fddf/Untitled.png\" for 127.0.0.1 at 2022-03-20 15:32:50 +0530\r\nProcessing by ActiveStorage::DiskController#show as PNG\r\n  Parameters: {\"encoded_key\"=>\"[FILTERED]\", \"filename\"=>\"Untitled\"}\r\nCompleted 200 OK in 4ms (ActiveRecord: 0.0ms | Allocations: 198)\r\n\r\n\r\nStarted POST \"/posts\" for 127.0.0.1 at 2022-03-20 15:33:05 +0530\r\nProcessing by PostsController#create as TURBO_STREAM\r\n  Parameters: {\"authenticity_token\"=>\"[FILTERED]\", \"post\"=>{\"title\"=>\"asdfaljdsf\", \"body\"=>\"<div>asdfasdfasdf<figure data-trix-attachment=\\\"{&quot;contentType&quot;:&quot;image/png&quot;,&quot;filename&quot;:&quot;Untitled.png&quot;,&quot;filesize&quot;:67712,&quot;height&quot;:391,&quot;sgid&quot;:&quot;BAh7CEkiCGdpZAY6BkVUSSI6Z2lkOi8vZ3V5cy13aG8tY29kZS9BY3RpdmVTdG9yYWdlOjpCbG9iLzI2P2V4cGlyZXNfaW4GOwBUSSIMcHVycG9zZQY7AFRJIg9hdHRhY2hhYmxlBjsAVEkiD2V4cGlyZXNfYXQGOwBUMA==--3f7a9f38b00731822e370a0629ee34084018e38b&quot;,&quot;url&quot;:&quot;http://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBIdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--50e4c4426007be24eaa37994d19f26672b7c16aa/Untitled.png&quot;,&quot;width&quot;:375}\\\" data-trix-content-type=\\\"image/png\\\" data-trix-attributes=\\\"{&quot;presentation&quot;:&quot;gallery&quot;}\\\" class=\\\"attachment attachment--preview attachment--png\\\"><img src=\\\"http://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBIdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--50e4c4426007be24eaa37994d19f26672b7c16aa/Untitled.png\\\" width=\\\"375\\\" height=\\\"391\\\"><figcaption class=\\\"attachment__caption\\\"><span class=\\\"attachment__name\\\">Untitled.png</span> <span class=\\\"attachment__size\\\">66.13 KB</span></figcaption></figure></div>\"}, \"commit\"=>\"Create Post\"}\r\n   (0.1ms)  SELECT sqlite_version(*)\r\n  ↳ app/controllers/posts_controller.rb:15:in `create'\r\n  TRANSACTION (0.0ms)  begin transaction\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActiveStorage::Blob Load (0.3ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  CACHE ActiveStorage::Blob Load (0.0ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  CACHE ActiveStorage::Blob Load (0.0ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  CACHE ActiveStorage::Blob Load (0.0ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/models/post.rb:8:in `body_length'\r\n  Post Create (1.7ms)  INSERT INTO \"posts\" (\"title\", \"created_at\", \"updated_at\") VALUES (?, ?, \r\n?)  [[\"title\", \"asdfaljdsf\"], [\"created_at\", \"2022-03-20 10:03:05.969215\"], [\"updated_at\", \"2022-03-20 10:03:05.969215\"]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActiveStorage::Blob Load (0.1ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActionText::RichText Create (0.5ms)  INSERT INTO \"action_text_rich_texts\" (\"name\", \"body\", \"record_type\", \"record_id\", \"created_at\", \"updated_at\") VALUES (?, ?, ?, ?, ?, ?)  [[\"name\", \"body\"], [\"body\", \"<div>asdfasdfasdf<action-text-attachment sgid=\\\"BAh7CEkiCGdpZAY6BkVUSSI6Z2lkOi8vZ3V5cy13aG8tY29kZS9BY3RpdmVTdG9yYWdlOjpCbG9iLzI2P2V4cGlyZXNfaW4GOwBUSSIMcHVycG9zZQY7AFRJIg9hdHRhY2hhYmxlBjsAVEkiD2V4cGlyZXNfYXQGOwBUMA==--3f7a9f38b00731822e370a0629ee34084018e38b\\\" content-type=\\\"image/png\\\" url=\\\"http://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBIdz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--50e4c4426007be24eaa37994d19f26672b7c16aa/Untitled.png\\\" filename=\\\"Untitled.png\\\" filesize=\\\"67712\\\" width=\\\"375\\\" height=\\\"391\\\" presentation=\\\"gallery\\\"></action-text-attachment></div>\"], [\"record_type\", \"Post\"], [\"record_id\", 20], [\"created_at\", \"2022-03-20 10:03:06.009179\"], [\"updated_at\", \"2022-03-20 10:03:06.009179\"]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActiveStorage::Blob Load (0.1ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActiveStorage::Blob Update (0.3ms)  UPDATE \"active_storage_blobs\" SET \"metadata\" = ? WHERE \"active_storage_blobs\".\"id\" = ?  [[\"metadata\", \"{\\\"identified\\\":true}\"], [\"id\", 26]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActiveStorage::Attachment Create (0.5ms)  INSERT INTO \"active_storage_attachments\" (\"name\", \"record_type\", \"record_id\", \"blob_id\", \"created_at\") VALUES (?, ?, ?, ?, ?)  [[\"name\", \"embeds\"], [\"record_type\", \"ActionText::RichText\"], [\"record_id\", 20], [\"blob_id\", 26], [\"created_at\", \"2022-03-20 10:03:06.032143\"]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  Post Update (0.1ms)  UPDATE \"posts\" SET \"updated_at\" = ? WHERE \"posts\".\"id\" = ?  [[\"updated_at\", \"2022-03-20 10:03:06.037194\"], [\"id\", 20]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  ActionText::RichText Update (0.1ms)  UPDATE \"action_text_rich_texts\" SET \"updated_at\" = ? WHERE \"action_text_rich_texts\".\"id\" = ?  [[\"updated_at\", \"2022-03-20 10:03:06.036584\"], [\"id\", 20]]\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n  TRANSACTION (5.8ms)  commit transaction\r\n  ↳ app/controllers/posts_controller.rb:16:in `create'\r\n[ActiveJob] Enqueued ActiveStorage::AnalyzeJob (Job ID: 20f7d9f4-4915-4db6-ad45-9214c5df56f0) to Async(default) with arguments: #<GlobalID:0x0000019f6a5745f8 @uri=#<URI::GID gid://guys-who-code/ActiveStorage::Blob/26>>\r\nRedirected to http://localhost:3000/posts/20\r\nCompleted 302 Found in 140ms (ActiveRecord: 10.4ms | Allocations: 39718)\r\n\r\n\r\nStarted GET \"/posts/20\" for 127.0.0.1 at 2022-03-20 15:33:06 +0530\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0]   ActiveStorage::Blob Load (0.2ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0] Performing ActiveStorage::AnalyzeJob (Job ID: 20f7d9f4-4915-4db6-ad45-9214c5df56f0) from Async(default) enqueued at 2022-03-20T10:03:06Z with arguments: #<GlobalID:0x0000019f6a5b8c08 @uri=#<URI::GID gid://guys-who-code/ActiveStorage::Blob/26>>\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0]   Disk Storage (4.1ms) Downloaded file from key: yg3tcj8az8wejmz1hc0baej8cb6l\r\nProcessing by PostsController#show as TURBO_STREAM\r\n  Parameters: {\"id\"=>\"20\"}\r\n  Post Load (0.5ms)  SELECT \"posts\".* FROM \"posts\" WHERE \"posts\".\"id\" = ? LIMIT ?  [[\"id\", 20], [\"LIMIT\", 1]]\r\n  ↳ app/controllers/posts_controller.rb:3:in `show'\r\n  Rendering layout layouts/application.html.erb\r\n  Rendering posts/show.html.erb within layouts/application\r\n  ActionText::RichText Load (0.5ms)  SELECT \"action_text_rich_texts\".* FROM \"action_text_rich_texts\" WHERE \"action_text_rich_texts\".\"record_id\" = ? AND \"action_text_rich_texts\".\"record_type\" = ? AND \"action_text_rich_texts\".\"name\" = ? LIMIT ?  [[\"record_id\", 20], [\"record_type\", \"Post\"], [\"name\", \"body\"], [\"LIMIT\", 1]]\r\n  ↳ app/views/posts/show.html.erb:12\r\n  ActiveStorage::Blob Load (0.3ms)  SELECT \"active_storage_blobs\".* FROM \"active_storage_blobs\" WHERE \"active_storage_blobs\".\"id\" = ? LIMIT ?  [[\"id\", 26], [\"LIMIT\", 1]]\r\n  ↳ app/views/posts/show.html.erb:12\r\n  Rendered active_storage/blobs/_blob.html.erb (Duration: 0.9ms | Allocations: 496)\r\n  Rendered C:/Ruby31-x64/lib/ruby/gems/3.1.0/gems/actiontext-7.0.2.2/app/views/action_text/contents/_content.html.erb within layouts/action_text/contents/_content (Duration: 8.1ms | Allocations: 3912)\r\n  Rendered posts/show.html.erb within layouts/application (Duration: 17.1ms | Allocations: 6114)\r\n  Rendered layout layouts/application.html.erb (Duration: 53.0ms | Allocations: 15288)\r\n\r\n\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0]   TRANSACTION (0.1ms)  begin transaction\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0]   ActiveStorage::Blob Update (2.1ms)  UPDATE \"active_storage_blobs\" SET \"metadata\" = ? WHERE \"active_storage_blobs\".\"id\" = ?  [[\"metadata\", \"{\\\"identified\\\":true,\\\"width\\\":375,\\\"height\\\":391,\\\"analyzed\\\":true}\"], [\"id\", 26]]\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0]   TRANSACTION (4.6ms)  commit transaction\r\n[ActiveJob] [ActiveStorage::AnalyzeJob] [20f7d9f4-4915-4db6-ad45-9214c5df56f0] Performed ActiveStorage::AnalyzeJob (Job ID: 20f7d9f4-4915-4db6-ad45-9214c5df56f0) from Async(default) in 578.03ms\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44729/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44729/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44721","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44721/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44721/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44721/events","html_url":"https://github.com/rails/rails/issues/44721","id":1174019679,"node_id":"I_kwDNIULORfoeXw","number":44721,"title":"rails server does not work","user":{"login":"InakiGT","id":62358280,"node_id":"MDQ6VXNlcjYyMzU4Mjgw","avatar_url":"https://avatars.githubusercontent.com/u/62358280?v=4","gravatar_id":"","url":"https://api.github.com/users/InakiGT","html_url":"https://github.com/InakiGT","followers_url":"https://api.github.com/users/InakiGT/followers","following_url":"https://api.github.com/users/InakiGT/following{/other_user}","gists_url":"https://api.github.com/users/InakiGT/gists{/gist_id}","starred_url":"https://api.github.com/users/InakiGT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/InakiGT/subscriptions","organizations_url":"https://api.github.com/users/InakiGT/orgs","repos_url":"https://api.github.com/users/InakiGT/repos","events_url":"https://api.github.com/users/InakiGT/events{/privacy}","received_events_url":"https://api.github.com/users/InakiGT/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null},{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-03-18T21:04:42Z","updated_at":"2022-04-07T00:02:29Z","closed_at":"2022-04-07T00:02:29Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrails -v #Rails 7.0.2.3\r\nrails server\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nRails server would works normally\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nIn console shows that the pocess was killed\r\n`[2]    9854 killed     rails server`\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.3\r\n\r\n**Ruby version**: 2.7.1p83\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44721/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44721/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44719","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44719/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44719/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44719/events","html_url":"https://github.com/rails/rails/issues/44719","id":1173624815,"node_id":"I_kwDNIULORfQX7w","number":44719,"title":"reverse_sql_order fails to reverse reversible order","user":{"login":"sebastianiorga","id":7011617,"node_id":"MDQ6VXNlcjcwMTE2MTc=","avatar_url":"https://avatars.githubusercontent.com/u/7011617?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianiorga","html_url":"https://github.com/sebastianiorga","followers_url":"https://api.github.com/users/sebastianiorga/followers","following_url":"https://api.github.com/users/sebastianiorga/following{/other_user}","gists_url":"https://api.github.com/users/sebastianiorga/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianiorga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianiorga/subscriptions","organizations_url":"https://api.github.com/users/sebastianiorga/orgs","repos_url":"https://api.github.com/users/sebastianiorga/repos","events_url":"https://api.github.com/users/sebastianiorga/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianiorga/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-03-18T13:59:12Z","updated_at":"2022-03-18T17:20:41Z","closed_at":"2022-03-18T17:20:41Z","author_association":"NONE","active_lock_reason":null,"body":"The way `ActiveRecord::QueryMethods#reverse_sql_order` and `ActiveRecord::QueryMethods#does_not_support_reverse?` test for reversibility/perform it, breaks in cases like \r\n\r\n```\r\n scope :evens_first_with_comma, lambda {\r\n    custom_ordering = <<~SQL\r\n      CASE\r\n        WHEN (category IN (0, 2))\r\n        THEN\r\n          category\r\n        ELSE category + 100\r\n      END ASC\r\n    SQL\r\n\r\n    order(Arel.sql(custom_ordering))\r\n  }\r\n```\r\n\r\nbecause they split on the comma in `IN (0, 2)`. Presumably, that split is intended to check for function calls or something. \r\n\r\nOrdering by `CASE` works when built via Arel, which I think is the proper way to do it anyway. I just wasn't aware Arel could do this when I first wrote the code that triggered the bug. \r\n\r\nI figured I'd raise an issue in case someone else was googling around due to this bug.\r\n\r\nNot sure what a good way to fix this would be, probably not worth fixing and adding more complexity to `reverse_sql_order`, tbh.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Fails in 5.2 and 6.1.5\r\n  gem \"rails\", '~> 5.2'\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.integer :category\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  scope :evens_first_with_comma, lambda {\r\n    custom_ordering = <<~SQL\r\n      CASE\r\n        WHEN (category IN (0, 2))\r\n        THEN\r\n          category\r\n        ELSE category + 100\r\n      END ASC\r\n    SQL\r\n\r\n    order(Arel.sql(custom_ordering))\r\n  }\r\n\r\n  scope :evens_first_without_comma, lambda {\r\n    custom_ordering = <<~SQL\r\n      CASE\r\n        WHEN (category = 0) OR (category = 2)\r\n        THEN\r\n          category\r\n        ELSE category + 100\r\n      END ASC\r\n    SQL\r\n\r\n    order(Arel.sql(custom_ordering))\r\n  }\r\n\r\n  scope :evens_first_with_arel_case, lambda {\r\n    posts = arel_table\r\n    custom_ordering = Arel::Nodes::Case\r\n                        .new\r\n                        .when(posts[:category].in([0, 2])).then(posts[:category])\r\n                        .else(posts[:category] + 200)\r\n\r\n    order(custom_ordering)\r\n  }\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post3 = Post.create! category: 3\r\n    post2 = Post.create! category: 2\r\n    post0 = Post.create! category: 0\r\n    post1 = Post.create! category: 1\r\n\r\n    assert_equal Post.evens_first_without_comma.to_a, [post0, post2, post1, post3]\r\n    assert_equal Post.evens_first_without_comma.reverse.to_a, [post0, post2, post1, post3].reverse\r\n    assert_equal Post.evens_first_without_comma.last(2), [post1, post3]\r\n\r\n    # Arel version works, and produces the same SQL\r\n    assert_equal Post.evens_first_with_arel_case.to_a, [post0, post2, post1, post3]\r\n    assert_equal Post.evens_first_with_arel_case.reverse.to_a, [post0, post2, post1, post3].reverse\r\n    assert_equal Post.evens_first_with_arel_case.last(2), [post1, post3]\r\n\r\n    assert_equal Post.evens_first_with_comma.to_a, [post0, post2, post1, post3]\r\n    assert_equal Post.evens_first_with_comma.reverse.to_a, [post0, post2, post1, post3].reverse\r\n    puts 'The next 1 will error'\r\n    assert_equal Post.evens_first_with_comma.last(2), [post1, post3]\r\n    # raises\r\n\r\n    # Error:\r\n    # BugTest#test_association_stuff:\r\n    # ActiveRecord::IrreversibleOrderError: Order \"CASE\\n  WHEN (category IN (0, 2))\\n  THEN\\n    category\\n  ELSE category + 100\\nEND ASC\\n\" can not be reversed automatically\r\n  end\r\nend\r\n\r\n# Problem code is below(from rails/AR 5.2.x):\r\n#\r\n#\r\n# module ActiveRecord\r\n#   module QueryMethods\r\n#     def reverse_sql_order(order_query)\r\n#       if order_query.empty?\r\n#         return [arel_attribute(primary_key).desc] if primary_key\r\n#         raise IrreversibleOrderError,\r\n#           \"Relation has no current order and table has no primary key to be used as default order\"\r\n#       end\r\n\r\n#       order_query.flat_map do |o|\r\n#         case o\r\n#         when Arel::Attribute\r\n#           o.desc\r\n#         when Arel::Nodes::Ordering\r\n#           o.reverse\r\n#         when String\r\n#           if does_not_support_reverse?(o)\r\n#             raise IrreversibleOrderError, \"Order #{o.inspect} can not be reversed automatically\"\r\n#           end\r\n#           o.split(\",\").map! do |s|\r\n#             s.strip!\r\n#             s.gsub!(/\\sasc\\Z/i, \" DESC\") || s.gsub!(/\\sdesc\\Z/i, \" ASC\") || (s << \" DESC\")\r\n#           end\r\n#         else\r\n#           o\r\n#         end\r\n#       end\r\n#     end\r\n\r\n#     def does_not_support_reverse?(order)\r\n#       # Account for String subclasses like Arel::Nodes::SqlLiteral that\r\n#       # override methods like #count.\r\n#       order = String.new(order) unless order.instance_of?(String)\r\n\r\n#       # Uses SQL function with multiple arguments.\r\n#       (order.include?(\",\") && order.split(\",\").find { |section| section.count(\"(\") != section.count(\")\") }) ||\r\n#         # Uses \"nulls first\" like construction.\r\n#         /nulls (first|last)\\Z/i.match?(order)\r\n#     end\r\n#   end\r\n# end\r\n```\r\n\r\n### Expected behavior\r\nAll the asserts should pass.\r\n\r\n### Actual behavior\r\nThe last assert triggers `IrreversibleOrderError`\r\n\r\n### System configuration\r\n**Rails version**: Checked on 5.2/6.1.5/7.0\r\n\r\n**Ruby version**: 2.5.1/2.7\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44719/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44719/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44713","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44713/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44713/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44713/events","html_url":"https://github.com/rails/rails/issues/44713","id":1172164480,"node_id":"I_kwDNIULORd3PgA","number":44713,"title":"Using `update` inside a transaction behaves differently when used in tests ","user":{"login":"richardboehme","id":61323346,"node_id":"MDQ6VXNlcjYxMzIzMzQ2","avatar_url":"https://avatars.githubusercontent.com/u/61323346?v=4","gravatar_id":"","url":"https://api.github.com/users/richardboehme","html_url":"https://github.com/richardboehme","followers_url":"https://api.github.com/users/richardboehme/followers","following_url":"https://api.github.com/users/richardboehme/following{/other_user}","gists_url":"https://api.github.com/users/richardboehme/gists{/gist_id}","starred_url":"https://api.github.com/users/richardboehme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/richardboehme/subscriptions","organizations_url":"https://api.github.com/users/richardboehme/orgs","repos_url":"https://api.github.com/users/richardboehme/repos","events_url":"https://api.github.com/users/richardboehme/events{/privacy}","received_events_url":"https://api.github.com/users/richardboehme/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-03-17T09:59:09Z","updated_at":"2022-06-15T19:58:33Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n* Clone [webit-de/rails-dirty-transaction-update](https://github.com/webit-de/rails-dirty-transaction-update)\r\n* Bundle\r\n* Update database.yml to your needs (only tested with postgresql)\r\n* Run `rails test test/models/test_object_test.rb`\r\n* Run `rails runner test_transactions.rb`\r\n\r\n**Note**: I tried using the ActiveRecord bug report template but I could not get the test case to behave like a 'normal' Rails test case (that uses transactional tests).\r\n\r\n### Expected behavior\r\nThe test and the script should print the same values for the updated database field (`test2`). It should not matter whether we use `update` or assign the attribute and use `save`.\r\n\r\n### Actual behavior\r\nThe test will print `test` for the version that uses the `update` method and `test2` for the version that uses an assign and a save.\r\nI'm not sure if this is an actual bug or expected behavior, but it took me a lot of time to figure out why my test case was not failing (but fails on prod/dev). \r\n\r\nI'm not into the internals of ActiveRecord but looking into the source of `update` I saw that there will be an additional transaction state remembered for the model (using `with_transaction_returning_status` which calls `remember_transaction_record_state`) when using `update`. Maybe this results in some invalid state if the update-transaction is shared with a business logic transaction above? \r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 2.7.0\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44713/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44713/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44711","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44711/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44711/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44711/events","html_url":"https://github.com/rails/rails/issues/44711","id":1171956833,"node_id":"I_kwDNIULORdqkYQ","number":44711,"title":"Visit enum value before type cast within ActiveRecord model instance method get unexpected result.","user":{"login":"zw963","id":549126,"node_id":"MDQ6VXNlcjU0OTEyNg==","avatar_url":"https://avatars.githubusercontent.com/u/549126?v=4","gravatar_id":"","url":"https://api.github.com/users/zw963","html_url":"https://github.com/zw963","followers_url":"https://api.github.com/users/zw963/followers","following_url":"https://api.github.com/users/zw963/following{/other_user}","gists_url":"https://api.github.com/users/zw963/gists{/gist_id}","starred_url":"https://api.github.com/users/zw963/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zw963/subscriptions","organizations_url":"https://api.github.com/users/zw963/orgs","repos_url":"https://api.github.com/users/zw963/repos","events_url":"https://api.github.com/users/zw963/events{/privacy}","received_events_url":"https://api.github.com/users/zw963/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-03-17T05:42:18Z","updated_at":"2022-06-16T14:57:22Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\ncreate a enum field in User model.\r\n\r\n```rb\r\n  enum moment_expires_in_seconds: {\r\n         'last_3_days' => 259200,\r\n         'last_month' => 2592000,\r\n         'last_6_months' => 15552000,\r\n         'all' => 0\r\n       }, _prefix: true\r\n```\r\n\r\n# Your reproduction script goes here\r\n\r\nFollowing is a screenshot for make describe more simpler, Following is some context:\r\n\r\n1. the breaking point is stop on a instance method in User model, so the self is a User model instance, that is why assert self == User.find(self.id) is pass\r\n2. But `self.moment_expires_in_seconds_before_type_cast` get different result as `user.moment_expires_in_seconds_before_type_cast`\r\n\r\n![image](https://user-images.githubusercontent.com/549126/158744077-46cb4038-612a-4a58-8845-cfb5074536ba.png)\r\n\r\n\r\n### Expected behavior\r\n\r\nWhen visit `moment_expires_in_seconds_before_type_cast` in model instance variable, i expected it return `259200`, as returned value when invoke from `user` instead self.\r\n\r\n### Actual behavior\r\n\r\nself.moment_expires_in_seconds_before_type_cast # => last_3_days  unexpected result.\r\nself.moment_expires_in_seconds_before_type_cast # => 259200, expected result.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n6.1.4.4\r\n\r\n**Ruby version**:\r\n3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44711/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44711/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44701","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44701/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44701/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44701/events","html_url":"https://github.com/rails/rails/issues/44701","id":1170832253,"node_id":"I_kwDNIULORcl7fQ","number":44701,"title":"Rails Credentials Merge Conflitcts Proposal","user":{"login":"itay-grudev","id":2123767,"node_id":"MDQ6VXNlcjIxMjM3Njc=","avatar_url":"https://avatars.githubusercontent.com/u/2123767?v=4","gravatar_id":"","url":"https://api.github.com/users/itay-grudev","html_url":"https://github.com/itay-grudev","followers_url":"https://api.github.com/users/itay-grudev/followers","following_url":"https://api.github.com/users/itay-grudev/following{/other_user}","gists_url":"https://api.github.com/users/itay-grudev/gists{/gist_id}","starred_url":"https://api.github.com/users/itay-grudev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/itay-grudev/subscriptions","organizations_url":"https://api.github.com/users/itay-grudev/orgs","repos_url":"https://api.github.com/users/itay-grudev/repos","events_url":"https://api.github.com/users/itay-grudev/events{/privacy}","received_events_url":"https://api.github.com/users/itay-grudev/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-16T10:32:16Z","updated_at":"2022-03-16T16:21:06Z","closed_at":"2022-03-16T16:21:05Z","author_association":"NONE","active_lock_reason":null,"body":"Rails Credentials are great for a lot of purposes, but merge conflicts are really annoying to resolve even with the included tools. But if we were to restructure how they work we could enable git to auto-resolve conflicts.\r\n\r\nTo that end I propose we convert the file from one big encrypted chunk to lots of small encrypted keypairs. There are two approaches we could take:\r\n\r\n1. Keeps keys encrypted as well\r\n2. Maintain keys in plain text\r\n\r\nNote that we don't actually have to encrypt keys. Key names could be inferred from the code base of an application. Therefore keys are not secret - values are. This means that if we were to parse the file and only encrypt values\r\n\r\nIn both cases git would be able to match individual lines and apply diffs automatically as the lines around our changes would remain the same. But if keys were kept in plain text (PR/MR) reviews would be easier as developer could infer what was changes just by looking at the diff.\r\n\r\nThis presents a small problem, where someone with access to the code-base could be able to tamper credentials without having access to the key, but we can add an HMAC checksum at the end of the file or each keypair to validate contents and mitigate that.\r\n\r\nI don't believe such an approach decreases security even in the case of plain text keys since as I mentioned before - we already know the keys, we even have clues about the content of values from the code base. The only thing we are doing is making it possible for git to auto resolve changes.\r\n\r\nThis could potentially add two improvements:\r\n1. Git would be able to auto-resolve conflicts\r\n2. PR diffs would be able to show what key was changed (the value would be unintelligible).\r\n3. The credential file would be tamper-evident.\r\n\r\nI would like us to start a discussion about the next iteration of credential management so we could improve it for future versions.\r\n\r\nRelated to: #28038","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44701/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44701/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44700","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44700/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44700/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44700/events","html_url":"https://github.com/rails/rails/issues/44700","id":1170648685,"node_id":"I_kwDNIULORcaubQ","number":44700,"title":"Rails 7 occasionally produces <TypeError: nil can't be coerced into Float> on concurrent multiple requests","user":{"login":"n00bvn","id":6227607,"node_id":"MDQ6VXNlcjYyMjc2MDc=","avatar_url":"https://avatars.githubusercontent.com/u/6227607?v=4","gravatar_id":"","url":"https://api.github.com/users/n00bvn","html_url":"https://github.com/n00bvn","followers_url":"https://api.github.com/users/n00bvn/followers","following_url":"https://api.github.com/users/n00bvn/following{/other_user}","gists_url":"https://api.github.com/users/n00bvn/gists{/gist_id}","starred_url":"https://api.github.com/users/n00bvn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/n00bvn/subscriptions","organizations_url":"https://api.github.com/users/n00bvn/orgs","repos_url":"https://api.github.com/users/n00bvn/repos","events_url":"https://api.github.com/users/n00bvn/events{/privacy}","received_events_url":"https://api.github.com/users/n00bvn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-16T07:36:21Z","updated_at":"2022-03-16T15:46:04Z","closed_at":"2022-03-16T15:46:03Z","author_association":"NONE","active_lock_reason":null,"body":"I'm using latest Rails 7.0.2.3 API mode and the app is currently developing on development environment only.\r\n\r\n### Steps to reproduce\r\nWell because this happen occasionally, so I'm not sure about this... \r\nAnyway basically, my frontend app sends multiple requests at the same time to Rails backend.\r\nIf I delay those requests a bit to make them call to the backend in series, then everything is ok.\r\n\r\n### Expected behavior\r\nAll requests should go through. \r\n\r\n\r\n### Actual behavior\r\nBut occasionally, I got error `<TypeError: nil can't be coerced into Float>`\r\n\r\n\r\n### My investigations:\r\n- Firstly, I edit `puma.rb` config to get more details of the exception:\r\n```\r\nlowlevel_error_handler do |e|\r\n  puts \"EXCEPTION = #{e.inspect}\".red\r\n  puts \"TRACES = #{e.backtrace.inspect}\".red\r\nend\r\n```\r\n\r\n- Then I got these messages:\r\n```\r\nEXCEPTION = #<TypeError: nil can't be coerced into Float>\r\nTRACES = [\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/notifications/instrumenter.rb:133:in `-'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/notifications/instrumenter.rb:133:in `duration'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/core_ext/enumerable.rb:61:in `map'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/core_ext/enumerable.rb:61:in `sum'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/core_ext/enumerable.rb:298:in `sum'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/server_timing.rb:26:in `block in call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/server_timing.rb:25:in `each'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/server_timing.rb:25:in `map'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/server_timing.rb:25:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/executor.rb:14:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/static.rb:23:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/rack-2.2.3/lib/rack/sendfile.rb:110:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/actionpack-7.0.2.3/lib/action_dispatch/middleware/host_authorization.rb:137:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/rack-cors-1.1.1/lib/rack/cors.rb:100:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/railties-7.0.2.3/lib/rails/engine.rb:530:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/configuration.rb:252:in `call'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/request.rb:77:in `block in handle_request'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/thread_pool.rb:340:in `with_force_shutdown'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/request.rb:76:in `handle_request'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/server.rb:441:in `process_client'\",\r\n\"/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/puma-5.6.2/lib/puma/thread_pool.rb:147:in `block in spawn_thread'\"]\r\n```\r\n\r\n- Then I open the file `/Users/thaw/.rvm/gems/ruby-3.0.0@epitome/gems/activesupport-7.0.2.3/lib/active_support/notifications/instrumenter.rb` and added this to line 134, (`duration` method)\r\n`puts \"=============#{self.end} --- #{time}================\".red`\r\n\r\nAnd I got this message before above exception message `=============1647410890381.45 --- ================`\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2.3\r\n**Ruby version**:\r\n3.0.0\r\n**Puma version**:\r\n5.6.2\r\n\r\n\r\nI didn't have this error before upgrading to Rails 7.\r\nThanks a lot for all of your helps!","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44700/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44700/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44698","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44698/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44698/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44698/events","html_url":"https://github.com/rails/rails/issues/44698","id":1170207434,"node_id":"I_kwDNIULORb_yyg","number":44698,"title":"certificate verify failed (unspecified certificate verification error)","user":{"login":"seb-sykio","id":25477479,"node_id":"MDQ6VXNlcjI1NDc3NDc5","avatar_url":"https://avatars.githubusercontent.com/u/25477479?v=4","gravatar_id":"","url":"https://api.github.com/users/seb-sykio","html_url":"https://github.com/seb-sykio","followers_url":"https://api.github.com/users/seb-sykio/followers","following_url":"https://api.github.com/users/seb-sykio/following{/other_user}","gists_url":"https://api.github.com/users/seb-sykio/gists{/gist_id}","starred_url":"https://api.github.com/users/seb-sykio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seb-sykio/subscriptions","organizations_url":"https://api.github.com/users/seb-sykio/orgs","repos_url":"https://api.github.com/users/seb-sykio/repos","events_url":"https://api.github.com/users/seb-sykio/events{/privacy}","received_events_url":"https://api.github.com/users/seb-sykio/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-15T20:29:43Z","updated_at":"2022-03-16T21:59:28Z","closed_at":"2022-03-16T21:59:28Z","author_association":"NONE","active_lock_reason":null,"body":"hi\r\nafter upgrading from rails 6.1.5 to rails 7.0.2 (ruby 2.7.4)\r\nI got this error in production why sending email :\r\n\r\n`W, [2022-03-15T19:16:12.512442 #792956]  WARN -- : [c07b4560-8dcd-4d6e-85f1-71bb17804f8e] exception : SSL_connect returned=1 errno=0 state=error: certificate verify failed (unspecified certificate verification error)\r\nW, [2022-03-15T19:16:12.512491 #792956]  WARN -- : [c07b4560-8dcd-4d6e-85f1-71bb17804f8e] .rvm/rubies/ruby-2.7.4/lib/ruby/2.7.0/net/protocol.rb:44:in `connect_nonblock'\r\n.rvm/rubies/ruby-2.7.4/lib/ruby/2.7.0/net/protocol.rb:44:in `ssl_socket_connect'\r\nbundle/ruby/2.7.0/gems/net-smtp-0.3.1/lib/net/smtp.rb:673:in `tlsconnect'\r\nbundle/ruby/2.7.0/gems/net-smtp-0.3.1/lib/net/smtp.rb:649:in `do_start'\r\nbundle/ruby/2.7.0/gems/net-smtp-0.3.1/lib/net/smtp.rb:604:in `start'\r\nbundle/ruby/2.7.0/gems/mail-2.7.1/lib/mail/network/delivery_methods/smtp.rb:109:in `start_smtp_session'\r\nbundle/ruby/2.7.0/gems/mail-2.7.1/lib/mail/network/delivery_methods/smtp.rb:100:in `deliver!'\r\nbundle/ruby/2.7.0/gems/mail-2.7.1/lib/mail/message.rb:2159:in `do_delivery'\r\nbundle/ruby/2.7.0/gems/mail-2.7.1/lib/mail/message.rb:260:in `block in deliver'\r\nbundle/ruby/2.7.0/gems/actionmailer-7.0.2.3/lib/action_mailer/base.rb:565:in `block in deliver_mail'\r\nbundle/ruby/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/notifications.rb:206:in `block in instrument'\r\nbundle/ruby/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\nbundle/ruby/2.7.0/gems/activesupport-7.0.2.3/lib/active_support/notifications.rb:206:in `instrument'\r\nbundle/ruby/2.7.0/gems/actionmailer-7.0.2.3/lib/action_mailer/base.rb:563:in `deliver_mail'\r\nbundle/ruby/2.7.0/gems/mail-2.7.1/lib/mail/message.rb:260:in `deliver'\r\nbundle/ruby/2.7.0/gems/actionmailer-7.0.2.3/lib/action_mailer/message_delivery.rb:119:in `block in deliver_now'\r\nbundle/ruby/2.7.0/gems/actionmailer-7.0.2.3/lib/action_mailer/rescuable.rb:17:in `handle_exceptions'\r\nbundle/ruby/2.7.0/gems/actionmailer-7.0.2.3/lib/action_mailer/message_delivery.rb:118:in `deliver_now'\r\nbundle/ruby/2.7.0/gems/devise-4.8.1/lib/devise/models/authenticatable.rb:204:in `send_devise_notification'\r\nbundle/ruby/2.7.0/gems/devise-4.8.1/lib/devise/models/confirmable.rb:121:in `send_confirmation_instructions'\r\nbundle/ruby/2.7.0/gems/devise-4.8.1/lib/devise/models/confirmable.rb:136:in `block in resend_confirmation_instructions'\r\n`\r\nin  production.rb\r\n\r\n`  \r\n  config.action_mailer.smtp_settings = {\r\n    address: \"localhost\",\r\n    port: 25,\r\n    enable_starttls_auto: false,\r\n  }`\r\n  \r\n  i have tried with\r\n  `openssl_verify_mode: 'none'`\r\n  \r\n  but no difference\r\n  with previous version of rails it has always work fine.\r\n\r\ncan it be linked with gem net-smtp' which since to have change with rails 7 / ruby 3 ?\r\n  ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44698/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44698/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44687","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44687/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44687/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44687/events","html_url":"https://github.com/rails/rails/issues/44687","id":1168766343,"node_id":"I_kwDNIULORan1hw","number":44687,"title":"An error with sqlite3, i just made the skeleton and this error appeared","user":{"login":"Doyddin","id":50780056,"node_id":"MDQ6VXNlcjUwNzgwMDU2","avatar_url":"https://avatars.githubusercontent.com/u/50780056?v=4","gravatar_id":"","url":"https://api.github.com/users/Doyddin","html_url":"https://github.com/Doyddin","followers_url":"https://api.github.com/users/Doyddin/followers","following_url":"https://api.github.com/users/Doyddin/following{/other_user}","gists_url":"https://api.github.com/users/Doyddin/gists{/gist_id}","starred_url":"https://api.github.com/users/Doyddin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Doyddin/subscriptions","organizations_url":"https://api.github.com/users/Doyddin/orgs","repos_url":"https://api.github.com/users/Doyddin/repos","events_url":"https://api.github.com/users/Doyddin/events{/privacy}","received_events_url":"https://api.github.com/users/Doyddin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-14T18:39:56Z","updated_at":"2022-03-15T00:58:05Z","closed_at":"2022-03-15T00:58:04Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```bundle install\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nthe bundle installed and the app running\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nappears a error for every gem that uses activerecord which is ->\r\n```\r\nGem::Ext::BuildError: ERROR: Failed to build gem native extension.\r\n\r\ncurrent directory:\r\nC:/Ruby31-x64/lib/ruby/gems/3.1.0/gems/bootsnap-1.11.1/ext/bootsnap\r\nC:/Ruby31-x64/bin/ruby.exe -I C:/Ruby31-x64/lib/ruby/3.1.0 -r\r\n./siteconf20220314-9264-an0w4o.rb extconf.rb\r\ncreating Makefile\r\n\r\ncurrent directory:\r\nC:/Ruby31-x64/lib/ruby/gems/3.1.0/gems/bootsnap-1.11.1/ext/bootsnap\r\nmake DESTDIR\\= clean\r\n\r\ncurrent directory:\r\nC:/Ruby31-x64/lib/ruby/gems/3.1.0/gems/bootsnap-1.11.1/ext/bootsnap\r\nmake DESTDIR\\=\r\ngenerating bootsnap-x64-mingw-ucrt.def\r\ncompiling bootsnap.c\r\nmake: gcc: No such file or directory\r\nmake: *** [Makefile:246: bootsnap.o] Erro 127\r\n\r\nmake failed, exit code 2\r\n```\r\nand when i try \"gem pristine sqlite3 --version 1.4.2 this appears -> \r\n```\r\nRestoring gems to pristine condition...\r\nTemporarily enhancing PATH for MSYS/MINGW...\r\nUsing msys2 packages: mingw-w64-x86_64-sqlite3\r\nBuilding native extensions. This could take a while...\r\nERROR:  While executing gem ... (Gem::Ext::BuildError)\r\n    ERROR: Failed to build gem native extension.\r\n\r\n    current directory: C:/Ruby31-x64/lib/ruby/gems/3.1.0/gems/sqlite3-1.4.2/ext/sqlite3\r\nC:/Ruby31-x64/bin/ruby.exe -I C:/Ruby31-x64/lib/ruby/3.1.0 -r ./siteconf20220314-16176-wojw9e.rb extconf.rb\r\n*** extconf.rb failed ***\r\nCould not create Makefile due to some reason, probably lack of necessary\r\nlibraries and/or headers.  Check the mkmf.log file for more details.  You may\r\nneed configuration options.\r\n\r\nProvided configuration options:\r\n        --with-opt-dir\r\n        --without-opt-dir\r\n        --with-opt-include\r\n        --without-opt-include=${opt-dir}/include\r\n        --with-opt-lib\r\n        --without-opt-lib=${opt-dir}/lib\r\n        --with-make-prog\r\n        --without-make-prog\r\n        --srcdir=.\r\n        --curdir\r\n        --ruby=C:/Ruby31-x64/bin/$(RUBY_BASE_NAME)\r\n        --with-sqlcipher\r\n        --without-sqlcipher\r\n        --with-sqlite3-dir\r\n        --without-sqlite3-dir\r\n        --with-sqlite3-include\r\n        --without-sqlite3-include=${sqlite3-dir}/include\r\n        --with-sqlite3-lib\r\n        --without-sqlite3-lib=${sqlite3-dir}/lib\r\n        --with-sqlite3-config\r\n        --without-sqlite3-config\r\n        --with-pkg-config\r\n        --without-pkg-config\r\nC:/Ruby31-x64/lib/ruby/3.1.0/mkmf.rb:498:in `try_do': The compiler failed to generate an executable file. (RuntimeError)\r\nYou have to install development tools first.\r\n        from C:/Ruby31-x64/lib/ruby/3.1.0/mkmf.rb:591:in `try_link0'\r\n        from C:/Ruby31-x64/lib/ruby/3.1.0/mkmf.rb:609:in `try_link'\r\n        from C:/Ruby31-x64/lib/ruby/3.1.0/mkmf.rb:711:in `try_ldflags'\r\n        from C:/Ruby31-x64/lib/ruby/3.1.0/mkmf.rb:1895:in `pkg_config'\r\n        from extconf.rb:35:in `<main>'\r\n\r\nTo see why this extension failed to compile, please check the mkmf.log which can be found here:\r\n\r\n  C:/Ruby31-x64/lib/ruby/gems/3.1.0/extensions/x64-mingw-ucrt/3.1.0/sqlite3-1.4.2/mkmf.log\r\n\r\nextconf failed, exit code 1\r\n```\r\n### System configuration\r\n**Rails version**: 7.0.2.3\r\n\r\n**Ruby version**: 3.1.1p18\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44687/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44687/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44682","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44682/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44682/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44682/events","html_url":"https://github.com/rails/rails/issues/44682","id":1168069688,"node_id":"I_kwDNIULORZ9UOA","number":44682,"title":"Allow use of destroy_async directly on an ActiveRecord instead of only as an dependency","user":{"login":"sjieg","id":5168683,"node_id":"MDQ6VXNlcjUxNjg2ODM=","avatar_url":"https://avatars.githubusercontent.com/u/5168683?v=4","gravatar_id":"","url":"https://api.github.com/users/sjieg","html_url":"https://github.com/sjieg","followers_url":"https://api.github.com/users/sjieg/followers","following_url":"https://api.github.com/users/sjieg/following{/other_user}","gists_url":"https://api.github.com/users/sjieg/gists{/gist_id}","starred_url":"https://api.github.com/users/sjieg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sjieg/subscriptions","organizations_url":"https://api.github.com/users/sjieg/orgs","repos_url":"https://api.github.com/users/sjieg/repos","events_url":"https://api.github.com/users/sjieg/events{/privacy}","received_events_url":"https://api.github.com/users/sjieg/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-14T08:56:09Z","updated_at":"2022-03-16T16:22:08Z","closed_at":"2022-03-16T16:22:07Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nThis PR the desroy_async dependency has been added: https://github.com/rails/rails/pull/40157 great stuff!\r\nNow it seems like a reasonable step to add the same functionality directly to an ActiveRecord item\r\n\r\n```ruby\r\narticle = Article.first\r\ncomments = article.comments.all\r\ncomments.each(&:destroy_async)\r\n```\r\n\r\n### Expected behavior\r\n\r\nTo enqueue all the comments to be deleted using `activerecord/lib/active_record/destroy_association_async_job.rb`\r\n\r\n### Actual behavior\r\n\r\nThe method does not exist yet: `'method_missing': undefined method 'destroy_async'`\r\n\r\n### System configuration\r\n**Rails version**: `> 6.1` (locally running on 7.0)\r\n\r\n**Ruby version**: All supported (locally running on 3.0)\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44682/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44682/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44668","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44668/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44668/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44668/events","html_url":"https://github.com/rails/rails/issues/44668","id":1167130613,"node_id":"I_kwDNIULORZD_9Q","number":44668,"title":"TaggedLogging not broadcasting tags","user":{"login":"mtomiyoshi","id":1923650,"node_id":"MDQ6VXNlcjE5MjM2NTA=","avatar_url":"https://avatars.githubusercontent.com/u/1923650?v=4","gravatar_id":"","url":"https://api.github.com/users/mtomiyoshi","html_url":"https://github.com/mtomiyoshi","followers_url":"https://api.github.com/users/mtomiyoshi/followers","following_url":"https://api.github.com/users/mtomiyoshi/following{/other_user}","gists_url":"https://api.github.com/users/mtomiyoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/mtomiyoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mtomiyoshi/subscriptions","organizations_url":"https://api.github.com/users/mtomiyoshi/orgs","repos_url":"https://api.github.com/users/mtomiyoshi/repos","events_url":"https://api.github.com/users/mtomiyoshi/events{/privacy}","received_events_url":"https://api.github.com/users/mtomiyoshi/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-12T01:12:12Z","updated_at":"2022-09-08T16:04:16Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"This is similar to https://github.com/rails/rails/issues/43291, but I am calling the method with a block.\r\n\r\nWhen not using a block it works fine, demonstrated by the test mentioned in the issue: https://github.com/rails/rails/blob/f95c0b7e96eb36bc3efc0c5beffbb9e84ea664e4/activesupport/test/tagged_logging_test.rb#L221\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem 'rails', github: 'rails/rails', branch: 'main'\r\nend\r\n\r\nrequire 'active_support'\r\nrequire 'active_support/core_ext/object/blank'\r\nrequire 'minitest/autorun'\r\n\r\nclass BugTest < Minitest::Test\r\n  class MyLogger < ::ActiveSupport::Logger\r\n    def flush(*)\r\n      info '[FLUSHED]'\r\n    end\r\n  end\r\n\r\n  def test_keep_broadcast_with_block\r\n    @output = StringIO.new\r\n    @logger = ActiveSupport::TaggedLogging.new(MyLogger.new(@output))\r\n\r\n    broadcast_output = StringIO.new\r\n    broadcast_logger = ActiveSupport::TaggedLogging.new(Logger.new(broadcast_output))\r\n    @logger.extend(ActiveSupport::Logger.broadcast(broadcast_logger))\r\n\r\n    @logger.tagged('OMG') { |logger| logger.info 'Broadcasting...' }\r\n\r\n    assert_equal \"[OMG] Broadcasting...\\n\", @output.string\r\n    assert_equal \"[OMG] Broadcasting...\\n\", broadcast_output.string\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nBoth loggers should log `\"[OMG] Broadcasting...\\n\"`\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nOne of them logs `\"[OMG] Broadcasting...\\n\"`, the other logs `Broadcasting...\\n` instead.\r\n\r\nResult of the test script:\r\n\r\n```\r\nF\r\n\r\nFailure:\r\nBugTest#test_keep_broadcast_with_block [tagged_logger_bug.rb:50]:\r\n--- expected\r\n+++ actual\r\n@@ -1,2 +1,2 @@\r\n-\"[OMG] Broadcasting...\r\n+\"Broadcasting...\r\n \"\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.1.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44668/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44668/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/44667","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44667/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44667/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44667/events","html_url":"https://github.com/rails/rails/issues/44667","id":1166756352,"node_id":"I_kwDNIULORYtKAA","number":44667,"title":"stop explicitly setting sql_auto_is_null to zero","user":{"login":"xiankaing","id":22782357,"node_id":"MDQ6VXNlcjIyNzgyMzU3","avatar_url":"https://avatars.githubusercontent.com/u/22782357?v=4","gravatar_id":"","url":"https://api.github.com/users/xiankaing","html_url":"https://github.com/xiankaing","followers_url":"https://api.github.com/users/xiankaing/followers","following_url":"https://api.github.com/users/xiankaing/following{/other_user}","gists_url":"https://api.github.com/users/xiankaing/gists{/gist_id}","starred_url":"https://api.github.com/users/xiankaing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiankaing/subscriptions","organizations_url":"https://api.github.com/users/xiankaing/orgs","repos_url":"https://api.github.com/users/xiankaing/repos","events_url":"https://api.github.com/users/xiankaing/events{/privacy}","received_events_url":"https://api.github.com/users/xiankaing/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-11T19:01:01Z","updated_at":"2022-05-19T18:09:28Z","closed_at":"2022-05-19T18:09:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Why I'm raising this?\r\nRDS Proxy pins connections if you set variables like `sql_auto_is_null`\r\nThere is a setting to EXCLUDE_VARIABLE_SETS but it is global in nature (all variables).\r\nRDS Proxy allows scaling to many db connections from the rails perspective, without creating tonnes of actual db connections. AWS RDS MySQL maxes out at 16000 connections.\r\nvia https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Limits.html\r\n\r\n\r\n### Ask\r\nConsider removing `variables['sql_auto_is_null'] = 0` in \r\nhttps://github.com/rails/rails/blob/39a192f158e1c1093e830754036d8b9ab6da6a5e/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb#L791\r\nSince at least MySQL 5.7 this has been defaulted to false. \r\nhttps://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_sql_auto_is_null\r\nIt *was* defaulted to true in MySQL 5.0\r\nsee: https://downloads.mysql.com/docs/refman-5.0-en.pdf page 560 (search for `sql_auto_is_null`)\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 4.2.11.3\r\n**Ruby version**:\r\nruby 2.4.2p198 (2017-09-14 revision 59899) [x86_64-darwin19]\r\n\r\nBut this applies to everything using at least MySQL 5.7+ \r\nsince https://web.archive.org/web/20100315185851/http://dev.rubyonrails.org/ticket/6778 was fixed\r\n(over 10 years ago)\r\n\r\n```\r\n<h2 class=\"summary\" style=\"font-family: arial, verdana, &quot;Bitstream Vera Sans&quot;, helvetica, sans-serif; font-weight: bold; letter-spacing: -0.018em; font-size: 16px; margin: 0px 0px 0.8em; color: rgb(0, 0, 0); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\">PATCH] find :conditions =&gt; 'id is null' returns a record with a non-null id</h2>\r\n\r\nReported by: | timc | Assigned to: | bitsweat\r\n(https://web.archive.org/web/20100315185851/http://dev.rubyonrails.org/ticket/6778#comment:description)PATCH] find :conditions => 'id is null' returns a record with a non-null id\r\nReported by:\ttimc\tAssigned to:\tbitsweat\r\nPriority:\tnormal\tMilestone:\t1.2\r\nComponent:\tActiveRecord\tVersion:\t1.1.6\r\nSeverity:\tnormal\tKeywords:\tfind mysql null\r\nCc:\t\t\t\r\nDescription \r\nAa is an empty class, subclassing ActiveRecord::Base. It has one column called 'nothing'\r\n\r\na = Aa.new\r\n\r\n=> #<Aa:0xb723dacc @new_record=true, @attributes={\"nothing\"=>nil}>\r\n\r\na.save\r\n\r\n=> true\r\n\r\nAa.find(:first, :conditions => 'id is null')\r\n\r\n=> #<Aa:0xb7237050 @attributes={\"id\"=>\"3\", \"nothing\"=>nil}>\r\n\r\nAa.find(:first, :conditions => 'id is null')\r\n\r\n=> nil\r\n\r\nnote the two find calls are identical, but the first call returns an unexpected result.\r\n\r\nthe log says:\r\n\r\nSQL (0.000243) BEGIN SQL (0.000226) INSERT INTO aas (nothing) VALUES(NULL) SQL (0.003979) COMMIT Aa Load (0.001234) SELECT * FROM aas WHERE (id is null) LIMIT 1 Aa Load (0.000842) SELECT * FROM aas WHERE (id is null) LIMIT 1\r\n\r\nversion info: rails 1.1.6 mysql Ver 14.12 Distrib 5.0.26, for pc-linux-gnu (i686) using readline 5.1 mysql 2.7 gem Gentoo Linux\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44667/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44667/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44662","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44662/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44662/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44662/events","html_url":"https://github.com/rails/rails/issues/44662","id":1166601012,"node_id":"I_kwDNIULORYjrNA","number":44662,"title":"Incorrect url comment notes in generated scaffold controller in a namespace.","user":{"login":"qichunren","id":39784,"node_id":"MDQ6VXNlcjM5Nzg0","avatar_url":"https://avatars.githubusercontent.com/u/39784?v=4","gravatar_id":"","url":"https://api.github.com/users/qichunren","html_url":"https://github.com/qichunren","followers_url":"https://api.github.com/users/qichunren/followers","following_url":"https://api.github.com/users/qichunren/following{/other_user}","gists_url":"https://api.github.com/users/qichunren/gists{/gist_id}","starred_url":"https://api.github.com/users/qichunren/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qichunren/subscriptions","organizations_url":"https://api.github.com/users/qichunren/orgs","repos_url":"https://api.github.com/users/qichunren/repos","events_url":"https://api.github.com/users/qichunren/events{/privacy}","received_events_url":"https://api.github.com/users/qichunren/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-11T16:11:38Z","updated_at":"2022-03-14T16:40:52Z","closed_at":"2022-03-14T16:40:52Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\nrails new test_blog\r\ncd test_blog\r\n./bin/rails generate model Post title context:text\r\n./bin/rails g scaffold_controller Admin::Post title context:text --model-name=Post\r\n```\r\n\r\n### Expected behavior\r\n\r\nEvery generated url comment note should contain namespace prefix like: `# GET /admin/posts or /admin/posts.json`\r\n\r\n### Actual behavior\r\n\r\nEvery generated url comment note missing namespace prefix like: `# GET /posts or /posts.json`\r\n\r\n### System configuration\r\n**Rails version**: v7.0.2.2\r\n\r\n**Ruby version**: v3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44662/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44662/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44657","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44657/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44657/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44657/events","html_url":"https://github.com/rails/rails/issues/44657","id":1165116573,"node_id":"I_kwDNIULORXJEnQ","number":44657,"title":"Bug on url() in stylesheets","user":{"login":"paul-mesnilgrente","id":4416830,"node_id":"MDQ6VXNlcjQ0MTY4MzA=","avatar_url":"https://avatars.githubusercontent.com/u/4416830?v=4","gravatar_id":"","url":"https://api.github.com/users/paul-mesnilgrente","html_url":"https://github.com/paul-mesnilgrente","followers_url":"https://api.github.com/users/paul-mesnilgrente/followers","following_url":"https://api.github.com/users/paul-mesnilgrente/following{/other_user}","gists_url":"https://api.github.com/users/paul-mesnilgrente/gists{/gist_id}","starred_url":"https://api.github.com/users/paul-mesnilgrente/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paul-mesnilgrente/subscriptions","organizations_url":"https://api.github.com/users/paul-mesnilgrente/orgs","repos_url":"https://api.github.com/users/paul-mesnilgrente/repos","events_url":"https://api.github.com/users/paul-mesnilgrente/events{/privacy}","received_events_url":"https://api.github.com/users/paul-mesnilgrente/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-10T11:44:07Z","updated_at":"2022-03-10T12:46:57Z","closed_at":"2022-03-10T12:02:15Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI'm having troubles with the url() css function in my rails 7 project. I reproduced it on a brand new one: https://github.com/paul-mesnilgrente/rails-7-url, see this commit: https://github.com/paul-mesnilgrente/rails-7-url/commit/77e1379cd98827f43b02605852220cd3db93ce06\r\n\r\nYou can simple run this `bundle install; bin/rails db:setup; bin/dev` and then go to localhost:3000. You'll see red square, but it shouldn't be red, it should have a background image.\r\n\r\n### Expected behavior\r\n`background-image: url(images/background.jpg)` should be translated to something like `background-image: url(images/background-<digest_hash>.jpg)`. The translated path in the browser should give a 200.\r\n\r\n### Actual behavior\r\n`background-image: url(images/background.jpg)` is translated to `background-image: url(/images/background.jpg)` (note the `/` at the beginning. This path is giving a 404 in the browser.\r\n\r\nI tried several paths for this, like `/images/background.jpg` or `../images/background.jpg` but it's always only prefixing `/` to the path without digest.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2, project created with `rails new -j esbuild -c sass`\r\n\r\n**Ruby version**: 3.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44657/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44657/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44656","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44656/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44656/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44656/events","html_url":"https://github.com/rails/rails/issues/44656","id":1165076047,"node_id":"I_kwDNIULORXGmTw","number":44656,"title":"ActiveStorage::Variation (v5.2.6.3)> .validate_arg_string > undefined method .any? for nil:NilClass","user":{"login":"roms182","id":21283406,"node_id":"MDQ6VXNlcjIxMjgzNDA2","avatar_url":"https://avatars.githubusercontent.com/u/21283406?v=4","gravatar_id":"","url":"https://api.github.com/users/roms182","html_url":"https://github.com/roms182","followers_url":"https://api.github.com/users/roms182/followers","following_url":"https://api.github.com/users/roms182/following{/other_user}","gists_url":"https://api.github.com/users/roms182/gists{/gist_id}","starred_url":"https://api.github.com/users/roms182/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roms182/subscriptions","organizations_url":"https://api.github.com/users/roms182/orgs","repos_url":"https://api.github.com/users/roms182/repos","events_url":"https://api.github.com/users/roms182/events{/privacy}","received_events_url":"https://api.github.com/users/roms182/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2022-03-10T11:04:12Z","updated_at":"2022-03-11T07:49:33Z","closed_at":"2022-03-11T00:03:01Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nActiveStorage::Variation method .validate_arg_string raises an error :\r\n  undefined method `any?' for nil:NilClass\r\n\r\n  ```\r\n## ActiveStorage::Variation in activestorage (v5.2.6.3, rbenv 2.7.2) > models > active_storage > variation.rb\r\n\r\ndef validate_arg_string(argument)\r\n      if UNSUPPORTED_IMAGE_PROCESSING_ARGUMENTS.any? { |bad_arg| argument.to_s.downcase.include?(bad_arg) }; raise UnsupportedImageProcessingArgument end\r\n    end\r\n```\r\n\r\nThis constant is defined at the top of the class : \r\n\r\n```\r\n## ActiveStorage::Variation in activestorage (v5.2.6.3, rbenv 2.7.2) > models > active_storage > variation.rb\r\n\r\nUNSUPPORTED_IMAGE_PROCESSING_ARGUMENTS = ActiveStorage.unsupported_image_processing_arguments\r\n```\r\nActiveStorage.unsupported_image_processing_arguments is not null when checking its value in console. \r\n```\r\n$ ActiveStorage.unsupported_image_processing_arguments\r\n=> [\"-debug\", \"-display\", \"-distribute-cache\", \"-help\", \"-path\", \"-print\", \"-set\", \"-verbose\", \"-version\", \"-write\", \"-write-mask\"]\r\n```\r\n\r\nThis one is defined in engine within the initializer\r\n\r\n```\r\n## ActiveStorage::Variation in activestorage (v5.2.6.3, rbenv 2.7.2) > models > active_storage > engine.rb\r\ndefault_unsupported_image_processing_arguments = %w(\r\n      -debug\r\n      -display\r\n      -distribute-cache\r\n      -help\r\n      -path\r\n      -print\r\n      -set\r\n      -verbose\r\n      -version\r\n      -write\r\n      -write-mask\r\n    )\r\n\r\ninitializer \"active_storage.configs\" do\r\n      config.after_initialize do |app|\r\n        ActiveStorage.logger     = app.config.active_storage.logger || Rails.logger\r\n        ActiveStorage.queue      = app.config.active_storage.queue\r\n        ActiveStorage.previewers = app.config.active_storage.previewers || []\r\n        ActiveStorage.analyzers  = app.config.active_storage.analyzers || []\r\n        ActiveStorage.paths      = app.config.active_storage.paths || {}\r\n\r\n        ActiveStorage.supported_image_processing_methods = app.config.active_storage.supported_image_processing_methods || []\r\n        ActiveStorage.unsupported_image_processing_arguments = app.config.active_storage.unsupported_image_processing_arguments || default_unsupported_image_processing_arguments\r\n        ActiveStorage.variable_content_types = app.config.active_storage.variable_content_types || []\r\n        ActiveStorage.content_types_to_serve_as_binary = app.config.active_storage.content_types_to_serve_as_binary || []\r\n        ActiveStorage.content_types_allowed_inline = app.config.active_storage.content_types_allowed_inline || []\r\n        ActiveStorage.binary_content_type = app.config.active_storage.binary_content_type || \"application/octet-stream\"\r\n      end\r\n    end\r\n```\r\n\r\n\r\n### Expected behavior\r\nUNSUPPORTED_IMAGE_PROCESSING_ARGUMENTS should be loaded with the value of ActiveStorage.unsupported_image_processing_arguments, no ?\r\n\r\n### Actual behavior\r\nUNSUPPORTED_IMAGE_PROCESSING_ARGUMENTS is nil which raises an error\r\n\r\n### System configuration\r\nrails (5.2.6.3)\r\n      activestorage (= 5.2.6.3)\r\n**Ruby version**:\r\nruby '2.7.2'\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44656/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44656/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44652","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44652/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44652/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44652/events","html_url":"https://github.com/rails/rails/issues/44652","id":1164729661,"node_id":"I_kwDNIULORWxdPQ","number":44652,"title":"ActionCable: Repeated subscription attempts","user":{"login":"sj26","id":14028,"node_id":"MDQ6VXNlcjE0MDI4","avatar_url":"https://avatars.githubusercontent.com/u/14028?v=4","gravatar_id":"","url":"https://api.github.com/users/sj26","html_url":"https://github.com/sj26","followers_url":"https://api.github.com/users/sj26/followers","following_url":"https://api.github.com/users/sj26/following{/other_user}","gists_url":"https://api.github.com/users/sj26/gists{/gist_id}","starred_url":"https://api.github.com/users/sj26/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sj26/subscriptions","organizations_url":"https://api.github.com/users/sj26/orgs","repos_url":"https://api.github.com/users/sj26/repos","events_url":"https://api.github.com/users/sj26/events{/privacy}","received_events_url":"https://api.github.com/users/sj26/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-03-10T04:12:53Z","updated_at":"2022-09-06T08:40:59Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create an actioncable subscription.\r\n2. Await subscription confirmation.\r\n3. Create another subscription with the same identifier.\r\n4. Observe websocket showing subscription attempts every second.\r\n\r\nI tried creating a small reproduction script, but involving views and action cable got too complicated. Instead, here's an app which replicates it:\r\n\r\nhttps://github.com/sj26/action_cable_test\r\n\r\nIt creates two subscriptions with the same identifier, with a timeout to be sure that the first subscription has already been confirmed:\r\n\r\n```erb\r\n<div id=\"count\"></div>\r\n<%= javascript_tag do %>\r\n  window.App.consumer.subscriptions.create({channel: \"TestChannel\"}, {\r\n    received({ count }) {\r\n      document.getElementById(\"count\").innerText = count;\r\n    }\r\n  });\r\n<% end %>\r\n\r\n<div id=\"contents\"></div>\r\n<%= javascript_tag do %>\r\n  setTimeout(function() {\r\n    window.App.consumer.subscriptions.create({channel: \"TestChannel\"}, {\r\n      received({ contents }) {\r\n        document.getElementById(\"contents\").innerText = contents;\r\n      }\r\n    });\r\n  }, 1000)\r\n<% end %>\r\n```\r\n\r\nThen a stream of subscription messages can be seen in the websocket traffic:\r\n\r\n<img width=\"1193\" alt=\"image\" src=\"https://user-images.githubusercontent.com/14028/157585817-14b2546d-0601-4faf-9334-e2615127be77.png\">\r\n\r\nbecause the guarantor considers the second subscription pending:\r\n\r\n<img width=\"1440\" alt=\"image\" src=\"https://user-images.githubusercontent.com/14028/157586067-5ce7d08d-263a-4ea7-bfe4-9ab581f589b1.png\">\r\n\r\nbecause actioncable short circuits existing subscriptions, and so doesn't submit multiple confirmations:\r\n\r\nhttps://github.com/rails/rails/blob/v7.0.2/actioncable/lib/action_cable/connection/subscriptions.rb#L32\r\n\r\n### Use case\r\n\r\nWe have a react frontend, and we want to subscribe to channels in each of the leaf components which require dynamic updates directly. Sometimes this means multiple components will be interested in the same updates, and subscribe to the same identifiers. Trying to deduplicate these subscriptions somehow requires a lot more state management which seems more fragile and uneccessary. Previous versions of actioncable before the guarantor seem to work great for this use case, and the actioncable implemenation seems to consider subscription duplication in all operations. It's the addition of the subscription guarantor in #41581 to fix #38668 which seems to have created this issue. I think it would continue to work great with some gentle adjustment.\r\n\r\n### Expected behavior\r\n\r\nSubscribing to the same channel identifier multiple times should not constantly send subscription messages.\r\n\r\n### Actual behavior\r\n\r\nA continuous stream of subscription messages are sent from the browser and arrive and are squashed at the server without any confirmation message returning. This taxes both the browser client and the action cable server unnecessarily.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.0\r\n\r\n### Potential solution\r\n\r\nThe simplest solution seems to be to follow the pattern established in the rest of Subscriptions and avoid re-subscribing subscriptions which already exist:\r\n\r\nhttps://github.com/rails/rails/pull/44653\r\n\r\nIt's also a little confusing. The \"subscription\" in the javascript environment does not necessarily have a 1:1 relationship with the \"subscription\" on the server. This is a good thing! But it'd be nice if they had different names.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44652/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44652/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44651","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44651/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44651/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44651/events","html_url":"https://github.com/rails/rails/issues/44651","id":1164621377,"node_id":"I_kwDNIULORWq2QQ","number":44651,"title":"\"Don't know how to build task 'importmap:install'\" when running \"rails new\"","user":{"login":"getaaron","id":789577,"node_id":"MDQ6VXNlcjc4OTU3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/789577?v=4","gravatar_id":"","url":"https://api.github.com/users/getaaron","html_url":"https://github.com/getaaron","followers_url":"https://api.github.com/users/getaaron/followers","following_url":"https://api.github.com/users/getaaron/following{/other_user}","gists_url":"https://api.github.com/users/getaaron/gists{/gist_id}","starred_url":"https://api.github.com/users/getaaron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/getaaron/subscriptions","organizations_url":"https://api.github.com/users/getaaron/orgs","repos_url":"https://api.github.com/users/getaaron/repos","events_url":"https://api.github.com/users/getaaron/events{/privacy}","received_events_url":"https://api.github.com/users/getaaron/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-10T01:05:17Z","updated_at":"2022-08-17T13:30:15Z","closed_at":"2022-03-10T01:12:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nTo work around #44649 I tried adding bootsnap to my `Gemfile`.\r\n\r\nCreate this `Gemfile`:\r\n\r\n```ruby\r\nsource \"https://rubygems.org\"\r\n\r\ngem \"bootsnap\"\r\ngem \"rails\"\r\n```\r\n\r\nRun `bundle` which installs `rails (7.0.2.3)` and related dependencies\r\n\r\nRun `bundle exec rails new app/`\r\n\r\n### Expected behavior\r\nI expect the app to be created without errors\r\n\r\n### Actual behavior\r\n\r\n```\r\n[…]\r\nUsing rails 7.0.2.3\r\nBundle complete! 15 Gemfile dependencies, 74 gems now installed.\r\nUse `bundle info [gemname]` to see where a bundled gem is installed.\r\n         run  bundle binstubs bundler\r\n       rails  importmap:install\r\nrails aborted!\r\nDon't know how to build task 'importmap:install' (See the list of available tasks with `rails --tasks`)\r\n\r\n(See full trace by running task with --trace)\r\n       rails  turbo:install stimulus:install\r\nrails aborted!\r\nDon't know how to build task 'turbo:install' (See the list of available tasks with `rails --tasks`)\r\n\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n```\r\n$ bundle exec rails -v\r\nRails 7.0.2.3\r\n```\r\n\r\n**Ruby version**:\r\n\r\n```\r\n$ bundle exec ruby -v\r\nruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [arm64-darwin21]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44651/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44651/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44649","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44649/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44649/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44649/events","html_url":"https://github.com/rails/rails/issues/44649","id":1164592619,"node_id":"I_kwDNIULORWpF6w","number":44649,"title":"\"cannot load such file -- bootsnap/setup (LoadError)\" when running \"rails new\"","user":{"login":"getaaron","id":789577,"node_id":"MDQ6VXNlcjc4OTU3Nw==","avatar_url":"https://avatars.githubusercontent.com/u/789577?v=4","gravatar_id":"","url":"https://api.github.com/users/getaaron","html_url":"https://github.com/getaaron","followers_url":"https://api.github.com/users/getaaron/followers","following_url":"https://api.github.com/users/getaaron/following{/other_user}","gists_url":"https://api.github.com/users/getaaron/gists{/gist_id}","starred_url":"https://api.github.com/users/getaaron/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/getaaron/subscriptions","organizations_url":"https://api.github.com/users/getaaron/orgs","repos_url":"https://api.github.com/users/getaaron/repos","events_url":"https://api.github.com/users/getaaron/events{/privacy}","received_events_url":"https://api.github.com/users/getaaron/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-10T00:26:48Z","updated_at":"2022-03-10T01:12:00Z","closed_at":"2022-03-10T01:12:00Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate this `Gemfile`:\r\n\r\n```ruby\r\nsource \"https://rubygems.org\"\r\n\r\ngem \"rails\"\r\n```\r\n\r\nRun `bundle` which installs `rails (7.0.2.3)` and related dependencies\r\n\r\nRun `bundle exec rails new app/`\r\n\r\n### Expected behavior\r\nI expect the app to be created without errors\r\n\r\n### Actual behavior\r\n\r\n```\r\n[…]\r\nUsing rails 7.0.2.3\r\nBundle complete! 15 Gemfile dependencies, 74 gems now installed.\r\nUse `bundle info [gemname]` to see where a bundled gem is installed.\r\n         run  bundle binstubs bundler\r\n       rails  importmap:install\r\nTraceback (most recent call last):\r\n\t3: from bin/rails:3:in `<main>'\r\n\t2: from bin/rails:3:in `require_relative'\r\n\t1: from /Users/aaron/rlto/app/config/boot.rb:4:in `<top (required)>'\r\n/Users/aaron/rlto/app/config/boot.rb:4:in `require': cannot load such file -- bootsnap/setup (LoadError)\r\n       rails  turbo:install stimulus:install\r\nTraceback (most recent call last):\r\n\t3: from bin/rails:3:in `<main>'\r\n\t2: from bin/rails:3:in `require_relative'\r\n\t1: from /Users/aaron/rlto/app/config/boot.rb:4:in `<top (required)>'\r\n/Users/aaron/rlto/app/config/boot.rb:4:in `require': cannot load such file -- bootsnap/setup (LoadError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n```\r\n$ bundle exec rails -v\r\nRails 7.0.2.3\r\n```\r\n\r\n**Ruby version**:\r\n\r\n```\r\n$ bundle exec ruby -v\r\nruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [arm64-darwin21]\r\n```\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44649/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44649/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44646","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44646/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44646/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44646/events","html_url":"https://github.com/rails/rails/issues/44646","id":1164335534,"node_id":"I_kwDNIULORWZZrg","number":44646,"title":"ENOENT with bin/rails tailwindcss:watch","user":{"login":"9mm","id":1386207,"node_id":"MDQ6VXNlcjEzODYyMDc=","avatar_url":"https://avatars.githubusercontent.com/u/1386207?v=4","gravatar_id":"","url":"https://api.github.com/users/9mm","html_url":"https://github.com/9mm","followers_url":"https://api.github.com/users/9mm/followers","following_url":"https://api.github.com/users/9mm/following{/other_user}","gists_url":"https://api.github.com/users/9mm/gists{/gist_id}","starred_url":"https://api.github.com/users/9mm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/9mm/subscriptions","organizations_url":"https://api.github.com/users/9mm/orgs","repos_url":"https://api.github.com/users/9mm/repos","events_url":"https://api.github.com/users/9mm/events{/privacy}","received_events_url":"https://api.github.com/users/9mm/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-09T19:14:02Z","updated_at":"2022-03-09T20:33:37Z","closed_at":"2022-03-09T20:33:37Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate a new project with these configurations (specifically, using tailwind):\r\n\r\n    rails new test-app --database=postgresql --skip-action-mailer --skip-action-mailbox --skip-action-text --skip-active-job --skip-active-storage --skip-action-cable --asset-pipeline=propshaft --skip-hotwire --skip-jbuilder --skip-test --skip-system-test --skip-bootsnap --css=tailwind\r\n\r\nNow run the included `bin/rails tailwindcss:watch`\r\n\r\nNow edit `application.html` several times, hitting save\r\n\r\n### Expected behavior\r\n\r\nThe watch command should always watch the saved file\r\n\r\n### Actual behavior\r\n\r\nAbout 1 out of 10 saves for me, it aborts the terminal command with the following error. I assume it is a race condition. I have tried saving very slowly and it still occurs even if I don't do 2 quick saves in succession:\r\n\r\n```\r\nRebuilding...\r\nDone in 63ms.\r\n\r\nRebuilding...\r\nDone in 66ms.\r\n\r\nRebuilding...\r\nDone in 65ms.\r\nnode:fs:585\r\n  handleErrorFromBinding(ctx);\r\n  ^\r\n\r\nError: ENOENT: no such file or directory, open '/Users/9mm/Code/test-app/app/layouts/application.html.erb~'\r\n    at Object.openSync (node:fs:585:3)\r\n    at Object.openSync (pkg/prelude/bootstrap.js:739:32)\r\n    at Object.readFileSync (node:fs:453:35)\r\n    at Object.readFileSync (pkg/prelude/bootstrap.js:1025:36)\r\n    at /snapshot/tailwindcss/lib/cli.js:687:42 {\r\n  errno: -2,\r\n  syscall: 'open',\r\n  code: 'ENOENT',\r\n  path: '/Users/9mm/Code/test-app/app/layouts/application.html.erb~'\r\n}\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**: Rails 7.0.2.3\r\n\r\n**Ruby version**: ruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-darwin19]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44646/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44646/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44645","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44645/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44645/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44645/events","html_url":"https://github.com/rails/rails/issues/44645","id":1164139312,"node_id":"I_kwDNIULORWNbMA","number":44645,"title":"Rails 7.0.1 migration with belongs_to association converts bigint to integer","user":{"login":"ZilvinasKucinskas","id":3614693,"node_id":"MDQ6VXNlcjM2MTQ2OTM=","avatar_url":"https://avatars.githubusercontent.com/u/3614693?v=4","gravatar_id":"","url":"https://api.github.com/users/ZilvinasKucinskas","html_url":"https://github.com/ZilvinasKucinskas","followers_url":"https://api.github.com/users/ZilvinasKucinskas/followers","following_url":"https://api.github.com/users/ZilvinasKucinskas/following{/other_user}","gists_url":"https://api.github.com/users/ZilvinasKucinskas/gists{/gist_id}","starred_url":"https://api.github.com/users/ZilvinasKucinskas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ZilvinasKucinskas/subscriptions","organizations_url":"https://api.github.com/users/ZilvinasKucinskas/orgs","repos_url":"https://api.github.com/users/ZilvinasKucinskas/repos","events_url":"https://api.github.com/users/ZilvinasKucinskas/events{/privacy}","received_events_url":"https://api.github.com/users/ZilvinasKucinskas/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-09T16:06:19Z","updated_at":"2022-03-10T00:19:58Z","closed_at":"2022-03-10T00:19:58Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nUpgrade existing Rails project to Rails 7.0.1 with existing migration (from active_storage):\r\n\r\n```ruby\r\nclass CreateActiveStorageVariantRecords < ActiveRecord::Migration[6.0]\r\n  def change\r\n    create_table :active_storage_variant_records do |t|\r\n      t.belongs_to :blob, null: false, index: false\r\n      t.string :variation_digest, null: false\r\n\r\n      t.index %i[ blob_id variation_digest ], name: \"index_active_storage_variant_records_uniqueness\", unique: true\r\n      t.foreign_key :active_storage_blobs, column: :blob_id\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nP.S. **With Rails 7.0.0 this issue does not happen!**\r\n\r\n### Expected behavior\r\n\r\nRunning the following:\r\n\r\n```bash\r\nbundle exec rake db:drop db:create db:migrate\r\ngit diff db/schema.rb\r\n```\r\n\r\nNo changes should be present.\r\n\r\n### Actual behavior\r\n\r\n```bash\r\nbundle exec rake db:drop db:create db:migrate\r\ngit diff db/schema.rb\r\n```\r\n\r\nproduces:\r\n\r\n```diff\r\ncreate_table \"active_storage_variant_records\", force: :cascade do |t|\r\n-    t.bigint \"blob_id\", null: false\r\n+    t.integer \"blob_id\", null: false\r\n     t.string \"variation_digest\", null: false\r\n     t.index [\"blob_id\", \"variation_digest\"], name: \"index_active_storage_variant_records_uniqueness\", unique: true\r\n   end\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\n\r\n7.0.1\r\n\r\n**Ruby version**:\r\n\r\n3.0.3\r\n\r\nLet me know if you need more input into this.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44645/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44645/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44642","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44642/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44642/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44642/events","html_url":"https://github.com/rails/rails/issues/44642","id":1163724290,"node_id":"I_kwDNIULORV0GAg","number":44642,"title":"`Dalli::Client` doesn't pick up the value of `MEMCACHE_SERVERS` when used with Rails","user":{"login":"radiantshaw","id":8337814,"node_id":"MDQ6VXNlcjgzMzc4MTQ=","avatar_url":"https://avatars.githubusercontent.com/u/8337814?v=4","gravatar_id":"","url":"https://api.github.com/users/radiantshaw","html_url":"https://github.com/radiantshaw","followers_url":"https://api.github.com/users/radiantshaw/followers","following_url":"https://api.github.com/users/radiantshaw/following{/other_user}","gists_url":"https://api.github.com/users/radiantshaw/gists{/gist_id}","starred_url":"https://api.github.com/users/radiantshaw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/radiantshaw/subscriptions","organizations_url":"https://api.github.com/users/radiantshaw/orgs","repos_url":"https://api.github.com/users/radiantshaw/repos","events_url":"https://api.github.com/users/radiantshaw/events{/privacy}","received_events_url":"https://api.github.com/users/radiantshaw/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-09T09:58:41Z","updated_at":"2022-03-09T13:19:22Z","closed_at":"2022-03-09T13:19:22Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n- Create a new Rails app\r\n- Set `config.cache_store` to `:mem_cache_store`\r\n- Install the `dalli` gem\r\n- Set the value of `MEMCACHE_SERVERS` env variable\r\n- Access the Memcache server via an instance of `Dalli::Client`\r\n- Now do the same with the object provided by `Rails.cache`\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activesupport\", \"~> 6.0.4.6\"\r\n  gem \"dalli\", \"~> 2.7.6\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass MemCacheBugTest < Minitest::Test\r\n  def test_dalli_client_reads_memcache_servers_env_var\r\n    ENV.stub :[], \"memcached.example.com:11211\" do\r\n      dalli_client = Dalli::Client.new\r\n      assert_includes dalli_client.instance_variable_get(:@servers), \"memcached.example.com:11211\"\r\n    end\r\n  end\r\n\r\n  def test_rails_cache_does_not_read_memcache_servers_env_var\r\n    ENV.stub :[], \"memcached.example.com:11211\" do\r\n      dalli_client = ActiveSupport::Cache::MemCacheStore.new.instance_variable_get(:@data)\r\n      refute_includes dalli_client.instance_variable_get(:@servers), \"memcached.example.com:11211\"\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nRails configuration shouldn't prevent `Dalli::Client` instances from reading the value of `MEMCACHE_SERVERS` env variable.\r\n\r\n### Actual behavior\r\nRails configuration prevents `Dalli::Client` instances from reading the value of `MEMCACHE_SERVERS` env variable.\r\n\r\n### System configuration\r\n**Rails version**: 6.0.4.6\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44642/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44642/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44640","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44640/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44640/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44640/events","html_url":"https://github.com/rails/rails/issues/44640","id":1162968902,"node_id":"I_kwDNIULORVF_Rg","number":44640,"title":"Cannot filter top-level params using a lambda if they are an array or a hash","user":{"login":"terracatta","id":315873,"node_id":"MDQ6VXNlcjMxNTg3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/315873?v=4","gravatar_id":"","url":"https://api.github.com/users/terracatta","html_url":"https://github.com/terracatta","followers_url":"https://api.github.com/users/terracatta/followers","following_url":"https://api.github.com/users/terracatta/following{/other_user}","gists_url":"https://api.github.com/users/terracatta/gists{/gist_id}","starred_url":"https://api.github.com/users/terracatta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/terracatta/subscriptions","organizations_url":"https://api.github.com/users/terracatta/orgs","repos_url":"https://api.github.com/users/terracatta/repos","events_url":"https://api.github.com/users/terracatta/events{/privacy}","received_events_url":"https://api.github.com/users/terracatta/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-08T18:11:15Z","updated_at":"2022-03-08T19:15:56Z","closed_at":"2022-03-08T19:15:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Background\r\n\r\nI have post params that look like the following\r\n\r\n```ruby\r\n{\r\n  data: [\"some\", \"thing\", \"very\", \"sensitive\"],\r\n  super_unique_param_name: 1\r\n}\r\n```\r\n\r\nI want to be able to use `Rails.application.config.filter_parameters` to be able to filter the contents of the `data` key, but the name `data` is just way too generic and as a result it's going to get over filtered. So to accomplish this I try to write some code like the following\r\n\r\n```ruby\r\nRails.application.config.filter_parameters << -> (key, value, original_params) do\r\n  value.replace(\"[FILTERED]\") if original_params.keys.include?(\"super_unique_param_name\") && key == \"data\"\r\nend\r\n```\r\n\r\nUnfortunately this doesn't work. This code is why https://github.com/rails/rails/blob/main/activesupport%2Flib%2Factive_support%2Fparameter_filter.rb#L113-L135\r\n\r\nAs you can see, each key/value pair is dropped into this if/else tree and since my sensitive param is an Array, that code always runs and my block is never actually passed. I feel that before we start breaking down parsing the an array or hash, we should first check if its parent keys should be filtered. Essentially I am simply advocating for moving the block.call higher up in the if/else tree.\r\n\r\n### Expected Results\r\n\r\nAs a the person writing the lambda I was expecting _all_ my params to be filtered through my method, not just the ones that contained only strings as their value.\r\n\r\n### Actual Results\r\nMy lambda is never called with the `data` key/value pair.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.2\r\n\r\n**Ruby version**: ruby 3.0.3p157\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44640/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44640/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44636","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44636/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44636/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44636/events","html_url":"https://github.com/rails/rails/issues/44636","id":1162219006,"node_id":"I_kwDNIULORUYN_g","number":44636,"title":"Raise an error if uses `remove_foreign_key` with `if_exists` options","user":{"login":"kmiyake","id":131562,"node_id":"MDQ6VXNlcjEzMTU2Mg==","avatar_url":"https://avatars.githubusercontent.com/u/131562?v=4","gravatar_id":"","url":"https://api.github.com/users/kmiyake","html_url":"https://github.com/kmiyake","followers_url":"https://api.github.com/users/kmiyake/followers","following_url":"https://api.github.com/users/kmiyake/following{/other_user}","gists_url":"https://api.github.com/users/kmiyake/gists{/gist_id}","starred_url":"https://api.github.com/users/kmiyake/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kmiyake/subscriptions","organizations_url":"https://api.github.com/users/kmiyake/orgs","repos_url":"https://api.github.com/users/kmiyake/repos","events_url":"https://api.github.com/users/kmiyake/events{/privacy}","received_events_url":"https://api.github.com/users/kmiyake/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-08T04:55:10Z","updated_at":"2022-03-09T14:22:03Z","closed_at":"2022-03-09T14:22:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"active_support\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :rockets do |t|\r\n    t.string :name\r\n  end\r\n\r\n  create_table :astronauts do |t|\r\n    t.string :name\r\n    t.bigint :rocket_id\r\n  end\r\nend\r\n\r\nclass Rocket < ActiveRecord::Base\r\n  has_many :astronauts\r\nend\r\n\r\nclass Astronaut < ActiveRecord::Base\r\n  belongs_to :rocket\r\nend\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def setup\r\n    @connection = ActiveRecord::Base.connection\r\n  end\r\n\r\n  def test_remove_foreign_key_with_if_exists_set\r\n    @connection.add_foreign_key :astronauts, :rockets\r\n    assert_equal 1, @connection.foreign_keys(\"astronauts\").size\r\n\r\n    assert_nothing_raised do\r\n      @connection.remove_foreign_key :astronauts, :rockets, if_exists: true\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nNothing to raise any error and remove foreign key constraint.\r\n\r\n### Actual behavior\r\n\r\nRaise an error.\r\n\r\n```\r\n1) Error:\r\nBugTest#test_remove_foreign_key_with_if_exists_set:\r\nArgumentError: Table 'astronauts' has no foreign key for rockets\r\n    /Users/kotamiyake/.rbenv/versions/3.1.1/lib/ruby/gems/3.1.0/gems/activerecord-7.0.2.2/lib/active_record/connection_adapters/sqlite3/schema_statements.rb:77:in `remove_foreign_key'\r\n    reproduce.rb:53:in `block in test_remove_foreign_key_with_if_exists_set'\r\n    /Users/kotamiyake/.rbenv/versions/3.1.1/lib/ruby/gems/3.1.0/gems/activesupport-7.0.2.2/lib/active_support/testing/assertions.rb:34:in `assert_nothing_raised'\r\n    reproduce.rb:52:in `test_remove_foreign_key_with_if_exists_set'\r\n\r\n1 runs, 1 assertions, 0 failures, 1 errors, 0 skips\r\n```\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\n\r\n7.0.2.2\r\n\r\n**Ruby version**:\r\n\r\n```\r\n$ ruby -v           \r\nruby 3.1.1p18 (2022-02-18 revision 53f5fc4236) [x86_64-darwin19]\r\n```\r\n\r\nI found the problem that `options` and `self.options` never match.\r\nBecause `options` is came from migration file, in this case it includes `{ if_exists: true }` and `fk.options` includes some `ForeignKeyDefinition` 's options.\r\n\r\nhttps://github.com/rails/rails/blob/74ba52ec5c5aa53e2e728d88c179b2d487fff2b4/activerecord/lib/active_record/connection_adapters/sqlite3/schema_statements.rb#L69-L77\r\n\r\nWhen I found this problem, I was using postgresql. In that case, it includes `{ to_table: :dogs, if_exists: true }` and `self.options` includes the some `ForeignKeyDefinition` 's options.\r\n\r\nhttps://github.com/rails/rails/blob/b2669d7361fe43e1b1d5ce2add3cb63c9061b761/activerecord/lib/active_record/connection_adapters/abstract/schema_definitions.rb#L126-L130","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44636/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44636/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44634","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44634/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44634/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44634/events","html_url":"https://github.com/rails/rails/issues/44634","id":1161859496,"node_id":"I_kwDNIULORUCRqA","number":44634,"title":"Removing the response body from redirects breaks assert_select","user":{"login":"brenogazzola","id":1793280,"node_id":"MDQ6VXNlcjE3OTMyODA=","avatar_url":"https://avatars.githubusercontent.com/u/1793280?v=4","gravatar_id":"","url":"https://api.github.com/users/brenogazzola","html_url":"https://github.com/brenogazzola","followers_url":"https://api.github.com/users/brenogazzola/followers","following_url":"https://api.github.com/users/brenogazzola/following{/other_user}","gists_url":"https://api.github.com/users/brenogazzola/gists{/gist_id}","starred_url":"https://api.github.com/users/brenogazzola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brenogazzola/subscriptions","organizations_url":"https://api.github.com/users/brenogazzola/orgs","repos_url":"https://api.github.com/users/brenogazzola/repos","events_url":"https://api.github.com/users/brenogazzola/events{/privacy}","received_events_url":"https://api.github.com/users/brenogazzola/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-07T19:58:54Z","updated_at":"2022-03-08T00:33:59Z","closed_at":"2022-03-08T00:33:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Original discussion: https://github.com/rails/rails/pull/44632\r\n\r\nAfter https://github.com/rails/rails/pull/44554 removed response body of redirect requests, tests that execute `assert_select` without first doing a `follow_redirect` produce the following error:\r\n\r\n```\r\nNoMethodError: undefined method `document' for nil:NilClass\r\n  Nokogiri::XML::NodeSet.new(node.document, [node])\r\n```\r\n\r\nWhile not having the `follow_redirect` is an error (since the `assert_select` is not testing the correct page), the exception is confusing.\r\n\r\nI'm opening this issue to keep track of this until we have a PR that fixes the exception.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44634/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44634/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44630","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44630/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44630/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44630/events","html_url":"https://github.com/rails/rails/issues/44630","id":1161601742,"node_id":"I_kwDNIULORTyizg","number":44630,"title":"Check on protected environments is being skipped on namespaced database tasks","user":{"login":"delphaber","id":139284,"node_id":"MDQ6VXNlcjEzOTI4NA==","avatar_url":"https://avatars.githubusercontent.com/u/139284?v=4","gravatar_id":"","url":"https://api.github.com/users/delphaber","html_url":"https://github.com/delphaber","followers_url":"https://api.github.com/users/delphaber/followers","following_url":"https://api.github.com/users/delphaber/following{/other_user}","gists_url":"https://api.github.com/users/delphaber/gists{/gist_id}","starred_url":"https://api.github.com/users/delphaber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delphaber/subscriptions","organizations_url":"https://api.github.com/users/delphaber/orgs","repos_url":"https://api.github.com/users/delphaber/repos","events_url":"https://api.github.com/users/delphaber/events{/privacy}","received_events_url":"https://api.github.com/users/delphaber/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-07T15:55:27Z","updated_at":"2022-03-08T14:18:54Z","closed_at":"2022-03-08T14:18:54Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate a new rails application with a simple scaffolded model\r\n\r\n```bash\r\nbin/rails new foobar --database=postgresql\r\nbin/rails db:create\r\nbin/rails g scaffold Post title:string\r\nbin/rails db:migrate\r\n```\r\n\r\nAdd this to `config/application.rb`, so that we can test the behaviour locally:\r\n\r\n```ruby\r\nconfig.active_record.protected_environments = %w[development]\r\n```\r\n\r\nConfigure `database.yml` like this:\r\n\r\n```yml\r\ndevelopment:\r\n  primary:\r\n    <<: *default\r\n    database: foobar_development\r\n\r\n  secondary:\r\n    <<: *default\r\n    database: foobar_development\r\n```\r\n\r\nSo now we have namespaced rake tasks in `bin/rails -T`\r\n\r\n```bash\r\nrails db:schema:load\r\nrails db:schema:load:primary\r\nrails db:schema:load:secondary\r\n```\r\n\r\n### Expected behavior\r\n\r\nSince `development` is a protected environment, when I run `bin/rails db:schema:load:primary`, it should stop the process and output a warning like `bin/rails db:schema:load` does:\r\n\r\n```\r\n ↳ $ bin/rails db:schema:load\r\nrails aborted!\r\nActiveRecord::ProtectedEnvironmentError: You are attempting to run a destructive action against your 'development' database.\r\nIf you are sure you want to continue, run the same command with the environment variable:\r\nDISABLE_DATABASE_ENVIRONMENT_CHECK=1\r\n\r\nTasks: TOP => db:schema:load => db:check_protected_environments\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n### Actual behavior\r\n\r\nWhen I run `bin/rails db:schema:load:primary`, the process is not stopped and the database tables get truncated.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 3.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44630/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44630/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44624","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44624/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44624/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44624/events","html_url":"https://github.com/rails/rails/issues/44624","id":1160614719,"node_id":"I_kwDNIULORS2TPw","number":44624,"title":"System tests screenshots - include path in test result message, backtrace or separate metadata","user":{"login":"davidwessman","id":6763624,"node_id":"MDQ6VXNlcjY3NjM2MjQ=","avatar_url":"https://avatars.githubusercontent.com/u/6763624?v=4","gravatar_id":"","url":"https://api.github.com/users/davidwessman","html_url":"https://github.com/davidwessman","followers_url":"https://api.github.com/users/davidwessman/followers","following_url":"https://api.github.com/users/davidwessman/following{/other_user}","gists_url":"https://api.github.com/users/davidwessman/gists{/gist_id}","starred_url":"https://api.github.com/users/davidwessman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidwessman/subscriptions","organizations_url":"https://api.github.com/users/davidwessman/orgs","repos_url":"https://api.github.com/users/davidwessman/repos","events_url":"https://api.github.com/users/davidwessman/events{/privacy}","received_events_url":"https://api.github.com/users/davidwessman/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-06T13:44:40Z","updated_at":"2022-06-06T14:41:10Z","closed_at":"2022-06-06T14:41:10Z","author_association":"NONE","active_lock_reason":null,"body":"While parsing test results from system tests, it would be very useful to include the paths to taken screenshots in the metadata.\r\n\r\nIn the [`ScreenshotHelper`](https://github.com/rails/rails/blob/main/actionpack/lib/action_dispatch/system_testing/test_helpers/screenshot_helper.rb#L37) the path will be output with `puts`, but then it can only be accessed in logs and not in for example a [`Minitest::Reporter`](https://github.com/seattlerb/minitest/blob/master/lib/minitest.rb#L602).\r\n\r\nWhile looking through [`ActiveSupport::TestCase`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/test_case.rb)  and [`Minitest::Test`](https://github.com/seattlerb/minitest/blob/master/lib/minitest/test.rb#L10) I could not find a good place to add more metadata.\r\n\r\nIt would be useful if the failure screenshot path (or paths to all screenshots in the test case):\r\n\r\n- are added to the `ActiveSupport::TestCase` failure message.\r\n- are added to some custom metadata of the test case, that could be accessed in e.g. a reporter.\r\n\r\n## Rspec\r\n\r\nIn Rspec it adds screenshot output as [`extra_failure_lines`](https://github.com/rspec/rspec-rails/blob/3e7d8d0391cbd6355eca7d6259fd5547e07d8277/spec/rspec/rails/example/system_example_group_spec.rb#L91) which is included in the spec result message of a failure.\r\n\r\n------------\r\n\r\nI would love to make a try at a PR, but I would need some guidance if it is possible or not.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44624/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44624/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44621","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44621/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44621/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44621/events","html_url":"https://github.com/rails/rails/issues/44621","id":1160369192,"node_id":"I_kwDNIULORSnUKA","number":44621,"title":"Rails 7: `implicit_order_column` does not order records","user":{"login":"john-999","id":3640027,"node_id":"MDQ6VXNlcjM2NDAwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/3640027?v=4","gravatar_id":"","url":"https://api.github.com/users/john-999","html_url":"https://github.com/john-999","followers_url":"https://api.github.com/users/john-999/followers","following_url":"https://api.github.com/users/john-999/following{/other_user}","gists_url":"https://api.github.com/users/john-999/gists{/gist_id}","starred_url":"https://api.github.com/users/john-999/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/john-999/subscriptions","organizations_url":"https://api.github.com/users/john-999/orgs","repos_url":"https://api.github.com/users/john-999/repos","events_url":"https://api.github.com/users/john-999/events{/privacy}","received_events_url":"https://api.github.com/users/john-999/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-05T14:44:56Z","updated_at":"2022-03-05T19:45:36Z","closed_at":"2022-03-05T19:45:36Z","author_association":"NONE","active_lock_reason":null,"body":"### How to to reproduce:\r\n\r\nIn the file `app/models/application_record.rb`, add a `implicit_order_column` as follows:\r\n```\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  primary_abstract_class\r\n  self.implicit_order_column = 'created_at'\r\nend\r\n```\r\nA query like...\r\n```\r\nUser.all\r\n```\r\n...will fail to return the records in the `created_at` order.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.2\r\n\r\n**Ruby version**: ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44621/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44621/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44620","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44620/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44620/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44620/events","html_url":"https://github.com/rails/rails/issues/44620","id":1160364860,"node_id":"I_kwDNIULORSnDPA","number":44620,"title":"Rails 7: `default_scope` with `all_queries: true` -> syntax error","user":{"login":"john-999","id":3640027,"node_id":"MDQ6VXNlcjM2NDAwMjc=","avatar_url":"https://avatars.githubusercontent.com/u/3640027?v=4","gravatar_id":"","url":"https://api.github.com/users/john-999","html_url":"https://github.com/john-999","followers_url":"https://api.github.com/users/john-999/followers","following_url":"https://api.github.com/users/john-999/following{/other_user}","gists_url":"https://api.github.com/users/john-999/gists{/gist_id}","starred_url":"https://api.github.com/users/john-999/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/john-999/subscriptions","organizations_url":"https://api.github.com/users/john-999/orgs","repos_url":"https://api.github.com/users/john-999/repos","events_url":"https://api.github.com/users/john-999/events{/privacy}","received_events_url":"https://api.github.com/users/john-999/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-05T14:24:11Z","updated_at":"2022-03-05T19:37:06Z","closed_at":"2022-03-05T19:37:06Z","author_association":"NONE","active_lock_reason":null,"body":"### How to to reproduce:\r\n\r\nIn the file `app/models/application_record.rb`, add a `default_scope` as follows:\r\n```\r\nclass ApplicationRecord < ActiveRecord::Base\r\n  primary_abstract_class\r\n  default_scope { order(created_at: :asc) }, all_queries: true\r\nend\r\n```\r\nThis will throw an error like:\r\n```\r\n/home/user/Websites/someproject/app/models/application_record.rb:3: syntax error, unexpected ',', expecting `end'\r\n...pe { order(created_at: :asc) }, all_queries: true\r\n... ^ \r\n```\r\nDeleting `, all_queries: true` will eliminate the error.\r\n\r\n### System configuration\r\n**Rails version**: Rails 7.0.2.2\r\n\r\n**Ruby version**: ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44620/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44620/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44619","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44619/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44619/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44619/events","html_url":"https://github.com/rails/rails/issues/44619","id":1160222691,"node_id":"I_kwDNIULORSeX4w","number":44619,"title":"Upgrading Rails from 6.0 --> 6.1 breaks this query","user":{"login":"markhilkert","id":46462767,"node_id":"MDQ6VXNlcjQ2NDYyNzY3","avatar_url":"https://avatars.githubusercontent.com/u/46462767?v=4","gravatar_id":"","url":"https://api.github.com/users/markhilkert","html_url":"https://github.com/markhilkert","followers_url":"https://api.github.com/users/markhilkert/followers","following_url":"https://api.github.com/users/markhilkert/following{/other_user}","gists_url":"https://api.github.com/users/markhilkert/gists{/gist_id}","starred_url":"https://api.github.com/users/markhilkert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markhilkert/subscriptions","organizations_url":"https://api.github.com/users/markhilkert/orgs","repos_url":"https://api.github.com/users/markhilkert/repos","events_url":"https://api.github.com/users/markhilkert/events{/privacy}","received_events_url":"https://api.github.com/users/markhilkert/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-03-05T04:09:01Z","updated_at":"2022-03-07T16:39:59Z","closed_at":"2022-03-07T16:39:58Z","author_association":"NONE","active_lock_reason":null,"body":"### Background\r\n\r\nI'm updating an app from 6.0 --> 6.1. An existing query broke after upgrading, and I can't figure out why. The query fails on any version 6.1.0+. Any ideas? I've reproduced the error below.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"7-0-stable\"\r\n  gem \"mysql2\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(\r\n  'adapter'  => 'mysql2',\r\n  'database' => 'test_database',\r\n  'username' => 'root'\r\n)\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table \"drone_identifier_sources\", options: \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\", force: :cascade do |t|\r\n    t.string \"name\"\r\n    t.string \"priority\"\r\n  end\r\n\r\n  create_table \"drone_identifier_types\", options: \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\", force: :cascade do |t|\r\n    t.string \"name\"\r\n  end\r\n\r\n  create_table \"drone_identifiers\", options: \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\", force: :cascade do |t|\r\n    t.string \"identifier\"\r\n    t.bigint \"drone_id\"\r\n    t.bigint \"drone_identifier_type_id\"\r\n    t.bigint \"drone_identifier_source_id\"\r\n    t.index [\"drone_id\"], name: \"index_drone_identifiers_on_drone_id\"\r\n    t.index [\"drone_identifier_source_id\"], name: \"index_drone_identifiers_on_drone_identifier_source_id\"\r\n    t.index [\"drone_identifier_type_id\"], name: \"index_drone_identifiers_on_drone_identifier_type_id\"\r\n  end\r\n\r\n  create_table \"drones\", options: \"ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci\", force: :cascade do |t|\r\n    t.string \"name\"\r\n  end\r\nend\r\n\r\nclass Drone < ActiveRecord::Base\r\n  has_many(:drone_identifiers,\r\n    ->() { joins(:drone_identifier_source).order('drone_identifier_sources.priority') },\r\n    dependent: :destroy\r\n  )\r\n\r\n  def self.find_by_identifier(identifier, drone_identifier_type_id)\r\n    joins(drone_identifiers: :drone_identifier_source)\r\n      .where(\r\n        drone_identifiers: {\r\n          identifier: identifier,\r\n          drone_identifier_type_id: drone_identifier_type_id\r\n        }\r\n      )\r\n      .order('drone_identifier_sources.priority')\r\n      .first!\r\n    rescue ActiveRecord::RecordNotFound\r\n      nil\r\n  end\r\nend\r\n\r\nclass DroneIdentifier < ActiveRecord::Base\r\n  belongs_to :drone_identifier_type\r\n  belongs_to :drone_identifier_source\r\n  belongs_to :drone\r\nend\r\n\r\nclass DroneIdentifierSource < ActiveRecord::Base\r\n  has_many :drone_identifiers\r\nend\r\n\r\nclass DroneIdentifierType < ActiveRecord::Base\r\n  has_many :drone_identifiers\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    drone = Drone.find_by_identifier('abc', 1)\r\n\r\n    assert_nil drone\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nIn Rails 6.0, the following query is executed successfully:\r\n\r\n```sql\r\nSELECT `drones`.* \r\n  FROM `drones` \r\n  INNER JOIN `drone_identifiers` \r\n  ON `drone_identifiers`.`drone_id` = `drones`.`id` \r\n  INNER JOIN `drone_identifier_sources` \r\n  ON `drone_identifier_sources`.`id` = `drone_identifiers`.`drone_identifier_source_id` \r\n  WHERE `drone_identifiers`.`identifier` = 'abc' \r\n  AND `drone_identifiers`.`drone_identifier_type_id` = 1 \r\n  ORDER BY drone_identifier_sources.priority \r\n  LIMIT 1\r\n```\r\n\r\n### Actual behavior\r\n\r\nOnce I upgrade Rails to 6.1 or higher, this SQL query is executed:\r\n\r\n```sql\r\nSELECT `drones`.* \r\n  FROM `drones` \r\n  INNER JOIN `drone_identifiers` \r\n  ON `drone_identifiers`.`drone_id` = `drones`.`id` \r\n  INNER JOIN `drone_identifier_sources` `drone_identifier_sources_drone_identifiers` \r\n  ON `drone_identifier_sources_drone_identifiers`.`id` = `drone_identifiers`.`drone_identifier_source_id` \r\n  WHERE `drone_identifiers`.`identifier` = 'abc' \r\n  AND `drone_identifiers`.`drone_identifier_type_id` = 1 \r\n  ORDER BY drone_identifier_sources.priority \r\n  LIMIT 1\r\n```\r\n\r\nWhich results in the following error:\r\n\r\n```\r\nActiveRecord::StatementInvalid: Mysql2::Error: Unknown column 'drone_identifier_sources.priority' in 'order clause'\r\n```\r\n\r\nStacktrace:\r\n\r\n```\r\nActiveRecord::StatementInvalid: Mysql2::Error: Unknown column 'drone_identifier_sources.priority' in 'order clause'\r\n    2.7.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `_query'\r\n    2.7.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:131:in `block in query'\r\n    2.7.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `handle_interrupt'\r\n    2.7.0/gems/mysql2-0.5.3/lib/mysql2/client.rb:130:in `query'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:632:in `block (2 levels) in raw_execute'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:631:in `block in raw_execute'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:765:in `block in log'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activesupport/lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb:756:in `log'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:630:in `raw_execute'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/mysql/database_statements.rb:96:in `raw_execute'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/mysql/database_statements.rb:47:in `execute'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb:207:in `execute_and_free'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/mysql/database_statements.rb:52:in `exec_query'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:560:in `select'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract/database_statements.rb:66:in `select_all'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/abstract/query_cache.rb:110:in `select_all'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/connection_adapters/mysql/database_statements.rb:12:in `select_all'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/querying.rb:54:in `_query_by_sql'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:941:in `block in exec_main_query'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:927:in `exec_main_query'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:913:in `block in exec_queries'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:961:in `skip_query_cache_if_necessary'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:907:in `exec_queries'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:695:in `load'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:250:in `records'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation.rb:245:in `to_ary'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation/finder_methods.rb:549:in `find_nth_with_limit'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation/finder_methods.rb:534:in `find_nth'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation/finder_methods.rb:146:in `first'\r\n    2.7.0/bundler/gems/rails-4656c1a8f2e8/activerecord/lib/active_record/relation/finder_methods.rb:153:in `first!'\r\n    demo.rb:66:in `find_by_identifier'\r\n    demo.rb:88:in `test_association_stuff'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2 (but the error occurs on any version after 6.1.0)\r\n\r\n**Ruby version**: 2.7.2p137\r\n\r\n**MySQL version**: 8.0.28 for macos12.2 on x86_64\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44619/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44597","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44597/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44597/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44597/events","html_url":"https://github.com/rails/rails/issues/44597","id":1157283261,"node_id":"I_kwDNIULORPq9vQ","number":44597,"title":"Rails new with both bootstrap and propshaft does not work","user":{"login":"kivanio","id":5107,"node_id":"MDQ6VXNlcjUxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/5107?v=4","gravatar_id":"","url":"https://api.github.com/users/kivanio","html_url":"https://github.com/kivanio","followers_url":"https://api.github.com/users/kivanio/followers","following_url":"https://api.github.com/users/kivanio/following{/other_user}","gists_url":"https://api.github.com/users/kivanio/gists{/gist_id}","starred_url":"https://api.github.com/users/kivanio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kivanio/subscriptions","organizations_url":"https://api.github.com/users/kivanio/orgs","repos_url":"https://api.github.com/users/kivanio/repos","events_url":"https://api.github.com/users/kivanio/events{/privacy}","received_events_url":"https://api.github.com/users/kivanio/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-03-02T14:38:34Z","updated_at":"2022-03-06T17:41:57Z","closed_at":"2022-03-06T17:41:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate a new app with options for both bootstrap and propshaft\r\n\r\nWith only one of them It works.\r\nWith bulma, tailwind It also works as expected.\r\n\r\n\r\n```ruby\r\nrails new r7propshaft --database=postgresql --css=bootstrap --asset-pipeline=propshaft\r\n```\r\n\r\n### Actual behavior\r\n```\r\n├─ source-map-js@1.0.2\r\n└─ to-regex-range@5.0.1\r\n✨  Done in 4.16s.\r\nrails aborted!\r\nThor::Error: The file /Users/kivanio/Sites/blockchain/r7propshaft/config/initializers/assets.rb does not appear to exist\r\n\r\nTasks: TOP => app:template\r\n(See full trace by running task with --trace)\r\n```\r\n\r\n\r\n\r\n### System configuration\r\n**Rails version**:\r\nRails 7.0.2.2\r\n**Ruby version**:\r\nruby 3.0.3p157","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44597/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44597/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44594","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44594/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44594/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44594/events","html_url":"https://github.com/rails/rails/issues/44594","id":1156841158,"node_id":"I_kwDNIULORPP-xg","number":44594,"title":"STI foreign key auto detection regression","user":{"login":"yskkin","id":5965113,"node_id":"MDQ6VXNlcjU5NjUxMTM=","avatar_url":"https://avatars.githubusercontent.com/u/5965113?v=4","gravatar_id":"","url":"https://api.github.com/users/yskkin","html_url":"https://github.com/yskkin","followers_url":"https://api.github.com/users/yskkin/followers","following_url":"https://api.github.com/users/yskkin/following{/other_user}","gists_url":"https://api.github.com/users/yskkin/gists{/gist_id}","starred_url":"https://api.github.com/users/yskkin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yskkin/subscriptions","organizations_url":"https://api.github.com/users/yskkin/orgs","repos_url":"https://api.github.com/users/yskkin/repos","events_url":"https://api.github.com/users/yskkin/events{/privacy}","received_events_url":"https://api.github.com/users/yskkin/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-03-02T09:03:58Z","updated_at":"2022-04-14T19:08:03Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nbegin\r\n  require \"bundler/inline\"\r\nrescue LoadError => e\r\n  $stderr.puts \"Bundler version 1.10 or later is required. Please update your Bundler\"\r\n  raise e\r\nend\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n  gem \"sqlite3\", \"~> 1.3.0\"\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"5.1.6\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# Ensure backward compatibility with Minitest 4\r\nMinitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\nend\r\n\r\nclass ChildPost < Post\r\n  has_one :foo, class_name: 'Comment', inverse_of: :bar, foreign_key: :post_id\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :bar, class_name: 'ChildPost', inverse_of: :foo\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_association_stuff\r\n    post = ChildPost.create!\r\n\r\n    post.build_foo\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nexit without error in Rails 5.1.6, 5.2.0 and 6.1.0\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nexit without error in Rails 5.1.6\r\nexit with following error in Rails 5.2.0 and 6.1.0\r\n```\r\nError:\r\nBugTest#test_association_stuff:\r\nActiveModel::MissingAttributeError: can't write unknown attribute `bar_id`\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activemodel-5.2.0/lib/active_model/attribute.rb:207:in `with_value_from_database'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activemodel-5.2.0/lib/active_model/attribute_set.rb:57:in `write_from_user'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods/write.rb:51:in `_write_attribute'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods/write.rb:45:in `write_attribute'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods.rb:410:in `[]='\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/belongs_to_association.rb:92:in `replace_keys'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/belongs_to_association.rb:33:in `target='\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:103:in `set_inverse_instance'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:178:in `initialize_attributes'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:271:in `block in build_record'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/core.rb:316:in `initialize'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/inheritance.rb:66:in `new'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/inheritance.rb:66:in `new'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/reflection.rb:154:in `build_association'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:270:in `build_record'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/singular_association.rb:21:in `build'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/builder/singular_association.rb:29:in `build_foo'\r\n    active_record_gem.rb:50:in `test_association_stuff'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:98:in `block (3 levels) in run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:195:in `capture_exceptions'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:95:in `block (2 levels) in run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:281:in `time_it'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:94:in `block in run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:376:in `on_signal'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:221:in `with_info_handler'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:93:in `run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:1042:in `run_one_method'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:350:in `run_one_method'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:337:in `block (2 levels) in run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:336:in `each'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:336:in `block in run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:376:in `on_signal'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:363:in `with_info_handler'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:335:in `run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `block in __run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `map'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `__run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:146:in `run'\r\n    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:73:in `block in autorun'\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**: 2.7.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44594/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44594/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44590","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44590/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44590/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44590/events","html_url":"https://github.com/rails/rails/issues/44590","id":1155720378,"node_id":"I_kwDNIULOROLkug","number":44590,"title":"Configure ActiveStorage with AzureStorage given SAS token","user":{"login":"BrandonBalala","id":15928313,"node_id":"MDQ6VXNlcjE1OTI4MzEz","avatar_url":"https://avatars.githubusercontent.com/u/15928313?v=4","gravatar_id":"","url":"https://api.github.com/users/BrandonBalala","html_url":"https://github.com/BrandonBalala","followers_url":"https://api.github.com/users/BrandonBalala/followers","following_url":"https://api.github.com/users/BrandonBalala/following{/other_user}","gists_url":"https://api.github.com/users/BrandonBalala/gists{/gist_id}","starred_url":"https://api.github.com/users/BrandonBalala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BrandonBalala/subscriptions","organizations_url":"https://api.github.com/users/BrandonBalala/orgs","repos_url":"https://api.github.com/users/BrandonBalala/repos","events_url":"https://api.github.com/users/BrandonBalala/events{/privacy}","received_events_url":"https://api.github.com/users/BrandonBalala/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-03-01T19:22:50Z","updated_at":"2022-06-28T01:04:02Z","closed_at":"2022-06-28T01:04:02Z","author_association":"NONE","active_lock_reason":null,"body":"Based on ActiveStorage document, we're only presented with the option to pass a storage_access_key in `config/storage.yml`. \r\n\r\ne.g.\r\n```\r\nazuretest:\r\n  service: AzureStorage\r\n  storage_account_name: \"[account_name]\"\r\n  storage_access_key: \"[storage_access_key]\"\r\n  container: \"[container_name]\"\r\n```\r\n\r\nI've been provided a SAS (storage access signature), is there a way to configure storage such that I make use of the SAS token, or will I have to request a storage access key to make use of ActiveStorage with Azure\r\n\r\n### System configuration\r\n**Rails version**:  6.0.4.6\r\n\r\n**Ruby version**: 2.6.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44590/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44590/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44589","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44589/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44589/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44589/events","html_url":"https://github.com/rails/rails/issues/44589","id":1155582747,"node_id":"I_kwDNIULORODLGw","number":44589,"title":"Unable to load assets when reloading the page","user":{"login":"izaguirrejoe","id":14005731,"node_id":"MDQ6VXNlcjE0MDA1NzMx","avatar_url":"https://avatars.githubusercontent.com/u/14005731?v=4","gravatar_id":"","url":"https://api.github.com/users/izaguirrejoe","html_url":"https://github.com/izaguirrejoe","followers_url":"https://api.github.com/users/izaguirrejoe/followers","following_url":"https://api.github.com/users/izaguirrejoe/following{/other_user}","gists_url":"https://api.github.com/users/izaguirrejoe/gists{/gist_id}","starred_url":"https://api.github.com/users/izaguirrejoe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/izaguirrejoe/subscriptions","organizations_url":"https://api.github.com/users/izaguirrejoe/orgs","repos_url":"https://api.github.com/users/izaguirrejoe/repos","events_url":"https://api.github.com/users/izaguirrejoe/events{/privacy}","received_events_url":"https://api.github.com/users/izaguirrejoe/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-01T17:01:40Z","updated_at":"2022-03-06T22:59:47Z","closed_at":"2022-03-06T22:59:47Z","author_association":"NONE","active_lock_reason":null,"body":"Rails 7.0.2\r\nRuby 3.1.1\r\nSafari 15.1\r\n\r\nReference app: [https://arcane-fjord-43463.herokuapp.com]https://arcane-fjord-43463.herokuapp.com\r\n\r\nA fresh Rails project with a scaffold generated for Posts.\r\n\r\nI'm getting the following errors in my Safari browser. This is an intermittent error, usually takes about 3-4 reloads for it to pop up. Sometimes I have to close the browser and open a new window for it to appear. But it appears consistently\r\n<img width=\"1440\" alt=\"Screen Shot 2022-03-01 at 9 00 59 AM\" src=\"https://user-images.githubusercontent.com/14005731/156214094-d3f5d9eb-89c8-4ada-bf79-e9f4b159a8d5.png\">\r\n.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44589/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44589/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44587","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44587/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44587/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44587/events","html_url":"https://github.com/rails/rails/issues/44587","id":1155468144,"node_id":"I_kwDNIULORN8LcA","number":44587,"title":"Assets from a webpacker configuration using custom domains not being resolved","user":{"login":"spullen","id":20021,"node_id":"MDQ6VXNlcjIwMDIx","avatar_url":"https://avatars.githubusercontent.com/u/20021?v=4","gravatar_id":"","url":"https://api.github.com/users/spullen","html_url":"https://github.com/spullen","followers_url":"https://api.github.com/users/spullen/followers","following_url":"https://api.github.com/users/spullen/following{/other_user}","gists_url":"https://api.github.com/users/spullen/gists{/gist_id}","starred_url":"https://api.github.com/users/spullen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spullen/subscriptions","organizations_url":"https://api.github.com/users/spullen/orgs","repos_url":"https://api.github.com/users/spullen/repos","events_url":"https://api.github.com/users/spullen/events{/privacy}","received_events_url":"https://api.github.com/users/spullen/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-03-01T15:20:17Z","updated_at":"2022-03-02T12:01:35Z","closed_at":"2022-03-02T12:01:35Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nI've been trying to set up `webpack-dev-server` to use a custom domain so I can use SSL in development. \r\n\r\nMy configuration is as follows:\r\n```ruby\r\ndev_server:\r\n    host: www.app.test\r\n    port: 3035\r\n    public: www.app.test:3035\r\n    hmr: false\r\n    # Inline should be set to true if using HMR\r\n    inline: true\r\n    overlay: true\r\n    compress: true\r\n    disable_host_check: true\r\n    use_local_ip: false\r\n    quiet: false\r\n    pretty: false\r\n    headers:\r\n      'Access-Control-Allow-Origin': '*'\r\n    watch_options:\r\n      ignored: '**/node_modules/**'\r\n```\r\n\r\nI also have a breakout configuration to handle setting the SSL key and cert as I wasn't able to do this in the yaml file.\r\n`./config/webpack/development.js`\r\n\r\n```javascript\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'development'\r\n\r\nconst fs = require('fs');\r\n\r\nconst environment = require('./environment')\r\n\r\nenvironment.config.devServer.https = {\r\n    key: fs.readFileSync(process.env.DEV_CERT_KEY_FILE),\r\n    cert: fs.readFileSync(process.env.DEV_CERT_FILE)\r\n}\r\n\r\nmodule.exports = environment.toWebpackConfig();\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe assets that are served from `webpack-dev-server` by `<%= stylesheet_pack_tag 'application' %>` and `<%= javascript_pack_tag 'application' %>` should resolve to the custom domain (eg. `https://www.app.test:3035/packs/...`)\r\n\r\n### Actual behavior\r\n\r\nThe assets that are served from `webpack-dev-server` are not being resolved to the custom domain, but instead they are being resolved to the host and port of the rails server (`https://www.app.dev:3000/packs/...`).\r\n\r\nI believe the webpacker configuration is correct. I was able to fetch an asset if I typed `https://www.app.test:3035/packs/css/application-2d3439a8.css` or `https://www.app.test:3035/packs/js/application-2d3439a8.js` directly in the browser.\r\n\r\nThe webpacker.yml configuration that I had before changing the configuration to use custom domains was:\r\n\r\n```ruby\r\ndev_server:\r\n    https: false\r\n    host: localhost\r\n    port: 3035\r\n    public: localhost:3035\r\n    hmr: false\r\n    # Inline should be set to true if using HMR\r\n    inline: true\r\n    overlay: true\r\n    compress: true\r\n    disable_host_check: true\r\n    use_local_ip: false\r\n    quiet: false\r\n    pretty: false\r\n    headers:\r\n      'Access-Control-Allow-Origin': '*'\r\n    watch_options:\r\n      ignored: '**/node_modules/**'\r\n```\r\n\r\nWhich resolved as expected (ex. `http://localhost:3035/packs/...`) using `<%= stylesheet_pack_tag 'application' %>` and `<%= javascript_pack_tag 'application' %>`\r\n\r\nTo workaround the issue, I set the asset_host configuration in `./config/environments/development.rb` as such:\r\n```ruby\r\nconfig.action_controller.asset_host = ENV.fetch('ASSET_HOST') { 'www.app.test:3035' }\r\n``` \r\nwhich works to resolve the assets generated by webpack.\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4\r\n**Ruby version**:\r\n2.7.4\r\n**Webpacker version**:\r\n5.4.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44587/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44587/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44583","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44583/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44583/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44583/events","html_url":"https://github.com/rails/rails/issues/44583","id":1155285825,"node_id":"I_kwDNIULORNxDQQ","number":44583,"title":"Rails 7 looking for application.css","user":{"login":"josephmo","id":202611,"node_id":"MDQ6VXNlcjIwMjYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/202611?v=4","gravatar_id":"","url":"https://api.github.com/users/josephmo","html_url":"https://github.com/josephmo","followers_url":"https://api.github.com/users/josephmo/followers","following_url":"https://api.github.com/users/josephmo/following{/other_user}","gists_url":"https://api.github.com/users/josephmo/gists{/gist_id}","starred_url":"https://api.github.com/users/josephmo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josephmo/subscriptions","organizations_url":"https://api.github.com/users/josephmo/orgs","repos_url":"https://api.github.com/users/josephmo/repos","events_url":"https://api.github.com/users/josephmo/events{/privacy}","received_events_url":"https://api.github.com/users/josephmo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2022-03-01T12:32:06Z","updated_at":"2022-08-01T22:42:28Z","closed_at":"2022-03-15T00:47:37Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n    Mac OS Monterey\r\n    Rails 7.0.2.2\r\n    Ruby 3.1.0\r\n    yarn 1.22.17\r\n    node 17.5.0\r\n\r\nI created an application as follows:\r\n\r\n`rails new myapp --database=mysql --skip-test --css=bootstrap\r\n`\r\nI added the DB credentials, and created the DB\r\n\r\n`rake db:create\r\n`\r\nThen I added a static home page (View and Controller) and made the home page the root page.\r\n\r\nThen I added the Devise Gem and produced all the views and controllers. Then I migrated the database.\r\n\r\nOn my local development machine, everything was running fine. I pushed the code to the repository, and then cloned the repo to another folder MyApp2\r\n\r\nFrom MyApp2, I did:\r\n\r\n```\r\nbundle install\r\nbundle update\r\n```\r\nAnd then:\r\n\r\n`rails s\r\n`\r\n\r\nI got an error message:\r\n\r\n```\r\nSprockets::Rails::Helper::AssetNotFound in StaticPages#home\r\nShowing MyApp2/app/views/layouts/application.html.slim where line #9 raised:\r\nThe asset \"application.css\" is not present in the asset pipeline.\r\n\r\n  = csrf_meta_tags\r\n  = csp_meta_tag\r\n  = stylesheet_link_tag \"application\", \"data-turbo-track\": \"reload\"\r\n  = javascript_include_tag \"application\", \"data-turbo-track\": \"reload\", defer: true\r\nbody\r\n  = yield\r\n\r\n```\r\n\r\nThere is no \"application.css\", it was deleted by the install process, that replaced it with \"application.bootstrap.scss\"\r\n\r\nAny idea what I'm missing before I start the server?\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nI am expecting to see the home page\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.2.2\r\n\r\n**Ruby version**:\r\n\r\n3.1.0","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44583/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44583/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44571","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44571/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44571/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44571/events","html_url":"https://github.com/rails/rails/issues/44571","id":1154146874,"node_id":"I_kwDNIULORMriOg","number":44571,"title":"`precision: nil` added to datetime columns in `schema.rb` in 7.0.2 causes a change in value","user":{"login":"thisismydesign","id":3299948,"node_id":"MDQ6VXNlcjMyOTk5NDg=","avatar_url":"https://avatars.githubusercontent.com/u/3299948?v=4","gravatar_id":"","url":"https://api.github.com/users/thisismydesign","html_url":"https://github.com/thisismydesign","followers_url":"https://api.github.com/users/thisismydesign/followers","following_url":"https://api.github.com/users/thisismydesign/following{/other_user}","gists_url":"https://api.github.com/users/thisismydesign/gists{/gist_id}","starred_url":"https://api.github.com/users/thisismydesign/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thisismydesign/subscriptions","organizations_url":"https://api.github.com/users/thisismydesign/orgs","repos_url":"https://api.github.com/users/thisismydesign/repos","events_url":"https://api.github.com/users/thisismydesign/events{/privacy}","received_events_url":"https://api.github.com/users/thisismydesign/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2022-02-28T14:16:37Z","updated_at":"2022-06-21T13:53:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nRunning `db:migrate` in `7.0.2` adds `precision: nil` to datetime columns using postgres (a change from `7.0.1` discussed here https://github.com/rails/rails/issues/43909).\r\n\r\nAfter this, one of our spec comparing dates is failing because of what looks like a precision related error:\r\n```\r\nDiff:\r\n       @@ -1 +1 @@\r\n       -Mon, 21 Feb 2022 14:10:49.640199500 CET +01:00\r\n       +Mon, 21 Feb 2022 14:10:49.640199000 CET +01:00\r\n```\r\n\r\nThe test basically asserts:\r\n\r\n```\r\nperiod = create(:period)\r\nuser = create(:user, period: period)\r\n\r\nexpect(period.start_at).to eq(user.period.start_at)\r\n```\r\n\r\nMore importantly, this leads me to think there's an actual precision change that would not be reflected on production, only locally. I'm not sure how to rectify this.\r\n\r\nIn addition, it's unclear what `nil` means in this case. I liked the explicit `6` or no mention for default, but a change to `nil` was confusing. I assume it stands for the default.\r\n\r\n### Expected behavior\r\n\r\nNo DB/value change\r\n\r\n### Actual behavior\r\n\r\nDB change\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 3.0.3\r\n\r\n**postgres version**: 13.4","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44571/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44571/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44566","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44566/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44566/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44566/events","html_url":"https://github.com/rails/rails/issues/44566","id":1153501473,"node_id":"I_kwDNIULORMEJIQ","number":44566,"title":"Rails 7.0.1 pulling 7.1.0(alpha) components","user":{"login":"josephmo","id":202611,"node_id":"MDQ6VXNlcjIwMjYxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/202611?v=4","gravatar_id":"","url":"https://api.github.com/users/josephmo","html_url":"https://github.com/josephmo","followers_url":"https://api.github.com/users/josephmo/followers","following_url":"https://api.github.com/users/josephmo/following{/other_user}","gists_url":"https://api.github.com/users/josephmo/gists{/gist_id}","starred_url":"https://api.github.com/users/josephmo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josephmo/subscriptions","organizations_url":"https://api.github.com/users/josephmo/orgs","repos_url":"https://api.github.com/users/josephmo/repos","events_url":"https://api.github.com/users/josephmo/events{/privacy}","received_events_url":"https://api.github.com/users/josephmo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-28T01:31:21Z","updated_at":"2022-02-28T01:58:29Z","closed_at":"2022-02-28T01:58:28Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nEnvironment: Mac Monterey\r\nRuby 3.0.3\r\n\r\nI did:\r\n\r\n`gem install rails -v 7.0.1\r\n`\r\nand all the 7.0.1 installed fine\r\n\r\n`rails new pli2 --database=mysql --skip-test --main --css=bootstrap\r\n`\r\nAt one point, the script said:\r\n\r\n```\r\nInstalling minitest 5.15.0\r\nUsing activesupport 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing activemodel 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing globalid 1.0.0\r\nUsing activerecord 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing activejob 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing nokogiri 1.13.3 (x86_64-darwin)\r\nUsing rails-dom-testing 2.0.3\r\nUsing loofah 2.14.0\r\nUsing rails-html-sanitizer 1.4.2\r\nUsing actionview 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing actionpack 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing actioncable 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing activestorage 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing railties 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\nUsing actiontext 7.1.0.alpha from https://github.com/rails/rails.git (at main@cece807)\r\n```\r\n\r\n\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.1 (or so I thought)\r\n**Ruby version**:\r\n3.0.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44566/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44566/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44565","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44565/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44565/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44565/events","html_url":"https://github.com/rails/rails/issues/44565","id":1153387130,"node_id":"I_kwDNIULORL9Keg","number":44565,"title":"tests relying on non-existant Gemfiles","user":{"login":"Segaja","id":586672,"node_id":"MDQ6VXNlcjU4NjY3Mg==","avatar_url":"https://avatars.githubusercontent.com/u/586672?v=4","gravatar_id":"","url":"https://api.github.com/users/Segaja","html_url":"https://github.com/Segaja","followers_url":"https://api.github.com/users/Segaja/followers","following_url":"https://api.github.com/users/Segaja/following{/other_user}","gists_url":"https://api.github.com/users/Segaja/gists{/gist_id}","starred_url":"https://api.github.com/users/Segaja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Segaja/subscriptions","organizations_url":"https://api.github.com/users/Segaja/orgs","repos_url":"https://api.github.com/users/Segaja/repos","events_url":"https://api.github.com/users/Segaja/events{/privacy}","received_events_url":"https://api.github.com/users/Segaja/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-27T20:27:26Z","updated_at":"2022-02-28T02:02:26Z","closed_at":"2022-02-28T02:02:26Z","author_association":"NONE","active_lock_reason":null,"body":"Both the tests for `activestorage` and `actionmailbox` in version 7.0.2 rely on a `Gemfile` being present in their subfolders ( https://github.com/rails/rails/blob/v7.0.2/activestorage/test/dummy/config/boot.rb, https://github.com/rails/rails/blob/v7.0.2/actionmailbox/test/dummy/config/boot.rb ) or being provided via environment variable.\r\n\r\nThe fallback path in both cases doesn't contain any `Gemfile`, so I'm unsure as to how to run these tests without them or what the Gemfile needs to contain.\r\n\r\nCan you give some advice?","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44565/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44565/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44563","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44563/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44563/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44563/events","html_url":"https://github.com/rails/rails/issues/44563","id":1153354413,"node_id":"I_kwDNIULORL7KrQ","number":44563,"title":"SVG tags generated with tag helper are not self closing","user":{"login":"davekaro","id":21263,"node_id":"MDQ6VXNlcjIxMjYz","avatar_url":"https://avatars.githubusercontent.com/u/21263?v=4","gravatar_id":"","url":"https://api.github.com/users/davekaro","html_url":"https://github.com/davekaro","followers_url":"https://api.github.com/users/davekaro/followers","following_url":"https://api.github.com/users/davekaro/following{/other_user}","gists_url":"https://api.github.com/users/davekaro/gists{/gist_id}","starred_url":"https://api.github.com/users/davekaro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davekaro/subscriptions","organizations_url":"https://api.github.com/users/davekaro/orgs","repos_url":"https://api.github.com/users/davekaro/repos","events_url":"https://api.github.com/users/davekaro/events{/privacy}","received_events_url":"https://api.github.com/users/davekaro/received_events","type":"User","site_admin":false},"labels":[{"id":3666649,"node_id":"MDU6TGFiZWwzNjY2NjQ5","url":"https://api.github.com/repos/rails/rails/labels/actionview","name":"actionview","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-27T18:43:05Z","updated_at":"2022-02-28T23:58:36Z","closed_at":"2022-02-28T23:58:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\nGenerate HTML using this code to output an SVG:\r\n\r\n```\r\ntag.div(style: \"height: 100px; width: 100px\") do\r\n  tag.svg(viewBox: \"0 0 100 100\", xmlns: \"http://www.w3.org/2000/svg\") do\r\n    tag.g(fill: \"white\", stroke: \"green\", \"stroke-width\": \"5\") do\r\n      tag.circle(cx: 40, cy: 40, r: 25) +\r\n        tag.circle(cx: 60, cy: 60, r: 25)\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n`<circle>` tags inside the SVG should be closed.\r\n\r\n```\r\n<div style=\"height: 100px; width: 100px\">\r\n  <svg viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\r\n    <g fill=\"white\" stroke=\"green\" stroke-width=\"5\">\r\n      <circle cx=\"40\" cy=\"40\" r=\"25\"></circle>\r\n      <circle cx=\"60\" cy=\"60\" r=\"25\"></circle>\r\n    </g>\r\n  </svg>\r\n</div>\r\n```\r\n\r\nSVG should look like\r\n![image](https://user-images.githubusercontent.com/21263/155895035-787f3854-a017-4b01-bb40-c639dd247421.png)\r\n\r\n### Actual behavior\r\n`<circle>` tags are not closed.\r\n\r\n```\r\n<div style=\"height: 100px; width: 100px\">\r\n  <svg viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\r\n    <g fill=\"white\" stroke=\"green\" stroke-width=\"5\">\r\n      <circle cx=\"40\" cy=\"40\" r=\"25\">\r\n      <circle cx=\"60\" cy=\"60\" r=\"25\">\r\n    </g>\r\n  </svg>\r\n</div>\r\n```\r\n\r\nThe browser ends up nesting the `<circle>` tags like:\r\n\r\n```\r\n<div style=\"height: 100px; width: 100px\">\r\n  <svg viewBox=\"0 0 100 100\" xmlns=\"http://www.w3.org/2000/svg\">\r\n    <g fill=\"white\" stroke=\"green\" stroke-width=\"5\">\r\n      <circle cx=\"40\" cy=\"40\" r=\"25\">\r\n        <circle cx=\"60\" cy=\"60\" r=\"25\"></circle>\r\n      </circle>\r\n    </g>\r\n  </svg>\r\n</div>\r\n```\r\n\r\nThe final SVG looks like:\r\n![image](https://user-images.githubusercontent.com/21263/155895127-2b5529b7-f987-47b8-b0e1-5ed6a0022e6e.png)\r\n\r\nChanges introduced in Rails 7 in https://github.com/rails/rails/pull/43232 broke this SVG. I think the changes are not correct. Only [void elements](https://html.spec.whatwg.org/multipage/syntax.html#void-elements) can omit the end tag. Tags inside SVG elements are not considered void elements but rather are [foreign elements](https://dev.w3.org/html5/html-author/#foreign-elements) (elements in the SVG namespace). These elements must be closed with either an end tag (like they were before the change), or by self-closing like `<circle cx=\"60\" cy=\"60\" r=\"25\" />`.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 3.1.1","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44563/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44563/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44561","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44561/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44561/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44561/events","html_url":"https://github.com/rails/rails/issues/44561","id":1152180032,"node_id":"I_kwDNIULORKzfQA","number":44561,"title":"Deleting an article in Getting Started guide missing install steps","user":{"login":"agmcleod","id":113275,"node_id":"MDQ6VXNlcjExMzI3NQ==","avatar_url":"https://avatars.githubusercontent.com/u/113275?v=4","gravatar_id":"","url":"https://api.github.com/users/agmcleod","html_url":"https://github.com/agmcleod","followers_url":"https://api.github.com/users/agmcleod/followers","following_url":"https://api.github.com/users/agmcleod/following{/other_user}","gists_url":"https://api.github.com/users/agmcleod/gists{/gist_id}","starred_url":"https://api.github.com/users/agmcleod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/agmcleod/subscriptions","organizations_url":"https://api.github.com/users/agmcleod/orgs","repos_url":"https://api.github.com/users/agmcleod/repos","events_url":"https://api.github.com/users/agmcleod/events{/privacy}","received_events_url":"https://api.github.com/users/agmcleod/received_events","type":"User","site_admin":false},"labels":[{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-02-26T19:27:14Z","updated_at":"2022-02-28T21:18:09Z","closed_at":"2022-02-28T21:18:09Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nAs per the instructions here: https://guides.rubyonrails.org/getting_started.html#deleting-an-article i setup a link with the data-turbo attributes. However it was just using the GET request. I could see there was no JS being loaded in the app, so I figured application.js or maybe other files needed to be setup.\r\n\r\nDigging through docs of turbo rails, and importmap i managed to figure out what I was missing:\r\n\r\n```\r\n./bin/rails importmap:install\r\n./bin/rails turbo:install\r\n```\r\n\r\nUpon running those and refreshing the page, the delete link worked.\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 2.7.0p\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44561/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44561/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44557","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44557/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44557/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44557/events","html_url":"https://github.com/rails/rails/issues/44557","id":1151047826,"node_id":"I_kwDNIULORJuYkg","number":44557,"title":"Upgrade to active_storage for 6.0 to 6.1 is objected to by strong_migrations gem","user":{"login":"obromios","id":1390233,"node_id":"MDQ6VXNlcjEzOTAyMzM=","avatar_url":"https://avatars.githubusercontent.com/u/1390233?v=4","gravatar_id":"","url":"https://api.github.com/users/obromios","html_url":"https://github.com/obromios","followers_url":"https://api.github.com/users/obromios/followers","following_url":"https://api.github.com/users/obromios/following{/other_user}","gists_url":"https://api.github.com/users/obromios/gists{/gist_id}","starred_url":"https://api.github.com/users/obromios/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obromios/subscriptions","organizations_url":"https://api.github.com/users/obromios/orgs","repos_url":"https://api.github.com/users/obromios/repos","events_url":"https://api.github.com/users/obromios/events{/privacy}","received_events_url":"https://api.github.com/users/obromios/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-02-26T01:57:42Z","updated_at":"2022-02-26T22:44:12Z","closed_at":"2022-02-26T22:44:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nUpgrading from rails 6.0 to 6.1, run\r\n```\r\nrails active_storage:update\r\nrails db:migrate\r\n```\r\n\r\n### Expected behavior\r\nI imagine this normally just works and creates the required changes to the database\r\n\r\n### Actual behavior\r\nThe migration fails with the following message\r\n\r\n```\r\nrails db:migrate\r\n== 20220226005243 AddServiceNameToActiveStorageBlobs: migrating ===============\r\n-- column_exists?(:active_storage_blobs, :service_name)\r\n   -> 0.0097s\r\n-- add_column(:active_storage_blobs, :service_name, :string)\r\n   -> 0.0051s\r\nrails aborted!\r\nStandardError: An error has occurred, this and all later migrations canceled:\r\n\r\n=== Dangerous operation detected #strong_migrations ===\r\n\r\nChanging the type is safe, but setting NOT NULL is not.\r\n```\r\n\r\nThe exception is causes by the  strong_migration [gem](https://github.com/ankane/strong_migrations).  Looking at their github page it seems to say that requiring a field to be not null 'on an existing column blocks reads and writes while every row is checked'. So according to the strong_parameters gem this is dangerous practice.  Should I just turn of the strong_migration check for this particular migration or is there an issue with the migration as it stands?\r\n\r\n### System configuration\r\n**Rails version**:\r\nrails '6.1.4.6'\r\n\r\n**Ruby version**:\r\nruby '2.7.5'","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44557/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44557/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44553","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44553/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44553/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44553/events","html_url":"https://github.com/rails/rails/issues/44553","id":1150651367,"node_id":"I_kwDNIULORJWL5w","number":44553,"title":"ActiveSupport::Deprecation does not fallback to configured disallowed_behavior","user":{"login":"grncdr","id":82634,"node_id":"MDQ6VXNlcjgyNjM0","avatar_url":"https://avatars.githubusercontent.com/u/82634?v=4","gravatar_id":"","url":"https://api.github.com/users/grncdr","html_url":"https://github.com/grncdr","followers_url":"https://api.github.com/users/grncdr/followers","following_url":"https://api.github.com/users/grncdr/following{/other_user}","gists_url":"https://api.github.com/users/grncdr/gists{/gist_id}","starred_url":"https://api.github.com/users/grncdr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/grncdr/subscriptions","organizations_url":"https://api.github.com/users/grncdr/orgs","repos_url":"https://api.github.com/users/grncdr/repos","events_url":"https://api.github.com/users/grncdr/events{/privacy}","received_events_url":"https://api.github.com/users/grncdr/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-02-25T16:43:41Z","updated_at":"2022-03-29T14:02:35Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activesupport\", \"~> 7.0.0\"\r\nend\r\n\r\nrequire \"active_support\"\r\nrequire \"active_support/core_ext/object/blank\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    warnings = []\r\n\r\n    ActiveSupport::Deprecation.disallowed_warnings << /my_gem soon/\r\n    ActiveSupport::Deprecation.disallowed_behavior = ->(msg, callstack, horizon, gem_name) {\r\n      warnings << msg\r\n    }\r\n\r\n    deprecator = ActiveSupport::Deprecation.new('soon', 'my_gem')\r\n    deprecator.deprecation_warning(:some_method)\r\n\r\n    refute warnings.empty?\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expect the custom `disallowed_behavior` to be called by `#deprecation_warning`.\r\n\r\n### Actual behavior\r\n\r\nThe gem-default behaviour (`:raise`) is called instead.\r\n\r\n### System configuration\r\n\r\n**Rails version**:\r\n\r\n6.1.4.4 (but this problem affects all versions of Rails from 6.1 onwards)\r\n\r\n**Ruby version**:\r\n\r\nRuby 3.1 (but this problem also occurs in earlier Ruby versions).\r\n\r\n### More information\r\n\r\nI _think_ this could be fixed by prepending a fallback to `ActiveSupport::Deprecation.disallowed_behavior` here: https://github.com/rails/rails/blob/87d4d0f4126f64d991d40a1827de50935ddfdbff/activesupport/lib/active_support/deprecation/behaviors.rb#L71-L73\r\n\r\nHowever, because this class is using a singleton and [InstanceDelegator](https://github.com/rails/rails/blob/87d4d0f4126f64d991d40a1827de50935ddfdbff/activesupport/lib/active_support/deprecation/instance_delegator.rb) the method might need two definitions, one on the class-level (that falls back to DEFAULT_BEHAVIORS) and one on the instance level (that falls back to the class-level behavior).","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44553/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44553/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44552","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44552/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44552/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44552/events","html_url":"https://github.com/rails/rails/issues/44552","id":1150441493,"node_id":"I_kwDNIULORJJYFQ","number":44552,"title":"Something wrong when create new ror application","user":{"login":"masterbo98","id":73686357,"node_id":"MDQ6VXNlcjczNjg2MzU3","avatar_url":"https://avatars.githubusercontent.com/u/73686357?v=4","gravatar_id":"","url":"https://api.github.com/users/masterbo98","html_url":"https://github.com/masterbo98","followers_url":"https://api.github.com/users/masterbo98/followers","following_url":"https://api.github.com/users/masterbo98/following{/other_user}","gists_url":"https://api.github.com/users/masterbo98/gists{/gist_id}","starred_url":"https://api.github.com/users/masterbo98/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/masterbo98/subscriptions","organizations_url":"https://api.github.com/users/masterbo98/orgs","repos_url":"https://api.github.com/users/masterbo98/repos","events_url":"https://api.github.com/users/masterbo98/events{/privacy}","received_events_url":"https://api.github.com/users/masterbo98/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-25T13:23:32Z","updated_at":"2022-02-25T19:22:12Z","closed_at":"2022-02-25T19:22:12Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\nWhen I use the command \"rails new myapp\"，there came some errors, can anyone teach me how to solve this problem?\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n![image](https://user-images.githubusercontent.com/73686357/155722373-a9f4d0a1-4e40-4334-8cd1-5661089045f3.png)\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2.2\r\n**Ruby version**:\r\n3.0.3","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44552/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44552/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44550","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44550/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44550/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44550/events","html_url":"https://github.com/rails/rails/issues/44550","id":1150287612,"node_id":"I_kwDNIULORI_-_A","number":44550,"title":"A doubt about the build scope of association","user":{"login":"OuYangJinTing","id":33079237,"node_id":"MDQ6VXNlcjMzMDc5MjM3","avatar_url":"https://avatars.githubusercontent.com/u/33079237?v=4","gravatar_id":"","url":"https://api.github.com/users/OuYangJinTing","html_url":"https://github.com/OuYangJinTing","followers_url":"https://api.github.com/users/OuYangJinTing/followers","following_url":"https://api.github.com/users/OuYangJinTing/following{/other_user}","gists_url":"https://api.github.com/users/OuYangJinTing/gists{/gist_id}","starred_url":"https://api.github.com/users/OuYangJinTing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OuYangJinTing/subscriptions","organizations_url":"https://api.github.com/users/OuYangJinTing/orgs","repos_url":"https://api.github.com/users/OuYangJinTing/repos","events_url":"https://api.github.com/users/OuYangJinTing/events{/privacy}","received_events_url":"https://api.github.com/users/OuYangJinTing/received_events","type":"User","site_admin":false},"labels":[{"id":1071962662,"node_id":"MDU6TGFiZWwxMDcxOTYyNjYy","url":"https://api.github.com/repos/rails/rails/labels/more-information-needed","name":"more-information-needed","color":"bfdadc","default":false,"description":"When reporter needs to provide more information"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-25T10:29:28Z","updated_at":"2022-03-28T23:48:08Z","closed_at":"2022-03-28T23:48:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n  # source \"https://gems.ruby-china.com/\"\r\n\r\n  gem \"minitest\", \"~> 5.15\"\r\n  gem \"minitest-reporters\"\r\n  gem \"activerecord\", \"~> 7.0.2\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"minitest/reporters\"\r\nrequire \"active_record\"\r\n\r\nMinitest::Reporters.use!\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n    t.string :name, null: false\r\n  end\r\n\r\n  create_table :posts, force: true do |t|\r\n    t.belongs_to :user\r\n    t.string :title, null: false\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_many :posts, dependent: :destroy\r\n\r\n  # This association is unreliable. As follows:\r\n  #   1. User.first._latest_post (Correct. It is good)\r\n  #      SQL => SELECT \"posts\".* FROM \"posts\" WHERE \"posts\".\"user_id\" = ? ORDER BY \"posts\".\"id\" DESC LIMIT ?\r\n  #   2. User.preload(:_latest_post).first._latest_post (Correct. But it produces redundant query data and Post objects)\r\n  #      SQL => SELECT \"posts\".* FROM \"posts\" WHERE \"posts\".\"user_id\" = ? ORDER BY \"posts\".\"id\" DESC\r\n  #   3. User.eager_load(:_latest_post).first._latest_post (Error. it not only roduces redundant query data and Post objects but also the result may be wrong)\r\n  #      SQL => SELECT \"users\".\"id\" AS t0_r0, \"users\".\"name\" AS t0_r1, \"posts\".\"id\" AS t1_r0, \"posts\".\"user_id\" AS t1_r1, \"posts\".\"title\" AS t1_r2 FROM \"users\" LEFT OUTER JOIN \"posts\" ON \"posts\".\"user_id\" = \"users\".\"id\" ORDER BY \"users\".\"id\" ASC LIMIT ?\r\n  has_one :_latest_post, -> { order(id: :desc) }, class_name: \"Post\"\r\n\r\n  # This association is reliable, but it is not good for performance. Because of missing user_id constraint in subquery in associate scope.\r\n  has_one :latest_post, -> { where(id: group(:user_id).select(\"MAX(posts.id) AS id\")) }, class_name: \"Post\"\r\n\r\n  # The sql performance of _latest_post is better latest_post when access associated object.\r\n  def latest_post\r\n    association(:latest_post).loaded? ? association(:latest_post).reader : _latest_post\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  belongs_to :user\r\nend\r\n\r\nclass SQLCounter\r\n  class << self\r\n    attr_accessor :log\r\n    def clear_log; self.log = [] end\r\n  end\r\n\r\n  clear_log\r\n\r\n  def call(_, _, _, _, values)\r\n    self.class.log << values[:sql]\r\n  end\r\n\r\n  ActiveSupport::Notifications.subscribe(\"sql.active_record\", new)\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    3.times do |i|\r\n      User.create(name: \"foo-#{i + 1}\").tap do |user|\r\n        10.times do |j|\r\n          user.posts.create(title: \"bar-#{j + 1}\")\r\n        end\r\n      end\r\n    end\r\n  end\r\n\r\n\r\n  def test_subquery_constraint\r\n    user_ids = User.includes(:latest_post).map(&:id)\r\n    act_post_sql = SQLCounter.log.last\r\n    latest_post_ids = Post.where(user_id: user_ids).group(:user_id).select(\"MAX(posts.id) AS id\")\r\n    Post.where(id: latest_post_ids, user_id: user_ids).load\r\n    exp_post_sql = SQLCounter.log.last\r\n\r\n    assert_equal exp_post_sql, act_post_sql, \"Expect the subquery to contain the user_id constraint, actually not.\"\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nExpect the subquery to contain the user_id constraint\r\n\r\n### Actual behavior\r\nThe subquery losing user_id constraint\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 3\r\n\r\n---\r\n\r\n_PS_: English is not my native language; please excuse typing errors and syntax error.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44550/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44550/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44549","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44549/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44549/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44549/events","html_url":"https://github.com/rails/rails/issues/44549","id":1150164625,"node_id":"I_kwDNIULORI4ekQ","number":44549,"title":"before_type_cast not work when it called by an object through association mapping and index","user":{"login":"jiso0jung","id":99234289,"node_id":"U_kgDOBeox8Q","avatar_url":"https://avatars.githubusercontent.com/u/99234289?v=4","gravatar_id":"","url":"https://api.github.com/users/jiso0jung","html_url":"https://github.com/jiso0jung","followers_url":"https://api.github.com/users/jiso0jung/followers","following_url":"https://api.github.com/users/jiso0jung/following{/other_user}","gists_url":"https://api.github.com/users/jiso0jung/gists{/gist_id}","starred_url":"https://api.github.com/users/jiso0jung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jiso0jung/subscriptions","organizations_url":"https://api.github.com/users/jiso0jung/orgs","repos_url":"https://api.github.com/users/jiso0jung/repos","events_url":"https://api.github.com/users/jiso0jung/events{/privacy}","received_events_url":"https://api.github.com/users/jiso0jung/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-02-25T08:16:14Z","updated_at":"2022-06-28T17:04:03Z","closed_at":"2022-06-28T17:04:03Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# db/schema.rb\r\nActiveRecord::Schema[7.0].define(version: 2022_02_25_061737) do\r\n  create_table \"boxes\", force: :cascade do |t|\r\n    t.datetime \"created_at\", null: false\r\n    t.datetime \"updated_at\", null: false\r\n  end\r\n\r\n  create_table \"chocolates\", force: :cascade do |t|\r\n    t.string \"flavor\"\r\n    t.integer \"box_id\", null: false\r\n    t.datetime \"created_at\", null: false\r\n    t.datetime \"updated_at\", null: false\r\n    t.index [\"box_id\"], name: \"index_chocolates_on_box_id\"\r\n  end\r\n\r\n  add_foreign_key \"chocolates\", \"boxes\"\r\nend\r\n```\r\n```ruby\r\n# app/models/box.rb\r\nclass Box < ApplicationRecord\r\n  has_many :chocolates, dependent: :destroy\r\n\r\n  def got_chocolate(flavor)\r\n    chocolates.create!(flavor:)\r\n  end\r\nend\r\n```\r\n```ruby\r\n# app/models/chocolate.rb\r\nclass Chocolate < ApplicationRecord\r\n  enum flavor: { matcha: '녹차', strawberry: '딸기' }\r\n  belongs_to :box\r\nend\r\n```\r\n``` ruby\r\n# spec/models/chocolate_spec.rb\r\nrequire 'rails_helper'\r\n\r\nRSpec.describe Chocolate, type: :model do\r\n  let(:box) { create(:box) }\r\n\r\n  before do\r\n    box.got_chocolate(Chocolate.flavors[:matcha])\r\n    box.got_chocolate(Chocolate.flavors[:strawberry])\r\n  end\r\n\r\n  it do\r\n    chocolates = box.chocolates\r\n    p chocolates.first.flavor_before_type_cast\r\n    p chocolates[0].flavor_before_type_cast\r\n\r\n    chocolates = Chocolate.where(box:)\r\n    p chocolates.first.flavor_before_type_cast\r\n    p chocolates[0].flavor_before_type_cast\r\n\r\n    should belong_to(:box)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\"녹차\" is the value and \"matcha\" is the key of the enum hash\r\n\r\n```ruby\r\n\"녹차\"\r\n\"녹차\"\r\n\"녹차\"\r\n\"녹차\"\r\n```\r\n\r\n### Actual behavior\r\n```ruby\r\n\"녹차\"\r\n\"matcha\"      # ????\r\n\"녹차\"\r\n\"녹차\"\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.0\r\n\r\n### repository\r\nhttps://github.com/jiso0jung/sample-proj\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44549/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44549/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44548","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44548/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44548/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44548/events","html_url":"https://github.com/rails/rails/issues/44548","id":1150059976,"node_id":"I_kwDNIULORIyFyA","number":44548,"title":"link_to \"delete\" cannot work","user":{"login":"AlfredjinAndroid","id":22347461,"node_id":"MDQ6VXNlcjIyMzQ3NDYx","avatar_url":"https://avatars.githubusercontent.com/u/22347461?v=4","gravatar_id":"","url":"https://api.github.com/users/AlfredjinAndroid","html_url":"https://github.com/AlfredjinAndroid","followers_url":"https://api.github.com/users/AlfredjinAndroid/followers","following_url":"https://api.github.com/users/AlfredjinAndroid/following{/other_user}","gists_url":"https://api.github.com/users/AlfredjinAndroid/gists{/gist_id}","starred_url":"https://api.github.com/users/AlfredjinAndroid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AlfredjinAndroid/subscriptions","organizations_url":"https://api.github.com/users/AlfredjinAndroid/orgs","repos_url":"https://api.github.com/users/AlfredjinAndroid/repos","events_url":"https://api.github.com/users/AlfredjinAndroid/events{/privacy}","received_events_url":"https://api.github.com/users/AlfredjinAndroid/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-25T05:28:40Z","updated_at":"2022-02-25T14:59:25Z","closed_at":"2022-02-25T14:59:25Z","author_association":"NONE","active_lock_reason":null,"body":"controller\r\n```\r\nclass ArticlesController < ApplicationController\r\n  def index\r\n    @articles = Article.all\r\n  end\r\n\r\n  def show\r\n    @article = Article.find(params[:id])\r\n  end\r\n\r\n  def new\r\n    @article = Article.new\r\n  end\r\n\r\n  def create\r\n    @article = Article.new(article_params)\r\n\r\n    if @article.save\r\n      redirect_to @article\r\n    else\r\n      render :new, status: :unprocessable_entity\r\n    end\r\n  end\r\n\r\n  def edit\r\n    @article = Article.find(params[:id])\r\n  end\r\n\r\n  def update\r\n    @article = Article.find(params[:id])\r\n\r\n    if @article.update(article_params)\r\n      redirect_to @article\r\n    else render :edit, status: :unprocessable_entity\r\n    end\r\n  end\r\n\r\n  def destroy\r\n    @article = Article.find(params[:id])\r\n    @article.destroy\r\n\r\n    redirect_to root_path, status: :see_other\r\n  end\r\n\r\n\r\n  private\r\n    def article_params\r\n      params.require(:article).permit(:title, :body)\r\n    end\r\n\r\nend\r\n\r\n```\r\n\r\nView\r\n\r\n```\r\n<h1> <%= @article.title %> </h1>\r\n<p> <%= @article.body %> </p>\r\n\r\n<ul> \r\n    <li> <%= link_to \"Edit\", edit_article_path(@article)%> </li>\r\n    <li><%= link_to \"Destroy\", article_path(@article), data: {\r\n                    turbo_method: :delete,\r\n                    turbo_confirm: \"Are you sure?\"\r\n                  } %></li>\r\n</ul>\r\n```\r\n\r\nI'm learn Ruby on Rails from https://guides.rubyonrails.org/getting_started.html\r\nbut it doesn't work...\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44548/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44548/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44546","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44546/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44546/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44546/events","html_url":"https://github.com/rails/rails/issues/44546","id":1149853973,"node_id":"I_kwDNIULORIlhFQ","number":44546,"title":"Unintialized Constant I cannot figure out in Rails 7","user":{"login":"resistorsoftware","id":123307,"node_id":"MDQ6VXNlcjEyMzMwNw==","avatar_url":"https://avatars.githubusercontent.com/u/123307?v=4","gravatar_id":"","url":"https://api.github.com/users/resistorsoftware","html_url":"https://github.com/resistorsoftware","followers_url":"https://api.github.com/users/resistorsoftware/followers","following_url":"https://api.github.com/users/resistorsoftware/following{/other_user}","gists_url":"https://api.github.com/users/resistorsoftware/gists{/gist_id}","starred_url":"https://api.github.com/users/resistorsoftware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/resistorsoftware/subscriptions","organizations_url":"https://api.github.com/users/resistorsoftware/orgs","repos_url":"https://api.github.com/users/resistorsoftware/repos","events_url":"https://api.github.com/users/resistorsoftware/events{/privacy}","received_events_url":"https://api.github.com/users/resistorsoftware/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-02-24T22:55:49Z","updated_at":"2022-02-25T18:27:46Z","closed_at":"2022-02-25T17:49:08Z","author_association":"NONE","active_lock_reason":null,"body":"I have an app directory in my Rails 7 App, app/beer, and in that folder a file named cool.rb with a defined execute() method.\r\n\r\nIn an ActiveJob **DrinkSudsJob** perform method I am calling the method execute from cool.rb as: \r\n\r\n    def perform(**jobargs)\r\n      Beer::Cool.execute\r\n    end\r\n\r\nBut my App blows up. Tells me **unitialized constant DrinkSudsJob::Beer**\r\n\r\nZeitwerk:check tells me everything is fine. What am I doing wrong here? \r\n\r\n    bin/rails r 'puts ActiveSupport::Dependencies.autoload_paths'\r\n    /Users/sputz/Documents/Workspace/Apps/2022/fug/app/beer\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44546/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44546/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44536","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44536/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44536/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44536/events","html_url":"https://github.com/rails/rails/issues/44536","id":1148550600,"node_id":"I_kwDNIULORHV9yA","number":44536,"title":"Content-Security-Policy: `:self` isn't turned into `'self'` when returned inside an array from a lambda","user":{"login":"asterite","id":209371,"node_id":"MDQ6VXNlcjIwOTM3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/209371?v=4","gravatar_id":"","url":"https://api.github.com/users/asterite","html_url":"https://github.com/asterite","followers_url":"https://api.github.com/users/asterite/followers","following_url":"https://api.github.com/users/asterite/following{/other_user}","gists_url":"https://api.github.com/users/asterite/gists{/gist_id}","starred_url":"https://api.github.com/users/asterite/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/asterite/subscriptions","organizations_url":"https://api.github.com/users/asterite/orgs","repos_url":"https://api.github.com/users/asterite/repos","events_url":"https://api.github.com/users/asterite/events{/privacy}","received_events_url":"https://api.github.com/users/asterite/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-23T20:35:51Z","updated_at":"2022-03-01T18:54:46Z","closed_at":"2022-03-01T18:51:02Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nSorry, I don't have a lot of time to create actual repro steps, but...\r\n\r\nIf you do something like this:\r\n\r\n```ruby\r\nclass ApplicationController < ActionController::Base\r\n  content_security_policy do |policy|\r\n    policy.frame_ancestors lambda { [:self, \"https://example.com\"] }\r\n  end\r\nend\r\n```\r\n\r\nThen the `content-security-policy` HTTP header will look like this:\r\n\r\n```\r\ncontent-security_policy: frame-ancestors self https://example.com\r\n```\r\n\r\nNote that it says `self` instead of `'self'`.\r\n\r\nThis only happens when you return an array from that lambda. If you return `:self` it works fine. Also moving `:self` to outside the lambda (passed directly to `frame_ancestors` works as expected.\r\n\r\n### Expected behavior\r\n\r\n```\r\ncontent-security_policy: frame-ancestors 'self' https://example.com\r\n```\r\n\r\n### Actual behavior\r\n\r\n```\r\ncontent-security_policy: frame-ancestors self https://example.com\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 6.0.4.4 (but I see no diff between the relevant file and `main`)\r\n\r\n**Ruby version**: 2.6.8","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44536/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44536/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44533","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44533/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44533/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44533/events","html_url":"https://github.com/rails/rails/issues/44533","id":1148290667,"node_id":"I_kwDNIULORHGGaw","number":44533,"title":"PR #36210 solved only for `save!`, but not for `save` neither `valid?`.","user":{"login":"cgimenes","id":2816976,"node_id":"MDQ6VXNlcjI4MTY5NzY=","avatar_url":"https://avatars.githubusercontent.com/u/2816976?v=4","gravatar_id":"","url":"https://api.github.com/users/cgimenes","html_url":"https://github.com/cgimenes","followers_url":"https://api.github.com/users/cgimenes/followers","following_url":"https://api.github.com/users/cgimenes/following{/other_user}","gists_url":"https://api.github.com/users/cgimenes/gists{/gist_id}","starred_url":"https://api.github.com/users/cgimenes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cgimenes/subscriptions","organizations_url":"https://api.github.com/users/cgimenes/orgs","repos_url":"https://api.github.com/users/cgimenes/repos","events_url":"https://api.github.com/users/cgimenes/events{/privacy}","received_events_url":"https://api.github.com/users/cgimenes/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-23T16:11:08Z","updated_at":"2022-06-01T23:52:19Z","closed_at":"2022-06-01T23:52:19Z","author_association":"NONE","active_lock_reason":null,"body":"Related PR: https://github.com/rails/rails/pull/36210\r\n\r\n```ruby\r\nclass List < ApplicationRecord\r\n  has_many :items, class_name: \"ListItem\", dependent: :destroy\r\nend\r\n\r\nclass ListItem < ApplicationRecord\r\n  belongs_to :list\r\n\r\n  validates_uniqueness_of :name, scope: :list_id\r\nend\r\n\r\nl = List.create name: 'TestList'\r\nl.items.build name: 'Item'\r\nl.items.build name: 'Item'\r\nl.valid? # this returns true instead of false\r\nl.save # this returns false correctly, but with a rollback exception\r\n```\r\n\r\nConfirmed on Rails 7.0.2.2","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44533/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44533/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44524","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44524/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44524/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44524/events","html_url":"https://github.com/rails/rails/issues/44524","id":1147860145,"node_id":"I_kwDNIULORGr0sQ","number":44524,"title":"Incorrect type definition for direct upload","user":{"login":"Oleksii14","id":36737084,"node_id":"MDQ6VXNlcjM2NzM3MDg0","avatar_url":"https://avatars.githubusercontent.com/u/36737084?v=4","gravatar_id":"","url":"https://api.github.com/users/Oleksii14","html_url":"https://github.com/Oleksii14","followers_url":"https://api.github.com/users/Oleksii14/followers","following_url":"https://api.github.com/users/Oleksii14/following{/other_user}","gists_url":"https://api.github.com/users/Oleksii14/gists{/gist_id}","starred_url":"https://api.github.com/users/Oleksii14/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Oleksii14/subscriptions","organizations_url":"https://api.github.com/users/Oleksii14/orgs","repos_url":"https://api.github.com/users/Oleksii14/repos","events_url":"https://api.github.com/users/Oleksii14/events{/privacy}","received_events_url":"https://api.github.com/users/Oleksii14/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-23T09:37:38Z","updated_at":"2022-03-02T12:03:09Z","closed_at":"2022-03-02T12:03:09Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Open `@types/rails__activestorage/index.d.ts`\r\n2. Open `@rails/activestorage/src/direct_upload.js`\r\n3. See that the class constructor is different from what we have in the type definition file.\r\n\r\n### Expected behavior\r\nThe type definition from step 1 should be correct and implement the class from step 2\r\n\r\n### Actual behavior\r\nThe type definition from step 1 should be correct and related to the class from step 2. It causes TS errors. And if those errors are fixed according to the incorrect type definition, the DirectUpload class does not work as expected\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44524/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44524/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44519","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44519/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44519/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44519/events","html_url":"https://github.com/rails/rails/issues/44519","id":1146812059,"node_id":"I_kwDNIULORFr2mw","number":44519,"title":"Generated issue by a dummy user","user":{"login":"secondu-ser","id":93895155,"node_id":"U_kgDOBZi58w","avatar_url":"https://avatars.githubusercontent.com/u/93895155?v=4","gravatar_id":"","url":"https://api.github.com/users/secondu-ser","html_url":"https://github.com/secondu-ser","followers_url":"https://api.github.com/users/secondu-ser/followers","following_url":"https://api.github.com/users/secondu-ser/following{/other_user}","gists_url":"https://api.github.com/users/secondu-ser/gists{/gist_id}","starred_url":"https://api.github.com/users/secondu-ser/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/secondu-ser/subscriptions","organizations_url":"https://api.github.com/users/secondu-ser/orgs","repos_url":"https://api.github.com/users/secondu-ser/repos","events_url":"https://api.github.com/users/secondu-ser/events{/privacy}","received_events_url":"https://api.github.com/users/secondu-ser/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-22T11:49:44Z","updated_at":"2022-02-22T12:00:47Z","closed_at":"2022-02-22T12:00:47Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n**Ruby version**:\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44519/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44519/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44517","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44517/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44517/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44517/events","html_url":"https://github.com/rails/rails/issues/44517","id":1146596000,"node_id":"I_kwDNIULORFeqoA","number":44517,"title":"ActiveRecord should not begin transaction If query is not written sql.","user":{"login":"OuYangJinTing","id":33079237,"node_id":"MDQ6VXNlcjMzMDc5MjM3","avatar_url":"https://avatars.githubusercontent.com/u/33079237?v=4","gravatar_id":"","url":"https://api.github.com/users/OuYangJinTing","html_url":"https://github.com/OuYangJinTing","followers_url":"https://api.github.com/users/OuYangJinTing/followers","following_url":"https://api.github.com/users/OuYangJinTing/following{/other_user}","gists_url":"https://api.github.com/users/OuYangJinTing/gists{/gist_id}","starred_url":"https://api.github.com/users/OuYangJinTing/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OuYangJinTing/subscriptions","organizations_url":"https://api.github.com/users/OuYangJinTing/orgs","repos_url":"https://api.github.com/users/OuYangJinTing/repos","events_url":"https://api.github.com/users/OuYangJinTing/events{/privacy}","received_events_url":"https://api.github.com/users/OuYangJinTing/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-02-22T08:25:27Z","updated_at":"2022-02-23T11:09:21Z","closed_at":"2022-02-22T12:49:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n\r\n  gem \"minitest\", \"~> 5.15\"\r\n  gem \"activerecord\", \"~> 7.0.2\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\nrequire \"active_record\"\r\n\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n    t.string :name, null: false\r\n    t.index :name, unique: true\r\n  end\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  validates :name, uniqueness: true # When this case is performed, will open transaction.\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    @user = User.create(name: \"foobar\")\r\n  end\r\n\r\n  def test_valid\r\n    called_begin_db_transaction = false\r\n    # @see https://github.com/seattlerb/minitest/blob/v5.15.0/lib/minitest/mock.rb#L215.\r\n    # Then __minitest_stub__begin_db_transaction method is temporarily defined by Object#stub.\r\n    return_proc = proc { called_begin_db_transaction = true; User.connection.__minitest_stub__begin_db_transaction }\r\n    User.connection.stub(:begin_db_transaction, return_proc) { @user.save }\r\n\r\n    # Failure\r\n    refute called_begin_db_transaction, \"Expected begin_db_transaction to be not called, but was called.\"\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nActiveRecord should not begin transaction If query is not written sql.\r\n\r\n### Actual behavior\r\n\r\nBegin transaction\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 3\r\n\r\n***\r\n_PS_: English is not my native language; please excuse typing errors.\r\n\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44517/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44517/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44516","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44516/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44516/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44516/events","html_url":"https://github.com/rails/rails/issues/44516","id":1146462592,"node_id":"I_kwDNIULORFWhgA","number":44516,"title":"Update password to an empty string(\"\") not working properly.","user":{"login":"rajesh-rrk","id":62842037,"node_id":"MDQ6VXNlcjYyODQyMDM3","avatar_url":"https://avatars.githubusercontent.com/u/62842037?v=4","gravatar_id":"","url":"https://api.github.com/users/rajesh-rrk","html_url":"https://github.com/rajesh-rrk","followers_url":"https://api.github.com/users/rajesh-rrk/followers","following_url":"https://api.github.com/users/rajesh-rrk/following{/other_user}","gists_url":"https://api.github.com/users/rajesh-rrk/gists{/gist_id}","starred_url":"https://api.github.com/users/rajesh-rrk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rajesh-rrk/subscriptions","organizations_url":"https://api.github.com/users/rajesh-rrk/orgs","repos_url":"https://api.github.com/users/rajesh-rrk/repos","events_url":"https://api.github.com/users/rajesh-rrk/events{/privacy}","received_events_url":"https://api.github.com/users/rajesh-rrk/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-02-22T05:10:09Z","updated_at":"2022-03-02T03:43:50Z","closed_at":"2022-03-02T03:43:50Z","author_association":"NONE","active_lock_reason":null,"body":"I'm using **has_secure_password** for User model. When I try to update my existing user's password to an empty string(''), It's not raising the **Password can't be blank** error. But when I try with nil, It's raising the error.\r\n\r\n**Reference**:\r\n```\r\nUser.first.update!(password: '')\r\n  User Load (1.1ms)  SELECT \"users\".* FROM \"users\" ORDER BY \"users\".\"id\" ASC LIMIT $1  [[\"LIMIT\", 1]]\r\n=> true\r\n>> User.first.update!(password: nil)\r\n  User Load (2.8ms)  SELECT \"users\".* FROM \"users\" ORDER BY \"users\".\"id\" ASC LIMIT $1  [[\"LIMIT\", 1]]\r\n/Users/rajeshkanna/.rvm/rubies/ruby-3.0.2/lib/ruby/gems/3.0.0/gems/activerecord-7.0.1/lib/active_record/validations.rb:80:in `raise_validation_error': Validation failed: Password can't be blank (ActiveRecord::RecordInvalid)\r\n```\r\n\r\nI've analyzed and figured out an issue in **secure_password.rb** file.\r\n\r\nThe issue is in secure_password.rb file, line no 96,\r\n`unencrypted_password.nil?` should be change it to `unencrypted_password.nil? || unencrypted_password.empty?`\r\n\r\nhttps://github.com/rails/rails/blob/1c976f26dfa2423bede55e89c8e6119d45edd79a/activemodel/lib/active_model/secure_password.rb#L96","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44516/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44516/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44503","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44503/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44503/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44503/events","html_url":"https://github.com/rails/rails/issues/44503","id":1145878360,"node_id":"I_kwDNIULOREy3WA","number":44503,"title":"ActionMailer smtp_settings lost with ruby 3.0 (but applied with ruby 2.7)","user":{"login":"hoeni","id":409930,"node_id":"MDQ6VXNlcjQwOTkzMA==","avatar_url":"https://avatars.githubusercontent.com/u/409930?v=4","gravatar_id":"","url":"https://api.github.com/users/hoeni","html_url":"https://github.com/hoeni","followers_url":"https://api.github.com/users/hoeni/followers","following_url":"https://api.github.com/users/hoeni/following{/other_user}","gists_url":"https://api.github.com/users/hoeni/gists{/gist_id}","starred_url":"https://api.github.com/users/hoeni/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hoeni/subscriptions","organizations_url":"https://api.github.com/users/hoeni/orgs","repos_url":"https://api.github.com/users/hoeni/repos","events_url":"https://api.github.com/users/hoeni/events{/privacy}","received_events_url":"https://api.github.com/users/hoeni/received_events","type":"User","site_admin":false},"labels":[{"id":107188,"node_id":"MDU6TGFiZWwxMDcxODg=","url":"https://api.github.com/repos/rails/rails/labels/actionmailer","name":"actionmailer","color":"8B00FC","default":false,"description":null},{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-02-21T14:32:59Z","updated_at":"2022-03-14T10:57:04Z","closed_at":"2022-03-14T10:57:03Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nScaffold a new Rails 6.1 App.\r\nSet `production.conf` to\r\n```ruby\r\n  config.action_mailer.delivery_method = :smtp\r\n  config.action_mailer.smtp_settings = {\r\n      address: 'smtpout.xxxx.com',\r\n      port: 25,\r\n      enable_starttls: false,\r\n      enable_starttls_auto: false,\r\n      openssl_verify_mode: OpenSSL::SSL::VERIFY_NONE,\r\n      ssl: false,\r\n      tls: false,\r\n  }\r\n```\r\nSo there should be no TLS/SSL handshake by any means.\r\n\r\nRails console shows, the config has been imported correctly:\r\n\r\n```irb\r\nRAILS_ENV=production rails c\r\nLoading production environment (Rails 6.1.4.6)\r\nirb(main):001:0> mailer = ActionMailer::Base.new\r\n=> #<ActionMailer::Base:0x00000000008688>\r\nirb(main):002:0> mailer.smtp_settings\r\n=> {:address=>\"smtpout.mitxp.com\", :port=>25, :enable_starttls=>false, :enable_starttls_auto=>false, :openssl_verify_mode=>0, :ssl=>false, :tls=>false}\r\nirb(main):003:0> mailer.mail(from: 'sender@example.com', to: 'recipient@ example.com', subject: 'test', body: \"Hello, you've got mail!\").deliver\r\n```\r\n\r\n### Expected behavior\r\nActionMailer should connect to the unsecured mail server (which has a self-signed certificate).\r\n\r\n### Actual behavior\r\nUsing ruby 2.7: This works fine.\r\nUsing ruby 3.0: This results in an error:\r\n```\r\n/usr/local/lib/ruby/3.0.0/net/protocol.rb:46:in `connect_nonblock': SSL_connect returned=1 errno=0 state=error: certificate verify failed (self signed certificate) (OpenSSL::SSL::SSLError)\r\n```\r\n\r\n### System configuration\r\nactionmailer 6.1.4.6\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44503/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44503/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44500","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44500/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44500/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44500/events","html_url":"https://github.com/rails/rails/issues/44500","id":1145736993,"node_id":"I_kwDNIULOREqPIQ","number":44500,"title":"after_commit on: :update callbacks are triggered even when none of the object's attributes are updated.","user":{"login":"manojmj92","id":4034241,"node_id":"MDQ6VXNlcjQwMzQyNDE=","avatar_url":"https://avatars.githubusercontent.com/u/4034241?v=4","gravatar_id":"","url":"https://api.github.com/users/manojmj92","html_url":"https://github.com/manojmj92","followers_url":"https://api.github.com/users/manojmj92/followers","following_url":"https://api.github.com/users/manojmj92/following{/other_user}","gists_url":"https://api.github.com/users/manojmj92/gists{/gist_id}","starred_url":"https://api.github.com/users/manojmj92/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/manojmj92/subscriptions","organizations_url":"https://api.github.com/users/manojmj92/orgs","repos_url":"https://api.github.com/users/manojmj92/repos","events_url":"https://api.github.com/users/manojmj92/events{/privacy}","received_events_url":"https://api.github.com/users/manojmj92/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-02-21T12:28:55Z","updated_at":"2022-02-21T20:06:41Z","closed_at":"2022-02-21T20:05:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi everyone,\r\n\r\nI came across this behaviour of `after_commit on: :update` callback and wanted to make sure if this is a bug or not.\r\n\r\nSuch callbacks are being fired even on empty saves where none of the object's attributes (including `updated_at`) changes. In short, there wasn't any update per se to the record, but the `update` callbacks are being triggered anyway, which is confusing.\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org/\"\r\n\r\n  git_source(:github) { |repo| \"[https://github.com/#{repo}.git](https://github.com/#%7Brepo%7D.git)\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  after_commit :some_callback, on: :update\r\n\r\n  private\r\n\r\n  def some_callback\r\n    raise 'triggered'\r\n  end\r\nend\r\n\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_callback\r\n    Post.create!\r\n    post = Post.last\r\n\r\n    post.save! # raises error from the callback, but ideally it shouldn't because no attribute of `post` was changed.\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n`update` callbacks should not be triggered because there are no updates to any of the attributes of the object.\r\n\r\n### Actual behavior\r\n\r\n`update` callbacks are being triggered even though there are no updates to any of the attributes of the object.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n`7.0.0`\r\n\r\n**Ruby version**:\r\n\r\n`ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux-gnu]`","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44500/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44500/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44498","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44498/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44498/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44498/events","html_url":"https://github.com/rails/rails/issues/44498","id":1145599615,"node_id":"I_kwDNIULOREh2fw","number":44498,"title":"Column comments set with `add_column` are now stripped from PostgreSQL structure dumps","user":{"login":"chrisandreae","id":186537,"node_id":"MDQ6VXNlcjE4NjUzNw==","avatar_url":"https://avatars.githubusercontent.com/u/186537?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisandreae","html_url":"https://github.com/chrisandreae","followers_url":"https://api.github.com/users/chrisandreae/followers","following_url":"https://api.github.com/users/chrisandreae/following{/other_user}","gists_url":"https://api.github.com/users/chrisandreae/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisandreae/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisandreae/subscriptions","organizations_url":"https://api.github.com/users/chrisandreae/orgs","repos_url":"https://api.github.com/users/chrisandreae/repos","events_url":"https://api.github.com/users/chrisandreae/events{/privacy}","received_events_url":"https://api.github.com/users/chrisandreae/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-21T10:21:12Z","updated_at":"2022-03-07T19:07:35Z","closed_at":"2022-03-07T19:07:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Commit https://github.com/rails/rails/commit/d5745607463ef72adb6a34e3ecc9b3820484a33f adds the `--no-comment` pg_dump option to the `structure_dump` database task. The linked issues suggest that the motivation for this was that setting comments on PostgreSQL extensions such as `plpgsql` requires elevated database permissions.\r\n\r\nHowever, this breaks the [documented](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/connection_adapters/abstract/schema_statements.rb#L559-L560) functionality of setting a `comment:` on database columns. While the comment will be added to the live database during the migration, it will no longer be emitted as part of the `structure.sql` dump, causing the committed structure to diverge from the schema in the database.\r\n\r\n### Steps to reproduce\r\n\r\nAdd a column with a comment in a migration, then update the database structure dump.\r\n\r\n```ruby\r\nadd_column(:users, :some_column, :integer, comment: 'the description of the column')\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe comment is emitted in `structure.sql`, in such a way that it will be restored to the database as part of loading the schema.\r\n\r\n```sql\r\n--\r\n-- Name: COLUMN users.some_column; Type: COMMENT; Schema: public; Owner: -\r\n--\r\n\r\nCOMMENT ON COLUMN public.users.some_column IS 'the description of the column';\r\n```\r\n\r\n### Actual behavior\r\n\r\nThe comment is not emitted.\r\n\r\n### System configuration\r\n**Rails version**: [`main`](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/tasks/postgresql_database_tasks.rb#L61)\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44498/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44496","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44496/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44496/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44496/events","html_url":"https://github.com/rails/rails/issues/44496","id":1145311408,"node_id":"I_kwDNIULOREQQsA","number":44496,"title":"The PR 43671 has broken many because `new_controller_thread` just copy `Thread.current`  fiber locals","user":{"login":"qinmingyuan","id":1678560,"node_id":"MDQ6VXNlcjE2Nzg1NjA=","avatar_url":"https://avatars.githubusercontent.com/u/1678560?v=4","gravatar_id":"","url":"https://api.github.com/users/qinmingyuan","html_url":"https://github.com/qinmingyuan","followers_url":"https://api.github.com/users/qinmingyuan/followers","following_url":"https://api.github.com/users/qinmingyuan/following{/other_user}","gists_url":"https://api.github.com/users/qinmingyuan/gists{/gist_id}","starred_url":"https://api.github.com/users/qinmingyuan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qinmingyuan/subscriptions","organizations_url":"https://api.github.com/users/qinmingyuan/orgs","repos_url":"https://api.github.com/users/qinmingyuan/repos","events_url":"https://api.github.com/users/qinmingyuan/events{/privacy}","received_events_url":"https://api.github.com/users/qinmingyuan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-02-21T04:31:45Z","updated_at":"2022-02-21T12:21:43Z","closed_at":"2022-02-21T11:28:42Z","author_association":"NONE","active_lock_reason":null,"body":"this PR #43671  has broken many because `new_controller_thread` just copy `Thread.current`  fiber locals\r\n\r\nhttps://github.com/rails/rails/blob/dbdb546c0cf1de4e0745ea00234558425dc37457/actionpack/lib/action_controller/metal/live.rb#L251-L263\r\n\r\n_Originally posted by @qinmingyuan in https://github.com/rails/rails/pull/43671#issuecomment-1046464496_","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44496/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44496/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44491","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44491/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44491/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44491/events","html_url":"https://github.com/rails/rails/issues/44491","id":1144938256,"node_id":"I_kwDNIULORD5fEA","number":44491,"title":"can't open rails console in production","user":{"login":"OlgaCoskun","id":31107638,"node_id":"MDQ6VXNlcjMxMTA3NjM4","avatar_url":"https://avatars.githubusercontent.com/u/31107638?v=4","gravatar_id":"","url":"https://api.github.com/users/OlgaCoskun","html_url":"https://github.com/OlgaCoskun","followers_url":"https://api.github.com/users/OlgaCoskun/followers","following_url":"https://api.github.com/users/OlgaCoskun/following{/other_user}","gists_url":"https://api.github.com/users/OlgaCoskun/gists{/gist_id}","starred_url":"https://api.github.com/users/OlgaCoskun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OlgaCoskun/subscriptions","organizations_url":"https://api.github.com/users/OlgaCoskun/orgs","repos_url":"https://api.github.com/users/OlgaCoskun/repos","events_url":"https://api.github.com/users/OlgaCoskun/events{/privacy}","received_events_url":"https://api.github.com/users/OlgaCoskun/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-20T06:56:48Z","updated_at":"2022-02-20T11:00:58Z","closed_at":"2022-02-20T11:00:58Z","author_association":"NONE","active_lock_reason":null,"body":"```ruby\r\n# /current$ bundle exec rails c\r\n/home/deploy/.rbenv/versions/3.0.3/lib/ruby/3.0.0/debug.rb:6:in `<top (required)>': undefined method `>' for nil:NilClass (NoMethodError)\r\n\tfrom /home/deploy/dima/shared/bundle/ruby/3.0.0/gems/zeitwerk-2.5.1/lib/zeitwerk/kernel.rb:35:in `require'\r\n\tfrom /home/deploy/dima/shared/bundle/ruby/3.0.0/gems/zeitwerk-2.5.1/lib/zeitwerk/kernel.rb:35:in `require'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler/runtime.rb:60:in `block (2 levels) in require'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler/runtime.rb:55:in `each'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler/runtime.rb:55:in `block in require'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler/runtime.rb:44:in `each'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler/runtime.rb:44:in `require'\r\n\tfrom /home/deploy/.rbenv/versions/3.0.3/lib/ruby/gems/3.0.0/gems/bundler-2.2.32/lib/bundler.rb:175:in `require'\r\n\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.0\r\n\r\n**Ruby version**: 3.0.3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44491/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44491/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44489","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44489/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44489/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44489/events","html_url":"https://github.com/rails/rails/issues/44489","id":1144857548,"node_id":"I_kwDNIULORD0jzA","number":44489,"title":"connection.sanitize_limit is no longer needed when building limit clause","user":{"login":"harrycis","id":4240939,"node_id":"MDQ6VXNlcjQyNDA5Mzk=","avatar_url":"https://avatars.githubusercontent.com/u/4240939?v=4","gravatar_id":"","url":"https://api.github.com/users/harrycis","html_url":"https://github.com/harrycis","followers_url":"https://api.github.com/users/harrycis/followers","following_url":"https://api.github.com/users/harrycis/following{/other_user}","gists_url":"https://api.github.com/users/harrycis/gists{/gist_id}","starred_url":"https://api.github.com/users/harrycis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harrycis/subscriptions","organizations_url":"https://api.github.com/users/harrycis/orgs","repos_url":"https://api.github.com/users/harrycis/repos","events_url":"https://api.github.com/users/harrycis/events{/privacy}","received_events_url":"https://api.github.com/users/harrycis/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-02-19T22:05:30Z","updated_at":"2022-05-29T21:32:31Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"connection.sanitize_limit [is currently called](https://github.com/rails/rails/blob/de7c495209811f8f918fa9f915e64df61a6080c1/activerecord/lib/active_record/relation/query_methods.rb#L1347) when building limit clause in Arel. \r\n\r\nIt doesn't seem necessary any more for the following reasons:\r\n1. build_cast_value results in  ActiveModel::Attribute type, which binds the value, and thus prevents SQLi\r\n2. there is little reason to pass in an argument of Arel::Nodes::SqlLiteral type to +limit+ API\r\n\r\nCurrent:\r\n arel.take(build_cast_value(\"LIMIT\", connection.sanitize_limit(limit_value))) if limit_value\r\nExpected:\r\n arel.take(build_cast_value(\"LIMIT\", limit_value.to_i)) if limit_value","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44489/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44489/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44479","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44479/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44479/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44479/events","html_url":"https://github.com/rails/rails/issues/44479","id":1143343989,"node_id":"I_kwDNIULORCYLdQ","number":44479,"title":"When using both touch and counter_cache on a belongs_to association, updated_at on the associated object instance is not updated","user":{"login":"yan-hoose","id":1543171,"node_id":"MDQ6VXNlcjE1NDMxNzE=","avatar_url":"https://avatars.githubusercontent.com/u/1543171?v=4","gravatar_id":"","url":"https://api.github.com/users/yan-hoose","html_url":"https://github.com/yan-hoose","followers_url":"https://api.github.com/users/yan-hoose/followers","following_url":"https://api.github.com/users/yan-hoose/following{/other_user}","gists_url":"https://api.github.com/users/yan-hoose/gists{/gist_id}","starred_url":"https://api.github.com/users/yan-hoose/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yan-hoose/subscriptions","organizations_url":"https://api.github.com/users/yan-hoose/orgs","repos_url":"https://api.github.com/users/yan-hoose/repos","events_url":"https://api.github.com/users/yan-hoose/events{/privacy}","received_events_url":"https://api.github.com/users/yan-hoose/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2022-02-18T16:17:36Z","updated_at":"2022-02-25T13:13:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"Hi everyone!\r\nI ran into an issue with a counter cached `belongs_to` association.\r\n\r\nIn short, when I have an association with only `touch: true`, it works as expected:\r\n```ruby\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post, touch: true\r\nend\r\n# updated_at is updated on the Post instance after doing this\r\npost.comments.create!\r\n```\r\nBut when I add `counter_cache: true` to the same association, it stops working as expected:\r\n```ruby\r\nclass Comment < ActiveRecord::Base\r\n  belongs_to :post, touch: true, counter_cache: true\r\nend\r\n# updated_at is NOT updated on the Post instance after doing this (it has been updated in the DB however)\r\npost.comments.create!\r\n```\r\n\r\n### Steps to reproduce\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  #gem \"rails\", \"6.0.4.6\"\r\n  #gem \"rails\", \"6.1.4.6\"\r\n  #gem \"rails\", \"7.0.2.2\"\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.integer :comments_count, null: false, default: 0\r\n    t.timestamps\r\n  end\r\n\r\n  create_table :comments, force: true do |t|\r\n    t.integer :post_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  has_many :comments\r\nend\r\n\r\nclass Comment < ActiveRecord::Base\r\n  # works as expected\r\n  #belongs_to :post, touch: true\r\n\r\n  # does not work as expected\r\n  belongs_to :post, touch: true, counter_cache: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_post_instance_updated\r\n    post = Post.create!\r\n    previous_updated_at = post.updated_at.to_f.to_s\r\n\r\n    post.comments.create!\r\n\r\n    # expecting post.updated_at to be different from the previous value\r\n    # after creating a new comment on this post\r\n    assert previous_updated_at != post.updated_at.to_f.to_s\r\n  end\r\nend\r\n\r\n```\r\n\r\n### Expected behavior\r\nUpdated `updated_at` should be reflected on the `Post` instance in addition to being updated in the database.\r\n\r\n### Actual behavior\r\nUpdated `updated_at` is not reflected on the `Post` instance. It is however correctly updated in the database.\r\n\r\n### System configuration\r\n**Rails version**:\r\n* 6.0.4.6\r\n* 6.1.4.6\r\n* 7.0.2.2\r\n* main\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44479/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44479/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44477","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44477/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44477/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44477/events","html_url":"https://github.com/rails/rails/issues/44477","id":1142845999,"node_id":"I_kwDNIULORB5yLw","number":44477,"title":"Request.headers in a JSON response raises SystemStackError","user":{"login":"realmocaccino","id":1899068,"node_id":"MDQ6VXNlcjE4OTkwNjg=","avatar_url":"https://avatars.githubusercontent.com/u/1899068?v=4","gravatar_id":"","url":"https://api.github.com/users/realmocaccino","html_url":"https://github.com/realmocaccino","followers_url":"https://api.github.com/users/realmocaccino/followers","following_url":"https://api.github.com/users/realmocaccino/following{/other_user}","gists_url":"https://api.github.com/users/realmocaccino/gists{/gist_id}","starred_url":"https://api.github.com/users/realmocaccino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/realmocaccino/subscriptions","organizations_url":"https://api.github.com/users/realmocaccino/orgs","repos_url":"https://api.github.com/users/realmocaccino/repos","events_url":"https://api.github.com/users/realmocaccino/events{/privacy}","received_events_url":"https://api.github.com/users/realmocaccino/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-02-18T11:00:24Z","updated_at":"2022-03-15T01:40:06Z","closed_at":"2022-03-15T01:40:06Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n```ruby\r\n# app/controllers/home_controller.rb\r\nclass HomeController < ApplicationController\r\n  def index\r\n    return render :json => {\r\n      :headers => request.headers\r\n    }, status: :ok\r\n    rescue SystemStackError => e\r\n      head :internal_server_error\r\n  end\r\nend\r\n\r\n# test/controllers/home_controller_test.rb\r\nrequire \"test_helper\"\r\n\r\nclass HomeControllerTest < ActionDispatch::IntegrationTest\r\n  OK = 200\r\n  INTERNAL_SERVER_ERROR = 500\r\n\r\n  def test_returns_ok\r\n    get '/'\r\n    assert_not response.status == OK\r\n  end\r\n  def test_returns_internal_server_error\r\n    get '/'\r\n    assert response.status == INTERNAL_SERVER_ERROR\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nOutput request's HTTP headers in a JSON response\r\n\r\n### Actual behavior\r\nApplication raises SystemStackError (stack level too deep)\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4.6\r\n**Ruby version**:\r\n3.0.2 p107","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44477/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44477/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44475","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44475/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44475/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44475/events","html_url":"https://github.com/rails/rails/issues/44475","id":1142250977,"node_id":"I_kwDNIULORBVd4Q","number":44475,"title":"ExecutorTest#test_class_serial_is_unaffected always fails","user":{"login":"yahonda","id":73684,"node_id":"MDQ6VXNlcjczNjg0","avatar_url":"https://avatars.githubusercontent.com/u/73684?v=4","gravatar_id":"","url":"https://api.github.com/users/yahonda","html_url":"https://github.com/yahonda","followers_url":"https://api.github.com/users/yahonda/followers","following_url":"https://api.github.com/users/yahonda/following{/other_user}","gists_url":"https://api.github.com/users/yahonda/gists{/gist_id}","starred_url":"https://api.github.com/users/yahonda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yahonda/subscriptions","organizations_url":"https://api.github.com/users/yahonda/orgs","repos_url":"https://api.github.com/users/yahonda/repos","events_url":"https://api.github.com/users/yahonda/events{/privacy}","received_events_url":"https://api.github.com/users/yahonda/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-18T03:02:26Z","updated_at":"2022-02-22T13:35:12Z","closed_at":"2022-02-22T13:35:12Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nManaged to reproduce https://buildkite.com/rails/rails/builds/84752#ba0366db-f450-475a-a6ca-48202fa35e3e but have no idea why.\r\n\r\n```ruby\r\ngit clone https://github.com/rails/rails\r\ncd rails/activesupport\r\nbundle install # `bundle update nokogiri --conservative` if you run Ruby 3.1\r\nbin/test test/executor_test.rb -n test_class_serial_is_unaffected\r\n```\r\n\r\n### Expected behavior\r\nIt should pass.\r\n\r\n### Actual behavior\r\nIt always fails.\r\n\r\n```ruby\r\n$ bin/test test/executor_test.rb -n test_class_serial_is_unaffected\r\nRun options: -n test_class_serial_is_unaffected --seed 37478\r\n\r\n# Running:\r\n\r\nF\r\n\r\nFailure:\r\nExecutorTest#test_class_serial_is_unaffected [/home/yahonda/rails/activesupport/test/executor_test.rb:241]:\r\nExpected: 2694\r\n  Actual: 2696\r\n\r\n\r\nbin/test test/executor_test.rb:220\r\n\r\n\r\n\r\nFinished in 0.013746s, 72.7506 runs/s, 72.7506 assertions/s.\r\n1 runs, 1 assertions, 1 failures, 0 errors, 0 skips\r\n$\r\n```\r\n\r\n### System configuration\r\n**Rails version**: main branch\r\n\r\n**Ruby version**:  It fails against these Rubies.\r\nruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [x86_64-linux]\r\nruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]\r\nruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44475/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44475/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44474","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44474/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44474/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44474/events","html_url":"https://github.com/rails/rails/issues/44474","id":1142139814,"node_id":"I_kwDNIULORBOrpg","number":44474,"title":"ActiveStorage :host in subfolder","user":{"login":"exocode","id":1597621,"node_id":"MDQ6VXNlcjE1OTc2MjE=","avatar_url":"https://avatars.githubusercontent.com/u/1597621?v=4","gravatar_id":"","url":"https://api.github.com/users/exocode","html_url":"https://github.com/exocode","followers_url":"https://api.github.com/users/exocode/followers","following_url":"https://api.github.com/users/exocode/following{/other_user}","gists_url":"https://api.github.com/users/exocode/gists{/gist_id}","starred_url":"https://api.github.com/users/exocode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/exocode/subscriptions","organizations_url":"https://api.github.com/users/exocode/orgs","repos_url":"https://api.github.com/users/exocode/repos","events_url":"https://api.github.com/users/exocode/events{/privacy}","received_events_url":"https://api.github.com/users/exocode/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-18T01:06:44Z","updated_at":"2022-03-23T23:12:51Z","closed_at":"2022-03-23T23:12:51Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nI am using Rails 6.1.4.1 as my backend API.\r\nRails is also handling image upload and variants\r\nI am creating URLs in the model\r\n\r\nBecuase of CORS I am running Rails in the \"subfolder\" `/backend`\r\n\r\nBut the UrlHelpers of ActiveStorage are truncating the `/backend` part of my `ActiveStorage::Current.host` path.\r\n\r\n```ruby\r\n\r\nmodel Product\r\n  ActiveStorage::Current.host = \"http://localhost:8000/backend/\"\r\n\r\n  has_many_attached :photos do |attachable|\r\n    attachable.variant({thumbnail: { resize_to_fill: [90, 90] })\r\n  end\r\n\r\nend\r\n\r\nProduct.last.photos.first.url\r\n```\r\n\r\n### Expected behavior\r\nurls generated by ActiveStorage should be `http:://localhost:8000/backend/`\r\n`http://localhost:8000/backend/rails/active_storage/disk/--9c2c6/400x400.png`\r\n\r\n### Actual behavior\r\nBut gets returned\r\n`http:://localhost:8000`\r\n`http://localhost:8000/rails/active_storage/disk/--9c2c6/400x400.png`\r\n### System configuration\r\n**Rails version**:\r\n`Rails 6.1.4.1`\r\n**Ruby version**:\r\n`ruby 2.7.2p137`\r\n\r\n**How can I explicitly reroute the ActiveStorage generated URLs?**","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44474/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44474/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44465","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44465/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44465/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44465/events","html_url":"https://github.com/rails/rails/issues/44465","id":1141712918,"node_id":"I_kwDNIULORA0oFg","number":44465,"title":"[activerecord] `numericality: {in: ...}` should accept an Array or Set of explicit values","user":{"login":"postmodern","id":12671,"node_id":"MDQ6VXNlcjEyNjcx","avatar_url":"https://avatars.githubusercontent.com/u/12671?v=4","gravatar_id":"","url":"https://api.github.com/users/postmodern","html_url":"https://github.com/postmodern","followers_url":"https://api.github.com/users/postmodern/followers","following_url":"https://api.github.com/users/postmodern/following{/other_user}","gists_url":"https://api.github.com/users/postmodern/gists{/gist_id}","starred_url":"https://api.github.com/users/postmodern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/postmodern/subscriptions","organizations_url":"https://api.github.com/users/postmodern/orgs","repos_url":"https://api.github.com/users/postmodern/repos","events_url":"https://api.github.com/users/postmodern/events{/privacy}","received_events_url":"https://api.github.com/users/postmodern/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-02-17T18:38:38Z","updated_at":"2022-06-02T23:11:58Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In order to be consistent with `inclusion: {in: ...}`, it should be possible to pass an Array or Set of literal Integer values to `numericality: {in: ...}`, instead of only a Range.\r\n\r\n### Steps to reproduce\r\n\r\n#### Gemfile\r\n\r\n```ruby\r\nsource 'https://rubygems.org/'\r\n\r\ngem 'activerecord', '~> 7.0'\r\ngem 'sqlite3'\r\n```\r\n\r\n#### test.rb\r\n\r\n```ruby\r\nrequire 'bundler/setup'\r\nrequire 'active_record'\r\n\r\nclass CreateTestModelTable < ActiveRecord::Migration[7.0]\r\n\r\n  def change\r\n    create_table :test_models do |t|\r\n      t.integer :ip_version\r\n    end\r\n  end\r\n\r\nend\r\n\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\n\r\nCreateTestModelTable.migrate(:up)\r\n\r\nclass TestModel < ActiveRecord::Base\r\n\r\n  attribute :ip_version, :integer\r\n  validates :ip_version, numericality: {in: [4,6]}\r\n\r\nend\r\nTestModel.connection\r\n\r\nrecord = TestModel.new(ip_version: 4)\r\np record.valid?\r\np record.errors\r\n```\r\n\r\n### Expected behavior\r\n\r\n`numericality: {in: ...}` accepts an Array of literal Integer values and validates against them.\r\n\r\n### Actual behavior\r\n\r\n```\r\n==  CreateTestModelTable: migrating ===========================================\r\n-- create_table(:test_models)\r\n   -> 0.0007s\r\n==  CreateTestModelTable: migrated (0.0008s) ==================================\r\n\r\n/home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:29:in `block in check_validity!': :in must be a range (ArgumentError)\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:27:in `each'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:27:in `check_validity!'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validator.rb:142:in `initialize'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:86:in `new'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:86:in `block in validates_with'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:85:in `each'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:85:in `validates_with'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:126:in `block in validates'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:115:in `each'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:115:in `validates'\r\n\tfrom test.rb:21:in `<class:TestModel>'\r\n\tfrom test.rb:18:in `<main>'\r\n```\r\n\r\n### System configuration\r\n\r\n* activerecord 7.0.2.2\r\n* ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44465/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44465/timeline","performed_via_github_app":null,"state_reason":"reopened"},{"url":"https://api.github.com/repos/rails/rails/issues/44461","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44461/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44461/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44461/events","html_url":"https://github.com/rails/rails/issues/44461","id":1141405048,"node_id":"I_kwDNIULORAh1eA","number":44461,"title":"MySQL adapter's change_column_comment looses auto increment","user":{"login":"jhass","id":141294,"node_id":"MDQ6VXNlcjE0MTI5NA==","avatar_url":"https://avatars.githubusercontent.com/u/141294?v=4","gravatar_id":"","url":"https://api.github.com/users/jhass","html_url":"https://github.com/jhass","followers_url":"https://api.github.com/users/jhass/followers","following_url":"https://api.github.com/users/jhass/following{/other_user}","gists_url":"https://api.github.com/users/jhass/gists{/gist_id}","starred_url":"https://api.github.com/users/jhass/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhass/subscriptions","organizations_url":"https://api.github.com/users/jhass/orgs","repos_url":"https://api.github.com/users/jhass/repos","events_url":"https://api.github.com/users/jhass/events{/privacy}","received_events_url":"https://api.github.com/users/jhass/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-17T14:23:35Z","updated_at":"2022-02-18T20:03:51Z","closed_at":"2022-02-18T20:03:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n1. Create table with an auto increment column\r\n2. Call `change_column_comment(:the_table, :the_column, \"some comment\")`\r\n\r\n### Expected behavior\r\n\r\nThe column retains the `AUTO INCREMENT` constraint.\r\n\r\n### Actual behavior\r\n\r\nThe column looses the `AUTO INCREMENT` constraint.\r\n\r\nThis is because `change_column_comment` just calls `change_column` with minimal options rather than reconstructing all possible column options:\r\n\r\nhttps://github.com/rails/rails/blob/7ad7550601a19d94a4bb41b8c49e3bbc3c12b150/activerecord/lib/active_record/connection_adapters/abstract_mysql_adapter.rb#L354-L357\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44461/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44461/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44460","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44460/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44460/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44460/events","html_url":"https://github.com/rails/rails/issues/44460","id":1141397868,"node_id":"I_kwDNIULORAhZbA","number":44460,"title":"validates_with can't be used with multiple Validators when the options hash must contain :attributes","user":{"login":"dspaeth-lp","id":94361863,"node_id":"U_kgDOBZ_ZBw","avatar_url":"https://avatars.githubusercontent.com/u/94361863?v=4","gravatar_id":"","url":"https://api.github.com/users/dspaeth-lp","html_url":"https://github.com/dspaeth-lp","followers_url":"https://api.github.com/users/dspaeth-lp/followers","following_url":"https://api.github.com/users/dspaeth-lp/following{/other_user}","gists_url":"https://api.github.com/users/dspaeth-lp/gists{/gist_id}","starred_url":"https://api.github.com/users/dspaeth-lp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dspaeth-lp/subscriptions","organizations_url":"https://api.github.com/users/dspaeth-lp/orgs","repos_url":"https://api.github.com/users/dspaeth-lp/repos","events_url":"https://api.github.com/users/dspaeth-lp/events{/privacy}","received_events_url":"https://api.github.com/users/dspaeth-lp/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-17T14:17:53Z","updated_at":"2022-05-26T21:02:35Z","closed_at":"2022-05-26T21:02:35Z","author_association":"NONE","active_lock_reason":null,"body":"The `ActiveModel::EachValidator`\r\n[deletes](https://github.com/rails/rails/blob/7-0-stable/activemodel/lib/active_model/validator.rb#L139) the `:attributes` key from the provided options hash.\r\n\r\nWhen I use `validates_with` with multiple validators that require an `:attribute` options, I get an exception,\r\nbecause the `options` hash is [reused](https://github.com/rails/rails/blob/7-0-stable/activemodel/lib/active_model/validations/with.rb#L142) and altered under the hood.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: \"sqlite3\", database: \":memory:\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.string :name\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base\r\n  validate :my_validations\r\n\r\n  def my_validations\r\n     validates_with ActiveRecord::Validations::UniquenessValidator, ActiveRecord::Validations::PresenceValidator, { attributes: [:name], allow_nil: true }\r\n  end\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_validations\r\n    post = Post.new name: 'a' \r\n\r\n    assert post.valid?\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nThis test should pass. `validates_with` should pass a duplicate of the option hash to the validators or \r\n`ActiveModel::EachValidator` should duplicate the options hash before modifying it.\r\n\r\n### Actual behavior\r\n\r\nAn `ArgumentError`: `:attributes` cannot be blank\r\n\r\n### System configuration\r\n**Rails version**: 6.1, 7.0\r\n\r\n**Ruby version**:  2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44460/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44460/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44458","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44458/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44458/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44458/events","html_url":"https://github.com/rails/rails/issues/44458","id":1141197015,"node_id":"I_kwDNIULORAVI1w","number":44458,"title":"Make before_commit hook public API","user":{"login":"splattael","id":28908,"node_id":"MDQ6VXNlcjI4OTA4","avatar_url":"https://avatars.githubusercontent.com/u/28908?v=4","gravatar_id":"","url":"https://api.github.com/users/splattael","html_url":"https://github.com/splattael","followers_url":"https://api.github.com/users/splattael/followers","following_url":"https://api.github.com/users/splattael/following{/other_user}","gists_url":"https://api.github.com/users/splattael/gists{/gist_id}","starred_url":"https://api.github.com/users/splattael/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/splattael/subscriptions","organizations_url":"https://api.github.com/users/splattael/orgs","repos_url":"https://api.github.com/users/splattael/repos","events_url":"https://api.github.com/users/splattael/events{/privacy}","received_events_url":"https://api.github.com/users/splattael/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-17T11:09:50Z","updated_at":"2022-03-17T22:38:01Z","closed_at":"2022-02-25T22:30:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The hook `before_commit` was added back in https://github.com/rails/rails/pull/18936 and was considered private API:\r\n\r\n> Keep in mind all this APIs are private for now, so we can use on https://github.com/rails/rails/pull/18824, and shape them before making them public.(if even we will)\r\n\r\nIn https://github.com/rails/rails/issues/25896 it was stated:\r\n\r\n> It is not public API and should be not used in applications. It is for Rails internal usage.\r\n\r\nThis happened 6 years ago.\r\n\r\nDo we consider `before_commit` hook stable now and should this API made public? :thinking: \r\n\r\nRefs https://gitlab.com/gitlab-org/gitlab/-/merge_requests/79964#note_844034381","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44458/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44458/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44457","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44457/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44457/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44457/events","html_url":"https://github.com/rails/rails/issues/44457","id":1141062954,"node_id":"I_kwDNIULORAM9Kg","number":44457,"title":"[activerecord] It should not be possible to define an `enum` without a Hash","user":{"login":"postmodern","id":12671,"node_id":"MDQ6VXNlcjEyNjcx","avatar_url":"https://avatars.githubusercontent.com/u/12671?v=4","gravatar_id":"","url":"https://api.github.com/users/postmodern","html_url":"https://github.com/postmodern","followers_url":"https://api.github.com/users/postmodern/followers","following_url":"https://api.github.com/users/postmodern/following{/other_user}","gists_url":"https://api.github.com/users/postmodern/gists{/gist_id}","starred_url":"https://api.github.com/users/postmodern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/postmodern/subscriptions","organizations_url":"https://api.github.com/users/postmodern/orgs","repos_url":"https://api.github.com/users/postmodern/repos","events_url":"https://api.github.com/users/postmodern/events{/privacy}","received_events_url":"https://api.github.com/users/postmodern/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2022-02-17T09:13:11Z","updated_at":"2022-02-19T08:25:41Z","closed_at":"2022-02-19T08:25:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n#### Gemfile\r\n\r\n```ruby\r\nsource 'https://rubygems.org/'\r\n\r\ngem 'activerecord', '~> 7.0'\r\ngem 'sqlite3'\r\n```\r\n\r\n#### test.rb\r\n\r\n```ruby\r\nrequire 'bundler/setup'\r\nrequire 'active_record'\r\n\r\nclass CreateTestModelTable < ActiveRecord::Migration[7.0]\r\n\r\n  def change\r\n    create_table :test_models do |t|\r\n      t.string :my_enum\r\n    end\r\n  end\r\n\r\nend\r\n\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\n\r\nCreateTestModelTable.migrate(:up)\r\n\r\nclass TestModel < ActiveRecord::Base\r\n\r\n  enum :my_enum # BUG: should not be possible to call enum with only a name, but no Hash of values\r\n  validates :my_enum, inclusion: {in: [1,2,3]}\r\n\r\nend\r\nTestModel.connection\r\n\r\np TestModel\r\n\r\nrecord = TestModel.new(my_enum: 1)\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nAn `ArgumentError` should be raised indicating that `enum` was called with only 1 argument, instead of 2 or more.\r\n\r\n### Actual behavior\r\n\r\n```\r\n==  CreateTestModelTable: migrating ===========================================\r\n-- create_table(:test_models)\r\n   -> 0.0005s\r\n==  CreateTestModelTable: migrated (0.0007s) ==================================\r\n\r\nTestModel(id: integer, my_enum: string)\r\n/home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/enum.rb:157:in `assert_valid_value': '1' is not a valid my_enum (ArgumentError)\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute.rb:76:in `with_value_from_user'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute_set.rb:55:in `write_from_user'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/attribute_methods/write.rb:42:in `_write_attribute'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute_methods.rb:277:in `my_enum='\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute_assignment.rb:49:in `public_send'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute_assignment.rb:49:in `_assign_attribute'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/attribute_assignment.rb:21:in `block in _assign_attributes'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/attribute_assignment.rb:13:in `each'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/attribute_assignment.rb:13:in `_assign_attributes'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/attribute_assignment.rb:34:in `assign_attributes'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/core.rb:468:in `initialize'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/inheritance.rb:75:in `new'\r\n\tfrom /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activerecord-7.0.2.2/lib/active_record/inheritance.rb:75:in `new'\r\n\tfrom test.rb:28:in `<main>'\r\n```\r\n\r\n### System configuration\r\n\r\n* activerecord-7.0.2.2\r\n* ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44457/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44457/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44453","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44453/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44453/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44453/events","html_url":"https://github.com/rails/rails/issues/44453","id":1140682767,"node_id":"I_kwDNIULOQ_1wDw","number":44453,"title":"`# :nodoc:` on ActiveModel::Errors#copy!","user":{"login":"jameno","id":25379576,"node_id":"MDQ6VXNlcjI1Mzc5NTc2","avatar_url":"https://avatars.githubusercontent.com/u/25379576?v=4","gravatar_id":"","url":"https://api.github.com/users/jameno","html_url":"https://github.com/jameno","followers_url":"https://api.github.com/users/jameno/followers","following_url":"https://api.github.com/users/jameno/following{/other_user}","gists_url":"https://api.github.com/users/jameno/gists{/gist_id}","starred_url":"https://api.github.com/users/jameno/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jameno/subscriptions","organizations_url":"https://api.github.com/users/jameno/orgs","repos_url":"https://api.github.com/users/jameno/repos","events_url":"https://api.github.com/users/jameno/events{/privacy}","received_events_url":"https://api.github.com/users/jameno/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-16T23:13:05Z","updated_at":"2022-06-29T16:36:58Z","closed_at":"2022-06-29T16:36:58Z","author_association":"NONE","active_lock_reason":null,"body":"`ActiveModel::Errors#copy!` is a useful method, but it does not appear in the documentation.\r\n\r\nIs there some reason this is marked with `# :nodoc:`?\r\n\r\nhttps://github.com/rails/rails/blob/0dbe699d5cd2b57a4a253283a7d7b7ffdd74db28/activemodel/lib/active_model/errors.rb#L102-L115","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44453/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44453/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44452","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44452/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44452/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44452/events","html_url":"https://github.com/rails/rails/issues/44452","id":1140574357,"node_id":"I_kwDNIULOQ_vIlQ","number":44452,"title":"Pathname.presence has surprising semantics","user":{"login":"akimd","id":232441,"node_id":"MDQ6VXNlcjIzMjQ0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/232441?v=4","gravatar_id":"","url":"https://api.github.com/users/akimd","html_url":"https://github.com/akimd","followers_url":"https://api.github.com/users/akimd/followers","following_url":"https://api.github.com/users/akimd/following{/other_user}","gists_url":"https://api.github.com/users/akimd/gists{/gist_id}","starred_url":"https://api.github.com/users/akimd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/akimd/subscriptions","organizations_url":"https://api.github.com/users/akimd/orgs","repos_url":"https://api.github.com/users/akimd/repos","events_url":"https://api.github.com/users/akimd/events{/privacy}","received_events_url":"https://api.github.com/users/akimd/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-16T20:51:44Z","updated_at":"2022-02-20T08:32:48Z","closed_at":"2022-02-20T08:32:48Z","author_association":"NONE","active_lock_reason":null,"body":"Because `Object#blank?` bounces to `empty?` if it exists, and because `Pathname#empty?` checks whether the directory/file is empty, the result is, I venture, not the intended semantics.  IMHO, `Pathname#blank?` should check whether this is `Pathname.new('')`.\r\n\r\n### Steps to reproduce\r\n```ruby\r\np = Pathname.new('/tmp/foo')  # Where /tmp/foo does not exist.\r\np p.presence # => #<Pathname:/tmp/foo>\r\np.mkpath\r\np p.presence  # => nil\r\n\r\np Pathname.new('').blank? # => false\r\n```\r\n\r\n### Expected behavior\r\n\r\nI expect `Pathname#blank?` to behave like `to_s.empty?`, or, arguably, like `to_s.blank?`.\r\n\r\n### Actual behavior\r\n\r\nTells whether the file/dir is empty.\r\n\r\n### System configuration\r\n**Rails version**:\r\n\r\n7.0.1\r\n\r\n**Ruby version**:\r\n\r\n2.7.4","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44452/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44452/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44444","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44444/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44444/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44444/events","html_url":"https://github.com/rails/rails/issues/44444","id":1139454276,"node_id":"I_kwDNIULOQ-qxRA","number":44444,"title":"Doing a request.params within a log_tag lambda causes malformed parameters to bubble up to puma","user":{"login":"arianf","id":7397857,"node_id":"MDQ6VXNlcjczOTc4NTc=","avatar_url":"https://avatars.githubusercontent.com/u/7397857?v=4","gravatar_id":"","url":"https://api.github.com/users/arianf","html_url":"https://github.com/arianf","followers_url":"https://api.github.com/users/arianf/followers","following_url":"https://api.github.com/users/arianf/following{/other_user}","gists_url":"https://api.github.com/users/arianf/gists{/gist_id}","starred_url":"https://api.github.com/users/arianf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arianf/subscriptions","organizations_url":"https://api.github.com/users/arianf/orgs","repos_url":"https://api.github.com/users/arianf/repos","events_url":"https://api.github.com/users/arianf/events{/privacy}","received_events_url":"https://api.github.com/users/arianf/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false},"assignees":[{"login":"gmcgibbon","id":5162312,"node_id":"MDQ6VXNlcjUxNjIzMTI=","avatar_url":"https://avatars.githubusercontent.com/u/5162312?v=4","gravatar_id":"","url":"https://api.github.com/users/gmcgibbon","html_url":"https://github.com/gmcgibbon","followers_url":"https://api.github.com/users/gmcgibbon/followers","following_url":"https://api.github.com/users/gmcgibbon/following{/other_user}","gists_url":"https://api.github.com/users/gmcgibbon/gists{/gist_id}","starred_url":"https://api.github.com/users/gmcgibbon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmcgibbon/subscriptions","organizations_url":"https://api.github.com/users/gmcgibbon/orgs","repos_url":"https://api.github.com/users/gmcgibbon/repos","events_url":"https://api.github.com/users/gmcgibbon/events{/privacy}","received_events_url":"https://api.github.com/users/gmcgibbon/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2022-02-16T02:40:54Z","updated_at":"2022-02-16T20:22:37Z","closed_at":"2022-02-16T19:43:56Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nChange config.log_tag to the following:\r\n\r\n```ruby\r\nconfig.log_tags = [\r\n  -> (req) { req.params[:hi] }\r\n]\r\n```\r\n\r\nThen make a curl request with invalid data that is not `application/json` valid.\r\n```bash\r\ncurl -X \"PUT\" \"http://localhost:3000/?hi=5\" \\\r\n     -H 'Content-Type: application/json' \\\r\n     -H 'Accept: application/json' \\\r\n     -d \"asdfadf\"\r\n```\r\n\r\nThe error will bubble up to puma\r\n`Puma caught this error: 765: unexpected token at 'asdfadf' (ActionDispatch::Http::Parameters::ParseError)`\r\n\r\n### Expected behavior\r\nTo be captured internally within rails and a 400 respond be sent `{\"status\":400,\"error\":\"Bad Request\"}`\r\n\r\n### Actual behavior\r\n`Puma caught this error: 765: unexpected token at 'asdfadf' (ActionDispatch::Http::Parameters::ParseError)`\r\n\r\n### System configuration\r\n**Rails version**: I tried rails (7.0.1) and rails (5.2.6.2)\r\n\r\n**Ruby version**:\r\n2.7.2 and 2.6.9","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44444/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44444/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44443","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44443/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44443/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44443/events","html_url":"https://github.com/rails/rails/issues/44443","id":1139342252,"node_id":"I_kwDNIULOQ-j7rA","number":44443,"title":"`rails new rails_app` command fails in Rails v5.2.6.2","user":{"login":"AndyObtiva","id":23052,"node_id":"MDQ6VXNlcjIzMDUy","avatar_url":"https://avatars.githubusercontent.com/u/23052?v=4","gravatar_id":"","url":"https://api.github.com/users/AndyObtiva","html_url":"https://github.com/AndyObtiva","followers_url":"https://api.github.com/users/AndyObtiva/followers","following_url":"https://api.github.com/users/AndyObtiva/following{/other_user}","gists_url":"https://api.github.com/users/AndyObtiva/gists{/gist_id}","starred_url":"https://api.github.com/users/AndyObtiva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndyObtiva/subscriptions","organizations_url":"https://api.github.com/users/AndyObtiva/orgs","repos_url":"https://api.github.com/users/AndyObtiva/repos","events_url":"https://api.github.com/users/AndyObtiva/events{/privacy}","received_events_url":"https://api.github.com/users/AndyObtiva/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-16T00:10:11Z","updated_at":"2022-02-16T02:44:39Z","closed_at":"2022-02-16T02:44:38Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nRun the following in a clean Ruby v3.0.2 environment (e.g. a new [RVM gemset](https://rvm.io/gemsets/basics)):\r\n```\r\ngem install rails -v5.2.6.2\r\nrails new rails_app\r\n```\r\n\r\n### Expected behavior\r\n\r\nIt should just work as expected by generating a new Rails 5 application.\r\n\r\n### Actual behavior\r\n\r\nThe `rails new rails_app` command fails with an error:\r\n\r\n```\r\nrails new rails_app         \r\n      create  \r\n      create  README.md\r\n      create  Rakefile\r\n      create  .ruby-version\r\n      create  config.ru\r\n      create  .gitignore\r\n      create  Gemfile\r\n         run  git init from \".\"\r\nInitialized empty Git repository in /Users/andymaleh/code/rails_app/.git/\r\n      create  package.json\r\n      create  app\r\n      create  app/assets/config/manifest.js\r\n      create  app/assets/javascripts/application.js\r\n      create  app/assets/javascripts/cable.js\r\n      create  app/assets/stylesheets/application.css\r\n      create  app/channels/application_cable/channel.rb\r\n      create  app/channels/application_cable/connection.rb\r\n      create  app/controllers/application_controller.rb\r\n      create  app/helpers/application_helper.rb\r\n      create  app/jobs/application_job.rb\r\n      create  app/mailers/application_mailer.rb\r\n      create  app/models/application_record.rb\r\n      create  app/views/layouts/application.html.erb\r\n      create  app/views/layouts/mailer.html.erb\r\n      create  app/views/layouts/mailer.text.erb\r\n      create  app/assets/images/.keep\r\n      create  app/assets/javascripts/channels\r\n      create  app/assets/javascripts/channels/.keep\r\n      create  app/controllers/concerns/.keep\r\n      create  app/models/concerns/.keep\r\n      create  bin\r\n      create  bin/bundle\r\n      create  bin/rails\r\n      create  bin/rake\r\n      create  bin/setup\r\n      create  bin/update\r\n      create  bin/yarn\r\n      create  config\r\n      create  config/routes.rb\r\n      create  config/application.rb\r\n      create  config/environment.rb\r\n      create  config/cable.yml\r\n      create  config/puma.rb\r\n      create  config/spring.rb\r\n      create  config/storage.yml\r\n      create  config/environments\r\n      create  config/environments/development.rb\r\n      create  config/environments/production.rb\r\n      create  config/environments/test.rb\r\n      create  config/initializers\r\n      create  config/initializers/application_controller_renderer.rb\r\n      create  config/initializers/assets.rb\r\n      create  config/initializers/backtrace_silencers.rb\r\n      create  config/initializers/content_security_policy.rb\r\n      create  config/initializers/cookies_serializer.rb\r\n      create  config/initializers/cors.rb\r\n      create  config/initializers/filter_parameter_logging.rb\r\n      create  config/initializers/inflections.rb\r\n      create  config/initializers/mime_types.rb\r\n      create  config/initializers/new_framework_defaults_5_2.rb\r\n      create  config/initializers/wrap_parameters.rb\r\n      create  config/locales\r\n      create  config/locales/en.yml\r\n      create  config/master.key\r\n      append  .gitignore\r\n/Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/messages/metadata.rb:17:in `wrap': wrong number of arguments (given 2, expected 1) (ArgumentError)\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/message_encryptor.rb:175:in `_encrypt'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/message_encryptor.rb:151:in `encrypt_and_sign'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/encrypted_file.rb:75:in `encrypt'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/encrypted_file.rb:49:in `write'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/activesupport-5.2.6.2/lib/active_support/encrypted_configuration.rb:29:in `write'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/generators/rails/credentials/credentials_generator.rb:31:in `add_credentials_file_silently'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/generators/rails/app/app_generator.rb:185:in `credentials'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/generators/app_base.rb:159:in `build'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/generators/rails/app/app_generator.rb:328:in `create_credentials'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:134:in `block in invoke_all'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:134:in `each'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:134:in `map'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:134:in `invoke_all'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/group.rb:232:in `dispatch'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/base.rb:485:in `start'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/commands/application/application_command.rb:26:in `perform'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/command.rb:27:in `run'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/thor-1.2.1/lib/thor.rb:392:in `dispatch'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/command/base.rb:69:in `perform'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/command.rb:46:in `invoke'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/lib/rails/cli.rb:18:in `<top (required)>'\r\n\tfrom <internal:/Users/andymaleh/.rvm/rubies/ruby-3.0.2/lib/ruby/site_ruby/3.0.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/Users/andymaleh/.rvm/rubies/ruby-3.0.2/lib/ruby/site_ruby/3.0.0/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/gems/railties-5.2.6.2/exe/rails:10:in `<top (required)>'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/bin/rails:25:in `load'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/bin/rails:25:in `<main>'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/bin/ruby_executable_hooks:22:in `eval'\r\n\tfrom /Users/andymaleh/.rvm/gems/ruby-3.0.2@code/bin/ruby_executable_hooks:22:in `<main>'\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 5.2.6.2\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44443/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44443/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44430","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44430/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44430/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44430/events","html_url":"https://github.com/rails/rails/issues/44430","id":1137804923,"node_id":"I_kwDNIULOQ9GGew","number":44430,"title":"Rails 5.2 Guides link leads to Edge Guides","user":{"login":"fitterflytech","id":22402409,"node_id":"MDEyOk9yZ2FuaXphdGlvbjIyNDAyNDA5","avatar_url":"https://avatars.githubusercontent.com/u/22402409?v=4","gravatar_id":"","url":"https://api.github.com/users/fitterflytech","html_url":"https://github.com/fitterflytech","followers_url":"https://api.github.com/users/fitterflytech/followers","following_url":"https://api.github.com/users/fitterflytech/following{/other_user}","gists_url":"https://api.github.com/users/fitterflytech/gists{/gist_id}","starred_url":"https://api.github.com/users/fitterflytech/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fitterflytech/subscriptions","organizations_url":"https://api.github.com/users/fitterflytech/orgs","repos_url":"https://api.github.com/users/fitterflytech/repos","events_url":"https://api.github.com/users/fitterflytech/events{/privacy}","received_events_url":"https://api.github.com/users/fitterflytech/received_events","type":"Organization","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-14T20:28:05Z","updated_at":"2022-02-17T17:50:14Z","closed_at":"2022-02-17T17:50:13Z","author_association":"NONE","active_lock_reason":null,"body":"This link I got from the homepage for Guides on Rails version 5.2 => https://guides.rubyonrails.org/v5.2/\r\nwhich leads me to Edge guides page.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44430/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44430/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44425","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44425/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44425/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44425/events","html_url":"https://github.com/rails/rails/issues/44425","id":1137257224,"node_id":"I_kwDNIULOQ8krCA","number":44425,"title":"AttrEncrypted::Adapters::ActiveRecord not working","user":{"login":"celsoMartins","id":214322,"node_id":"MDQ6VXNlcjIxNDMyMg==","avatar_url":"https://avatars.githubusercontent.com/u/214322?v=4","gravatar_id":"","url":"https://api.github.com/users/celsoMartins","html_url":"https://github.com/celsoMartins","followers_url":"https://api.github.com/users/celsoMartins/followers","following_url":"https://api.github.com/users/celsoMartins/following{/other_user}","gists_url":"https://api.github.com/users/celsoMartins/gists{/gist_id}","starred_url":"https://api.github.com/users/celsoMartins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/celsoMartins/subscriptions","organizations_url":"https://api.github.com/users/celsoMartins/orgs","repos_url":"https://api.github.com/users/celsoMartins/repos","events_url":"https://api.github.com/users/celsoMartins/events{/privacy}","received_events_url":"https://api.github.com/users/celsoMartins/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-14T12:50:26Z","updated_at":"2022-02-14T13:48:15Z","closed_at":"2022-02-14T13:48:15Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n- Update rails to rails 7\r\n- run ```rails app:update```\r\n- run ```bin/rails db:environment:set RAILS_ENV=test --trace```\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\nEnvironment set in the schema.rb\r\n\r\n### Actual behavior\r\n```** Invoke db:environment:set (first_time)\r\n** Invoke db:load_config (first_time)\r\n** Invoke environment (first_time)\r\n** Execute environment\r\n** Execute db:load_config\r\n** Execute db:environment:set\r\nrails aborted!\r\nNoMethodError: undefined method `key?' for false:FalseClass\r\n\r\n              send method, new_attributes.reject { |k, _|  self.class.encrypted_attributes?.key?(k.to_sym) }, *args\r\n                                                                                           ^^^^^\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/attr_encrypted-3.1.0/lib/attr_encrypted/adapters/active_record.rb:28:in `block in perform_attribute_assignment'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/attr_encrypted-3.1.0/lib/attr_encrypted/adapters/active_record.rb:28:in `reject'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/attr_encrypted-3.1.0/lib/attr_encrypted/adapters/active_record.rb:28:in `perform_attribute_assignment'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/attr_encrypted-3.1.0/lib/attr_encrypted/adapters/active_record.rb:36:in `assign_attributes'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/core.rb:468:in `initialize'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/inheritance.rb:75:in `new'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/inheritance.rb:75:in `new'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:861:in `_new'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:71:in `block in new'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:880:in `_scoping'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:428:in `scoping'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:71:in `new'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/relation.rb:227:in `find_or_initialize_by'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/querying.rb:22:in `find_or_initialize_by'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/internal_metadata.rb:31:in `[]='\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/activerecord-7.0.2.2/lib/active_record/railties/databases.rake:14:in `block (2 levels) in <top (required)>'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:281:in `block in execute'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:281:in `each'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:281:in `execute'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:219:in `block in invoke_with_call_chain'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:199:in `synchronize'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:199:in `invoke_with_call_chain'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/task.rb:188:in `invoke'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:160:in `invoke_task'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:116:in `block (2 levels) in top_level'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:116:in `each'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:116:in `block in top_level'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:125:in `run_with_threads'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:110:in `top_level'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/railties-7.0.2.2/lib/rails/commands/rake/rake_command.rb:24:in `block (2 levels) in perform'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/application.rb:186:in `standard_exception_handling'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/railties-7.0.2.2/lib/rails/commands/rake/rake_command.rb:24:in `block in perform'\r\n/Users/celsomartins/.rvm/rubies/ruby-3.1.0/lib/ruby/gems/3.1.0/gems/rake-13.0.6/lib/rake/rake_module.rb:59:in `with_application'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/railties-7.0.2.2/lib/rails/commands/rake/rake_command.rb:18:in `perform'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/railties-7.0.2.2/lib/rails/command.rb:51:in `invoke'\r\n/Users/celsomartins/.rvm/gems/ruby-3.1.0@flow_climate/gems/railties-7.0.2.2/lib/rails/commands.rb:18:in `<top (required)>'\r\nbin/rails:4:in `require'\r\nbin/rails:4:in `<main>'\r\nTasks: TOP => db:environment:set\r\n```\r\n\r\n### System configuration\r\n**Rails version**: rails (7.0.2.2)\r\n\r\n**Ruby version**: ruby-3.1.0\r\n\r\nComments on issue:\r\n\r\nWhen I added a null check to the line, the task worked:\r\n\r\n```send method, new_attributes.reject { |k, _|  self.class.encrypted_attributes&.key?(k.to_sym) }, *args```\r\n\r\nWhen I inspected the ```self.class``` the result was ```ActiveRecord::InternalMetadata```\r\n\r\nI already removed all encryptations in my code and the issue remains.\r\n\r\nThanks in advance.\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44425/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44425/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44424","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44424/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44424/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44424/events","html_url":"https://github.com/rails/rails/issues/44424","id":1136649521,"node_id":"I_kwDNIULOQ7_lMQ","number":44424,"title":"Rails 7 - referring an ActiveRecord model in an initializer does not work","user":{"login":"kapso","id":344198,"node_id":"MDQ6VXNlcjM0NDE5OA==","avatar_url":"https://avatars.githubusercontent.com/u/344198?v=4","gravatar_id":"","url":"https://api.github.com/users/kapso","html_url":"https://github.com/kapso","followers_url":"https://api.github.com/users/kapso/followers","following_url":"https://api.github.com/users/kapso/following{/other_user}","gists_url":"https://api.github.com/users/kapso/gists{/gist_id}","starred_url":"https://api.github.com/users/kapso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kapso/subscriptions","organizations_url":"https://api.github.com/users/kapso/orgs","repos_url":"https://api.github.com/users/kapso/repos","events_url":"https://api.github.com/users/kapso/events{/privacy}","received_events_url":"https://api.github.com/users/kapso/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-14T02:08:11Z","updated_at":"2022-02-14T18:10:16Z","closed_at":"2022-02-14T18:10:16Z","author_association":"NONE","active_lock_reason":null,"body":"We have an initializer that refers to an ActiveRecord model, so something like this...\r\n\r\n`config/initializers/user_init.rb`\r\n```ruby\r\n# User is an ActiveRecord model\r\nUser.load_settings # Pre-load app settings in the initializer from an external HTTP source\r\n```\r\n\r\nBut Rails cannot find the model (this works in Rails 6.1.x)\r\n```\r\n/Users/kapil/projects/test_me/config/initializers/user_init.rb:1:in `<main>': uninitialized constant User (NameError)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.2\r\n\r\n**Ruby version**: 3.1.0\r\n\r\nIs this expected behavior in `v7.x`?\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44424/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44424/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44418","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44418/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44418/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44418/events","html_url":"https://github.com/rails/rails/issues/44418","id":1136254837,"node_id":"I_kwDNIULOQ7nfdQ","number":44418,"title":"Multiple \"fixtures\" folders support","user":{"login":"inem","id":9665,"node_id":"MDQ6VXNlcjk2NjU=","avatar_url":"https://avatars.githubusercontent.com/u/9665?v=4","gravatar_id":"","url":"https://api.github.com/users/inem","html_url":"https://github.com/inem","followers_url":"https://api.github.com/users/inem/followers","following_url":"https://api.github.com/users/inem/following{/other_user}","gists_url":"https://api.github.com/users/inem/gists{/gist_id}","starred_url":"https://api.github.com/users/inem/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inem/subscriptions","organizations_url":"https://api.github.com/users/inem/orgs","repos_url":"https://api.github.com/users/inem/repos","events_url":"https://api.github.com/users/inem/events{/privacy}","received_events_url":"https://api.github.com/users/inem/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-02-13T18:28:55Z","updated_at":"2022-08-07T15:06:38Z","closed_at":"2022-02-14T20:52:44Z","author_association":"NONE","active_lock_reason":null,"body":"Hello, I am trying to have two sets of fixtures in my Rails app. The reason behind that is fixtures library became quite big, and hard to maintain. My idea is to have two separate sets of fixtures - one for one subset of features, another one - for the rest.\r\n\r\nAnother potential use-case: When you have a legacy app with a mess in fixtures, you put your fixtures into \"quarantine\" folder, and mark you tests accordingly, and go through your tests one by one and give fixtures a better organization in a separate folder (and making related tests use different fixtures folder).\r\n\r\nI was able to find a brief mention that it fixtures path might be configurable [here](https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html): `ActiveSupport::TestCase.fixture_path=(path)`\r\n\r\nAlso [here](https://github.com/rails/rails/blob/24956f2e5fdbc43ff5e073a8f5c4d7f710d359e5/actionmailbox/test/test_helper.rb#L17): `ActionDispatch::IntegrationTest.fixture_path = ActiveSupport::TestCase.fixture_path`.\r\n\r\nI tried setting alternative paths in:\r\n- specific test files - with no effect\r\n- test helper - got `NoMethodError: undefined method `users'`\r\n\r\nI also tried to use low level helper `ActiveRecord::FixtureSet.create_fixtures('test/fixtures-2', model_name)`, but it gives you not very useable array of something.  Also, it seems to ignore the path you pass to it ('test/fixtures-2'):\r\n\r\n```\r\n @name=\"users\",\r\n @path=\"/usr/src/app/test/fixtures/users\",\r\n @table_name=\"users\">\r\n```\r\n\r\nI would appreciate any hints how could one make multiple folders of fixtures working in a Rails app. Thanks!","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44418/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44418/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44416","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44416/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44416/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44416/events","html_url":"https://github.com/rails/rails/issues/44416","id":1134846205,"node_id":"I_kwDNIULOQ6Rg_Q","number":44416,"title":"ActionCable ignores WebSocket protocol making the connection close with status 1066","user":{"login":"fabiolnm","id":508671,"node_id":"MDQ6VXNlcjUwODY3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/508671?v=4","gravatar_id":"","url":"https://api.github.com/users/fabiolnm","html_url":"https://github.com/fabiolnm","followers_url":"https://api.github.com/users/fabiolnm/followers","following_url":"https://api.github.com/users/fabiolnm/following{/other_user}","gists_url":"https://api.github.com/users/fabiolnm/gists{/gist_id}","starred_url":"https://api.github.com/users/fabiolnm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fabiolnm/subscriptions","organizations_url":"https://api.github.com/users/fabiolnm/orgs","repos_url":"https://api.github.com/users/fabiolnm/repos","events_url":"https://api.github.com/users/fabiolnm/events{/privacy}","received_events_url":"https://api.github.com/users/fabiolnm/received_events","type":"User","site_admin":false},"labels":[{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-13T00:13:22Z","updated_at":"2022-05-22T21:39:16Z","closed_at":"2022-05-22T21:39:16Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Proof of Concept\r\nhttp://action-cable-protocol.herokuapp.com/\r\n\r\n## Context\r\nSome firmwares communicate using WebSockets specifying the WebSocket protocol argument. If the protocol is specified, the `/cable` endpoint should upgrade the connection instead of closing it with status 1066.\r\n\r\n### Connect WebSocket to ActionCable without a protocol header\r\nIt works if the websocket receive no protocol param\r\n```\r\nwebsocket = new WebSocket('http://localhost/cable');\r\n```\r\n### WebSocket to ActionCable passing null protocol header\r\nThis code fails with status error = 1066\r\n```\r\nwebsocket = new WebSocket('http://localhost/cable', null);\r\n```\r\n### WebSocket to ActionCable passing custom protocol header\r\nThis code fails with status error = 1066\r\n```\r\nwebsocket = new WebSocket('http://localhost/cable', 'custom');\r\n```\r\n### Possible Cause\r\nThe `ActionCable::Connection::WebSocket` constructor defines a named argument `protocols` https://github.com/rails/rails/blob/f9a1671c182eb2ed5fb159f154bc03195bcb7238/actioncable/lib/action_cable/connection/web_socket.rb#L8-L11\r\nwhich default is `ActionCable::INTERNAL[:protocols]`:\r\n```\r\nirb(main):001:0> ActionCable::INTERNAL[:protocols]\r\n=> [\"actioncable-v1-json\", \"actioncable-unsupported\"]\r\n```\r\nHowever, the WebSocket protocol header is not passed when the object is instantiated https://github.com/rails/rails/blob/f9a1671c182eb2ed5fb159f154bc03195bcb7238/actioncable/lib/action_cable/connection/base.rb#L61\r\n\r\n### Monkey Patch\r\nThe following monkey patch (proof of concept) overrides the `Action::Cable::Connection::Base` constructor to initialize the WebSocket with the proper protocols argument.\r\n```\r\n  module ActionCable\r\n    module Connection\r\n      class Base\r\n        def initialize(server, env, coder: ActiveSupport::JSON)\r\n          @server, @env, @coder = server, env, coder\r\n\r\n          @worker_pool = server.worker_pool\r\n          @logger = new_tagged_logger\r\n\r\n          if Rack::Request.new(env).params['patch_action_cable']\r\n            @websocket    = ActionCable::Connection::WebSocket.new env,\r\n              self, event_loop, protocols: @env['HTTP_SEC_WEBSOCKET_PROTOCOL']\r\n          else\r\n            @websocket    = ActionCable::Connection::WebSocket.new(env, self, event_loop)\r\n          end\r\n          @subscriptions  = ActionCable::Connection::Subscriptions.new(self)\r\n          @message_buffer = ActionCable::Connection::MessageBuffer.new(self)\r\n\r\n          @_internal_subscriptions = nil\r\n          @started_at = Time.now\r\n        end\r\n      end\r\n    end\r\n  end\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44416/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44416/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44407","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44407/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44407/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44407/events","html_url":"https://github.com/rails/rails/issues/44407","id":1133048458,"node_id":"I_kwDNIULOQ4jyig","number":44407,"title":"NameError: undefined local variable or method `state' for ActiveSupport::IsolatedExecutionState:Module","user":{"login":"sebitoelcheater","id":2347536,"node_id":"MDQ6VXNlcjIzNDc1MzY=","avatar_url":"https://avatars.githubusercontent.com/u/2347536?v=4","gravatar_id":"","url":"https://api.github.com/users/sebitoelcheater","html_url":"https://github.com/sebitoelcheater","followers_url":"https://api.github.com/users/sebitoelcheater/followers","following_url":"https://api.github.com/users/sebitoelcheater/following{/other_user}","gists_url":"https://api.github.com/users/sebitoelcheater/gists{/gist_id}","starred_url":"https://api.github.com/users/sebitoelcheater/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebitoelcheater/subscriptions","organizations_url":"https://api.github.com/users/sebitoelcheater/orgs","repos_url":"https://api.github.com/users/sebitoelcheater/repos","events_url":"https://api.github.com/users/sebitoelcheater/events{/privacy}","received_events_url":"https://api.github.com/users/sebitoelcheater/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-11T20:16:01Z","updated_at":"2022-02-12T08:41:31Z","closed_at":"2022-02-12T08:41:31Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nUpdate to rails 7.0.2.1\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\nenqueue an ActiveJob\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nExecute the job\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n```\r\nNameError: undefined local variable or method `state' for ActiveSupport::IsolatedExecutionState:Module\r\n  activesupport (7.0.2.1) lib/active_support/isolated_execution_state.rb:41:in `key?'\r\n  activesupport (7.0.2.1) lib/active_support/execution_wrapper.rb:120:in `active?'\r\n  activesupport (7.0.2.1) lib/active_support/execution_wrapper.rb:88:in `wrap'\r\n  activesupport (7.0.2.1) lib/active_support/reloader.rb:71:in `wrap'\r\n  sidekiq (6.4.1) lib/sidekiq/rails.rb:13:in `call'\r\n...\r\n(14 additional frame(s) were not displayed)\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.1\r\n\r\n**Ruby version**: 3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44407/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44407/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44405","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44405/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44405/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44405/events","html_url":"https://github.com/rails/rails/issues/44405","id":1133013217,"node_id":"I_kwDNIULOQ4ho4Q","number":44405,"title":"NameError: undefined local variable or method `state' for ActiveSupport::IsolatedExecutionState:Module","user":{"login":"tannalynn","id":11799492,"node_id":"MDQ6VXNlcjExNzk5NDky","avatar_url":"https://avatars.githubusercontent.com/u/11799492?v=4","gravatar_id":"","url":"https://api.github.com/users/tannalynn","html_url":"https://github.com/tannalynn","followers_url":"https://api.github.com/users/tannalynn/followers","following_url":"https://api.github.com/users/tannalynn/following{/other_user}","gists_url":"https://api.github.com/users/tannalynn/gists{/gist_id}","starred_url":"https://api.github.com/users/tannalynn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tannalynn/subscriptions","organizations_url":"https://api.github.com/users/tannalynn/orgs","repos_url":"https://api.github.com/users/tannalynn/repos","events_url":"https://api.github.com/users/tannalynn/events{/privacy}","received_events_url":"https://api.github.com/users/tannalynn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-11T19:40:02Z","updated_at":"2022-02-11T19:46:31Z","closed_at":"2022-02-11T19:46:31Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nWith 7.0.2.1, call either [key? or delete](https://github.com/rails/rails/blob/v7.0.2.1/activesupport/lib/active_support/isolated_execution_state.rb#L40-L46)  in ActiveSupport::IsolatedExecutionState.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\nState should be defined\r\n\r\n### Actual behavior\r\nIt appears the newest release includes only part of a change made to this file in active support, [active_support/isolated_execution_state.rb](https://github.com/rails/rails/blob/v7.0.2.1/activesupport/lib/active_support/isolated_execution_state.rb).\r\nIn this [commit](https://github.com/rails/rails/commit/449101e753c20af35661afd31ff3fa090b7e919d#diff-258986eb56946168eedb2cbfd0c74bb7ec73ef1c319bdf1d8b8216d205df1219), it looks like there is some work being worked to update this to use `state`, but only part of this change is present in the 7.0.2.1 release. Neither of the methods causing errors appear in [7.0.2](https://github.com/rails/rails/blob/v7.0.2/activesupport/lib/active_support/isolated_execution_state.rb)\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2.1\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44405/reactions","total_count":5,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":2},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44405/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44403","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44403/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44403/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44403/events","html_url":"https://github.com/rails/rails/issues/44403","id":1132902989,"node_id":"I_kwDNIULOQ4a6TQ","number":44403,"title":"Assets prefix in Rails 7 not working when there's a resource called `assets`","user":{"login":"ollie-nye","id":26125311,"node_id":"MDQ6VXNlcjI2MTI1MzEx","avatar_url":"https://avatars.githubusercontent.com/u/26125311?v=4","gravatar_id":"","url":"https://api.github.com/users/ollie-nye","html_url":"https://github.com/ollie-nye","followers_url":"https://api.github.com/users/ollie-nye/followers","following_url":"https://api.github.com/users/ollie-nye/following{/other_user}","gists_url":"https://api.github.com/users/ollie-nye/gists{/gist_id}","starred_url":"https://api.github.com/users/ollie-nye/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ollie-nye/subscriptions","organizations_url":"https://api.github.com/users/ollie-nye/orgs","repos_url":"https://api.github.com/users/ollie-nye/repos","events_url":"https://api.github.com/users/ollie-nye/events{/privacy}","received_events_url":"https://api.github.com/users/ollie-nye/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-11T17:40:23Z","updated_at":"2022-02-12T07:45:33Z","closed_at":"2022-02-12T07:45:33Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nCreate a new rails project\r\nAdd `config.assets.prefix = '/assetz'` to `config/application.rb`\r\nAdd `resources :assets` to `config/routes.rb`\r\nCreate a basic controller & view with any content\r\n\r\nExample app is at https://github.com/ollie-nye/rails-assets-poc\r\n\r\n### Expected behavior\r\nAll assets are served under the `/assetz` path\r\n\r\n### Actual behavior\r\nViewing the page in a browser has most assets under the correct `/assetz` path, but JS preload tags are still under the `/assets` path:\r\n```\r\n<link rel=\"modulepreload\" href=\"/assets/application.js\">\r\n<link rel=\"modulepreload\" href=\"/assets/stimulus.min.js\">\r\n<link rel=\"modulepreload\" href=\"/assets/stimulus-loading.js\">\r\n```\r\n\r\nNo JS gets loaded onto the page.\r\n\r\nRemoving `resources :assets` from routes puts these JS files back on the correct path prefix.\r\n\r\n### System configuration\r\n**Rails version**: 7\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44403/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44403/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44402","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44402/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44402/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44402/events","html_url":"https://github.com/rails/rails/issues/44402","id":1132782359,"node_id":"I_kwDNIULOQ4TjFw","number":44402,"title":"Joins problem of self-association","user":{"login":"iceskyl","id":846003,"node_id":"MDQ6VXNlcjg0NjAwMw==","avatar_url":"https://avatars.githubusercontent.com/u/846003?v=4","gravatar_id":"","url":"https://api.github.com/users/iceskyl","html_url":"https://github.com/iceskyl","followers_url":"https://api.github.com/users/iceskyl/followers","following_url":"https://api.github.com/users/iceskyl/following{/other_user}","gists_url":"https://api.github.com/users/iceskyl/gists{/gist_id}","starred_url":"https://api.github.com/users/iceskyl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iceskyl/subscriptions","organizations_url":"https://api.github.com/users/iceskyl/orgs","repos_url":"https://api.github.com/users/iceskyl/repos","events_url":"https://api.github.com/users/iceskyl/events{/privacy}","received_events_url":"https://api.github.com/users/iceskyl/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-11T15:51:56Z","updated_at":"2022-02-12T06:29:00Z","closed_at":"2022-02-12T06:29:00Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n#### Model\r\n\r\n```ruby\r\nclass Account < ApplicationRecord\r\n  belongs_to :trade_account, class_name: \"Account\"\r\n  belongs_to :agent_target, class_name: \"Account\"\r\nend\r\n```\r\n\r\nWhen I execute the query. The SQL use `trade_accounts_accounts` table name twice. `\"trade_accounts_accounts\".\"id\" AS t1_r0` and `\"trade_accounts_accounts\".\"id\" AS t2_r0`\r\n\r\n```ruby\r\nAccount.select(\"accounts.agent_target_id\", \"accounts.trade_account_id\")\r\n  .joins(:trade_account)\r\n  .includes(:trade_account, :agent_target)\r\n```\r\n```ruby\r\nSQL (0.9ms)  SELECT \"accounts\".\"agent_target_id\", \"accounts\".\"trade_account_id\", \"accounts\".\"id\" AS t0_r0, \"trade_accounts_accounts\".\"id\" AS t1_r0, \"trade_accounts_accounts\".\"id\" AS t2_r0 FROM \"accounts\" INNER JOIN \"accounts\" \"trade_accounts_accounts\" ON \"trade_accounts_accounts\".\"id\" = \"accounts\".\"trade_account_id\"\r\n```\r\n\r\nIt looks correct when I remove `:agent_target` in includes \r\n\r\n```ruby\r\nAccount.select(\"accounts.trade_account_id\")\r\n  .joins(:trade_account)\r\n  .includes(:trade_account)\r\n```\r\n\r\n```ruby\r\nSQL (0.5ms)  SELECT \"accounts\".\"trade_account_id\", \"accounts\".\"id\" AS t0_r0, \"trade_accounts_accounts\".\"id\" AS t1_r0 FROM \"accounts\" INNER JOIN \"accounts\" \"trade_accounts_accounts\" ON \"trade_accounts_accounts\".\"id\" = \"accounts\".\"trade_account_id\"\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4\r\n\r\n**Ruby version**:\r\n3.0.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44402/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44401","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44401/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44401/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44401/events","html_url":"https://github.com/rails/rails/issues/44401","id":1132643031,"node_id":"I_kwDNIULOQ4LC1w","number":44401,"title":"Arel::UpdateManager with join statement on a sqlite and postgres database are invalid","user":{"login":"gagalago","id":519226,"node_id":"MDQ6VXNlcjUxOTIyNg==","avatar_url":"https://avatars.githubusercontent.com/u/519226?v=4","gravatar_id":"","url":"https://api.github.com/users/gagalago","html_url":"https://github.com/gagalago","followers_url":"https://api.github.com/users/gagalago/followers","following_url":"https://api.github.com/users/gagalago/following{/other_user}","gists_url":"https://api.github.com/users/gagalago/gists{/gist_id}","starred_url":"https://api.github.com/users/gagalago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gagalago/subscriptions","organizations_url":"https://api.github.com/users/gagalago/orgs","repos_url":"https://api.github.com/users/gagalago/repos","events_url":"https://api.github.com/users/gagalago/events{/privacy}","received_events_url":"https://api.github.com/users/gagalago/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":126910270,"node_id":"MDU6TGFiZWwxMjY5MTAyNzA=","url":"https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps","name":"With reproduction steps","color":"009800","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-11T14:00:28Z","updated_at":"2022-03-12T02:07:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\ncomplex update with joins produce invalid sql syntax with sqlite and postgres.\r\nthe following test [it \"generates an update statement with joins\"](https://github.com/rails/rails/blob/b961af3345fe2f9e492ba1e5424c2ceb75ac6ead/activerecord/test/cases/arel/update_manager_test.rb#L122-L133) is checking an sql query that is invalid in sqlite and postgres.\r\n\r\nthis is how [postgres update syntax](https://www.postgresql.org/docs/current/sql-update.html) can be and how [sqlite update syntax\r\n](https://sqlite.org/lang_update.html) is defined. To join table during an update we should use the `FROM`.\r\nit seems that it's a [syntax only valid in mysql](https://dev.mysql.com/doc/refman/8.0/en/update.html).\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire 'bundler/inline'\r\n\r\ngemfile(true) do\r\n  source 'https://rubygems.org'\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem 'rails', github: 'rails/rails', branch: 'main'\r\n  gem 'sqlite3'\r\nend\r\n\r\nrequire 'active_record'\r\nrequire 'minitest/autorun'\r\nrequire 'logger'\r\n\r\n# This connection will do for database-independent bug reports.\r\nActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :users, force: true do |t|\r\n    t.integer :posts_count\r\n  end\r\n\r\n  create_table :posts, force: true do |t|\r\n    t.integer :user_id\r\n  end\r\nend\r\n\r\nclass BugTest < ActiveSupport::TestCase\r\n  def test_update_with_joins\r\n    um = Arel::UpdateManager.new\r\n\r\n    table = Arel::Table.new(:users)\r\n    join_table = Arel::Table.new(:posts)\r\n    join_source = Arel::Nodes::JoinSource.new(\r\n      table,\r\n      [table.create_join(join_table)]\r\n    )\r\n\r\n    um.table join_source\r\n    um.set [[table[:posts_count], join_table[:id].count]]\r\n    assert_nothing_raised { ActiveRecord::Base.connection.update(um) }\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nit should be possible to set the `FROM` to join other tables. and at the end generate the following sql `UPDATE \"users\" SET  \"posts_count\" = COUNT(\"posts\".\"id\") FROM \"posts\" WHERE \"users\".\"id\" = \"posts\".\"user_id\"`.\r\n\r\nfor example with the following syntax:\r\n```ruby\r\ntable = Arel::Table.new(:users)\r\njoin_table = Arel::Table.new(:posts)\r\n\r\num.table table\r\num.from join_table\r\num.set [[table[:posts_count], join_table[:id].count]]\r\num.where table[:id].eq(join_table[:user_id])\r\nActiveRecord::Base.connection.update(um)\r\n```\r\n\r\n### Actual behavior\r\nfor now, it generate the following sql `UPDATE \"users\" INNER JOIN \"posts\" SET \"posts_count\" = COUNT(\"posts\".\"id\")` that is an invalid syntax\r\n\r\n### System configuration\r\n**Rails version**: 7.0.1\r\n\r\n**Ruby version**: 3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44401/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44401/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44400","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44400/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44400/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44400/events","html_url":"https://github.com/rails/rails/issues/44400","id":1132642872,"node_id":"I_kwDNIULOQ4LCOA","number":44400,"title":"ActiveRecord::RecordNotFound error in fixture array when deleting or destroying objects through model callbacks during test execution","user":{"login":"jlucartc","id":18648391,"node_id":"MDQ6VXNlcjE4NjQ4Mzkx","avatar_url":"https://avatars.githubusercontent.com/u/18648391?v=4","gravatar_id":"","url":"https://api.github.com/users/jlucartc","html_url":"https://github.com/jlucartc","followers_url":"https://api.github.com/users/jlucartc/followers","following_url":"https://api.github.com/users/jlucartc/following{/other_user}","gists_url":"https://api.github.com/users/jlucartc/gists{/gist_id}","starred_url":"https://api.github.com/users/jlucartc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jlucartc/subscriptions","organizations_url":"https://api.github.com/users/jlucartc/orgs","repos_url":"https://api.github.com/users/jlucartc/repos","events_url":"https://api.github.com/users/jlucartc/events{/privacy}","received_events_url":"https://api.github.com/users/jlucartc/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-02-11T14:00:22Z","updated_at":"2022-05-20T00:02:33Z","closed_at":"2022-05-20T00:02:33Z","author_association":"NONE","active_lock_reason":null,"body":"I wrote a test case which verifies if children(B model) objects are deleted from database after their parent(A model) is deleted. The parent object is always deleted successfully, but for some reason the children fixtures array ends up being broken and failing the test with an unexpected error. The error message is as follows:\r\n\r\n```\r\nError:\r\nATest#test_destroying_A_should_delete_all_associated_B:\r\nActiveRecord::RecordNotFound: Couldn't find B with 'id'=980190962\r\n    test/models/a_test.rb:6:in `block in <class:ATest>'\r\n\r\n```\r\n\r\n### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n##### Creating project\r\n```ruby\r\nrails new testing-fixtures\r\ncd testing-fixtures\r\nrails g model A\r\nrails g model B\r\n```\r\n##### Migrations\r\n```ruby\r\nclass CreateAs < ActiveRecord::Migration[7.0]\r\n  def change\r\n    create_table :as do |t|\r\n      t.string :name\r\n      t.timestamps\r\n    end\r\n  end\r\nend\r\n```\r\n```ruby\r\nclass CreateBs < ActiveRecord::Migration[7.0]\r\n  def change\r\n    create_table :bs do |t|\r\n      t.integer :a_id\r\n      t.string :description\r\n      t.timestamps\r\n    end\r\n  end\r\nend\r\n```\r\n##### Fixtures\r\n\r\n```yml\r\n# A objects\r\none: {\r\n  id: 1,\r\n  name: 'A-object number 1'\r\n}\r\n```\r\n\r\n```yml\r\n# B objects\r\none: {\r\n  a_id: 1,\r\n  description: 'Belongs to A#1'\r\n}\r\ntwo: {\r\n  a_id: 2,\r\n  description: 'Belongs to A#2'\r\n}\r\n```\r\n##### app/models/a.rb\r\n\r\n```ruby\r\nclass A < ApplicationRecord\r\n\tafter_destroy :delete_all_associated_bs\r\n\r\n\tdef delete_all_associated_bs\r\n\t\tB.where(a_id: self.id).destroy_all\r\n\tend\r\n\r\nend\r\n```\r\n##### test/models/a_test.rb\r\n\r\n```ruby\r\nrequire \"test_helper\"\r\n\r\nclass ATest < ActiveSupport::TestCase\r\n  test \"destroying A should delete all associated B\" do\r\n    as(:one).destroy\r\n    refute B.find(bs(:one)[:id]).present?\r\n  end\r\nend\r\n```\r\n##### Running migrations\r\n`rails db:migrate`\r\n\r\n##### Running test\r\n\r\n`rails test test/models/a_test.rb`\r\n\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n`bs` array should still contain both entries, while `B.all` should return an array containing only the `:two` object. The test case should pass.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nAny interaction with `bs` array  (ex: executing `puts bs`,`bs.class`,`bs.nil?` on console ) triggers:\r\n```\r\nError:\r\nATest#test_destroying_A_should_delete_all_associated_B:\r\nActiveRecord::RecordNotFound: Couldn't find B with 'id'=980190962\r\n    test/models/a_test.rb:6:in `block in <class:ATest>'\r\n\r\n```\r\n\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44400/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44400/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44399","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44399/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44399/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44399/events","html_url":"https://github.com/rails/rails/issues/44399","id":1132581834,"node_id":"I_kwDNIULOQ4HTyg","number":44399,"title":"`require \"bigdecimal\"` is missing","user":{"login":"pvalena","id":15652483,"node_id":"MDQ6VXNlcjE1NjUyNDgz","avatar_url":"https://avatars.githubusercontent.com/u/15652483?v=4","gravatar_id":"","url":"https://api.github.com/users/pvalena","html_url":"https://github.com/pvalena","followers_url":"https://api.github.com/users/pvalena/followers","following_url":"https://api.github.com/users/pvalena/following{/other_user}","gists_url":"https://api.github.com/users/pvalena/gists{/gist_id}","starred_url":"https://api.github.com/users/pvalena/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvalena/subscriptions","organizations_url":"https://api.github.com/users/pvalena/orgs","repos_url":"https://api.github.com/users/pvalena/repos","events_url":"https://api.github.com/users/pvalena/events{/privacy}","received_events_url":"https://api.github.com/users/pvalena/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2022-02-11T13:14:14Z","updated_at":"2022-02-12T09:09:44Z","closed_at":"2022-02-12T09:08:06Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nWhen running ActiveJob tests with Ruby 3.1 while building it for Fedora I've hit (100% of the time) - require 'bigdecimal' needed.\r\n\r\n### Actual behavior\r\n\r\n```\r\n+ ruby -Ilib:test -e 'Dir.glob \"./test/cases/**/*_test.rb\", &method(:require)'\r\nUsing async\r\n/builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/lib/active_job/arguments.rb:49:in `<module:Arguments>': uninitialized constant ActiveJob::Arguments::BigDecimal (NameError)\r\n      PERMITTED_TYPES = [ NilClass, String, Integer, Float, BigDecimal, TrueClass, FalseClass ]\r\n                                                            ^^^^^^^^^^\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/lib/active_job/arguments.rb:27:in `<module:ActiveJob>'\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/lib/active_job/arguments.rb:5:in `<top (required)>'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/lib/active_job/enqueuing.rb:3:in `<top (required)>'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/lib/active_job/base.rb:7:in `<top (required)>'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/test/helper.rb:14:in `<top (required)>'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom /builddir/build/BUILD/activejob-7.0.2/usr/share/gems/gems/activejob-7.0.2/test/cases/adapter_test.rb:3:in `<top (required)>'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:/usr/share/rubygems/rubygems/core_ext/kernel_require.rb>:85:in `require'\r\n\tfrom <internal:dir>:220:in `glob'\r\n\tfrom -e:1:in `<main>'\r\n```\r\n\r\nI'm not sure what causes this issue - it occurs in the production build system only, which has almost the same dependencies as the development one, which works fine.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2\r\n\r\n**Ruby version**:\r\n3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44399/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44399/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44396","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44396/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44396/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44396/events","html_url":"https://github.com/rails/rails/issues/44396","id":1132011652,"node_id":"I_kwDNIULOQ3kghA","number":44396,"title":"ActionView::Template::Error (Internal Error: Incompatible units: '%' and 'rem'","user":{"login":"ciscolive","id":20869208,"node_id":"MDQ6VXNlcjIwODY5MjA4","avatar_url":"https://avatars.githubusercontent.com/u/20869208?v=4","gravatar_id":"","url":"https://api.github.com/users/ciscolive","html_url":"https://github.com/ciscolive","followers_url":"https://api.github.com/users/ciscolive/followers","following_url":"https://api.github.com/users/ciscolive/following{/other_user}","gists_url":"https://api.github.com/users/ciscolive/gists{/gist_id}","starred_url":"https://api.github.com/users/ciscolive/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ciscolive/subscriptions","organizations_url":"https://api.github.com/users/ciscolive/orgs","repos_url":"https://api.github.com/users/ciscolive/repos","events_url":"https://api.github.com/users/ciscolive/events{/privacy}","received_events_url":"https://api.github.com/users/ciscolive/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-11T07:57:10Z","updated_at":"2022-02-11T08:04:43Z","closed_at":"2022-02-11T08:04:43Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n\r\n```ruby\r\n# gem modules\r\nsource \"https://rubygems.org\"\r\ngit_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\nruby \"3.0.3\"\r\n\r\n# Bundle edge Rails instead: gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\ngem \"rails\", \"~> 7.0.2\"\r\n\r\n# The original asset pipeline for Rails [https://github.com/rails/sprockets-rails]\r\ngem \"sprockets-rails\"\r\n\r\n# Use postgresql as the database for Active Record\r\ngem \"pg\", \"~> 1.1\"\r\n\r\n# Use the Puma web server [https://github.com/puma/puma]\r\ngem \"puma\", \"~> 5.0\"\r\n\r\n# Use JavaScript with ESM import maps [https://github.com/rails/importmap-rails]\r\ngem \"importmap-rails\"\r\n\r\n# Hotwire's SPA-like page accelerator [https://turbo.hotwired.dev]\r\ngem \"turbo-rails\"\r\n\r\n# Hotwire's modest JavaScript framework [https://stimulus.hotwired.dev]\r\ngem \"stimulus-rails\"\r\n\r\n# Use Tailwind CSS [https://github.com/rails/tailwindcss-rails]\r\ngem \"tailwindcss-rails\"\r\n\r\n# Build JSON APIs with ease [https://github.com/rails/jbuilder]\r\ngem \"jbuilder\"\r\n\r\n# Use Redis adapter to run Action Cable in production\r\ngem \"redis\", \"~> 4.0\"\r\n\r\n# Use Kredis to get higher-level data types in Redis [https://github.com/rails/kredis]\r\n# gem \"kredis\"\r\n\r\n# Use Active Model has_secure_password [https://guides.rubyonrails.org/active_model_basics.html#securepassword]\r\n# gem \"bcrypt\", \"~> 3.1.7\"\r\n\r\n# Windows does not include zoneinfo files, so bundle the tzinfo-data gem\r\ngem \"tzinfo-data\", platforms: %i[ mingw mswin x64_mingw jruby ]\r\n\r\n# Reduces boot times through caching; required in config/boot.rb\r\ngem \"bootsnap\", require: false\r\n\r\n# Use Sass to process CSS\r\ngem \"sassc-rails\"\r\n\r\n# Use Active Storage variants [https://guides.rubyonrails.org/active_storage_overview.html#transforming-images]\r\n# gem \"image_processing\", \"~> 1.2\"\r\n\r\ngroup :development, :test do\r\n  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem\r\n  gem \"debug\", platforms: %i[ mri mingw x64_mingw ]\r\nend\r\n\r\ngroup :development do\r\n  # Use console on exceptions pages [https://github.com/rails/web-console]\r\n  gem \"web-console\"\r\n\r\n  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]\r\n  # gem \"rack-mini-profiler\"\r\n\r\n  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]\r\n  # gem \"spring\"\r\nend\r\n\r\ngroup :test do\r\n  # Use system testing [https://guides.rubyonrails.org/testing.html#system-testing]\r\n  gem \"capybara\"\r\n  gem \"selenium-webdriver\"\r\n  gem \"webdrivers\"\r\nend\r\n\r\ngem \"hotwire-livereload\", \"~> 1.1\", :group => :development\r\n\r\ngem \"figaro\", \"~> 1.2\"\r\n\r\ngem \"bootstrap_icons_rubygem\", \"~> 0.1.1\"\r\n\r\ngem \"remixicon\", \"~> 1.0\"\r\n\r\ngem \"quill-editor-rails\", \"~> 0.1.2\"\r\n\r\ngem \"tinymce-rails\", \"~> 5.10\"\r\ngem \"tinymce-rails-langs\", \"~> 5.20200505\"\r\n```\r\n\r\ncan not work \r\n```ruby\r\n15:53:08 web.1  |   Rendered layout layouts/admin.html.erb (Duration: 6440.9ms | Allocations: 631699)\r\n15:53:08 web.1  | Completed 500 Internal Server Error in 6457ms (ActiveRecord: 0.0ms | Allocations: 638799)\r\n15:53:08 web.1  | \r\n15:53:08 web.1  | \r\n15:53:08 web.1  |   \r\n15:53:08 web.1  | ActionView::Template::Error (Internal Error: Incompatible units: '%' and 'rem'.\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44396/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44396/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44395","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44395/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44395/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44395/events","html_url":"https://github.com/rails/rails/issues/44395","id":1131126743,"node_id":"I_kwDNIULOQ2uf1w","number":44395,"title":"Tests related do #40226 fail.","user":{"login":"pvalena","id":15652483,"node_id":"MDQ6VXNlcjE1NjUyNDgz","avatar_url":"https://avatars.githubusercontent.com/u/15652483?v=4","gravatar_id":"","url":"https://api.github.com/users/pvalena","html_url":"https://github.com/pvalena","followers_url":"https://api.github.com/users/pvalena/followers","following_url":"https://api.github.com/users/pvalena/following{/other_user}","gists_url":"https://api.github.com/users/pvalena/gists{/gist_id}","starred_url":"https://api.github.com/users/pvalena/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvalena/subscriptions","organizations_url":"https://api.github.com/users/pvalena/orgs","repos_url":"https://api.github.com/users/pvalena/repos","events_url":"https://api.github.com/users/pvalena/events{/privacy}","received_events_url":"https://api.github.com/users/pvalena/received_events","type":"User","site_admin":false},"labels":[{"id":131864,"node_id":"MDU6TGFiZWwxMzE4NjQ=","url":"https://api.github.com/repos/rails/rails/labels/third%20party%20issue","name":"third party issue","color":"02d7e1","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-10T22:26:44Z","updated_at":"2022-05-25T01:06:47Z","closed_at":"2022-05-25T01:06:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\nHello,\r\n\r\nwhen creating an update for Fedora, the following 4 tests fail. \r\n\r\nProbably related to #40226.\r\n\r\n### Actual behavior\r\n\r\n```\r\nError:\r\nActiveStorage::VariantTest#test_optimized_variation_of_GIF_blob:\r\nVips::Error: VipsForeignSave: \"/tmp/image_processing20220210-1778-cjj2xp.gif\" is not a known file format\r\nVipsForeignSave: \"/tmp/image_processing20220210-1778-cjj2xp.gif\" is not a known file format\r\n\r\n    /usr/share/gems/gems/ruby-vips-2.1.4/lib/vips/image.rb:590:in `write_to_file'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/vips.rb:63:in `save_image'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/processor.rb:23:in `call'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:50:in `call_processor'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:28:in `block in call'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:64:in `create_tempfile'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:27:in `call'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:14:in `block in call!'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:21:in `instrument'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:13:in `call!'\r\n    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/chainable.rb:58:in `call'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/transformers/image_processing_transformer.rb:22:in `process'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/transformers/transformer.rb:22:in `transform'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variation.rb:56:in `block in transform'\r\n    /usr/share/gems/gems/activesupport-7.0.2/lib/active_support/notifications.rb:208:in `instrument'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variation.rb:55:in `transform'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:110:in `block in process'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:15:in `block in open'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:24:in `open_tempfile'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:12:in `open'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/service.rb:90:in `open'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/blob.rb:301:in `open'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:109:in `process'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:64:in `processed'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:122:in `block (3 levels) in <class:VariantTest>'\r\n    /usr/share/gems/gems/activesupport-7.0.2/lib/active_support/testing/assertions.rb:34:in assert_nothing_raised'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:121:in `block (2 levels) in <class:VariantTest>'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:218:in `process_variants_with'\r\n    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:120:in `block in <class:VariantTest>'\r\n\r\nrails test /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:117\r\n```\r\nSame failures also for BMP, ICO and PSD.\r\n\r\nI've also filed https://github.com/janko/image_processing/issues/98, but I'm not sure it's related in any way.\r\n\r\n### System configuration\r\n**Rails version**:\r\n7.0.2\r\n\r\n**Ruby version**:\r\n3.1\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44395/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44395/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44391","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44391/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44391/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44391/events","html_url":"https://github.com/rails/rails/issues/44391","id":1130570783,"node_id":"I_kwDNIULOQ2MkHw","number":44391,"title":"Documentation should specify which version of yarn to use","user":{"login":"jcoyne","id":92044,"node_id":"MDQ6VXNlcjkyMDQ0","avatar_url":"https://avatars.githubusercontent.com/u/92044?v=4","gravatar_id":"","url":"https://api.github.com/users/jcoyne","html_url":"https://github.com/jcoyne","followers_url":"https://api.github.com/users/jcoyne/followers","following_url":"https://api.github.com/users/jcoyne/following{/other_user}","gists_url":"https://api.github.com/users/jcoyne/gists{/gist_id}","starred_url":"https://api.github.com/users/jcoyne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcoyne/subscriptions","organizations_url":"https://api.github.com/users/jcoyne/orgs","repos_url":"https://api.github.com/users/jcoyne/repos","events_url":"https://api.github.com/users/jcoyne/events{/privacy}","received_events_url":"https://api.github.com/users/jcoyne/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-10T17:56:57Z","updated_at":"2022-02-14T23:44:05Z","closed_at":"2022-02-14T23:44:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I was unable to find any documentation about which version is supported, although it looks like the directions in https://github.com/rails/rails/blob/0d91d4aa07cd69d97e8390176d43a93a862cca0a/guides/source/development_dependencies_install.md#ubuntu end up getting you 1.22\r\n\r\nIf you follow those links you end up redirected to this site (https://classic.yarnpkg.com/en/docs/install) where it says that yarn <2 is in maintenance mode and will soon reach EOL.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44391/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44391/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44383","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44383/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44383/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44383/events","html_url":"https://github.com/rails/rails/issues/44383","id":1129403041,"node_id":"I_kwDNIULOQ1FSoQ","number":44383,"title":"ActiveModel::Attributes raise error on example from edge guides","user":{"login":"uxxman","id":3153380,"node_id":"MDQ6VXNlcjMxNTMzODA=","avatar_url":"https://avatars.githubusercontent.com/u/3153380?v=4","gravatar_id":"","url":"https://api.github.com/users/uxxman","html_url":"https://github.com/uxxman","followers_url":"https://api.github.com/users/uxxman/followers","following_url":"https://api.github.com/users/uxxman/following{/other_user}","gists_url":"https://api.github.com/users/uxxman/gists{/gist_id}","starred_url":"https://api.github.com/users/uxxman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uxxman/subscriptions","organizations_url":"https://api.github.com/users/uxxman/orgs","repos_url":"https://api.github.com/users/uxxman/repos","events_url":"https://api.github.com/users/uxxman/events{/privacy}","received_events_url":"https://api.github.com/users/uxxman/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-10T03:40:10Z","updated_at":"2022-02-10T20:31:29Z","closed_at":"2022-02-10T20:31:29Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\nThe updated **ActiveModel::Attributes** guides suggest the example which doesn't run. The initialise method doesn't accept any arguments.\r\n\r\nGuide: https://edgeapi.rubyonrails.org/classes/ActiveModel/Attributes/ClassMethods.html#method-i-attribute \r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\nend\r\n\r\nrequire \"active_model\"\r\nrequire \"minitest/autorun\"\r\n\r\nclass Person\r\n  include ActiveModel::Attributes\r\n\r\n  attribute :name, :string\r\n  attribute :active, :boolean, default: true\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_stuff\r\n    person = Person.new(name: \"Volmer\")\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nTest should not raise any exception.\r\n\r\n### Actual behavior\r\nRaises: ArgumentError: wrong number of arguments (given 1, expected 0)\r\n\r\n### System configuration\r\n**Rails version**: main\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44383/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44383/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44382","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44382/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44382/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44382/events","html_url":"https://github.com/rails/rails/issues/44382","id":1129392811,"node_id":"I_kwDNIULOQ1Eqqw","number":44382,"title":"RoutingError on destroy test when use carrierwave","user":{"login":"phuongnd08","id":184037,"node_id":"MDQ6VXNlcjE4NDAzNw==","avatar_url":"https://avatars.githubusercontent.com/u/184037?v=4","gravatar_id":"","url":"https://api.github.com/users/phuongnd08","html_url":"https://github.com/phuongnd08","followers_url":"https://api.github.com/users/phuongnd08/followers","following_url":"https://api.github.com/users/phuongnd08/following{/other_user}","gists_url":"https://api.github.com/users/phuongnd08/gists{/gist_id}","starred_url":"https://api.github.com/users/phuongnd08/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/phuongnd08/subscriptions","organizations_url":"https://api.github.com/users/phuongnd08/orgs","repos_url":"https://api.github.com/users/phuongnd08/repos","events_url":"https://api.github.com/users/phuongnd08/events{/privacy}","received_events_url":"https://api.github.com/users/phuongnd08/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-02-10T03:24:41Z","updated_at":"2022-02-16T00:37:14Z","closed_at":"2022-02-16T00:37:14Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nCheck out this commit\r\nhttps://github.com/phuongnd08/movereader/commit/b53bf41b0f46cfcff5b33951514d5570e8649a7e\r\n\r\nAnd setup your rails app using PostgreSQL db: \r\n```\r\nbundle install\r\nbin/rails db:test:prepare\r\n```\r\n\r\nThen run the test: \r\n```\r\nbin/rails test test/system/moves_test.rb\r\n```\r\n\r\n### Expected behavior\r\nTest pass \r\n\r\n### Actual behavior\r\nTest failed with ActionController::RoutingError\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 2.7.2\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44382/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44382/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44376","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44376/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44376/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44376/events","html_url":"https://github.com/rails/rails/issues/44376","id":1128909190,"node_id":"I_kwDNIULOQ0nJhg","number":44376,"title":"ActiveStorage, how to alter the key in direct uploads? Use of a Prefix for S3 buckets.","user":{"login":"resistorsoftware","id":123307,"node_id":"MDQ6VXNlcjEyMzMwNw==","avatar_url":"https://avatars.githubusercontent.com/u/123307?v=4","gravatar_id":"","url":"https://api.github.com/users/resistorsoftware","html_url":"https://github.com/resistorsoftware","followers_url":"https://api.github.com/users/resistorsoftware/followers","following_url":"https://api.github.com/users/resistorsoftware/following{/other_user}","gists_url":"https://api.github.com/users/resistorsoftware/gists{/gist_id}","starred_url":"https://api.github.com/users/resistorsoftware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/resistorsoftware/subscriptions","organizations_url":"https://api.github.com/users/resistorsoftware/orgs","repos_url":"https://api.github.com/users/resistorsoftware/repos","events_url":"https://api.github.com/users/resistorsoftware/events{/privacy}","received_events_url":"https://api.github.com/users/resistorsoftware/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-09T18:54:15Z","updated_at":"2022-02-16T01:41:42Z","closed_at":"2022-02-16T01:41:42Z","author_association":"NONE","active_lock_reason":null,"body":"I have a bucket at s3 called **my-bucket** and the CORS for the bucket works. I can direct upload files to it. I have a folder (key) under that bucket called **special-stuff** where I want my direct uploads to go. That folder has security credentials that work, as I logged in the AWS console and successfully uploaded files to the location **my-bucket/special-stuff**. \r\n\r\nI assigned those credentials to the **:amazon** settings in my Rails 7.0.2 App, and then I tried an upload going to the bucket **my-bucket**. It passed CORS but failed on the PUT. I think the reason is, it tried uploading to **my-bucket** and not the desired **my-bucket/special-stuff**. \r\n\r\nSo my big question is, where in my code can I inform S3 the key is **my-bucket/special-stuff/myfile.csv** when my upload form submits the direct upload filename myfile.csv. At this time, it just goes to the bucket which is not where I would like the file to be saved, ie)  **my-bucket/myfile.csv**\r\n\r\nI see in the attach method, my desired upload is available to me, but it is already some encrypted string. \r\n\r\n\"my_upload\"=>\"eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBHUT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--ff2502d7aa2eec5b97405b86070b4d50c86fb9a6\"\r\n\r\nSo I see no way of getting in there and adding in my needed prefix.\r\n\r\n\r\nThanks","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44376/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44376/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44375","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44375/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44375/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44375/events","html_url":"https://github.com/rails/rails/issues/44375","id":1128727451,"node_id":"I_kwDNIULOQ0cDmw","number":44375,"title":"ActiveStorage and encodings","user":{"login":"resistorsoftware","id":123307,"node_id":"MDQ6VXNlcjEyMzMwNw==","avatar_url":"https://avatars.githubusercontent.com/u/123307?v=4","gravatar_id":"","url":"https://api.github.com/users/resistorsoftware","html_url":"https://github.com/resistorsoftware","followers_url":"https://api.github.com/users/resistorsoftware/followers","following_url":"https://api.github.com/users/resistorsoftware/following{/other_user}","gists_url":"https://api.github.com/users/resistorsoftware/gists{/gist_id}","starred_url":"https://api.github.com/users/resistorsoftware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/resistorsoftware/subscriptions","organizations_url":"https://api.github.com/users/resistorsoftware/orgs","repos_url":"https://api.github.com/users/resistorsoftware/repos","events_url":"https://api.github.com/users/resistorsoftware/events{/privacy}","received_events_url":"https://api.github.com/users/resistorsoftware/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-02-09T16:00:13Z","updated_at":"2022-02-09T19:25:48Z","closed_at":"2022-02-09T19:25:48Z","author_association":"NONE","active_lock_reason":null,"body":"ActiveStorage  comes with a convenience method for opening uploaded files. When I use it and then parse the file opened, that throws an exception:\r\n\r\n WARNING: you are trying to process UTF-8 input, but did not open the input with \"b:utf-8\" option. See README file \"NOTES about File Encodings\".\r\n \r\n So there is no way to open this file with options, and therefore this warning is always thrown, even for UTF-8 encoded files. What are we supposed to do here? Ignore the warning? ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44375/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44375/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44374","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44374/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44374/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44374/events","html_url":"https://github.com/rails/rails/issues/44374","id":1128654888,"node_id":"I_kwDNIULOQ0XoKA","number":44374,"title":"Rails 7.0.1 Direct Uploads remain painful to use","user":{"login":"resistorsoftware","id":123307,"node_id":"MDQ6VXNlcjEyMzMwNw==","avatar_url":"https://avatars.githubusercontent.com/u/123307?v=4","gravatar_id":"","url":"https://api.github.com/users/resistorsoftware","html_url":"https://github.com/resistorsoftware","followers_url":"https://api.github.com/users/resistorsoftware/followers","following_url":"https://api.github.com/users/resistorsoftware/following{/other_user}","gists_url":"https://api.github.com/users/resistorsoftware/gists{/gist_id}","starred_url":"https://api.github.com/users/resistorsoftware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/resistorsoftware/subscriptions","organizations_url":"https://api.github.com/users/resistorsoftware/orgs","repos_url":"https://api.github.com/users/resistorsoftware/repos","events_url":"https://api.github.com/users/resistorsoftware/events{/privacy}","received_events_url":"https://api.github.com/users/resistorsoftware/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-02-09T15:02:52Z","updated_at":"2022-02-10T00:30:56Z","closed_at":"2022-02-09T18:49:19Z","author_association":"NONE","active_lock_reason":null,"body":"Using Ruby 3.1 and Rails 7.01 to do a Direct Upload, we know we have to Monkeypatch out any of the Direct Upload token code. Failure to do so results in the dreaded:\r\n\r\n    ActiveStorage::InvalidDirectUploadTokenError (ActiveStorage::InvalidDirectUploadTokenError):\r\n    \r\nInterestingly, while we get uploads working by removing this token, if we have an exception in our code, and then re-use the same upload to try again after fixing the exception, this error is indeed part of the cycle again. So as an example, when saving the attachment from a direct upload, we then try and run a background job to process it, and we blew that. If we fix the background job call, and just re-up a file, boom:\r\n\r\n     ActiveStorage::InvalidDirectUploadTokenError (ActiveStorage::InvalidDirectUploadTokenError):\r\n     \r\nI would love for this to be fixed!! I ","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44374/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44374/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44373","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44373/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44373/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44373/events","html_url":"https://github.com/rails/rails/issues/44373","id":1128554161,"node_id":"I_kwDNIULOQ0ResQ","number":44373,"title":"`with_options trailing_slash: true` is broken on Rails 7","user":{"login":"WaKeMaTTa","id":3450257,"node_id":"MDQ6VXNlcjM0NTAyNTc=","avatar_url":"https://avatars.githubusercontent.com/u/3450257?v=4","gravatar_id":"","url":"https://api.github.com/users/WaKeMaTTa","html_url":"https://github.com/WaKeMaTTa","followers_url":"https://api.github.com/users/WaKeMaTTa/followers","following_url":"https://api.github.com/users/WaKeMaTTa/following{/other_user}","gists_url":"https://api.github.com/users/WaKeMaTTa/gists{/gist_id}","starred_url":"https://api.github.com/users/WaKeMaTTa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WaKeMaTTa/subscriptions","organizations_url":"https://api.github.com/users/WaKeMaTTa/orgs","repos_url":"https://api.github.com/users/WaKeMaTTa/repos","events_url":"https://api.github.com/users/WaKeMaTTa/events{/privacy}","received_events_url":"https://api.github.com/users/WaKeMaTTa/received_events","type":"User","site_admin":false},"labels":[{"id":35206628,"node_id":"MDU6TGFiZWwzNTIwNjYyOA==","url":"https://api.github.com/repos/rails/rails/labels/routing","name":"routing","color":"e102d8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"assignees":[{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-02-09T13:37:01Z","updated_at":"2022-02-15T11:11:49Z","closed_at":"2022-02-15T11:11:49Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n\r\nhttps://gist.github.com/WaKeMaTTa/365a79c969a959cf944fa7cf49d00973\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~> 7.0.0\"\r\nend\r\n\r\nrequire \"rack/test\"\r\nrequire \"action_controller/railtie\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  routes.draw do\r\n    with_options trailing_slash: true do\r\n      get '/test/' => \"test#index\", as: :test\r\n    end\r\n  end\r\nend\r\n\r\nclass TestController < ActionController::Base\r\n  include Rails.application.routes.url_helpers\r\n\r\n  def index\r\n    render plain: \"Home\"\r\n  end\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  include Rack::Test::Methods\r\n\r\n  def test_returns_success\r\n    path = app.routes.url_helpers.test_path\r\n    assert_equal \"/test/\", path\r\n    get path\r\n    assert last_response.ok?\r\n  end\r\n\r\n  private\r\n    def app\r\n      Rails.application\r\n    end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nHaving this route configuration\r\n\r\n```ruby\r\nroutes.draw do\r\n  with_options trailing_slash: true do\r\n    get '/test/' => \"test#index\", as: :test\r\n  end\r\nend\r\n```\r\n\r\nwe expect `test_path` to return `\"/test/\"` (like in Rails 6)\r\n\r\n### Actual behavior\r\n\r\nBut in rails 7 when we call `test_path` we get `\"/test\"`.\r\n\r\n### System configuration\r\n\r\n**Rails version**: rails 7\r\n\r\n**Ruby version**: ruby 3\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44373/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44371","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44371/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44371/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44371/events","html_url":"https://github.com/rails/rails/issues/44371","id":1128399906,"node_id":"I_kwDNIULOQ0IEIg","number":44371,"title":"After update to 7.0.2: NoMethodError: undefined method `record_changed?","user":{"login":"Tiikara","id":4703086,"node_id":"MDQ6VXNlcjQ3MDMwODY=","avatar_url":"https://avatars.githubusercontent.com/u/4703086?v=4","gravatar_id":"","url":"https://api.github.com/users/Tiikara","html_url":"https://github.com/Tiikara","followers_url":"https://api.github.com/users/Tiikara/followers","following_url":"https://api.github.com/users/Tiikara/following{/other_user}","gists_url":"https://api.github.com/users/Tiikara/gists{/gist_id}","starred_url":"https://api.github.com/users/Tiikara/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Tiikara/subscriptions","organizations_url":"https://api.github.com/users/Tiikara/orgs","repos_url":"https://api.github.com/users/Tiikara/repos","events_url":"https://api.github.com/users/Tiikara/events{/privacy}","received_events_url":"https://api.github.com/users/Tiikara/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-09T11:13:12Z","updated_at":"2022-02-09T13:58:18Z","closed_at":"2022-02-09T13:58:18Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\nThis error encountered on `model.update(attrs)` after update rails from 7.0.1 to 7.0.2. On 7.0.1 works perfectly.\r\n\r\n### Expected behavior\r\nShould successfull update\r\n\r\n### Actual behavior\r\n\r\n```\r\nNoMethodError: undefined method `record_changed?' for #<Invoice id: 1393, contractor_id: 9618, storage_id: 2676, price_type_id: nil, shipment_id: nil, shipment_number: \"\", quantity: nil, purchase_sum: nil, sum: nil, invoice_date: nil, invoice_code: \"\">\r\nDid you mean?  _record_changed?\r\n\r\n  0) InvoicesController base rest controller test PATCH update should pass simple request\r\n     Failure/Error: if model.update(attrs)\r\n\r\n     NoMethodError:\r\n       undefined method `record_changed?' for #<Invoice id: 1393, contractor_id: 9618, storage_id: 2676, price_type_id: nil, shipment_id: nil, shipment_number: \"\", quantity: nil, purchase_sum: nil, sum: nil, invoice_date: nil, invoice_code: \"\">\r\n       Did you mean?  _record_changed?\r\n```\r\n\r\n### System configuration\r\n**Rails version**: 7.0.2\r\n\r\n**Ruby version**: 3.1.0\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44371/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44362","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44362/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44362/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44362/events","html_url":"https://github.com/rails/rails/issues/44362","id":1127534361,"node_id":"I_kwDNIULOQzTPGQ","number":44362,"title":"Handle dependent: nil on ActiveStorage attachments","user":{"login":"ryanseys","id":163873,"node_id":"MDQ6VXNlcjE2Mzg3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/163873?v=4","gravatar_id":"","url":"https://api.github.com/users/ryanseys","html_url":"https://github.com/ryanseys","followers_url":"https://api.github.com/users/ryanseys/followers","following_url":"https://api.github.com/users/ryanseys/following{/other_user}","gists_url":"https://api.github.com/users/ryanseys/gists{/gist_id}","starred_url":"https://api.github.com/users/ryanseys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryanseys/subscriptions","organizations_url":"https://api.github.com/users/ryanseys/orgs","repos_url":"https://api.github.com/users/ryanseys/repos","events_url":"https://api.github.com/users/ryanseys/events{/privacy}","received_events_url":"https://api.github.com/users/ryanseys/received_events","type":"User","site_admin":false},"labels":[{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-02-08T17:13:44Z","updated_at":"2022-08-08T20:53:25Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\nSetting `has_one_attached :content, dependent: nil` on an ActiveRecord model does not work as expected.\r\n\r\n### Expected behavior\r\n\r\nWhen calling destroy on the record which has `has_one_attached :content, dependent: nil` set, I would expect the attachment and blob to not be destroyed.\r\n\r\n### Actual behavior\r\n\r\nThe attachment does get destroyed. \r\n\r\n### System configuration\r\n**Rails version**: 6.1\r\n\r\n**Ruby version**: 2.7.5\r\n","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44362/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44362/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44360","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44360/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44360/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44360/events","html_url":"https://github.com/rails/rails/issues/44360","id":1126878174,"node_id":"I_kwDNIULOQyrL3g","number":44360,"title":"Comparison queries against nullable UUID column in postgres should use `IS [NOT] DISTINCT FROM` instead of `[!]=`","user":{"login":"JoeWoodward","id":442279,"node_id":"MDQ6VXNlcjQ0MjI3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/442279?v=4","gravatar_id":"","url":"https://api.github.com/users/JoeWoodward","html_url":"https://github.com/JoeWoodward","followers_url":"https://api.github.com/users/JoeWoodward/followers","following_url":"https://api.github.com/users/JoeWoodward/following{/other_user}","gists_url":"https://api.github.com/users/JoeWoodward/gists{/gist_id}","starred_url":"https://api.github.com/users/JoeWoodward/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JoeWoodward/subscriptions","organizations_url":"https://api.github.com/users/JoeWoodward/orgs","repos_url":"https://api.github.com/users/JoeWoodward/repos","events_url":"https://api.github.com/users/JoeWoodward/events{/privacy}","received_events_url":"https://api.github.com/users/JoeWoodward/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-08T07:16:18Z","updated_at":"2022-03-10T20:46:57Z","closed_at":"2022-03-10T20:46:57Z","author_association":"NONE","active_lock_reason":null,"body":"https://www.postgresql.org/docs/current/functions-comparison.html\r\n> Ordinary comparison operators yield null (signifying “unknown”), not true or false, when either input is null. For example, 7 = NULL yields null, as does 7 <> NULL. When this behavior is not suitable, use the IS [ NOT ] DISTINCT FROM predicates:\r\n\r\nWhen a UUID column has a NULL value comparing again NULL or a value will return NULL instead of true or false in postgres. This produces confusing results. You would expect\r\n\r\n```\r\nposts = [<Post id: 1, comment_id: null>, <Post id: 2, comment_id: 'f072c0a3-c825-46e2-88f8-9d65b99ca4c4'>]\r\nposts.where(comment_id: nil) => [] # Would expect Post(1) to be returned\r\nposts.where.not(comment_id: 'f072c0a3-c825-46e2-88f8-9d65b99ca4c4') => [] # Would also expect Post(1) here\r\n```\r\n\r\nWhen the comment_id column is populated the issue isn't present, this only happens for rows with null values. \r\nWhen the value passed into the query is NULL ActiveRecord uses `IS NULL` so avoids the issue.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n./bin/rails generate model FooBar uuid:uuid\r\n./bin/rails db:migrate\r\n./bin/rails console\r\n\r\n> FooBar.create\r\n> FooBar.where.not(uuid: SecureRandom.uuid)\r\n-- : FooBar Load (1.8ms)  SELECT \"foo_bars\".* FROM \"foo_bars\" WHERE \"foo_bars\".\"uuid\" != $1  [[\"uuid\", \"4059be21-eb38-4b72-885f-9735b130b382\"]]\r\n=> []\r\n```\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"activerecord\", \"~> 7.0.0\"\r\n  gem \"pg\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# This connection will do for database-independent bug reports.\r\ndb_config = {\r\n  adapter: \"postgresql\",\r\n  encoding: \"unicode\",\r\n  database: \"uuid_bug_test_env\",\r\n  host: \"db\",\r\n  username: \"postgres\"\r\n}\r\ndb_config_admin =\r\n  db_config.merge(database: \"postgres\", schema_search_path: \"public\")\r\n\r\nbegin\r\n  ActiveRecord::Base.establish_connection(db_config)\r\n  ActiveRecord::Base.connection.active?\r\nrescue ActiveRecord::NoDatabaseError\r\n  ActiveRecord::Base.establish_connection(db_config_admin)\r\n  ActiveRecord::Base.connection.create_database(db_config[:database])\r\nensure\r\n  ActiveRecord::Base.establish_connection(db_config)\r\nend\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :posts, force: true do |t|\r\n    t.uuid :comment_id\r\n  end\r\nend\r\n\r\nclass Post < ActiveRecord::Base; end\r\n\r\nclass BugTest < Minitest::Test\r\n  def setup\r\n    @unknown_uuid = SecureRandom.uuid\r\n    @post_a_comment_id = SecureRandom.uuid\r\n\r\n    @post_a = Post.create!(comment_id: @post_a_comment_id)\r\n    @post_b = Post.create!\r\n  end\r\n\r\n  def teardown\r\n    Post.destroy_all\r\n  end\r\n\r\n  def test_is_distinct_from_query\r\n    posts_without_unknown_uuid =\r\n      Post.where('comment_id IS DISTINCT FROM ?', @unknown_uuid)\r\n    assert_includes(posts_without_unknown_uuid, @post_a)\r\n    assert_includes(posts_without_unknown_uuid, @post_b)\r\n\r\n    posts_without_post_a_comment_id =\r\n      Post.where('comment_id IS DISTINCT FROM ?', @post_a_comment_id)\r\n    refute_includes(posts_without_post_a_comment_id, @post_a)\r\n    assert_includes(posts_without_post_a_comment_id, @post_b)\r\n  end\r\n\r\n  def test_is_not_distinct_from_query\r\n    posts_with_unknown_uuid =\r\n      Post.where('comment_id IS NOT DISTINCT FROM ?', @unknown_uuid)\r\n    refute_includes(posts_with_unknown_uuid, @post_a)\r\n    refute_includes(posts_with_unknown_uuid, @post_b)\r\n\r\n    posts_with_post_a_comment_id =\r\n      Post.where('comment_id IS NOT DISTINCT FROM ?', @post_a_comment_id)\r\n    assert_includes(posts_with_post_a_comment_id, @post_a)\r\n    refute_includes(posts_with_post_a_comment_id, @post_b)\r\n  end\r\n\r\n  # The following tests should pass but currently fail due to the use of `[!]=`\r\n  # Need to use `IS [NOT] DISTINCT FROM` to compare nullable values\r\n  #\r\n  # https://www.postgresql.org/docs/14/functions-comparison.html\r\n  #\r\n  # Ordinary comparison operators yield null (signifying “unknown”), not true\r\n  # or false, when either input is null. For example, 7 = NULL yields null,\r\n  # as does 7 <> NULL. When this behavior is not suitable, use the IS [ NOT ]\r\n  # DISTINCT FROM predicates:\r\n  def test_where_not_uuid_query\r\n    posts_without_unknown_uuid = Post.where.not(comment_id: @unknown_uuid)\r\n    # This is true because @post_a.comment_id is not null\r\n    assert_includes(posts_without_unknown_uuid, @post_a)\r\n    # This is false because @post_b.comment_id is null and NULL != NULL returns\r\n    # NULL (signifying \"unknown\") not true as we'd expect\r\n    assert_includes(posts_without_unknown_uuid, @post_b)\r\n\r\n    posts_without_post_a_comment_id =\r\n      Post.where.not(comment_id: @post_a_comment_id)\r\n    refute_includes(posts_without_post_a_comment_id, @post_a)\r\n    # Again fails because @post_b.comment_id is null so we get NULL !=  NULL =>\r\n    # NULL (we expect true)\r\n    assert_includes(posts_without_post_a_comment_id, @post_b)\r\n  end\r\n\r\n  def test_where_uuid_query\r\n    posts_with_unknown_uuid = Post.where(comment_id: @unknown_uuid)\r\n    refute_includes(posts_with_unknown_uuid, @post_a)\r\n    refute_includes(posts_with_unknown_uuid, @post_b)\r\n\r\n    # This works because both @post_a.comment_id and @post_a_comment_id are not\r\n    # null\r\n    posts_with_post_a_comment_id = Post.where(comment_id: @post_a_comment_id)\r\n    assert_includes(posts_with_post_a_comment_id, @post_a)\r\n    refute_includes(posts_with_post_a_comment_id, @post_b)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nWhen a UUID column is nullable, where and where.not should use `IS [NOT] DISTINCT FROM` not `=` or `!=`\r\n\r\n### Actual behavior\r\nCurrently ActiveRecord generates a statement that will return unexpected results. If you have a record with a null uuid column, doing `Model.where(column: nil)` or `Model.where.not(column: SecureRandom.uuid)` will actually return an empty collection, where you'd expect it to return the record.\r\n\r\n### System configuration\r\n\r\nIssue present on activerecord 6.1.3.2 and 7.0.1\r\n\r\n**Ruby version**:\r\nruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [arm64-darwin20]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44360/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44360/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44351","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44351/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44351/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44351/events","html_url":"https://github.com/rails/rails/issues/44351","id":1125413794,"node_id":"I_kwDNIULOQxRzog","number":44351,"title":"Add an index to the guides","user":{"login":"martindemello","id":16215,"node_id":"MDQ6VXNlcjE2MjE1","avatar_url":"https://avatars.githubusercontent.com/u/16215?v=4","gravatar_id":"","url":"https://api.github.com/users/martindemello","html_url":"https://github.com/martindemello","followers_url":"https://api.github.com/users/martindemello/followers","following_url":"https://api.github.com/users/martindemello/following{/other_user}","gists_url":"https://api.github.com/users/martindemello/gists{/gist_id}","starred_url":"https://api.github.com/users/martindemello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martindemello/subscriptions","organizations_url":"https://api.github.com/users/martindemello/orgs","repos_url":"https://api.github.com/users/martindemello/repos","events_url":"https://api.github.com/users/martindemello/events{/privacy}","received_events_url":"https://api.github.com/users/martindemello/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-02-07T01:53:30Z","updated_at":"2022-05-07T06:27:41Z","closed_at":"2022-05-07T06:27:40Z","author_association":"NONE","active_lock_reason":null,"body":"I wanted to know how to deal with file uploads in the controller, and a bit of googling finally turned up the `form.file_field` tag, which made me realise the docs would be under form helpers. Perhaps obvious in retrospect, but as someone learning rails I didn't think of it at the time. It would be super useful to have a flat alphabetical index of everything in the guides, so that e.g. the link to `form.file_field` would be there under \"File uploads\" and \"Uploads\".","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44351/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44351/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44348","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44348/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44348/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44348/events","html_url":"https://github.com/rails/rails/issues/44348","id":1125333213,"node_id":"I_kwDNIULOQxM43Q","number":44348,"title":"`ActiveSupport::Notification`: bugs with overlapping events and subscriptions","user":{"login":"jaynetics","id":10758879,"node_id":"MDQ6VXNlcjEwNzU4ODc5","avatar_url":"https://avatars.githubusercontent.com/u/10758879?v=4","gravatar_id":"","url":"https://api.github.com/users/jaynetics","html_url":"https://github.com/jaynetics","followers_url":"https://api.github.com/users/jaynetics/followers","following_url":"https://api.github.com/users/jaynetics/following{/other_user}","gists_url":"https://api.github.com/users/jaynetics/gists{/gist_id}","starred_url":"https://api.github.com/users/jaynetics/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaynetics/subscriptions","organizations_url":"https://api.github.com/users/jaynetics/orgs","repos_url":"https://api.github.com/users/jaynetics/repos","events_url":"https://api.github.com/users/jaynetics/events{/privacy}","received_events_url":"https://api.github.com/users/jaynetics/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":12449438,"node_id":"MDU6TGFiZWwxMjQ0OTQzOA==","url":"https://api.github.com/repos/rails/rails/labels/stale","name":"stale","color":"444444","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jhawthorn","id":131752,"node_id":"MDQ6VXNlcjEzMTc1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/131752?v=4","gravatar_id":"","url":"https://api.github.com/users/jhawthorn","html_url":"https://github.com/jhawthorn","followers_url":"https://api.github.com/users/jhawthorn/followers","following_url":"https://api.github.com/users/jhawthorn/following{/other_user}","gists_url":"https://api.github.com/users/jhawthorn/gists{/gist_id}","starred_url":"https://api.github.com/users/jhawthorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhawthorn/subscriptions","organizations_url":"https://api.github.com/users/jhawthorn/orgs","repos_url":"https://api.github.com/users/jhawthorn/repos","events_url":"https://api.github.com/users/jhawthorn/events{/privacy}","received_events_url":"https://api.github.com/users/jhawthorn/received_events","type":"User","site_admin":true},"assignees":[{"login":"jhawthorn","id":131752,"node_id":"MDQ6VXNlcjEzMTc1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/131752?v=4","gravatar_id":"","url":"https://api.github.com/users/jhawthorn","html_url":"https://github.com/jhawthorn","followers_url":"https://api.github.com/users/jhawthorn/followers","following_url":"https://api.github.com/users/jhawthorn/following{/other_user}","gists_url":"https://api.github.com/users/jhawthorn/gists{/gist_id}","starred_url":"https://api.github.com/users/jhawthorn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhawthorn/subscriptions","organizations_url":"https://api.github.com/users/jhawthorn/orgs","repos_url":"https://api.github.com/users/jhawthorn/repos","events_url":"https://api.github.com/users/jhawthorn/events{/privacy}","received_events_url":"https://api.github.com/users/jhawthorn/received_events","type":"User","site_admin":true}],"milestone":null,"comments":3,"created_at":"2022-02-06T22:15:19Z","updated_at":"2022-05-25T11:18:26Z","closed_at":"2022-05-25T11:18:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"this is a bunch of bugs i found while investigating https://github.com/rails/rails/issues/44167.\r\n\r\n## bug 1: subscribing during an event causes errors\r\n\r\nthere is no handling for subscriptions/instrumentations that happen between the start and the end of an event. i've described the control flow in some detail [here]( https://github.com/rails/rails/issues/44167#issuecomment-1029015048 ).\r\n\r\n- if the listeners internal stack is not initialized, i.e. an `instrumenter#finish` call happens after subscribing, but before the first `instrumenter#start` call, the stack is `nil` and there is a `NoMethodError`\r\n- else, if at least one event starts before any event finishes, the stack will be initialized but depleted\r\n  - for `EventObject` subscribers, this will cause a `NoMethodError`\r\n  - for `Timed` subscribers, this will cause `Event#start` to be `nil`, which causes https://github.com/rails/rails/issues/44167\r\n\r\n### example\r\n\r\n```ruby\r\nActiveSupport::Notifications.instrumenter.start('bar', {})\r\nActiveSupport::Notifications.subscribe('bar') { |*args| }\r\nActiveSupport::Notifications.instrumenter.finish('bar', {})\r\n# => undefined method `pop' for nil:NilClass (NoMethodError)\r\n\r\nActiveSupport::Notifications.instrumenter.start('bar', {})  # initialize stack\r\nActiveSupport::Notifications.instrumenter.finish('bar', {}) # OK\r\nActiveSupport::Notifications.instrumenter.finish('bar', {}) # start == nil\r\n```\r\n\r\n## bug 2: event data (times, payloads) leaks between multiple subscribers\r\n\r\nbecause multiple subscribers (`Evented` instances) of the same type share a stack for all events that they match, they mishandle events with an overlapping duration.\r\n\r\nthis particular bug was also described in the abandoned PR https://github.com/rails/rails/pull/43241, but AFAICT that PR would have fixed only this one bug and only for a specific use case.\r\n\r\n### example\r\n\r\n```ruby\r\nfoo_events = []\r\nbar_events = []\r\nActiveSupport::Notifications.subscribe('foo') { |e| foo_events << e }\r\nActiveSupport::Notifications.subscribe('bar') { |e| bar_events << e }\r\n\r\n# puts foo data on shared stack\r\nActiveSupport::Notifications.instrumenter.start('foo', { name: 'FOO' })\r\n\r\n# fetches foo data from shared stack\r\nActiveSupport::Notifications.instrumenter.finish('bar', { name: 'BAR' })\r\n\r\n# resulting event is a mix of both events\r\nfoo_events.count      # => 0\r\nbar_events.count      # => 1\r\nbar_events[0].name    # => 'foo'            # name from foo event\r\nbar_events[0].payload # => {:name => \"BAR\"} # payload from bar event\r\nbar_events[0].time    # => 1650862655       # start time from foo event\r\nbar_events[0].end     # => 1650862656       # end time from bar event\r\n```\r\n\r\n## bug 3: event data leaks between events of a single subscriber\r\n\r\nthis is because individual subscribers use a shared stack for all types of events that they match.\r\n\r\n### example\r\n\r\n```ruby\r\nevents = []\r\nActiveSupport::Notifications.subscribe(/.*/) { |e| events << e }\r\n\r\nActiveSupport::Notifications.instrumenter.start('foo', { name: 'FOO' })\r\nActiveSupport::Notifications.instrumenter.finish('bar', { name: 'BAR' })\r\n\r\n# resulting event is a mix of both events\r\nevents.count      # => 1\r\nevents[0].name    # => 'foo'            # name from foo event\r\nevents[0].payload # => {:name => \"BAR\"} # payload from bar event\r\nevents[0].time    # => 1650862655       # start time from foo event\r\nevents[0].end     # => 1650862656       # end time from bar event\r\n```","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44348/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44344","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44344/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44344/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44344/events","html_url":"https://github.com/rails/rails/issues/44344","id":1125101123,"node_id":"I_kwDNIULOQw-uQw","number":44344,"title":"Tell me the appropriate or efficient change method for ActiveRecord::Enum.","user":{"login":"ryosk7","id":17314812,"node_id":"MDQ6VXNlcjE3MzE0ODEy","avatar_url":"https://avatars.githubusercontent.com/u/17314812?v=4","gravatar_id":"","url":"https://api.github.com/users/ryosk7","html_url":"https://github.com/ryosk7","followers_url":"https://api.github.com/users/ryosk7/followers","following_url":"https://api.github.com/users/ryosk7/following{/other_user}","gists_url":"https://api.github.com/users/ryosk7/gists{/gist_id}","starred_url":"https://api.github.com/users/ryosk7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ryosk7/subscriptions","organizations_url":"https://api.github.com/users/ryosk7/orgs","repos_url":"https://api.github.com/users/ryosk7/repos","events_url":"https://api.github.com/users/ryosk7/events{/privacy}","received_events_url":"https://api.github.com/users/ryosk7/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-06T04:22:58Z","updated_at":"2022-02-06T10:42:36Z","closed_at":"2022-02-06T10:42:36Z","author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nAfter upgrade rails version 5.1 to 5.2, then raise an error like this.\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n\r\n```ruby\r\nYou tried to define an enum named \"status\" on the model \"User\", but this will generate a class method \"reject\", which is already defined by ActiveRecord::Relation.\r\n```\r\n\r\nI tried `_prefix ` option. And it looks good work.\r\nHowever, there are many changes in our service.\r\nPlease tell me the appropriate or efficient change method.\r\n\r\nI want a solution that lets me list and detect unused keys.\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\nNOTE: Since it is written according to the issue guide, the content is duplicated.\r\n\r\n```ruby\r\n  enum status: {\r\n    normal: 0,\r\n    deleted: 1,\r\n    reject: 2\r\n  }, _prefix: :is\r\n```\r\n\r\n```ruby\r\nUser.last.is_reject!\r\n#=> is_reject\r\n```\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\nsample code.\r\n\r\n```ruby\r\nUser.last.reject!\r\n```\r\n\r\nthen,\r\n\r\n```ruby\r\nYou tried to define an enum named \"status\" on the model \"User\", but this will generate a class method \"reject\", which is already defined by ActiveRecord::Relation.\r\n```\r\n\r\nbut I know, it fix like this.\r\n\r\n```ruby\r\n  enum status: {\r\n    normal: 0,\r\n    deleted: 1,\r\n    reject: 2\r\n  }, _prefix: :is\r\n```\r\n\r\n```ruby\r\nUser.last.is_reject!\r\n#=> is_reject\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n5.2.6\r\n**Ruby version**:\r\n2.7.5","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44344/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44344/timeline","performed_via_github_app":null,"state_reason":"completed"},{"url":"https://api.github.com/repos/rails/rails/issues/44341","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44341/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44341/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44341/events","html_url":"https://github.com/rails/rails/issues/44341","id":1125051948,"node_id":"I_kwDNIULOQw7uLA","number":44341,"title":"Postgres adapter does not cast ActiveSupport::Duration to interval in array condition","user":{"login":"aramgre","id":10539627,"node_id":"MDQ6VXNlcjEwNTM5NjI3","avatar_url":"https://avatars.githubusercontent.com/u/10539627?v=4","gravatar_id":"","url":"https://api.github.com/users/aramgre","html_url":"https://github.com/aramgre","followers_url":"https://api.github.com/users/aramgre/followers","following_url":"https://api.github.com/users/aramgre/following{/other_user}","gists_url":"https://api.github.com/users/aramgre/gists{/gist_id}","starred_url":"https://api.github.com/users/aramgre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aramgre/subscriptions","organizations_url":"https://api.github.com/users/aramgre/orgs","repos_url":"https://api.github.com/users/aramgre/repos","events_url":"https://api.github.com/users/aramgre/events{/privacy}","received_events_url":"https://api.github.com/users/aramgre/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null},{"id":70310659,"node_id":"MDU6TGFiZWw3MDMxMDY1OQ==","url":"https://api.github.com/repos/rails/rails/labels/PostgreSQL","name":"PostgreSQL","color":"fbca04","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-05T23:06:22Z","updated_at":"2022-02-15T17:15:56Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When passing an `ActiveSupport::Duration` to an Active Record `where` query on Postgres, it will be converted to an ISO 8601 string in a hash condition on an `interval` column, but not in an array condition. \r\n\r\nFor `interval` columns, it would be convenient to be able to pass `ActiveSupport::Duration` in either hash or array conditions. However, some applications probably depend on the existing behavior to pass `ActiveSupport::Duration` as a numeric type so any change might have to be opt-in.\r\n\r\n### Steps to reproduce\r\n\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  gem \"rails\", github: \"rails/rails\", branch: \"main\"\r\n  gem \"pg\"\r\n  gem \"byebug\"\r\nend\r\n\r\nrequire \"active_record\"\r\nrequire \"minitest/autorun\"\r\nrequire \"logger\"\r\n\r\n# docker run --rm -e POSTGRES_PASSWORD=postgres -p 9999:5432 postgres\r\nActiveRecord::Base.establish_connection(\"postgres://postgres:postgres@localhost:9999/postgres\")\r\nActiveRecord::Base.logger = Logger.new(STDOUT)\r\n\r\nActiveRecord::Schema.define do\r\n  create_table :movies, force: true do |t|\r\n    t.interval :runtime\r\n  end\r\nend\r\n\r\nclass Movie < ActiveRecord::Base\r\nend\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_duration\r\n    Movie.create!(runtime: 2.hours)\r\n    Movie.create!(runtime: 90.minutes)\r\n    Movie.create!(runtime: 3.hours + 30.minutes)\r\n\r\n    # SELECT COUNT(*) FROM \"movies\" WHERE \"movies\".\"runtime\" < $1  [[\"runtime\", \"PT3H\"]]\r\n    assert_equal 2, Movie.where(runtime: ...3.hours).count\r\n\r\n    # SELECT COUNT(*) FROM \"movies\" WHERE (runtime < 10800)\r\n    # ActiveRecord::StatementInvalid: PG::UndefinedFunction: ERROR:  operator does not exist: interval < integer\r\n    assert_equal 2, Movie.where('runtime < ?', 3.hours).count\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nWhen passing a duration in an array condition, it should be converted to a valid interval input (e.g., ISO 8601)\r\n\r\nhttps://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-INTERVAL-INPUT\r\n \r\n### Actual behavior\r\n\r\nThe duration get converted to an integer seconds which Postgres can't cast to an interval.  \r\n\r\n### System configuration\r\n**Rails version**:\r\nUsing rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@6a55aff)\r\n**Ruby version**:\r\nruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x86_64-darwin19]","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44341/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44341/timeline","performed_via_github_app":null,"state_reason":null},{"url":"https://api.github.com/repos/rails/rails/issues/44336","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/44336/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/44336/comments","events_url":"https://api.github.com/repos/rails/rails/issues/44336/events","html_url":"https://github.com/rails/rails/issues/44336","id":1124582320,"node_id":"I_kwDNIULOQwfDsA","number":44336,"title":"Unable to require `active_record/base` separately from `active_record`","user":{"login":"postmodern","id":12671,"node_id":"MDQ6VXNlcjEyNjcx","avatar_url":"https://avatars.githubusercontent.com/u/12671?v=4","gravatar_id":"","url":"https://api.github.com/users/postmodern","html_url":"https://github.com/postmodern","followers_url":"https://api.github.com/users/postmodern/followers","following_url":"https://api.github.com/users/postmodern/following{/other_user}","gists_url":"https://api.github.com/users/postmodern/gists{/gist_id}","starred_url":"https://api.github.com/users/postmodern/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/postmodern/subscriptions","organizations_url":"https://api.github.com/users/postmodern/orgs","repos_url":"https://api.github.com/users/postmodern/repos","events_url":"https://api.github.com/users/postmodern/events{/privacy}","received_events_url":"https://api.github.com/users/postmodern/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-02-04T20:18:19Z","updated_at":"2022-02-05T01:38:58Z","closed_at":"2022-02-05T00:36:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It should be possible to require `active_record/base`, and any files it may need, separately from requiring all of `active_record`.\r\n\r\n### Steps to reproduce\r\n\r\n1. Create the `Gemfile`\r\n\r\n    ```ruby\r\n    source 'https://rubygems.org/'\r\n    gem 'activerecord', '7.0.1'\r\n    ```\r\n2. `bundle install`\r\n3. `ruby -r bundler/setup -r active_record/base -e 'p ActiveRecord::Base'`\r\n\r\n### Test Case\r\n\r\n```ruby\r\nassert_nothing_raised do\r\n  require 'active_record/base'\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\nRequires `active_record/base` and any other files `ActiveRecord::Base` may need.\r\n\r\n### Actual behavior\r\n\r\n```\r\n/home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/xml_mini.rb:184:in `current_thread_backend': uninitialized constant ActiveSupport::XmlMini::IsolatedExecutionState (NameError)\r\n\r\n        IsolatedExecutionState[:xml_mini_backend]\r\n        ^^^^^^^^^^^^^^^^^^^^^^\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/xml_mini.rb:103:in `backend='\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/xml_mini.rb:201:in `<module:ActiveSupport>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/xml_mini.rb:11:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/array/conversions.rb:3:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/array/conversions.rb:3:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/duration.rb:3:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/duration.rb:3:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/time/calculations.rb:3:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/time/calculations.rb:3:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/time.rb:4:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/core_ext/time.rb:4:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/time.rb:12:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activesupport-7.0.1/lib/active_support/time.rb:12:in `<top (required)>'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.1/lib/active_record/base.rb:6:in `require'\r\n\tfrom /home/postmodern/test/ruby/bundler/vendor/bundle/ruby/3.1.0/gems/activerecord-7.0.1/lib/active_record/base.rb:6:in `<top (required)>'\r\n\tfrom -e:in `require'\r\n```\r\n\r\n### System configuration\r\n\r\n* activerecord 7.0.1\r\n* ruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [x86_64-linux]\r\n\r\nThis error is reproducible on all ruby versions, ruby 3.1.0 just had the nicer error message.","reactions":{"url":"https://api.github.com/repos/rails/rails/issues/44336/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rails/rails/issues/44336/timeline","performed_via_github_app":null,"state_reason":"completed"}]